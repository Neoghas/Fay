<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FayLotto SpinBet (Traditional UI)</title>
  <link rel="stylesheet" href="style.css" />
  <!-- ethers.js v5 CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"</script>
</head>
<style>
  :root{
  --bg:#0f1724;
  --card:#0b1220;
  --accent:#06b6d4;
  --muted:#94a3b8;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:linear-gradient(180deg,#071127 0%, #08111b 100%);
  color:#e6eef6;
  min-height:100vh;
}
.topbar{
  height:64px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  background:var(--card);
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.brand{font-weight:700; font-size:18px}
.right{display:flex; align-items:center; gap:12px}
.addr{font-size:13px; color:var(--muted)}
.container{
  max-width:1100px;
  margin:20px auto;
  display:grid;
  grid-template-columns: 1fr 420px;
  gap:18px;
  padding:0 18px;
}
.card{
  background:var(--glass);
  padding:16px;
  border-radius:12px;
  box-shadow: 0 6px 20px rgba(2,6,23,0.6);
  border:1px solid rgba(255,255,255,0.02);
}
.controls .row{display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap}
.btn{
  background:transparent;
  border:1px solid rgba(255,255,255,0.06);
  color:#e6eef6;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
}
.btn.primary{background:linear-gradient(90deg,var(--accent),#10b981); border:0}
.note{color:var(--muted); font-size:13px}
.list{max-height:420px; overflow:auto; margin-top:8px}
.bet-item{
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  border:1px solid rgba(255,255,255,0.02);
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:center;
}
.bet-left{flex:1}
.bet-right{min-width:200px; text-align:right}
.small{font-size:13px; color:var(--muted)}
input[type="text"], input{
  padding:8px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.04);
  background:transparent;
  color:inherit;
}
.addr{max-width:220px; display:inline-block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
.footer{max-width:1100px; margin:18px auto; padding:8px 18px; color:var(--muted)}
@media(max-width:900px){
  .container{grid-template-columns:1fr; padding:12px}
  .right{gap:8px}
}
</style>
  
</head>
<body>
  <header class="topbar">
    <div class="brand">FayLotto SpinBet</div>
    <div class="right">
      <button id="btn-connect" class="btn">Connect Wallet</button>
      <span id="addr-short" class="addr"></span>
    </div>
  </header>

  <main class="container">
    <section class="controls card">
      <h2>Play</h2>
      <div class="row">
        <button id="btn-spin" class="btn primary">Spin (pay)</button>
        <button id="btn-free-spin" class="btn">Free Spin</button>
        <div class="note">Spin price: <span id="spin-price">-</span> ETH</div>
      </div>
      <div class="row small">
        <button id="btn-generate-uid" class="btn">Generate Referral UID</button>
        <input id="input-uid" placeholder="Enter referee UID (0xFAY...)" />
        <button id="btn-add-ref" class="btn">Use Referral UID</button>
      </div>

      <div class="row">
        <div>
          <strong>Your referral reward:</strong> <span id="ref-reward">-</span> ETH
        </div>
        <div>
          <button id="btn-claim-ref" class="btn">Claim Referral Reward</button>
        </div>
      </div>

      <div class="row">
        <small>Referral count: <span id="ref-count">0</span></small>
      </div>
    </section>

    <section class="public-bets card">
      <h2>Public Spins (recent)</h2>
      <div id="public-bets-list" class="list"></div>
      <button id="btn-refresh-bets" class="btn">Refresh</button>
    </section>

    <section class="my-bets card">
      <h2>My Bets</h2>
      <div id="my-bets-list" class="list"></div>
      <button id="btn-refresh-my-bets" class="btn">Refresh My Bets</button>
    </section>
  </main>

  <footer class="footer">
    <small>Traditional UI — ethers.js (CDN). Make sure MetaMask is installed.</small>
  </footer>

  <script src="app.js"></script>
  <script>
    // app.js - Traditional JS + ethers.js (v5)
// IMPORTANT: replace CONTRACT_ADDRESS with your deployed contract address
const CONTRACT_ADDRESS = "0x179c8F2fef1b02A3E1C8Be8C4723De65Cf7e4183";

// Minimal ABI (functions used by UI). If your contract uses different names/params, adjust accordingly.
const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_lpointAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"BetLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"result","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"randomNumber","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"contractBalance","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalBets","type":"uint256"},{"indexed":false,"internalType":"string","name":"highestAvailablePrize","type":"string"},{"indexed":false,"internalType":"bool","name":"prizeAvailable","type":"bool"},{"indexed":false,"internalType":"uint256","name":"winChance","type":"uint256"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"BetUnliked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"prizeName","type":"string"}],"name":"ETHAwarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"freeSpinNumber","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"random","type":"uint256"}],"name":"FreeSpinPlayed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"LPointAwarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"rating","type":"uint8"}],"name":"RatingAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"oldRating","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"newRating","type":"uint8"}],"name":"RatingEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"inviter","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"}],"name":"ReferralAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"inviter","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"ReferralRewardEarned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"uid","type":"string"}],"name":"UIDGenerated","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[{"internalType":"string","name":"refereeUID","type":"string"}],"name":"addReferralByUID","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"claimedReferralRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dailyQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dailyUsedQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"depositLPoint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"freeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeSpinData","outputs":[{"internalType":"uint256","name":"freeSpinsUsed","type":"uint256"},{"internalType":"uint256","name":"lastActive","type":"uint256"},{"internalType":"uint256","name":"walletCreated","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"freeSpinQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"generateUID","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getPublicBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"result","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"randomNumber","type":"uint256"},{"internalType":"uint256","name":"contractBalance","type":"uint256"},{"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"internalType":"uint256","name":"totalBets","type":"uint256"},{"internalType":"string","name":"highestAvailablePrize","type":"string"},{"internalType":"bool","name":"prizeAvailable","type":"bool"},{"internalType":"uint256","name":"winChance","type":"uint256"}],"internalType":"struct FaylottoSpinBetBattle.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getUserBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"result","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"randomNumber","type":"uint256"},{"internalType":"uint256","name":"contractBalance","type":"uint256"},{"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"internalType":"uint256","name":"totalBets","type":"uint256"},{"internalType":"string","name":"highestAvailablePrize","type":"string"},{"internalType":"bool","name":"prizeAvailable","type":"bool"},{"internalType":"uint256","name":"winChance","type":"uint256"}],"internalType":"struct FaylottoSpinBetBattle.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"lastPrizeTimestamps","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastResetTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lpointToken","outputs":[{"internalType":"contract LPointToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minInactiveTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minWalletAge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"publicHistoryLimit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrals","outputs":[{"internalType":"address","name":"inviter","type":"address"},{"internalType":"uint256","name":"rewardEarned","type":"uint256"},{"internalType":"string","name":"uid","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"spinBetPaid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"spinPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBetsEver","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"uidToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawLPoint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

let provider, signer, contract;
let userAddress = null;

// DOM
const btnConnect = document.getElementById("btn-connect");
const addrShort = document.getElementById("addr-short");
const btnSpin = document.getElementById("btn-spin");
const spinPriceEl = document.getElementById("spin-price");
const btnFreeSpin = document.getElementById("btn-free-spin");
const btnGenerateUID = document.getElementById("btn-generate-uid");
const inputUID = document.getElementById("input-uid");
const btnAddRef = document.getElementById("btn-add-ref");
const refRewardEl = document.getElementById("ref-reward");
const refCountEl = document.getElementById("ref-count");
const btnClaimRef = document.getElementById("btn-claim-ref");
const publicBetsList = document.getElementById("public-bets-list");
const myBetsList = document.getElementById("my-bets-list");
const btnRefreshBets = document.getElementById("btn-refresh-bets");
const btnRefreshMyBets = document.getElementById("btn-refresh-my-bets");

// Helpers
function shortAddr(a){
  if(!a) return "";
  return a.substring(0,6)+"..."+a.substring(a.length-4);
}
function showToast(msg){
  console.log("[ui]", msg);
  // simple alert fallback
  // for production replace with better toast
  alert(msg);
}

// =============== WALLET CONNECT =================
async function connectWallet(){
  if(!window.ethereum) return showToast("Install MetaMask dulu.");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  const network = await provider.getNetwork();
  if(network.chainId !== 84532){ // 84532 = Base Sepolia Testnet
    showToast("Please switch to Base Sepolia Testnet.");
    return;
  }
  userAddress = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
  addrShort.textContent = shortAddr(userAddress);
  btnConnect.textContent = "Disconnect";
  await postConnectInit();
}

// After connect
async function postConnectInit(){
  try {
    const price = await contract.spinPrice();
    spinPriceEl.textContent = ethers.utils.formatEther(price);
  } catch {
    spinPriceEl.textContent = "-";
  }
  await refreshRefInfo();
  await refreshPublicBets();
  await refreshMyBets();
    }

// Disconnect (simple UI reset)
function disconnectWallet(){
  provider = null;
  signer = null;
  contract = null;
  userAddress = null;
  addrShort.textContent = "";
  btnConnect.textContent = "Connect Wallet";
  refRewardEl.textContent = "-";
  refCountEl.textContent = "0";
  spinPriceEl.textContent = "-";
  publicBetsList.innerHTML = "";
  myBetsList.innerHTML = "";
}

// On connect init: read spin price and referral info
async function postConnectInit(){
  try{
    // spin price
    const price = await contract.spinPrice();
    spinPriceEl.textContent = ethers.utils.formatEther(price);
  }catch(e){
    console.error(e);
    spinPriceEl.textContent = "-";
  }
  await refreshRefInfo();
  await refreshPublicBets();
  await refreshMyBets();
}

// Refresh referral info
async function refreshRefInfo(){
  if(!contract || !userAddress) return;
  try{
    const reward = await contract.getReferralReward(userAddress);
    const count = await contract.getReferralCount(userAddress);
    refRewardEl.textContent = ethers.utils.formatEther(reward) + " ETH";
    refCountEl.textContent = count.toString();
  }catch(e){
    console.error("referr", e);
  }
}

// Spin (payable)
async function doSpin(){
  if(!contract || !signer) { showToast("Connect wallet first"); return; }
  try{
    const price = await contract.spinPrice();
    const tx = await contract.placeBet({ value: price });
    showToast("Transaction sent. Confirm in wallet.");
    await tx.wait();
    showToast("Spin completed.");
    await refreshPublicBets();
    await refreshMyBets();
    await refreshRefInfo();
  }catch(e){
    console.error(e);
    showToast("Spin failed: " + (e?.message||e));
  }
}

// Free spin
async function doFreeSpin(){
  if(!contract || !signer) { showToast("Connect wallet first"); return; }
  try{
    const tx = await contract.freeSpin();
    showToast("Free spin tx sent.");
    await tx.wait();
    showToast("Free spin completed.");
    await refreshPublicBets();
    await refreshMyBets();
  }catch(e){
    console.error(e);
    showToast("FreeSpin failed: " + (e?.message||e));
  }
}

// Generate UID
async function doGenerateUID(){
  if(!contract || !signer) { showToast("Connect wallet first"); return; }
  try{
    const tx = await contract.generateUID();
    showToast("Generating UID — confirm in wallet.");
    await tx.wait();
    // fetch via event not implemented here; just refresh referral info
    showToast("UID generated. Check contract / UI.");
  }catch(e){
    console.error(e);
    showToast("generateUID failed: " + (e?.message||e));
  }
}

// Add referral by UID (use as inviter for the UID owner)
async function doAddReferralByUID(){
  const uid = inputUID.value.trim();
  if(!uid){ showToast("Enter UID"); return; }
  try{
    const tx = await contract.addReferralByUID(uid);
    showToast("Adding referral — confirm in wallet.");
    await tx.wait();
    showToast("Referral saved.");
    await refreshRefInfo();
  }catch(e){
    console.error(e);
    showToast("addReferralByUID failed: " + (e?.message||e));
  }
}

// Claim referral reward
async function doClaimReferralReward(){
  try{
    const tx = await contract.claimReferralReward();
    showToast("Claim tx sent — confirm wallet.");
    await tx.wait();
    showToast("Referral reward claimed.");
    await refreshRefInfo();
  }catch(e){
    console.error(e);
    showToast("claimReferralReward failed: " + (e?.message||e));
  }
}

// Refresh public bets list
async function refreshPublicBets(){
  if(!contract) return;
  try{
    const bets = await contract.getPublicBets();
    publicBetsList.innerHTML = "";
    if(!bets || bets.length === 0){
      publicBetsList.innerHTML = "<div class='small'>No public bets yet</div>";
      return;
    }
    bets.forEach((b, idx) => {
      const item = document.createElement("div");
      item.className = "bet-item";
      const left = document.createElement("div");
      left.className = "bet-left";
      left.innerHTML = `<div><strong>${b.result}</strong></div>
        <div class="small">Player: ${shortAddr(b.player)} — Amt: ${ethers.utils.formatEther(b.amount)} ETH — Time: ${new Date(b.timestamp*1000).toLocaleString()}</div>`;
      const right = document.createElement("div");
      right.className = "bet-right";
      // like / comment / rating controls (simple)
      const likeBtn = document.createElement("button");
      likeBtn.className = "btn";
      likeBtn.textContent = "Like";
      likeBtn.onclick = async ()=>{ await toggleLike(idx); };
      const likeCountSpan = document.createElement("div");
      likeCountSpan.className = "small";
      likeCountSpan.textContent = "Likes: -";
      // load like count
      contract.getLikeCount(idx).then(n => { likeCountSpan.textContent = "Likes: "+n.toString(); }).catch(()=>{});
      const commentBtn = document.createElement("button");
      commentBtn.className = "btn";
      commentBtn.textContent = "Comments";
      commentBtn.onclick = ()=>{ openComments(idx); };
      right.appendChild(likeBtn);
      right.appendChild(likeCountSpan);
      right.appendChild(commentBtn);
      item.appendChild(left);
      item.appendChild(right);
      publicBetsList.appendChild(item);
    });
  }catch(e){
    console.error(e);
    publicBetsList.innerHTML = "<div class='small'>Failed to load public bets</div>";
  }
}

// Refresh my bets
async function refreshMyBets(){
  if(!contract || !signer) return;
  try{
    const bets = await contract.getUserBets();
    myBetsList.innerHTML = "";
    if(!bets || bets.length === 0){
      myBetsList.innerHTML = "<div class='small'>No bets yet</div>";
      return;
    }
    bets.forEach(b=>{
      const item = document.createElement("div");
      item.className = "bet-item";
      item.innerHTML = `<div class="bet-left"><strong>${b.result}</strong>
        <div class="small">Time: ${new Date(b.timestamp*1000).toLocaleString()}</div></div>
        <div class="bet-right">Amt: ${ethers.utils.formatEther(b.amount)} ETH</div>`;
      myBetsList.appendChild(item);
    });
  }catch(e){
    console.error(e);
    myBetsList.innerHTML = "<div class='small'>Failed to load my bets</div>";
  }
}

// Like toggle (uses global public index)
async function toggleLike(globalId){
  if(!contract || !signer){ showToast("Connect wallet"); return; }
  try{
    const tx = await contract.likeSpin(globalId);
    showToast("Like tx sent");
    await tx.wait();
    showToast("Like toggled");
    await refreshPublicBets();
  }catch(e){
    console.error(e);
    showToast("like failed: " + (e?.message||e));
  }
}

// Open comments simple prompt UX (for demo)
async function openComments(globalId){
  if(!contract) return;
  try{
    const comments = await contract.getComments(globalId);
    let msg = "Comments:\n";
    comments.forEach((c,i)=> msg += `${i+1}. ${c.user}: ${c.text}\n`);
    const add = confirm(msg + "\nWould you like to add a comment?");
    if(add){
      const text = prompt("Enter comment (max 256 chars)");
      if(text && text.length>0){
        const tx = await contract.addComment(globalId, text);
        showToast("Adding comment...");
        await tx.wait();
        showToast("Comment added");
      }
    }
  }catch(e){
    console.error(e);
    showToast("comments failed: " + (e?.message||e));
  }
}

// Event handlers
btnConnect.addEventListener("click", async ()=>{
  if(!userAddress) await connectWallet(); else disconnectWallet();
});
btnSpin.addEventListener("click", doSpin);
btnFreeSpin.addEventListener("click", doFreeSpin);
btnGenerateUID.addEventListener("click", doGenerateUID);
btnAddRef.addEventListener("click", doAddReferralByUID);
btnClaimRef.addEventListener("click", doClaimReferralReward);
btnRefreshBets.addEventListener("click", refreshPublicBets);
btnRefreshMyBets.addEventListener("click", refreshMyBets);

// auto-detect account change
if(window.ethereum){
  window.ethereum.on('accountsChanged', (accounts) => {
    if(accounts.length === 0) disconnectWallet();
    else {
      // reconnect with new account
      connectWallet().catch(console.error);
    }
  });
  window.ethereum.on('chainChanged', (chainId) => {
    // simple: page reload on chain change
    console.log("chain changed", chainId);
    window.location.reload();
  });
}

// initial small UI
spinPriceEl.textContent = "-";
refRewardEl.textContent = "-";
refCountEl.textContent = "0";
  </script>
</body>
</html>
