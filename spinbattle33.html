<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --red-main: #c0392b;
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  body {
  margin: 0;
  min-height: 100vh; /* Gunakan min-height, bukan height fix */
  background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
  font-family: "Ubuntu", sans-serif;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  /* justify-content: center; Hapus ini agar konten mulai dari atas */
  padding: 20px 0; /* Beri sedikit ruang atas bawah */
  overflow-x: hidden; /* Hanya sembunyikan scroll horizontal jika perlu */
  overflow-y: auto; /* Izinkan scroll vertikal */
  }

/* === HERO SECTION STYLES (SIMPLE) === */
#hero-section {
    position: relative;
    width: 100%;
    min-height: 20vh; /* Tinggi sesuai permintaan */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding-top: 80px;
    padding-bottom: 40px;
    background: var(--bg-dark-2);
    border-bottom: 1px solid rgba(120, 0, 255, 0.2); /* Garis pemisah halus di bawah */
}

/* Latar Belakang Statis yang Ringan */
.hero-static-bg {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0;
    opacity: 0.4;
    /* Pola grid halus statis */
    background-image: 
        linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
    background-size: 30px 30px;
}

/* Konten Hero (Box Title) */
.hero-content {
    position: relative; z-index: 1;
    text-align: center; max-width: 800px; padding: 30px;
    background: rgba(10, 10, 25, 0.5); /* Latar sedikit lebih gelap */
    backdrop-filter: blur(5px); /* Blur ringan */
    border-radius: 15px;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Bayangan agar menonjol */
}

.hero-title {
    background: #000;
    font-size: 2rem; font-weight: 700; margin: 0 0 15px 0;
    font-family: "Ubuntu", sans-serif;
    letter-spacing: 2px; line-height: 1.1;
}
.hero-title .highlight-text {
    background: linear-gradient(90deg, #03a9f4, #f441a5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
    display: block;
}
.hero-subtitle {
    font-size: 1.1rem; color: #ccc; margin: 0 auto 30px auto;
    max-width: 600px; line-height: 1.5;
}

/* Tombol CTA */
.hero-cta-container { display: inline-block; cursor: pointer; }
.play-now-btn {
    background: linear-gradient(90deg, var(--pink-main), var(--blue-main)); color: #ffffff; /* Warna solid langsung */
    border: none; padding: 12px 35px;
    font-size: 16px; font-weight: bold; letter-spacing: 1px;
    border-radius: 12px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; align-items: center; gap: 8px;
}
.play-now-btn:hover {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4);
}
.arrow-icon { font-size: 1.2em; }

/* Responsif Ponsel */
@media (max-width: 768px) {
    .hero-title { font-size: 2.2rem; }
    .hero-subtitle { font-size: 1rem; }
    .hero-content {
        width: 90%;
        padding: 20px;
        margin: 0 auto; /* Tambahkan ini agar simetris di tengah */
        box-sizing: border-box; /* Pastikan padding tidak menambah lebar total */
    }
}

  /* Mode PC (layar besar) */
@media (min-width: 1024px) {
  #hero-section {
    min-height: 5vh; /* lebih pendek di PC */
    padding-top: 60px;
    padding-bottom: 20px;
  }
}

  .app-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  .lists-wrapper {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-top: 20px;
      width: 90%;
      max-width: 820px;
  }

  /* === [DIUBAH] Wallet Buttons Container === */
  .wallet-container {
    position: fixed;
    top: 20px;
    right: 25px;
    display: flex;
    gap: 10px;
    z-index: 1001;
  }
  .wallet-btn, .referral-btn {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 14px; font-weight: bold; padding: 10px 20px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main);
    transition: all 0.3s ease;
  }
  .wallet-btn:hover, .referral-btn:hover { 
      box-shadow: 0 0 25px var(--pink-main); 
      transform: scale(1.05); 
  }
  
  /* [BARU] Tombol Referral */
  .referral-btn {
      background: linear-gradient(90deg, var(--pink-main), var(--blue-main));
      display: none; /* Sembunyi sampai connect */
  }

  /* Mengganti style .wallet-info lama agar sesuai di dalam modal */
  #walletInfo {
    font-size: 14px;
    line-height: 1.6;
    color: #ccc;
  }
  #walletInfo p { margin: 8px 0; }
  #walletInfo span { color: var(--cyan-main); font-weight: bold; }
  #walletInfo hr {
      border: none;
      height: 1px;
      background-color: var(--border-color);
      margin: 12px 0;
  }

  /* [BARU] Style untuk tombol Disconnect */
  .modal-btn-disconnect {
      background: linear-gradient(90deg, var(--pink-main), var(--red-main));
      box-shadow: 0 0 20px var(--pink-main);
  }
  .modal-btn-disconnect:hover {
      box-shadow: 0 0 25px var(--red-main);
  }

  /* === [PERBAIKAN] Memindahkan Modal Wallet ke Pojok Kanan Atas === */

#wallet-modal {
    /* 1. Hapus pemusatan dari class .modal */
    top: 65px;  /* (Tombol 20px + Jarak 45px) */
    left: auto;
    right: 25px;
    
    /* 2. Hapus transform pemusatan & scaling */
    transform: none;

    /* 3. Atur ulang animasi 'show/hide' agar muncul dari atas (bukan zoom) */
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

/* 4. Ganti animasi .modal.show */
#wallet-modal.show {
    transform: translateY(0);
    opacity: 1;
}

/* 5. Hapus latar belakang gelap HANYA untuk modal ini */
#wallet-modal-overlay.show {
     background: transparent;
     backdrop-filter: none;
}

  /* === Controls (Tidak Berubah) === */
  .controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 250px; 
  }
  .main-btn {
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    padding: 12px 30px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s ease;
    width: 100%;
  }
  #placeBetBtn {
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main);
  }
  #placeBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }
  #finalizeBtn {
    background: linear-gradient(90deg, var(--pink-main), var(--blue-main));
    box-shadow: 0 0 20px var(--pink-main);
    display: none;
  }
  #finalizeBtn:hover { box-shadow: 0 0 25px var(--red-main); transform: scale(1.05); }
  .main-btn:disabled {
    background: #555;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
  }
  .status {
    font-size: 13px;
    margin-top: 8px;
    color: var(--blue-main);
    min-height: 1.2em;
    text-align: center;
    max-width: 320px;
  }
  .timer {
      font-size: 16px;
      font-weight: bold;
      color: var(--cyan-main);
      margin-top: 10px;
      height: 20px;
  }

  /* === Bet & Winner Lists (Tidak Berubah) === */
  .list-container {
    width: 100%;
    max-width: 400px;
    max-height: 350px; 
    background: rgba(10, 10, 20, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  .list-container h3 {
    margin: 0 0 10px 0; font-size: 14px;
    color: var(--blue-main); text-align: center;
    text-transform: uppercase;
  }
  .bet-list-item, .winner-list-item {
    background: rgba(20, 20, 40, 0.7);
    border-radius: 4px; padding: 8px 10px;
    margin-bottom: 6px; font-size: 12px;
  }
  .bet-list-item {
    display: flex; justify-content: space-between;
    align-items: center;
  }
  .bet-list-item .player-id { font-weight: bold; color: var(--cyan-main); }
  .bet-list-item .player-bets { text-align: right; color: #eee; }
  .winner-list-item .winner-id {
    font-weight: bold;
    color: var(--cyan-main);
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .winner-list-item .winner-id span {
      font-weight: normal;
      color: #aaa;
  }
  .winner-list-item .prize-line {
      font-size: 11px;
      color: #eee;
  }
  #bet-list-placeholder, #winner-list-placeholder {
    text-align: center; font-size: 13px;
    color: #888; padding-top: 20px;
  }

  @media (min-width: 768px) {
  .list-container {
    max-height: 400px; /* Tinggi maksimal lebih besar di PC */
    /* Atau gunakan height tetap jika ingin selalu tinggi: */
    /* height: 400px; */
  }
  }
  
  /* === Modal Base (Digunakan oleh Bet & Referral) === */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999; display: none; opacity: 0;
    transition: opacity 0.3s ease;
  }
  .modal { /* [DIUBAH] Nama kelas generik */
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 380px;
    background: var(--bg-modal);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 0 40px rgba(180, 0, 255, 0.3);
    z-index: 1000; display: none; opacity: 0;
    transition: all 0.3s ease;
  }
  .modal-overlay.show, .modal.show { display: block; opacity: 1; }
  .modal.show { transform: translate(-50%, -50%) scale(1); }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2);
  }
  .modal-header h2 { margin: 0; font-size: 20px; color: var(--blue-main); }
  .modal-close-btn {
    font-size: 28px; font-weight: bold; color: #fff;
    cursor: pointer; line-height: 1; background: none; border: none;
  }
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .balance-display, .limits-display { font-size: 13px; color: #999; line-height: 1.5; }
  .limits-display p { margin: 2px 0; }
  .balance-display span, .limits-display span { font-weight: bold; color: var(--cyan-main); }
  .input-group { display: flex; gap: 10px; }
  .input-group input, .input-group select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    font-size: 16px;
    padding: 10px 12px;
  }
  .input-group input { flex-grow: 1; width: 65%; }
  .input-group select { width: 35%; }
  .percent-buttons { display: flex; justify-content: space-between; gap: 8px; }
  .percent-btn {
    flex: 1; background: rgba(120, 0, 255, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px; color: #fff;
    padding: 8px 10px; font-size: 13px;
    cursor: pointer; transition: background 0.2s ease;
  }
  .percent-btn:hover { background: rgba(120, 0, 255, 0.4); }
  .modal-footer { padding: 20px; border-top: 1px solid rgba(120, 0, 255, 0.2); }
  
  /* Tombol di footer modal */
  .modal-btn {
    width: 100%;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: bold; padding: 12px 30px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 20px var(--blue-main);
    transition: all 0.3s ease;
  }
  .modal-btn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.02); }
  .modal-btn:disabled {
    background: #555; color: #999;
    box-shadow: none; transform: none; cursor: not-allowed;
  }
  
  /* [BARU] Style khusus untuk Referral Modal */
  .ref-section {
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.1);
  }
  .ref-section:last-child { border-bottom: none; }
  .ref-section h3 {
      font-size: 16px;
      color: var(--cyan-main);
      margin: 0 0 10px 0;
  }
  .ref-info {
      font-size: 14px;
      color: #ccc;
      line-height: 1.6;
  }
  .ref-info span {
      color: #fff;
      font-weight: bold;
  }
  .ref-section .input-group {
      margin-bottom: 10px;
  }

  .reward-icon {
    width: 22px;
    height: 22px;
    margin-right: 6px;
    vertical-align: middle;
  }
  
  @media (max-width: 840px) {
    .lists-wrapper {
        flex-direction: column;
    }
  }

/* --- RODA SVG V4 (PERBAIKAN POSISI DAN UKURAN) --- */
.donut-wrap {
    position: relative;
    width: 100%;
    max-width: 450px; /* Lebar maksimal roda, sesuaikan jika perlu */
    aspect-ratio: 1 / 1; /* Memastikan container selalu kotak */
    margin: 30px auto; /* Margin atas/bawah agar tidak terlalu mepet */
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; /* Membuat container terlihat bulat */
    overflow: hidden; /* Penting agar elemen SVG yang keluar batas tidak terlihat */
    /* Menghilangkan filter drop-shadow dari sini, kita akan taruh di SVG langsung */
}

/* Pastikan SVG mengisi seluruh container */
.spin-wheel {
    width: 100%;
    height: 100%;
    display: block;
    /* Transform-origin di tengah untuk rotasi GSAP */
    transform-origin: center center;
    /* Tambahkan drop-shadow di SVG agar efeknya tidak terpotong overflow */
    filter: drop-shadow(0 0 20px rgba(98, 0, 255, 0.3));
}

/* Penunjuk (pointer) */
.donut-pointer {
    position: absolute;
    /* Sesuaikan 'top' agar panah tepat di atas roda */
    top: -20px; /* Nilai negatif ini sangat penting untuk posisi di atas */
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    width: 0;
    height: 0;
    border-left: 18px solid transparent; /* Ukuran dasar panah */
    border-right: 18px solid transparent;
    border-top: 38px solid var(--cyan-main); /* Ukuran dasar panah */
    filter: drop-shadow(0 0 10px var(--cyan-main)); /* Efek glow */
}

  /* TAMBAHKAN INI KE CSS ANDA */
#donutCanvas {
    width: 100%;
    height: 100%;
    display: block;
}

/* Tombol tengah */
.spin-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Pastikan di tengah container */
    width: 100px; /* Ukuran tombol tengah */
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(145deg, var(--pink-main), #4a0072);
    color: #fff;
    font-weight: bold;
    display: flex;
    flex-direction: column; /* Untuk teks dan timer */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 0 20px rgba(255, 0, 230, 0.5), inset 0 2px 5px rgba(255,255,255,0.3);
    border: 3px solid #fff;
    z-index: 15;
    text-align: center;
    transition: all 0.2s ease;
    font-size: 16px; /* Ukuran font teks tombol */
}
.spin-btn:hover {
    transform: translate(-50%, -50%) scale(1.05);
    box-shadow: 0 0 30px rgba(255, 0, 230, 0.7), inset 0 2px 5px rgba(255,255,255,0.5);
}
.spin-btn:disabled {
    background: #333;
    border-color: #555;
    cursor: not-allowed;
    opacity: 0.7;
}
.countdown-timer {
    font-size: 13px; /* Ukuran font timer */
    color: var(--cyan-main);
    margin-top: 4px;
}
  
  /* === [BARU] Style untuk Fitur Sosial === */
.winner-social {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(120, 0, 255, 0.2);
}

.like-btn {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}
.like-btn.liked {
    color: var(--pink-main); /* Warna pink saat di-like */
}
.like-btn:hover {
    color: #fff;
}

/* === [REVISI FINAL] Style Bintang Rating === */
.rating-stars {
    display: flex;
    gap: 4px;
    /* Kita BALIK urutannya agar :hover ~ berfungsi benar */
    flex-direction: row-reverse; 
}

.star-icon {
    width: 14px;
    height: 14px;
    cursor: pointer;
    mask-image: url('blackstar.svg');
    mask-size: contain;
    mask-repeat: no-repeat;
    mask-position: center;
    background-color: #555; /* Default mati */
    transition: background-color 0.1s ease;
}

/* Saat hover di SATU bintang, 
   SEMUA bintang "sebelumnya" (yang di kanannya di DOM) ikut menyala */
.star-icon:hover,
.star-icon:hover ~ .star-icon {
    background-color: gold;
}

/* Terapkan warna 'active' (rating yang tersimpan) */
/* Pastikan bintang 'active' tetap menyala meskipun tidak di-hover */
.rating-stars:hover .star-icon.active {
    background-color: gold;
}
.star-icon.active {
    background-color: gold;
}

  /* === [BARU] Gaya Komentar Futuristik (Terminal) === */

/* Container terminal utama */
.comments-terminal {
    background: rgba(0, 0, 0, 0.8); /* Latar lebih gelap agar teks terminal terbaca */
    border: 1px solid var(--purple-main);
    border-radius: 6px;
    padding: 10px;
    font-family: 'Courier Prime', monospace; /* Font monospace penting untuk gaya terminal */
    font-size: 12px;
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
    max-height: 300px; /* Batasi tinggi agar tidak terlalu panjang */
    overflow-y: auto; /* Scroll jika komentar banyak */
}

/* Header terminal (misal: > LOG FOR WINNER...) */
.terminal-header {
    color: var(--cyan-main);
    border-bottom: 1px dashed var(--purple-main);
    padding-bottom: 4px;
    margin-bottom: 10px;
    font-size: 10px; 
    opacity: 0.8;
    letter-spacing: 1px;
}

/* Blok satu komentar individu */
.comment-log {
    margin-bottom: 12px;
    padding-left: 8px;
    border-left: 2px solid var(--blue-main); /* Indikator garis di kiri */
}

/* Metadata komentar (Nickname, Waktu, Wallet) */
.log-meta { 
    color: #888; 
    font-size: 10px; 
    margin-bottom: 2px; 
}
.log-nickname { 
    color: var(--pink-main); /* Nickname warna pink neon */
    font-weight: bold; 
}
.log-wallet { 
    color: #555; 
}

/* Isi pesan komentar */
.log-message { 
    color: #eee; 
    line-height: 1.4; 
    white-space: pre-wrap; /* Agar enter/baris baru terbaca */
}

/* Input gaya terminal */
.terminal-input {
    flex-grow: 1; /* Mengisi sisa ruang */
    background: rgba(0,0,0,0.3);
    border: none; 
    border-bottom: 1px solid var(--cyan-main);
    color: var(--cyan-main);
    font-family: 'Courier Prime', monospace;
    padding: 4px 6px; 
    outline: none;
    font-size: 12px;
}
.terminal-input::placeholder {
    color: rgba(0, 255, 255, 0.3);
}

/* Tombol gaya terminal ([ SEND ], [ EDIT LOG ], dll) */
.terminal-btn {
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--cyan-main);
    color: var(--cyan-main); 
    padding: 3px 8px; 
    font-size: 10px;
    cursor: pointer; 
    font-family: 'Courier Prime', monospace;
    transition: all 0.2s ease;
}
.terminal-btn:hover { 
    background: var(--cyan-main); 
    color: #000; /* Teks jadi hitam saat hover agar kontras */
}

  .log-message { 
    /* ... */
    white-space: pre-wrap; /* Ini yang membuat baris baru (enter) terlihat */
  }

/* === [BARU] Navbar Glassmorphism === */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 30px;
    box-sizing: border-box;
    z-index: 1000;

    /* Efek Glassmorphism */
    background: rgba(10, 10, 25, 0.6); /* Latar belakang transparan gelap */
    backdrop-filter: blur(12px); /* Efek blur di belakangnya */
    border-bottom: 1px solid rgba(120, 0, 255, 0.3); /* Garis batas halus */
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); /* Bayangan lembut */
}

.navbar-logo {
    font-family: "Ubuntu", sans-serif;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
    /* Anda bisa menambahkan <img> di sini jika punya file logo */
}

.navbar-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

/* Hapus style .wallet-container yang lama karena sudah tidak dipakai */
/* .wallet-container { ... }  <-- HAPUS INI */

/* Sesuaikan posisi modal wallet agar pas di bawah navbar */
#wallet-modal {
    top: 80px; /* 70px navbar + 10px jarak */
    right: 25px;
    /* ... (sisa style modal tetap sama) ... */
}

  /* ===== Minimal Footer Style ===== */
  footer {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        background: #000; /* Warna gelap */
        color: #ddd; /* Warna teks */
        font-size: 12px;
    }

    .social-icons {
        margin-bottom: 10px;
    }

    .social-icons a {
    background: rgba(255, 255, 255, 0.2); /* Transparan seperti kaca */
    border-radius: 10px; /* Agar sedikit membulat */
    padding: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white; /* Warna ikon */
    font-size: 15px;
    margin: 0 5px;
    text-decoration: none;
    transition: transform 0.5s ease, text-shadow 0.5s ease, box-shadow 0.5s ease;
    box-shadow: 0 0 10px rgba(0, 0, 255, 0.6); /* Cahaya biru */
    backdrop-filter: blur(10px); /* Efek blur kaca */
}

/* Efek saat hover */
.social-icons a:hover {
    color: #1a88ff; /* Warna biru neon */
    text-shadow: 0 0 10px #1a88ff, 0 0 20px #1a88ff, 0 0 30px #1a88ff; /* Glow lebih intens */
    box-shadow: 0 0 20px rgba(0, 0, 255, 1), 0 0 30px rgba(0, 0, 255, 0.8); /* Shadow lebih terang */
    transform: rotate(360deg); /* Efek berputar */
}

/* === Style Modal Profil Player === */
.profile-body {
    align-items: center;
    text-align: center;
    padding-top: 30px !important; /* Tambah jarak atas */
}

/* Avatar Robot dengan Cincin Berputar */
.profile-avatar-container {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto 20px;
}
.profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: #0b0b15;
    border: 2px solid var(--cyan-main);
    padding: 5px; /* Jarak dari border */
    position: relative;
    z-index: 2;
}
.avatar-ring {
    position: absolute;
    top: -10px; left: -10px; right: -10px; bottom: -10px;
    border: 2px dashed var(--pink-main);
    border-radius: 50%;
    animation: spinRight 20s linear infinite;
    opacity: 0.6;
    z-index: 1;
}

/* Info Teks */
#profileNickname {
    color: var(--cyan-main);
    font-size: 24px;
    margin: 0 0 10px 0;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
}
.profile-address-box {
    background: rgba(0, 0, 0, 0.3);
    padding: 8px 15px;
    border-radius: 20px;
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    color: #aaa;
    cursor: pointer;
    display: inline-block;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.2s ease;
}
.profile-address-box:hover {
    border-color: var(--cyan-main);
    color: #fff;
}

/* Grid Statistik */
.profile-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    width: 100%;
    margin-top: 30px;
}
.stat-box {
    background: linear-gradient(135deg, rgba(20, 20, 40, 0.8), rgba(10, 10, 20, 0.9));
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid var(--purple-main);
    text-align: left;
}
.stat-label {
    display: block;
    font-size: 10px;
    color: #88aaff;
    letter-spacing: 1px;
    margin-bottom: 5px;
}
.stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #fff;
}
.active-glow {
    color: var(--cyan-main);
    text-shadow: 0 0 8px var(--cyan-main);
}

  /* === [BARU] Gaya Avatar di Riwayat Pemenang === */
.winner-main-content {
    display: flex;
    gap: 12px;
    align-items: flex-start; /* Rata atas agar rapi jika teks panjang */
}

.winner-avatar-small {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid var(cyan-main); /* Border pink agar mencolok */
    background: #0b0b15;
    padding: 2px;
    flex-shrink: 0; /* Agar avatar tidak mengecil */
    cursor: pointer; /* Menunjukkan bisa diklik */
    transition: transform 0.2s ease;
}
.winner-avatar-small:hover {
    transform: scale(1.1); /* Efek zoom sedikit saat hover */
}

.winner-info-text {
    flex-grow: 1; /* Mengisi sisa ruang */
    width: 100%; /* Memastikan lebar penuh */
}


  /* === VICTORY OVERLAY STYLES === */
#victory-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(5, 5, 16, 0.95); z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
    backdrop-filter: blur(10px);
}
#victory-overlay.show { opacity: 1; pointer-events: auto; }

#victory-canvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1;
}

.victory-content {
    position: relative; z-index: 2; text-align: center;
    transform: scale(0.8); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#victory-overlay.show .victory-content { transform: scale(1); }

.victory-title {
    font-size: 6rem; margin: 0; color: #fff;
    font-family: "Ubuntu", sans-serif; font-weight: 900; font-style: italic;
    text-shadow: 0 0 20px var(--cyan-main), 0 0 40px var(--cyan-main), 0 0 80px var(--cyan-main);
    animation: titlePulse 1s infinite alternate;
}

.victory-glitch {
    font-family: 'Courier Prime', monospace; color: var(--pink-main);
    font-size: 1.2rem; letter-spacing: 4px; margin-bottom: 20px;
    position: relative; display: inline-block;
}
/* Efek glitch sederhana dengan pseudo-elements */
.victory-glitch::before, .victory-glitch::after {
    content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%;
    background: rgba(5, 5, 16, 0.95); clip: rect(0, 0, 0, 0);
}
.victory-glitch::after {
    left: 2px; text-shadow: -1px 0 red; animation: glitch-anim 2s infinite linear alternate-reverse;
}

.victory-subtitle {
    color: #ccc; font-size: 1.2rem; margin-top: 10px;
}

.claim-victory-btn {
    margin-top: 40px; padding: 15px 50px; font-size: 18px;
    background: var(--pink-main); border: none; color: #fff; font-weight: bold;
    border-radius: 4px; cursor: pointer;
    box-shadow: 0 0 30px var(--pink-main);
    transition: all 0.3s ease;
}
.claim-victory-btn:hover {
    background: #fff; color: var(--pink-main); box-shadow: 0 0 50px #fff;
}

@keyframes titlePulse {
    from { text-shadow: 0 0 20px var(--cyan-main), 0 0 40px var(--cyan-main); }
    to { text-shadow: 0 0 40px var(--cyan-main), 0 0 80px var(--cyan-main); }
}
@keyframes glitch-anim {
    0% { clip: rect(30px, 9999px, 10px, 0); }
    5% { clip: rect(85px, 9999px, 66px, 0); }
    /* ... bisa ditambahkan lebih banyak frame untuk glitch yang lebih acak ... */
    100% { clip: rect(90px, 9999px, 100px, 0); }
}

/* Responsif untuk HP */
@media (max-width: 768px) {
    .victory-title { font-size: 4rem; }
    .victory-glitch { font-size: 0.9rem; letter-spacing: 2px; }
}

  /* === LEADERBOARD STYLES (OPTIMIZED) === */

.leaderboard-section {
    width: 95%; /* Sedikit lebih lebar agar muat di HP */
    max-width: 820px; 
    margin: 40px auto;
    text-align: center;
}

.section-title {
    background: linear-gradient(90deg, #03a9f4, #f441a5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent; 
    font-size: 24px; 
    margin-bottom: 20px; 
    letter-spacing: 2px;
    text-shadow: 0 0 10px var(--purple-main); /* Pastikan variabel ini ada di :root */
    font-weight: 800;
}

/* Container Utama dengan Scroll Horizontal untuk Mobile */
.leaderboard-container {
    background: rgba(10, 10, 25, 0.85); /* Sedikit lebih gelap agar teks terbaca */
    border: 1px solid var(--purple-main);
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 0 30px rgba(98, 0, 255, 0.15);
    overflow-x: auto; /* [PENTING] Agar bisa digeser jika layar sempit */
}

/* === TAB NAVIGATION === */
.lb-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}

.lb-tab {
    background: rgba(16, 16, 24, 0.8);
    border: 1px solid #444;
    color: #888;
    padding: 8px 25px;
    border-radius: 30px; /* Lebih bulat */
    cursor: pointer;
    font-family: 'Ubuntu', sans-serif;
    font-weight: bold;
    transition: all 0.3s ease;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.lb-tab:hover {
    border-color: #fff;
    color: #fff;
}

.lb-tab.active {
    background: rgba(0, 255, 136, 0.15);
    border-color: #00ff88;
    color: #00ff88;
    box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
}

/* === GRID SYSTEM (Updated untuk 5 Kolom) === */
/* Urutan: Rank | Player | Score/Count | ETH | USDT */
.lb-header, .lb-item {
    display: grid;
    /* Kolom diatur agar pas dengan data JS Anda */
    grid-template-columns: 50px 2fr 1.2fr 1fr 1fr; 
    gap: 10px;
    padding: 12px 15px;
    align-items: center;
    text-align: left;
    min-width: 500px; /* [PENTING] Mencegah tabel hancur di HP, user harus scroll */
}

.lb-header {
    color: var(--cyan-main); 
    font-weight: bold; 
    letter-spacing: 1px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 11px;
    text-transform: uppercase;
    opacity: 0.8;
}

.lb-item {
    color: #ccc; 
    font-size: 13px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    transition: background 0.2s;
}

.lb-item:hover {
    background: rgba(255, 255, 255, 0.05); 
    color: #fff;
}

.lb-rank { 
    font-weight: bold; 
    color: var(--pink-main); 
    font-family: monospace;
    font-size: 14px;
}

/* Status Loading */
.lb-loading { 
    padding: 30px; 
    color: #666; 
    font-style: italic; 
    font-size: 14px;
    animation: pulseText 1.5s infinite; 
}

@keyframes pulseText {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

/* === RANK HIGHLIGHTS === */
.lb-item.rank-1 { 
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), transparent); 
    border-left: 3px solid #FFD700; /* Gold */
}
.lb-item.rank-1 .lb-rank { color: #FFD700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }

.lb-item.rank-2 { 
    background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), transparent); 
    border-left: 3px solid #C0C0C0; /* Silver */
}
.lb-item.rank-2 .lb-rank { color: #C0C0C0; }

.lb-item.rank-3 { 
    background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), transparent); 
    border-left: 3px solid #CD7F32; /* Bronze */
}
.lb-item.rank-3 .lb-rank { color: #CD7F32; }

/* === MOBILE RESPONSIVE TWEAK === */
@media (max-width: 600px) {
    .section-title { font-size: 20px; }
    .lb-tab { padding: 6px 15px; font-size: 11px; }
    
    /* Di HP, font tabel dikecilkan sedikit */
    .lb-header, .lb-item { font-size: 11px; padding: 10px 5px; }
    .lb-item div small { display: none; } /* Sembunyikan detail kecil (misal 'Baby') jika terlalu sempit */
} 

  
  /* === [BARU] Gaya Box untuk Setiap Komentar === */

.comment-log {
    display: flex;
    gap: 10px; /* Jarak antara avatar dan teks */
    align-items: flex-start;
    
    /* GAYA BOX BARU */
    background: rgba(0, 0, 0, 0.4); /* Latar belakang box komentar */
    border: 1px solid rgba(0, 255, 255, 0.1); /* Border cyan tipis */
    border-left: 2px solid var(--purple-dark); /* Aksen pink di kiri */
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 10px; /* Jarak antar box komentar */
}

/* Avatar di dalam komentar */
.comment-avatar {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    border: 1px solid var(--cyan-main);
    background: #0b0b15;
    flex-shrink: 0;
    cursor: pointer;
    transition: transform 0.2s;
}
.comment-avatar:hover {
    transform: scale(1.1);
}

/* Konten teks di sebelah kanan avatar */
.comment-content {
    flex-grow: 1;
    width: 100%; /* Memastikan ini mengisi sisa ruang */
    word-wrap: break-word; /* Memastikan teks panjang pindah baris */
    overflow: hidden; /* Mencegah overflow */
}

/* Sisa style meta-data (pastikan font-family sudah ada) */
.log-meta { 
    color: #888; 
    font-size: 10px; 
    margin-bottom: 5px; 
    font-family: 'Courier Prime', monospace;
}
.log-nickname { 
    color: var(--pink-main); 
    font-weight: bold; 
    font-size: 12px;
}
.log-wallet { 
    color: #555; 
}
.log-message { 
    color: #eee; 
    line-height: 1.4; 
    white-space: pre-wrap;
    font-family: 'Courier Prime', monospace;
    font-size: 13px;
}

/* Tombol Edit di dalam box */
.comment-content .terminal-btn {
    opacity: 0.7;
    margin-top: 8px;
}
.comment-content .edit-actions {
    margin-top: 10px;
}

  /* === [REVISI] Ukuran Ikon Aset Pemenang === */
.asset-icon-group {
    display: flex;
    align-items: center;
    gap: 4px; /* Jarak antar ikon jika ada dua */
}

.asset-icon {
    width: 30px;  /* Sesuai permintaan Anda */
    height: 30px; /* Sesuai permintaan Anda */
    vertical-align: middle;
    filter: drop-shadow(0 0 3px var(--cyan-main)); /* Efek glow tipis */
}


  .balance-display {

    font-size: 13px; color: #999; line-height: 1.5;

}

.balance-display p {

    margin-top: 0;

    margin-bottom: 5px;

    font-weight: bold;

    color: #fff; /* Teks "Your Balance:" jadi putih */

}



/* Baris baru untuk ikon + saldo */

.balance-line {

    display: flex;

    align-items: center;

    gap: 8px; /* Jarak antara ikon dan angka */

    font-size: 15px;

    margin-bottom: 5px;

}



/* Ukuran ikon di modal */

.balance-icon {

    width: 22px;

    height: 22px;

}



/* Mengatur span (angka) agar tetap sama */

.balance-line span {

    font-weight: bold; color: var(--cyan-main);

}
  
/* Wrapper pembungkus input/select */
.input-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

/* Style ikon (img atau font-icon) */
.input-icon,
.input-icon-fa {
    position: absolute;
    left: 7px;           /* Jarak ikon dari kiri */
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    color: var(--cyan-main);
    opacity: 0.6;
    pointer-events: none;
}
.input-icon { width: 20px; height: 20px; }
.input-icon-fa { font-size: 14px; }

/* Style untuk input/select DI DALAM wrapper */
.input-icon-wrapper input,
.input-icon-wrapper select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    fonfont-size: 15px;

    /* Ruang untuk ikon kiri */
    padding: 10px 12px 10px 28px;

    width: 100%;
    box-sizing: border-box;
}

/* Style khusus SELECT agar panah terlihat */
.input-icon-wrapper select {
    appearance: none;
    -webkit-appearance: none;

    /* Ikon panah */
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%2Sxmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300FFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.6-3.6%205.4-7.9%205.4-12.9%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: .65em auto;

    padding-right: 10px; /* Ruang untuk panah */
}

    /* === STYLING NOTIFIKASI STATUS (TOAST) === */
#toast-container {
  position: fixed; /* Tetap di layar saat di-scroll */
  top: 90px; /* Di bawah navbar */
  right: 20px;
  z-index: 10000; /* Paling atas */
  width: 300px;
  max-width: 90%;
}

/* Style untuk setiap notifikasi */
.toast-notification {
  background: #333;
  color: white;
  padding: 15px 20px;
  margin-bottom: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  font-family: Arial, sans-serif;
  font-weight: bold;
  font-size: 14px;
  border: 2px solid #555;
  
  /* Flexbox untuk ikon + teks */
  display: flex;
  align-items: center;
  gap: 10px;
  
  /* Animasi fade-in dan fade-out */
  opacity: 0;
  transform: translateX(100%);
  transition: all 0.5s ease-in-out;
}

/* Animasi saat muncul */
.toast-notification.show {
  opacity: 1;
  transform: translateX(0);
}

/* Animasi saat hilang */
.toast-notification.hide {
  opacity: 0;
  transform: translateX(100%);
}

/* Ikon di dalam toast */
.toast-notification img {
  width: 30px;
  height: 30px;
  flex-shrink: 0;
}
.toast-notification span {
  flex-grow: 1;
  word-wrap: break-word;
}

/* Warna berdasarkan tipe */
.toast-notification.success {
  background: #2c4c00;
  border: 2px solid #69a31a;
}
.toast-notification.error {
  background: #4a2c2c;
  border: 2px solid #dc3545;
}
.toast-notification.info {
  background: #56616e;
  border: 2px solid #343a42;
}
.toast-notification.load {
  background: #0a3c66; /* Abu-abu gelap */
  border: border 2px solid #0061b3;
}

.toast-notification.warning {
  background: #997a00;
  border: 2px solid #ffcc00;
}

/* Warna untuk tipe 'spin' (Ungu/Pink) */
.toast-notification.spin {
  background: #501f66;
  border: 2px solid #a03ecc; /* Mengambil warna dari gradien tombol */
}

/* Warna untuk tipe 'wolf' (Biru Cyan) */
.toast-notification.wolf {
  background: #804f00;
  border: 2px solid #e68d00; /* Mengambil warna dari gradien tombol */
}

/* === STYLE BARU UNTUK TOMBOL CLOSE TOAST === */
.toast-close-btn {
  background: none;
  border: none;
  color: #ff4d4d;
  font-size: 24px;  /* Perbesar tombol 'x' */
  font-weight: bold;
  line-height: 1;
  padding: 0 5px;
  margin-left: 10px; /* Jarak dari teks */
  cursor: pointer;
  transition: color 0.2s;
}

/* Tombol close jadi merah saat di-hover */
.toast-close-btn:hover {
  color: #ff8282; 
}

/* Pastikan span-nya tidak menabrak tombol */
.toast-notification span {
  flex-grow: 1; /* Biarkan teks mengambil sisa ruang */
  word-wrap: break-word;
}
  
  @media (min-width: 768px) {
  #donutCanvas {
    /* Ubah ukuran sesuai keinginan Anda, misalnya 500px */
    width: 550px !important;
    height: 550px !important;
  }
</style>
  </head>
  
<body>
   <nav class="navbar">
      <div class="navbar-logo">
    <img src="logo.svg" alt="Faylotto Logo" style="height: 40px; margin-right: 10px;">
    <span style="font-weight:bold; font-size:20px; color:var(--cyan-main);"></span></div>
      <div class="navbar-actions">
          <button class="referral-btn" id="referralBtn">Referral</button>
          <button class="wallet-btn" id="walletBtn">Connect Wallet</button>
      </div>
   </nav>

   <div class="modal-overlay" id="wallet-modal-overlay"></div>
  <div class="modal" id="wallet-modal">
    <div class="modal-header">
      <h2>Wallet Info</h2>
      <button class="modal-close-btn" id="wallet-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body" id="walletInfo"> 
      <p>Address: <span id="walletAddress">-</span></p>
      <p><img src="eth.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">Balance (ETH): <span id="ethBalance">0</span></p>
      <p><img src="usdt.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">Balance (USDT): <span id="usdtBalance">0</span></p>
      <p><img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">BabyDoge: <span id="babyDogeBalance">0</span></p>
      <p>
      <img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">
      <span style="color: var(--cyan-main);">Free BabyDoge Balance:</span> 
      <span id="freeBalance">0</span>
      </p>
      <hr/>
      <p><img src="eth.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">My Deposits (ETH): <span id="myEthDeposit">0</span></p>
      <p><img src="usdt.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">My Deposits (USDT): <span id="myUsdtDeposit">0</span></p>
      <p><img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">My Deposits (BabyDoge): <span id="myBabyDogeDeposit">0</span></p>
      <p><img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">Free Deposits (BabyDoge): <span id="myFreeDeposit">0</span></p>
    </div>
    <div class="modal-footer">
      <button id="disconnectBtn" class="modal-btn modal-btn-disconnect">Disconnect</button>
    </div>
  </div>

  <section id="hero-section">
    <div class="hero-static-bg"></div>
    
    <div class="hero-content">
        <h2 class="hero-title">
         <span class="highlight-text">Faylotto Spin Battle</span></h2>
        <p class="hero-subtitle">
          Spin the wheel of fortune on a decentralized network. Fair, transparent, and automated.
        </p>
        
        <div class="hero-cta-container" onclick="document.querySelector('.app-body').scrollIntoView({behavior: 'smooth'})">
            <button class="play-now-btn">
                Play Now! <span class="arrow-icon">â†“</span>
            </button>
        </div>
    </div>
  </section>

  <div class="app-body" style="margin-top: 80px;"> 
    
    <div class="donut-wrap">
        <div class="donut-pointer"></div>
        <canvas id="donutCanvas"></canvas>
    </div>

    <div class="controls">
      <button id="placeBetBtn" class="main-btn">Place Bet</button>
      <button id="finalizeBtn" class="main-btn">Finalize Round</button>
      <div class="status" id="statusText">Wallet not connected</div>
      <div class="timer" id="timerText"></div>
    </div>
    
    <div class="lists-wrapper">
      <div id="bet-list-container" class="list-container">
          <h3>Current Round Bets</h3>
          <div id="bet-list">
              <p id="bet-list-placeholder">No bets placed yet in this round.</p>
          </div>
      </div>
      
      <div id="winner-list-container" class="list-container">
          <h3>Recent Winners</h3>
          <div id="winner-list">
              <p id="winner-list-placeholder">No winners yet.</p>
          </div>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="bet-modal-overlay"></div>
  <div class="modal" id="bet-modal">
  <div class="modal-header">
    <h2>Place Your Bet</h2>
    <button class="modal-close-btn" id="bet-modal-close-btn">&times;</button>
  </div>
  <div class="modal-body">
    <div class="balance-display">
      <p>Your Balance:</p> 
      <div class="balance-line">
          <img src="eth.svg" class="balance-icon" alt="ETH"> 
          <span id="modalEthBalance">0</span> ETH
      </div>
      
      <div class="balance-line">
          <img src="usdt.svg" class="balance-icon" alt="USDT"> <span id="modalUsdtBalance">0</span> USDT
      </div>
      
      <div class="balance-line">
          <img src="bb.svg" class="balance-icon" alt="BabyDoge"> <span id="modalBabyDogeBalance">0</span> BabyDoge
      </div>

      <div class="balance-line">
          <img src="bb.svg" class="balance-icon" alt="Free"> 
          <span id="modalFreeBalance">0</span> FREE
      </div>
    </div>
    
    <div class="input-group">
      
      <div class="input-icon-wrapper" style="flex-grow: 1; width: 65%;">
          <i class="fa-solid fa-hashtag input-icon-fa"></i>
          <input type="number" id="betAmountInput" placeholder="Custom Amount">
      </div>
      
      <div class="input-icon-wrapper select-wrapper" style="width: 35%;">
          <img src="eth.svg" class="input-icon" id="currency-icon" alt="">
          <select id="betCurrencySelect">
            <option value="ETH" data-icon="eth.svg">ETH</option>
            <option value="USDT" data-icon="usdt.svg">USDT</option>
            <option value="BABYDOGE" data-icon="bb.svg">BabyDoge</option>
            <option value="FREE" data-icon="bb.svg">FREE</option>
          </select>
      </div>

    </div>
    <div class="percent-buttons">
      <button class="percent-btn" data-percent="0.10">MIN</button> 
      <button class="percent-btn" data-percent="0.25">25%</button>
      <button class="percent-btn" data-percent="0.50">50%</button>
      <button class="percent-btn" data-percent="0.75">75%</button>
      <button class="percent-btn" data-percent="1.00">MAX</button>
    </div>
  </div>
  <div class="modal-footer">
    <button id="confirmBetBtn" class="modal-btn">Confirm Bet</button>
  </div>
  <center><p>
<span style="color:#f0f0f0; font-size: 13px;">Note:</span><br>
<span style="color:#ccba00; font-size: 12px;">
  Min bet is 0.00005 ETH Max 0.00256 ETH<br>
  Min bet is 0.5 ETH Max 10 USDT<br>
  Min bet is 1M BabyDoge Max 10M BabyDoge<br>
  Min bet is 500k FreeBabyDoge Max 10B FreeBabyDoge<br>
  Maximum bets are 2 per round
</span>
  </p></center>
</div>
  
  <div class="modal-overlay" id="referral-modal-overlay"></div>
  <div class="modal" id="referral-modal">
    <div class="modal-header">
      <h2>Referral System</h2>
      <button class="modal-close-btn" id="referral-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body">
        
      <div class="ref-section">
          <h3>My Info</h3>
          <div class="ref-info">
              My Nickname: <span id="myNickname">-</span><br/>
              My Referrer: <span id="myReferrer">-</span>
          </div>
      </div>
      
      <div class="ref-section">
          <h3>Create/Update Nickname</h3>
          <div class="input-group">
              <input type="text" id="nicknameInput" placeholder="Enter your nickname">
          </div>
          <button id="createNicknameBtn" class="modal-btn">Create</button>
      </div>

      <div class="ref-section" id="referralLinkSection" style="display: none;">
            <h3>Your Referral Link</h3>
            <div class="input-group">
                <input type="text" id="referralLinkInput" readonly style="cursor: pointer;">
            </div>
            <br><button id="copyReferralBtn" class="modal-btn">Copy Link</button>
      </div>
      
      <div class="ref-section">
    <h3>My Rewards</h3>
    <div class="ref-info">

        <img src="eth.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">
        ETH Rewards: <span id="ethRewards">0</span><br/>

        <img src="usdt.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">
        USDT Rewards: <span id="usdtRewards">0</span><br/>
        
        <img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">
        BabyDoge Rewards: <span id="babyDogeRewards">0</span><br/>
        Total Referrals: <span id="referralCount">0</span>

    </div>
      </div>

    </div>
    <div class="modal-footer">
      <button id="claimRewardsBtn" class="modal-btn">Claim Rewards</button>
    </div>
  </div>

  <div class="modal-overlay" id="profile-modal-overlay"></div>
<div class="modal" id="profile-modal">
    <div class="modal-header">
        <h2>Identity_Log</h2> <button class="modal-close-btn" id="profile-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body profile-body">
        <div class="profile-avatar-container">
            <img id="profileAvatar" src="" alt="Avatar" class="profile-avatar-img">
            <div class="avatar-ring"></div>
        </div>
        
        <div class="profile-main-info">
            <h3 id="profileNickname">Loading...</h3>
            <div class="profile-address-box" onclick="copyToClipboard(this.innerText)" title="Click to Copy">
                <span id="profileAddress">0x000...0000</span> <i class="fa-regular fa-copy" style="font-size: 12px; opacity: 0.6;"></i>
            </div>
        </div>

        <div class="profile-stats-grid">
            <div class="stat-box">
                <span class="stat-label">Referral</span>
                <span class="stat-value" id="profileRefCount">-</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Status</span>
                <span class="stat-value active-glow">Active</span>
            </div>
             </div>
    </div>
</div>

  <div id="victory-overlay">
    <canvas id="victory-canvas"></canvas>
    <div class="victory-content">
        <div class="victory-glitch" data-text="NEURAL SYNC COMPLETE">NEURAL SYNC COMPLETE</div>
        <h1 class="victory-title">YOU WIN!</h1>
        <p class="victory-subtitle">Funds transferring to your secure wallet...</p>
        <button class="claim-victory-btn" onclick="hideVictoryScreen()">ACKNOWLEDGE</button>
    </div>
  </div>

  <section class="leaderboard-section">
    <h2 class="section-title">Leaderboard</h2>
    
    <div class="lb-tabs">
        <button class="lb-tab active" onclick="switchLeaderboard('pilot')" id="tab-pilot">Top Pilot</button>
        <button class="lb-tab" onclick="switchLeaderboardreferral('referral')" id="tab-referral">Top Referral</button>
    </div>

    <div class="leaderboard-container">
        <div class="lb-header" id="lb-header-row">
            <span>Rank</span>
            <span>Player</span>
            <span>Score ($)</span> <span>ETH</span>
            <span>USDT</span> 
        </div>

        <div id="leaderboard-list">
            <div class="lb-loading">> No data is displayed...</div>
        </div>
    </div>
  </section>

<audio id="sfx-click" src="clickI.mp3" preload="auto"></audio>
<audio id="sfx-spin" src="spinI.mp3" preload="auto"></audio>
<audio id="sfx-win" src="winI.mp3" preload="auto"></audio>
<audio id="sfx-coin" src="coin.mp3" preload="auto"></audio>

  <div id="toast-container"></div>
    
  <footer>
    <div id="footer" class="social-icons">
        <a href="https://x.com/FaylottoXyz" target="_blank"><i class="fa-brands fa-twitter"></i></a>
        <a href="https://t.me/FaylottoXyz" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://t.me/Faylotto" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://discord.gg/6uMYTdCZwJ" target="_blank"><i class="fa-brands fa-discord"></i></a>
        <a href="https://facebook.com/Faylotto" target="_blank"><i class="fa-brands fa-facebook"></i></a>
    </div>
    <p>
      Â© Powered By Faylotto.
      <span>
        <a href="https://docs.faylotto.xyz/policy/AllRightsReserved" style="color: #007bff; text-decoration: none;" target="_blank">
          <span id="year"></span> All rights reserved. 
        </a>
      </span>
      Play responsibly.
      <span>
        <a href="privacypolicy" style="color: #007bff; text-decoration: none;" target="_blank">
          Privacy Policy.
        </a>
      </span>
    </p>
  </footer>

  <script>
    // ==================================================================
    // 1. KONFIGURASI & ABI
    // ==================================================================
    
    const FAYLOTTO_ADDRESS = "0x998d821efa06D7C24260e41EBC68C9fD3f9219DA"; 
    const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2"; 
    const BABYDOGE_ADDRESS = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";   
    
    const BASE_SEPOLIA_CHAIN_ID = '0x14A34'; 
    const BASE_SEPOLIA_RPC = "https://sepolia.base.org";
    const HTTPS_URL = BASE_SEPOLIA_RPC;
    const WSS_URL = "wss://base-sepolia.drpc.org";
    const ETH_USD_PRICE_FEED_ADDRESS = "0x4aDC67696bA383F43DD60A9e78F2C97Fbbfc7cb1";
    
    
    // ABI ERC20 Standar
    const USDT_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
      

    
    // ABI FAYLOTTO (LENGKAP)
    const FAYLOTTO_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_babyDogeToken","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"},{"internalType":"address","name":"_nativeUsdPriceFeedAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetBabyDoge","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetFree","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetNative","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetUSDT","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"FreeSpinNoPrize","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"prizeTier","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FreeSpinWon","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"referralCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalEthClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalUsdtClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalBabyDogeClaimed","type":"uint256"}],"name":"LeaderboardReferralStatsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"int256","name":"newNetUsdScore","type":"int256"},{"indexed":false,"internalType":"int256","name":"netEth","type":"int256"},{"indexed":false,"internalType":"int256","name":"netUsdt","type":"int256"},{"indexed":false,"internalType":"int256","name":"netBabyDoge","type":"int256"}],"name":"LeaderboardScoreUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"babyDogeAmount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_BETS_PER_PLAYER","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_NATIVE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_USDT_UNSCALED","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"babyDogeDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeUsdPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeBalances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"freeBetCost","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"freeSpinHistory","outputs":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getFreeSpinHistory","outputs":[{"components":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.FreeSpinWinner[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLatestNativePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLeaderboardPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"internalType":"uint256","name":"babyDogeAmount","type":"uint256"},{"internalType":"uint256","name":"usdWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"usdtReward","type":"uint256"},{"internalType":"uint256","name":"babyDogeReward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalUSDT","type":"uint256"},{"internalType":"uint256","name":"totalBabyDoge","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"},{"internalType":"uint256","name":"totalWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isFreeSpinPaused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"leaderboardPlayers","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"leaderboardStats","outputs":[{"internalType":"int256","name":"netEth","type":"int256"},{"internalType":"int256","name":"netUsdt","type":"int256"},{"internalType":"int256","name":"netBabyDoge","type":"int256"},{"internalType":"int256","name":"netUsdScore","type":"int256"},{"internalType":"uint256","name":"totalReferralEthClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralUsdtClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralBabyDogeClaimed","type":"uint256"},{"internalType":"uint256","name":"referralCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nativeUsdDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextFreeSpinId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetNative","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"quotaTier1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier2","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier3","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier4","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier5","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier6","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier7","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier8","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier9","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsBabyDoge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsUSDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"setBabyDogePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"cost","type":"uint256"}],"name":"setFreeBetCost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"spinCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"spinFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdtDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

      
    // --- KONFIGURASI UI ---
    const ETH_LOGO_PATH = "eth.svg"; 
    const USDT_LOGO_PATH = "usdt.svg"; 
    const BABYDOGE_LOGO_PATH = "bb.svg";
    const AUTO_CONNECT_KEY = "faylotto_v3_session";
    
    // ==================================================================
    // 2. GLOBAL STATE
    // ==================================================================
    let provider, signer, userAddress;
    let faylottoContract, usdtContract, babyDogeContract;
    
    // Balance Variables
    let rawEthBalance, rawUsdtBalance, rawBabyDogeBalance;
    let rawFreeBalance = ethers.BigNumber.from(0);
    let usdtDecimals = 6, babyDogeDecimals = 18;
    
    // Round & Game State
    let currentRoundId;
    let visualTimer = null;
    let isSpinning = false;
    let isFinalizing = false;
    
    // Wheel & Player State
    let players = {}; 
    let playersArray = []; 
    let totalWeight = ethers.BigNumber.from(0);
    let currentRotation = 0; 
    
    // Canvas Config
    let ctx, cw, ch, cx, cy, outerR, innerR;
    const PLAYER_COLORS = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#F9D423", "#FFA62B", "#7B72E9", "#3DCC91", "#FF90B3", "#C0E218", "#3498DB"];

    // Referral & Prices
    let pendingReferrerNickname = null; 
    let currentEthPrice = 3000; 
    let currentBabyDogePrice = 0; 
    
    // Leaderboard State 
    let currentLbMode = 'pilot'; 

    // ==================================================================
    // 3. CORE WALLET FUNCTIONS
    // ==================================================================

    async function toggleWallet(isAutoConnect = false) {
        if (userAddress && !isAutoConnect) return; 
        if (!window.ethereum) return showStatus("Please install MetaMask!", "error");
        
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            
            if (isAutoConnect) {
                const accounts = await provider.listAccounts();
                if (accounts.length === 0) {
                    localStorage.removeItem(AUTO_CONNECT_KEY); 
                    return; 
                }
                signer = provider.getSigner(accounts[0]);
            } else {
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
            }
            
            const network = await provider.getNetwork();
            if (network.chainId.toString() !== '84532' && network.chainId.toString() !== '0x14a34') {
                showStatus("Wrong Network. Switch to Base Sepolia.", "warning");
                try {
                    await provider.send('wallet_switchEthereumChain', [{ chainId: BASE_SEPOLIA_CHAIN_ID }]);
                } catch(e) { showStatus("Failed to switch network", "error"); return; }
            }

            userAddress = await signer.getAddress(); 
            
            // Init Contracts
            usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
            babyDogeContract = new ethers.Contract(BABYDOGE_ADDRESS, USDT_ABI, signer);
            faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, signer);

            document.getElementById("walletBtn").innerText = "Dashboard";
            document.getElementById("referralBtn").style.display = "block"; 
            document.getElementById("walletAddress").innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
            
            localStorage.setItem(AUTO_CONNECT_KEY, (new Date().getTime() + 86400000).toString());
            
            if (!isAutoConnect) showStatus("Wallet Connected!", "success");

            await updateUserBalances(); 
            await fetchAndDisplayRoundData(); 
            await fetchReferralData(); 
            setupEventListeners(); 

            if (pendingReferrerNickname) await handlePendingReferral(); 

        } catch (err) {
            console.error("Connection Error:", err);
            showStatus(err.message.slice(0, 50), "error");
        }
    }

    function disconnectWallet() {
        userAddress = null; signer = null;
        document.getElementById("walletBtn").innerText = "Connect Wallet";
        document.getElementById("referralBtn").style.display = "none";
        document.getElementById("statusText").innerText = "Wallet not connected";
        localStorage.removeItem(AUTO_CONNECT_KEY);
        hideWalletModal();
        resetRoundUI();
        showStatus("Wallet Disconnected", "info");
    }

    async function updateUserBalances() {
        if (!userAddress) return;
        try {
            rawEthBalance = await provider.getBalance(userAddress);
            document.getElementById("ethBalance").innerText = parseFloat(ethers.utils.formatEther(rawEthBalance)).toFixed(4);
            document.getElementById("modalEthBalance").innerText = parseFloat(ethers.utils.formatEther(rawEthBalance)).toFixed(4);

            if(usdtContract) {
                usdtDecimals = await usdtContract.decimals();
                rawUsdtBalance = await usdtContract.balanceOf(userAddress);
                const usdtFmt = parseFloat(ethers.utils.formatUnits(rawUsdtBalance, usdtDecimals)).toFixed(2);
                document.getElementById("usdtBalance").innerText = usdtFmt;
                document.getElementById("modalUsdtBalance").innerText = usdtFmt;
            }
            if(babyDogeContract) {
                babyDogeDecimals = await babyDogeContract.decimals();
                rawBabyDogeBalance = await babyDogeContract.balanceOf(userAddress);
                const babyFmt = parseFloat(ethers.utils.formatUnits(rawBabyDogeBalance, babyDogeDecimals)).toFixed(0);
                document.getElementById("babyDogeBalance").innerText = babyFmt;
                document.getElementById("modalBabyDogeBalance").innerText = babyFmt;
            }
            if(faylottoContract) {
                rawFreeBalance = await faylottoContract.freeBalances(userAddress);
                const freeFmt = parseFloat(ethers.utils.formatEther(rawFreeBalance)).toFixed(0);
                document.getElementById("freeBalance").innerText = freeFmt;
                document.getElementById("modalFreeBalance").innerText = freeFmt;
            }
        } catch(e) { console.error("Balance sync error", e); }
    }

    // ==================================================================
    // 4. GAME LOGIC & SYNC
    // ==================================================================

    function addBetToState(player, eth, usdt, baby, free, weight, isRealtime) {
        const key = player.toLowerCase();
        
        if (!players[key]) {
            players[key] = {
                id: player,
                eth: ethers.BigNumber.from(0),
                usdt: ethers.BigNumber.from(0),
                baby: ethers.BigNumber.from(0),
                free: ethers.BigNumber.from(0),
                weight: ethers.BigNumber.from(0),
                color: PLAYER_COLORS[Object.keys(players).length % PLAYER_COLORS.length]
            };
        }

        // Akumulasi nilai
        players[key].eth = players[key].eth.add(eth);
        players[key].usdt = players[key].usdt.add(usdt);
        players[key].baby = players[key].baby.add(baby);
        players[key].free = players[key].free.add(free);
        players[key].weight = players[key].weight.add(weight);

        if (isRealtime) updateBetList();
    }

    async function fetchAndDisplayRoundData() {
        let contract = faylottoContract || new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
        if (!contract || isSpinning) return;

        try {
            const latestRoundId = await contract.currentRoundId();
            
            // Deteksi jika ronde berubah di blockchain (reset lokal jika perlu)
            if (currentRoundId && !latestRoundId.eq(currentRoundId)) {
                console.log("Chain advanced. Resetting UI...");
                resetRoundUI(); 
            }
            currentRoundId = latestRoundId;
            
            // [id, start, end, finalized, winner, eth, usdt, baby, playerCount, weight]
            const roundInfo = await contract.getRoundBasic(currentRoundId);

            // Sync Players
            const onChainCount = roundInfo[8].toNumber(); 
            if (Object.keys(players).length !== onChainCount) {
                const playersList = await contract.getRoundPlayers(currentRoundId);
                players = {}; 
                
                for (const pAddr of playersList) {
                    const d = await contract.getPlayerDeposits(currentRoundId, pAddr);
                    addBetToState(pAddr, d[0], d[1], d[2], ethers.BigNumber.from(0), d[3], false);
                }
                updateBetList();
            }

            updateMyDeposits();

            // Timer Logic
            const endTime = roundInfo[2].toNumber() * 1000;
            const isFinalized = roundInfo[3];
            
            if (visualTimer) clearInterval(visualTimer);
            
            if (isFinalized) {
                // Ronde sudah selesai dan difinalisasi on-chain
                document.getElementById("statusText").innerText = "Round Finalized. Waiting new round...";
                // Coba cek lagi nanti
                setTimeout(fetchAndDisplayRoundData, 3000);
            } else if (Date.now() < endTime) {
                // Ronde Masih Jalan
                document.getElementById("statusText").innerText = `Round #${currentRoundId} Live!`;
                document.getElementById("placeBetBtn").style.display = "block";
                document.getElementById("finalizeBtn").style.display = "none";
                startVisualTimer(endTime);
            } else {
                // Waktu Habis, Belum Finalisasi
                document.getElementById("statusText").innerText = "Round Ended!";
                document.getElementById("timerText").innerText = "00:00";
                
                // [PENTING] Panggil fungsi ini agar tombol berubah
                showFinalizeButton(); 
            }

        } catch (e) { console.error("Sync Error", e); }
    }

    function startVisualTimer(endTime) {
        if (visualTimer) clearInterval(visualTimer);
        visualTimer = setInterval(() => {
            const now = Date.now();
            const timeLeft = endTime - now;
            
            if (timeLeft <= 0) {
                clearInterval(visualTimer);
                document.getElementById("timerText").innerText = "00:00";
                // [PENTING] Inilah fungsi yang sebelumnya hilang
                showFinalizeButton(); 
                return;
            }
            
            const m = Math.floor(left / 60000);
            const s = Math.floor((left % 60000) / 1000);
            document.getElementById("timerText").innerText = `${m}:${s < 10 ? '0'+s : s}`;
        }, 1000);
    }

    // [BARU & PENTING] FUNGSI YANG HILANG UNTUK TRANSISI TOMBOL
    function showFinalizeButton() {
        isFinalizing = true;
        document.getElementById("statusText").innerText = "Round Ended! Please Finalize.";
        
        // Sembunyikan Place Bet
        const pb = document.getElementById("placeBetBtn");
        if(pb) pb.style.display = "none";

        // Tampilkan Finalize
        const fb = document.getElementById("finalizeBtn");
        if(fb) {
            fb.style.display = "block";
            fb.disabled = false;
            fb.innerText = "Finalize Round";
        }
    }

    async function updateMyDeposits() {
        if (!userAddress || !players[userAddress.toLowerCase()]) {
             document.getElementById("myEthDeposit").innerText = "0";
             document.getElementById("myUsdtDeposit").innerText = "0";
             document.getElementById("myBabyDogeDeposit").innerText = "0";
             document.getElementById("myFreeDeposit").innerText = "0";
             return;
        }
        const p = players[userAddress.toLowerCase()];
        document.getElementById("myEthDeposit").innerText = parseFloat(ethers.utils.formatEther(p.eth)).toFixed(4);
        document.getElementById("myUsdtDeposit").innerText = parseFloat(ethers.utils.formatUnits(p.usdt, usdtDecimals)).toFixed(2);
        document.getElementById("myBabyDogeDeposit").innerText = parseFloat(ethers.utils.formatUnits(p.baby, babyDogeDecimals)).toFixed(0);
        document.getElementById("myFreeDeposit").innerText = parseFloat(ethers.utils.formatUnits(p.free, 18)).toFixed(0);
    }

    function setupEventListeners() {
        if (!faylottoContract) return;
        const c = faylottoContract;
        c.removeAllListeners();

        c.on("BetNative", (rid, player, amt, weight) => {
            if (currentRoundId && rid.eq(currentRoundId)) {
                addBetToState(player, amt, ethers.constants.Zero, ethers.constants.Zero, ethers.constants.Zero, weight, true);
            }
        });
        c.on("BetUSDT", (rid, player, amt, weight) => {
            if (currentRoundId && rid.eq(currentRoundId)) {
                addBetToState(player, ethers.constants.Zero, amt, ethers.constants.Zero, ethers.constants.Zero, weight, true);
            }
        });
        c.on("BetBabyDoge", (rid, player, amt, weight) => {
            if (currentRoundId && rid.eq(currentRoundId)) {
                addBetToState(player, ethers.constants.Zero, ethers.constants.Zero, amt, ethers.constants.Zero, weight, true);
            }
        });
        c.on("BetFree", (rid, player, amt) => {
            if (currentRoundId && rid.eq(currentRoundId)) {
                addBetToState(player, ethers.constants.Zero, ethers.constants.Zero, ethers.constants.Zero, amt, ethers.constants.Zero, true);
                setTimeout(fetchAndDisplayRoundData, 2000); 
            }
        });
        c.on("WinnerRecorded", (wid, rid, winner) => {
            if (currentRoundId && rid.eq(currentRoundId) && !isSpinning) {
                handleRoundFinalized(winner);
            }
        });
    }

    // ==================================================================
    // 5. BETTING & INTERACTION
    // ==================================================================

    function showBetModal() {
        if (!userAddress) return showStatus("Connect wallet first!", "error");
        if (isFinalizing) return showStatus("Round is ending, new bets are closed.", "warning"); 
        
        document.getElementById("bet-modal-overlay").classList.add("show");
        document.getElementById("bet-modal").classList.add("show");

        // Update saldo di modal
        document.getElementById("modalEthBalance").innerText = document.getElementById("ethBalance").innerText;
        document.getElementById("modalUsdtBalance").innerText = document.getElementById("usdtBalance").innerText;
        document.getElementById("modalBabyDogeBalance").innerText = document.getElementById("babyDogeBalance").innerText;
        const freeEl = document.getElementById("modalFreeBalance");
        if(freeEl) freeEl.innerText = document.getElementById("freeBalance").innerText;

        document.getElementById("betAmountInput").value = "";
        document.getElementById("betCurrencySelect").value = "ETH"; 
        document.getElementById('currency-icon').src = "eth.svg";
    }

    function hideBetModal() {
        document.getElementById("bet-modal-overlay").classList.remove("show");
        document.getElementById("bet-modal").classList.remove("show");
    }

    function setAmountByPercent(percent) {
        const currency = document.getElementById("betCurrencySelect").value;
        let min, max, decimalsToDisplay, userBalanceBN;
        let decimals = 18; 

        if (currency === 'ETH') {
            userBalanceBN = rawEthBalance || ethers.BigNumber.from(0);
            decimalsToDisplay = 8; 
            min = "0.00005"; max = "0.00265"; decimals = 18;
        } else if (currency === 'USDT') {
            userBalanceBN = rawUsdtBalance || ethers.BigNumber.from(0);
            decimalsToDisplay = 2; 
            min = "0.5"; max = "10.0"; decimals = usdtDecimals;
        } else if (currency === 'BABYDOGE') {
            userBalanceBN = rawBabyDogeBalance || ethers.BigNumber.from(0);
            decimalsToDisplay = 0; 
            min = "1000000"; max = "10000000000"; decimals = babyDogeDecimals;
        } else if (currency === 'FREE') {
            userBalanceBN = rawFreeBalance || ethers.BigNumber.from(0);
            decimalsToDisplay = 0; 
            min = "500000"; max = "10000000000"; decimals = 18; 
        } else { return; }

        const minBN = ethers.utils.parseUnits(min, decimals);
        const maxBN = ethers.utils.parseUnits(max, decimals);
        let amountToSetBN;

        if (percent === 0.10) { 
            amountToSetBN = minBN;
        } else {
            let calculationBase = userBalanceBN.lt(maxBN) ? userBalanceBN : maxBN;
            if (percent === 1.00) amountToSetBN = calculationBase;
            else amountToSetBN = calculationBase.mul(Math.floor(percent * 100)).div(100);
        }

        if (amountToSetBN.lt(minBN) && userBalanceBN.gte(minBN)) amountToSetBN = minBN;
        if (amountToSetBN.gt(maxBN)) amountToSetBN = maxBN;
        if (amountToSetBN.gt(userBalanceBN)) amountToSetBN = userBalanceBN;

        const formattedAmount = ethers.utils.formatUnits(amountToSetBN, decimals);
        document.getElementById("betAmountInput").value = parseFloat(formattedAmount).toFixed(decimalsToDisplay);
    }

    async function confirmBet() {
        const amt = document.getElementById("betAmountInput").value;
        const cur = document.getElementById("betCurrencySelect").value;
        if (!amt || parseFloat(amt) <= 0) return showStatus("Invalid amount", "warning");

        const btn = document.getElementById("confirmBetBtn");
        btn.disabled = true; 
        btn.innerText = "Processing..."; 
        
        try {
            let tx;
            if (cur === 'ETH') {
                btn.innerText = "Sign Transaction..."; 
                tx = await faylottoContract.placeBetNative({value: ethers.utils.parseEther(amt)});
            } else if (cur === 'USDT') {
                const wei = ethers.utils.parseUnits(amt, usdtDecimals);
                showStatus("Checking allowance...", "load");
                const allow = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
                if (allow.lt(wei)) {
                     btn.innerText = "Approving USDT..."; 
                     showStatus("Please Approve USDT in Wallet...", "warning"); 
                     const approveTx = await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
                     showStatus("Waiting for Approval...", "load");
                     await approveTx.wait(); 
                     showStatus("Approval Success! Now confirming bet...", "success");
                }
                btn.innerText = "Sign Bet...";
                tx = await faylottoContract.placeBetUSDT(wei);
            } else if (cur === 'BABYDOGE') {
                const wei = ethers.utils.parseUnits(amt, babyDogeDecimals);
                showStatus("Checking allowance...", "load");
                const allow = await babyDogeContract.allowance(userAddress, FAYLOTTO_ADDRESS);
                if (allow.lt(wei)) {
                     btn.innerText = "Approving BabyDoge...";
                     showStatus("Please Approve BabyDoge...", "warning");
                     const approveTx = await babyDogeContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
                     showStatus("Waiting for Approval...", "load");
                     await approveTx.wait();
                     showStatus("Approval Success!", "success");
                }
                btn.innerText = "Sign Bet...";
                tx = await faylottoContract.placeBetBabyDoge(wei);
            } else if (cur === 'FREE') {
                const wei = ethers.utils.parseUnits(amt, 18); 
                btn.innerText = "Sign Free Bet...";
                tx = await faylottoContract.placeBetFree(wei);
            }

            showStatus("Transaction Sent! Waiting...", "load");
            await tx.wait();
            showStatus("Bet Placed Successfully!", "success");
            hideBetModal();
            updateUserBalances(); 
            setTimeout(fetchAndDisplayRoundData, 2000); 

        } catch (e) {
            console.error(e);
            let msg = e.reason || e.message || "Transaction Failed";
            if (msg.includes("user rejected")) msg = "Transaction rejected by user.";
            if (msg.includes("insufficient funds")) msg = "Insufficient funds for gas/bet.";
            showStatus(msg.slice(0,60), "error");
        } finally {
            btn.disabled = false; 
            btn.innerText = "Confirm Bet"; 
        }
    }

    async function callFinalizeRound() {
        if (!userAddress || !faylottoContract) return showStatus("Connect wallet first", "error");
        
        const finalizeBtn = document.getElementById("finalizeBtn");
        finalizeBtn.disabled = true;
        finalizeBtn.innerText = "Processing...";
        showStatus("Sending Finalize Transaction...", "load");

        try {
            const tx = await faylottoContract.finalizeRound(currentRoundId);
            showStatus("Finalizing... Waiting for confirmation", "load");
            
            const receipt = await tx.wait(); 
            showStatus("Transaction Confirmed!", "success");

            // Panggil fungsi pemaksa update dengan Polling
            const finishedRoundId = currentRoundId;
            await forceWaitForNextRound(finishedRoundId);

        } catch (e) {
            console.error(e);
            let msg = e.reason || e.message || "Finalize Failed";
            showStatus(msg.slice(0, 60), "error");
            finalizeBtn.disabled = false;
            finalizeBtn.innerText = "Finalize Round";
        }
    }

    async function forceWaitForNextRound(oldRoundId) {
        console.log(`ðŸ›‘ OLD Round: ${oldRoundId}. Waiting for NEW Round...`);
        
        // UI Update Langsung
        document.getElementById("finalizeBtn").style.display = "none";
        
        const placeBetBtn = document.getElementById("placeBetBtn");
        placeBetBtn.style.display = "block";
        placeBetBtn.disabled = true;
        placeBetBtn.innerText = "Loading New Round...";
        
        document.getElementById("statusText").innerText = "Creating Next Round...";
        document.getElementById("timerText").innerText = "Loading...";

        // Hard Polling
        let retries = 0;
        const maxRetries = 60; 

        const checkInterval = setInterval(async () => {
            retries++;
            try {
                const tempProvider = provider || new ethers.providers.JsonRpcProvider(HTTPS_URL);
                const contract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, tempProvider);
                
                const latestIdBN = await contract.currentRoundId();
                
                // Cek ID
                if (latestIdBN.gt(oldRoundId)) {
                    console.log(`âœ… NEW Round Detected: ${latestIdBN.toString()}`);
                    clearInterval(checkInterval); 
                    
                    currentRoundId = latestIdBN;
                    resetRoundUI(); 
                    await fetchAndDisplayRoundData();
                    
                    showStatus(`Round ${latestIdBN} Started!`, "success");
                } else {
                    console.log(`â³ Still on old round... (${retries})`);
                    if(document.getElementById("statusText")) {
                        document.getElementById("statusText").innerText = `Waiting for block... (${retries})`;
                    }
                }

                if (retries >= maxRetries) {
                    clearInterval(checkInterval);
                    showStatus("Network slow. Please refresh.", "warning");
                }
            } catch (err) {
                console.error("Polling error:", err);
            }
        }, 2000); 
    }

    // ==================================================================
    // 6. CANVAS / WHEEL LOGIC
    // ==================================================================

    function initCanvas() {
        const canvas = document.getElementById('donutCanvas');
        const container = document.querySelector('.donut-wrap');
        if (!canvas || !container) return;
        
        ctx = canvas.getContext('2d');
        function resize() {
            const size = container.clientWidth;
            canvas.width = size * window.devicePixelRatio;
            canvas.height = size * window.devicePixelRatio;
            canvas.style.width = size + "px";
            canvas.style.height = size + "px";
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            cw = size; ch = size;
            cx = cw / 2; cy = ch / 2;
            outerR = cw * 0.45;
            innerR = cw * 0.25;
            drawDonut();
        }
        window.addEventListener('resize', resize);
        resize();
    }

    function updateBetList() {
        const list = document.getElementById("bet-list");
        list.innerHTML = "";
        playersArray = [];
        totalWeight = ethers.BigNumber.from(0);

        for (const key in players) {
            const p = players[key];
            playersArray.push(p);
            totalWeight = totalWeight.add(p.weight);
        }
        playersArray.sort((a,b) => b.weight.sub(a.weight).gt(0) ? 1 : -1);

        if (playersArray.length === 0) {
            list.innerHTML = "<p>No bets yet.</p>";
        } else {
            playersArray.forEach(p => {
                const div = document.createElement("div");
                div.className = "bet-list-item";
                div.style.borderLeft = `4px solid ${p.color}`;
                const eth = parseFloat(ethers.utils.formatEther(p.eth));
                const baby = parseFloat(ethers.utils.formatUnits(p.baby, babyDogeDecimals));
                div.innerHTML = `
                    <div class="player-id" onclick="showPlayerProfile('${p.id}')">
                        ${p.id === userAddress ? "YOU" : p.id.slice(0,6)+'...'+p.id.slice(-4)}
                    </div>
                    <div class="player-bets">
                        ${eth > 0 ? `<span>${eth.toFixed(4)} ETH</span><br>` : ''}
                        ${baby > 0 ? `<span>${baby.toFixed(0)} BabyDoge</span>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        }
        calculateAnglesAndDraw();
    }

    function calculateAnglesAndDraw() {
        let currentAngle = 0;
        const totalW_BN = totalWeight;
        playersArray.forEach(p => {
            p.startAngle = currentAngle;
            let percentage = 0;
            if (totalW_BN.gt(0)) {
                const w = p.weight.mul(1000000).div(totalW_BN).toNumber();
                percentage = w / 1000000.0;
            }
            if (percentage === 0 && playersArray.length > 0) percentage = 0.01; 
            p.endAngle = currentAngle + (percentage * Math.PI * 2);
            currentAngle = p.endAngle;
        });
        drawDonut(currentRotation);
    }

    function drawDonut(rotationDeg = 0) {
        if (!ctx) return;
        ctx.clearRect(0, 0, cw, ch);
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(rotationDeg * Math.PI / 180);

        if (playersArray.length === 0) {
            ctx.beginPath();
            ctx.arc(0, 0, outerR, 0, Math.PI*2);
            ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = "#ffffff"; ctx.font = "14px Arial";
            ctx.textAlign = "center"; ctx.fillText("Waiting for bets...", 0, 0);
        } else {
            playersArray.forEach(p => {
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, outerR, p.startAngle, p.endAngle);
                ctx.closePath();
                ctx.fillStyle = p.color;
                ctx.fill();
            });
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(0, 0, innerR, 0, Math.PI*2);
            ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
        }
        ctx.restore();
        
        ctx.fillStyle = "#FF0000";
        ctx.beginPath();
        ctx.moveTo(cx, cy - outerR - 10);
        ctx.lineTo(cx - 10, cy - outerR - 25);
        ctx.lineTo(cx + 10, cy - outerR - 25);
        ctx.fill();
    }

    // 1. LOGIKA SETELAH SPIN SELESAI (Memastikan transisi otomatis)
    async function handleRoundFinalized(winnerAddr) {
        isSpinning = true;
        
        const target = playersArray.find(p => p.id.toLowerCase() === winnerAddr.toLowerCase());
        if (!target) {
            console.warn("Winner not found locally, resetting...");
            isSpinning = false; 
            isFinalizing = false;
            resetRoundUI(); 
            return;
        }

        const midRad = (target.startAngle + target.endAngle) / 2;
        const midDeg = midRad * 180 / Math.PI;
        const targetRotation = 270 - midDeg; 
        const spins = 5 * 360; 
        const finalRot = spins + targetRotation;
        
        const start = performance.now();
        const duration = 6000; 

        function animate(time) {
            const elapsed = time - start;
            const t = Math.min(1, elapsed / duration);
            const ease = 1 - Math.pow(1 - t, 3);
            currentRotation = ease * finalRot;
            drawDonut(currentRotation);

            if (t < 1) {
                requestAnimationFrame(animate);
            } else {
                isSpinning = false;
                isFinalizing = false; 
                showVictoryScreen(); 
                playSound('sfx-win');
                showStatus(`Winner: ${winnerAddr.slice(0,6)}...`, "success");
                
                setTimeout(() => {
                    hideVictoryScreen(); 
                    resetRoundUI();      
                }, 5000);
            }
        }
        requestAnimationFrame(animate);
    }

    // 2. LOGIKA RESET UI
    function resetRoundUI() {
        console.log("ðŸ§¹ Resetting UI Components...");
        
        isSpinning = false;
        isFinalizing = false;
        players = {};
        playersArray = [];
        totalWeight = ethers.BigNumber.from(0);
        currentRotation = 0;

        updateBetList();
        if(ctx) drawDonut();

        if(document.getElementById("myEthDeposit")) document.getElementById("myEthDeposit").innerText = "0";
        if(document.getElementById("myUsdtDeposit")) document.getElementById("myUsdtDeposit").innerText = "0";
        if(document.getElementById("myBabyDogeDeposit")) document.getElementById("myBabyDogeDeposit").innerText = "0";
        if(document.getElementById("myFreeDeposit")) document.getElementById("myFreeDeposit").innerText = "0";

        // Kembalikan Tombol Place Bet
        const placeBetBtn = document.getElementById("placeBetBtn");
        if (placeBetBtn) {
            placeBetBtn.style.display = "block";
            placeBetBtn.disabled = false; 
            placeBetBtn.innerText = "Place Bet";
        }

        const finalizeBtn = document.getElementById("finalizeBtn");
        if (finalizeBtn) {
            finalizeBtn.style.display = "none";
            finalizeBtn.disabled = false;
            finalizeBtn.innerText = "Finalize Round";
        }
        
        fetchAndDisplayWinners();
        fetchAndRenderLeaderboard();
    }

    // ==================================================================
    // 7. REFERRAL & SOCIAL
    // ==================================================================

    async function handlePendingReferral() {
        if(!userAddress || !pendingReferrerNickname) return;
        if(confirm(`Set Referrer to: ${pendingReferrerNickname}?`)) {
             try {
                 const tx = await faylottoContract.setReferralByNickname(pendingReferrerNickname);
                 showStatus("Setting referrer...", "load");
                 await tx.wait();
                 showStatus("Referrer set!", "success");
                 pendingReferrerNickname = null;
             } catch(e) { showStatus("Referral Failed", "error"); }
        }
    }
    
    async function fetchReferralData() {
        if(!userAddress) return;
        try {
            const nick = await faylottoContract.nicknames(userAddress);
            const ref = await faylottoContract.referrerOf(userAddress);
            const rewards = await faylottoContract.getReferralRewards(userAddress);
            
            document.getElementById("myNickname").innerText = nick || "Not Set";
            document.getElementById("myReferrer").innerText = ref === ethers.constants.AddressZero ? "None" : ref.slice(0,6)+'...';
            document.getElementById("ethRewards").innerText = parseFloat(ethers.utils.formatEther(rewards.ethReward)).toFixed(5);
            
            if(nick) {
                document.getElementById("referralLinkSection").style.display = "block";
                document.getElementById("referralLinkInput").value = window.location.origin + "?ref=" + nick;
            }
        } catch(e) { console.error(e); }
    }

    async function createNickname() {
        const val = document.getElementById("nicknameInput").value;
        if(val.length < 3) return showStatus("Min 3 chars", "warning");
        try {
            const tx = await faylottoContract.createNickname(val);
            await tx.wait();
            showStatus("Nickname created!", "success");
            fetchReferralData();
        } catch(e) { showStatus("Error creating nickname", "error"); }
    }

    async function claimRewards() {
        try {
            const tx = await faylottoContract.claimReferralRewards();
            await tx.wait();
            showStatus("Rewards Claimed!", "success");
            fetchReferralData();
            updateUserBalances();
        } catch(e) { showStatus("Claim Failed", "error"); }
    }

    function switchLeaderboard(mode) {
        currentLbMode = mode;
        document.querySelectorAll('.lb-tab').forEach(b => b.classList.remove('active'));
        if(mode === 'pilot') document.getElementById('tab-pilot').classList.add('active');
        else document.getElementById('tab-referral').classList.add('active');

        const header = document.getElementById('lb-header-row');
        if (mode === 'pilot') {
            header.innerHTML = `<span>Rank</span><span>Pilot</span><span>Win Score</span><span>ETH</span><span>USDT</span>`;
        } else {
            header.innerHTML = `<span>Rank</span><span>Inviter</span><span>Invites</span><span>ETH Earned</span><span>USDT Earned</span>`;
        }
        fetchAndRenderLeaderboard();
    }

    function switchLeaderboardreferral(mode) {
        switchLeaderboard(mode);
    }

    async function fetchAndRenderLeaderboard() {
        const list = document.getElementById("leaderboard-list");
        if (!list) return;
        list.innerHTML = "<div class='lb-loading'>> Scanning Network Data...</div>";

        let contract = faylottoContract || new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);

        try {
            let usdtDec = 6, babyDec = 18;
            try {
                if (usdtContract) usdtDec = await usdtContract.decimals();
                if (babyDogeContract) babyDec = await babyDogeContract.decimals();
            } catch (e) {}

            const playersList = await contract.getLeaderboardPlayers();
            if (playersList.length === 0) {
                list.innerHTML = "<div class='lb-loading' style='animation:none;'>NO DATA RECORDED.</div>";
                return;
            }

            let leaderboardData = [];
            for (let playerAddr of playersList) {
                const stats = await contract.leaderboardStats(playerAddr);
                leaderboardData.push({
                    addr: playerAddr,
                    score: stats[3], netEth: stats[0], netUsdt: stats[1], netBaby: stats[2],
                    refCount: stats[7], refEth: stats[4], refUsdt: stats[5], refBaby: stats[6]
                });
            }

            leaderboardData.sort((a, b) => {
                if (currentLbMode === 'pilot') {
                    if (b.score.gt(a.score)) return 1;
                    if (b.score.lt(a.score)) return -1;
                    return 0;
                } else {
                    if (b.refCount.gt(a.refCount)) return 1;
                    if (b.refCount.lt(a.refCount)) return -1;
                    return 0;
                }
            });

            const topPlayers = leaderboardData.slice(0, 20);
            list.innerHTML = "";
            topPlayers.forEach((p, index) => {
                const rank = index + 1;
                const shortAddr = p.addr.slice(0, 6) + "..." + p.addr.slice(-4);
                const isMe = userAddress && p.addr.toLowerCase() === userAddress.toLowerCase();
                const displayName = isMe ? "YOU" : shortAddr;
                const rowStyle = isMe ? 'color:var(--cyan-main); font-weight:bold; background:rgba(0,255,136,0.05);' : '';
                let col3, col4, col5;

                if (currentLbMode === 'pilot') {
                    const scoreFmt = parseFloat(ethers.utils.formatEther(p.score)).toFixed(2); 
                    const ethFmt = parseFloat(ethers.utils.formatEther(p.netEth)).toFixed(4);
                    const usdtFmt = parseFloat(ethers.utils.formatUnits(p.netUsdt, usdtDec)).toFixed(2);
                    const babyFmt = parseFloat(ethers.utils.formatUnits(p.netBaby, babyDec)).toFixed(0);
                    col3 = `$${scoreFmt}`; col4 = `${ethFmt} ETH`; col5 = `${usdtFmt} USDT`;
                } else {
                    const countFmt = p.refCount.toString();
                    const refEthFmt = parseFloat(ethers.utils.formatEther(p.refEth)).toFixed(4);
                    const refUsdtFmt = parseFloat(ethers.utils.formatUnits(p.refUsdt, usdtDec)).toFixed(2);
                    col3 = `<span style="color:#ffcc00">${countFmt} Users</span>`; col4 = `${refEthFmt} ETH`; col5 = `${refUsdtFmt} USDT`;
                }

                list.innerHTML += `
                    <div class="lb-item rank-${rank}" style="${rowStyle}">
                        <div class="lb-rank">#${rank}</div>
                        <div style="cursor:pointer;" onclick="showPlayerProfile('${p.addr}')">${displayName}</div>
                        <div>${col3}</div> <div>${col4}</div> <div style="line-height:1.2;">${col5}</div> 
                    </div>`;
            });
        } catch (err) {
            console.error("Leaderboard error:", err);
            list.innerHTML = "<div class='lb-loading' style='color:#ff5555;'>Failed to load data.</div>";
        }
    }
    
    async function fetchAndDisplayWinners() {
    const list = document.getElementById("winner-list");
    if (!list) return;
    
    let contractInstance = faylottoContract;
    if (!contractInstance) {
        const tempProvider = provider || new ethers.providers.JsonRpcProvider(HTTPS_URL);
        contractInstance = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, tempProvider);
    }
    
    try {
        const winnersArray = await contractInstance.getWinners(10);
        list.innerHTML = "";
        
        if (winnersArray.length === 0) {
            list.innerHTML = "<p style='text-align:center;'>No winners yet.</p>";
            return;
        }
        
        let usdtDec = 6, babyDec = 18;
        try {
            if (usdtContract) usdtDec = await usdtContract.decimals();
            if (babyDogeContract) babyDec = await babyDogeContract.decimals();
        } catch (e) {}
        
        const renderArray = [...winnersArray].reverse();
        
        for (const winner of renderArray) {
            try {
                // --- 1. SIAPKAN DATA DASAR ---
                const winnerId = winner.winnerId.toString();
                const roundId = winner.roundId.toString();
                const winnerAddr = winner.winner;
                const timestamp = winner.timestamp ? winner.timestamp.toNumber() : Date.now() / 1000;
                const shortId = winnerAddr.slice(0, 6) + "..." + winnerAddr.slice(-4);
                
                // Format Tanggal
                const date = new Date(timestamp * 1000).toLocaleString('id-ID', {
                    day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                });
                
                // Avatar
                const avatarUrl = `https://api.dicebear.com/9.x/bottts/svg?seed=${winnerAddr}&baseColor=f0f4f8&backgroundColor=e0f2f7&mouthColor=ffc0cb&faceColor=a7d9f7&sidesColor=ffd700`;

                // --- 2. SIAPKAN JUMLAH (AMOUNT) ---
                const ethAmt = parseFloat(ethers.utils.formatEther(winner.rewardETH || 0)).toFixed(4);
                const usdtAmt = parseFloat(ethers.utils.formatUnits(winner.rewardUSDT || 0, usdtDec)).toFixed(2);
                const babyAmt = parseFloat(ethers.utils.formatUnits(winner.rewardBabyDoge || 0, babyDec)).toFixed(0);
                
                // [FIX 1] Definisikan freeAmt (Wajib ada karena dipanggil di HTML)
                const freeAmt = "0"; 

                // [FIX 2] Definisikan displayName
                let displayName = shortId; 
                // Opsional: Coba ambil nickname jika ada cache, tapi default ke shortId biar aman
                
                // --- 3. SIAPKAN BOOLEAN (LOGIKA TAMPILAN) ---
                // HTML Anda menggunakan ${hasEth ? ...} jadi ini harus boolean
                const hasEth = winner.rewardETH.gt(0);
                const hasUsdt = winner.rewardUSDT.gt(0);
                const hasBaby = winner.rewardBabyDoge.gt(0);
                const hasFree = false; // Set false agar bagian free tidak error

                // --- 4. SIAPKAN ICON HTML ---
                // [FIX 3] Nama variabel harus 'assetIconsHtml' sesuai yang dipanggil di HTML bawah
                let assetIconsHtml = '<div class="asset-icon-group">';
                if (hasEth) assetIconsHtml += `<img src="${ETH_LOGO_PATH}" class="asset-icon" title="ETH">`;
                if (hasUsdt) assetIconsHtml += `<img src="${USDT_LOGO_PATH}" class="asset-icon" title="USDT">`;
                if (hasBaby) assetIconsHtml += `<img src="${BABYDOGE_LOGO_PATH}" class="asset-icon" title="BabyDoge">`;
                assetIconsHtml += '</div>';

                // --- 5. SIAPKAN DATA SOSIAL (Supaya tidak crash) ---
                // Kita set default 0 dulu agar HTML bisa dirender instan
                let likes = 0;
                let ratingCount = 0; 
                let commentCount = 0;
                let isLikedByMe = false; 
                let myRating = 0;
                
                // Kita fetch data asli secara asynchronous (try-catch agar tidak memblokir render)
                try {
                     if(contractInstance.getLikeCount) likes = (await contractInstance.getLikeCount(winnerId)).toNumber();
                     if(contractInstance.getCommentCountForWinner) commentCount = (await contractInstance.getCommentCountForWinner(winnerId)).toNumber();
                     if(contractInstance.getRatingCountForWinner) ratingCount = (await contractInstance.getRatingCountForWinner(winnerId)).toNumber();
                } catch(e) { /* Abaikan error sosial data agar list tetap muncul */ }

                const item = document.createElement("div");
                item.className = "winner-list-item";
                
                // --- 6. INI HTML ASLI ANDA (TIDAK DIUBAH) ---
                item.innerHTML = `
              <div class="winner-main-content">
                  <img src="${avatarUrl}" alt="Avatar" 
                       class="winner-avatar-small"
                       onclick="showPlayerProfile('${winnerAddr}')">              

                  <div class="winner-info-text">
                      <div class="winner-id" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span>Round: #${roundId}</span>  
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">        
                        <small style="color: #888; font-size: 10px;">${date}</small>
                        ${assetIconsHtml} 
                     </div>
                 </div>

                      <div style="margin-top: 4px; margin-bottom: 4px; font-weight: bold; font-size:14px; color: var(--cyan-main); cursor: pointer;" 
                           onclick="showPlayerProfile('${winnerAddr}')">
                         Winer: ${displayName}
                      </div><br>

                      <div class="prize-line" style="color: #00dd00; font-weight: bold; font-size:15px;">
                 Prize: 
                 ${hasEth ? ethAmt + ' ETH ' : ''} 
                 ${hasUsdt ? '+ ' + usdtAmt + ' USDT ' : ''}
                 ${hasBaby ? '+ ' + babyDogeAmt + ' BabyDoge ' : ''}
                 ${hasFree ? `<br><span style="color:#00ff88;">+ ${freeAmt} Free BabyDoge</span>` : ''}
            </div><br>
                  </div>
              </div>
              <div class="winner-social" style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(120,0,255,0.2); display:flex; justify-content:space-between; align-items:center;">
                  <button class="like-btn" style="background:none; border:none; cursor:pointer; color: ${isLikedByMe ? '#ff00e6' : '#888'}; font-size:14px; display:flex; align-items:center; gap:4px;" onclick="toggleLike(${winnerId})"><img src="like.svg" style="width:25px; height:25px; vertical-align:middle;"><span style="color:#ff00e6">Like (${likes})</span>
                  </button>
                  <div style="display:flex; align-items:center; gap:6px;">
                      <div class="rating-stars">
                         ${[5, 4, 3, 2, 1].map(i => `
                            <span class="star-icon ${i <= myRating ? 'active' : ''}" onclick="rateWinner(${winnerId}, ${i})"></span>
                         `).join('')}
                      </div>
                      <span style="font-size: 12px; color: #888;">(${ratingCount})</span>
                  </div>
                  <button class="terminal-btn" id="comm-btn-${winnerId}" 
                        style="background:none; border:none; color:var(--cyan-main); font-size:14px; cursor:pointer; display:flex; align-items:center; gap:5px;" 
                        onclick="toggleComments(${winnerId}, '${winnerAddr}')">
                    <img src="comment.svg" style="width:25px; height:25px; vertical-align:middle;">Log
                    <span>(${commentCount})</span>
                  </button>
              </div>
              <div class="comments-terminal" id="terminal-${winnerId}" style="display: none; margin-top: 10px;">
                  <div class="terminal-header">> Log For Winner: ${winnerAddr.slice(0,10)}...</div>
                  <div class="comments-list"></div>
                  <div class="new-comment-section" style="margin-top: 10px; padding-top: 8px; border-top: 1px dashed rgba(120, 0, 255, 0.2); display: flex; gap: 5px; align-items: center;">
                      <span style="color: var(--cyan-main);">></span>
                      <textarea class="terminal-input" id="new-comment-${winnerId}" placeholder="Transmit data..." rows="1" style="resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
                      <button class="terminal-btn" onclick="submitComment(${winnerId})">[ SEND ]</button>
                  </div>
              </div>
            `;
                winnerList.appendChild(item);
            } catch (errInner) {
                console.error("Error rendering item:", errInner);
            }
        }
    } catch (err) {
        console.error("Fetch Winners Error:", err);
        list.innerHTML = `<p style="color:#ff5555; text-align:center;">Failed to load data.</p>`;
    }
    }

  // Comment Function
  async function submitComment(winnerId) {
  if (!signer) { showStatus("Connect wallet first.", "warning"); return; }
  const input = document.getElementById(`new-comment-${winnerId}`);
  const text = input.value.trim();
  if (!text) return; 
  try {
    input.disabled = true; input.value = "Transmitting...";
    showStatus("Sending comment...", "load");
    const tx = await faylottoContract.addCommentToWinner(winnerId, text);
    await tx.wait();
    showStatus("Comment sent!", "success");
    input.value = ""; await fetchAndRenderComments(winnerId); 
  } catch (err) { showStatus("Failed to send comment.", "error"); input.value = ""; } finally { input.disabled = false; }
}

async function fetchAndRenderComments(winnerId) {
    const terminalDiv = document.getElementById(`terminal-${winnerId}`);
    if (!terminalDiv) return;
    const commentsListDiv = terminalDiv.querySelector('.comments-list');
    commentsListDiv.innerHTML = "> Loading Neural Logs...";
    let contractInstance = faylottoContract || new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, new ethers.providers.JsonRpcProvider(HTTPS_URL));
    try {
        const comments = await contractInstance.getAllCommentsForWinner(winnerId);
        if (comments.length === 0) { commentsListDiv.innerHTML = "> No Transmissions Found."; return; }
        commentsListDiv.innerHTML = "";
        for (let i = 0; i < comments.length; i++) {
            const c = comments[i];
            const user = c.user;
            const text = c.text;
            const dateObj = new Date(c.timestamp.toNumber() * 1000);
            const time = dateObj.toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
            const displayName = user.slice(0, 6) + '...';
            commentsListDiv.innerHTML += `<div class="comment-log"><span style="color:var(--cyan-main); font-weight:bold;">${displayName}</span> [${time}]: ${text}</div>`;
        }
    } catch (err) { commentsListDiv.innerHTML = "> Failed: No Signal."; }
}
    
function toggleComments(winnerId, winnerAddr) {
    const terminal = document.getElementById(`terminal-${winnerId}`);
    if (terminal.style.display === 'none') {
        terminal.style.display = 'block';
        fetchAndRenderComments(winnerId);
    } else { terminal.style.display = 'none'; }
}

    async function toggleLike(winnerId) {
      if (!signer) return showStatus("Please connect wallet.", "warning");
      showStatus("Processing Like...", "load");
      try {
        const tx = await faylottoContract.toggleLikeWinner(winnerId);
        await tx.wait();
        showStatus("Like updated!", "success");
        fetchAndDisplayWinners(); 
      } catch (err) { showStatus("Like failed.", "error"); }
    }

    // ==================================================================
    // 8. UTILS & INITIALIZATION
    // ==================================================================

    function showStatus(message, type = 'info', duration = 10000) { 
        const container = document.getElementById('toast-container');
        if (!container) return;
        let iconName = 'info-icon.svg'; 
        if (type === 'success') iconName = 'success.svg';
        else if (type === 'error') iconName = 'error.svg';
        else if (type === 'load') iconName = 'load.svg';
        else if (type === 'warning') iconName = 'warning.svg';
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        const icon = document.createElement('img');
        icon.src = `${iconName}`; 
        const text = document.createElement('span');
        text.textContent = message;
        const closeButton = document.createElement('button');
        closeButton.className = 'toast-close-btn';
        closeButton.innerHTML = '&times;'; 
        toast.appendChild(icon);
        toast.appendChild(text);
        toast.appendChild(closeButton);
        function removeToast() {
          toast.classList.remove('show');
          toast.classList.add('hide');
          toast.addEventListener('transitionend', () => { if (toast.parentNode === container) container.removeChild(toast); }, { once: true });
        }
        const hideTimeout = setTimeout(removeToast, duration);
        closeButton.onclick = () => { clearTimeout(hideTimeout); removeToast(); };
        container.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 10); 
    }

    // DOM Ready
    document.addEventListener("DOMContentLoaded", () => {
        initCanvas();
        
        document.getElementById("walletBtn").addEventListener("click", () => toggleWallet());
        document.getElementById("disconnectBtn").addEventListener("click", disconnectWallet);
        document.getElementById("placeBetBtn").addEventListener("click", showBetModal);
        document.getElementById("confirmBetBtn").addEventListener("click", confirmBet);
        document.getElementById("finalizeBtn").addEventListener("click", callFinalizeRound);
        document.getElementById("bet-modal-close-btn").addEventListener("click", hideBetModal);
        document.getElementById("wallet-modal-close-btn").addEventListener("click", () => {
            document.getElementById("wallet-modal-overlay").classList.remove("show");
            document.getElementById("wallet-modal").classList.remove("show");
        });
        document.getElementById("referralBtn").addEventListener("click", () => {
            document.getElementById("referral-modal-overlay").classList.add("show");
            document.getElementById("referral-modal").classList.add("show");
        });
        document.getElementById("referral-modal-close-btn").addEventListener("click", () => {
             document.getElementById("referral-modal-overlay").classList.remove("show");
             document.getElementById("referral-modal").classList.remove("show");
        });
        document.getElementById("createNicknameBtn").addEventListener("click", createNickname);
        document.getElementById("claimRewardsBtn").addEventListener("click", claimRewards);
        document.getElementById("profile-modal-close-btn").addEventListener("click", () => {
            document.getElementById("profile-modal-overlay").classList.remove("show");
            document.getElementById("profile-modal").classList.remove("show");
        });

        provider = new ethers.providers.JsonRpcProvider(HTTPS_URL);
        fetchAndDisplayRoundData();
        fetchAndDisplayWinners();
        fetchAndRenderLeaderboard();
        
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('ref')) pendingReferrerNickname = urlParams.get('ref');

        const expiry = localStorage.getItem(AUTO_CONNECT_KEY);
        if(expiry && new Date().getTime() < Number(expiry)) {
             toggleWallet(true);
        }
    });
    
    // Helper Profile
    async function showPlayerProfile(addr) {
        document.getElementById("profile-modal-overlay").classList.add("show");
        document.getElementById("profile-modal").classList.add("show");
        document.getElementById("profileAddress").innerText = addr;
        document.getElementById("profileNickname").innerText = "Loading...";
        const c = faylottoContract || new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, new ethers.providers.JsonRpcProvider(HTTPS_URL));
        try {
            const n = await c.nicknames(addr);
            document.getElementById("profileNickname").innerText = n || "No Nickname";
        } catch(e) { document.getElementById("profileNickname").innerText = "-"; }
    }
    
    // Buttons sound
    document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => playSound('sfx-click'));
    });
    function playSound(soundId) {
        const audio = document.getElementById(soundId);
        if (audio) { audio.currentTime = 0; audio.play().catch(e => {}); }
    }
  </script>
</body>
</html>
