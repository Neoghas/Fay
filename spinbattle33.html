<!DOCTYPEhtml>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --red-main: #c0392b;
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  body {
  margin: 0;
  min-height: 100vh; /* Gunakan min-height, bukan height fix */
  background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
  font-family: "Ubuntu", sans-serif;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  /* justify-content: center; Hapus ini agar konten mulai dari atas */
  padding: 20px 0; /* Beri sedikit ruang atas bawah */
  overflow-x: hidden; /* Hanya sembunyikan scroll horizontal jika perlu */
  overflow-y: auto; /* Izinkan scroll vertikal */
  }

/* === HERO SECTION STYLES (SIMPLE) === */
#hero-section {
    position: relative;
    width: 100%;
    min-height: 20vh; /* Tinggi sesuai permintaan */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding-top: 80px;
    padding-bottom: 40px;
    background: var(--bg-dark-2);
    border-bottom: 1px solid rgba(120, 0, 255, 0.2); /* Garis pemisah halus di bawah */
}

/* Latar Belakang Statis yang Ringan */
.hero-static-bg {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0;
    opacity: 0.4;
    /* Pola grid halus statis */
    background-image: 
        linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
    background-size: 30px 30px;
}

/* Konten Hero (Box Title) */
.hero-content {
    position: relative; z-index: 1;
    text-align: center; max-width: 800px; padding: 30px;
    background: rgba(10, 10, 25, 0.5); /* Latar sedikit lebih gelap */
    backdrop-filter: blur(5px); /* Blur ringan */
    border-radius: 15px;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Bayangan agar menonjol */
}

.hero-title {
    background: #000;
    font-size: 2rem; font-weight: 700; margin: 0 0 15px 0;
    font-family: "Ubuntu", sans-serif;
    letter-spacing: 2px; line-height: 1.1;
}
.hero-title .highlight-text {
    background: linear-gradient(90deg, #03a9f4, #f441a5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
    display: block;
}
.hero-subtitle {
    font-size: 1.1rem; color: #ccc; margin: 0 auto 30px auto;
    max-width: 600px; line-height: 1.5;
}

/* Tombol CTA */
.hero-cta-container { display: inline-block; cursor: pointer; }
.play-now-btn {
    background: linear-gradient(90deg, var(--pink-main), var(--blue-main)); color: #ffffff; /* Warna solid langsung */
    border: none; padding: 12px 35px;
    font-size: 16px; font-weight: bold; letter-spacing: 1px;
    border-radius: 12px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; align-items: center; gap: 8px;
}
.play-now-btn:hover {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4);
}
.arrow-icon { font-size: 1.2em; }

/* Responsif Ponsel */
@media (max-width: 768px) {
    .hero-title { font-size: 2.2rem; }
    .hero-subtitle { font-size: 1rem; }
    .hero-content {
        width: 90%;
        padding: 20px;
        margin: 0 auto; /* Tambahkan ini agar simetris di tengah */
        box-sizing: border-box; /* Pastikan padding tidak menambah lebar total */
    }
}

  /* Mode PC (layar besar) */
@media (min-width: 1024px) {
  #hero-section {
    min-height: 5vh; /* lebih pendek di PC */
    padding-top: 60px;
    padding-bottom: 20px;
  }
}

  .app-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  .lists-wrapper {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-top: 20px;
      width: 90%;
      max-width: 820px;
  }

  /* === [DIUBAH] Wallet Buttons Container === */
  .wallet-container {
    position: fixed;
    top: 20px;
    right: 25px;
    display: flex;
    gap: 10px;
    z-index: 1001;
  }
  .wallet-btn, .referral-btn {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 14px; font-weight: bold; padding: 10px 20px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main);
    transition: all 0.3s ease;
  }
  .wallet-btn:hover, .referral-btn:hover { 
      box-shadow: 0 0 25px var(--pink-main); 
      transform: scale(1.05); 
  }
  
  /* [BARU] Tombol Referral */
  .referral-btn {
      background: linear-gradient(90deg, var(--pink-main), var(--blue-main));
      display: none; /* Sembunyi sampai connect */
  }

  /* Mengganti style .wallet-info lama agar sesuai di dalam modal */
  #walletInfo {
    font-size: 14px;
    line-height: 1.6;
    color: #ccc;
  }
  #walletInfo p { margin: 8px 0; }
  #walletInfo span { color: var(--cyan-main); font-weight: bold; }
  #walletInfo hr {
      border: none;
      height: 1px;
      background-color: var(--border-color);
      margin: 12px 0;
  }

  /* [BARU] Style untuk tombol Disconnect */
  .modal-btn-disconnect {
      background: linear-gradient(90deg, var(--pink-main), var(--red-main));
      box-shadow: 0 0 20px var(--pink-main);
  }
  .modal-btn-disconnect:hover {
      box-shadow: 0 0 25px var(--red-main);
  }

  /* === [PERBAIKAN] Memindahkan Modal Wallet ke Pojok Kanan Atas === */

#wallet-modal {
    /* 1. Hapus pemusatan dari class .modal */
    top: 65px;  /* (Tombol 20px + Jarak 45px) */
    left: auto;
    right: 25px;
    
    /* 2. Hapus transform pemusatan & scaling */
    transform: none;

    /* 3. Atur ulang animasi 'show/hide' agar muncul dari atas (bukan zoom) */
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

/* 4. Ganti animasi .modal.show */
#wallet-modal.show {
    transform: translateY(0);
    opacity: 1;
}

/* 5. Hapus latar belakang gelap HANYA untuk modal ini */
#wallet-modal-overlay.show {
     background: transparent;
     backdrop-filter: none;
}

  /* === Controls (Tidak Berubah) === */
  .controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 250px; 
  }
  .main-btn {
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    padding: 12px 30px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s ease;
    width: 100%;
  }
  #placeBetBtn {
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main);
  }
  #placeBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }
  #finalizeBtn {
    background: linear-gradient(90deg, var(--pink-main), var(--blue-main));
    box-shadow: 0 0 20px var(--pink-main);
    display: none;
  }
  #finalizeBtn:hover { box-shadow: 0 0 25px var(--red-main); transform: scale(1.05); }
  .main-btn:disabled {
    background: #555;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
  }
  .status {
    font-size: 13px;
    margin-top: 8px;
    color: var(--blue-main);
    min-height: 1.2em;
    text-align: center;
    max-width: 320px;
  }
  .timer {
      font-size: 16px;
      font-weight: bold;
      color: var(--cyan-main);
      margin-top: 10px;
      height: 20px;
  }

  /* === Bet & Winner Lists (Tidak Berubah) === */
  .list-container {
    width: 100%;
    max-width: 400px;
    max-height: 350px; 
    background: rgba(10, 10, 20, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  .list-container h3 {
    margin: 0 0 10px 0; font-size: 14px;
    color: var(--blue-main); text-align: center;
    text-transform: uppercase;
  }
  .bet-list-item, .winner-list-item {
    background: rgba(20, 20, 40, 0.7);
    border-radius: 4px; padding: 8px 10px;
    margin-bottom: 6px; font-size: 12px;
  }
  .bet-list-item {
    display: flex; justify-content: space-between;
    align-items: center;
  }
  .bet-list-item .player-id { font-weight: bold; color: var(--cyan-main); }
  .bet-list-item .player-bets { text-align: right; color: #eee; }
  .winner-list-item .winner-id {
    font-weight: bold;
    color: var(--cyan-main);
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .winner-list-item .winner-id span {
      font-weight: normal;
      color: #aaa;
  }
  .winner-list-item .prize-line {
      font-size: 11px;
      color: #eee;
  }
  #bet-list-placeholder, #winner-list-placeholder {
    text-align: center; font-size: 13px;
    color: #888; padding-top: 20px;
  }

  @media (min-width: 768px) {
  .list-container {
    max-height: 400px; /* Tinggi maksimal lebih besar di PC */
    /* Atau gunakan height tetap jika ingin selalu tinggi: */
    /* height: 400px; */
  }
  }
  
  /* === Modal Base (Digunakan oleh Bet & Referral) === */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999; display: none; opacity: 0;
    transition: opacity 0.3s ease;
  }
  .modal { /* [DIUBAH] Nama kelas generik */
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 380px;
    background: var(--bg-modal);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 0 40px rgba(180, 0, 255, 0.3);
    z-index: 1000; display: none; opacity: 0;
    transition: all 0.3s ease;
  }
  .modal-overlay.show, .modal.show { display: block; opacity: 1; }
  .modal.show { transform: translate(-50%, -50%) scale(1); }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2);
  }
  .modal-header h2 { margin: 0; font-size: 20px; color: var(--blue-main); }
  .modal-close-btn {
    font-size: 28px; font-weight: bold; color: #fff;
    cursor: pointer; line-height: 1; background: none; border: none;
  }
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .balance-display, .limits-display { font-size: 13px; color: #999; line-height: 1.5; }
  .limits-display p { margin: 2px 0; }
  .balance-display span, .limits-display span { font-weight: bold; color: var(--cyan-main); }
  .input-group { display: flex; gap: 10px; }
  .input-group input, .input-group select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    font-size: 16px;
    padding: 10px 12px;
  }
  .input-group input { flex-grow: 1; width: 65%; }
  .input-group select { width: 35%; }
  .percent-buttons { display: flex; justify-content: space-between; gap: 8px; }
  .percent-btn {
    flex: 1; background: rgba(120, 0, 255, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px; color: #fff;
    padding: 8px 10px; font-size: 13px;
    cursor: pointer; transition: background 0.2s ease;
  }
  .percent-btn:hover { background: rgba(120, 0, 255, 0.4); }
  .modal-footer { padding: 20px; border-top: 1px solid rgba(120, 0, 255, 0.2); }
  
  /* Tombol di footer modal */
  .modal-btn {
    width: 100%;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: bold; padding: 12px 30px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 20px var(--blue-main);
    transition: all 0.3s ease;
  }
  .modal-btn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.02); }
  .modal-btn:disabled {
    background: #555; color: #999;
    box-shadow: none; transform: none; cursor: not-allowed;
  }
  
  /* [BARU] Style khusus untuk Referral Modal */
  .ref-section {
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.1);
  }
  .ref-section:last-child { border-bottom: none; }
  .ref-section h3 {
      font-size: 16px;
      color: var(--cyan-main);
      margin: 0 0 10px 0;
  }
  .ref-info {
      font-size: 14px;
      color: #ccc;
      line-height: 1.6;
  }
  .ref-info span {
      color: #fff;
      font-weight: bold;
  }
  .ref-section .input-group {
      margin-bottom: 10px;
  }

  .reward-icon {
    width: 22px;
    height: 22px;
    margin-right: 6px;
    vertical-align: middle;
  }
  
  @media (max-width: 840px) {
    .lists-wrapper {
        flex-direction: column;
    }
  }

  /* === Donut Wheel Section === */
.donut-wrap {
  display: flex;
  gap: 16px;
  align-items: center;
  justify-content: center;
  margin-top: 12px;
  flex-wrap: wrap;
  position: relative;
}

#donutCanvas {
  background: linear-gradient(90deg, #03a9f4, #f441a5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  border-radius: 50%;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
}

.donut-pointer {
  position: absolute;
  top: 15px; /* Sesuaikan sedikit agar pas di atas donut */
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-top: 30px solid var(--blue-main); 
  z-index: 10;
  filter: drop-shadow(0 -2px 5px rgba(0, 179, 255, 0.7)); 
}

  /* === [BARU] Style untuk Fitur Sosial === */
.winner-social {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(120, 0, 255, 0.2);
}

.like-btn {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}
.like-btn.liked {
    color: var(--pink-main); /* Warna pink saat di-like */
}
.like-btn:hover {
    color: #fff;
}

/* === [REVISI FINAL] Style Bintang Rating === */
.rating-stars {
    display: flex;
    gap: 4px;
    /* Kita BALIK urutannya agar :hover ~ berfungsi benar */
    flex-direction: row-reverse; 
}

.star-icon {
    width: 14px;
    height: 14px;
    cursor: pointer;
    mask-image: url('blackstar.svg');
    mask-size: contain;
    mask-repeat: no-repeat;
    mask-position: center;
    background-color: #555; /* Default mati */
    transition: background-color 0.1s ease;
}

/* Saat hover di SATU bintang, 
   SEMUA bintang "sebelumnya" (yang di kanannya di DOM) ikut menyala */
.star-icon:hover,
.star-icon:hover ~ .star-icon {
    background-color: gold;
}

/* Terapkan warna 'active' (rating yang tersimpan) */
/* Pastikan bintang 'active' tetap menyala meskipun tidak di-hover */
.rating-stars:hover .star-icon.active {
    background-color: gold;
}
.star-icon.active {
    background-color: gold;
}

  /* === [BARU] Gaya Komentar Futuristik (Terminal) === */

/* Container terminal utama */
.comments-terminal {
    background: rgba(0, 0, 0, 0.8); /* Latar lebih gelap agar teks terminal terbaca */
    border: 1px solid var(--purple-main);
    border-radius: 6px;
    padding: 10px;
    font-family: 'Courier Prime', monospace; /* Font monospace penting untuk gaya terminal */
    font-size: 12px;
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
    max-height: 300px; /* Batasi tinggi agar tidak terlalu panjang */
    overflow-y: auto; /* Scroll jika komentar banyak */
}

/* Header terminal (misal: > LOG FOR WINNER...) */
.terminal-header {
    color: var(--cyan-main);
    border-bottom: 1px dashed var(--purple-main);
    padding-bottom: 4px;
    margin-bottom: 10px;
    font-size: 10px; 
    opacity: 0.8;
    letter-spacing: 1px;
}

/* Blok satu komentar individu */
.comment-log {
    margin-bottom: 12px;
    padding-left: 8px;
    border-left: 2px solid var(--blue-main); /* Indikator garis di kiri */
}

/* Metadata komentar (Nickname, Waktu, Wallet) */
.log-meta { 
    color: #888; 
    font-size: 10px; 
    margin-bottom: 2px; 
}
.log-nickname { 
    color: var(--pink-main); /* Nickname warna pink neon */
    font-weight: bold; 
}
.log-wallet { 
    color: #555; 
}

/* Isi pesan komentar */
.log-message { 
    color: #eee; 
    line-height: 1.4; 
    white-space: pre-wrap; /* Agar enter/baris baru terbaca */
}

/* Input gaya terminal */
.terminal-input {
    flex-grow: 1; /* Mengisi sisa ruang */
    background: rgba(0,0,0,0.3);
    border: none; 
    border-bottom: 1px solid var(--cyan-main);
    color: var(--cyan-main);
    font-family: 'Courier Prime', monospace;
    padding: 4px 6px; 
    outline: none;
    font-size: 12px;
}
.terminal-input::placeholder {
    color: rgba(0, 255, 255, 0.3);
}

/* Tombol gaya terminal ([ SEND ], [ EDIT LOG ], dll) */
.terminal-btn {
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--cyan-main);
    color: var(--cyan-main); 
    padding: 3px 8px; 
    font-size: 10px;
    cursor: pointer; 
    font-family: 'Courier Prime', monospace;
    transition: all 0.2s ease;
}
.terminal-btn:hover { 
    background: var(--cyan-main); 
    color: #000; /* Teks jadi hitam saat hover agar kontras */
}

  .log-message { 
    /* ... */
    white-space: pre-wrap; /* Ini yang membuat baris baru (enter) terlihat */
  }

/* === [BARU] Navbar Glassmorphism === */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 30px;
    box-sizing: border-box;
    z-index: 1000;

    /* Efek Glassmorphism */
    background: rgba(10, 10, 25, 0.6); /* Latar belakang transparan gelap */
    backdrop-filter: blur(12px); /* Efek blur di belakangnya */
    border-bottom: 1px solid rgba(120, 0, 255, 0.3); /* Garis batas halus */
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); /* Bayangan lembut */
}

.navbar-logo {
    font-family: "Ubuntu", sans-serif;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
    /* Anda bisa menambahkan <img> di sini jika punya file logo */
}

.navbar-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

/* Hapus style .wallet-container yang lama karena sudah tidak dipakai */
/* .wallet-container { ... }  <-- HAPUS INI */

/* Sesuaikan posisi modal wallet agar pas di bawah navbar */
#wallet-modal {
    top: 80px; /* 70px navbar + 10px jarak */
    right: 25px;
    /* ... (sisa style modal tetap sama) ... */
}

  /* ===== Minimal Footer Style ===== */
  footer {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        background: #000; /* Warna gelap */
        color: #ddd; /* Warna teks */
        font-size: 12px;
    }

    .social-icons {
        margin-bottom: 10px;
    }

    .social-icons a {
    background: rgba(255, 255, 255, 0.2); /* Transparan seperti kaca */
    border-radius: 10px; /* Agar sedikit membulat */
    padding: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white; /* Warna ikon */
    font-size: 15px;
    margin: 0 5px;
    text-decoration: none;
    transition: transform 0.5s ease, text-shadow 0.5s ease, box-shadow 0.5s ease;
    box-shadow: 0 0 10px rgba(0, 0, 255, 0.6); /* Cahaya biru */
    backdrop-filter: blur(10px); /* Efek blur kaca */
}

/* Efek saat hover */
.social-icons a:hover {
    color: #1a88ff; /* Warna biru neon */
    text-shadow: 0 0 10px #1a88ff, 0 0 20px #1a88ff, 0 0 30px #1a88ff; /* Glow lebih intens */
    box-shadow: 0 0 20px rgba(0, 0, 255, 1), 0 0 30px rgba(0, 0, 255, 0.8); /* Shadow lebih terang */
    transform: rotate(360deg); /* Efek berputar */
}

/* === Style Modal Profil Player === */
.profile-body {
    align-items: center;
    text-align: center;
    padding-top: 30px !important; /* Tambah jarak atas */
}

/* Avatar Robot dengan Cincin Berputar */
.profile-avatar-container {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto 20px;
}
.profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: #0b0b15;
    border: 2px solid var(--cyan-main);
    padding: 5px; /* Jarak dari border */
    position: relative;
    z-index: 2;
}
.avatar-ring {
    position: absolute;
    top: -10px; left: -10px; right: -10px; bottom: -10px;
    border: 2px dashed var(--pink-main);
    border-radius: 50%;
    animation: spinRight 20s linear infinite;
    opacity: 0.6;
    z-index: 1;
}

/* Info Teks */
#profileNickname {
    color: var(--cyan-main);
    font-size: 24px;
    margin: 0 0 10px 0;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
}
.profile-address-box {
    background: rgba(0, 0, 0, 0.3);
    padding: 8px 15px;
    border-radius: 20px;
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    color: #aaa;
    cursor: pointer;
    display: inline-block;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.2s ease;
}
.profile-address-box:hover {
    border-color: var(--cyan-main);
    color: #fff;
}

/* Grid Statistik */
.profile-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    width: 100%;
    margin-top: 30px;
}
.stat-box {
    background: linear-gradient(135deg, rgba(20, 20, 40, 0.8), rgba(10, 10, 20, 0.9));
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid var(--purple-main);
    text-align: left;
}
.stat-label {
    display: block;
    font-size: 10px;
    color: #88aaff;
    letter-spacing: 1px;
    margin-bottom: 5px;
}
.stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #fff;
}
.active-glow {
    color: var(--cyan-main);
    text-shadow: 0 0 8px var(--cyan-main);
}

  /* === [BARU] Gaya Avatar di Riwayat Pemenang === */
.winner-main-content {
    display: flex;
    gap: 12px;
    align-items: flex-start; /* Rata atas agar rapi jika teks panjang */
}

.winner-avatar-small {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid var(cyan-main); /* Border pink agar mencolok */
    background: #0b0b15;
    padding: 2px;
    flex-shrink: 0; /* Agar avatar tidak mengecil */
    cursor: pointer; /* Menunjukkan bisa diklik */
    transition: transform 0.2s ease;
}
.winner-avatar-small:hover {
    transform: scale(1.1); /* Efek zoom sedikit saat hover */
}

.winner-info-text {
    flex-grow: 1; /* Mengisi sisa ruang */
    width: 100%; /* Memastikan lebar penuh */
}


  /* === VICTORY OVERLAY STYLES === */
#victory-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(5, 5, 16, 0.95); z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
    backdrop-filter: blur(10px);
}
#victory-overlay.show { opacity: 1; pointer-events: auto; }

#victory-canvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1;
}

.victory-content {
    position: relative; z-index: 2; text-align: center;
    transform: scale(0.8); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#victory-overlay.show .victory-content { transform: scale(1); }

.victory-title {
    font-size: 6rem; margin: 0; color: #fff;
    font-family: "Ubuntu", sans-serif; font-weight: 900; font-style: italic;
    text-shadow: 0 0 20px var(--cyan-main), 0 0 40px var(--cyan-main), 0 0 80px var(--cyan-main);
    animation: titlePulse 1s infinite alternate;
}

.victory-glitch {
    font-family: 'Courier Prime', monospace; color: var(--pink-main);
    font-size: 1.2rem; letter-spacing: 4px; margin-bottom: 20px;
    position: relative; display: inline-block;
}
/* Efek glitch sederhana dengan pseudo-elements */
.victory-glitch::before, .victory-glitch::after {
    content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%;
    background: rgba(5, 5, 16, 0.95); clip: rect(0, 0, 0, 0);
}
.victory-glitch::after {
    left: 2px; text-shadow: -1px 0 red; animation: glitch-anim 2s infinite linear alternate-reverse;
}

.victory-subtitle {
    color: #ccc; font-size: 1.2rem; margin-top: 10px;
}

.claim-victory-btn {
    margin-top: 40px; padding: 15px 50px; font-size: 18px;
    background: var(--pink-main); border: none; color: #fff; font-weight: bold;
    border-radius: 4px; cursor: pointer;
    box-shadow: 0 0 30px var(--pink-main);
    transition: all 0.3s ease;
}
.claim-victory-btn:hover {
    background: #fff; color: var(--pink-main); box-shadow: 0 0 50px #fff;
}

@keyframes titlePulse {
    from { text-shadow: 0 0 20px var(--cyan-main), 0 0 40px var(--cyan-main); }
    to { text-shadow: 0 0 40px var(--cyan-main), 0 0 80px var(--cyan-main); }
}
@keyframes glitch-anim {
    0% { clip: rect(30px, 9999px, 10px, 0); }
    5% { clip: rect(85px, 9999px, 66px, 0); }
    /* ... bisa ditambahkan lebih banyak frame untuk glitch yang lebih acak ... */
    100% { clip: rect(90px, 9999px, 100px, 0); }
}

/* Responsif untuk HP */
@media (max-width: 768px) {
    .victory-title { font-size: 4rem; }
    .victory-glitch { font-size: 0.9rem; letter-spacing: 2px; }
}

  /* =========================================
   LEADERBOARD SECTION STYLES
   ========================================= */

/* Wrapper Utama Section */
.leaderboard-section {
    width: 95%;
    max-width: 850px; /* Lebar maksimal agar tidak terlalu lebar di PC */
    margin: 60px auto; /* Jarak atas bawah */
    position: relative;
    z-index: 5;
}

.section-title {
    text-align: center;
    font-family: "Ubuntu", sans-serif;
    font-size: 28px;
    margin-bottom: 25px;
    background: linear-gradient(90deg, #03a9f4, #f441a5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 20px rgba(98, 0, 255, 0.4);
    letter-spacing: 2px;
    text-transform: uppercase;
}

/* === TABS SWITCHER (Tombol Ganti Mode) === */
.lb-tabs {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

/* Style Dasar Tombol Tab */
.lb-tabs button {
    background: rgba(0, 0, 0, 0.6); /* Latar gelap transparan */
    border: 1px solid var(--purple-main);
    color: #aaa;
    padding: 10px 30px;
    border-radius: 30px; /* Membuat tombol bulat kapsul */
    font-family: "Ubuntu", sans-serif;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 1px;
    text-transform: uppercase;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
}

/* Efek Hover */
.lb-tabs button:hover {
    border-color: var(--cyan-main);
    color: #fff;
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0, 255, 255, 0.2);
}

/* Efek Active (Dikontrol JS, tapi kita perkuat di CSS) */
.lb-tabs button.active {
    background: linear-gradient(90deg, var(--pink-main), var(--purple-main)) !important;
    color: #fff !important;
    border: none !important;
    box-shadow: 0 0 25px var(--pink-main) !important;
    opacity: 1 !important;
}


/* === CONTAINER LEADERBOARD === */
.leaderboard-container {
    background: rgba(12, 12, 28, 0.85); /* Latar belakang tabel */
    border: 1px solid rgba(120, 0, 255, 0.4);
    border-radius: 16px;
    padding: 0; 
    overflow: hidden; /* Agar konten tidak keluar dari radius */
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px); /* Efek kaca */
}

/* === GRID HEADER & ITEM === */
/* Note: Grid template columns diatur inline oleh JS, 
   tapi kita set alignment dasar di sini */
.lb-header, .lb-item {
    display: grid;
    align-items: center;
    padding: 16px 20px;
    gap: 10px;
}

/* Header Kolom */
.lb-header {
    background: rgba(30, 30, 60, 0.9);
    border-bottom: 2px solid var(--purple-main);
    color: var(--cyan-main);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 800;
}

/* Baris Item Pemain */
.lb-item {
    border-bottom: 1px solid rgba(120, 0, 255, 0.1);
    color: #ddd;
    font-size: 13px;
    transition: background 0.2s ease;
}

.lb-item:last-child {
    border-bottom: none;
}

.lb-item:hover {
    background: rgba(255, 255, 255, 0.05); /* Highlight saat mouse lewat */
}


/* === RANKING COLORS (Juara 1-3) === */
.lb-rank {
    font-weight: bold;
    font-size: 14px;
    font-family: 'Courier Prime', monospace;
}

/* Juara 1 (Emas) */
.lb-item.rank-1 {
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), transparent);
    border-left: 4px solid #ffd700;
}
.lb-item.rank-1 .lb-rank { color: #ffd700; text-shadow: 0 0 10px #ffd700; }

/* Juara 2 (Perak) */
.lb-item.rank-2 {
    border-left: 4px solid #c0c0c0;
}
.lb-item.rank-2 .lb-rank { color: #c0c0c0; text-shadow: 0 0 10px #c0c0c0; }

/* Juara 3 (Perunggu) */
.lb-item.rank-3 {
    border-left: 4px solid #cd7f32;
}
.lb-item.rank-3 .lb-rank { color: #cd7f32; text-shadow: 0 0 10px #cd7f32; }


/* === LOADING STATE === */
.lb-loading {
    padding: 50px;
    text-align: center;
    color: #666;
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 2px;
}


/* === RESPONSIVE MOBILE === */
@media (max-width: 600px) {
    .leaderboard-section {
        width: 95%;
        margin-top: 30px;
    }

    /* Kecilkan tombol tab di HP */
    .lb-tabs button {
        padding: 8px 20px;
        font-size: 10px;
    }
    
    /* Atur padding tabel agar muat */
    .lb-header, .lb-item {
        padding: 12px 10px;
        font-size: 11px;
        grid-gap: 5px;
    }
    
    /* Sembunyikan detail yang kurang penting jika layar sangat kecil (Opsional) */
    .lb-item div small {
        font-size: 9px;
    }
}


  /* === [BARU] Gaya Box untuk Setiap Komentar === */

.comment-log {
    display: flex;
    gap: 10px; /* Jarak antara avatar dan teks */
    align-items: flex-start;
    
    /* GAYA BOX BARU */
    background: rgba(0, 0, 0, 0.4); /* Latar belakang box komentar */
    border: 1px solid rgba(0, 255, 255, 0.1); /* Border cyan tipis */
    border-left: 2px solid var(--purple-dark); /* Aksen pink di kiri */
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 10px; /* Jarak antar box komentar */
}

/* Avatar di dalam komentar */
.comment-avatar {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    border: 1px solid var(--cyan-main);
    background: #0b0b15;
    flex-shrink: 0;
    cursor: pointer;
    transition: transform 0.2s;
}
.comment-avatar:hover {
    transform: scale(1.1);
}

/* Konten teks di sebelah kanan avatar */
.comment-content {
    flex-grow: 1;
    width: 100%; /* Memastikan ini mengisi sisa ruang */
    word-wrap: break-word; /* Memastikan teks panjang pindah baris */
    overflow: hidden; /* Mencegah overflow */
}

/* Sisa style meta-data (pastikan font-family sudah ada) */
.log-meta { 
    color: #888; 
    font-size: 10px; 
    margin-bottom: 5px; 
    font-family: 'Courier Prime', monospace;
}
.log-nickname { 
    color: var(--pink-main); 
    font-weight: bold; 
    font-size: 12px;
}
.log-wallet { 
    color: #555; 
}
.log-message { 
    color: #eee; 
    line-height: 1.4; 
    white-space: pre-wrap;
    font-family: 'Courier Prime', monospace;
    font-size: 13px;
}

/* Tombol Edit di dalam box */
.comment-content .terminal-btn {
    opacity: 0.7;
    margin-top: 8px;
}
.comment-content .edit-actions {
    margin-top: 10px;
}

  /* === [REVISI] Ukuran Ikon Aset Pemenang === */
.asset-icon-group {
    display: flex;
    align-items: center;
    gap: 4px; /* Jarak antar ikon jika ada dua */
}

.asset-icon {
    width: 30px;  /* Sesuai permintaan Anda */
    height: 30px; /* Sesuai permintaan Anda */
    vertical-align: middle;
    filter: drop-shadow(0 0 3px var(--cyan-main)); /* Efek glow tipis */
}


  .balance-display {

    font-size: 13px; color: #999; line-height: 1.5;

}

.balance-display p {

    margin-top: 0;

    margin-bottom: 5px;

    font-weight: bold;

    color: #fff; /* Teks "Your Balance:" jadi putih */

}



/* Baris baru untuk ikon + saldo */

.balance-line {

    display: flex;

    align-items: center;

    gap: 8px; /* Jarak antara ikon dan angka */

    font-size: 15px;

    margin-bottom: 5px;

}



/* Ukuran ikon di modal */

.balance-icon {

    width: 22px;

    height: 22px;

}



/* Mengatur span (angka) agar tetap sama */

.balance-line span {

    font-weight: bold; color: var(--cyan-main);

}
  
/* Wrapper pembungkus input/select */
.input-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

/* Style ikon (img atau font-icon) */
.input-icon,
.input-icon-fa {
    position: absolute;
    left: 7px;           /* Jarak ikon dari kiri */
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    color: var(--cyan-main);
    opacity: 0.6;
    pointer-events: none;
}
.input-icon { width: 20px; height: 20px; }
.input-icon-fa { font-size: 14px; }

/* Style untuk input/select DI DALAM wrapper */
.input-icon-wrapper input,
.input-icon-wrapper select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    fonfont-size: 15px;

    /* Ruang untuk ikon kiri */
    padding: 10px 12px 10px 28px;

    width: 100%;
    box-sizing: border-box;
}

/* Style khusus SELECT agar panah terlihat */
.input-icon-wrapper select {
    appearance: none;
    -webkit-appearance: none;

    /* Ikon panah */
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300FFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.6-3.6%205.4-7.9%205.4-12.9%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: .65em auto;

    padding-right: 10px; /* Ruang untuk panah */
}

    /* === STYLING NOTIFIKASI STATUS (TOAST) === */
#toast-container {
  position: fixed; /* Tetap di layar saat di-scroll */
  top: 90px; /* Di bawah navbar */
  right: 20px;
  z-index: 10000; /* Paling atas */
  width: 300px;
  max-width: 90%;
}

/* Style untuk setiap notifikasi */
.toast-notification {
  background: #333;
  color: white;
  padding: 15px 20px;
  margin-bottom: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  font-family: Arial, sans-serif;
  font-weight: bold;
  font-size: 14px;
  border: 2px solid #555;
  
  /* Flexbox untuk ikon + teks */
  display: flex;
  align-items: center;
  gap: 10px;
  
  /* Animasi fade-in dan fade-out */
  opacity: 0;
  transform: translateX(100%);
  transition: all 0.5s ease-in-out;
}

/* Animasi saat muncul */
.toast-notification.show {
  opacity: 1;
  transform: translateX(0);
}

/* Animasi saat hilang */
.toast-notification.hide {
  opacity: 0;
  transform: translateX(100%);
}

/* Ikon di dalam toast */
.toast-notification img {
  width: 30px;
  height: 30px;
  flex-shrink: 0;
}
.toast-notification span {
  flex-grow: 1;
  word-wrap: break-word;
}

/* Warna berdasarkan tipe */
.toast-notification.success {
  background: #2c4c00;
  border: 2px solid #69a31a;
}
.toast-notification.error {
  background: #4a2c2c;
  border: 2px solid #dc3545;
}
.toast-notification.info {
  background: #56616e;
  border: 2px solid #343a42;
}
.toast-notification.load {
  background: #0a3c66; /* Abu-abu gelap */
  border: border 2px solid #0061b3;
}

.toast-notification.warning {
  background: #997a00;
  border: 2px solid #ffcc00;
}

/* Warna untuk tipe 'spin' (Ungu/Pink) */
.toast-notification.spin {
  background: #501f66;
  border: 2px solid #a03ecc; /* Mengambil warna dari gradien tombol */
}

/* Warna untuk tipe 'wolf' (Biru Cyan) */
.toast-notification.wolf {
  background: #804f00;
  border: 2px solid #e68d00; /* Mengambil warna dari gradien tombol */
}

/* === STYLE BARU UNTUK TOMBOL CLOSE TOAST === */
.toast-close-btn {
  background: none;
  border: none;
  color: #ff4d4d;
  font-size: 24px;  /* Perbesar tombol 'x' */
  font-weight: bold;
  line-height: 1;
  padding: 0 5px;
  margin-left: 10px; /* Jarak dari teks */
  cursor: pointer;
  transition: color 0.2s;
}

/* Tombol close jadi merah saat di-hover */
.toast-close-btn:hover {
  color: #ff8282; 
}

/* Pastikan span-nya tidak menabrak tombol */
.toast-notification span {
  flex-grow: 1; /* Biarkan teks mengambil sisa ruang */
  word-wrap: break-word;
}
  
  @media (min-width: 768px) {
  #donutCanvas {
    /* Ubah ukuran sesuai keinginan Anda, misalnya 500px */
    width: 550px !important;
    height: 550px !important;
  }
</style>
</head>

<body>
   <nav class="navbar">
      <div class="navbar-logo">
    <img src="logo.svg" alt="Faylotto Logo" style="height: 40px; margin-right: 10px;">
    <span style="font-weight:bold; font-size:20px; color:var(--cyan-main);"></span></div>
      <div class="navbar-actions">
          <button class="referral-btn" id="referralBtn">Referral</button>
          <button class="wallet-btn" id="walletBtn">Connect Wallet</button>
      </div>
   </nav>

  <div class="modal-overlay" id="wallet-modal-overlay"></div>
  <div class="modal" id="wallet-modal">
    <div class="modal-header">
      <h2>Wallet Info</h2>
      <button class="modal-close-btn" id="wallet-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body" id="walletInfo"> 
      <p>Address: <span id="walletAddress">-</span></p>
      <p><img src="eth.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">Balance (ETH): <span id="ethBalance">0</span></p>
      <p><img src="usdt.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">Balance (USDT): <span id="usdtBalance">0</span></p>
      <hr/>
      <p><img src="eth.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">My Deposits (ETH): <span id="myEthDeposit">0</span></p>
      <p><img src="usdt.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">My Deposits (USDT): <span id="myUsdtDeposit">0</span></p>
    </div>
    <div class="modal-footer">
      <button id="disconnectBtn" class="modal-btn modal-btn-disconnect">Disconnect</button>
    </div>
  </div>

  <section id="hero-section">
    <div class="hero-static-bg"></div>
    
    <div class="hero-content">
        <h2 class="hero-title">
         <span class="highlight-text">Faylotto Spin Battle</span></h2>
        <p class="hero-subtitle">
          Spin the wheel of fortune on a decentralized network. Fair, transparent, and automated.
        </p>
        
        <div class="hero-cta-container" onclick="document.querySelector('.app-body').scrollIntoView({behavior: 'smooth'})">
            <button class="play-now-btn">
                Play Now! <span class="arrow-icon">↓</span>
            </button>
        </div>
    </div>
  </section>

  <div class="app-body" style="margin-top: 80px;"> 
      
      </div>

    <div class="donut-wrap">
        <div class="donut-pointer"></div>
        <canvas id="donutCanvas" width="360" height="360"></canvas>
    </div>

    <div class="controls">
      <button id="placeBetBtn" class="main-btn">Place Bet</button>
      <button id="finalizeBtn" class="main-btn">Finalize Round</button>
      <div class="status" id="statusText">Wallet not connected</div>
      <div class="timer" id="timerText"></div>
    </div>
    
    <div class="lists-wrapper">
      <div id="bet-list-container" class="list-container">
          <h3>Current Round Bets</h3>
          <div id="bet-list">
              <p id="bet-list-placeholder">No bets placed yet in this round.</p>
          </div>
      </div>
      
      <div id="winner-list-container" class="list-container">
          <h3>Recent Winners</h3>
          <div id="winner-list">
              <p id="winner-list-placeholder">No winners yet.</p>
          </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="bet-modal-overlay"></div>
  <div class="modal" id="bet-modal">
    <div class="modal-header">
      <h2>Place Your Bet</h2>
      <button class="modal-close-btn" id="bet-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="balance-display">

        <p>Your Balance:</p> <div class="balance-line">

            <img src="eth.svg" class="balance-icon" alt="ETH"> 

            <span id="modalEthBalance">0</span> ETH

        </div>

        

        <div class="balance-line">

            <img src="usdt.svg" class="balance-icon" alt="USDT">

            <span id="modalUsdtBalance">0</span> USDT

        </div>

      </div>
      
      <div class="input-group">
        
        <div class="input-icon-wrapper" style="flex-grow: 1; width: 65%;">
            <i class="fa-solid fa-hashtag input-icon-fa"></i>
            <input type="number" id="betAmountInput" placeholder="Custom Amount">
        </div>
        
        <div class="input-icon-wrapper select-wrapper" style="width: 35%;">
            <img src="eth.svg" class="input-icon" id="currency-icon" alt="">
            <select id="betCurrencySelect">
                <option value="ETH" data-icon="eth.svg">ETH</option>
                <option value="USDT" data-icon="usdt.svg">USDT</option>
            </select>
        </div>

      </div>
      <div class="percent-buttons">
        <button class="percent-btn" data-percent="0.10">MIN</button> 
        <button class="percent-btn" data-percent="0.25">25%</button>
        <button class="percent-btn" data-percent="0.50">50%</button>
        <button class="percent-btn" data-percent="0.75">75%</button>
        <button class="percent-btn" data-percent="1.00">MAX</button>
      </div>
    </div>
    <div class="modal-footer">
      <button id="confirmBetBtn" class="modal-btn">Confirm Bet</button>
    </div>
    <center><p>
  <span style="color:#f0f0f0; font-size: 13px;">Note:</span><br>
  <span style="color:#ccba00; font-size: 12px;">
    Minimum bet is 0.00005 ETH or 0.5 USDT<br>
    Maximum bet is 0.00256 ETH or 10 USDT<br>
    Maximum bets are 2 per round
  </span>
    </p></center>
  </div>
  
  <div class="modal-overlay" id="referral-modal-overlay"></div>
  <div class="modal" id="referral-modal">
    <div class="modal-body">
    
  <div class="ref-section">
      <h3>My Info</h3>
      <div class="ref-info">
          My Nickname: <span id="myNickname">-</span><br/>
          My Referrer: <span id="myReferrer">-</span>
      </div>
  </div>
  
  <div class="ref-section">
      <h3>Create/Update Nickname</h3>
      <div class="input-group">
          <input type="text" id="nicknameInput" placeholder="Enter your nickname">
      </div>
      <button id="createNicknameBtn" class="modal-btn">Create</button>
  </div>

  <div class="ref-section" id="referralLinkSection" style="display: none;">
        <h3>Your Referral Link</h3>
        <div class="input-group">
            <input type="text" id="referralLinkInput" readonly style="cursor: pointer;">
        </div>
        <br><button id="copyReferralBtn" class="modal-btn">Copy Link</button>
  </div>
  
  <div class="ref-section">
    <h3>My Rewards</h3>
    <div class="ref-info">
        <!-- ETH -->
        <div style="margin-bottom: 4px;">
            <img src="eth.svg" width="20" height="20" style="vertical-align: middle; margin-right: 5px;">
            ETH: <span id="ethRewards" style="color:var(--cyan-main); font-weight:bold;">0</span>
        </div>

        <!-- USDT -->
        <div style="margin-bottom: 4px;">
            <img src="usdt.svg" width="20" height="20" style="vertical-align: middle; margin-right: 5px;">
            USDT: <span id="usdtRewards" style="color:var(--cyan-main); font-weight:bold;">0</span>
        </div>
        
        <!-- [BARU] BABY DOGE -->
        <div style="margin-bottom: 4px;">
            <img src="bb.svg" width="20" height="20" style="vertical-align: middle; margin-right: 5px;">
            BabyDoge: <span id="babyDogeRewards" style="color:var(--cyan-main); font-weight:bold;">0</span>
        </div>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 8px 0;">
        
        <img src="ref.png" width="20" height="20" style="vertical-align: middle; margin-right: 5px;">
        Total Referrals: <span id="referralCount">0</span>

    </div>
  </div>

    </div>

  <div class="modal-overlay" id="profile-modal-overlay"></div>
<div class="modal" id="profile-modal">
    <div class="modal-header">
        <h2>Identity_Log</h2> <button class="modal-close-btn" id="profile-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body profile-body">
        <div class="profile-avatar-container">
            <img id="profileAvatar" src="" alt="Avatar" class="profile-avatar-img">
            <div class="avatar-ring"></div>
        </div>
        
        <div class="profile-main-info">
            <h3 id="profileNickname">Loading...</h3>
            <div class="profile-address-box" onclick="copyToClipboard(this.innerText)" title="Click to Copy">
                <span id="profileAddress">0x000...0000</span> <i class="fa-regular fa-copy" style="font-size: 12px; opacity: 0.6;"></i>
            </div>
        </div>

        <div class="profile-stats-grid">
            <div class="stat-box">
                <span class="stat-label">Referral</span>
                <span class="stat-value" id="profileRefCount">-</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Status</span>
                <span class="stat-value active-glow">Active</span>
            </div>
             </div>
    </div>
</div>

  <div id="victory-overlay">
    <canvas id="victory-canvas"></canvas>
    <div class="victory-content">
        <div class="victory-glitch" data-text="NEURAL SYNC COMPLETE">NEURAL SYNC COMPLETE</div>
        <h1 class="victory-title">YOU WIN!</h1>
        <p class="victory-subtitle">Funds transferring to your secure wallet...</p>
        <button class="claim-victory-btn" onclick="hideVictoryScreen()">ACKNOWLEDGE</button>
    </div>
  </div>

    <section class="leaderboard-section">
    <h2 class="section-title">Leaderboard</h2>
    
    <!-- [BARU] Tombol Ganti Mode -->
    <div class="lb-tabs" style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
        <button id="btn-lb-score" class="terminal-btn active" style="background:var(--pink-main); color:#fff;" onclick="switchLbMode('score')">TOP PROFIT</button>
        <button id="btn-lb-ref" class="terminal-btn" style="opacity:0.6;" onclick="switchLbMode('ref')">TOP REFERRAL</button>
    </div>

    <div class="leaderboard-container">
        <!-- Header Kolom (Akan berubah lewat JS) -->
        <div class="lb-header" id="lb-header-row" style="display:grid; grid-template-columns: 0.5fr 2fr 1.5fr 2fr; padding:10px; border-bottom:1px solid var(--purple-main); color:var(--cyan-main); font-weight:bold;">
            <span>Rank</span>
            <span>Pilot</span>
            <span>Score ($)</span>
            <span>Details</span> 
        </div>
        
        <div id="leaderboard-list">
            <div class="lb-loading">> Loading data...</div>
        </div>
    </div>
  </section>


<audio id="sfx-click" src="clickI.mp3" preload="auto"></audio>
<audio id="sfx-spin" src="spinI.mp3" preload="auto"></audio>
<audio id="sfx-win" src="winI.mp3" preload="auto"></audio>
<audio id="sfx-coin" src="coin.mp3" preload="auto"></audio>

  <div id="toast-container"></div>
    
  <footer>
    <div id="footer" class="social-icons">
        <a href="https://x.com/FaylottoXyz" target="_blank"><i class="fa-brands fa-twitter"></i></a>
        <a href="https://t.me/FaylottoXyz" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://t.me/Faylotto" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://discord.gg/6uMYTdCZwJ" target="_blank"><i class="fa-brands fa-discord"></i></a>
        <a href="https://facebook.com/Faylotto" target="_blank"><i class="fa-brands fa-facebook"></i></a>
    </div>
    <p>
      © Powered By Faylotto.
      <span>
        <a href="https://docs.faylotto.xyz/policy/AllRightsReserved" style="color: #007bff; text-decoration: none;" target="_blank">
          <span id="year"></span> All rights reserved. 
        </a>
      </span>
      Play responsibly.
      <span>
        <a href="privacypolicy" style="color: #007bff; text-decoration: none;" target="_blank">
          Privacy Policy.
        </a>
      </span>
    </p>
    </footer>

  <script>
    // ===========================================
// === 1. KONFIGURASI KONTRAK ===
// ===========================================
    
// ⚠️ GANTI INI DENGAN ALAMAT KONTRAK ANDA DI SEPOLIA
const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2"; 
const FAYLOTTO_ADDRESS = "0x998d821efa06D7C24260e41EBC68C9fD3f9219DA"; // Ganti dengan address valid yang sudah deployed!
// ===========================================
const WSS_URL = "wss://base-sepolia.drpc.org"; // GANTI DENGAN KUNCI ASLI ANDA!
const HTTPS_URL = "https://sepolia.base.org";

// === 2. ABI LENGKAP ===
// Sesuai permintaan, ABI dikosongkan.
const USDT_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
const FAYLOTTO_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_babyDogeToken","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"},{"internalType":"address","name":"_nativeUsdPriceFeedAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetBabyDoge","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetFree","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetNative","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetUSDT","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"FreeSpinNoPrize","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"prizeTier","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FreeSpinWon","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"referralCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalEthClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalUsdtClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalBabyDogeClaimed","type":"uint256"}],"name":"LeaderboardReferralStatsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"int256","name":"newNetUsdScore","type":"int256"},{"indexed":false,"internalType":"int256","name":"netEth","type":"int256"},{"indexed":false,"internalType":"int256","name":"netUsdt","type":"int256"},{"indexed":false,"internalType":"int256","name":"netBabyDoge","type":"int256"}],"name":"LeaderboardScoreUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"babyDogeAmount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_BETS_PER_PLAYER","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_NATIVE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_USDT_UNSCALED","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"babyDogeDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeUsdPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeBalances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"freeBetCost","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"freeSpinHistory","outputs":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getFreeSpinHistory","outputs":[{"components":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.FreeSpinWinner[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLatestNativePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLeaderboardPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"internalType":"uint256","name":"babyDogeAmount","type":"uint256"},{"internalType":"uint256","name":"usdWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"usdtReward","type":"uint256"},{"internalType":"uint256","name":"babyDogeReward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalUSDT","type":"uint256"},{"internalType":"uint256","name":"totalBabyDoge","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"},{"internalType":"uint256","name":"totalWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isFreeSpinPaused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"leaderboardPlayers","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"leaderboardStats","outputs":[{"internalType":"int256","name":"netEth","type":"int256"},{"internalType":"int256","name":"netUsdt","type":"int256"},{"internalType":"int256","name":"netBabyDoge","type":"int256"},{"internalType":"int256","name":"netUsdScore","type":"int256"},{"internalType":"uint256","name":"totalReferralEthClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralUsdtClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralBabyDogeClaimed","type":"uint256"},{"internalType":"uint256","name":"referralCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nativeUsdDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextFreeSpinId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetNative","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"quotaTier1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier2","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier3","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier4","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier5","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier6","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier7","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier8","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier9","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsBabyDoge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsUSDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"setBabyDogePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"cost","type":"uint256"}],"name":"setFreeBetCost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"spinCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"spinFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdtDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}]
  
// === [BARU] KONFIGURASI JARINGAN & AUTO-CONNECT ===
const BASE_SEPOLIA_CHAIN_ID = '0x14A34'; // 84532
const BASE_SEPOLIA_PARAMS = {
    chainId: BASE_SEPOLIA_CHAIN_ID,
    chainName: 'Base Sepolia Testnet',
    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
    rpcUrls: ['https://sepolia.base.org'],
    blockExplorerUrls: ['https://sepolia.basescan.org']
};
const AUTO_CONNECT_KEY = "faylotto_wallet_session"; // Kunci Local Storage
const AUTO_CONNECT_DURATION = 30 * 24 * 60 * 60 * 1000; // 30 hari
    
const ETH_LOGO_PATH = "eth.svg"; 
const USDT_LOGO_PATH = "usdt.svg"; 
// ===========================================
// === 3. LOGIKA APLIKASI ===
// ===========================================

// --- Variabel Global ---
let provider, signer, userAddress;
let usdtContract, faylottoContract;
let rawEthBalance, rawUsdtBalance, usdtDecimals = 6;
let currentRoundId;
let currentRoundEndTime = 0;
let visualTimer = null;
let isSpinning = false;
let isFinalizing = false;
let players = {};
let totalWeight = ethers.BigNumber.from(0);
let contractRoundLengthSeconds = 300; // (Pastikan variabel ini ada dari timer)
let ctx, cw, ch, cx, cy;
let outerR = 140; // Radius luar donut
let innerR = 80;  // Radius dalam donut
let currentRotation = 0; // Rotasi roda saat ini
let playersArray = [];
let myCurrentEthDeposit = ethers.BigNumber.from(0);
let myCurrentUsdtDeposit = ethers.BigNumber.from(0);
let pendingReferrerNickname = null;

function getProvider() {
    // Cek apakah user punya wallet (misal MetaMask)
    if (window.ethereum) {
        return new ethers.providers.Web3Provider(window.ethereum);
    } else {
        // Jika tidak, gunakan penyedia publik/pihak ketiga untuk data read-only
        try {
            // Coba WebSocket dulu untuk event real-time yang lebih baik
            return new ethers.providers.WebSocketProvider(WSS_URL);
        } catch (e) {
            console.warn("WSS failed, falling back to HTTP", e);
            // Fallback ke HTTP jika WSS gagal
            return new ethers.providers.JsonRpcProvider(HTTPS_URL);
        }
    }
}

// --- Inisialisasi Provider Segera ---
provider = getProvider();

// --- Elemen DOM ---
const walletBtn = document.getElementById("walletBtn");
const walletInfo = document.getElementById("walletInfo");
const walletAddress = document.getElementById("walletAddress");
const ethBalance = document.getElementById("ethBalance");
const usdtBalance = document.getElementById("usdtBalance");
const myEthDeposit = document.getElementById("myEthDeposit");
const myUsdtDeposit = document.getElementById("myUsdtDeposit");
const statusText = document.getElementById("statusText");
const timerText = document.getElementById("timerText");
const placeBetBtn = document.getElementById("placeBetBtn");
const finalizeBtn = document.getElementById("finalizeBtn");
const winnerList = document.getElementById("winner-list");
const winnerListPlaceholder = document.getElementById("winner-list-placeholder");
// Modal Bet
const betModalOverlay = document.getElementById("bet-modal-overlay");
const betModal = document.getElementById("bet-modal");
const betModalCloseBtn = document.getElementById("bet-modal-close-btn");
const modalEthBalance = document.getElementById("modalEthBalance");
const modalUsdtBalance = document.getElementById("modalUsdtBalance");
const betAmountInput = document.getElementById("betAmountInput");
const betCurrencySelect = document.getElementById("betCurrencySelect");
const percentButtons = document.querySelectorAll(".percent-btn");
const confirmBetBtn = document.getElementById("confirmBetBtn");
// Roda & List
const betList = document.getElementById("bet-list");
const betListPlaceholder = document.getElementById("bet-list-placeholder");
// [BARU] Elemen DOM Referral
const referralBtn = document.getElementById("referralBtn");
const referralModalOverlay = document.getElementById("referral-modal-overlay");
const referralModal = document.getElementById("referral-modal");
const referralModalCloseBtn = document.getElementById("referral-modal-close-btn");
const myNickname = document.getElementById("myNickname");
const myReferrer = document.getElementById("myReferrer");
const nicknameInput = document.getElementById("nicknameInput");
const createNicknameBtn = document.getElementById("createNicknameBtn");
const setReferrerSection = document.getElementById("setReferrerSection");
const referrerNicknameInput = document.getElementById("referrerNicknameInput");
const setReferrerBtn = document.getElementById("setReferrerBtn");
const ethRewards = document.getElementById("ethRewards");
const usdtRewards = document.getElementById("usdtRewards");
const referralCount = document.getElementById("referralCount");
const claimRewardsBtn = document.getElementById("claimRewardsBtn");

// [BARU] Elemen DOM Modal Wallet
const walletModalOverlay = document.getElementById("wallet-modal-overlay");
const walletModal = document.getElementById("wallet-modal");
const walletModalCloseBtn = document.getElementById("wallet-modal-close-btn");
const disconnectBtn = document.getElementById("disconnectBtn");

// Hapus definisi AUTO_CONNECT_KEY yang duplikat di sini

const PLAYER_COLORS = [
  "#FF6B6B", // Merah
  "#4ECDC4", // Turquoise
  "#45B7D1", // Biru Cerah
  "#F9D423", // Kuning
  "#FFA62B", // Oranye
  "#7B72E9", // Ungu
  "#3DCC91", // Hijau
  "#FF90B3", // Pink
  "#C0E218", // Lime
  "#3498DB"  // Biru
];

// Inisialisasi Halaman (Page Load)
// Menunggu DOM (HTML) selesai dimuat sebelum menjalankan
document.addEventListener("DOMContentLoaded", () => {
    // Ambil canvas dan gambar roda kosong (No bets yet)
    const canvas = document.getElementById('donutCanvas');
    if (canvas) { // Cek jika canvas ada
        ctx = canvas.getContext('2d');
        cw = canvas.width;
        ch = canvas.height;
        cx = cw / 2;
        cy = ch / 2;
        drawDonut(); // Gambar roda kosong "No bets yet" saat halaman dimuat
    } else {
        console.error("Canvas element 'donutCanvas' not found!");
    }
});

// === [BARU] FUNGSI UNTUK GANTI JARINGAN ===
/**
 * Mencoba mengganti jaringan atau menambahkannya jika belum ada.
 */
async function switchOrAddNetwork() {
    try {
        // 1. Coba ganti jaringan dulu
        await provider.send('wallet_switchEthereumChain', [{ chainId: BASE_SEPOLIA_CHAIN_ID }]);
    } catch (switchError) {
        // Error code 4902: Jaringan belum ditambahkan ke MetaMask
        if (switchError.code === 4902) {
            try {
                // 2. [FITUR 1] Jika belum ada, paksa tambahkan RPC
                showStatus("Network not found. Adding Sepolia Base...", "wolf");
                await provider.send('wallet_addEthereumChain', [BASE_SEPOLIA_PARAMS]);
            } catch (addError) {
                console.error("Failed to add network:", addError);
                throw new Error("Failed to add Sepolia Base network.");
            }
        } else {
            console.error("Failed to change network:", switchError);
            throw new Error("Failed to change network. Please check your EVM wallet.");
        }
    }
}

// === [REVISI TOTAL] FUNGSI-FUNGSI WALLET ===

/**
 * [REVISI TOTAL] Fungsi 2: Fungsi 'toggleWallet' utama
 * (Sekarang menerima flag 'isAutoConnect')
 */
async function toggleWallet(isAutoConnect = false) {
    if (userAddress) return; 
    // [FIX] Ganti showToast ke showStatus
    if (!window.ethereum) return showStatus("Please install a wallet that supports EVM. Or Metamask.", "wolf");
    
    try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        
        if (isAutoConnect) {
            // Coba ambil akun yang ada tanpa popup
            const accounts = await provider.listAccounts();
            if (accounts.length === 0) {
                console.log("Auto-connect failed: No account.");
                localStorage.removeItem(AUTO_CONNECT_KEY); // Hapus kunci jika gagal
                return; // Gagal secara diam-diam
            }
            signer = provider.getSigner(accounts[0]);
        } else {
            // Minta koneksi manual
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
        }
        
        // --- [FITUR 1] Cek Jaringan ---
        const network = await provider.getNetwork();
        if (network.chainId !== 84532) { // 84532 adalah Chain ID Base Sepolia
            // [FIX] Ganti showToast ke showStatus
            showStatus("Wrong Network. Requesting to switch to Sepolia Base...", "warning");
            await switchOrAddNetwork();
            
            // Re-inisialisasi provider & signer SETELAH ganti jaringan
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
        }

        userAddress = await signer.getAddress(); // Dapatkan alamat HANYA setelah jaringan benar

        // --- [FITUR 2] Tanda Tangan (Signature) ---
        if (!isAutoConnect) { // Hanya minta tanda tangan saat koneksi manual
            const localTime = new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'medium' });
            const message = `Welcome ${userAddress} (${localTime})`;
            
            try {
                // [FIX] Ganti showToast ke showStatus
                showStatus("Meminta tanda tangan...", "load");
                await signer.signMessage(message);
            } catch (signError) {
                // [FIX] Ganti showToast ke showStatus
                showStatus("You refused the signature, login was cancelled.", "error");
                // Reset manual karena login dibatalkan
                provider = null; signer = null; userAddress = null;
                return; // Hentikan login
            }
        }
        
        // --- Login Sukses, Lanjutkan ---
        usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
        faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, signer);

        walletBtn.innerText = "Dashboard";
        referralBtn.style.display = "block"; 
        walletAddress.innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
        
        // Simpan koneksi di Local Storage
        const expiry = new Date().getTime() + AUTO_CONNECT_DURATION;
        localStorage.setItem(AUTO_CONNECT_KEY, expiry.toString());
        
        await updateUserBalances();
        await fetchAndDisplayRoundData(); // Panggil fungsi yang hilang
        await fetchReferralData();
        setupEventListeners();

        // Cek referral dari URL (logika Anda yang sudah ada)
        if (pendingReferrerNickname) {
            try {
                const currentRef = await faylottoContract.referrerOf(userAddress);
                if (currentRef === ethers.constants.AddressZero) {
                    const tx = await faylottoContract.setReferralByNickname(pendingReferrerNickname);
                    await tx.wait();
                    // [FIX] Ganti showToast ke showStatus
                    showStatus(`You have been successfully referred by ${pendingReferrerNickname}!`, "success");
                    pendingReferrerNickname = null;
                    fetchReferralData();
                }
            } catch (e) { console.warn("Failed to auto-set referrer:", e.message); }
        }

        if (!isAutoConnect) {
            // [FIX] Ganti showToast ke showStatus
            showStatus("Wallet connected successfully!", "success");
        }

    } catch (err) {
        console.error("Gagal menghubungkan wallet:", err.message);
        statusText.innerText = "Gagal terhubung. Cek MetaMask.";
        provider = null; signer = null; userAddress = null;
        if (!isAutoConnect) {
            // [FIX] Ganti showToast ke showStatus
            showStatus(err.message, "error");
        }
    }
}

/**
 * [BARU] Fungsi 3: Cek auto-connect saat halaman dimuat
 */
function checkAutoConnect() {
    const expiry = localStorage.getItem(AUTO_CONNECT_KEY);
    if (expiry && new Date().getTime() < Number(expiry)) {
        console.log("Auto-connecting wallet...");
        setTimeout(() => toggleWallet(true), 500); // Panggil dengan flag auto-connect
    } else {
        localStorage.removeItem(AUTO_CONNECT_KEY); // Hapus jika sudah kedaluwarsa
    }
}
    
// === FUNGSI UTAMA: Ambil Data Pemenang & Fitur Sosial ===
async function fetchAndDisplayWinners() {
    let contractInstance = faylottoContract;
    if (!contractInstance) {
       if (!provider) provider = new ethers.providers.JsonRpcProvider("https://sepolia.base.org");
       contractInstance = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    }
    
    try {
        winnerList.innerHTML = "";
        const winnersArray = await contractInstance.getWinners(10); 
        
        if (winnersArray.length === 0) {
            winnerList.appendChild(winnerListPlaceholder);
            return;
        }

        let usdtDecimalsWinner = 18;
        try { if (usdtContract) usdtDecimalsWinner = await usdtContract.decimals(); } catch (e) {}
      
        for (const winner of winnersArray) {
            const winnerId = winner.winnerId.toString();
            const roundId = winner.roundId.toString();
            const winnerAddr = winner.winner;
            const ethAmtBigNum = winner.rewardETH;
            const usdtAmtBigNum = winner.rewardERC20;
            const ethAmt = parseFloat(ethers.utils.formatEther(ethAmtBigNum)).toFixed(4);
            const usdtAmt = parseFloat(ethers.utils.formatUnits(usdtAmtBigNum, usdtDecimalsWinner)).toFixed(2);
            const date = new Date(winner.timestamp.toNumber() * 1000).toLocaleString();
            const shortId = (userAddress && winnerAddr.toLowerCase() === userAddress.toLowerCase()) ? "You" : (winnerAddr.slice(0, 6) + "..." + winnerAddr.slice(-4));
            const avatarUrl = `https://api.dicebear.com/9.x/bottts/svg?seed=${winnerAddr}&baseColor=f0f4f8&backgroundColor=e0f2f7&mouthColor=ffc0cb&faceColor=a7d9f7&sidesColor=ffd700&size=40`;

            // --- LOGIKA Ikon Aset ---
            let assetIconsHtml = '';
            const hasEthReward = ethAmtBigNum.gt(0);
            const hasUsdtReward = usdtAmtBigNum.gt(0);

            if (hasEthReward || hasUsdtReward) {
                assetIconsHtml += '<div class="asset-icon-group">';
                if (hasEthReward) {
                    assetIconsHtml += `<img src="${ETH_LOGO_PATH}" alt="ETH" class="asset-icon">`;
                }
                if (hasUsdtReward) {
                    assetIconsHtml += `<img src="${USDT_LOGO_PATH}" alt="USDT" class="asset-icon">`;
                }
                assetIconsHtml += '</div>';
            }

            // --- AMBIL DATA SOSIAL ---
            let likes = 0, ratingCount = 0, commentCount = 0;
            let isLikedByMe = false, myRating = 0;

            try {
                likes = (await contractInstance.getLikeCount(winnerId)).toNumber();
                ratingCount = (await contractInstance.getRatingCountForWinner(winnerId)).toNumber();
                commentCount = (await contractInstance.getCommentCountForWinner(winnerId)).toNumber();
            } catch (e) { console.warn("Failed to retrieve social public data", e); }

            if (userAddress && faylottoContract) { 
                try {
                    const signedContract = faylottoContract.connect(signer);
                    isLikedByMe = await signedContract.liked(winnerId, userAddress);
                    myRating = await signedContract.ratings(winnerId, userAddress);
                } catch (e) { }
            }
            
            // === [PERBAIKAN DIMULAI DI SINI] ===

            // 1. Ambil Nickname Pemenang
            let winnerNickname = null;
            try {
                winnerNickname = await contractInstance.nicknames(winnerAddr);
            } catch(e) { console.warn("Failed to fetch the winner's nickname", e); }
            
            // 2. Tentukan Nama Tampilan (Prioritas: You -> Nickname -> Alamat Singkat)
            const displayName = (userAddress && winnerAddr.toLowerCase() === userAddress.toLowerCase()) 
                                ? "You" 
                                : (winnerNickname || shortId);

            // =================================

            const item = document.createElement("div");
            item.className = "winner-list-item";
          
            // --- [PERBAIKAN HTML DI SINI] ---
            item.innerHTML = `
              <div class="winner-main-content">
                  <img src="${avatarUrl}" alt="Avatar" 
                       class="winner-avatar-small"
                       onclick="showPlayerProfile('${winnerAddr}')">              

                  <div class="winner-info-text">
                      <div class="winner-id" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span>Round: #${roundId}</span>  
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">        
                        <small style="color: #888; font-size: 10px;">${date}</small>
        
                        ${assetIconsHtml} 

                     </div>
                 </div>

                      <div style="margin-top: 4px; margin-bottom: 4px; font-weight: bold; font-size:14px; color: var(--cyan-main); cursor: pointer;" 
                           onclick="showPlayerProfile('${winnerAddr}')">
                         Winer: ${displayName}
                      </div><br>

                      <div class="prize-line" style="color: #00dd00; font-weight: bold; font-size:15px;">
                         Prize Amount: ${hasEthReward ? ethAmt + ' ETH' : ''} 
                             ${(hasEthReward && hasUsdtReward) ? ' + ' : ''}
                             ${hasUsdtReward ? usdtAmt + ' USDT' : ''}
                      </div><br>
                  </div>
              </div>

              <div class="winner-social" style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(120,0,255,0.2); display:flex; justify-content:space-between; align-items:center;">
                  <button class="like-btn" style="background:none; border:none; cursor:pointer; color: ${isLikedByMe ? '#ff00e6' : '#888'}; font-size:14px; display:flex; align-items:center; gap:4px;" onclick="toggleLike(${winnerId})"><img src="like.svg" style="width:25px; height:25px; vertical-align:middle;"><span style="color:#ff00e6">Like (${likes})</span>
                  </button>
                  <div style="display:flex; align-items:center; gap:6px;">
                      <div class="rating-stars">
                         ${[5, 4, 3, 2, 1].map(i => `
    <span class="star-icon ${i <= myRating ? 'active' : ''}" onclick="rateWinner(${winnerId}, ${i})"></span>
`).join('')}
                      </div>
                      <span style="font-size: 12px; color: #888;">(${ratingCount})</span>
                  </div>
                  <button class="terminal-btn" id="comm-btn-${winnerId}" 
        style="background:none; border:none; color:var(--cyan-main); font-size:14px; cursor:pointer; display:flex; align-items:center; gap:5px;" 
        onclick="toggleComments(${winnerId}, '${winnerAddr}')">
    <img src="comment.svg" style="width:25px; height:25px; vertical-align:middle;">Log
    <span>(${commentCount})</span>
</button>
              </div>

              <div class="comments-terminal" id="terminal-${winnerId}" style="display: none; margin-top: 10px;">
                  <div class="terminal-header">> Log For Winner: ${winnerAddr.slice(0,10)}...</div>
                  <div class="comments-list"></div>
                  <div class="new-comment-section" style="margin-top: 10px; padding-top: 8px; border-top: 1px dashed rgba(120, 0, 255, 0.2); display: flex; gap: 5px; align-items: center;">
                      <span style="color: var(--cyan-main);">></span>
                      <textarea class="terminal-input" id="new-comment-${winnerId}" placeholder="Transmit data..." rows="1" style="resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
                      <button class="terminal-btn" onclick="submitComment(${winnerId})">[ SEND ]</button>
                  </div>
              </div>
            `;
            winnerList.appendChild(item);
        }
    } catch (err) {
        console.error("Failed fetching winners:", err.message);
        winnerList.appendChild(winnerListPlaceholder);
    }
}
            
            
    
// ... (Fungsi toggleLike, rateWinner, submitComment, showEditComment, cancelEditComment, saveEditComment) ...
// ... (Tidak ada perubahan pada fungsi-fungsi ini) ...
async function toggleLike(winnerId) {
  // 1. Ganti alert() dengan showStatus()
  if (!signer || !faylottoContract) {
    showStatus("Please connect wallet first.", "warning");
    return;
  }
  
  // 2. Tambahkan toast 'load'
  showStatus("Processing Like/Unlike...", "load", 3000); // Tampil 3 detik

  try {
    const tx = await faylottoContract.toggleLikeWinner(winnerId);
    await tx.wait();
    
    // 3. Tambahkan toast 'success' (opsional)
    // showStatus("Like updated!", "success", 3000);
    
    fetchAndDisplayWinners(); // Refresh setelah sukses
  } catch (err) {
    console.error("Like failed:", err);
    
    // 4. Tambahkan toast 'error'
    let userMessage = "Like failed.";
    const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;
    else if (err.code === 'ACTION_REJECTED') userMessage = "Transaction rejected.";
    
    showStatus(userMessage, "error");
  }
}

async function rateWinner(winnerId, stars) {
  // 1. Ganti alert() dengan showStatus()
  if (!signer || !faylottoContract) {
    showStatus("Please connect wallet first.", "warning");
    return;
  }
  
  // 2. Tambahkan toast 'load'
  showStatus("Sending your rating...", "load");

  try {
    const tx = await faylottoContract.rateWinner(winnerId, stars);
    await tx.wait();
    
    // 3. Tambahkan toast 'success'
    showStatus("Rating successfully saved!", "success");
    
    fetchAndDisplayWinners(); // Refresh setelah sukses
  } catch (err) {
    console.error("Rating failed:", err);
    
    // 4. Tambahkan toast 'error'
    let userMessage = "Rating failed.";
    const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;
    else if (err.code === 'ACTION_REJECTED') userMessage = "Transaction rejected.";
    
    showStatus(userMessage, "error");
  }
}

async function submitComment(winnerId) {
  // 1. Ganti alert() dengan showStatus()
  if (!signer) {
    showStatus("Connect wallet first.", "warning");
    return;
  }
  
  const input = document.getElementById(`new-comment-${winnerId}`);
  const text = input.value.trim();
  if (!text) return; // Tidak perlu notifikasi jika hanya kosong

  try {
    input.disabled = true;
    const originalValue = input.value;
    input.value = "Transmitting...";
    
    // 2. Tambahkan toast 'load'
    showStatus("Sending comment...", "load");
    
    const tx = await faylottoContract.addCommentToWinner(winnerId, text);
    await tx.wait();
    
    // 3. Tambahkan toast 'success'
    showStatus("Comment sent!", "success");
    
    input.value = "";
    await fetchAndRenderComments(winnerId); // Refresh
  } catch (err) {
    console.error(err);
    
    // 4. Ganti alert() dengan showStatus() 'error'
    let userMessage = "Failed to send comment.";
    const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;
    else if (err.code === 'ACTION_REJECTED') userMessage = "Transaction rejected.";
    
    showStatus(userMessage, "error");
    
    input.value = originalValue; // Kembalikan teks asli jika gagal
  } finally {
    input.disabled = false;
  }
}

function showEditComment(wid, cid) {
  // ... (Tidak ada perubahan pada fungsi ini, sudah benar) ...
  document.getElementById(`msg-${wid}-${cid}`).style.display = 'none';
  document.getElementById(`edit-btn-${wid}-${cid}`).style.display = 'none';
  document.getElementById(`edit-actions-${wid}-${cid}`).style.display = 'block';
}

function cancelEditComment(wid, cid) {
  // ... (Tidak ada perubahan pada fungsi ini, sudah benar) ...
  document.getElementById(`msg-${wid}-${cid}`).style.display = 'block';
  document.getElementById(`edit-btn-${wid}-${cid}`).style.display = 'inline-block';
  document.getElementById(`edit-actions-${wid}-${cid}`).style.display = 'none';
}

async function saveEditComment(wid, cid) {
  // 1. Tambahkan pengecekan signer
  if (!signer) {
      showStatus("Connect wallet first.", "warning");
      return;
  }
  
  const input = document.getElementById(`edit-input-${wid}-${cid}`);
  const newText = input.value.trim();
  
  // 2. Ganti alert() dengan showStatus()
  if (!newText) {
    showStatus("Comment cannot be empty.", "warning");
    return;
  }

  // 3. Tambahkan toast 'load'
  showStatus("Saving edit...", "load");
  
  try {
    const tx = await faylottoContract.editCommentOnWinner(wid, cid, newText);
    await tx.wait();
    
    // 4. Tambahkan toast 'success'
    showStatus("Comment updated!", "success");
    
    fetchAndRenderComments(wid); // Refresh setelah simpan
  } catch (err) {
    console.error("Edit failed:", err);
    
    // 5. Ganti alert() dengan showStatus() 'error'
    let userMessage = "Failed to edit comment.";
    const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;
    else if (err.code === 'ACTION_REJECTED') userMessage = "Transaction rejected.";
    
    showStatus(userMessage, "error");
  }
  // 'finally' block tidak diperlukan di sini karena
  // 'fetchAndRenderComments' akan menggambar ulang UI
  // dan 'cancelEditComment' akan dipanggil secara manual jika gagal.
}


// [WAJIB ADA] Fungsi untuk mengambil dan merender komentar
async function fetchAndRenderComments(winnerId) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const terminalDiv = document.getElementById(`terminal-${winnerId}`);
    if (!terminalDiv) return;
    const commentsListDiv = terminalDiv.querySelector('.comments-list');
    if (!commentsListDiv) return;
    commentsListDiv.innerHTML = "> Loading Neural Logs...";
    let contractInstance = faylottoContract;
    if (!contractInstance) {
        if (!provider) provider = new ethers.providers.JsonRpcProvider(HTTPS_URL);
        contractInstance = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    }
    try {
        const comments = await contractInstance.getAllCommentsForWinner(winnerId);
        if (comments.length === 0) {
            commentsListDiv.innerHTML = "> No Transmissions Found.";
            const commBtn = document.getElementById(`comm-btn-${winnerId}`);
            if (commBtn) {
                commBtn.innerHTML = `<img src="comment.svg" style="width:20px; height:20px; vertical-align:middle;"> <span>(0)</span>`;
            }
            return;
        }
        commentsListDiv.innerHTML = "";
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < comments.length; i++) {
            const c = comments[i];
            const user = c.user;
            const text = c.text;
            const dateObj = new Date(c.timestamp.toNumber() * 1000);
            const time = dateObj.toLocaleString('id-ID', {
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                day: '2-digit', month: '2-digit', year: 'numeric', hour12: false
            });
            const isMyComment = (userAddress && user.toLowerCase() === userAddress.toLowerCase());
            let nickname = null;
            try { nickname = await contractInstance.nicknames(user); } catch (e) {}
            const displayName = nickname || user.slice(0, 6) + '...';
            const avatarUrl = `https://api.dicebear.com/9.x/bottts/svg?seed=${user}&baseColor=f0f4f8&backgroundColor=e0f2f7&mouthColor=ffc0cb&faceColor=a7d9f7&sidesColor=ffd700&size=40`;
            const commentDiv = document.createElement('div');
            commentDiv.className = "comment-log";
            commentDiv.id = `comment-${winnerId}-${i}`;
            let commentHTML = `
                <img src="${avatarUrl}" alt="Avatar" class="comment-avatar" onclick="showPlayerProfile('${user}')">
                <div class="comment-content">
                    <div class="log-meta">
                        <span class="log-nickname" style="cursor: pointer;" onclick="showPlayerProfile('${user}')">
                            ${displayName}
                        </span>
                        <span class="log-wallet" style="cursor: pointer;" onclick="showPlayerProfile('${user}')">
                            (${user.slice(0, 6)}...${user.slice(-4)})
                        </span><br>[${time}]
                    </div><br>
                    <div class="log-message" id="msg-${winnerId}-${i}">${text}</div><br>
            `;
            if (isMyComment) {
                commentHTML += `
                    <div class="edit-actions" style="display:none; margin-top: 10px;" id="edit-actions-${winnerId}-${i}">
                        <textarea class="terminal-input" id="edit-input-${winnerId}-${i}" rows="2">${text}</textarea>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button class="terminal-btn" onclick="saveEditComment(${winnerId}, ${i})">[ SAVE ]</button>
                            <button class="terminal-btn" style="color:#ff5555;border-color:#ff5555" onclick="cancelEditComment(${winnerId}, ${i})">[ CANCEL ]</button>
                        </div>
                    </div>
                    <button class="terminal-btn" id="edit-btn-${winnerId}-${i}" onclick="showEditComment(${winnerId}, ${i})" style="opacity:0.7; margin-top:5px;">[ EDIT LOG ]</button>
                `;
            }
            commentHTML += `</div>`;
            commentDiv.innerHTML = commentHTML;
            fragment.appendChild(commentDiv);
        }
        commentsListDiv.appendChild(fragment);
        const commBtn = document.getElementById(`comm-btn-${winnerId}`);
        if(commBtn) {
            commBtn.innerHTML = `<img src="comment.svg" style="width:20px; height:20px; vertical-align:middle;"> <span>(${comments.length})</span>`;
        }
    } catch (err) {
        console.error("Error fetching comments:", err);
        commentsListDiv.innerHTML = "> Failed: No Signal.";
    }
}
    
function toggleComments(winnerId, winnerAddr) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const terminal = document.getElementById(`terminal-${winnerId}`);
    if (terminal.style.display === 'none') {
        terminal.style.display = 'block';
        fetchAndRenderComments(winnerId);
    } else {
        terminal.style.display = 'none';
    }
}

// === FUNGSI UTAMA: Memulai Event Listener ===
function setupEventListeners() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    let contractToListen = faylottoContract;
    if (!contractToListen && provider) {
         contractToListen = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    }
    if (!contractToListen) return; 
    contractToListen.removeAllListeners(); 
    contractToListen.on("BetETH", (roundId, player, amount) => {
        if (currentRoundId && roundId.eq(currentRoundId)) {
            addBetToState(player, amount, ethers.BigNumber.from(0), true);
            updateBetList();
            if (userAddress && player.toLowerCase() === userAddress.toLowerCase()) updateMyDeposits();
        }
    });
    contractToListen.on("BetERC20", (roundId, player, amount) => {
        if (currentRoundId && roundId.eq(currentRoundId)) {
            addBetToState(player, ethers.BigNumber.from(0), amount, true);
            updateBetList();
            if (userAddress && player.toLowerCase() === userAddress.toLowerCase()) updateMyDeposits();
        }
    });
    contractToListen.on("WinnerRecorded", (winnerId, roundId, winner, rewardETH, rewardERC20, timestamp) => {
        console.log("Event WinnerRecorded received from blockchain:", roundId.toString(), winner);
        if (currentRoundId && roundId.eq(currentRoundId)) {
            if (!isSpinning) {
                 console.log("Starting auto spin for passive users!");
                 handleRoundFinalized(roundId, winner);
            } else {
                 console.log("While spinning, event is ignored (prevents double spins).");
            }
        }
    });
    if (userAddress) {
        contractToListen.on("NicknameCreated", (user) => {
            if (user.toLowerCase() === userAddress.toLowerCase()) fetchReferralData();
        });
        contractToListen.on("ReferralSet", (user) => {
            if (user.toLowerCase() === userAddress.toLowerCase()) fetchReferralData();
        });
    }
}

// Menambahkan fungsi `fetchAndDisplayRoundData` yang hilang
async function fetchAndDisplayRoundData() {
    if (!faylottoContract) return;
    try {
        statusText.innerText = "Syncing round data...";
        currentRoundId = await faylottoContract.currentRoundId();
        const roundInfo = await faylottoContract.getRoundBasic(currentRoundId);
        
        // Reset dan ambil data pemain
        resetRoundUI(); 
        const playersList = await faylottoContract.getRoundPlayers(currentRoundId);
        for (const playerAddress of playersList) {
            const deposits = await faylottoContract.getPlayerDeposits(currentRoundId, playerAddress);
            addBetToState(playerAddress, deposits.ethAmount, deposits.erc20Amount, false);
        }
        updateBetList();
        await updateMyDeposits();

        // === LOGIKA TIMER YANG BENAR (TERSINKRONISASI) ===
        // Ambil endTime ASLI dari kontrak (dalam milidetik)
        const contractEndTime = roundInfo.endTime.toNumber() * 1000;
        const now = Date.now();
        const timeLeft = contractEndTime - now;

        if (timeLeft <= 0) {
            // Jika waktu habis, langsung tampilkan Finalize (kontrak sudah siap)
            statusText.innerText = "Round ended. Waiting for finalization...";
            startVisualTimer(contractEndTime); // Ini akan langsung ke 00:00
        } else {
            // Jika ronde masih berjalan, tampilkan timer
            statusText.innerText = `Round ${currentRoundId.toString()} is live!`;
            placeBetBtn.disabled = false;
            isFinalizing = false;
            startVisualTimer(contractEndTime); // Mulai timer ASLI
        }
        // ===============================================

        console.log("Round data fetched:", roundInfo);
    } catch (err) {
        console.error("Failed fetching round data:", err.message);
        statusText.innerText = "Failed syncing data. Please refresh or check console.";
    }
}


// === FUNGSI UTAMA: Handle Finalisasi ===
async function handleRoundFinalized(roundId, winnerAddr) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    if (isSpinning) return;
    isSpinning = true;
    isFinalizing = true;
    placeBetBtn.style.display = "none";
    finalizeBtn.style.display = "none";
    if (visualTimer) clearInterval(visualTimer);
    timerText.innerText = "WINNER!";
    statusText.innerText = "Spinning to the winner...";
    playSound('sfx-spin');
    await new Promise(resolve => setTimeout(resolve, 1000));
    const targetPlayer = playersArray.find(p => p.addr.toLowerCase() === winnerAddr.toLowerCase());
    if (!targetPlayer) {
        console.error("Winner not found in local playersArray!");
        resetAndFetchNewRound();
        return;
    }
    await spinToPlayer(targetPlayer); 
}
  
// === FUNGSI UTAMA: Reset & Ambil Ronde Baru ===
async function resetAndFetchNewRound() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    console.log("Reset for new round...");
    isSpinning = false;
    isFinalizing = false;
    await new Promise(resolve => setTimeout(resolve, 3000));
    await fetchAndDisplayWinners(); 
    await fetchAndDisplayRoundData(); 
}

// GANTI SELURUH FUNGSI LAMA ANDA DENGAN YANG INI
async function callFinalizeRound() {
    // ... (kode Anda untuk mendapatkan finalizeBtn, statusText, dll) ...
    
    // 1. Ganti alert() dengan showStatus()
    if (!signer || !faylottoContract) {
        showStatus("Please connect your wallet.", "warning"); // atau "warning"
        return;
    }
    
    finalizeBtn.disabled = true;
    statusText.innerText = "Sending finalization transaction...";
    
    // 2. Tambahkan toast 'load'
    showStatus("Sending finalization transaction...", "load");

    try {
        const tx = await faylottoContract.finalizeRound(currentRoundId);
        
        // 3. Tambahkan toast 'load' untuk konfirmasi
        statusText.innerText = "Finalizing... awaiting confirmation.";
        // (Durasi panjang agar tidak hilang saat menunggu)
        showStatus("Finalizing... awaiting confirmation.", "load", 15000); // 15 detik

        const receipt = await tx.wait(); 
        
        // 4. Tambahkan toast 'success'
        showStatus("Round finalized successfully!", "success", 10000); // 3 detik

        console.log("Finalize transaction confirmed.", receipt);
        const event = receipt.events?.find(e => e.event === 'WinnerRecorded');
        
        if (event) {
            const roundId = event.args[1]; 
            const winnerAddr = event.args[2];
            console.log(`Winner found: ${winnerAddr} for Round ${roundId}`);
            if (!isSpinning) {
                handleRoundFinalized(roundId, winnerAddr);
            }
        } else {
            console.log("Round was empty. Resetting...");
            if (!isSpinning) {
                resetAndFetchNewRound();
            }
        }
    } catch (err) {
        console.error("Finalize failed:", err);
        
        // 5. Ganti alert() error dengan showStatus() 'error' + parsing
        let userMessage = "Finalization failed.";
        // (Pastikan 'faylottoContract' memiliki 'interface' untuk parseError)
        const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
        
        if (reason) {
            userMessage = `Error: ${reason.substring(0, 100)}`;
        } else if (err.code === 'ACTION_REJECTED') {
            userMessage = "Transaction rejected by user.";
        }
        
        showStatus(userMessage, "error");
        
        statusText.innerText = "Finalization failed.";
        finalizeBtn.disabled = false; 
    }
}

// === FUNGSI MODAL: Konfirmasi & Kirim Transaksi ===
// GANTI 6 FUNGSI ANDA DENGAN INI (SINTAKS v5)

function showBetModal() {
  if (!signer) {
    showStatus("Connect wallet first!", "wolf");
    return;
  }
  if (isFinalizing) {
    showStatus("Round is ending, new bets are closed.", "warning"); 
    return;
  }

  // --- PERBAIKAN SINTAKS v5 ---
  modalEthBalance.innerText = ethers.utils.formatEther(rawEthBalance || 0); 
  modalUsdtBalance.innerText = ethers.utils.formatUnits(rawUsdtBalance || 0, usdtDecimals); 
  // --- AKHIR PERBAIKAN ---

  betAmountInput.value = "";
  betModalOverlay.classList.add("show");
  betModal.classList.add("show");
}

function hideBetModal() {
  betModalOverlay.classList.remove("show");
  betModal.classList.remove("show");
}

// GANTI FUNGSI LAMA ANDA DENGAN YANG INI
function setAmountByPercent(percent) {
  // 1. Ambil mata uang yang dipilih
  const currency = betCurrencySelect.value;
  
  let min, max, decimalsToDisplay;

  // 2. Tentukan batas min/max berdasarkan mata uang
  if (currency === 'ETH') {
    min = 0.00005;
    max = 0.00256;
    decimalsToDisplay = 8; // ETH butuh presisi desimal lebih tinggi
  } else { // USDT
    min = 0.5;
    max = 10.0;
    decimalsToDisplay = 2; // USDT cukup 2 desimal
  }

  let amountToSet;

  // 3. Kalkulasi jumlah berdasarkan persentase
  // 'percent' akan berupa angka seperti 0.10, 0.25, 0.50, 0.75, 1.00
  
  if (percent === 0.10) {
    // Tombol MIN (dari data-percent="0.10")
    amountToSet = min;
  } else if (percent === 1.00) {
    // Tombol MAX (dari data-percent="1.00")
    amountToSet = max;
  } else {
    // Tombol 25%, 50%, 75%
    // Hitung rentang (selisih) antara max dan min
    const range = max - min;
    // Hitung nilainya: minimal + (rentang * persentase)
    amountToSet = min + (range * percent);
  }

  // 4. Set nilai di input, diformat ke jumlah desimal yang tepat
  betAmountInput.value = amountToSet.toFixed(decimalsToDisplay);
}

// === FUNGSI MODAL: Konfirmasi & Kirim Transaksi ===
async function confirmBet() {
  const amountStr = betAmountInput.value;
  const currency = betCurrencySelect.value;
  
  if (!amountStr || parseFloat(amountStr) <= 0) {
    showStatus("Please enter a valid amount.", "error"); 
    return;
  }
  
  confirmBetBtn.disabled = true;
  confirmBetBtn.innerText = "Processing...";
  showStatus("Sending bet transaction...", "load");

  try {
    let tx;
    if (currency === 'ETH') {
      tx = await placeBetETH(amountStr);
    } else {
      tx = await placeBetUSDT(amountStr);
    }
    
    showStatus("Bet sent! Awaiting confirmation...", "load", 10000); 
    statusText.innerText = `Bet sent! Awaiting confirmation...`;
    
    await tx.wait();
    
    playSound('sfx-coin');
    showStatus("Bet confirmed! Good luck.", "success");
    statusText.innerText = `Bet confirmed! Good luck.`;
    
    hideBetModal();
    await updateUserBalances();
    await updateMyDeposits();
    
  } catch (err) {
    console.error(err);
    const errorMessage = err.reason || err.message || "Transaction failed!";
    showStatus(`Failed: ${errorMessage.substring(0, 100)}`, "error");
    statusText.innerText = "Transaction failed.";
    
  } finally {
    confirmBetBtn.disabled = false;
    confirmBetBtn.innerText = "Confirm Bet";
  }
}

async function placeBetETH(amountStr) {
  // --- PERBAIKAN SINTAKS v5 ---
  const amountWei = ethers.utils.parseEther(amountStr);
  if (amountWei.gt(rawEthBalance || 0)) throw new Error("Insufficient ETH balance.");
  const minEth = ethers.utils.parseEther("0.00005");
  if (amountWei.lt(minEth)) throw new Error("Minimum bet is 0.00005 ETH");
  const maxEth = ethers.utils.parseEther("0.00256");
  const newTotalDeposit = (myCurrentEthDeposit || ethers.BigNumber.from(0)).add(amountWei); // v5
  if (newTotalDeposit.gt(maxEth)) throw new Error("Max total deposit (0.00256 ETH) exceeded.");
  // --- AKHIR PERBAIKAN ---
  return faylottoContract.placeBetETH({ value: amountWei });
}
  
async function placeBetUSDT(amountStr) {
  // --- PERBAIKAN SINTAKS v5 ---
  const amountUsdt = ethers.utils.parseUnits(amountStr, usdtDecimals);
  if (amountUsdt.gt(rawUsdtBalance || 0)) throw new Error("Insufficient USDT balance.");
  const minUsdt = ethers.utils.parseUnits("0.5", usdtDecimals);
  if (amountUsdt.lt(minUsdt)) throw new Error(`Minimum bet is 0.5 USDT`);
  const maxUsdt = ethers.utils.parseUnits("10", usdtDecimals); 
  const newTotalDeposit = (myCurrentUsdtDeposit || ethers.BigNumber.from(0)).add(amountUsdt); // v5
  if (newTotalDeposit.gt(maxUsdt)) throw new Error("Max total deposit (10 USDT) exceeded.");
  
  const currentAllowance = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
  
  if (currentAllowance.lt(amountUsdt)) {
    showStatus("Approval needed. Please approve in MetaMask...", "info", 10000); 
    statusText.innerText = "Need approval. Please approve in MetaMask...";
    
    const approveTx = await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256); // v5
    
    showStatus("Confirming approval...", "load", 10000); 
    statusText.innerText = "Confirming approval...";
    
    await approveTx.wait();
    
    showStatus("Approval successful! Placing bet...", "success");
    statusText.innerText = "Approval successful! Placing bet...";
  }
  // --- AKHIR PERBAIKAN ---
  return faylottoContract.placeBetERC20(amountUsdt);
}


// ===========================================
// === [BARU] FUNGSI-FUNGSI REFERRAL ===
// ===========================================
// --- Tampilkan Modal ---
async function showReferralModal() {
    if (!signer) {
        showStatus("Connect wallet first!", "warning");
        return;
    }
    // Tampilkan modal dulu agar user tidak menunggu lama
    referralModalOverlay.classList.add("show");
    referralModal.classList.add("show");
    
    // Baru fetch data
    await fetchReferralData(); 
}

// --- Ambil Data Referral (PERBAIKAN) ---
async function fetchReferralData() {
    if (!faylottoContract || !userAddress) return;

    try {
        // Pastikan decimals sudah terload
        if (!usdtDecimals && usdtContract) {
            try { usdtDecimals = await usdtContract.decimals(); } catch { usdtDecimals = 6; }
        }
        if (!babyDogeDecimals && babyDogeContract) {
            try { babyDogeDecimals = await babyDogeContract.decimals(); } catch { babyDogeDecimals = 18; } // Default 18 atau 9 tergantung token aslinya
        }

        // Panggil data dari Smart Contract
        const nick = await faylottoContract.nicknames(userAddress);
        const referrer = await faylottoContract.referrerOf(userAddress);
        // Di kontrak baru, returns (ethReward, usdtReward, babyDogeReward)
        const rewards = await faylottoContract.getReferralRewards(userAddress); 
        const count = await faylottoContract.getReferralCount(userAddress);
        
        updateReferralUI(nick, referrer, rewards, count);

    } catch (err) {
        console.error("Failed fetching referral data:", err);
        // Jangan tampilkan error jika modal sudah ditutup
        if(document.getElementById('referral-modal').classList.contains('show')){
             showStatus("Failed to load referral data.", "error");
        }
    }
}

// --- Update UI (PERBAIKAN + BABY DOGE) ---
function updateReferralUI(nick, referrer, rewards, count) {
    // 1. Update Nickname & Link
    const myNickElem = document.getElementById("myNickname");
    const linkSection = document.getElementById("referralLinkSection");
    const linkInput = document.getElementById("referralLinkInput");
    
    if (nick) {
        myNickElem.innerText = nick;
        myNickElem.style.color = "var(--cyan-main)";
        linkSection.style.display = "block";
        linkInput.value = `${window.location.origin}${window.location.pathname}?ref=${nick}`;
    } else {
        myNickElem.innerText = "-";
        linkSection.style.display = "none";
    }
    
    // 2. Update Referrer
    const myRefElem = document.getElementById("myReferrer");
    if (referrer === ethers.constants.AddressZero) {
        myRefElem.innerText = pendingReferrerNickname ? `Pending (${pendingReferrerNickname})` : "-";
        // Jika Anda punya elemen input set referrer, tampilkan di sini
    } else {
        myRefElem.innerText = referrer.slice(0, 6) + "..." + referrer.slice(-4);
    }
    
    // 3. Update Rewards (LOGIKA BARU)
    // Struct return dari kontrak: [ethReward, usdtReward, babyDogeReward]
    
    const ethVal = rewards.ethReward || rewards[0];
    const usdtVal = rewards.usdtReward || rewards.erc20Reward || rewards[1]; // Support nama lama/baru/array index
    const babyVal = rewards.babyDogeReward || rewards[2]; // Nama variabel baru di kontrak

    // Format Angka
    document.getElementById("ethRewards").innerText = parseFloat(ethers.utils.formatEther(ethVal)).toFixed(6);
    document.getElementById("usdtRewards").innerText = parseFloat(ethers.utils.formatUnits(usdtVal, usdtDecimals || 6)).toFixed(2);
    
    // [BARU] Format BabyDoge
    // Cek apakah babyVal ada (karena ini variabel baru)
    if(babyVal) {
        document.getElementById("babyDogeRewards").innerText = parseFloat(ethers.utils.formatUnits(babyVal, babyDogeDecimals || 18)).toFixed(0);
    } else {
        document.getElementById("babyDogeRewards").innerText = "0";
    }

    document.getElementById("referralCount").innerText = count.toString();
    
    // 4. Enable/Disable Claim Button
    const claimBtn = document.getElementById("claimRewardsBtn");
    
    // Tombol aktif jika SALAH SATU reward > 0
    if (ethVal.gt(0) || usdtVal.gt(0) || (babyVal && babyVal.gt(0))) {
        claimBtn.disabled = false;
        claimBtn.innerText = "Claim Rewards";
        claimBtn.style.background = "linear-gradient(90deg, var(--blue-main), var(--pink-main))";
    } else {
        claimBtn.disabled = true;
        claimBtn.innerText = "No Rewards";
        claimBtn.style.background = "#555";
    }
}

    
// === FUNGSI HELPER (Tidak berubah) ===
async function updateUserBalances() {
  // ... (Tidak ada perubahan pada fungsi ini) ...
  if (!provider || !userAddress || !usdtContract) return;
  try {
    rawEthBalance = await provider.getBalance(userAddress);
    ethBalance.innerText = parseFloat(ethers.utils.formatEther(rawEthBalance)).toFixed(5);
    usdtDecimals = await usdtContract.decimals();
    rawUsdtBalance = await usdtContract.balanceOf(userAddress);
    usdtBalance.innerText = parseFloat(ethers.utils.formatUnits(rawUsdtBalance, usdtDecimals)).toFixed(2);
  } catch (err) { 
    console.error("Failed fetching balances:", err.message);
    usdtBalance.innerText = "Failed";
  }
}

  async function updateMyDeposits() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    if (!faylottoContract || !currentRoundId || !userAddress) {
        myEthDeposit.innerText = "0";
        myUsdtDeposit.innerText = "0";
        myCurrentEthDeposit = ethers.BigNumber.from(0); 
        myCurrentUsdtDeposit = ethers.BigNumber.from(0); 
        return;
    }
    try {
        const deposits = await faylottoContract.getPlayerDeposits(currentRoundId, userAddress);
        myCurrentEthDeposit = deposits.ethAmount; 
        myCurrentUsdtDeposit = deposits.erc20Amount;
        myEthDeposit.innerText = parseFloat(ethers.utils.formatEther(deposits.ethAmount)).toFixed(5);
        myUsdtDeposit.innerText = parseFloat(ethers.utils.formatUnits(deposits.erc20Amount, usdtDecimals)).toFixed(2);
    } catch (err) {
        console.error("Could not fetch user deposits:", err.message);
        myEthDeposit.innerText = "Failed, please try again.";
        myUsdtDeposit.innerText = "Failed, please try again.";
    }
  }

  function startVisualTimer(endTime) {
  // ... (Tidak ada perubahan pada fungsi ini) ...
  if (visualTimer) clearInterval(visualTimer);
  visualTimer = setInterval(() => {
    const now = Date.now();
    const timeLeft = endTime - now;
    if (timeLeft <= 0) {
      clearInterval(visualTimer);
      timerText.innerText = "00:00";
      showFinalizeButton(); 
      return;
    }
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    timerText.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }, 1000);
  }
  
function showFinalizeButton() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    if (isFinalizing) return;
    isFinalizing = true; 
    const playerCount = Object.keys(players).length;
    if (playerCount > 0) {
        statusText.innerText = "Round Ended! Click 'Finalize' to pick a winner.";
        finalizeBtn.innerText = "Finalize Round"; 
    } else {
        statusText.innerText = "Round Ended! Click 'Start Now' to begin a new round.";
        finalizeBtn.innerText = "Start Round"; 
    }
    placeBetBtn.disabled = true;
    placeBetBtn.style.display = "none";
    finalizeBtn.style.display = "block";
    finalizeBtn.disabled = false;
}

  function resetRoundUI() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    players = {};
    totalWeight = ethers.BigNumber.from(0);
    playersArray = []; 
    if (ctx) {
        currentRotation = 0;
        drawDonut(); 
    }
    updateBetList();
    placeBetBtn.style.display = "block";
    placeBetBtn.disabled = true;
    finalizeBtn.style.display = "none";
    finalizeBtn.innerText = "Finalize Round"; 
    myEthDeposit.innerText = "0";
    myUsdtDeposit.innerText = "0";
  }

function addBetToState(playerId, ethAmount, usdtAmount, isEvent = false) {
  // ... (Tidak ada perubahan pada fungsi ini) ...
  const playerKey = playerId.toLowerCase(); 
  if (!players[playerKey]) {
    const colorIndex = Object.keys(players).length;
    const playerColor = PLAYER_COLORS[colorIndex % 10]; 
    players[playerKey] = {
      id: playerId,
      eth: ethers.BigNumber.from(0),
      usdt: ethers.BigNumber.from(0),
      color: playerColor, 
      data: { startAngle: 0, endAngle: 0 } 
    };
  }
  const player = players[playerKey];
  if (isEvent) {
      player.eth = player.eth.add(ethAmount);
      player.usdt = player.usdt.add(usdtAmount);
  } else {
      player.eth = ethAmount;
      player.usdt = usdtAmount;
  }
  const ethWeight = player.eth;
  const usdtFactor = ethers.BigNumber.from(10).pow(18 - usdtDecimals);
  const usdtWeight = player.usdt.mul(usdtFactor);
  player.weight = ethWeight.add(usdtWeight);
  totalWeight = ethers.BigNumber.from(0);
  for (const pid in players) {
      totalWeight = totalWeight.add(players[pid].weight);
  }
  rebuildPlayersArrayAndDraw();
}
  
  
function updateBetList() {
  // ... (Tidak ada perubahan pada fungsi ini) ...
  betList.innerHTML = ""; 
  const playerIds = Object.keys(players);
  if (playerIds.length === 0) {
    betList.innerHTML = '<p id="bet-list-placeholder">No bets placed yet in this round.</p>';
    return;
  }
  playerIds.forEach(id => {
    const player = players[id];
    const ethAmount = parseFloat(ethers.utils.formatEther(player.eth)).toFixed(5);
    const usdtAmount = parseFloat(ethers.utils.formatUnits(player.usdt, usdtDecimals)).toFixed(2);
    const shortId = (userAddress && id.toLowerCase() === userAddress.toLowerCase()) ? "You" : (id.slice(0, 6) + "..." + id.slice(-4));
    let betsHtml = "";
    if (player.eth.gt(0)) betsHtml += `${ethAmount} ETH`;
    if (player.eth.gt(0) && player.usdt.gt(0)) betsHtml += " + ";
    if (player.usdt.gt(0)) betsHtml += `${usdtAmount} USDT`;
    const item = document.createElement("div");
    item.className = "bet-list-item";
    item.innerHTML = `
      <div class="player-id" style="color: ${player.color}">${shortId}</div>
      <div class="player-bets">${betsHtml}</div>
    `;
    betList.appendChild(item);
  });
}

// ======= Draw donut on canvas =======
    function drawDonut(rotationDeg = currentRotation) {
      // ... (Tidak ada perubahan pada fungsi ini) ...
      ctx.clearRect(0,0,cw,ch);
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(rotationDeg * Math.PI / 180);
      ctx.translate(-cx, -cy);
      ctx.beginPath();
      ctx.arc(cx, cy, outerR + 6, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.01)';
      ctx.fill();
      if (!playersArray || playersArray.length === 0) {
        const gradient = ctx.createRadialGradient(cx, cy, innerR, cx, cy, outerR);
        gradient.addColorStop(0, '#ff00e6');    
        gradient.addColorStop(0.7, '#6200ff');  
        gradient.addColorStop(1, '#0b0b12');    
        ctx.beginPath();
        ctx.arc(cx, cy, outerR, 0, Math.PI*2);
        ctx.fillStyle = gradient;
        ctx.fill();
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(cx, cy, innerR, 0, Math.PI*2);
        ctx.fill();
        ctx.globalCompositeOperation = 'source-over';
        ctx.restore();
        ctx.fillStyle = '#ffffff';
        ctx.font = '14px Ubuntu'; 
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('No bets yet', cx, cy);
        return;
      }
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        const sa = p.startAngle;
        const ea = p.endAngle;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, outerR, sa, ea, false);
        ctx.closePath();
        ctx.fillStyle = p.color;
        ctx.fill();
      }
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(cx, cy, innerR, 0, Math.PI*2);
      ctx.fill();
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = 'rgba(0,0,0,0.25)';
      ctx.lineWidth = 1;
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        ctx.beginPath();
        ctx.moveTo(cx + Math.cos(p.startAngle) * (innerR+2), cy + Math.sin(p.startAngle) * (innerR+2));
        ctx.lineTo(cx + Math.cos(p.startAngle) * outerR, cy + Math.sin(p.startAngle) * outerR);
        ctx.stroke();
      }
      ctx.fillStyle = '#fff';
      ctx.font = '12px Ubuntu'; 
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        const mid = (p.startAngle + p.endAngle) / 2;
        const rlabel = (outerR + innerR) / 2;
        const lx = cx + Math.cos(mid) * rlabel;
        const ly = cy + Math.sin(mid) * rlabel;
        const short = p.addr.slice(0,6);
        ctx.fillStyle = 'rgba(0,12,20,0.85)';
        ctx.beginPath();
        ctx.fillStyle = 'rgba(255,255,255,0.85)';
        ctx.roundRect = ctx.roundRect || function(x,y,w,h,r){ if (w<2*r) r=w/2; if (h<2*r) r=h/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill(); };
        const text = short;
        ctx.font = '12px Ubuntu';
        const tw = ctx.measureText(text).width + 8;
        ctx.fillStyle = 'rgba(0,0,0,0.45)';
        ctx.roundRect(lx - tw/2, ly - 12/2, tw, 16, 8);
        ctx.fillStyle = '#fff';
        ctx.fillText(text, lx, ly);
      }
      ctx.restore();
    }

    if (!CanvasRenderingContext2D.prototype.roundRect) {
      // ... (Tidak ada perubahan pada fungsi ini) ...
      CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
        if (w<2*r) r=w/2; if (h<2*r) r=h/2;
        this.beginPath();
        this.moveTo(x+r,y);
        this.arcTo(x+w,y,x+w,y+h,r);
        this.arcTo(x+w,y+h,x,y+h,r);
        this.arcTo(x,y+h,x,y,r);
        this.arcTo(x,y,x+w,y,r);
        this.closePath();
        this.fill();
      };
    }

function rebuildPlayersArrayAndDraw() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    playersArray = []; 
    const playerKeys = Object.keys(players);
    for (const key of playerKeys) {
        playersArray.push({
            addr: players[key].id,
            weight: players[key].weight, 
            color: players[key].color
        });
    }
    let currentAngle = 0;
    const totalW = totalWeight; 
    for (const p of playersArray) {
        p.startAngle = currentAngle;
        let percentage = 0;
        if (totalW.gt(0)) {
            percentage = p.weight.mul(1000000).div(totalW).toNumber() / 1000000;
        }
        p.endAngle = currentAngle + (percentage * Math.PI * 2);
        currentAngle = p.endAngle;
    }
    drawDonut();
}

  
  
  // ======= Weighted random selection (client-side) =======
    function pickWinnerClientSide() {
      // ... (Tidak ada perubahan pada fungsi ini) ...
      if (!playersArray || playersArray.length === 0) return null;
      const total = playersArray.reduce((acc,p)=> acc + p.weight, 0n);
      if (total === 0n) return null;
      const rand = randBigInt(total);
      let cum = 0n;
      for (let i=0;i<playersArray.length;i++){
        cum += playersArray[i].weight;
        if (rand < cum) return playersArray[i];
      }
      return playersArray[playersArray.length-1];
    }

  function randBigInt(max) {
      // ... (Tidak ada perubahan pada fungsi ini) ...
      const bytes = Math.ceil((max.toString(2).length)/8);
      let rand;
      do {
        const arr = new Uint8Array(bytes);
        window.crypto.getRandomValues(arr);
        rand = 0n;
        for (let i=0;i<arr.length;i++) rand = (rand << 8n) + BigInt(arr[i]);
      } while (rand >= max);
      return rand;
    }

// ======= Spin animation =======
function spinToPlayer(targetPlayer) {
  // ... (Tidak ada perubahan pada fungsi ini) ...
  return new Promise((resolveAnimation) => { 
      if (!targetPlayer) {
          resetAndFetchNewRound();
          resolveAnimation(); return;
      }
      const midRad = (targetPlayer.startAngle + targetPlayer.endAngle) / 2;
      const midDeg = (midRad * 180 / Math.PI);
      const targetRotationDeg = 270 - midDeg;
      const duration = Math.floor(Math.random() * (40000 - 30000 + 1)) + 30000;
      const spins = Math.floor(duration / 1200); 
      const finalRotation = (spins * 360) + targetRotationDeg;
      const startRotation = currentRotation; 
      const startTime = performance.now();
      function animate(now) {
        const t = Math.min(1, (now - startTime) / duration);
        const eased = 1 - Math.pow(1 - t, 4);
        currentRotation = startRotation + ((finalRotation - startRotation) * eased); 
        drawDonut(currentRotation);
        if (t < 1) {
          requestAnimationFrame(animate);
        } else {
          isSpinning = false; 
          const spinAudio = document.getElementById('sfx-spin');
          if(spinAudio) { spinAudio.pause(); spinAudio.currentTime = 0; }
          playSound('sfx-win');
          const isWinner = userAddress && (targetPlayer.addr.toLowerCase() === userAddress.toLowerCase());
          if (isWinner) {
              showVictoryScreen();
          } else {
              const winnerName = targetPlayer.addr.slice(0, 6) + "...";
              // [FIX] Ganti alert ke showStatus
              showStatus(`The winner is ${winnerName}! Try again later.`, 'info');
          }
          resetAndFetchNewRound(); 
          resolveAnimation(); 
        } 
      }
      requestAnimationFrame(animate);
  });
}

// [BARU] Fungsi untuk menampilkan/menyembunyikan Modal Wallet
function showWalletModal() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    walletModalOverlay.classList.add("show");
    walletModal.classList.add("show");
}
function hideWalletModal() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    walletModalOverlay.classList.remove("show");
    walletModal.classList.remove("show");
}

    // Function Disconnect Wallet
function disconnectWallet() {
    userAddress = null; provider = null; signer = null;
    walletBtn.innerText = "Connect Wallet";
    referralBtn.style.display = "none";
    statusText.innerText = "Wallet not connected";
    
    hideWalletModal(); 
    
    localStorage.removeItem(AUTO_CONNECT_KEY);
    
    if (visualTimer) clearInterval(visualTimer);
    if (faylottoContract) {
        faylottoContract.removeAllListeners();
        faylottoContract = null; 
    }
    
    resetRoundUI();
    myEthDeposit.innerText = "0"; 
    myUsdtDeposit.innerText = "0";
    winnerList.innerHTML = "";
    winnerList.appendChild(winnerListPlaceholder);

    // Reset info di modal
    walletAddress.innerText = "-";
    ethBalance.innerText = "0";
    usdtBalance.innerText = "0";
    
    fetchAndDisplayRoundData();
    fetchAndDisplayWinners();
    // [FIX] Ganti showToast ke showStatus
    showStatus("Wallet disconnected.", "info");
}
    
function handleCanvasRedraw() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    if (ctx) {
        console.log("Window/Tab is back active. Redrawing canvas...");
        drawDonut(currentRotation);
    }
}

    // --- FUNGSI PROFIL PLAYER ---
async function showPlayerProfile(address) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const modal = document.getElementById('profile-modal');
    const overlay = document.getElementById('profile-modal-overlay');
    document.getElementById('profileNickname').innerText = "Scanning...";
    document.getElementById('profileAddress').innerText = address;
    document.getElementById('profileRefCount').innerText = "-";
    document.getElementById('profileAvatar').src = `https://api.dicebear.com/9.x/bottts/svg?seed=${address}&baseColor=f0f4f8&backgroundColor=e0f2f7&mouthColor=ffc0cb&faceColor=a7d9f7&sidesColor=ffd700`;
    modal.classList.add('show');
    overlay.classList.add('show');
    try {
        const contract = faylottoContract || new ethers.providers.JsonRpcProvider(HTTPS_URL).then(p => new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, p));
        const activeContract = (contract.then) ? await contract : contract;
        const nickname = await activeContract.nicknames(address);
        const refCount = await activeContract.getReferralCount(address);
        document.getElementById('profileNickname').innerText = nickname || "No Nickname Yet";
        document.getElementById('profileRefCount').innerText = refCount.toString();
    } catch (e) {
        showStatus("Failed to load profile. Please connect your wallet.", "warning"); 
        document.getElementById('profileNickname').innerText = "Failed to load";
        document.getElementById('profileRefCount').innerText = "N/A";
    }
}

// === FUNGSI HELPER AUDIO ===
function playSound(soundId) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const audio = document.getElementById(soundId);
    if (audio) {
        audio.currentTime = 0; 
        audio.play().catch(e => console.warn("Audio autoplay blocked:", e));
    }
}
// (Hapus fungsi playSound duplikat)
// (Hapus fungsi confirmBet duplikat)

    // === FUNGSI VICTORY OVERLAY ===
let victoryAnimationId = null;
function showVictoryScreen() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const overlay = document.getElementById('victory-overlay');
    overlay.classList.add('show');
    playSound('sfx-win'); 
    startVictoryConfetti();
}
function hideVictoryScreen() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const overlay = document.getElementById('victory-overlay');
    overlay.classList.remove('show');
    stopVictoryConfetti();
}
function startVictoryConfetti() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const canvas = document.getElementById('victory-canvas');
    const ctx = canvas.getContext('2d');
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;
    const particles = [];
    const particleCount = 150;
    const colors = ['#00ffff', '#ff00e6', '#6200ff', '#ffffff']; 
    for (let i = 0; i < particleCount; i++) {
        particles.push({
            x: Math.random() * width,
            y: Math.random() * height - height, 
            w: Math.random() * 10 + 5,          
            h: Math.random() * 10 + 5,
            speed: Math.random() * 5 + 2,       
            color: colors[Math.floor(Math.random() * colors.length)],
            tilt: Math.random() * 10,           
            tiltAngleIns: Math.random() * 0.07 + 0.05
        });
    }
    function animateConfetti() {
        ctx.clearRect(0, 0, width, height);
        particles.forEach(p => {
            p.tilt += p.tiltAngleIns;
            p.y += p.speed;
            ctx.beginPath();
            ctx.lineWidth = p.w / 2;
            ctx.strokeStyle = p.color;
            ctx.moveTo(p.x + p.tilt + (p.w / 2), p.y);
            ctx.lineTo(p.x + p.tilt, p.y + p.tilt + (p.h / 2));
            ctx.stroke();
            if (p.y > height) {
                p.x = Math.random() * width;
                p.y = -20;
            }
        });
        victoryAnimationId = requestAnimationFrame(animateConfetti);
    }
    animateConfetti();
}
function stopVictoryConfetti() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    if (victoryAnimationId) cancelAnimationFrame(victoryAnimationId);
    const canvas = document.getElementById('victory-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}
    
   // 1. Variabel Global Baru
let currentLbMode = 'score'; // Default ke Profit

// 2. Fungsi Ganti Mode
function switchLbMode(mode) {
    currentLbMode = mode;
    
    // Update Tampilan Tombol
    document.getElementById('btn-lb-score').style.opacity = mode === 'score' ? '1' : '0.6';
    document.getElementById('btn-lb-score').style.background = mode === 'score' ? 'var(--pink-main)' : 'transparent';
    
    document.getElementById('btn-lb-ref').style.opacity = mode === 'ref' ? '1' : '0.6';
    document.getElementById('btn-lb-ref').style.background = mode === 'ref' ? 'var(--pink-main)' : 'transparent';

    // Update Header Kolom
    const header = document.getElementById('lb-header-row');
    if (mode === 'score') {
        header.innerHTML = `<span>Rank</span><span>Pilot</span><span>Net Profit ($)</span><span>Assets Won</span>`;
    } else {
        header.innerHTML = `<span>Rank</span><span>Inviter</span><span>Total Refs</span><span>Rewards Claimed</span>`;
    }

    // Refresh Data
    fetchAndRenderLeaderboard();
}

// 3. UPDATE FUNGSI fetchAndRenderLeaderboard (Support 2 Mode)
async function fetchAndRenderLeaderboard() {
    const list = document.getElementById("leaderboard-list");
    if (!list) return;
    
    // Gunakan provider read-only
    let contract = faylottoContract || new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    
    try {
        list.innerHTML = "<div class='lb-loading' style='animation:blink 1s infinite;'>Scanning blockchain data...</div>";
        
        const playerAddresses = await contract.getLeaderboardPlayers();
        
        if (playerAddresses.length === 0) {
            list.innerHTML = "<div class='lb-loading' style='animation:none;'>NO DATA YET.</div>";
            return;
        }

        // Ambil Data
        const promises = playerAddresses.map(async (addr) => {
            const stats = await contract.leaderboardStats(addr);
            return {
                addr: addr,
                // Data Profit
                netEth: stats.netEth,
                netUsdt: stats.netUsdt,
                netBaby: stats.netBabyDoge,
                score: stats.netUsdScore, // BigNumber (int256)
                
                // Data Referral
                refCount: stats.referralCount, // BigNumber (uint256)
                refEth: stats.totalReferralEthClaimed,
                refUsdt: stats.totalReferralUsdtClaimed,
                refBaby: stats.totalReferralBabyDogeClaimed
            };
        });

        const rawData = await Promise.all(promises);

        // === LOGIKA SORTING BERDASARKAN MODE ===
        rawData.sort((a, b) => {
            if (currentLbMode === 'score') {
                // Sort Profit: Dari Tinggi ke Rendah
                if (b.score.gt(a.score)) return 1;
                if (b.score.lt(a.score)) return -1;
                return 0;
            } else {
                // Sort Referral: Dari Banyak ke Sedikit
                if (b.refCount.gt(a.refCount)) return 1;
                if (b.refCount.lt(a.refCount)) return -1;
                return 0;
            }
        });

        const top10 = rawData.slice(0, 10);
        list.innerHTML = ""; 

        if (!usdtDecimals) usdtDecimals = 6; 
        if (!babyDogeDecimals) babyDogeDecimals = 18;

        for (let i = 0; i < top10.length; i++) {
            const p = top10[i];
            const rank = i + 1;
            const shortAddr = p.addr.slice(0, 6) + "..." + p.addr.slice(-4);
            const isMe = userAddress && p.addr.toLowerCase() === userAddress.toLowerCase();
            const displayName = isMe ? "YOU" : shortAddr;
            
            let rankClass = "";
            if (rank === 1) rankClass = "rank-1";
            else if (rank === 2) rankClass = "rank-2";
            else if (rank === 3) rankClass = "rank-3";

            // === RENDER HTML BERDASARKAN MODE ===
            if (currentLbMode === 'score') {
                // TAMPILAN PROFIT
                const scoreFmt = parseFloat(ethers.utils.formatEther(p.score)).toFixed(2);
                // Warna skor: Hijau jika plus, Merah jika minus
                const scoreColor = p.score.gte(0) ? '#00ff88' : '#ff4d4d';
                
                // Hitung total aset (Net)
                const ethFmt = parseFloat(ethers.utils.formatEther(p.netEth)).toFixed(4);
                const usdtFmt = parseFloat(ethers.utils.formatUnits(p.netUsdt, usdtDecimals)).toFixed(2);

                list.innerHTML += `
                    <div class="lb-item ${rankClass}" style="display:grid; grid-template-columns: 0.5fr 2fr 1.5fr 2fr; padding:10px; border-bottom:1px solid rgba(120,0,255,0.2); ${isMe ? 'color:var(--cyan-main); font-weight:bold;' : ''}">
                        <div class="lb-rank">#${rank}</div>
                        <div style="cursor:pointer;" onclick="showPlayerProfile('${p.addr}')">${displayName}</div>
                        <div style="color:${scoreColor}; font-weight:bold;">$${scoreFmt}</div>
                        <div style="font-size:11px;">
                            ${ethFmt} ETH<br>
                            ${usdtFmt} USDT
                        </div> 
                    </div>
                `;
            } else {
                // TAMPILAN REFERRAL
                const count = p.refCount.toString();
                const refEth = parseFloat(ethers.utils.formatEther(p.refEth)).toFixed(4);
                const refBaby = parseFloat(ethers.utils.formatUnits(p.refBaby, babyDogeDecimals)).toFixed(0);

                list.innerHTML += `
                    <div class="lb-item ${rankClass}" style="display:grid; grid-template-columns: 0.5fr 2fr 1.5fr 2fr; padding:10px; border-bottom:1px solid rgba(120,0,255,0.2); ${isMe ? 'color:var(--cyan-main); font-weight:bold;' : ''}">
                        <div class="lb-rank">#${rank}</div>
                        <div style="cursor:pointer;" onclick="showPlayerProfile('${p.addr}')">${displayName}</div>
                        <div style="color:#ff00e6; font-weight:bold;">${count} Users</div>
                        <div style="font-size:11px;">
                            ${refEth} ETH<br>
                            ${refBaby} Baby
                        </div> 
                    </div>
                `;
            }
        }

    } catch (err) {
        console.error("Leaderboard error:", err);
        list.innerHTML = "<div class='lb-loading' style='color:#ff5555;'>FAILED TO LOAD.</div>";
    }
}

    
// Fungsi Tutup Modal Profil
function hideProfileModal() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    document.getElementById('profile-modal').classList.remove('show');
    document.getElementById('profile-modal-overlay').classList.remove('show');
}

// Helper Copy to Clipboard (berguna untuk address)
function copyToClipboard(text) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    navigator.clipboard.writeText(text);
    showStatus("Address copied: " + text, "success", 3000); // 3000ms = 3 detik
}

/**
 * [FIX] Ini adalah fungsi TOAST Anda. Namanya showStatus, bukan showToast.
 * (Tidak ada perubahan di dalam fungsi ini, hanya memastikan ia ada)
 */
function showStatus(message, type = 'info', duration = 10000) { 
  const container = document.getElementById('toast-container');
  if (!container) return;
  let iconName = 'info-icon.svg'; 
  if (type === 'success') iconName = 'success.svg';
  else if (type === 'error') iconName = 'error.svg';
  else if (type === 'load') iconName = 'load.svg';
  else if (type === 'warning') iconName = 'warning.svg';
  else if (type === 'spin') iconName = 'spin.svg';
  else if (type === 'wolf') iconName = 'wolf.svg';
  const toast = document.createElement('div');
  toast.className = `toast-notification ${type}`;
  const icon = document.createElement('img');
  icon.src = `${iconName}`; 
  icon.alt = "status icon";
  const text = document.createElement('span');
  text.textContent = message;
  const closeButton = document.createElement('button');
  closeButton.className = 'toast-close-btn';
  closeButton.innerHTML = '&times;'; 
  toast.appendChild(icon);
  toast.appendChild(text);
  toast.appendChild(closeButton);
  function removeToast() {
    toast.classList.remove('show');
    toast.classList.add('hide');
    toast.addEventListener('transitionend', () => {
      if (toast.parentNode === container) {
          container.removeChild(toast);
      }
    }, { once: true });
  }
  const hideTimeout = setTimeout(removeToast, duration);
  closeButton.onclick = () => {
    clearTimeout(hideTimeout); 
    removeToast(); 
  };
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('show');
  }, 10); 
}

// === 4. Inisialisasi & Event Listeners (LENGKAP & DIPERBAIKI) ===

document.addEventListener("DOMContentLoaded", () => {
    console.log("🚀 App initializing...");

    // 1. Inisialisasi Canvas (Roda Donat)
    // (Ini sudah ditangani oleh DOMContentLoaded Anda yang lain di baris 316,
    // tapi kita bisa gabungkan di sini jika mau. Untuk saat ini, biarkan saja.)
    // const canvas = document.getElementById('donutCanvas'); ...

    // 2. Cek Link Referral dari URL
    // (Ini adalah logika dari DOMContentLoaded Anda yang error di baris 297)
    const urlParams = new URLSearchParams(window.location.search);
    const refNick = urlParams.get('ref');
    if (refNick) {
        console.log("🔗 Referral detected:", refNick);
        pendingReferrerNickname = refNick;
    }

    // 3. Panggil Data Awal SEGERA (Tanpa Menunggu Wallet)
    // [FIX] Ini adalah perbaikan untuk bug "tombol tidak aktif"
    fetchAndDisplayRoundData(); // <-- FUNGSI YANG HILANG SEKARANG ADA
    fetchAndDisplayWinners();
    fetchAndRenderLeaderboard(); // Panggil leaderboard saat load
    checkAutoConnect(); // Coba auto-connect

    // -------------------------------------------------
    // 4. Pasang Semua Event Listeners
    // -------------------------------------------------

    // Listener Tombol Utama
    walletBtn.addEventListener("click", () => {
        if (!userAddress) toggleWallet(); else showWalletModal();
    });
    placeBetBtn.addEventListener("click", showBetModal);
    finalizeBtn.addEventListener("click", callFinalizeRound);

    // Listener Modal Profil
    const profileCloseBtn = document.getElementById('profile-modal-close-btn');
    if (profileCloseBtn) profileCloseBtn.addEventListener('click', hideProfileModal);
    const profileOverlay = document.getElementById('profile-modal-overlay');
    if (profileOverlay) profileOverlay.addEventListener('click', hideProfileModal);

    // Listener Modal Bet
    betModalCloseBtn.addEventListener("click", hideBetModal);
    betModalOverlay.addEventListener("click", hideBetModal);
    confirmBetBtn.addEventListener("click", confirmBet);
    percentButtons.forEach(button => {
        button.addEventListener("click", () => {
            const percent = parseFloat(button.dataset.percent);
            setAmountByPercent(percent);
        });
    });

    // Listener Modal Referral
    if (referralBtn) referralBtn.addEventListener("click", showReferralModal);
    if (referralModalCloseBtn) referralModalCloseBtn.addEventListener("click", hideReferralModal);
    if (referralModalOverlay) referralModalOverlay.addEventListener("click", hideReferralModal);
    if (createNicknameBtn) createNicknameBtn.addEventListener("click", callCreateNickname);
    // [FIX] Tambahkan cek null untuk elemen yang mungkin tidak ada
    if (setReferrerBtn) setReferrerBtn.addEventListener("click", callSetReferrer);
    if (claimRewardsBtn) claimRewardsBtn.addEventListener("click", callClaimRewards);

    // Listener Modal Wallet
    if (walletModalCloseBtn) walletModalCloseBtn.addEventListener("click", hideWalletModal);
    if (walletModalOverlay) walletModalOverlay.addEventListener("click", hideWalletModal);
    if (disconnectBtn) disconnectBtn.addEventListener("click", disconnectWallet);

    // Listener Copy Referral
    const copyBtn = document.getElementById("copyReferralBtn");
    if (copyBtn) {
        copyBtn.addEventListener("click", () => {
            const linkInput = document.getElementById("referralLinkInput");
            if (linkInput) {
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); 
                navigator.clipboard.writeText(linkInput.value)
                    .then(() => showStatus("Link referral disalin!", "success")) // [FIX] Ganti alert ke showStatus
                    .catch(() => {
                        document.execCommand('copy');
                        showStatus("Link referral disalin!", "success"); // [FIX] Ganti alert ke showStatus
                    });
            }
        });
    }

    // Listener ganti ikon di modal bet
    const currencySelect = document.getElementById('betCurrencySelect');
    const currencyIcon = document.getElementById('currency-icon');
    if (currencySelect && currencyIcon) {
        currencySelect.addEventListener('change', (e) => {
            const selectedIconPath = e.target.options[e.target.selectedIndex].dataset.icon;
            if (selectedIconPath) {
                currencyIcon.src = selectedIconPath;
            }
        });
    }

     // Tambahkan suara klik ke semua tombol
    document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => playSound('sfx-click'));
    });

    // Listener Perbaikan Canvas & Tab
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') handleCanvasRedraw();
    });
    window.addEventListener("focus", handleCanvasRedraw);

});

  </script>
</body>
  </html>
