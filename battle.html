<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Faylotto — Minimal Futuristic UI</title>

<!-- Ethers v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
  /* Minimal futuristic design with dark/light mode */
  :root{
    --bg-dark: #061021;
    --panel-dark: #071029;
    --accent: #4f9ef9;
    --muted: #9fb0c8;
    --glass: rgba(255,255,255,0.03);
    --success: #2dd4bf;
    --danger: #ff6b6b;

    --bg-light: #f5f7fb;
    --panel-light: #ffffff;
    --text-light: #0b1320;
    --muted-light: #6b7280;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;display:flex;align-items:center;justify-content:center;background:var(--bg-dark);color:#dbeafe}
  .app{width:100%;max-width:1100px;padding:18px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#8be9ff);display:grid;place-items:center;color:#021627;font-weight:700}
  h1{font-size:15px;margin:0}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#021627;border:none;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .badge{background:var(--glass);padding:6px 10px;border-radius:8px;font-weight:600;color:var(--muted);font-size:13px}

  /* layout grid */
  .grid{display:grid;grid-template-columns: 360px 1fr; gap:14px}
  @media (max-width:920px){ .grid{grid-template-columns:1fr} }

  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .section-title{font-size:13px;color:var(--muted);margin-bottom:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text], input[type=number], select{
    width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;outline:none;
  }
  .small{font-size:13px;color:var(--muted)}
  .balances{display:flex;flex-direction:column;gap:6px}
  .player-item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px}
  .winners{display:flex;flex-direction:column;gap:8px}
  pre{background:#001218;padding:10px;border-radius:8px;color:#bfe6ff;max-height:200px;overflow:auto;font-size:12px}

  /* theme: light */
  .light {
    background: var(--bg-light);
    color: var(--text-light);
  }
  .light .panel{background:var(--panel-light);border-color:rgba(11,18,32,0.04);box-shadow:none}
  .light .badge{background:#f1f5f9;color:var(--muted-light}
  .light input, .light select{background:#fff;color:var(--text-light);border-color:#e6eef6}

  /* minimal futuristic touches */
  .muted{color:var(--muted);font-size:13px}
  .accent-small{color:var(--accent);font-weight:700}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .tiny{font-size:12px;color:var(--muted)}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo">FY</div>
        <div>
          <h1>Faylotto Spin Battle</h1>
          <div class="tiny">Minimal • Futuristic • Dual-mode</div>
        </div>
      </div>

      <div class="controls">
        <div id="networkBadge" class="badge">Network: -</div>
        <div id="addrBadge" class="badge">Not connected</div>
        <button id="btnTheme" class="btn ghost">Toggle Theme</button>
        <button id="btnConnect" class="btn">Connect</button>
        <button id="btnDisconnect" class="btn ghost hidden">Disconnect</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT COLUMN: Controls -->
      <div>
        <div class="panel" style="margin-bottom:12px">
          <div class="section-title">Contract / Token</div>
          <label>Contract Address</label>
          <input id="inputContract" type="text" placeholder="0x... (FaylottoSpinBattle)" />
          <label style="margin-top:8px">ERC20 Token (USDT)</label>
          <input id="inputERC20" type="text" placeholder="0x... (USDT token)" />
          <div style="margin-top:10px" class="row">
            <button id="btnLoad" class="btn">Load</button>
            <button id="btnRefresh" class="btn ghost">Refresh</button>
          </div>
          <div style="margin-top:10px" class="tiny">Chain expected: Sepolia (edit constant in code if different)</div>
        </div>

        <div class="panel" style="margin-bottom:12px">
          <div class="section-title">Wallet Balances</div>
          <div class="balances">
            <div class="flex-between"><div class="small">ETH</div><div id="balEth" class="accent-small">-</div></div>
            <div class="flex-between"><div class="small">USDT</div><div id="balToken" class="accent-small">-</div></div>
            <div class="tiny" id="allowInfo">Allowance: -</div>
          </div>
        </div>

        <div class="panel">
          <div class="section-title">Referral / Nickname</div>
          <label>Create Nickname</label>
          <input id="inputNick" type="text" placeholder="min 3 chars" />
          <div style="margin-top:8px" class="row">
            <button id="btnCreateNick" class="btn">Create</button>
            <button id="btnSetRef" class="btn ghost">Set Referral</button>
          </div>

          <label style="margin-top:8px">Referral Nickname</label>
          <input id="inputRefNick" type="text" placeholder="refNickname" />
          <div style="margin-top:8px" class="row">
            <button id="btnClaimRef" class="btn">Claim Rewards</button>
            <div id="refRewards" class="tiny" style="align-self:center">Rewards: -</div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Round & Actions -->
      <div>
        <div class="panel" style="margin-bottom:12px">
          <div class="flex-between">
            <div>
              <div class="section-title">Current Round</div>
              <div id="roundSummary" class="small">No contract loaded.</div>
            </div>
            <div>
              <div class="tiny">Players: <span id="playersCount">-</span></div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Bet ETH</label>
            <input id="inputBetEth" type="number" placeholder="0.01" />
            <div style="margin-top:8px" class="row">
              <button id="btnBetEth" class="btn">Place ETH</button>
              <button id="btnFinalize" class="btn ghost">Finalize</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Bet USDT</label>
            <input id="inputBetToken" type="number" placeholder="10" />
            <div style="margin-top:8px" class="row">
              <button id="btnApprove" class="btn ghost">Approve</button>
              <button id="btnBetToken" class="btn">Place USDT</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="section-title">Players</div>
            <div id="playersList" class="small">-</div>
          </div>
        </div>

        <div class="panel" style="margin-bottom:12px">
          <div class="section-title">Recent Winners</div>
          <div id="winnersFeed" class="winners small">-</div>
        </div>

        <div class="panel">
          <div class="section-title">Console</div>
          <pre id="consoleLog">Ready.</pre>
          <div style="margin-top:8px" class="row">
            <button id="btnClearLog" class="btn ghost">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== minimal ABIs (same as contract) ===== */
const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_erc20Token","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetERC20","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20Token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"erc20Reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalERC20","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getWinnerCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsERC20","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

/* ===== app state ===== */
let provider, signer, userAddress=null, network=null;
let contract=null, tokenContract=null, tokenDecimals=18;
const CHAIN_ID_EXPECTED = 11155111; // Sepolia; change if needed

/* ===== DOM ===== */
const btnConnect = document.getElementById('btnConnect');
const btnDisconnect = document.getElementById('btnDisconnect');
const btnTheme = document.getElementById('btnTheme');
const networkBadge = document.getElementById('networkBadge');
const addrBadge = document.getElementById('addrBadge');
const inputContract = document.getElementById('inputContract');
const inputERC20 = document.getElementById('inputERC20');
const btnLoad = document.getElementById('btnLoad');
const btnRefresh = document.getElementById('btnRefresh');
const balEth = document.getElementById('balEth');
const balToken = document.getElementById('balToken');
const allowInfo = document.getElementById('allowInfo');
const btnBetEth = document.getElementById('btnBetEth');
const btnBetToken = document.getElementById('btnBetToken');
const btnApprove = document.getElementById('btnApprove');
const inputBetEth = document.getElementById('inputBetEth');
const inputBetToken = document.getElementById('inputBetToken');
const btnFinalize = document.getElementById('btnFinalize');
const playersList = document.getElementById('playersList');
const playersCount = document.getElementById('playersCount');
const roundSummary = document.getElementById('roundSummary');
const inputNick = document.getElementById('inputNick');
const btnCreateNick = document.getElementById('btnCreateNick');
const inputRefNick = document.getElementById('inputRefNick');
const btnSetRef = document.getElementById('btnSetRef');
const btnClaimRef = document.getElementById('btnClaimRef');
const refRewards = document.getElementById('refRewards');
const winnersFeed = document.getElementById('winnersFeed');
const consoleLog = document.getElementById('consoleLog');
const btnClearLog = document.getElementById('btnClearLog');

function log(...args){
  console.log(...args);
  const t = (new Date()).toLocaleTimeString();
  consoleLog.textContent += `\n[${t}] ` + args.map(a => (typeof a === 'object' ? JSON.stringify(a) : a)).join(' ');
  consoleLog.scrollTop = consoleLog.scrollHeight;
}
function setAddr(a){ addrBadge.textContent = a ? (a.slice(0,6)+'...'+a.slice(-4)) : 'Not connected'; }
function setNetwork(n,id){ networkBadge.textContent = `Network: ${n} (${id})`; }

/* ===== wallet connect ===== */
async function connectWallet(){
  if(!window.ethereum){ alert('No Ethereum provider (install MetaMask)'); return; }
  try{
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    network = await provider.getNetwork();
    setAddr(userAddress);
    setNetwork(network.name||network.chainId, network.chainId);
    btnConnect.classList.add('hidden'); btnDisconnect.classList.remove('hidden');
    log('Connected', userAddress, 'network', network);
    // auto-load if addresses present
    if(inputContract.value && inputERC20.value) loadContract();
    window.ethereum.on('accountsChanged', handleAccountsChanged);
    window.ethereum.on('chainChanged', handleChainChanged);
    await refreshAll();
  }catch(e){ console.error(e); alert('Connect failed: '+(e.message||e)); }
}
function handleAccountsChanged(accounts){
  if(!accounts || accounts.length===0) { disconnectWallet(); }
  else { userAddress = accounts[0]; setAddr(userAddress); log('Account changed', userAddress); refreshAll(); }
}
function handleChainChanged(hex){ const id = parseInt(hex,16); network = {chainId:id}; setNetwork(network.name||id,id); log('Chain changed',id); refreshAll(); }

function disconnectWallet(){
  signer=null; provider=null; userAddress=null; contract=null; tokenContract=null;
  setAddr(null); networkBadge.textContent='Network: -'; btnConnect.classList.remove('hidden'); btnDisconnect.classList.add('hidden');
  balEth.textContent='-'; balToken.textContent='-'; allowInfo.textContent='Allowance: -';
  log('Disconnected (UI reset)');
  if(window.ethereum && window.ethereum.removeListener){
    try{ window.ethereum.removeListener('accountsChanged', handleAccountsChanged); window.ethereum.removeListener('chainChanged', handleChainChanged); }catch(e){}
  }
}

/* ===== contract load ===== */
function validateAddr(a){ return a && ethers.utils.isAddress(a); }
function simpleError(msg){ alert(msg); log('ERR',msg); }

async function loadContract(){
  const c = inputContract.value.trim(); const t = inputERC20.value.trim();
  if(!validateAddr(c)) return simpleError('Invalid contract address');
  if(!validateAddr(t)) return simpleError('Invalid token address');
  if(!provider){ provider = new ethers.providers.Web3Provider(window.ethereum || window.web3); signer = provider.getSigner ? provider.getSigner() : null; }
  contract = new ethers.Contract(c, CONTRACT_ABI, provider);
  tokenContract = new ethers.Contract(t, ERC20_ABI, provider);
  if(signer){ contract = contract.connect(signer); tokenContract = tokenContract.connect(signer); }
  try{ tokenDecimals = await tokenContract.decimals(); }catch(e){ log('Token decimals read failed, default 18', e); tokenDecimals = 18; }
  log('Loaded contract', c, 'token', t, 'decimals', tokenDecimals);
  await refreshAll();
}

/* ===== refresh ===== */
async function refreshAll(){
  if(!provider || !userAddress) return;
  await updateBalances();
  if(contract){ await updateRoundInfo(); await updateReferralRewards(); await loadWinners(); }
}

async function updateBalances(){
  try{
    const ethBal = await provider.getBalance(userAddress);
    balEth.textContent = parseFloat(ethers.utils.formatEther(ethBal)).toFixed(6) + ' ETH';
    if(tokenContract){
      const tBal = await tokenContract.balanceOf(userAddress);
      const human = ethers.utils.formatUnits(tBal, tokenDecimals);
      balToken.textContent = Number(human).toFixed(6) + ' USDT';
      const caddr = inputContract.value.trim();
      if(validateAddr(caddr)){
        const allowance = await tokenContract.allowance(userAddress, caddr);
        const humanAllow = ethers.utils.formatUnits(allowance, tokenDecimals);
        allowInfo.textContent = 'Allowance: ' + Number(humanAllow).toFixed(6) + ' USDT';
      }
    } else { balToken.textContent = '-'; }
  }catch(e){ log('updateBalances error', e); }
}

/* ===== round info ===== */
async function updateRoundInfo(){
  try{
    const ridBN = await contract.currentRoundId();
    const rid = ridBN.toString();
    const round = await contract.getRoundBasic(rid);
    const players = await contract.getRoundPlayers(rid);
    const start = new Date(round[1].toNumber()*1000);
    const end = new Date(round[2].toNumber()*1000);
    roundSummary.innerHTML = `#${round[0].toString()} • ${round[3] ? '<span style="color:var(--danger)">Finalized</span>' : '<span style="color:var(--accent)">Open</span>'} • ${start.toLocaleTimeString()}→${end.toLocaleTimeString()}<br>Pool: ${ethers.utils.formatEther(round[5])} ETH / ${ethers.utils.formatUnits(round[6], tokenDecimals)} USDT`;
    playersCount.textContent = players.length;
    if(players.length === 0) playersList.textContent = '-';
    else {
      playersList.innerHTML = '';
      for(let p of players){
        const d = await contract.getPlayerDeposits(rid, p);
        const eth = ethers.utils.formatEther(d[0]);
        const erc = ethers.utils.formatUnits(d[1], tokenDecimals);
        const div = document.createElement('div'); div.className='player-item';
        div.innerHTML = `<div>${p.slice(0,6)}...${p.slice(-4)}</div><div class="tiny">${Number(eth).toFixed(6)} ETH / ${Number(erc).toFixed(6)} USDT</div>`;
        playersList.appendChild(div);
      }
    }
    log('Round loaded', rid, 'players', players.length);
  }catch(e){ log('updateRoundInfo failed', e); roundSummary.textContent='Failed to fetch round info.'; }
}

/* ===== bets ===== */
async function placeEthBet(){
  if(!contract || !signer) return simpleError('Connect & load contract first');
  const amt = inputBetEth.value;
  if(!amt || Number(amt) <= 0) return simpleError('Invalid ETH amount');
  const value = ethers.utils.parseEther(String(amt));
  try{
    const tx = await contract.placeBetETH({ value });
    log('placeBetETH tx sent', tx.hash);
    await tx.wait();
    log('ETH bet confirmed', tx.hash);
    await refreshAll();
  }catch(e){ log('placeEthBet error', e); alert('Bet failed: '+(e.message||e)); }
}

async function approveToken(amount){
  if(!tokenContract || !signer) return simpleError('Connect & load token');
  if(!amount || Number(amount) <= 0) return simpleError('Invalid amount');
  const caddr = inputContract.value.trim();
  if(!validateAddr(caddr)) return simpleError('Invalid contract address');
  const amt = ethers.utils.parseUnits(String(amount), tokenDecimals);
  try{
    const tx = await tokenContract.approve(caddr, amt);
    log('Approve tx sent', tx.hash);
    await tx.wait();
    log('Approve confirmed', tx.hash);
    await updateBalances();
  }catch(e){ log('approveToken error', e); alert('Approve failed: '+(e.message||e)); }
}

async function placeTokenBet(){
  if(!contract || !signer) return simpleError('Connect & load contract first');
  const amt = inputBetToken.value;
  if(!amt || Number(amt) <= 0) return simpleError('Invalid token amount');
  const parsed = ethers.utils.parseUnits(String(amt), tokenDecimals);
  try{
    const caddr = inputContract.value.trim();
    const allowance = await tokenContract.allowance(userAddress, caddr);
    if(allowance.lt(parsed)){
      if(!confirm('Allowance low. Approve now?')) return;
      await approveToken(amt);
    }
    const tx = await contract.placeBetERC20(parsed);
    log('placeBetERC20 tx sent', tx.hash);
    await tx.wait();
    log('Token bet confirmed', tx.hash);
    await refreshAll();
  }catch(e){ log('placeTokenBet error', e); alert('Token bet failed: '+(e.message||e)); }
}

/* ===== finalize, referral, nickname ===== */
async function finalizeRound(){
  if(!contract || !signer) return simpleError('Connect & load contract first');
  try{
    const rid = await contract.currentRoundId();
    const tx = await contract.finalizeRound(rid);
    log('finalizeRound tx sent', tx.hash);
    await tx.wait();
    log('Round finalized', tx.hash);
    await refreshAll();
  }catch(e){ log('finalizeRound error', e); alert('Finalize failed: '+(e.message||e)); }
}

async function createNickname(){
  const nick = inputNick.value.trim();
  if(!nick || nick.length<3) return simpleError('Nickname too short');
  try{ const tx = await contract.createNickname(nick); log('createNickname tx sent', tx.hash); await tx.wait(); log('Nickname created', nick); }catch(e){ log('createNickname error', e); alert('Create nickname failed: '+(e.message||e)); }
}

async function setReferral(){
  const r = inputRefNick.value.trim();
  if(!r) return simpleError('Provide referral nickname');
  try{ const tx = await contract.setReferralByNickname(r); log('setReferral tx sent', tx.hash); await tx.wait(); log('Referral set to', r); }catch(e){ log('setReferral error', e); alert('Set referral failed: '+(e.message||e)); }
}

async function updateReferralRewards(){
  try{
    const rewards = await contract.getReferralRewards(userAddress);
    const eth = ethers.utils.formatEther(rewards[0]);
    const erc = ethers.utils.formatUnits(rewards[1], tokenDecimals);
    refRewards.textContent = `ETH: ${Number(eth).toFixed(6)} | USDT: ${Number(erc).toFixed(6)}`;
  }catch(e){ refRewards.textContent='-'; }
}

async function claimReferralRewards(){
  try{ const tx = await contract.claimReferralRewards(); log('claimReferralRewards tx sent', tx.hash); await tx.wait(); log('Referral rewards claimed', tx.hash); await refreshAll(); }catch(e){ log('claimReferralRewards error', e); alert('Claim failed: '+(e.message||e)); }
}

/* ===== winners feed ===== */
async function loadWinners(limit=6){
  try{
    const countBN = await contract.getWinnerCount();
    const total = countBN.toNumber ? countBN.toNumber() : Number(countBN);
    const fetchLimit = Math.min(limit,total);
    if(fetchLimit===0){ winnersFeed.innerHTML='-'; return; }
    const ws = await contract.getWinners(fetchLimit);
    winnersFeed.innerHTML = '';
    for(let w of ws){
      const div = document.createElement('div'); div.className='player-item';
      const ts = new Date((w.timestamp.toNumber ? w.timestamp.toNumber() : Number(w.timestamp))*1000);
      div.innerHTML = `<div>${w.winner.slice(0,6)}...${w.winner.slice(-4)}</div><div class="tiny">#${w.roundId} • ${Number(ethers.utils.formatEther(w.rewardETH)).toFixed(4)} ETH</div>`;
      winnersFeed.appendChild(div);
    }
  }catch(e){ winnersFeed.innerHTML='Failed to load winners'; log('loadWinners err', e); }
}

/* ===== UI wiring ===== */
btnConnect.addEventListener('click', connectWallet);
btnDisconnect.addEventListener('click', disconnectWallet);
btnLoad.addEventListener('click', loadContract);
btnRefresh.addEventListener('click', refreshAll);
btnBetEth.addEventListener('click', placeEthBet);
btnApprove.addEventListener('click', () => approveToken(inputBetToken.value));
btnBetToken.addEventListener('click', placeTokenBet);
btnFinalize.addEventListener('click', finalizeRound);
btnCreateNick.addEventListener('click', createNickname);
btnSetRef.addEventListener('click', setReferral);
btnClaimRef.addEventListener('click', claimReferralRewards);
btnClearLog.addEventListener('click', ()=> consoleLog.textContent = 'Ready.');
btnTheme.addEventListener('click', ()=>{
  document.body.classList.toggle('light');
  // adapt network badge colors
  if(document.body.classList.contains('light')){ document.body.style.background = 'var(--bg-light)'; } else { document.body.style.background = 'var(--bg-dark)'; }
});

/* ===== auto init if metamask connected ===== */
(async function init(){
  if(window.ethereum && window.ethereum.selectedAddress){
    await connectWallet();
  }
})();
</script>
</body>
  </html>
