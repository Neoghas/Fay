<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --red-main: #c0392b; /* [BARU] Warna untuk tombol finalize */
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  body {
    margin: 0;
    height: 100vh;
    background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
    font-family: "Ubuntu", sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
    align: center;
    justify-content: center;
    overflow-y: auto; /* Izinkan scroll jika konten meluap */
    padding: 20px;
    box-sizing: border-box;
  }
  /* === Wallet Button & Info === */
  .wallet-btn {
    position: fixed; top: 20px; right: 25px;
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 14px; font-weight: bold; padding: 10px 20px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main);
    transition: all 0.3s ease; z-index: 1001;
  }
  .wallet-btn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }
  .wallet-info {
    position: fixed; top: 65px; right: 25px;
    background: rgba(20, 20, 40, 0.9);
    border: 2px solid var(--border-color);
    border-radius: 12px; padding: 12px 16px;
    font-size: 13px; line-height: 1.5;
    min-width: 240px; display: none;
    box-shadow: 0 0 20px rgba(180, 0, 255, 0.3); z-index: 1001;
  }
  .wallet-info span { color: var(--cyan-main); font-weight: bold; }

  /* === Wheel Container & SVG (DIUBAH UNTUK CANVAS) === */
  .wheel-container {
    position: relative; width: 320px; height: 320px;
    border-radius: 50%;
    background: radial-gradient(circle at center, #101020 30%, var(--purple-dark) 100%);
    box-shadow: 0 0 40px rgba(98,0,255,0.5), inset 0 0 25px rgba(0,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    /* [DIHAPUS] padding-top: 30px; */
    box-sizing: border-box;
    margin-top: 60px; /* Beri ruang untuk tombol wallet */
  }
  .wheel-pointer {
    position: absolute; width: 0; height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 30px solid var(--blue-main);
    top: -15px; /* Disesuaikan untuk canvas */
    left: 50%;
    transform: translateX(-50%); z-index: 10;
    filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.15));
  }
  #donutCanvas {
    width: 100%;
    height: 100%;
    transform-origin: center center;
  }

  /* === Controls (DIUBAH) === */
  .controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 250px; 
  }
  
  .main-btn {
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    padding: 12px 30px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s ease;
    width: 100%;
  }
  
  #placeBetBtn {
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main);
  }
  #placeBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }

  #finalizeBtn {
    background: linear-gradient(90deg, var(--pink-main), var(--red-main));
    box-shadow: 0 0 20px var(--pink-main);
    display: none; /* Sembunyi by default */
  }
  #finalizeBtn:hover { box-shadow: 0 0 25px var(--red-main); transform: scale(1.05); }
  
  .main-btn:disabled {
    background: #555;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
  }

  .status {
    font-size: 13px;
    margin-top: 8px;
    color: var(--blue-main);
    min-height: 1.2em;
    text-align: center;
    max-width: 320px;
  }
  /* [DIUBAH] ID timerText diubah ke idleCountdown */
  .timer {
      font-size: 16px;
      font-weight: bold;
      color: var(--cyan-main);
      margin-top: 10px;
      height: 20px;
  }

  /* === Bet List === */
  #bet-list-container {
    margin-top: 20px;
    width: 90%;
    max-width: 400px;
    height: 150px;
    background: rgba(10, 10, 20, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  #bet-list-container h3 {
    margin: 0 0 10px 0; font-size: 14px;
    color: var(--blue-main); text-align: center;
    text-transform: uppercase;
  }
  /* Gaya ini akan diterapkan oleh JS */
  .bet-list-item {
    background: rgba(20, 20, 40, 0.7);
    border-radius: 4px; padding: 8px 10px;
    margin-bottom: 6px; font-size: 12px;
    display: flex; justify-content: space-between;
    align-items: center;
  }
  .bet-list-item .player-id { font-weight: bold; color: var(--cyan-main); }
  .bet-list-item .player-bets { text-align: right; color: #eee; }
  #bet-list-placeholder {
    text-align: center; font-size: 13px;
    color: #888; padding-top: 20px;
  }

  /* === MODAL POPUP === */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999; display: none; opacity: 0;
    transition: opacity 0.3s ease;
  }
  .bet-modal {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 380px;
    background: var(--bg-modal);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 0 40px rgba(180, 0, 255, 0.3);
    z-index: 1000; display: none; opacity: 0;
    transition: all 0.3s ease;
  }
  .modal-overlay.show, .bet-modal.show { display: block; opacity: 1; }
  .bet-modal.show { transform: translate(-50%, -50%) scale(1); }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2);
  }
  .modal-header h2 { margin: 0; font-size: 20px; color: var(--blue-main); }
  .modal-close-btn {
    font-size: 28px; font-weight: bold; color: #fff;
    cursor: pointer; line-height: 1; background: none; border: none;
  }
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .balance-display, .min-display { font-size: 13px; color: #999; line-height: 1.5; }
  .balance-display span, .min-display span { font-weight: bold; color: var(--cyan-main); }
  .input-group { display: flex; gap: 10px; }
  .input-group input, .input-group select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    font-size: 16px;
    padding: 10px 12px;
  }
  .input-group input { flex-grow: 1; width: 65%; }
  .input-group select { width: 35%; }
  .percent-buttons { display: flex; justify-content: space-between; gap: 8px; }
  .percent-btn {
    flex: 1; background: rgba(120, 0, 255, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px; color: #fff;
    padding: 8px 10px; font-size: 13px;
    cursor: pointer; transition: background 0.2s ease;
  }
  .percent-btn:hover { background: rgba(120, 0, 255, 0.4); }
  .modal-footer { padding: 20px; border-top: 1px solid rgba(120, 0, 255, 0.2); }
  #confirmBetBtn {
    width: 100%;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: bold; padding: 12px 30px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 20px var(--blue-main);
    transition: all 0.3s ease;
  }
  #confirmBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.02); }
  #confirmBetBtn:disabled {
    background: #555; color: #999;
    box-shadow: none; transform: none; cursor: not-allowed;
  }

  /* [BARU] Gaya untuk Console Log */
  .console-container {
    margin-top: 30px;
    width: 90%;
    max-width: 400px;
    background: rgba(10, 10, 20, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    font-size: 14px;
  }
  .console-container strong { color: var(--blue-main); }
  .console-container .muted { font-size: 12px; color: #888; }
  .console-container pre {
    background: #000;
    border-radius: 4px;
    padding: 10px;
    height: 150px;
    overflow-y: auto;
    font-size: 11px;
    line-height: 1.4;
    color: #ccc;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .console-container .ghost {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--cyan-main);
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
  }
  .console-container .ghost:hover { background: rgba(0, 255, 255, 0.1); }

</style>
</head>

<body>
  <button class="wallet-btn" id="walletBtn">Connect Wallet</button>
  <div class="wallet-info" id="walletInfo">
    <p>Address: <span id="walletAddress">-</span></p>
    <p>Balance (ETH): <span id="ethBalance">0</span></p>
    <p>Balance (USDT): <span id="usdtBalance">0</span></p>
  </div>

  <div class="wheel-container">
    <div class="wheel-pointer"></div>
    <canvas id="donutCanvas" width="320" height="320"></canvas>
  </div>

  <div class="controls">
    <button id="placeBetBtn" class="main-btn" disabled>Place Bet</button>
    <button id="finalizeBtn" class="main-btn" disabled>Finalize Round</button> 
    <div class="status" id="statusText">Wallet not connected</div>
    <div class="timer" id="idleCountdownContainer">
      Auto-spin in: <span id="idleCountdown">30</span>s
    </div>
  </div>
  
  <div id="bet-list-container">
      <h3>Current Round Bets (Donut Legend)</h3>
      <div id="bet-list">
          <p id="bet-list-placeholder">No bets placed yet in this round.</p>
      </div>
  </div>

  <div class="console-container">
    <strong>Raw Console</strong>
    <div class="muted small">Log aktivitas (klik Clear untuk membersihkan)</div>
    <pre id="consoleLog">Ready.</pre>
    <div style="margin-top:8px;">
      <button id="btnClearLog" class="ghost">Clear</button>
    </div>
  </div>


  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="bet-modal" id="bet-modal">
    <div class="modal-header">
      <h2>Place Your Bet</h2>
      <button class="modal-close-btn" id="modal-close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="balance-display">
        <p>Your Balance:<br/>
          <span id="modalEthBalance">0</span> ETH<br/>
          <span id="modalUsdtBalance">0</span> USDT
        </p>
      </div>
      <div class="min-display">
        Mins: <span id="minEth">...</span> ETH / <span id="minUsdt">...</span> USDT
      </div>
      <div class="input-group">
        <input type="number" id="betAmountInput" placeholder="Custom Amount">
        <select id="betCurrencySelect">
          <option value="ETH">ETH</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      <div class="percent-buttons">
        <button class="percent-btn" data-percent="0.10">10%</button>
        <button class="percent-btn" data-percent="0.25">25%</button>
        <button class="percent-btn" data-percent="0.50">50%</button>
        <button class="percent-btn" data-percent="1.0">MAX</button> </div>
    </div>
    <div class="modal-footer">
      <button id="confirmBetBtn">Confirm Bet</button>
    </div>
  </div>

<script>
// =================================================================
// ======= JAVASCRIPT TELAH DIREFAKTOR UNTUK UI BARU =======
// =================================================================

// Harap isi ABI Anda di sini
const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_erc20Token","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetERC20","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20Token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"erc20Reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalERC20","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getWinnerCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsERC20","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

    const CONTRACT_ADDRESS = "0x7CD731477dbD9655A605E1B788F5A064415471D3";  // FaylottoSpinBattle
    const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2";      // USDT ERC20
    const CHAIN_ID_EXPECTED = 84532;
    
    // ======= App State =======
    let provider = null;
    let signer = null;
    let userAddress = null;
    let network = null;
    let contract = null;
    let usdt = null;
    let tokenDecimals = 18; // Akan di-fetch
    let minBetEth = 0n;
    let minBetUsdt = 0n;
    let userEthBalance = 0n;
    let userUsdtBalance = 0n;

    // idle spin timeout (in seconds)
    const IDLE_SECONDS = 30;
    let idleTimer = IDLE_SECONDS;
    let idleInterval = null;
    let lastActivityAt = Date.now();

    // donut data
    let playersArray = []; // { addr, weight: BigInt, eth: BigInt, erc20: BigInt, color, startAngle, endAngle }

    // ======= DOM (Disesuaikan dengan UI baru) =======
    const walletBtn = document.getElementById('walletBtn');
    const walletInfo = document.getElementById('walletInfo');
    const walletAddress = document.getElementById('walletAddress');
    const ethBalance = document.getElementById('ethBalance');
    const usdtBalance = document.getElementById('usdtBalance');

    const placeBetBtn = document.getElementById('placeBetBtn');
    const finalizeBtn = document.getElementById('finalizeBtn');
    const statusText = document.getElementById('statusText');
    const playersListEl = document.getElementById('bet-list'); // Diarahkan ke #bet-list
    const betListPlaceholder = document.getElementById('bet-list-placeholder');

    const consoleLog = document.getElementById('consoleLog');
    const btnClearLog = document.getElementById('btnClearLog');
    const donutCanvas = document.getElementById('donutCanvas');
    const idleCountdownEl = document.getElementById('idleCountdown');

    // Modal DOM
    const modalOverlay = document.getElementById('modal-overlay');
    const betModal = document.getElementById('bet-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalEthBalance = document.getElementById('modalEthBalance');
    const modalUsdtBalance = document.getElementById('modalUsdtBalance');
    const minEthEl = document.getElementById('minEth');
    const minUsdtEl = document.getElementById('minUsdt');
    const betAmountInput = document.getElementById('betAmountInput');
    const betCurrencySelect = document.getElementById('betCurrencySelect');
    const confirmBetBtn = document.getElementById('confirmBetBtn');
    const percentButtons = document.querySelectorAll('.percent-btn');

    // canvas context
    const ctx = donutCanvas.getContext('2d');
    // [DIUBAH] Ukuran canvas disesuaikan dengan container (320x320)
    const cw = donutCanvas.width;
    const ch = donutCanvas.height;
    const cx = cw / 2;
    const cy = ch / 2;
    const outerR = Math.min(cw, ch) * 0.45;
    const innerR = outerR * 0.45;

    // spinning state
    let isSpinning = false;
    let currentRotation = 0; // degrees

    // ======= Helpers =======
    function log(...args) {
      console.log(...args);
      const t = (new Date()).toLocaleTimeString();
      consoleLog.textContent += `\n[${t}] ` + args.map(a => (typeof a === 'object' ? JSON.stringify(a) : a)).join(' ');
      consoleLog.scrollTop = consoleLog.scrollHeight;
    }
    
    // [DIUBAH] Helper untuk update UI wallet
    function updateWalletUI(connected) {
      if (connected) {
        walletBtn.textContent = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
        walletAddress.textContent = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
        walletInfo.style.display = 'block';
        statusText.textContent = 'Ready to bet!';
        placeBetBtn.disabled = false;
        finalizeBtn.disabled = false; // Asumsi admin bisa finalize
      } else {
        walletBtn.textContent = 'Connect Wallet';
        walletAddress.textContent = '-';
        ethBalance.textContent = '0';
        usdtBalance.textContent = '0';
        walletInfo.style.display = 'none';
        statusText.textContent = 'Wallet not connected';
        placeBetBtn.disabled = true;
        finalizeBtn.disabled = true;
      }
    }
    
    function weiToEth(wei) { try { return ethers.utils.formatEther(wei); } catch(e) { return '0'; } }
    function toFixedTrim(numStr, digits=6) { return (+numStr).toFixed(digits).replace(/\.?0+$/, ''); }
    function bnToBigInt(bn) { if (!bn) return 0n; try { return BigInt(bn.toString()); } catch(e){ return 0n; } }

    function playerColor(i) {
      const base = 195;
      const hue = (base + (i * 37)) % 360;
      return `hsl(${hue},72%,58%)`;
    }

    // ======= Wallet connect =======
    walletBtn.addEventListener('click', connectWallet);
    btnClearLog.addEventListener('click', () => { consoleLog.textContent = "Ready."; });

    async function connectWallet() {
      if (!window.ethereum) { 
        alert('No Ethereum provider found. Install MetaMask.'); 
        return; 
      }
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        const net = await provider.getNetwork();
        network = net;

        if (net.chainId !== CHAIN_ID_EXPECTED) {
            alert(`Wrong network. Please switch to Base Sepolia (ID: ${CHAIN_ID_EXPECTED})`);
            log(`Wrong network: ${net.name} (${net.chainId})`);
            return;
        }

        // Inisialisasi kontrak setelah konek wallet
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer); // Pakai signer untuk approve
        try {
          tokenDecimals = await usdt.decimals();
        } catch(e) {
          log('Gagal fetch token decimals, default ke 18', e);
          tokenDecimals = 18;
        }

        updateWalletUI(true);
        log('Connected', userAddress, 'network', net.name);

        window.ethereum.on('accountsChanged', handleAccountsChanged);
        window.ethereum.on('chainChanged', handleChainChanged);

        await refreshAll();
        startIdleTimer(); // Mulai timer setelah konek

      } catch (err) {
        console.error(err);
        log('Wallet connection failed: ' + (err && err.message ? err.message : err));
      }
    }

    async function disconnectWallet() {
      signer = null; userAddress = null; provider = null;
      updateWalletUI(false);
      log('Disconnected (UI reset)');
      try {
        if (window.ethereum && window.ethereum.removeListener) {
          window.ethereum.removeListener('accountsChanged', handleAccountsChanged);
          window.ethereum.removeListener('chainChanged', handleChainChanged);
        }
      } catch(e){}
    }
    
    function handleAccountsChanged(accounts) {
      if (!accounts || accounts.length === 0) disconnectWallet();
      else { userAddress = accounts[0]; log('Account changed'); connectWallet(); } // Re-connect
    }
    function handleChainChanged(chainIdHex) {
      log('Chain changed to', chainIdHex);
      connectWallet(); // Re-connect & check network
    }

    // ======= Fungsionalitas Lama (Dinonaktifkan) =======
    // btnLoad.addEventListener('click', loadContract);
    // btnRefresh.addEventListener('click', refreshAll);
    // async function loadContract() { ... } // Tidak diperlukan, kontrak di-load saat konek

    // ======= Refresh =======
    async function refreshAll() {
      if (!provider || !userAddress || !contract) return;
      await updateBalances();
      await updateRoundInfo();
      await fetchMinBets();
      // await updateReferralRewards().catch(()=>{}); // Fungsionalitas tidak ada di UI
      // await loadWinners().catch(()=>{}); // Fungsionalitas tidak ada di UI
    }

    async function updateBalances() {
      try {
        const ethBal = await provider.getBalance(userAddress);
        userEthBalance = bnToBigInt(ethBal);
        ethBalance.textContent = toFixedTrim(weiToEth(ethBal), 6);
        
        const tBal = await usdt.balanceOf(userAddress);
        userUsdtBalance = bnToBigInt(tBal);
        const human = ethers.utils.formatUnits(tBal, tokenDecimals);
        usdtBalance.textContent = toFixedTrim(human, 6);
          
        // Update modal balances juga
        modalEthBalance.textContent = toFixedTrim(weiToEth(ethBal), 6);
        modalUsdtBalance.textContent = toFixedTrim(human, 6);

      } catch (e) { log('updateBalances error', e); }
    }

    async function fetchMinBets() {
        try {
            minBetEth = bnToBigInt(await contract.MIN_BET_ETH());
            minBetUsdt = bnToBigInt(await contract.MIN_BET_ERC20());
            minEthEl.textContent = toFixedTrim(ethers.utils.formatEther(minBetEth), 6);
            minUsdtEl.textContent = toFixedTrim(ethers.utils.formatUnits(minBetUsdt, tokenDecimals), 2);
        } catch (e) {
            log('Gagal fetch min bets', e);
            minEthEl.textContent = '...';
            minUsdtEl.textContent = '...';
        }
    }

    // ======= Read round + players + bets dan compute weights =======
    async function updateRoundInfo() {
      if (!contract) return;
      try {
        const rid = await contract.currentRoundId();
        const round = await contract.getRoundBasic(rid);
        const players = await contract.getRoundPlayers(rid);
        const start = new Date(Number(round[1].toString()) * 1000);
        
        // [DIUBAH] Tampilkan status di #statusText
        const statusMsg = `Round #${round[0].toString()} | ${round[3] ? '<span style="color:var(--red-main)">Finalized</span>' : '<span style="color:var(--cyan-main)">Open</span>'} | Starts: ${start.toLocaleTimeString()}`;
        statusText.innerHTML = statusMsg;

        playersArray = [];
        let totalWeight = 0n;
        for (let i=0;i<players.length;i++){
          const addr = players[i];
          let weightBn = await contract.getPlayerBet(rid, addr);
          const weightBigInt = bnToBigInt(weightBn);
          totalWeight += weightBigInt;
          playersArray.push({
            addr,
            weight: weightBigInt,
            color: playerColor(i),
            startAngle: 0,
            endAngle: 0
          });
        }

        if (totalWeight === 0n) {
          playersListEl.innerHTML = ''; // Kosongkan
          playersListEl.appendChild(betListPlaceholder); // Tampilkan placeholder
          betListPlaceholder.style.display = 'block';
          drawDonut(); // empty donut
          return;
        }

        betListPlaceholder.style.display = 'none'; // Sembunyikan placeholder
        playersArray.sort((a,b)=> (b.weight > a.weight ? 1 : (b.weight < a.weight ? -1 : 0)));

        let cur = 0n;
        for (let i=0;i<playersArray.length;i++){
          const w = playersArray[i].weight;
          const startAngle = Number((cur * 360n) / totalWeight) * Math.PI/180;
          cur += w;
          const endAngle = Number((cur * 360n) / totalWeight) * Math.PI/180;
          playersArray[i].startAngle = startAngle;
          playersArray[i].endAngle = endAngle;
        }
        
        updatePlayersListUI();
        drawDonut();
      } catch (err) {
        console.error('updateRoundInfo err', err);
        log('updateRoundInfo error', err && err.message ? err.message : err);
      }
    }

    // [DIUBAH] Render UI list agar sesuai CSS baru
    function updatePlayersListUI() {
      playersListEl.innerHTML = '';
      for (const p of playersArray) {
        const el = document.createElement('div');
        el.className = 'bet-list-item';
        
        const short = p.addr.slice(0,6) + '...' + p.addr.slice(-4);
        const weightDisplay = humanizeWeight(p.weight);
        
        const left = document.createElement('div');
        left.className = 'player-id';
        left.innerHTML = `<span style="width:10px;height:10px;border-radius:3px;background:${p.color};display:inline-block;margin-right: 8px;"></span>${short}`;
        
        const right = document.createElement('div');
        right.className = 'player-bets';
        right.textContent = `${weightDisplay} (Weight)`;

        el.appendChild(left);
        el.appendChild(right);
        playersListEl.appendChild(el);
      }
    }

    function humanizeWeight(w) {
      try {
        const asEther = Number(w) / 1e18;
        if (asEther >= 0.000001) return asEther.toFixed(6) + ' ETH-eq';
        return w.toString();
      } catch(e){ return w.toString(); }
    }

    // ======= Draw donut on canvas =======
    function drawDonut(rotationDeg = currentRotation) {
      ctx.clearRect(0,0,cw,ch);
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(rotationDeg * Math.PI / 180);
      ctx.translate(-cx, -cy);

      if (!playersArray || playersArray.length === 0) {
        // draw empty donut
        ctx.beginPath();
        ctx.arc(cx, cy, outerR, 0, Math.PI*2);
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 1;
        ctx.stroke();
        // inner hole
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(cx, cy, innerR, 0, Math.PI*2);
        ctx.fill();
        ctx.globalCompositeOperation = 'source-over';
        ctx.restore();
        // center label
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.font = '14px Ubuntu';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('No bets yet', cx, cy);
        return;
      }

      // draw sectors
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, outerR, p.startAngle, p.endAngle, false);
        ctx.closePath();
        ctx.fillStyle = p.color;
        ctx.fill();
      }

      // inner circle to make donut
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(cx, cy, innerR, 0, Math.PI*2);
      ctx.fill();
      ctx.globalCompositeOperation = 'source-over';

      // draw separators
      ctx.strokeStyle = 'rgba(0,0,0,0.3)';
      ctx.lineWidth = 1.5;
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        ctx.beginPath();
        ctx.moveTo(cx + Math.cos(p.startAngle) * innerR, cy + Math.sin(p.startAngle) * innerR);
        ctx.lineTo(cx + Math.cos(p.startAngle) * outerR, cy + Math.sin(p.startAngle) * outerR);
        ctx.stroke();
      }
      ctx.restore();
    }

    // ======= Weighted random selection (client-side) =======
    function pickWinnerClientSide() {
      if (!playersArray || playersArray.length === 0) return null;
      const total = playersArray.reduce((acc,p)=> acc + p.weight, 0n);
      if (total === 0n) return null;
      const rand = randBigInt(total);
      let cum = 0n;
      for (let i=0;i<playersArray.length;i++){
        cum += playersArray[i].weight;
        if (rand < cum) return playersArray[i];
      }
      return playersArray[playersArray.length-1];
    }

    function randBigInt(max) {
      const bytes = Math.ceil((max.toString(2).length)/8) || 1;
      let rand;
      do {
        const arr = new Uint8Array(bytes);
        window.crypto.getRandomValues(arr);
        rand = 0n;
        for (let i=0;i<arr.length;i++) rand = (rand << 8n) + BigInt(arr[i]);
      } while (rand >= max);
      return rand;
    }

    // ======= Spin animation =======
    function spinToPlayer(targetPlayer) {
      if (!targetPlayer) return;
      if (isSpinning) return;
      isSpinning = true;
      finalizeBtn.disabled = true;
      placeBetBtn.disabled = true;

      const midRad = (targetPlayer.startAngle + targetPlayer.endAngle) / 2;
      const midDeg = (midRad * 180 / Math.PI);
      
      const spins = 5;
      // [DIUBAH] Logika rotasi disesuaikan. Pointer ada di -90deg.
      // Kita ingin (midDeg + currentRotation) berakhir di -90.
      // targetRotation = -midDeg - 90 + 360 * spins
      const targetRotation = 360 * spins - midDeg - 90;
      
      const duration = 4.0; // Durasi spin 4 detik

      gsap.to(donutCanvas, {
        rotation: targetRotation,
        duration: duration,
        ease: "power3.out",
        onUpdate: function() {
            // Update currentRotation untuk drawDonut jika diperlukan
            // Tapi GSAP memutar elemen canvas, bukan menggambar ulang
            // Kita harus memutar *konteks*
        },
        onComplete: () => {
          isSpinning = false;
          finalizeBtn.disabled = false;
          placeBetBtn.disabled = false;
          log('Spin result (client-side):', targetPlayer.addr);
          // Simpan rotasi akhir
          currentRotation = targetRotation % 360;
          // Perbarui data on-chain
          updateRoundInfo().catch(()=>{});
        }
      });

      // [DIUBAH] Gunakan GSAP untuk memutar elemen canvas
      gsap.to(donutCanvas, {
        rotation: `+=${targetRotation - (currentRotation % 360)}`, // Putar ke target absolut
        duration: duration,
        ease: "power3.out",
        onComplete: () => {
          isSpinning = false;
          finalizeBtn.disabled = false;
          placeBetBtn.disabled = false;
          currentRotation = targetRotation; // Simpan rotasi akhir
          log('Spin result (client-side):', targetPlayer.addr);
          // alert(`Visual winner (client-side): ${targetPlayer.addr}`);
          updateRoundInfo().catch(()=>{});
        }
      });
    }

    // ======= Idle timer logic =======
    function resetIdleTimer() {
      lastActivityAt = Date.now();
      idleTimer = IDLE_SECONDS;
      idleCountdownEl.textContent = String(IDLE_SECONDS);
    }
    
    function startIdleTimer() {
      if (idleInterval) clearInterval(idleInterval);
      resetIdleTimer();
      idleInterval = setInterval(async () => {
        const elapsed = Math.floor((Date.now() - lastActivityAt)/1000);
        const left = Math.max(0, IDLE_SECONDS - elapsed);
        idleCountdownEl.textContent = String(left);
        if (left <= 0) {
          clearInterval(idleInterval);
          idleInterval = null;
          idleCountdownEl.textContent = '0';
          if (playersArray.length > 0 && !isSpinning) {
            log('Idle timer expired. Spinning client-side...');
            const pick = pickWinnerClientSide();
            if (pick) spinToPlayer(pick);
          }
          setTimeout(() => { startIdleTimer(); }, 5000); // Restart setelah 5d
        }
      }, 500);
    }

    // ======= Modal Handlers =======
    function showModal() {
        updateBalances(); // Refresh balance saat modal dibuka
        betModal.style.display = 'block';
        modalOverlay.style.display = 'block';
        setTimeout(() => {
            betModal.classList.add('show');
            modalOverlay.classList.add('show');
        }, 10);
    }

    function closeModal() {
        betModal.classList.remove('show');
        modalOverlay.classList.remove('show');
        setTimeout(() => {
            betModal.style.display = 'none';
            modalOverlay.style.display = 'none';
        }, 300);
    }

    placeBetBtn.addEventListener('click', showModal);
    modalCloseBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);

    // Modal: Tombol Persentase
    percentButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const percent = parseFloat(btn.dataset.percent);
            const currency = betCurrencySelect.value;
            let balance = 0n;

            if (currency === 'ETH') {
                balance = userEthBalance;
                const amount = (balance * BigInt(Math.floor(percent * 100))) / 100n;
                betAmountInput.value = ethers.utils.formatEther(amount);
            } else if (currency === 'USDT') {
                balance = userUsdtBalance;
                const amount = (balance * BigInt(Math.floor(percent * 100))) / 100n;
                betAmountInput.value = ethers.utils.formatUnits(amount, tokenDecimals);
            }
        });
    });

    // ======= Place bet handlers: [DIUBAH] Sekarang dari Modal =======
    
    confirmBetBtn.addEventListener('click', async () => {
      try {
        if (!contract || !signer) return simpleError('Connect wallet first.');
        
        const amtStr = betAmountInput.value;
        const currency = betCurrencySelect.value;
        if (!amtStr || Number(amtStr) <= 0) return alert('Enter valid amount');

        confirmBetBtn.disabled = true;
        confirmBetBtn.textContent = 'Processing...';

        if (currency === 'ETH') {
            const value = ethers.utils.parseEther(String(amtStr));
            if (value < minBetEth) {
                throw new Error(`Minimum bet is ${ethers.utils.formatEther(minBetEth)} ETH`);
            }
            const tx = await contract.placeBetETH({ value });
            log('placeBetETH tx sent', tx.hash);
            resetIdleTimer();
            await tx.wait();
            log('placeBetETH confirmed');
        } 
        else if (currency === 'USDT') {
            const value = ethers.utils.parseUnits(String(amtStr), tokenDecimals);
            if (value < minBetUsdt) {
                throw new Error(`Minimum bet is ${ethers.utils.formatUnits(minBetUsdt, tokenDecimals)} USDT`);
            }

            // Cek allowance
            const allowance = await usdt.allowance(userAddress, CONTRACT_ADDRESS);
            if (allowance.lt(value)) {
                log('Allowance too low. Requesting approval...');
                confirmBetBtn.textContent = 'Approving...';
                const approveTx = await usdt.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
                await approveTx.wait();
                log('Approve confirmed. Now placing bet...');
                confirmBetBtn.textContent = 'Placing Bet...';
            }

            const tx = await contract.placeBetERC20(value);
            log('placeBetERC20 tx sent', tx.hash);
            resetIdleTimer();
            await tx.wait();
            log('placeBetERC20 confirmed');
        }

        closeModal();
        await updateBalances();
        await updateRoundInfo();
        const pick = pickWinnerClientSide();
        if (pick) spinToPlayer(pick);

      } catch (err) {
        console.error(err); 
        alert(err.reason || (err.data ? err.data.message : err.message) || 'Bet failed');
      } finally {
        confirmBetBtn.disabled = false;
        confirmBetBtn.textContent = 'Confirm Bet';
      }
    });

    // finalize button (user can call)
    finalizeBtn.addEventListener('click', async () => {
      try {
        if (!contract || !signer) return simpleError('Connect wallet first.');
        finalizeBtn.disabled = true;
        finalizeBtn.textContent = 'Finalizing...';
        
        const rid = await contract.currentRoundId();
        const tx = await contract.finalizeRound(rid);
        log('finalize tx sent', tx.hash);
        await tx.wait();
        log('finalize confirmed');
        await updateRoundInfo();

      } catch (err) { 
        console.error(err); 
        alert(err.reason || (err.data ? err.data.message : err.message) || 'Finalize failed');
      } finally {
        finalizeBtn.disabled = false;
        finalizeBtn.textContent = 'Finalize Round';
      }
    });

    // ======= Fungsionalitas LAMA (Dinonaktifkan karena tidak ada UI) =======
    // btnCreateNick.addEventListener('click', ...);
    // btnSetRef.addEventListener('click', ...);
    // btnClaimRef.addEventListener('click', ...);
    // async function loadWinners() { ... }
    // async function updateReferralRewards() { ... }

    // ======= Auto-refresh dan Inisialisasi =======

    // start initial draw
    drawDonut();

    // small: refresh round setiap 15s
    setInterval(() => {
      if (contract && userAddress && !isSpinning) {
        updateRoundInfo().catch(()=>{});
      }
    }, 15000);

    // refresh balance setiap 30s
    setInterval(() => {
      if (contract && userAddress) {
        updateBalances().catch(()=>{});
      }
    }, 30000);

    // ensure idle timer restarts when user interacts
    document.addEventListener('click', () => { 
        if (idleInterval) resetIdleTimer(); 
    });

</script>

</body>
</html>
