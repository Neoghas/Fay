<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --red-main: #c0392b;
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  body {
    margin: 0;
    height: 100vh;
    background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
    font-family: "Ubuntu", sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .wallet-btn {
    position: fixed; top: 20px; right: 25px;
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 14px; font-weight: bold; padding: 10px 20px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main);
    transition: all 0.3s ease; z-index: 1001;
  }
  .wallet-btn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }
  .wallet-info {
    position: fixed; top: 65px; right: 25px;
    background: rgba(20, 20, 40, 0.9);
    border: 2px solid var(--border-color);
    border-radius: 12px; padding: 12px 16px;
    font-size: 13px; line-height: 1.5;
    min-width: 240px; display: none;
    box-shadow: 0 0 20px rgba(180, 0, 255, 0.3); z-index: 1001;
  }
  .wallet-info span { color: var(--cyan-main); font-weight: bold; }

  .wheel-container {
    position: relative; width: 320px; height: 320px;
    border-radius: 50%;
    background: radial-gradient(circle at center, #101020 30%, var(--purple-dark) 100%);
    box-shadow: 0 0 40px rgba(98,0,255,0.5), inset 0 0 25px rgba(0,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    padding-top: 30px; box-sizing: border-box;
  }
  .wheel-pointer {
    position: absolute; width: 0; height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 30px solid var(--blue-main);
    top: 0px; left: 50%;
    transform: translateX(-50%); z-index: 10;
    filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.15));
  }
  #wheel-svg {
    width: 100%; height: 100%;
    transform-origin: center center;
    overflow: visible;
  }
  .wheel-center {
    fill: var(--bg-dark-1);
    stroke: var(--purple-light);
    stroke-width: 2;
    filter: drop-shadow(0 0 10px var(--purple-light));
  }
  .slice {
    stroke: var(--bg-dark-1); stroke-width: 1.5;
    transition: filter 0.2s ease;
  }
  .slice:hover { filter: brightness(1.2); }

  .controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 250px;
  }

  .main-btn {
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    padding: 12px 30px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s ease;
    width: 100%;
  }

  #placeBetBtn {
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main);
  }
  #placeBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }

  #finalizeBtn {
    background: linear-gradient(90deg, var(--pink-main), var(--red-main));
    box-shadow: 0 0 20px var(--pink-main);
    display: none;
  }
  #finalizeBtn:hover { box-shadow: 0 0 25px var(--red-main); transform: scale(1.05); }

  .main-btn:disabled {
    background: #555;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
  }

  .status {
    font-size: 13px;
    margin-top: 8px;
    color: var(--blue-main);
    min-height: 1.2em;
    text-align: center;
    max-width: 320px;
  }
  .timer {
      font-size: 16px;
      font-weight: bold;
      color: var(--cyan-main);
      margin-top: 10px;
      height: 20px;
  }

  #bet-list-container {
    margin-top: 20px;
    width: 90%;
    max-width: 400px;
    height: 150px;
    background: rgba(10, 10, 20, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  #bet-list-container h3 {
    margin: 0 0 10px 0; font-size: 14px;
    color: var(--blue-main); text-align: center;
    text-transform: uppercase;
  }
  .bet-list-item {
    background: rgba(20, 20, 40, 0.7);
    border-radius: 4px; padding: 8px 10px;
    margin-bottom: 6px; font-size: 12px;
    display: flex; justify-content: space-between;
    align-items: center;
  }
  .bet-list-item .player-id { font-weight: bold; color: var(--cyan-main); }
  .bet-list-item .player-bets { text-align: right; color: #eee; }
  #bet-list-placeholder {
    text-align: center; font-size: 13px;
    color: #888; padding-top: 20px;
  }

  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999; display: none; opacity: 0;
    transition: opacity 0.3s ease;
  }
  .bet-modal {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 380px;
    background: var(--bg-modal);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 0 40px rgba(180, 0, 255, 0.3);
    z-index: 1000; display: none; opacity: 0;
    transition: all 0.3s ease;
  }
  .modal-overlay.show, .bet-modal.show { display: block; opacity: 1; }
  .bet-modal.show { transform: translate(-50%, -50%) scale(1); }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2);
  }
  .modal-header h2 { margin: 0; font-size: 20px; color: var(--blue-main); }
  .modal-close-btn {
    font-size: 28px; font-weight: bold; color: #fff;
    cursor: pointer; line-height: 1; background: none; border: none;
  }
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .balance-display, .min-display { font-size: 13px; color: #999; line-height: 1.5; }
  .balance-display span, .min-display span { font-weight: bold; color: var(--cyan-main); }
  .input-group { display: flex; gap: 10px; }
  .input-group input, .input-group select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    font-size: 16px;
    padding: 10px 12px;
  }
  .input-group input { flex-grow: 1; width: 65%; }
  .input-group select { width: 35%; }
  .percent-buttons { display: flex; justify-content: space-between; gap: 8px; }
  .percent-btn {
    flex: 1; background: rgba(120, 0, 255, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px; color: #fff;
    padding: 8px 10px; font-size: 13px;
    cursor: pointer; transition: background 0.2s ease;
  }
  .percent-btn:hover { background: rgba(120, 0, 255, 0.4); }
  .modal-footer { padding: 20px; border-top: 1px solid rgba(120, 0, 255, 0.2); }
  #confirmBetBtn {
    width: 100%;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: bold; padding: 12px 30px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 20px var(--blue-main);
    transition: all 0.3s ease;
  }
  #confirmBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.02); }
  #confirmBetBtn:disabled {
    background: #555; color: #999;
    box-shadow: none; transform: none; cursor: not-allowed;
  }
</style>
</head>

<body>
  <button class="wallet-btn" id="walletBtn">Connect Wallet</button>

  <div class="wallet-info" id="walletInfo">
    <p>Address: <span id="walletAddress">-</span></p>
    <p>Balance (ETH): <span id="ethBalance">0</span></p>
    <p>Balance (USDT): <span id="usdtBalance">0</span></p>
  </div>

  <div class="wheel-container">
    <div class="wheel-pointer"></div>
    <svg id="wheel-svg" viewBox="0 0 100 100">
        <g transform="rotate(-90, 50, 50)" id="slices-group"></g>
        <circle class="wheel-center" cx="50" cy="50" r="25" />
    </svg>
    <template id="slice-template">
         <path class="slice" stroke-width="1.5">
            <title></title>
         </path>
    </template>
  </div>

  <div class="controls">
    <button id="placeBetBtn" class="main-btn">Place Bet</button>
    <button id="finalizeBtn" class="main-btn">Finalize Round</button>
    <div class="status" id="statusText">Wallet not connected</div>
    <div class="timer" id="timerText"></div>
  </div>
  
  <div id="bet-list-container">
      <h3>Current Round Bets</h3>
      <div id="bet-list">
          <p id="bet-list-placeholder">No bets placed yet in this round.</p>
      </div>
  </div>

  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="bet-modal" id="bet-modal">
    <div class="modal-header">
      <h2>Place Your Bet</h2>
      <button class="modal-close-btn" id="modal-close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="balance-display">
        <p>Your Balance:<br/>
          <span id="modalEthBalance">0</span> ETH<br/>
          <span id="modalUsdtBalance">0</span> USDT
        </p>
      </div>
      <div class="min-display">
        Mins: <span>0.00005 ETH</span> / <span>0.5 USDT</span>
      </div>
      <div class="input-group">
        <input type="number" id="betAmountInput" placeholder="Custom Amount">
        <select id="betCurrencySelect">
          <option value="ETH">ETH</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      <div class="percent-buttons">
        <button class="percent-btn" data-percent="0.10">10%</button>
        <button class="percent-btn" data-percent="0.25">25%</button>
        <button class="percent-btn" data-percent="0.50">50%</button>
        <button class="percent-btn" data-percent="0.57">57%</button>
      </div>
    </div>
    <div class="modal-footer">
      <button id="confirmBetBtn">Confirm Bet</button>
    </div>
  </div>

  <!-- load app.js -->
  <script>
    // app.js - Faylotto Spin Battle frontend logic
// -----------------------------
// 1) PASTE YOUR ABIs INTO CONTRACT_ABI and ERC20_ABI below
// 2) Save this file as app.js and open index.html in browser
// -----------------------------

// ======= ABIs (paste your ABI arrays/strings) =======
const CONTRACT_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
const ERC20_ABI = [{"inputs":[{"internalType":"address","name":"_erc20Token","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetERC20","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20Token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"erc20Reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalERC20","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getWinnerCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsERC20","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];
  
// ======= Config (addresses & chain) =======
const CONTRACT_ADDRESS = "0x7CD731477dbD9655A605E1B788F5A064415471D3";
const USDT_ADDRESS     = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2";
const CHAIN_ID_EXPECTED = 84532; // as you provided

// ======= App State =======
let provider = null;
let signer = null;
let userAddress = null;
let network = null;
let contract = null;
let tokenContract = null;
let tokenDecimals = 18;

// idle spin timeout
const IDLE_SECONDS = 30;
let idleTimer = IDLE_SECONDS;
let idleInterval = null;
let lastActivityAt = Date.now();

// donut data
let playersArray = []; // { addr, weight: BigInt, color, startAngle, endAngle }

// canvas / spin
const donutCanvas = document.getElementById('donutCanvas') || (() => {
  // if canvas missing (older HTML), create fallback canvas inside wheel container
  const c = document.createElement('canvas');
  c.id = 'donutCanvas';
  c.width = 360; c.height = 360;
  document.querySelector('.wheel-container').appendChild(c);
  return c;
})();
const ctx = donutCanvas.getContext('2d');
const cw = donutCanvas.width;
const ch = donutCanvas.height;
const cx = cw/2, cy = ch/2;
const outerR = Math.min(cw,ch) * 0.45;
const innerR = outerR * 0.45;

let isSpinning = false;
let currentRotation = 0; // degrees

// DOM
const walletBtn = document.getElementById('walletBtn');
const walletInfo = document.getElementById('walletInfo');
const walletAddressEl = document.getElementById('walletAddress');
const ethBalanceEl = document.getElementById('ethBalance');
const usdtBalanceEl = document.getElementById('usdtBalance');
const placeBetBtn = document.getElementById('placeBetBtn');
const finalizeBtn = document.getElementById('finalizeBtn');
const statusText = document.getElementById('statusText');
const timerText = document.getElementById('timerText');
const betListEl = document.getElementById('bet-list');
const betListPlaceholder = document.getElementById('bet-list-placeholder');
const modalOverlay = document.getElementById('modal-overlay');
const betModal = document.getElementById('bet-modal');
const modalCloseBtn = document.getElementById('modal-close-btn');
const betAmountInput = document.getElementById('betAmountInput');
const betCurrencySelect = document.getElementById('betCurrencySelect');
const confirmBetBtn = document.getElementById('confirmBetBtn');
const percentButtons = document.querySelectorAll('.percent-btn');
const modalEthBalance = document.getElementById('modalEthBalance');
const modalUsdtBalance = document.getElementById('modalUsdtBalance');
const idleCountdownEl = document.getElementById('idleCountdown') || (() => {
  // create small visible element next to UI if not present
  const el = document.createElement('div');
  el.id = 'idleCountdown';
  el.style.display = 'none';
  document.body.appendChild(el);
  return el;
})();

const inputBetEth = document.getElementById('inputBetEth');
const inputBetToken = document.getElementById('inputBetToken');
const btnApprove = document.getElementById('btnApprove');
const btnBetEth = document.getElementById('btnBetEth');
const btnBetToken = document.getElementById('btnBetToken');

const winnersFeed = document.getElementById('winnersFeed');
const playersListEl = document.getElementById('playersList');
const consoleLog = document.getElementById('consoleLog') || (function(){ const p=document.createElement('pre'); p.id='consoleLog'; document.body.appendChild(p); return p; })();

function log(...args){
  console.log(...args);
  const t = (new Date()).toLocaleTimeString();
  consoleLog.textContent += `\n[${t}] ` + args.map(a => (typeof a === 'object' ? JSON.stringify(a) : a)).join(' ');
  consoleLog.scrollTop = consoleLog.scrollHeight;
}

function setWalletUIConnected(addr){
  walletAddressEl.innerText = addr.slice(0,6) + '...' + addr.slice(-4);
  walletInfo.style.display = 'block';
  walletBtn.innerText = 'Disconnect';
}

function setWalletUIDisconnected(){
  walletAddressEl.innerText = '-';
  ethBalanceEl.innerText = '0';
  usdtBalanceEl.innerText = '0';
  walletInfo.style.display = 'none';
  walletBtn.innerText = 'Connect Wallet';
}

function weiToEth(wei){ try { return ethers.utils.formatEther(wei); } catch(e){ return '0'; } }
function toFixedTrim(numStr, digits=6){ return (+numStr).toFixed(digits).replace(/\.?0+$/,''); }
function bnToBigInt(bn){ if(!bn) return 0n; try { return BigInt(bn.toString()); } catch(e){ return 0n; } }
function playerColor(i){ const base=195; const hue=(base + (i*37)) % 360; return `hsl(${hue},72%,58%)`; }

// ======= Wallet connect / disconnect =======
walletBtn.addEventListener('click', async () => {
  if (!provider) {
    await connectWallet();
  } else {
    // disconnect
    disconnectWallet();
  }
});

async function connectWallet(){
  if (!window.ethereum) { alert('Install MetaMask or compatible wallet'); return; }
  try {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    const net = await provider.getNetwork();
    network = net;

    // instantiate contracts (addresses permanent)
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    tokenContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
    // connect signer for tokenContract to allow approve
    tokenContract = tokenContract.connect(signer);

    setWalletUIConnected(userAddress);
    setNetworkUI(net);
    log('Connected', userAddress, 'network', net);
    await refreshAll();

    // event listeners from provider
    window.ethereum.on('accountsChanged', handleAccountsChanged);
    window.ethereum.on('chainChanged', handleChainChanged);
  } catch(err){
    console.error(err);
    alert('Wallet connect failed: ' + (err && err.message ? err.message : err));
  }
}

function handleAccountsChanged(accounts){
  if (!accounts || accounts.length === 0) { disconnectWallet(); }
  else {
    userAddress = accounts[0];
    setWalletUIConnected(userAddress);
    log('Account changed to', userAddress);
    refreshAll();
  }
}

function handleChainChanged(chainIdHex){
  const id = parseInt(chainIdHex, 16);
  log('chain changed', id);
  if (id !== CHAIN_ID_EXPECTED) {
    statusText.innerText = `Switch to chain ${CHAIN_ID_EXPECTED}`;
  }
  refreshAll();
}

function disconnectWallet(){
  signer=null; provider=null; userAddress=null; contract=null; tokenContract=null;
  setWalletUIDisconnected();
  log('Disconnected (UI reset)');
  try {
    if (window.ethereum && window.ethereum.removeListener) {
      window.ethereum.removeListener('accountsChanged', handleAccountsChanged);
      window.ethereum.removeListener('chainChanged', handleChainChanged);
    }
  } catch(e){}
}

// ======= Refresh & balances =======
async function refreshAll(){
  if (!provider || !userAddress) return;
  await updateBalances();
  if (contract) {
    await updateRoundInfo();
    await loadWinners().catch(()=>{});
    await updateReferralRewards().catch(()=>{});
  }
}

async function updateBalances(){
  try {
    const ethBal = await provider.getBalance(userAddress);
    ethBalanceEl.innerText = toFixedTrim(weiToEth(ethBal),6);
    if (tokenContract) {
      try {
        tokenDecimals = await tokenContract.decimals();
      } catch(e){ tokenDecimals = 18; }
      const tBal = await tokenContract.balanceOf(userAddress);
      usdtBalanceEl.innerText = toFixedTrim(ethers.utils.formatUnits(tBal, tokenDecimals), 6);
      modalEthBalance.innerText = toFixedTrim(weiToEth(ethBal), 6);
      modalUsdtBalance.innerText = toFixedTrim(ethers.utils.formatUnits(tBal, tokenDecimals), 6);
    } else {
      usdtBalanceEl.innerText = '0';
    }
  } catch(e){ console.error('updateBalances', e); }
}

// ======= Round info, players and computing weights =======
async function updateRoundInfo(){
  if (!contract) return;
  try {
    const ridBn = await contract.currentRoundId();
    const rid = ridBn.toString();
    const round = await contract.getRoundBasic(rid);
    // round: id, startTime, endTime, finalized, winner, totalETH, totalERC20, playersCount
    const players = await contract.getRoundPlayers(rid);
    // build playersArray
    playersArray = [];
    let totalWeight = 0n;
    for (let i=0;i<players.length;i++){
      const addr = players[i];
      // fetch deposits
      let deposits;
      try {
        deposits = await contract.getPlayerDeposits(rid, addr);
      } catch(e){
        deposits = { ethAmount: ethers.BigNumber.from('0'), erc20Amount: ethers.BigNumber.from('0') };
      }
      // scale ERC20 to 1e18 like contract did: factor = 10^(18 - tokenDecimals)
      const factor = BigInt(10) ** BigInt(18 - tokenDecimals);
      const ethBn = bnToBigInt(deposits.ethAmount);
      const ercBn = bnToBigInt(deposits.erc20Amount) * factor;
      const weight = ethBn + ercBn;
      totalWeight += weight;
      playersArray.push({
        addr,
        weight,
        color: playerColor(i),
        startAngle: 0,
        endAngle: 0
      });
    }
    if (totalWeight === 0n) {
      playersListEl.innerHTML = '<div class="small-muted">No bets yet this round.</div>';
      betListEl.innerHTML = '<p id="bet-list-placeholder">No bets placed yet in this round.</p>';
      drawDonut();
      return;
    }
    // sort by weight desc for nicer visualization
    playersArray.sort((a,b)=> (a.weight < b.weight ? 1 : (a.weight > b.weight ? -1 : 0)));
    // compute angles (radians)
    let cur = 0n;
    for (let i=0;i<playersArray.length;i++){
      const w = playersArray[i].weight;
      const startDeg = Number((cur * 360n) / totalWeight);
      cur += w;
      const endDeg = Number((cur * 360n) / totalWeight);
      playersArray[i].startAngle = startDeg * Math.PI / 180;
      playersArray[i].endAngle = endDeg * Math.PI / 180;
    }
    // update UI lists
    updatePlayersListUI();
    updateBetListUI();
    drawDonut();
    // set finalize button visible only if there are bets
    if (playersArray.length > 0) finalizeBtn.style.display = 'block';
    else finalizeBtn.style.display = 'none';
    statusText.innerText = `Round ${rid} loaded â€” ${playersArray.length} players`;
  } catch(err){
    console.error('updateRoundInfo', err);
    log('updateRoundInfo error', err && err.message ? err.message : err);
  }
}

function updatePlayersListUI(){
  playersListEl.innerHTML = '';
  for (let i=0;i<playersArray.length;i++){
    const p = playersArray[i];
    const el = document.createElement('div');
    el.className = 'player-item';
    const short = p.addr.slice(0,6) + '...' + p.addr.slice(-4);
    el.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><span style="width:12px;height:12px;border-radius:4px;background:${p.color};display:inline-block"></span>${short}</div><div>${humanizeWeight(p.weight)}</div>`;
    playersListEl.appendChild(el);
  }
}

function updateBetListUI(){
  betListEl.innerHTML = '';
  if (playersArray.length === 0) {
    betListEl.innerHTML = '<p id="bet-list-placeholder">No bets placed yet in this round.</p>';
    return;
  }
  for (let p of playersArray) {
    const item = document.createElement('div');
    item.className = 'bet-list-item';
    const short = p.addr.slice(0,6) + '...' + p.addr.slice(-4);
    const wt = humanizeWeight(p.weight);
    item.innerHTML = `<div class="player-id">${short}</div><div class="player-bets">${wt}</div>`;
    betListEl.appendChild(item);
  }
}

function humanizeWeight(w){
  try {
    const asEther = Number(w) / 1e18;
    if (asEther >= 0.000001) return asEther.toFixed(6) + ' ETH-eq';
    return w.toString();
  } catch(e){ return w.toString(); }
}

// ======= Draw donut =======
function drawDonut(rotationDeg = currentRotation){
  ctx.clearRect(0,0,cw,ch);
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(rotationDeg * Math.PI / 180);
  ctx.translate(-cx,-cy);

  // background ring
  ctx.beginPath();
  ctx.arc(cx, cy, outerR + 6, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(255,255,255,0.01)';
  ctx.fill();

  if (!playersArray || playersArray.length === 0) {
    // empty donut
    ctx.beginPath();
    ctx.arc(cx, cy, outerR, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,255,255,0.02)';
    ctx.fill();
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath(); ctx.arc(cx, cy, innerR, 0, Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation = 'source-over';
    ctx.restore();
    // center text
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    ctx.font = '14px Ubuntu';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('No bets yet', cx, cy);
    return;
  }

  for (let i=0;i<playersArray.length;i++){
    const p = playersArray[i];
    const sa = p.startAngle;
    const ea = p.endAngle;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx, cy, outerR, sa, ea, false);
    ctx.closePath();
    ctx.fillStyle = p.color;
    ctx.fill();
  }

  // inner hole
  ctx.globalCompositeOperation = 'destination-out';
  ctx.beginPath(); ctx.arc(cx, cy, innerR, 0, Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation = 'source-over';

  // separators
  ctx.strokeStyle = 'rgba(0,0,0,0.25)';
  ctx.lineWidth = 1;
  for (let i=0;i<playersArray.length;i++){
    const p = playersArray[i];
    const a = p.startAngle;
    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(a)*(innerR+2), cy + Math.sin(a)*(innerR+2));
    ctx.lineTo(cx + Math.cos(a)*outerR, cy + Math.sin(a)*outerR);
    ctx.stroke();
  }

  // labels
  ctx.fillStyle = '#fff';
  ctx.font = '12px Ubuntu';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  for (let p of playersArray){
    const mid = (p.startAngle + p.endAngle)/2;
    const rlabel = (outerR + innerR)/2;
    const lx = cx + Math.cos(mid)*rlabel;
    const ly = cy + Math.sin(mid)*rlabel;
    const short = p.addr.slice(0,6);
    // pill bg
    const text = short;
    ctx.font = '12px Ubuntu';
    const tw = ctx.measureText(text).width + 8;
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    roundRect(ctx, lx - tw/2, ly - 10/2, tw, 16, 8, 'fill');
    ctx.fillStyle = '#fff';
    ctx.fillText(text, lx, ly);
  }

  ctx.restore();
}

// helper roundRect
function roundRect(ctx,x,y,w,h,r, mode='fill'){
  if (w<2*r) r=w/2; if (h<2*r) r=h/2;
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  if (mode==='fill') ctx.fill(); else ctx.stroke();
}

// ======= Weighted random pick (client-side) =======
function randBigInt(max){
  const bytes = Math.ceil((max.toString(2).length)/8);
  let rand;
  do {
    const arr = new Uint8Array(bytes);
    window.crypto.getRandomValues(arr);
    rand = 0n;
    for (let i=0;i<arr.length;i++) rand = (rand<<8n) + BigInt(arr[i]);
  } while (rand >= max);
  return rand;
}
function pickWinnerClientSide(){
  if (!playersArray || playersArray.length===0) return null;
  const total = playersArray.reduce((acc,p)=> acc + p.weight, 0n);
  if (total === 0n) return null;
  const r = randBigInt(total);
  let cum = 0n;
  for (let i=0;i<playersArray.length;i++){
    cum += playersArray[i].weight;
    if (r < cum) return playersArray[i];
  }
  return playersArray[playersArray.length-1];
}

// ======= Spin animation =======
function spinToPlayer(targetPlayer){
  if (!targetPlayer || isSpinning) return;
  isSpinning = true;
  const midRad = (targetPlayer.startAngle + targetPlayer.endAngle)/2;
  const midDeg = midRad * 180 / Math.PI;
  const spins = 5;
  const targetRotation = -90 - midDeg + spins * 360;
  const start = (currentRotation % 360);
  const end = start + targetRotation;
  const duration = 4000;
  const startTime = performance.now();
  function animate(now){
    const t = Math.min(1, (now - startTime)/duration);
    const eased = 1 - Math.pow(1 - t, 3);
    currentRotation = start + (end - start) * eased;
    drawDonut(currentRotation);
    if (t < 1) requestAnimationFrame(animate);
    else {
      isSpinning = false;
      log('Visual spin finished - winner:', targetPlayer.addr);
      alert(`Visual winner: ${targetPlayer.addr}`);
      // refresh after spin to sync on-chain
      setTimeout(()=> updateRoundInfo().catch(()=>{}), 800);
    }
  }
  requestAnimationFrame(animate);
}

// ======= Idle timer logic =======
function resetIdleTimer(){
  lastActivityAt = Date.now();
  idleTimer = IDLE_SECONDS;
  if (idleCountdownEl) { idleCountdownEl.style.display='inline-block'; idleCountdownEl.textContent = String(IDLE_SECONDS); }
}
function startIdleTimer(){
  if (idleInterval) clearInterval(idleInterval);
  resetIdleTimer();
  idleInterval = setInterval(async ()=>{
    const elapsed = Math.floor((Date.now() - lastActivityAt)/1000);
    const left = Math.max(0, IDLE_SECONDS - elapsed);
    if (idleCountdownEl) idleCountdownEl.textContent = String(left);
    if (left <= 0){
      clearInterval(idleInterval);
      idleInterval = null;
      if (playersArray.length > 0) {
        const pick = pickWinnerClientSide();
        if (pick) spinToPlayer(pick);
      }
      // restart after short delay
      setTimeout(()=> startIdleTimer(), 2000);
    }
  }, 500);
}

// ======= Place bet flows =======
// show modal
placeBetBtn.addEventListener('click', ()=>{
  if (!provider || !signer) return alert('Connect wallet first');
  modalOverlay.classList.add('show');
  betModal.classList.add('show');
  resetIdleTimer();
});

// hide modal
modalCloseBtn.addEventListener('click', hideBetModal);
modalOverlay.addEventListener('click', hideBetModal);
function hideBetModal(){
  modalOverlay.classList.remove('show');
  betModal.classList.remove('show');
}

// percent buttons
percentButtons.forEach(b=>{
  b.addEventListener('click', ()=>{
    const pct = parseFloat(b.dataset.percent);
    if (!provider || !userAddress) return;
    provider.getBalance(userAddress).then(bal => {
      const bn = ethers.BigNumber.from(bal.toString());
      const amt = bn.mul(Math.floor(pct*1000)).div(1000);
      betAmountInput.value = ethers.utils.formatEther(amt);
    }).catch(()=>{});
  });
});

// confirm bet in modal
confirmBetBtn.addEventListener('click', async ()=>{
  const amountStr = betAmountInput.value;
  const currency = betCurrencySelect.value;
  if (!amountStr || Number(amountStr) <= 0) return alert('Enter amount');
  confirmBetBtn.disabled = true;
  confirmBetBtn.innerText = 'Processing...';
  try {
    if (currency === 'ETH') {
      const value = ethers.utils.parseEther(String(amountStr));
      const tx = await contract.placeBetETH({ value });
      log('placeBetETH tx', tx.hash);
      resetIdleTimer();
      await tx.wait();
      log('placeBetETH confirmed');
    } else {
      const val = ethers.utils.parseUnits(String(amountStr), tokenDecimals || 18);
      // ensure allowance
      const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESS);
      if (allowance.lt(val)) {
        const ap = await tokenContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
        log('approve tx', ap.hash);
        await ap.wait();
        log('approve confirmed');
      }
      const tx = await contract.placeBetERC20(val);
      log('placeBetERC20 tx', tx.hash);
      resetIdleTimer();
      await tx.wait();
      log('placeBetERC20 confirmed');
    }
    await updateBalances();
    await updateRoundInfo();
    const pick = pickWinnerClientSide();
    if (pick) spinToPlayer(pick);
    hideBetModal();
  } catch(err){
    console.error(err);
    alert(err && err.message ? err.message : 'Bet failed');
  } finally {
    confirmBetBtn.disabled = false;
    confirmBetBtn.innerText = 'Confirm Bet';
  }
});

// quick approve / place buttons (if you left the other controls present)
if (btnApprove) btnApprove.addEventListener('click', async ()=>{
  if (!tokenContract || !signer) return alert('Connect first');
  try {
    const tx = await tokenContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
    log('approve sent', tx.hash);
    await tx.wait();
    log('approve confirmed');
    await updateBalances();
  } catch(e){ console.error(e); alert('Approve failed'); }
});
if (btnBetEth) btnBetEth.addEventListener('click', async ()=>{
  try {
    if (!contract || !signer) return alert('Connect & load contract first');
    const amt = inputBetEth.value;
    if (!amt || Number(amt) <= 0) return alert('Enter ETH amount');
    const value = ethers.utils.parseEther(String(amt));
    const tx = await contract.placeBetETH({ value });
    log('placeBetETH tx', tx.hash);
    resetIdleTimer();
    await tx.wait();
    log('placeBetETH confirmed');
    await updateBalances(); await updateRoundInfo();
    const pick = pickWinnerClientSide(); if (pick) spinToPlayer(pick);
  } catch(e){ console.error(e); alert('Bet failed'); }
});
if (btnBetToken) btnBetToken.addEventListener('click', async ()=>{
  try {
    if (!contract || !signer) return alert('Connect & load contract first');
    const amt = inputBetToken.value;
    if (!amt || Number(amt) <= 0) return alert('Enter token amount');
    const val = ethers.utils.parseUnits(String(amt), tokenDecimals || 18);
    const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESS);
    if (allowance.lt(val)) {
      const ap = await tokenContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
      await ap.wait();
    }
    const tx = await contract.placeBetERC20(val);
    log('placeBetERC20 tx', tx.hash);
    resetIdleTimer();
    await tx.wait();
    log('placeBetERC20 confirmed');
    await updateBalances(); await updateRoundInfo();
    const pick = pickWinnerClientSide(); if (pick) spinToPlayer(pick);
  } catch(e){ console.error(e); alert('Bet failed'); }
});

// finalize
finalizeBtn.addEventListener('click', async ()=>{
  try {
    if (!contract || !signer) return alert('Connect first');
    const rid = await contract.currentRoundId();
    const tx = await contract.finalizeRound(rid);
    log('finalize tx', tx.hash);
    await tx.wait();
    log('finalize confirmed');
    await updateRoundInfo();
  } catch(e){ console.error(e); alert('Finalize failed'); }
});

// referral placeholder UI functions
async function updateReferralRewards(){
  if (!contract || !userAddress) return;
  try {
    const r = await contract.getReferralRewards(userAddress);
    // expects tuple (ethReward, erc20Reward)
    // find refRewards DOM if exists
    const el = document.getElementById('refRewards');
    if (el) el.textContent = `${ethers.utils.formatEther(r[0])} ETH / ${ethers.utils.formatUnits(r[1], tokenDecimals)} USDT`;
  } catch(e){ console.error(e); }
}

// winners list
async function loadWinners(){
  if (!contract) return;
  try {
    const arr = await contract.getWinners(10);
    winnersFeed.innerHTML = '';
    if (!arr || arr.length === 0) { winnersFeed.textContent = '-'; return; }
    for (let i=0;i<arr.length;i++){
      const w = arr[i];
      const card = document.createElement('div');
      card.className = 'winner-card';
      const short = w.winner.slice(0,6) + '...' + w.winner.slice(-4);
      const ethStr = ethers.utils.formatEther(w.rewardETH || 0);
      card.innerHTML = `<div><strong>${short}</strong><div class="small-muted">Round ${w.roundId.toString()}</div></div><div style="margin-top:6px;">${ethStr} ETH</div>`;
      winnersFeed.appendChild(card);
    }
  } catch(e){ console.error(e); winnersFeed.textContent = '-'; }
}

// small UI helpers
function setNetworkUI(net){
  // show small status if chain mismatch
  if (net && net.chainId && net.chainId !== CHAIN_ID_EXPECTED) {
    statusText.innerText = `Connected to ${net.name || net.chainId} (expected ${CHAIN_ID_EXPECTED})`;
  } else {
    statusText.innerText = `Connected - ${userAddress ? userAddress.slice(0,6)+'...'+userAddress.slice(-4) : ''}`;
  }
}

// init
drawDonut();
startIdleTimer();
setInterval(()=>{ if (contract && userAddress) updateRoundInfo().catch(()=>{}); }, 10000);
document.addEventListener('click', ()=> resetIdleTimer());
log('UI ready');

  </script>
</body>
</html>
