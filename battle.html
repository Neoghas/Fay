<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FaylottoSpinBattle - Frontend Demo (Donut Wheel)</title>
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --accent: #3b82f6;
      --muted: #9aa4b2;
      --glass: rgba(255,255,255,0.03);
      --success: #16a34a;
      --danger: #ef4444;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body { height:100%; margin:0; background: radial-gradient(circle at 10% 10%, #071023 0%, var(--bg) 60%); color:#e6eef6; }
    .container { max-width:1100px; margin:28px auto; padding:20px; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand { display:flex; gap:12px; align-items:center; }
    .logo { width:48px; height:48px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,var(--accent),#6ee7b7); color:#04203a; font-weight:700; }
    h1 { margin:0; font-size:18px; }
    .card { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:16px; box-shadow: 0 6px 22px rgba(2,6,23,0.7); border:1px solid rgba(255,255,255,0.03); }
    .row { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:240px; }
    .muted { color:var(--muted); font-size:13px; }
    button { background:var(--accent); color:#041023; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    button.ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }
    input[type=text], input[type=number] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; box-sizing: border-box; } /* [FIX] box-sizing */
    .small { font-size:13px; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .balances { display:flex; gap:12px; align-items:center; }
    .badge { background:var(--glass); padding:8px 10px; border-radius:10px; font-weight:600; }
    .danger { color:var(--danger); }
    .success { color:var(--success); }
    .players-list { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
    .player-item { background:rgba(255,255,255,0.02); padding:8px; border-radius:8px; display:flex; justify-content:space-between; font-size:13px; }
    .footer { margin-top:18px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:13px; }
    pre { background:#00111a; padding:12px; border-radius:8px; overflow:auto; max-height:220px; }
    .winners { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .winner-card { background:linear-gradient(180deg, rgba(59,130,246,0.06), rgba(255,255,255,0.02)); padding:10px; border-radius:8px; min-width:220px; }
    .inline { display:flex; gap:8px; align-items:center; }
    .small-muted { color:var(--muted); font-size:12px; }
    .donut-wrap { display:flex; gap:16px; align-items:center; justify-content:center; margin-top:12px; flex-wrap:wrap; }
    #donutCanvas { background: radial-gradient(circle at center, rgba(255,255,255,0.02), transparent 40%); border-radius:50%; box-shadow: 0 8px 30px rgba(0,0,0,0.6); }
    .donut-legend { max-width:300px; text-align:left; }
    .legend-item { display:flex; justify-content:space-between; padding:6px 8px; border-radius:8px; margin-bottom:6px; background:rgba(255,255,255,0.01); font-size:13px; }
    .countdown { font-weight:700; color:#fff; background:rgba(255,255,255,0.02); padding:6px 8px; border-radius:8px; display:inline-block; }
    @media (max-width:720px) { .grid-2 { grid-template-columns: 1fr; } .header { flex-direction:column; align-items:flex-start; gap:10px; } .donut-wrap { flex-direction:column; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">FY</div>
        <div>
          <h1>Faylotto Spin Battle — Demo UI</h1>
          <div class="muted small">Connect wallet, place bets (ETH / ERC20), referral & visual donut wheel</div>
        </div>
      </div>

      <div class="card" style="display:flex;align-items:center;gap:12px;">
        <div id="networkBadge" class="badge small-muted">Network: -</div>
        <div id="addrBadge" class="badge small-muted">Not connected</div>
        <button id="btnConnect">Connect Wallet</button>
        <button id="btnDisconnect" class="ghost" style="display:none">Disconnect</button>
      </div>
    </div>

    <div class="row" style="margin-top:18px;">
      <div class="col card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong>Contract Loader</strong>
            <div class="muted small">Isi address kontrak (token sudah di-setting di JS)</div>
          </div>
          <div class="small-muted">Sepolia / testnet</div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label class="small-muted">Contract Address</label>
            <input id="inputContract" type="text" placeholder="0x... (FaylottoSpinBattle contract)" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnLoad">Load Contract</button>
          <button id="btnRefresh" class="ghost">Refresh Balances & Round</button>
        </div>
      </div>


      <div class="col card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong>Wallet Balances</strong>
            <div class="muted small">ETH & USDT (ERC20)</div>
          </div>
          <div class="small-muted">Realtime when connected</div>
        </div>

        <div class="row" style="margin-top:12px;align-items:center;">
          <div class="balances col">
            <div>
              <div class="small-muted">ETH</div>
              <div id="balEth" style="font-weight:700">-</div>
            </div>
            <div>
              <div class="small-muted">USDT</div>
              <div id="balToken" style="font-weight:700">-</div>
            </div>
          </div>

          <div style="min-width:220px;">
            <div class="small-muted">Gas info / allowance</div>
            <div id="allowInfo" class="small-muted">Allowance: -</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:18px;">
      <div class="col card">
        <strong>Current Round</strong>
        <div class="muted small">Informasi dasar round aktif</div>

        <div style="margin-top:12px;">
          <div id="roundSummary" class="small-muted">Tidak ada kontrak dimuat.</div>

          <div class="donut-wrap">
            <canvas id="donutCanvas" width="360" height="360"></canvas>
            <div class="donut-legend">
              <div>Countdown: <span id="idleCountdown" class="countdown">30</span>s</div>
              <div style="margin-top:8px;"><strong>Players</strong></div>
              <div id="playersList" class="players-list small-muted">-</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div class="col">
              <label class="small-muted">Bet ETH (wei auto convert)</label>
              <input id="inputBetEth" type="number" placeholder="ETH amount (e.g., 0.01)" />
              <div style="margin-top:8px;">
                <button id="btnBetEth">Place Bet (ETH)</button>
              </div>
            </div>

            <div class="col">
              <label class="small-muted">Bet ERC20 (USDT) amount</label>
              <input id="inputBetToken" type="number" placeholder="Token amount (e.g., 10)" />
              <div style="margin-top:8px;" class="grid-2">
                <button id="btnApprove">Approve Token</button>
                <button id="btnBetToken">Place Bet (USDT)</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="inline">
              <button id="btnFinalize" class="ghost">Finalize Round (anyone)</button>
              <div class="small-muted" style="margin-left:8px;">(call finalizeRound after round end)</div>
            </div>
          </div>

        </div>
      </div>

      <div class="col card">
        <strong>Referral & Nickname</strong>
        <div class="muted small">Buat nickname, set ref, klaim reward</div>

        <div style="margin-top:12px;" class="grid-2">
          <div>
            <label class="small-muted">Create Nickname</label>
            <input id="inputNick" type="text" placeholder="username (min 3 chars)" />
            <div style="margin-top:8px;">
              <button id="btnCreateNick">Create Nickname</button>
            </div>
          </div>
          <div>
            <label class="small-muted">Set Referral by Nickname</label>
            <input id="inputRefNick" type="text" placeholder="refNickname" />
            <div style="margin-top:8px;">
              <button id="btnSetRef">Set Referral</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <button id="btnClaimRef" class="">Claim Referral Rewards</button>
          <div id="refRewards" class="small-muted" style="margin-top:8px;">Rewards: -</div>
        </div>

        <div style="margin-top:12px;">
          <strong>Recent Winners</strong>
          <div id="winnersFeed" class="winners small-muted">-</div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:18px;">
      <div class="col card">
        <strong>Raw Console</strong>
        <div class="muted small">Log aktivitas (klik Clear untuk membersihkan)</div>
        <pre id="consoleLog">Ready.</pre>
        <div style="margin-top:8px;">
          <button id="btnClearLog" class="ghost">Clear</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Built for Faylotto — demo UI</div>
      <div class="muted small">Pastikan contract & token address diisi. Handle with care on mainnet.</div>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
    // ======= ABI UNTUK KONTRAK 1 (GAME ANDA) =======
    const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_erc20Token","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetERC20","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20Token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"erc20Reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalERC20","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getWinnerCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsERC20","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

    // ======= ABI UNTUK KONTRAK 2 (TOKEN ERC20) =======
    const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
      
    // ======= Alamat Token Ditanam Di Sini =======
    // Ganti alamat ini dengan alamat token ERC20 Anda
    const TOKEN_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2"; // Alamat dari contoh Anda (Base Sepolia)
    
    // ======= App State =======
    let provider, signer;
    let userAddress = null;
    let network = null;
    let contract = null; // Variabel untuk Kontrak 1
    let tokenContract = null; // Variabel untuk Kontrak 2
    let tokenDecimals = 18;
    const CHAIN_ID_EXPECTED = 84532; // Base Sepolia
    
    // idle spin timeout (in seconds)
    const IDLE_SECONDS = 30;
    let idleTimer = IDLE_SECONDS;
    let idleInterval = null;
    let lastActivityAt = Date.now();

    // donut data
    let playersArray = []; 

    // DOM
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const addrBadge = document.getElementById('addrBadge');
    const networkBadge = document.getElementById('networkBadge');
    const btnLoad = document.getElementById('btnLoad');
    const btnRefresh = document.getElementById('btnRefresh');
    const inputContract = document.getElementById('inputContract');
    // inputERC20 dihapus dari DOM
    const balEth = document.getElementById('balEth');
    const balToken = document.getElementById('balToken');
    const allowInfo = document.getElementById('allowInfo');
    const btnBetEth = document.getElementById('btnBetEth');
    const btnBetToken = document.getElementById('btnBetToken');
    const btnApprove = document.getElementById('btnApprove');
    const inputBetEth = document.getElementById('inputBetEth');
    const inputBetToken = document.getElementById('inputBetToken');
    const roundSummary = document.getElementById('roundSummary');
    const playersListEl = document.getElementById('playersList');
    const btnFinalize = document.getElementById('btnFinalize');
    const inputNick = document.getElementById('inputNick');
    const btnCreateNick = document.getElementById('btnCreateNick');
    const inputRefNick = document.getElementById('inputRefNick');
    const btnSetRef = document.getElementById('btnSetRef');
    const btnClaimRef = document.getElementById('btnClaimRef');
    const refRewards = document.getElementById('refRewards');
    const winnersFeed = document.getElementById('winnersFeed');
    const consoleLog = document.getElementById('consoleLog');
    const btnClearLog = document.getElementById('btnClearLog');
    const donutCanvas = document.getElementById('donutCanvas');
    const idleCountdownEl = document.getElementById('idleCountdown');

    // canvas context
    const ctx = donutCanvas.getContext('2d');
    const cw = donutCanvas.width;
    const ch = donutCanvas.height;
    const cx = cw / 2;
    const cy = ch / 2;
    const outerR = Math.min(cw, ch) * 0.45;
    const innerR = outerR * 0.45;

    // spinning state
    let isSpinning = false;
    let currentRotation = 0; // degrees

    // ======= Helpers =======
    function log(...args) {
      console.log(...args);
      const t = (new Date()).toLocaleTimeString();
      consoleLog.textContent += `\n[${t}] ` + args.map(a => (typeof a === 'object' ? JSON.stringify(a) : a)).join(' ');
      consoleLog.scrollTop = consoleLog.scrollHeight;
    }
    function setAddr(addr) { addrBadge.textContent = addr ? (addr.slice(0,6) + '...' + addr.slice(-4)) : 'Not connected'; }
    function setNetwork(name, id) { 
      networkBadge.textContent = `Network: ${name} (${id})`; 
      if (id !== CHAIN_ID_EXPECTED) { 
        networkBadge.style.color = 'var(--danger)'; 
        networkBadge.style.border = '1px solid var(--danger)'; 
      } else {
        networkBadge.style.color = 'inherit';
        networkBadge.style.border = 'none';
      }
    }
    function weiToEth(wei) { try { return ethers.utils.formatEther(wei); } catch(e) { return '0'; } }
    function toFixedTrim(numStr, digits=6) { return (+numStr).toFixed(digits).replace(/\.?0+$/, ''); }
    function bnToBigInt(bn) { if (!bn) return 0n; try { return BigInt(bn.toString()); } catch(e){ return 0n; } }
    function playerColor(i) {
      const base = 195;
      const hue = (base + (i * 37)) % 360;
      return `hsl(${hue},72%,58%)`;
    }

    // ======= Wallet connect =======
    btnConnect.addEventListener('click', connectWallet);
    btnDisconnect.addEventListener('click', disconnectWallet);
    btnLoad.addEventListener('click', loadContract);
    btnRefresh.addEventListener('click', refreshAll);
    btnClearLog.addEventListener('click', () => { consoleLog.textContent = "Ready."; });

    async function connectWallet() {
      if (!window.ethereum) { alert('No Ethereum provider found. Install MetaMask.'); return; }
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        const net = await provider.getNetwork();
        network = net;
        setAddr(userAddress);
        setNetwork(net.name || net.chainId, net.chainId);
        btnConnect.style.display = 'none';
        btnDisconnect.style.display = 'inline-block';
        log('Connected', userAddress, 'network', net);
        
        if (inputContract.value) {
          await loadContract();
        }
        window.ethereum.on('accountsChanged', handleAccountsChanged);
        window.ethereum.on('chainChanged', handleChainChanged);
        await refreshAll();
      } catch (err) {
        console.error(err);
        alert('Wallet connection failed: ' + (err && err.message ? err.message : err));
      }
    }
    async function disconnectWallet() {
      signer = null; userAddress = null; provider = null;
      setAddr(null);
      btnConnect.style.display = 'inline-block';
      btnDisconnect.style.display = 'none';
      balEth.textContent = '-'; balToken.textContent = '-'; allowInfo.textContent = 'Allowance: -';
      log('Disconnected (UI reset)');
      try {
        if (window.ethereum && window.ethereum.removeListener) {
          window.ethereum.removeListener('accountsChanged', handleAccountsChanged);
          window.ethereum.removeListener('chainChanged', handleChainChanged);
        }
      } catch(e){}
    }
    function handleAccountsChanged(accounts) {
      if (!accounts || accounts.length === 0) disconnectWallet();
      else { userAddress = accounts[0]; setAddr(userAddress); refreshAll(); log('Account changed'); }
    }
    function handleChainChanged(chainIdHex) {
      const id = parseInt(chainIdHex, 16);
      network = { chainId: id, name: id === CHAIN_ID_EXPECTED ? 'Base Sepolia' : 'unknown' };
      setNetwork(network.name, id);
      log('Chain changed to', id);
      refreshAll();
    }

    // ======= Contract loading =======
    function validateAddr(a) { return a && ethers.utils.isAddress(a); }
    function simpleError(msg) { alert(msg); log('ERR', msg); }

    async function loadContract() {
      const caddr = inputContract.value.trim();
      const taddr = TOKEN_ADDRESS; // Mengambil dari konstanta
      
      if (!validateAddr(caddr)) { simpleError('Invalid contract address'); return; }
      if (!validateAddr(taddr)) { simpleError('Invalid token address in JS constant (TOKEN_ADDRESS)'); return; } 
      
      if (!provider) {
        provider = new ethers.providers.Web3Provider(window.ethereum || window.web3);
        signer = provider.getSigner ? provider.getSigner() : null;
      }
      
      // === INI KONTRAK 1 (GAME ANDA) ===
      // Menggunakan alamat dari input (caddr) dan CONTRACT_ABI
      contract = new ethers.Contract(caddr, CONTRACT_ABI, provider);
      
      // === INI KONTRAK 2 (TOKEN USDT) ===
      // Menggunakan alamat dari konstanta (taddr) dan ERC20_ABI
      tokenContract = new ethers.Contract(taddr, ERC20_ABI, provider);
      
      if (signer) { 
        // Hubungkan kedua kontrak ke signer agar bisa mengirim transaksi
        contract = contract.connect(signer); 
        tokenContract = tokenContract.connect(signer); 
      }
      
      try { tokenDecimals = await tokenContract.decimals(); } catch(e){ log('Token decimals read failed, default 18', e); tokenDecimals = 18; }
      
      log('Loaded contract 1 (Game):', caddr);
      log('Loaded contract 2 (Token):', taddr, 'decimals', tokenDecimals);
      await refreshAll();
      startIdleTimer(); 
    }

    // ======= Refresh =======
    async function refreshAll() {
      if (!provider || !userAddress) return;
      await updateBalances();
      if (contract) {
        await updateRoundInfo();
        await updateReferralRewards().catch(()=>{});
        await loadWinners().catch(()=>{});
      }
    }

    async function updateBalances() {
      try {
        const ethBal = await provider.getBalance(userAddress);
        balEth.textContent = toFixedTrim(weiToEth(ethBal), 6) + ' ETH';
        
        // Cek saldo dari Kontrak 2 (Token)
        if (tokenContract) { 
          const tBal = await tokenContract.balanceOf(userAddress);
          const human = ethers.utils.formatUnits(tBal, tokenDecimals);
          balToken.textContent = toFixedTrim(human, 6) + ' USDT';
          
          // Cek allowance dari Kontrak 2 (Token) ke Kontrak 1 (Game)
          const caddr = inputContract.value.trim();
          if (validateAddr(caddr)) {
            const allowance = await tokenContract.allowance(userAddress, caddr);
            const humanAllow = ethers.utils.formatUnits(allowance, tokenDecimals);
            allowInfo.textContent = 'Allowance: ' + toFixedTrim(humanAllow,6) + ' USDT';
          }
        } else balToken.textContent = '-';
      } catch (e) { log('updateBalances error', e); }
    }

    // ======= Read round + players + bets and compute weights =======
    async function updateRoundInfo() {
      if (!contract) return; // Butuh Kontrak 1
      try {
        const rid = await contract.currentRoundId();
        const round = await contract.getRoundBasic(rid);
        const players = await contract.getRoundPlayers(rid);
        const start = new Date(Number(round[1].toString()) * 1000);
        const end = new Date(Number(round[2].toString()) * 1000);
        roundSummary.innerHTML = `
          <div class="small-muted">Round #${round[0].toString()} | ${round[3] ? '<span class="danger">Finalized</span>' : '<span class="success">Open</span>'}</div>
          <div class="small-muted">Start: ${start.toLocaleTimeString()} | End: ${end.toLocaleTimeString()}</div>
        `;
        // fetch bets and build playersArray
        playersArray = [];
        let totalWeight = 0n;
        for (let i=0;i<players.length;i++){
          const addr = players[i];
          let weightBn = null;
          try {
            weightBn = await contract.getPlayerBet(rid, addr);
          } catch(e) {
            try {
              const deposits = await contract.getPlayerDeposits(rid, addr);
              const ethBn = deposits.ethAmount;
              const ercBn = deposits.erc20Amount;
              const factor = BigInt(10) ** BigInt(18 - (tokenDecimals || 18));
              weightBn = ethBn.add(ercBn.mul(ethers.BigNumber.from(factor.toString())));
            } catch(err2){
              weightBn = ethers.BigNumber.from("0");
            }
          }
          const weightBigInt = bnToBigInt(weightBn);
          totalWeight += weightBigInt;
          playersArray.push({
            addr,
            eth: null,
            erc20: null,
            weight: weightBigInt,
            color: playerColor(i),
            startAngle: 0,
            endAngle: 0
          });
        }
        // compute angles
        if (totalWeight === 0n) {
          playersListEl.innerHTML = '<div class="small-muted">No bets yet this round.</div>';
          drawDonut(); // empty donut
          return;
        }
        playersArray.sort((a,b)=> (b.weight > a.weight ? 1 : (b.weight < a.weight ? -1 : 0)));
        let cur = 0n;
        for (let i=0;i<playersArray.length;i++){
          const w = playersArray[i].weight;
          const startAngle = Number((cur * 360n) / totalWeight) * Math.PI/180;
          cur += w;
          const endAngle = Number((cur * 360n) / totalWeight) * Math.PI/180;
          playersArray[i].startAngle = startAngle;
          playersArray[i].endAngle = endAngle;
        }
        updatePlayersListUI();
        drawDonut();
      } catch (err) {
        console.error('updateRoundInfo err', err);
        log('updateRoundInfo error', err && err.message ? err.message : err);
      }
    }

    function updatePlayersListUI() {
      playersListEl.innerHTML = '';
      for (const p of playersArray) {
        const el = document.createElement('div');
        el.className = 'player-item';
        const short = p.addr.slice(0,6) + '...' + p.addr.slice(-4);
        const weightDisplay = humanizeWeight(p.weight);
        el.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><span style="width:12px;height:12px;border-radius:4px;background:${p.color};display:inline-block"></span>${short}</div><div>${weightDisplay}</div>`;
        playersListEl.appendChild(el);
      }
    }

    function humanizeWeight(w) {
      try {
        const asEther = Number(w) / 1e18;
        if (asEther >= 0.000001) return asEther.toFixed(6) + ' ETH-eq';
        return w.toString();
      } catch(e){ return w.toString(); }
    }

    // ======= Draw donut on canvas =======
    function drawDonut(rotationDeg = currentRotation) {
      ctx.clearRect(0,0,cw,ch);
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(rotationDeg * Math.PI / 180);
      ctx.translate(-cx, -cy);

      ctx.beginPath();
      ctx.arc(cx, cy, outerR + 6, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.01)';
      ctx.fill();

      if (!playersArray || playersArray.length === 0) {
        ctx.beginPath();
        ctx.arc(cx, cy, outerR, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(255,255,255,0.02)';
        ctx.fill();
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(cx, cy, innerR, 0, Math.PI*2);
        ctx.fill();
        ctx.globalCompositeOperation = 'source-over';
        ctx.restore();
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.font = '14px Inter';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('No bets yet', cx, cy);
        return;
      }

      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        const sa = p.startAngle;
        const ea = p.endAngle;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, outerR, sa, ea, false);
        ctx.closePath();
        ctx.fillStyle = p.color;
        ctx.fill();
      }

      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(cx, cy, innerR, 0, Math.PI*2);
      ctx.fill();
      ctx.globalCompositeOperation = 'source-over';

      ctx.strokeStyle = 'rgba(0,0,0,0.25)';
      ctx.lineWidth = 1;
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        ctx.beginPath();
        ctx.moveTo(cx + Math.cos(p.startAngle) * (innerR+2), cy + Math.sin(p.startAngle) * (innerR+2));
        ctx.lineTo(cx + Math.cos(p.startAngle) * outerR, cy + Math.sin(p.startAngle) * outerR);
        ctx.stroke();
      }

      ctx.fillStyle = '#fff';
      ctx.font = '12px Inter';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        const mid = (p.startAngle + p.endAngle) / 2;
        const rlabel = (outerR + innerR) / 2;
        const lx = cx + Math.cos(mid) * rlabel;
        const ly = cy + Math.sin(mid) * rlabel;
        const short = p.addr.slice(0,6);
        ctx.fillStyle = 'rgba(0,12,20,0.85)';
        ctx.beginPath();
        ctx.fillStyle = 'rgba(255,255,255,0.85)';
        ctx.roundRect = ctx.roundRect || function(x,y,w,h,r){ if (w<2*r) r=w/2; if (h<2*r) r=h/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill(); };
        const text = short;
        ctx.font = '12px Inter';
        const tw = ctx.measureText(text).width + 8;
        ctx.fillStyle = 'rgba(0,0,0,0.45)';
        ctx.roundRect(lx - tw/2, ly - 12/2, tw, 16, 8);
        ctx.fillStyle = '#fff';
        ctx.fillText(text, lx, ly);
      }

      ctx.restore();
    }

    if (!CanvasRenderingContext2D.prototype.roundRect) {
      CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
        if (w<2*r) r=w/2; if (h<2*r) r=h/2;
        this.beginPath();
        this.moveTo(x+r,y);
        this.arcTo(x+w,y,x+w,y+h,r);
        this.arcTo(x+w,y+h,x,y+h,r);
        this.arcTo(x,y+h,x,y,r);
        this.arcTo(x,y,x+w,y,r);
        this.closePath();
        this.fill();
      };
    }

    // ======= Weighted random selection (client-side) =======
    function pickWinnerClientSide() {
      if (!playersArray || playersArray.length === 0) return null;
      const total = playersArray.reduce((acc,p)=> acc + p.weight, 0n);
      if (total === 0n) return null;
      const rand = randBigInt(total);
      let cum = 0n;
      for (let i=0;i<playersArray.length;i++){
        cum += playersArray[i].weight;
        if (rand < cum) return playersArray[i];
      }
      return playersArray[playersArray.length-1];
    }

    function randBigInt(max) {
      const bytes = Math.ceil((max.toString(2).length)/8);
      let rand;
      do {
        const arr = new Uint8Array(bytes);
        window.crypto.getRandomValues(arr);
        rand = 0n;
        for (let i=0;i<arr.length;i++) rand = (rand << 8n) + BigInt(arr[i]);
      } while (rand >= max);
      return rand;
    }

    // ======= Spin animation =======
    function spinToPlayer(targetPlayer) {
      if (!targetPlayer) return;
      if (isSpinning) return;
      isSpinning = true;
      const midRad = (targetPlayer.startAngle + targetPlayer.endAngle) / 2;
      const midDeg = midRad * 180 / Math.PI;
      const spins = 5; 
      const targetRotation = -90 - midDeg + spins * 360;
      const start = currentRotation % 360;
      const end = start + targetRotation;
      const duration = 4000; 
      const startTime = performance.now();

      function animate(now) {
        const t = Math.min(1, (now - startTime) / duration);
        const eased = 1 - Math.pow(1 - t, 3);
        currentRotation = start + (end - start) * eased;
        drawDonut(currentRotation);
        if (t < 1) {
          requestAnimationFrame(animate);
        } else {
          isSpinning = false;
          log('Spin result (client-side):', targetPlayer.addr);
          alert(`Visual winner (client-side): ${targetPlayer.addr}`);
          updateRoundInfo().catch(()=>{});
        }
      }
      requestAnimationFrame(animate);
    }

    // ======= Idle timer logic =======
    function resetIdleTimer() {
      lastActivityAt = Date.now();
      idleTimer = IDLE_SECONDS;
      idleCountdownEl.textContent = String(IDLE_SECONDS);
    }
    function startIdleTimer() {
      if (idleInterval) clearInterval(idleInterval);
      resetIdleTimer();
      idleInterval = setInterval(async () => {
        const elapsed = Math.floor((Date.now() - lastActivityAt)/1000);
        const left = Math.max(0, IDLE_SECONDS - elapsed);
        idleCountdownEl.textContent = String(left);
        if (left <= 0) {
          clearInterval(idleInterval);
          idleInterval = null;
          idleCountdownEl.textContent = '0';
          if (playersArray.length > 0) {
            const pick = pickWinnerClientSide();
            if (pick) spinToPlayer(pick);
          }
          setTimeout(() => { startIdleTimer(); }, 2000);
        }
      }, 500);
    }

    // ======= Place bet handlers: call contract, then refresh + spin visual =======
    document.getElementById('btnBetEth').addEventListener('click', async () => {
      try {
        if (!contract || !signer) return simpleError('Connect wallet and load contract first.');
        const amt = inputBetEth.value;
        if (!amt || Number(amt) <= 0) return alert('Enter ETH amount');
        const value = ethers.utils.parseEther(String(amt));
        
        // Memanggil fungsi di Kontrak 1
        const tx = await contract.placeBetETH({ value }); 
        log('placeBetETH tx sent', tx.hash);
        resetIdleTimer();
        await tx.wait();
        log('placeBetETH confirmed');
        await updateBalances();
        await updateRoundInfo();
        const pick = pickWinnerClientSide();
        if (pick) spinToPlayer(pick);
      } catch (err) {
        console.error(err); alert(err && err.message ? err.message : 'Bet failed');
      }
    });

    document.getElementById('btnApprove').addEventListener('click', async () => {
      try {
        if (!tokenContract || !signer) return simpleError('Connect wallet & load token first.');
        const caddr = inputContract.value.trim();
        const max = ethers.constants.MaxUint256;
        
        // Memanggil fungsi 'approve' di Kontrak 2 (Token)
        // Memberi izin Kontrak 1 (caddr) untuk mengambil token
        const tx = await tokenContract.approve(caddr, max); 
        log('approve sent', tx.hash);
        await tx.wait();
        log('approve confirmed');
        await updateBalances();
      } catch(e){ console.error(e); alert('Approve failed'); }
    });

    document.getElementById('btnBetToken').addEventListener('click', async () => {
      try {
        if (!contract || !signer) return simpleError('Connect wallet and load contract first.');
        const amt = inputBetToken.value;
        if (!amt || Number(amt) <= 0) return alert('Enter token amount');
        const decimals = tokenDecimals || 18;
        const value = ethers.utils.parseUnits(String(amt), decimals);
        
        // Memanggil fungsi di Kontrak 1
        const tx = await contract.placeBetERC20(value); 
        log('placeBetERC20 tx sent', tx.hash);
        resetIdleTimer();
        await tx.wait();
        log('placeBetERC20 confirmed');
        await updateBalances();
        await updateRoundInfo();
        const pick = pickWinnerClientSide();
        if (pick) spinToPlayer(pick);
      } catch (err) {
        console.error(err); alert(err && err.message ? err.message : 'Bet failed');
      }
    });

    // finalize button (user can call)
    btnFinalize.addEventListener('click', async () => {
      try {
        if (!contract || !signer) return simpleError('Connect wallet & load contract first.');
        const rid = await contract.currentRoundId();
        
        // Memanggil fungsi di Kontrak 1
        const tx = await contract.finalizeRound(rid); 
        log('finalize tx sent', tx.hash);
        await tx.wait();
        log('finalize confirmed');
        await updateRoundInfo();
      } catch (err) { console.error(err); alert(err && err.message ? err.message : 'Finalize failed'); }
    });

    // referral related buttons (basic calls)
    btnCreateNick.addEventListener('click', async () => {
      try {
        const nick = inputNick.value;
        if (!nick || nick.length < 3) return alert('Nickname min 3 chars');
        const tx = await contract.createNickname(nick); // Kontrak 1
        await tx.wait();
        alert('Nickname created');
      } catch(e){ console.error(e); alert('createNickname failed'); }
    });
    btnSetRef.addEventListener('click', async () => {
      try {
        const rn = inputRefNick.value;
        if (!rn) return alert('Enter ref nickname');
        const tx = await contract.setReferralByNickname(rn); // Kontrak 1
        await tx.wait();
        alert('Referrer set');
      } catch(e){ console.error(e); alert('setReferralByNickname failed'); }
    });
    btnClaimRef.addEventListener('click', async () => {
      try {
        const tx = await contract.claimReferralRewards(); // Kontrak 1
        await tx.wait();
        alert('Rewards claimed');
        await updateBalances();
        updateReferralRewards();
      } catch(e){ console.error(e); alert('claimReferralRewards failed'); }
    });

    // load winners (simple)
    async function loadWinners() {
      try {
        if (!contract) return;
        const arr = await contract.getWinners(10); // Kontrak 1
        winnersFeed.innerHTML = '';
        if (!arr || arr.length === 0) { winnersFeed.textContent = '-'; return; }
        for (let i=0;i<arr.length;i++){
          const w = arr[i];
          const card = document.createElement('div');
          card.className = 'winner-card';
          const short = w.winner.slice(0,6) + '...' + w.winner.slice(-4);
          card.innerHTML = `<div><strong>${short}</strong><div class="small-muted">Round ${w.roundId.toString()}</div></div><div style="margin-top:6px;">${ethers.utils.formatEther(w.rewardETH)} ETH</div>`;
          winnersFeed.appendChild(card);
        }
      } catch(e){ console.error(e); winnersFeed.textContent = '-'; }
    }

    async function updateReferralRewards() {
      try {
        if (!contract || !userAddress) return;
        const r = await contract.getReferralRewards(userAddress); // Kontrak 1
        refRewards.textContent = `Rewards: ${ethers.utils.formatEther(r[0])} ETH / ${ethers.utils.formatUnits(r[1], tokenDecimals)} USDT`;
      } catch(e){ 
        console.error(e); 
        refRewards.textContent = 'Rewards: (Gagal load)';
      }
    }

    // start idle timer when page loaded if contract present
    function ensureIdle() {
      if (!idleInterval) startIdleTimer();
    }

    // start initial draw
    drawDonut();

    // small: refresh round every 10s to update live bets
    setInterval(() => {
      if (contract && userAddress) updateRoundInfo().catch(()=>{});
    }, 10000);

    // ensure idle timer restarts when user interacts
    document.addEventListener('click', () => { 
      if (idleInterval) resetIdleTimer(); 
    });

  </script>
</body>
</html>
