<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto Ultimate - Social Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
<style>
    /* --- CSS UTAMA & SOCIAL --- */
    * { box-sizing: border-box; }
    :root {
        --primary: #0052ff; --accent: #00d1ff; --bg: #0f111a;
        --panel: #1e2130; --text: #ffffff; --danger: #ff4b4b; --success: #00d26a;
        --shib-color: #FFA409; --usdt-color: #26A17B; --eth-color: #627EEA;
        --gold: #FFD700; --gradient-bg: linear-gradient(135deg, #0f111a, #1e2130);
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--gradient-bg); color: var(--text); margin: 0;
        display: flex; flex-direction: column; align-items: center;
        min-height: 100vh; padding-bottom: 80px; overflow-x: hidden;
    }
    header {
        width: 100%; padding: 15px 20px; display: flex; justify-content: space-between;
        align-items: center; background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--panel);
        position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .wallet-btn {
        background: var(--primary); color: white; border: none; padding: 8px 16px;
        border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.3s;
        box-shadow: 0 0 10px rgba(0, 82, 255, 0.5);
    }
    .wallet-btn.connected { background: var(--success); border: 1px solid #fff; cursor: default; }
    .layout-container { width: 94%; max-width: 480px; display: flex; flex-direction: column; align-items: center; margin: 0 auto; }

    /* SLOT MACHINE */
    .slot-machine {
        margin-top: 30px; background: var(--panel); padding: 20px;
        border-radius: 15px; border: 4px solid #333;
        box-shadow: 0 0 30px rgba(0, 82, 255, 0.4);
        width: 100%; display: flex; flex-direction: column; align-items: center;
    }
    .reels-container { display: flex; gap: 8px; background: #000; padding: 10px; border-radius: 8px; justify-content: center; margin-bottom: 15px; width: 100%; box-shadow: inset 0 0 10px rgba(255,255,255,0.1); }
    .reel { flex: 1; height: 90px; background: #fff; border-radius: 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    .reel-img { width: 80%; height: 80%; object-fit: contain; transition: transform 0.1s; }

    .draw-section { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .btn-draw {
        background: linear-gradient(45deg, #333, #555); color: #888; border: 2px solid #444;
        padding: 12px 0; width: 70%; border-radius: 30px;
        font-size: 0.9em; font-weight: 800; cursor: not-allowed; transition: 0.3s;
    }
    .btn-draw.ready {
        background: linear-gradient(45deg, #ff0000, #ff8800); color: white; border: 2px solid #ffaa00;
        cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); } 50% { box-shadow: 0 0 25px rgba(255, 100, 0, 0.8); } 100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); } }
    .status-text { font-size: 0.8em; color: var(--accent); font-weight: bold; text-align: center; }

    /* BETTING CARDS */
    .betting-section { margin-top: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; }
    .bet-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-top: 15px; }
    .bet-card {
        background: var(--panel); border: 3px solid #333; border-radius: 12px; padding: 10px; cursor: pointer; transition: 0.2s;
        display: flex; flex-direction: column; align-items: center; justify-content: center; aspect-ratio: 1/1.2; position: relative;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .bet-card:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(0, 82, 255, 0.5); }
    .bet-card.my-bet { border-color: var(--primary); background: rgba(0, 82, 255, 0.2); box-shadow: 0 0 20px rgba(0, 82, 255, 0.6); }
    .bet-card.open { border-color: var(--success); animation: pulseGreen 2s infinite; }
    @keyframes pulseGreen { 0% { border-color: #00d26a; } 50% { border-color: #00ff80; } 100% { border-color: #00d26a; } }
    .bet-card.selected { transform: scale(0.95); background: rgba(255, 255, 255, 0.15); box-shadow: 0 0 15px var(--accent); }
    .bet-icon-img { width: 50%; height: 50%; object-fit: contain; margin-bottom: 5px; }
    .name { font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px;}
    .team-count { font-size: 9px; color: #aaa; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-top: 2px; }
    .team-count.filled { color: var(--success); border: 1px solid var(--success); }

    /* DASHBOARD & MODALS */
    .pool-dashboard { width: 100%; display: flex; justify-content: space-between; gap: 5px; margin-top: 20px; margin-bottom: 10px; }
    .pool-box { flex: 1; background: #151925; border: 1px solid #333; border-radius: 8px; padding: 8px 5px; text-align: center; display: flex; flex-direction: column; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .pool-title { font-size: 0.6em; color: #aaa; text-transform: uppercase; margin-bottom: 3px; }
    .pool-value { font-size: 0.8em; font-weight: bold; }
    .text-eth { color: var(--eth-color); } .text-usdt { color: var(--usdt-color); } .text-shib { color: var(--shib-color); }
    .card-stats-container { width: 100%; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; font-size: 0.6em; font-weight: bold; }
    .c-stat { display: flex; align-items: center; gap: 2px; }
    .main-bet-btn { margin-top: 15px; background: var(--primary); color: white; border: 3px solid #0027b3; padding: 13px 0; width: 70%; border-radius: 50px; font-size: 0.9em; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 0 15px var(--primary); }
    .main-bet-btn:hover { background: var(--accent); transform: translateY(-2px); box-shadow: 0 0 25px var(--accent); }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); overflow-y: auto; }
    .modal-content { background: var(--panel); width: 90%; max-width: 380px; padding: 25px; border-radius: 15px; text-align: center; border: 1px solid var(--accent); box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative; margin-top: 50px; margin-bottom: 50px;}
    .modal-title { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; }
    .pay-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .pay-btn { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 13px; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
    .btn-eth { background: var(--eth-color); } .btn-usdt { background: var(--usdt-color); } .btn-shib { background: var(--shib-color); }
    .close-modal { background: none; border: none; color: #aaa; font-size: 1.5em; position: absolute; top: 10px; right: 15px; cursor: pointer; }
    .dash-profile { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
    .dash-balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; text-align: left; }
    .dash-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; }
    .dash-label { font-size: 0.65em; color: #aaa; display: block; }
    .dash-val { font-size: 0.85em; font-weight: bold; }
    .btn-disconnect { background: var(--danger); width: 100%; padding: 10px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
    .referral-panel { margin-top: 20px; width: 100%; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid #333; text-align: center; display: none; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
    .ref-box { background: #000; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; margin-top: 5px; font-size: 0.8em; color: #888; }
    .btn-copy { background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
    .withdraw-section { margin-top:15px; padding-top:10px; border-top:1px dashed #444; text-align:left; }
    .withdraw-title { font-size:0.8em; color:#aaa; margin-bottom:5px; }
    .btn-withdraw-small { background: var(--success); color:black; border:none; padding:4px 8px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.8em; float:right; }
    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 999; bottom: 30px; left: 50%; transform: translateX(-50%); }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    /* --- WINNER & HISTORY --- */
    .winner-glamour { border-color: var(--gold) !important; background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.3)) !important; animation: glamourPulse 0.8s infinite alternate !important; z-index: 10; transform-origin: center; }
    @keyframes glamourPulse { 0% { box-shadow: 0 0 15px var(--gold), inset 0 0 5px var(--gold); transform: scale(1); border-color: var(--gold); } 100% { box-shadow: 0 0 30px var(--gold), 0 0 45px #FF4500, inset 0 0 20px var(--gold); transform: scale(1.1); border-color: #FFF; } }
    .winner-glamour::before { content: "üèÜ WINNER"; position: absolute; top: -15px; background: linear-gradient(45deg, var(--gold), #FFA500); color: #000; font-weight: bold; font-size: 0.7em; padding: 3px 10px; border-radius: 10px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); animation: bounce 0.8s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .history-section { margin-top: 30px; width: 100%; }
    .history-card { background: var(--panel); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.3); position: relative; }
    .history-reels { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
    .history-reel-img { width: 40px; height: 40px; object-fit: contain; }
    .history-outcome { font-weight: bold; color: var(--accent); }
    .history-tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
    .tab-btn { flex: 1; padding: 10px; background: #151925; border: 1px solid #333; color: #888; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: 0.3s; }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 82, 255, 0.4); }
    .btn-load-more { width: 100%; padding: 12px; background: #222; border: 1px dashed #555; color: #aaa; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 0.8em; transition: 0.3s; }
    .btn-load-more:hover { background: #333; color: white; border-color: white; }
    .hidden { display: none; }
    .personal-bet-card { background: rgba(255,255,255,0.03); border-left: 3px solid #555; padding: 10px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    .pb-info { font-size: 0.8em; }
    .pb-time { font-size: 0.7em; color: #666; }
    .pb-animal { font-weight: bold; color: var(--accent); }
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; text-transform: uppercase; }
    .badge-win { background: rgba(0, 210, 106, 0.2); color: var(--success); border: 1px solid var(--success); }
    .badge-lose { background: rgba(255, 75, 75, 0.2); color: var(--danger); border: 1px solid var(--danger); }

    /* --- SOCIAL & PRICE FEED STYLES (NEW) --- */
    .price-ticker { width: 100%; background: #000; color: #aaa; font-size: 0.7em; padding: 8px; display: flex; justify-content: space-around; border-top: 1px solid #333; position: fixed; bottom: 0; z-index: 200; }
    .price-item span { font-weight: bold; color: white; }
    
    .btn-social-open { position: absolute; top: 10px; right: 10px; background: transparent; border: 1px solid #444; color: #aaa; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
    .btn-social-open:hover { background: #222; color: white; border-color: white; }

    .rating-stars { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; }
    .star { font-size: 1.5em; color: #444; cursor: pointer; transition: 0.2s; }
    .star.active { color: var(--gold); transform: scale(1.1); }
    
    .reaction-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
    .btn-react { flex: 1; padding: 8px; background: #111; border: 1px solid #333; border-radius: 6px; color: #888; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .btn-react.active-like { border-color: var(--success); color: var(--success); background: rgba(0, 210, 106, 0.1); }
    .btn-react.active-dislike { border-color: var(--danger); color: var(--danger); background: rgba(255, 75, 75, 0.1); }

    .comment-section { text-align: left; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
    .comment-list { max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
    .comment-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; margin-bottom: 8px; font-size: 0.85em; }
    .comment-user { font-weight: bold; color: var(--primary); font-size: 0.9em; }
    .comment-text { color: #ddd; margin-top: 2px; }
    .input-comment { width: 100%; background: #111; border: 1px solid #333; padding: 10px; color: white; border-radius: 6px; margin-bottom: 8px; }
</style>
</head>
<body>
<header>
    <div style="font-weight:bold; font-size:1.2em;">Faylotto <span style="color:var(--accent)">Ultimate</span></div>
    <button id="connectBtn" class="wallet-btn" onclick="handleWalletClick()">Connect Wallet</button>
</header>

<div class="layout-container">
    <div class="slot-machine">
        <div class="reels-container">
            <div class="reel"><img id="imgReel1" src="what.svg" class="reel-img"></div>
            <div class="reel"><img id="imgReel2" src="what.svg" class="reel-img"></div>
            <div class="reel"><img id="imgReel3" src="what.svg" class="reel-img"></div>
        </div>
        <div class="draw-section">
            <button id="drawBtn" class="btn-draw" onclick="executeDraw()" disabled>DRAW NOW!</button>
            <div id="drawStatus" class="status-text">Waiting for players...</div>
        </div>
    </div>

    <div class="betting-section">
        <h3 style="margin-bottom:5px;">SELECT ANIMAL</h3>
        <div class="bet-grid">
            <div class="bet-card" id="card-0" onclick="selectAnimal('tuna', 0)"><img src="tuna.svg" class="bet-icon-img"><span class="name">Tuna</span><span id="count-0" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-0">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-0">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-0">0</span></span></div></div>
            <div class="bet-card" id="card-1" onclick="selectAnimal('crab', 1)"><img src="crab.svg" class="bet-icon-img"><span class="name">Crab</span><span id="count-1" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-1">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-1">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-1">0</span></span></div></div>
            <div class="bet-card" id="card-2" onclick="selectAnimal('shark', 2)"><img src="shark.svg" class="bet-icon-img"><span class="name">Shark</span><span id="count-2" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-2">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-2">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-2">0</span></span></div></div>
            <div class="bet-card" id="card-3" onclick="selectAnimal('octopus', 3)"><img src="octo.svg" class="bet-icon-img"><span class="name">Octopus</span><span id="count-3" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-3">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-3">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-3">0</span></span></div></div>
            <div class="bet-card" id="card-4" onclick="selectAnimal('shrimp', 4)"><img src="shrimp.svg" class="bet-icon-img"><span class="name">Shrimp</span><span id="count-4" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-4">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-4">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-4">0</span></span></div></div>
            <div class="bet-card" id="card-5" onclick="selectAnimal('orcha', 5)"><img src="orcha.svg" class="bet-icon-img"><span class="name">Orcha</span><span id="count-5" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-5">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-5">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-5">0</span></span></div></div>
        </div>

        <div style="width:100%; margin-top:20px; font-size:0.7em; color:#aaa; text-align:left;">ESTIMATED POOLS (ROUND)</div>
        <div class="pool-dashboard">
            <div class="pool-box"><span class="pool-title">ETH</span><span class="pool-value text-eth" id="poolTotalETH">0.0000</span></div>
            <div class="pool-box"><span class="pool-title">USDT</span><span class="pool-value text-usdt" id="poolTotalUSDT">0.00</span></div>
            <div class="pool-box"><span class="pool-title">SHIB</span><span class="pool-value text-shib" id="poolTotalSHIB">0</span></div>
        </div>

        <button id="mainBetBtn" class="main-bet-btn" onclick="triggerBetModal()">PLACE BET</button>
        <p style="margin-top:15px; color:#aaa; font-size:0.7em;">*Min 5 teams required to Draw</p>

        <div id="referralPanel" class="referral-panel">
            <div class="ref-label">Player Profile</div>
            <div style="font-size:1.2em; font-weight:bold; color:white; margin-bottom:10px;" id="displayNick">...</div>
            <div id="claimBonusBtnContainer"></div>
            <div class="ref-label">Referral Link</div>
            <div class="ref-box">
                <span id="displayRefLink" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">...</span>
                <button class="btn-copy" onclick="copyRefLink()">Copy</button>
            </div>
        </div>

        <div class="history-section">
            <div class="history-tabs">
                <button class="tab-btn active" onclick="switchTab('global')">Global Results</button>
                <button class="tab-btn" onclick="switchTab('personal')">My Winnings</button>
            </div>
            <div id="tabGlobal">
                <div id="historyList"></div>
                <button id="btnLoadMore" class="btn-load-more" onclick="loadMoreHistory()">Load Previous Rounds (15)</button>
            </div>
            <div id="tabPersonal" class="hidden">
                <div id="personalHistoryList">
                    <div style="text-align:center; color:#555; font-size:0.8em; padding:20px;">Fetching blockchain data...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="price-ticker">
    <div class="price-item">ETH: <span id="priceETH">...</span></div>
    <div class="price-item">USDT: <span id="priceUSDT">...</span></div>
    <div class="price-item">SHIB: <span id="priceSHIB">...</span></div>
</div>

<div id="socialModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('socialModal')">&times;</button>
        <div class="modal-title" style="font-size:1em; border-bottom:1px solid #333; padding-bottom:10px;">Round #<span id="socialRoundId"></span> Discussion</div>
        
        <div style="font-size:0.7em; color:#aaa; margin-bottom:5px;">RATE THIS ROUND</div>
        <div class="rating-stars" id="ratingStars">
            <span class="star" onclick="rateRound(1)">‚òÖ</span><span class="star" onclick="rateRound(2)">‚òÖ</span><span class="star" onclick="rateRound(3)">‚òÖ</span><span class="star" onclick="rateRound(4)">‚òÖ</span><span class="star" onclick="rateRound(5)">‚òÖ</span>
        </div>
        <div style="font-size:0.7em; color:#666; margin-bottom:15px;">Avg: <span id="avgRating">0.0</span> (<span id="countRating">0</span> votes)</div>

        <div class="reaction-bar">
            <button class="btn-react" id="btnLike" onclick="reactRound(1)">üëç <span id="cntLike">0</span></button>
            <button class="btn-react" id="btnDislike" onclick="reactRound(2)">üëé <span id="cntDislike">0</span></button>
        </div>

        <div class="comment-section">
            <div style="font-size:0.8em; font-weight:bold; margin-bottom:5px;">COMMENTS (<span id="cntComments">0</span>)</div>
            <div class="comment-list" id="commentList">Loading comments...</div>
            <input type="text" id="commentInput" class="input-comment" placeholder="Write a comment...">
            <button class="wallet-btn" style="width:100%; padding:8px; font-size:0.8em;" onclick="postComment()">POST COMMENT</button>
        </div>
    </div>
</div>

<div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('paymentModal')">&times;</button>
        <div class="modal-title">BET ON <span id="modalAnimalName">ANIMAL</span></div>
        <div class="pay-options">
            <button class="pay-btn btn-eth" onclick="processPayment('ETH')"><span>ETH</span> <span>0.0005 ETH</span></button>
            <button class="pay-btn btn-usdt" onclick="processPayment('USDT')"><span>USDT</span> <span>10 USDT</span></button>
            <button class="pay-btn btn-shib" onclick="processPayment('SHIB')"><span>SHIB</span> <span>110,000 SHIB</span></button>
        </div>
        <div style="border-top:1px dashed #444; padding-top:10px;">
            <div style="font-size:0.8em; color:#aaa;">Free Credit Balance: <span id="userBonusBalance" style="color:white;">0</span> SHIB</div>
            <button id="btnFreeBet" class="wallet-btn" style="width:100%; margin-top:5px; background:#333;" disabled onclick="processPayment('FREE')">Use Free Credit (10k)</button>
        </div>
    </div>
</div>

<div id="registerModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">REGISTER PROFILE</div>
        <input type="text" id="regNickname" class="input-field" placeholder="Enter Nickname (Min 3 Chars)" style="width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:none;">
        <div id="refInfoDisplay" style="font-size:0.8em; color:var(--success); margin-bottom:10px;"></div>
        <button class="wallet-btn" style="width:100%;" onclick="registerUser()">REGISTER NOW</button>
    </div>
</div>
<div id="walletInfoModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('walletInfoModal')">&times;</button>
        <div class="dash-profile"><div style="font-weight:bold; margin-bottom:5px;">WALLET & WINNINGS</div><div style="font-size:0.8em; color:#aaa; background:#111; padding:5px; border-radius:4px;" id="dashAddress">...</div></div>
        <div style="font-size:0.7em; color:#888; margin-bottom:5px;">WALLET BALANCE</div>
        <div class="dash-balance-grid">
            <div class="dash-item"><span class="dash-label">ETH</span><span class="dash-val text-eth" id="balETH">0.000</span></div>
            <div class="dash-item"><span class="dash-label">USDT</span><span class="dash-val text-usdt" id="balUSDT">0.00</span></div>
            <div class="dash-item"><span class="dash-label">SHIB</span><span class="dash-val text-shib" id="balSHIB">0.00</span></div>
        </div>
        <div class="withdraw-section">
            <div class="withdraw-title">GAME CREDIT / WINNINGS (IN CONTRACT)</div>
            <div class="dash-balance-grid">
                <div class="dash-item"><span class="dash-label">ETH Credit</span><span class="dash-val text-eth" id="credETH">0.000</span><button class="btn-withdraw-small" onclick="withdraw('ETH')">W/D</button></div>
                <div class="dash-item"><span class="dash-label">USDT Credit</span><span class="dash-val text-usdt" id="credUSDT">0.00</span><button class="btn-withdraw-small" onclick="withdraw('USDT')">W/D</button></div>
                <div class="dash-item"><span class="dash-label">SHIB Credit</span><span class="dash-val text-shib" id="credSHIB">0.00</span><button class="btn-withdraw-small" onclick="withdraw('SHIB')">W/D</button></div>
            </div>
        </div>
        <button class="btn-disconnect" onclick="disconnectWallet()">DISCONNECT</button>
    </div>
</div>
<div id="toast">Notification</div>

<script>
    // --- KONFIGURASI PENTING --- 
    const CONTRACT_ADDRESS = "0x72a20552267B4313f74003E25593592B15b76ad6";
    const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2";
    const SHIB_ADDRESS = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";
    const BASE_SEPOLIA_ID = 84532;
    const BASE_SEPOLIA_HEX = "0x14a34";

    const GAME_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_shibToken","type":"address"},{"internalType":"address","name":"_priceFeedETH","type":"address"},{"internalType":"address","name":"_priceFeedUSDT","type":"address"},{"internalType":"address","name":"_priceFeedSHIB","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"indexed":false,"internalType":"string","name":"outcome","type":"string"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"BattleResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"enum FaylottoUltimate.Currency","name":"curr","type":"uint8"},{"indexed":false,"internalType":"bool","name":"isRealTransfer","type":"bool"}],"name":"WinDistributed","type":"event"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"}],"name":"getRoundResult","outputs":[{"components":[{"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"internalType":"struct FaylottoUltimate.RoundResultData","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"enum FaylottoUltimate.BetType","name":"bType","type":"uint8"},{"internalType":"uint8","name":"animalChoice","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"globalWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"","type":"uint8"}],"name":"activeTeamCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"}],"name":"betETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"},{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"bool","name":"_isFreeBet","type":"bool"}],"name":"betToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeDraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"hasBet","type":"bool"},{"internalType":"uint256","name":"pendingRefBonusCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeShibCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"enum FaylottoUltimate.Currency","name":"","type":"uint8"}],"name":"userCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawCredit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_referrerNick","type":"string"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralBonus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"commentCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_stars","type":"uint8"}],"name":"submitRating","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_reaction","type":"uint8"}],"name":"setReaction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"dislikeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"}],"name":"getLatestPrice","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"}];
    const ERC20_ABI = [{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

    const IMAGE_NAMES = ['tuna', 'crab', 'shark', 'octopus', 'shrimp', 'orcha'];
    const IMAGE_LIST = ["tuna.svg", "crab.svg", "shark.svg", "octo.svg", "shrimp.svg", "orcha.svg", "zonk.svg"]; 
    const MIN_SPIN_TIME = 35000; 
    let spinStartTime = 0; let spinIntervals = [];
    let provider, signer, userAddress, gameContract;
    let isConnected = false;
    let currentSelectedAnimal = { name: '', index: -1 };
    let detectedReferrer = "";
    let roundPools = { eth: 0, usdt: 0, shib: 0 };
    let historyCursor = 0; let isInitialLoad = true; let currentMaxRound = 0;
    
    // Cache Optimization
    let globalWinnersCache = {}; 
    let globalHistoryLength = -1; // -1 artinya belum tau panjang array
    let currentSocialRound = 0;

    window.onload = async () => {
        document.querySelectorAll('.reel-img').forEach(img => img.src = "what.svg");
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('ref')) detectedReferrer = urlParams.get('ref');
        provider = new ethers.JsonRpcProvider("https://sepolia.base.org");
        gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, provider);
        setupEventListeners(); refreshGameData(); 
        fetchOraclePrices(); setInterval(fetchOraclePrices, 60000);
    };

    async function connectWallet() {
        if (!window.ethereum) { showToast("MetaMask missing"); return; }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            userAddress = accounts[0]; await switchNetwork();
            signer = await provider.getSigner();
            gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, signer);
            const storedAuth = localStorage.getItem(`auth_${userAddress}`);
            if (storedAuth && JSON.parse(storedAuth).expiry > Date.now()) finalizeLogin();
            else await requestSignature();
        } catch (error) { console.error(error); }
    }
    
    function handleWalletClick() { isConnected ? openWalletDashboard() : connectWallet(); }
    async function switchNetwork() { try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_SEPOLIA_HEX }] }); } catch {} }
    async function requestSignature() {
        try {
            const msg = `Login Faylotto\nUser: ${userAddress}\nTs: ${Date.now()}`;
            const sig = await signer.signMessage(msg);
            localStorage.setItem(`auth_${userAddress}`, JSON.stringify({ sig, expiry: Date.now() + 86400000 * 30 }));
            finalizeLogin();
        } catch { showToast("Login Cancelled"); }
    }
    async function finalizeLogin() {
        isConnected = true;
        document.getElementById("connectBtn").innerText = userAddress.substring(0,6)+"...";
        document.getElementById("connectBtn").classList.add("connected");
        showToast("Connected"); refreshGameData();
    }

    async function fetchOraclePrices() {
        try {
            const [eth, usdt, shib] = await Promise.all([
                gameContract.getLatestPrice(0),
                gameContract.getLatestPrice(1),
                gameContract.getLatestPrice(2)
            ]);
            document.getElementById('priceETH').innerText = `$${(Number(eth)/1e8).toFixed(2)}`;
            document.getElementById('priceUSDT').innerText = `$${(Number(usdt)/1e8).toFixed(4)}`;
            document.getElementById('priceSHIB').innerText = `$${(Number(shib)/1e8).toFixed(8)}`;
        } catch(e) { }
    }

    // --- SOCIAL FUNCTIONS ---
    async function openSocialModal(roundId) {
        if(!isConnected) { showToast("Connect Wallet first"); return; }
        currentSocialRound = roundId;
        document.getElementById('socialModal').style.display = 'flex';
        document.getElementById('socialRoundId').innerText = roundId;
        loadSocialData(roundId);
    }

    async function loadSocialData(roundId) {
        document.getElementById('commentList').innerHTML = 'Loading...';
        try {
            const [score, count, likes, dislikes, cCount] = await Promise.all([
                gameContract.totalRatingScore(roundId),
                gameContract.totalRatingCount(roundId),
                gameContract.likeCounts(roundId),
                gameContract.dislikeCounts(roundId),
                gameContract.commentCounts(roundId)
            ]);
            
            const avg = count > 0n ? (Number(score) / Number(count)).toFixed(1) : "0.0";
            document.getElementById('avgRating').innerText = avg;
            document.getElementById('countRating').innerText = count;
            document.getElementById('cntLike').innerText = likes;
            document.getElementById('cntDislike').innerText = dislikes;
            document.getElementById('cntComments').innerText = cCount;

            const list = document.getElementById('commentList');
            list.innerHTML = '';
            
            for(let i=0; i< Number(cCount); i++) {
                const c = await gameContract.roundComments(roundId, i);
                const userNick = (await gameContract.users(c[1]))[0] || c[1].substring(0,6);
                const div = document.createElement('div');
                div.className = 'comment-item';
                div.innerHTML = `<div class="comment-user">${userNick}</div><div class="comment-text">${c[2]}</div>`;
                list.appendChild(div);
            }
            if(Number(cCount) === 0) list.innerHTML = '<div style="color:#666; font-size:0.8em;">No comments yet.</div>';

        } catch(e) { document.getElementById('commentList').innerHTML = 'Error loading data'; }
    }

    async function rateRound(stars) { if(!currentSocialRound)return; try { await (await gameContract.submitRating(currentSocialRound, stars)).wait(); showToast("Rated!"); loadSocialData(currentSocialRound); } catch(e){ showToast("Error");} }
    async function reactRound(type) { if(!currentSocialRound)return; try { await (await gameContract.setReaction(currentSocialRound, type)).wait(); showToast("Reacted!"); loadSocialData(currentSocialRound); } catch(e){ showToast("Error");} }
    async function postComment() { const t=document.getElementById('commentInput').value; if(!t)return; try{ await (await gameContract.addComment(currentSocialRound, t)).wait(); document.getElementById('commentInput').value=""; showToast("Posted!"); loadSocialData(currentSocialRound); } catch(e){ showToast("Error");} }

    // --- GAME LOGIC ---
    function switchTab(tab) {
        if (tab === 'global') {
            document.getElementById('tabGlobal').classList.remove('hidden'); document.getElementById('tabPersonal').classList.add('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active'); document.querySelectorAll('.tab-btn')[1].classList.remove('active');
        } else {
            document.getElementById('tabGlobal').classList.add('hidden'); document.getElementById('tabPersonal').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active'); document.querySelectorAll('.tab-btn')[1].classList.add('active');
            updatePersonalHistory();
        }
    }

    function formatOutcomeText(raw, reels) {
        const r0=Number(reels[0]), r1=Number(reels[1]), r2=Number(reels[2]);
        const gN = (i) => i===6 ? "Zonk" : (IMAGE_NAMES[i] ? IMAGE_NAMES[i].charAt(0).toUpperCase()+IMAGE_NAMES[i].slice(1) : "?");
        if(raw==="TRIPLE") return `<span style="color:var(--gold);">${gN(r0)} (TRIPLE)</span>`;
        if(raw==="DOUBLE") {
            let d = r0===r1?gN(r0): (r1===r2?gN(r1):gN(r0)); let s = r0===r1?gN(r2): (r1===r2?gN(r0):gN(r1));
            return `<span style="color:var(--accent);">${d} (Double)</span> - ${s}`;
        }
        if(raw==="ONE_ZONK") return `${gN(r0)} - <span style="color:var(--danger)">Zonk</span> - ${gN(r2)}`;
        return `${gN(r0)} - ${gN(r1)} - ${gN(r2)}`;
    }

    async function fetchBatchHistory(count) {
        const historyList = document.getElementById('historyList');
        if (historyCursor < 1) { document.getElementById('btnLoadMore').style.display = 'none'; return; }
        const start = historyCursor, end = Math.max(1, historyCursor - count + 1);
        const roundPromises = [];
        for (let r = start; r >= end; r--) {
            if (document.getElementById(`history-card-${r}`)) continue;
            roundPromises.push(gameContract.getRoundResult(r).then(res => ({ r, res })));
        }
        if (roundPromises.length === 0) { historyCursor = end - 1; return; }
        try {
            const results = await Promise.all(roundPromises);
            for (let item of results) {
                const { r, res } = item;
                const card = document.createElement('div'); card.className = 'history-card'; card.id = `history-card-${r}`;
                card.innerHTML = `
                    <button class="btn-social-open" onclick="openSocialModal(${r})">üí¨</button>
                    <div style="font-size:0.8em; color:#aaa; margin-bottom:5px;">Round #${r} ‚Ä¢ ${new Date(Number(res.timestamp) * 1000).toLocaleTimeString()}</div>
                    <div class="history-reels"><img class="history-reel-img" src="${IMAGE_LIST[Number(res.reels[0])]}"><img class="history-reel-img" src="${IMAGE_LIST[Number(res.reels[1])]}"><img class="history-reel-img" src="${IMAGE_LIST[Number(res.reels[2])]}"></div>
                    <div class="history-outcome" style="margin-top:5px;">${formatOutcomeText(res.outcome, res.reels)}</div>
                    <div id="winner-info-${r}" style="margin-top:8px; border-top:1px dashed #444; padding-top:5px; min-height:20px;"><span style="font-size:0.7em; color:#555;">Loading...</span></div>
                `;
                historyList.appendChild(card);
            }
            await fetchWinnersOptimized(start, end);
        } catch (err) { console.error("History Error:", err); }
        historyCursor = end - 1; if (historyCursor < 1) document.getElementById('btnLoadMore').style.display = 'none';
    }

    // --- OPTIMIZED WINNER FETCHING (BINARY SEARCH LENGTH + PARALLEL FETCH) ---
    async function fetchWinnersOptimized(maxRound, minRound) {
        try {
            // 1. Find Array Length using Binary Search (Fast!)
            if (globalHistoryLength === -1) {
                let low = 0;
                let high = Number(await gameContract.currentRoundId()) + 5; // Estimates max length
                let foundLen = 0;
                
                while (low <= high) {
                    let mid = Math.floor((low + high) / 2);
                    try {
                        // Check if index exists
                        await gameContract.globalWinHistory(mid);
                        foundLen = mid + 1;
                        low = mid + 1;
                    } catch (e) {
                        high = mid - 1;
                    }
                }
                globalHistoryLength = foundLen;
            }

            // 2. Parallel Fetching of Data (Batching)
            // We only need to scan data relevant to our rounds
            // Scan backwards from end of array
            
            let endScan = globalHistoryLength - 1;
            let startScan = Math.max(0, endScan - 50); // Scan last 50 winners max
            
            if (endScan < 0) return; // Empty history

            const promises = [];
            for(let i = endScan; i >= startScan; i--) {
                promises.push(gameContract.globalWinHistory(i));
            }
            
            const winnersData = await Promise.all(promises);

            // 3. Map Data & Aggregate
            for(let d of winnersData) {
                const rId = Number(d[3]);
                if (rId <= maxRound && rId >= minRound) {
                    if (!globalWinnersCache[rId]) globalWinnersCache[rId] = { eth:0n, usdt:0n, shib:0n, topAddr:d[0], topAmt:d[1] };
                    if(Number(d[2])===0) globalWinnersCache[rId].eth+=d[1]; 
                    else if(Number(d[2])===1) globalWinnersCache[rId].usdt+=d[1]; 
                    else globalWinnersCache[rId].shib+=d[1];
                    
                    if(d[1] > globalWinnersCache[rId].topAmt) { 
                        globalWinnersCache[rId].topAmt=d[1]; globalWinnersCache[rId].topAddr=d[0]; 
                    }
                }
            }

            // 4. Update UI
            for (let r = maxRound; r >= minRound; r--) {
                const div = document.getElementById(`winner-info-${r}`); if (!div) continue;
                const d = globalWinnersCache[r];
                if (!d) { div.innerHTML = '<span style="font-size:0.7em; color:#666;">No Winners</span>'; continue; }
                
                let pay = ""; 
                if(d.eth>0n) pay+=`<div style="color:#627EEA">+${parseFloat(ethers.formatEther(d.eth)).toFixed(4)} ETH</div>`;
                if(d.usdt>0n) pay+=`<div style="color:#26A17B">+${parseFloat(ethers.formatUnits(d.usdt,6)).toFixed(2)} USDT</div>`;
                if(d.shib>0n) pay+=`<div style="color:#FFA409">+${parseFloat(ethers.formatUnits(d.shib,18)).toLocaleString()} SHIB</div>`;
                
                div.innerHTML = `<div class="winner-info-box" style="display:block; border-top:1px solid #333; margin-top:5px; padding-top:5px;"><div style="display:flex; justify-content:space-between;"><div style="text-align:left;"><div style="font-size:0.65em; color:#888;">WINNER</div><div style="color:var(--gold); font-weight:bold; font-size:0.85em;" id="nick-${r}">üèÜ ${d.topAddr.substring(0,4)}...</div></div><div style="text-align:right; font-size:0.75em; font-weight:bold;">${pay}</div></div></div>`;
                
                gameContract.users(d.topAddr).then(u=>{ if(u[0]) document.getElementById(`nick-${r}`).innerText=`üèÜ ${u[0]}`; }).catch(()=>{});
            }

        } catch (e) { console.log("Fetch error", e); }
    }

    async function loadMoreHistory() { const btn=document.getElementById('btnLoadMore'); btn.innerText="Loading..."; btn.disabled=true; await fetchBatchHistory(15); btn.innerText="Load More"; btn.disabled=false; }

    async function updatePersonalHistory() {
        const list = document.getElementById('personalHistoryList');
        if (!isConnected) { list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Connect Wallet</div>'; return; }
        list.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">Loading...</div>';
        try {
            let myWins = [], idx = 0, fetching = true;
            // Optimization: Parallel fetch initial 20 items
            const p = [];
            for(let i=0; i<20; i++) p.push(gameContract.userWinHistory(userAddress, i).catch(()=>null));
            const res = await Promise.all(p);
            
            for(let r of res) { if(r) myWins.push(r); else fetching=false; }
            
            // Fetch rest sequentially if more exist
            if(fetching && myWins.length === 20) {
                 idx = 20;
                 while(fetching && idx < 50) { try { const log = await gameContract.userWinHistory(userAddress, idx); myWins.push(log); idx++; } catch { fetching=false; } }
            }

            if(myWins.length===0) { list.innerHTML='<div style="text-align:center; padding:20px; color:#666;">No winnings yet.</div>'; return; }
            list.innerHTML='';
            for(let win of myWins.reverse()) {
                let sym = Number(win[2])===0?"ETH":(Number(win[2])===1?"USDT":"SHIB");
                let val = parseFloat(ethers.formatUnits(win[1], Number(win[2])===1?6:18));
                let el = document.createElement('div'); el.className = 'personal-bet-card'; el.style.borderLeftColor = 'var(--gold)';
                el.innerHTML = `<div class="pb-info"><div class="pb-time">Round #${win[3]}</div><div style="font-weight:bold; color:var(--text);">Result: <span style="color:var(--accent);">${win[5]}</span></div></div><div style="text-align:right;"><span class="badge badge-win" style="color:var(--gold);">üèÜ VICTORY</span><div style="margin-top:5px; font-weight:bold; color:#fff;">+ ${val.toLocaleString()} ${sym}</div></div>`;
                list.appendChild(el);
            }
        } catch(e) { list.innerHTML='Error'; }
    }

    async function refreshGameData() {
        if(isConnected) {
            const u = await gameContract.users(userAddress);
            if(u[1]) {
                document.getElementById('referralPanel').style.display='block';
                document.getElementById('displayNick').innerText=u[0];
                document.getElementById('displayRefLink').innerText=location.origin+location.pathname+"?ref="+u[0];
                if(Number(u[4])>0) { document.getElementById('claimBonusBtnContainer').innerHTML=`<button class='wallet-btn' onclick='claimReferralBonus()'>Claim ${Number(u[4])*10000} SHIB</button>`; }
            }
            const b = await gameContract.freeShibCredits(userAddress);
            document.getElementById('userBonusBalance').innerText=Number(ethers.formatEther(b)).toLocaleString();
            document.getElementById('btnFreeBet').disabled = b < ethers.parseEther("10000");
            if(b >= ethers.parseEther("10000")) document.getElementById('btnFreeBet').style.background = "var(--success)";
        }
        const currR = Number(await gameContract.currentRoundId());
        
        let bets=[], idx=0; while(true){ try{ bets.push(await gameContract.roundBets(currR, idx)); idx++; }catch{break;}}
        let counts=[0,0,0,0,0,0], pools={e:0,u:0,s:0}, myBets=[0,0,0,0,0,0];
        bets.forEach(b => {
            let amt = parseFloat(ethers.formatUnits(b[1], Number(b[2])===1?6:18));
            if(Number(b[2])===0) pools.e+=amt; else if(Number(b[2])===1) pools.u+=amt; else pools.s+=amt;
            counts[Number(b[4])]++; if(b[0].toLowerCase()===userAddress?.toLowerCase()) myBets[Number(b[4])]=1;
        });
        document.getElementById('poolTotalETH').innerText=pools.e.toFixed(4);
        document.getElementById('poolTotalUSDT').innerText=pools.u.toFixed(2);
        document.getElementById('poolTotalSHIB').innerText=pools.s.toLocaleString();
        
        for(let i=0; i<6; i++) {
            document.getElementById(`count-${i}`).innerText = counts[i];
            let c = document.getElementById(`card-${i}`);
            c.classList.remove('my-bet','open');
            if(myBets[i]) c.classList.add('my-bet'); else c.classList.add('open');
        }
        let active = counts.filter(c=>c>0).length;
        if(active>=5) { document.getElementById('drawBtn').disabled=false; document.getElementById('drawBtn').classList.add('ready'); document.getElementById('drawStatus').innerText="READY!"; }
        else { document.getElementById('drawBtn').disabled=true; document.getElementById('drawBtn').classList.remove('ready'); document.getElementById('drawStatus').innerText=`Need ${5-active} teams`; }

        if(isInitialLoad) { document.getElementById('historyList').innerHTML=''; fetchBatchHistory(10); isInitialLoad=false; }
        else if(document.getElementById('historyList').firstChild) { document.getElementById('historyList').innerHTML=''; fetchBatchHistory(10); }
        if(!document.getElementById('tabPersonal').classList.contains('hidden')) updatePersonalHistory();
    }

    function selectAnimal(n,i) { currentSelectedAnimal={name:n,index:i}; for(let k=0;k<6;k++) document.getElementById(`card-${k}`).classList.remove('selected'); document.getElementById(`card-${i}`).classList.add('selected'); }
    function triggerBetModal() { if(!isConnected || currentSelectedAnimal.index===-1) return showToast("Connect & Select!"); document.getElementById("modalAnimalName").innerText=currentSelectedAnimal.name.toUpperCase(); document.getElementById('paymentModal').style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function showToast(m) { let x=document.getElementById("toast"); x.innerText=m; x.className="show"; setTimeout(()=>{x.className=x.className.replace("show","")},3000); }
    
    async function processPayment(type) {
        closeModal('paymentModal'); showToast("Processing...");
        try {
            let tx, i=currentSelectedAnimal.index;
            if(type==='ETH') tx = await gameContract.betETH(i, {value:ethers.parseEther("0.0005")});
            else if(type==='FREE') tx = await gameContract.betToken(i,2,true);
            else {
                let t = type==='USDT'? new ethers.Contract(USDT_ADDRESS,ERC20_ABI,signer) : new ethers.Contract(SHIB_ADDRESS,ERC20_ABI,signer);
                let a = type==='USDT'? ethers.parseUnits("10",6) : ethers.parseUnits("110000",18);
                if((await t.allowance(userAddress,CONTRACT_ADDRESS)) < a) { showToast("Approving..."); await (await t.approve(CONTRACT_ADDRESS,ethers.MaxUint256)).wait(); }
                tx = await gameContract.betToken(i, type==='USDT'?1:2, false);
            }
            showToast("Sending..."); await tx.wait(); showToast("Bet Placed!"); refreshGameData();
        } catch(e) { showToast("Error"); console.log(e); }
    }

    async function openWalletDashboard() {
        document.getElementById('walletInfoModal').style.display='flex'; document.getElementById('dashAddress').innerText=userAddress;
        try {
            document.getElementById('balETH').innerText=parseFloat(ethers.formatEther(await provider.getBalance(userAddress))).toFixed(4);
            let cr = await gameContract.userCredits(userAddress,0); document.getElementById('credETH').innerText=parseFloat(ethers.formatEther(cr)).toFixed(4);
        } catch(e){}
    }
    async function withdraw(curr) {
        try { showToast("Withdrawing..."); let c=curr==='ETH'?0:(curr==='USDT'?1:2); await (await gameContract.withdrawCredit(c, await gameContract.userCredits(userAddress,c))).wait(); showToast("Success"); } catch(e){ showToast("Fail");}
    }
    function disconnectWallet() { localStorage.removeItem(`auth_${userAddress}`); location.reload(); }
    function copyRefLink() { navigator.clipboard.writeText(document.getElementById('displayRefLink').innerText); showToast("Copied"); }
    async function registerUser() { try { await (await gameContract.register(document.getElementById('regNickname').value, detectedReferrer||"")).wait(); closeModal('registerModal'); finalizeLogin(); } catch(e){ showToast("Reg Fail"); } }
    async function claimReferralBonus() { try { await (await gameContract.claimReferralBonus()).wait(); showToast("Claimed"); refreshGameData(); } catch(e){} }

    function startSpinAnimation() { spinIntervals.forEach(clearInterval); spinIntervals=[]; [1,2,3].forEach((x,i)=> spinIntervals.push(setInterval(()=>document.getElementById(`imgReel${x}`).src=IMAGE_LIST[Math.floor(Math.random()*7)], 80+i*10))); }
    function stopSpinAnimation(r1,r2,r3) { spinIntervals.forEach(clearInterval); document.getElementById('imgReel1').src=IMAGE_LIST[r1]; setTimeout(()=>document.getElementById('imgReel2').src=IMAGE_LIST[r2],500); setTimeout(()=>document.getElementById('imgReel3').src=IMAGE_LIST[r3],1000); }
    async function executeDraw() { try { await gameContract.executeDraw(); startSpinAnimation(); spinStartTime=Date.now(); showToast("Spinning..."); checkRoundResult((await gameContract.currentRoundId())-1n); } catch(e){ showToast("Error"); } }
    let processing=false;
    async function checkRoundResult(rid) {
        if(processing) return; processing=true; setTimeout(()=>processing=false,40000);
        setTimeout(async()=>{
            try { const r = await gameContract.getRoundResult(rid); stopSpinAnimation(r[0][0],r[0][1],r[0][2]); refreshGameData(); } catch(e){}
        }, Math.max(0, MIN_SPIN_TIME - (Date.now()-spinStartTime)));
    }
    function setupEventListeners() { gameContract.on("NewBet", refreshGameData); gameContract.on("BattleResult", (a,b,id)=>checkRoundResult(id)); }
        </script>
</body>
</html>
