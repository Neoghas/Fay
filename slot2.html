<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto Spin Battle - Base Sepolia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
<style>
    /* --- CSS GLOBAL --- */
    * { box-sizing: border-box; }
    :root {
        --primary: #0052ff; --accent: #00d1ff; --bg: #0f111a;
        --panel: #1e2130; --text: #ffffff; --danger: #ff4b4b; --success: #00d26a;
        --gold: #FFD700;
        --shib-color: #FFA409; --usdt-color: #26A17B; --eth-color: #627EEA;
        --purple: #bf00ff;
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg); color: var(--text); margin: 0;
        display: flex; flex-direction: column; align-items: center;
        min-height: 100vh; padding-bottom: 50px; overflow-x: hidden;
    }
    header {
        width: 100%; padding: 15px 20px; display: flex; justify-content: space-between;
        align-items: center; background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--panel);
        position: sticky; top: 0; z-index: 100; backdrop-filter: blur(5px);
    }
    .wallet-btn {
        background: var(--primary); color: white; border: none; padding: 8px 16px;
        border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.3s;
    }
    .wallet-btn.connected { background: var(--success); border: 1px solid #fff; }

    .layout-container { width: 92%; max-width: 480px; display: flex; flex-direction: column; align-items: center; }

    /* SLOT MACHINE */
    .slot-machine {
        margin-top: 30px; background: var(--panel); padding: 20px;
        border-radius: 15px; border: 4px solid #333;
        box-shadow: 0 0 20px rgba(0, 82, 255, 0.2); 
        width: 100%; display: flex; flex-direction: column; align-items: center;
    }
    .reels-container { display: flex; gap: 8px; background: #000; padding: 10px; border-radius: 8px; justify-content: center; margin-bottom: 15px; width: 100%; }
    .reel { flex: 1; height: 90px; background: #fff; border-radius: 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
    .reel-img { width: 80%; height: 80%; object-fit: contain; }

    /* BUTTON DRAW */
    .draw-section { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .btn-draw {
        background: linear-gradient(45deg, #333, #555); color: #888; border: 2px solid #444;
        padding: 11px 0; width: 40%; border-radius: 30px;
        font-size: 0.6em; font-weight: 700; letter-spacing: 1px;
        cursor: not-allowed; transition: 0.3s; box-shadow: none; text-transform: uppercase;
    }
    .btn-draw.ready {
        background: linear-gradient(45deg, #ff0000, #ff8800); color: white; border: 2px solid #ffaa00;
        cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        animation: pulse 1.5s infinite;
    }
    .btn-draw.ready:hover { transform: scale(1.02); }
    @keyframes pulse { 0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); } 50% { box-shadow: 0 0 25px rgba(255, 100, 0, 0.8); } 100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); } }
    .status-text { font-size: 0.9em; color: var(--accent); font-weight: bold; text-align: center; }
    .status-text.ready { color: var(--success); }

    /* BETTING AREA */
    .betting-section { margin-top: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; }
    .bet-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-top: 15px; }
    
    .bet-card {
        background: var(--panel); border: 2px solid transparent;
        border-radius: 12px; padding: 10px; cursor: pointer; transition: 0.2s;
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; aspect-ratio: 1/1.1; position: relative;
    }
    .bet-card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 5px 15px rgba(0, 209, 255, 0.2); }
    .bet-card.selected { border-color: var(--success); background: rgba(0, 210, 106, 0.1); transform: scale(0.98); box-shadow: 0 0 15px rgba(0, 210, 106, 0.4); }
    
    .bet-icon-img { width: 50%; height: 50%; object-fit: contain; margin-bottom: 8px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); }
    .name { font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px;}
    
    .team-count { font-size: 9px; color: #aaa; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-top: 5px; }
    .team-count.filled { color: var(--success); border: 1px solid var(--success); }

    /* BUTTON BET */
    .main-bet-btn {
        margin-top: 25px; background: var(--primary); color: white; border: 3px solid #0027b3;
        padding: 13px 0; width: 50%; border-radius: 50px; font-size: 0.9em;
        font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 82, 255, 0.4);
    }
    .main-bet-btn:hover { background: var(--accent); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 209, 255, 0.5); }
    .main-bet-btn:disabled { background: #444; cursor: not-allowed; box-shadow: none; color: #888; }

    /* MODALS */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-content { background: var(--panel); width: 90%; max-width: 400px; padding: 25px; border-radius: 15px; text-align: center; border: 1px solid var(--accent); box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative;}
    .modal-title { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; }
    .modal-title span { color: var(--accent); text-transform: uppercase; }
    
    .pay-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .pay-btn { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; }
    .btn-eth { background: var(--eth-color); } .btn-usdt { background: var(--usdt-color); } .btn-shib { background: var(--shib-color); }
    
    .free-bet-panel { background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 15px; margin-top: 15px; border: 1px dashed var(--success); }
    .free-balance { font-size: 0.9em; color: #aaa; margin-bottom: 8px; }
    .free-val { color: var(--success); font-weight: bold; font-size: 1.1em; }
    .btn-free { width: 100%; background: var(--success); color: #000; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 5px; }
    .btn-free:disabled { background: #333; color: #666; cursor: not-allowed; }
    .close-modal { margin-top: 15px; background: transparent; border: none; color: #aaa; cursor: pointer; text-decoration: underline; }
    
    .input-field { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #0f111a; color: white; }

    /* --- WALLET DASHBOARD STYLES --- */
    .dash-profile { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333; }
    .dash-nick { font-size: 1.4em; color: var(--gold); font-weight: bold; margin-bottom: 5px; }
    .dash-ref-box { background: #111; padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; font-size: 0.8em; color: #888; margin-top: 10px; border: 1px solid #333; }
    .dash-copy { background: var(--primary); color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-left: 5px; }
    .dash-balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; text-align: left; }
    .dash-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }
    .dash-label { font-size: 0.7em; color: #aaa; display: block; margin-bottom: 4px; }
    .dash-val { font-size: 0.9em; font-weight: bold; }
    .btn-disconnect { background: var(--danger); width: 100%; padding: 10px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }

    /* --- REFERRAL PANEL (DI BAWAH TOMBOL BET) --- */
.referral-panel {
    margin-top: 25px;
    width: 100%;
    background: rgba(255, 255, 255, 0.03);
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #333;
    text-align: center;
    display: none; /* Hidden default, muncul pas login */
}
.ref-label { font-size: 0.7em; color: var(--accent); letter-spacing: 1px; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
.ref-nick { font-size: 1.3em; color: var(--gold); font-weight: bold; margin-bottom: 10px; }
.ref-box {
    background: #000; padding: 8px 12px; border-radius: 8px;
    display: flex; justify-content: space-between; align-items: center;
    font-size: 0.8em; color: #888; border: 1px solid #333;
}
.btn-copy-small {
    background: var(--primary); color: white; border: none;
    padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-left: 8px;
}
    
    /* TOAST */
    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 999; bottom: 30px; left: 50%; transform: translateX(-50%); }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
</style>
</head>
<body>

    <header>
        <div style="font-weight:bold; font-size:1.2em;">Faylotto <span style="color:var(--accent)">Battle</span></div>
        <button id="connectBtn" class="wallet-btn" onclick="handleWalletClick()">Connect Wallet</button>
    </header>

    <div class="layout-container">
        <div class="slot-machine">
            <div class="reels-container">
                <div class="reel" id="reel1"><img id="imgReel1" src="what.svg" class="reel-img"></div>
                <div class="reel" id="reel2"><img id="imgReel2" src="what.svg" class="reel-img"></div>
                <div class="reel" id="reel3"><img id="imgReel3" src="what.svg" class="reel-img"></div>
            </div>
            <div class="draw-section">
                <button id="drawBtn" class="btn-draw" onclick="executeDraw()" disabled>DRAW NOW!</button>
                <div id="drawStatus" class="status-text">Waiting for players... (0/6 Teams Active)</div>
            </div>
        </div>

        <div class="betting-section">
            <h3 style="margin-bottom:5px;">SELECT ANIMAL FIRST</h3>
            <div class="bet-grid">
                <div class="bet-card" id="card-0" onclick="selectAnimal('tuna', 0)">
                    <img id="img-tuna" src="" class="bet-icon-img" alt="Tuna"><span class="name">Tuna</span><span id="count-0" class="team-count">0/2</span>
                </div>
                <div class="bet-card" id="card-1" onclick="selectAnimal('crab', 1)">
                    <img id="img-crab" src="" class="bet-icon-img" alt="Crab"><span class="name">Crab</span><span id="count-1" class="team-count">0/2</span>
                </div>
                <div class="bet-card" id="card-2" onclick="selectAnimal('shark', 2)">
                    <img id="img-shark" src="" class="bet-icon-img" alt="Shark"><span class="name">Shark</span><span id="count-2" class="team-count">0/2</span>
                </div>
                <div class="bet-card" id="card-3" onclick="selectAnimal('octopus', 3)">
                    <img id="img-octopus" src="" class="bet-icon-img" alt="Octopus"><span class="name">Octopus</span><span id="count-3" class="team-count">0/2</span>
                </div>
                <div class="bet-card" id="card-4" onclick="selectAnimal('shrimp', 4)">
                    <img id="img-shrimp" src="" class="bet-icon-img" alt="Shrimp"><span class="name">Shrimp</span><span id="count-4" class="team-count">0/2</span>
                </div>
                <div class="bet-card" id="card-5" onclick="selectAnimal('orcha', 5)">
                    <img id="img-orcha" src="" class="bet-icon-img" alt="Orcha"><span class="name">Orcha</span><span id="count-5" class="team-count">0/2</span>
                </div>
            </div>
            <button id="mainBetBtn" class="main-bet-btn" onclick="triggerBetModal()">PLACE BET</button>
            <p style="margin-top:20px; color:#aaa; font-size:0.8em;">*Min 5 teams required to Draw</p>
        </div>
    </div>

    <div id="referralPanel" class="referral-panel">

    <div class="ref-label">Player Profile</div>

    <div class="ref-nick" id="displayNick">Loading...</div>

    

    <div class="ref-label" style="margin-top:10px;">Your Referral Link</div>

    <div class="ref-box">

        <span id="displayRefLink" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 200px;">...</span>

        <button class="btn-copy-small" onclick="copyRefLink()">Copy</button>

    </div>

</div>



<p style="margin-top:20px; color:#aaa; font-size:0.8em;">*Min 5 teams required to Draw</p>

    <div id="paymentModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">BET ON <span id="modalAnimalName">ANIMAL</span></div>
            <div class="pay-options">
                <button class="pay-btn btn-eth" onclick="processPayment('ETH')"><span>ETH</span> <span>0.0005 ETH</span></button>
                <button class="pay-btn btn-usdt" onclick="processPayment('USDT')"><span>USDT</span> <span>10 USDT</span></button>
                <button class="pay-btn btn-shib" onclick="processPayment('SHIB')"><span>SHIB</span> <span>110,000 SHIB</span></button>
            </div>
            <div class="free-bet-panel">
                <div class="free-balance">Bonus Balance:</div>
                <div class="free-val"><span id="userBonusBalance">0</span> SHIB</div>
                <button id="btnFreeBet" class="btn-free" onclick="processPayment('FREE')" disabled>Use Bonus Bet (10k SHIB)</button>
                <div style="font-size:0.7em; color:#aaa; margin-top:5px;">*From Referral Bonus</div>
            </div>
            <button class="close-modal" onclick="closeModal('paymentModal')">Cancel</button>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">PLAYER REGISTRATION</div>
            <p style="font-size:0.9em; color:#aaa;">You must register a nickname to play.</p>
            <input type="text" id="regNickname" class="input-field" placeholder="Enter Your Nickname (min 3 chars)">
            
            <div style="font-size:0.8em; color: var(--success); margin-top:5px;" id="refInfoDisplay"></div>
            
            <button class="wallet-btn" style="width:100%; margin-top:10px;" onclick="registerUser()">REGISTER NOW</button>
        </div>
    </div>

    <div id="walletInfoModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" style="position:absolute; top:10px; right:15px; margin:0; text-decoration:none; font-size:1.5em;" onclick="closeModal('walletInfoModal')">&times;</button>
        
        <div class="dash-profile">
            <div style="font-size:1.1em; font-weight:bold; color:white; margin-bottom:5px;">WALLET INFO</div>
            <div style="font-size:0.85em; color:#aaa; background:#111; padding:5px 10px; border-radius:20px; display:inline-block;" id="dashAddress">0x00...0000</div>
        </div>

        <div class="dash-balance-grid">
            <div class="dash-item"> <span class="dash-label">ETH Balance</span> <span class="dash-val stat-eth" id="balETH">0.000</span> </div>
            <div class="dash-item"> <span class="dash-label">USDT Balance</span> <span class="dash-val stat-usdt" id="balUSDT">0.00</span> </div>
            <div class="dash-item"> <span class="dash-label">SHIB Balance</span> <span class="dash-val stat-shib" id="balSHIB">0.00</span> </div>
            <div class="dash-item"> <span class="dash-label">Free Credits (SHIB)</span> <span class="dash-val stat-shib" id="balFree">0.00</span> </div>
        </div>
        
        <button class="btn-disconnect" onclick="disconnectWallet()">DISCONNECT</button>
    </div>
    </div>

    <div id="toast">Notification</div>

<script>
    const CONTRACT_ADDRESS = "0x72a20552267B4313f74003E25593592B15b76ad6"; // << ISI ALAMAT KONTRAK FAYLOTTOULTIMATE DISINI
    const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2";     // << ISI ALAMAT USDT DISINI
    const SHIB_ADDRESS = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";     // << ISI ALAMAT SHIB DISINI
    
    const BASE_SEPOLIA_ID = 84532; 
    const BASE_SEPOLIA_HEX = "0x14a34"; 

    // ABI Minimal untuk Interaksi
    const GAME_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_shibToken","type":"address"},{"internalType":"address","name":"_priceFeedETH","type":"address"},{"internalType":"address","name":"_priceFeedUSDT","type":"address"},{"internalType":"address","name":"_priceFeedSHIB","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"indexed":false,"internalType":"string","name":"outcome","type":"string"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"BattleResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BonusClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"oldCollector","type":"address"},{"indexed":false,"internalType":"address","name":"newCollector","type":"address"}],"name":"FeeCollectorUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint8","name":"animalChoice","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NewBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"RatingSubmitted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"reactionType","type":"uint8"}],"name":"ReactionUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"invitee","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralLinked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"UserRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"enum FaylottoUltimate.Currency","name":"curr","type":"uint8"},{"indexed":false,"internalType":"bool","name":"isRealTransfer","type":"bool"}],"name":"WinDistributed","type":"event"},{"inputs":[],"name":"COST_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_MAIN","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_PLATFORM_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TOTAL_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TEAMS_ACTIVE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BONUS_AMOUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"","type":"uint8"}],"name":"activeTeamCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"}],"name":"betETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"},{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"bool","name":"_isFreeBet","type":"bool"}],"name":"betToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralBonus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"commentCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"dislikeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint256","name":"_cId","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"name":"emergencyWithdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeDraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeShibCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getActiveTeamCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getBonusBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"}],"name":"getLatestPrice","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"}],"name":"getRoundResult","outputs":[{"components":[{"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"internalType":"struct FaylottoUltimate.RoundResultData","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"globalWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nicknameToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_referrerNick","type":"string"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"enum FaylottoUltimate.BetType","name":"bType","type":"uint8"},{"internalType":"uint8","name":"animalChoice","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundHistory","outputs":[{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_eth","type":"address"},{"internalType":"address","name":"_usdt","type":"address"},{"internalType":"address","name":"_shib","type":"address"}],"name":"setPriceFeeds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_reaction","type":"uint8"}],"name":"setReaction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"shibToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_stars","type":"uint8"}],"name":"submitRating","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"enum FaylottoUltimate.Currency","name":"","type":"uint8"}],"name":"userCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRatings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userReactions","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"hasBet","type":"bool"},{"internalType":"uint256","name":"pendingRefBonusCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawCredit","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

    const ITEM_IMAGES = { tuna: "tuna.svg", crab: "crab.svg", shark: "shark.svg", octopus: "octo.svg", shrimp: "shrimp.svg", orcha: "orcha.svg" };
    const REEL_INITIAL_IMG = "what.svg";

    let provider, signer, userAddress, gameContract;
    let isConnected = false;
    let currentSelectedAnimal = { name: '', index: -1 };
    let teamData = [0,0,0,0,0,0];
    let detectedReferrer = ""; // Menyimpan referrer dari URL

    window.onload = async () => {
        loadImages();
        checkReferralUrl(); // Cek apakah ada ?ref= di URL
        checkLocalStorageAuth();
    };

    function loadImages() {
        document.getElementById('imgReel1').src = REEL_INITIAL_IMG;
        document.getElementById('imgReel2').src = REEL_INITIAL_IMG;
        document.getElementById('imgReel3').src = REEL_INITIAL_IMG;
        for (const [key, url] of Object.entries(ITEM_IMAGES)) {
            const imgEl = document.getElementById(`img-${key}`);
            if (imgEl) imgEl.src = url;
        }
    }

    // 1. CHECK REFERRAL URL
    function checkReferralUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const ref = urlParams.get('ref');
        if (ref) {
            detectedReferrer = ref;
            console.log("Referrer Detected:", ref);
            // Simpan sementara di session/local storage jika perlu, tapi variabel cukup
        }
    }

    // 2. HANDLE WALLET CLICK (Connect OR Open Dashboard)
    function handleWalletClick() {
        if (isConnected) {
            openWalletDashboard();
        } else {
            connectWallet();
        }
    }

    async function connectWallet() {
        if (!window.ethereum) { showToast("MetaMask not installed!"); return; }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            userAddress = accounts[0];
            await switchNetwork();
            signer = await provider.getSigner();
            gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, signer);

            const storedAuth = localStorage.getItem(`auth_${userAddress}`);
            if (storedAuth) {
                const authData = JSON.parse(storedAuth);
                if (new Date().getTime() < authData.expiry) {
                    await finalizeLogin();
                    return;
                }
            }
            await requestSignature();
        } catch (error) { console.error(error); showToast("Connection failed"); }
    }

    async function switchNetwork() {
        const network = await provider.getNetwork();
        if (Number(network.chainId) !== BASE_SEPOLIA_ID) {
            try {
                await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_SEPOLIA_HEX }] });
            } catch (err) { if (err.code === 4902) { /* Add Chain Logic */ } }
        }
    }

    async function requestSignature() {
        const message = `Login to Faylotto\nUser: ${userAddress}\nTime: ${new Date().toLocaleString()}`;
        try {
            const signature = await signer.signMessage(message);
            const expiry = new Date().getTime() + (30 * 24 * 3600 * 1000);
            localStorage.setItem(`auth_${userAddress}`, JSON.stringify({ signature, expiry }));
            await finalizeLogin();
        } catch (err) { showToast("Signature rejected"); }
    }

    async function finalizeLogin() {
        setConnectedState(true);
        showToast("Wallet Connected");
        
        try {
            const userData = await gameContract.users(userAddress);
            if (!userData.isRegistered) {
                // Tampilkan info referrer jika ada
                if(detectedReferrer) {
                    document.getElementById('refInfoDisplay').innerText = `Invited by: ${detectedReferrer}`;
                }
                document.getElementById('registerModal').style.display = 'flex';
            } else {
                refreshGameData();
            }
        } catch(e) { console.error("Read user error", e); }
    }

    function setConnectedState(status) {
        isConnected = status;
        const btn = document.getElementById("connectBtn");
        if (status) {
            btn.innerText = userAddress.substring(0,6) + "..." + userAddress.slice(-4);
            btn.classList.add("connected");
        } else {
            btn.innerText = "Connect Wallet";
            btn.classList.remove("connected");
        }
    }

    // 3. DASHBOARD LOGIC
    async function openWalletDashboard() {
    document.getElementById('walletInfoModal').style.display = 'flex';
    document.getElementById('dashAddress').innerText = userAddress;
    
    try {
        const balEth = await provider.getBalance(userAddress);
        document.getElementById('balETH').innerText = parseFloat(ethers.formatEther(balEth)).toFixed(4);

        const usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
        const balUsdt = await usdtContract.balanceOf(userAddress);
        document.getElementById('balUSDT').innerText = parseFloat(ethers.formatUnits(balUsdt, 6)).toFixed(2);

        const shibContract = new ethers.Contract(SHIB_ADDRESS, ERC20_ABI, provider);
        const balShib = await shibContract.balanceOf(userAddress);
        document.getElementById('balSHIB').innerText = parseFloat(ethers.formatEther(balShib)).toFixed(2);

        const bonus = await gameContract.getBonusBalance(userAddress);
        document.getElementById('balFree').innerText = parseFloat(ethers.formatEther(bonus)).toFixed(2);
    } catch(e) { console.error(e); }
    }

    function copyRefLink() {
    const text = document.getElementById('displayRefLink').innerText;
    navigator.clipboard.writeText(text).then(() => showToast("Link Copied!"));
    }

    function disconnectWallet() {
    isConnected = false;
    localStorage.removeItem(`auth_${userAddress}`);
    userAddress = null; signer = null; gameContract = null;
    setConnectedState(false);
    closeModal('walletInfoModal');
    
    // Hide panel referral
    document.getElementById('referralPanel').style.display = 'none';
    
    showToast("Disconnected");
    }

    // Register User (Use Detected Referrer)
    async function registerUser() {
        const nick = document.getElementById('regNickname').value;
        // Gunakan referrer dari URL jika ada, kalau tidak kosong string
        const refNick = detectedReferrer || ""; 
        
        if(nick.length < 3) { showToast("Nickname too short"); return; }
        
        try {
            showToast("Registering...");
            const tx = await gameContract.register(nick, refNick);
            await tx.wait();
            showToast("Registration Success!");
            closeModal('registerModal');
            refreshGameData();
        } catch(err) { showToast("Reg Failed: " + (err.reason || err.message)); }
    }

    // ... (Sisa Logika Game, Bet, Draw sama seperti sebelumnya) ...
    
async function refreshGameData() {

    if(!gameContract) return;

    try {

        // --- LOGIC BARU: TAMPILKAN REFERRAL DI HALAMAN DEPAN ---

        const userData = await gameContract.users(userAddress);

        if(userData.isRegistered) {

            document.getElementById('referralPanel').style.display = 'block';

            document.getElementById('displayNick').innerText = userData.nickname;

            

            const baseUrl = window.location.origin + window.location.pathname;

            document.getElementById('displayRefLink').innerText = `${baseUrl}?ref=${userData.nickname}`;

        }



        // ... (Sisa logika refresh bonus & draw button tetap sama seperti sebelumnya) ...

        const bonus = await gameContract.getBonusBalance(userAddress);

        document.getElementById('userBonusBalance').innerText = ethers.formatEther(bonus);

        // ... dst (kode lama tetap ada)

        const costFree = ethers.parseEther("10000"); 

        const btnFree = document.getElementById('btnFreeBet');

        if(bonus >= costFree) { btnFree.disabled = false; btnFree.innerText = "Use Bonus Bet (10k SHIB)"; } 

        else { btnFree.disabled = true; btnFree.innerText = "Insufficient Bonus"; }



        let activeCount = 0;

        for(let i=0; i<6; i++) {

            const count = await gameContract.activeTeamCounts(i);

            teamData[i] = Number(count);

            if(teamData[i] > 0) activeCount++;

            const badge = document.getElementById(`count-${i}`);

            badge.innerText = `${teamData[i]}/2`;

            if(teamData[i] >= 2) badge.classList.add('filled'); else badge.classList.remove('filled');

        }

        const btnDraw = document.getElementById('drawBtn');

        const statText = document.getElementById('drawStatus');

        if(activeCount >= 5) {

            btnDraw.disabled = false; btnDraw.classList.add('ready');

            statText.innerText = "BATTLE READY! CLICK TO DRAW!"; statText.classList.add('ready');

        } else {

            btnDraw.disabled = true; btnDraw.classList.remove('ready');

            statText.innerText = `Waiting for players... (${activeCount}/6 Teams Active)`; statText.classList.remove('ready');

        }

    } catch(e) { console.error(e); }

}
    
    async function processPayment(currencyType) {
        if (currentSelectedAnimal.index === -1) return;
        const idx = currentSelectedAnimal.index;
        if(teamData[idx] >= 2) { showToast("Team Full!"); return; }
        closeModal('paymentModal');
        showToast(`Processing ${currencyType} Bet...`);
        try {
            let tx;
            if (currencyType === 'ETH') {
                const val = ethers.parseEther("0.0005");
                tx = await gameContract.betETH(idx, { value: val });
            } else if (currencyType === 'USDT') {
                const amount = ethers.parseUnits("10", 6); 
                await checkApprove(USDT_ADDRESS, amount);
                tx = await gameContract.betToken(idx, 1, false);
            } else if (currencyType === 'SHIB') {
                const amount = ethers.parseEther("110000");
                await checkApprove(SHIB_ADDRESS, amount);
                tx = await gameContract.betToken(idx, 2, false);
            } else if (currencyType === 'FREE') {
                tx = await gameContract.betToken(idx, 2, true);
            }
            showToast("Transaction sent...");
            await tx.wait();
            showToast("Bet Confirmed!");
            refreshGameData();
        } catch (err) { console.error(err); showToast("Bet Failed: " + (err.reason || "Check console")); }
    }

    async function checkApprove(tokenAddr, amountNeeded) {
        const token = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
        const allowance = await token.allowance(userAddress, CONTRACT_ADDRESS);
        if(allowance < amountNeeded) {
            showToast("Approving Token...");
            const tx = await token.approve(CONTRACT_ADDRESS, ethers.MaxUint256);
            await tx.wait();
            showToast("Approved!");
        }
    }

    async function executeDraw() {
        if(!gameContract) return;
        try {
            showToast("Executing Draw...");
            const tx = await gameContract.executeDraw();
            await tx.wait();
            showToast("Draw Complete! Spinning...");
            startSpinAnimation();
            setTimeout(() => { refreshGameData(); showToast("Round Ended! Check Winnings."); }, 35000);
        } catch(err) { showToast("Draw Failed: " + err.reason); }
    }

    function selectAnimal(name, index) {
        currentSelectedAnimal = { name, index };
        for (let i = 0; i < 6; i++) document.getElementById(`card-${i}`).classList.remove('selected');
        document.getElementById(`card-${index}`).classList.add('selected');
    }
    function triggerBetModal() {
        if (!isConnected) { showToast("Connect Wallet First!"); return; }
        if (currentSelectedAnimal.index === -1) { showToast("Select Animal First!"); return; }
        document.getElementById("modalAnimalName").innerText = currentSelectedAnimal.name.toUpperCase();
        document.getElementById('paymentModal').style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function startSpinAnimation() {
        const reels = [document.getElementById('imgReel1'), document.getElementById('imgReel2'), document.getElementById('imgReel3')];
        const imageUrls = Object.values(ITEM_IMAGES);
        reels.forEach((reelImg, i) => {
            let counter = 0;
            const interval = setInterval(() => {
                reelImg.src = imageUrls[Math.floor(Math.random() * imageUrls.length)];
                counter++; if (counter > 10 + (i * 5)) clearInterval(interval);
            }, 100);
        });
    }
    function showToast(msg) {
        const x = document.getElementById("toast");
        x.innerText = msg; x.className = "show";
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
    }
    function checkLocalStorageAuth() { 
        const stored = localStorage.getItem(`auth_${userAddress}`);
        // Auto connect logic if desired
    }
</script>
</body>
</html>
