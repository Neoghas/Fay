<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle V4</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="style.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<style>
:root {
    --purple-main: #6200ff;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --bg-dark: #0b0b12;
    --bg-panel: rgba(15, 15, 30, 0.8);
}

body {
    margin: 0; font-family: "Ubuntu", sans-serif; color: #fff;
    background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
    min-height: 100vh; overflow-x: hidden;
}

/* NAVBAR & WALLET V4 */
.navbar {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 30px; background: rgba(10,10,20,0.8); backdrop-filter: blur(10px);
    position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(120,0,255,0.3);
}
.wallet-btn {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; padding: 10px 20px; border-radius: 12px;
    color: white; font-weight: bold; cursor: pointer;
    display: flex; align-items: center; gap: 10px;
    transition: 0.3s;
}
.wallet-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--blue-main); }
.status-dot { width: 10px; height: 10px; background: #0f0; border-radius: 50%; box-shadow: 0 0 5px #0f0; }

/* MODAL WALLET */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
    display: none; justify-content: center; align-items: center; z-index: 2000;
    opacity: 0; transition: opacity 0.3s;
}
.modal-overlay.show { display: flex; opacity: 1; }

.wallet-modal, .modal {
    background: #151525; border: 1px solid var(--purple-main);
    width: 350px; border-radius: 16px; padding: 20px;
    box-shadow: 0 0 30px rgba(98,0,255,0.3);
    transform: scale(0.9); transition: transform 0.3s;
}
.modal-overlay.show .wallet-modal, .modal-overlay.show .modal { transform: scale(1); }

.user-identity { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
#userAvatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--cyan-main); }
.balance-item { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }
.balance-item img { width: 28px; height: 28px; }
.free-balance-glow { background: rgba(0, 255, 136, 0.1) !important; border: 1px dashed #00ff88; }
.disconnect-btn { width: 100%; padding: 12px; background: rgba(255,50,50,0.1); border: 1px solid #ff5555; color: #ff5555; border-radius: 8px; cursor: pointer; margin-top: 10px;}

/* --- RODA SVG V4 (STYLE BARU) --- */
.donut-wrap {
    position: relative; width: 100%; max-width: 400px;
    aspect-ratio: 1 / 1; margin: 30px auto;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    /* Glow effect untuk roda */
    filter: drop-shadow(0 0 20px rgba(98, 0, 255, 0.3)); 
}
.spin-wheel { width: 100%; height: 100%; display: block; transform-origin: center; }
.donut-pointer {
    position: absolute; top: -15px; left: 50%; transform: translateX(-50%); z-index: 10;
    width: 0; height: 0;
    border-left: 15px solid transparent; border-right: 15px solid transparent;
    border-top: 35px solid var(--cyan-main);
    filter: drop-shadow(0 0 10px var(--cyan-main));
}
.spin-btn {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 90px; height: 90px; border-radius: 50%;
    background: linear-gradient(145deg, var(--pink-main), #4a0072);
    color: #fff; font-weight: bold; display: flex; flex-direction: column;
    align-items: center; justify-content: center; cursor: pointer;
    box-shadow: 0 0 20px rgba(255, 0, 230, 0.5), inset 0 2px 5px rgba(255,255,255,0.3);
    border: 3px solid #fff; z-index: 15; text-align: center; transition: 0.2s;
}
.spin-btn:hover { transform: translate(-50%, -50%) scale(1.05); }
.spin-btn:disabled { background: #333; border-color: #555; cursor: not-allowed; }
.countdown-timer { font-size: 12px; color: var(--cyan-main); margin-top: 4px; }
.winner-glow { filter: drop-shadow(0 0 15px gold); z-index: 5; }

/* GAME UI LAINNYA */
.controls { max-width: 300px; margin: 0 auto; text-align: center; }
.main-btn { width: 100%; padding: 12px; background: linear-gradient(90deg, var(--blue-main), var(--purple-main)); border: 0; border-radius: 10px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; margin-bottom: 10px; }
.status { color: var(--cyan-main); font-size: 14px; min-height: 20px; }

.lists-wrapper { display: flex; gap: 20px; max-width: 800px; margin: 20px auto; flex-wrap: wrap; }
.list-container { flex: 1; min-width: 300px; background: var(--bg-panel); padding: 15px; border-radius: 12px; border: 1px solid rgba(98,0,255,0.2); max-height: 300px; overflow-y: auto; }
.winner-list-item, .bet-list-item { background: rgba(0,0,0,0.3); padding: 8px; margin-bottom: 5px; border-radius: 6px; font-size: 13px; display: flex; justify-content: space-between; }

/* Leaderboard */
.leaderboard-section { max-width: 800px; margin: 40px auto; }
.leaderboard-container { background: var(--bg-panel); border-radius: 12px; padding: 15px; }
.lb-header, .lb-item { display: grid; grid-template-columns: 0.5fr 2fr 1fr 1.5fr; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.lb-header { color: var(--cyan-main); font-weight: bold; }

/* Victory Overlay */
#victory-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 3000; flex-direction: column; }
#victory-overlay.show { display: flex; }
.victory-title { font-size: 4rem; color: gold; text-shadow: 0 0 30px gold; animation: pulse 1s infinite; }
.claim-victory-btn { padding: 15px 40px; background: var(--pink-main); border: 0; color: white; font-size: 18px; cursor: pointer; border-radius: 8px; margin-top: 20px; }

/* Toast */
#toast-container { position: fixed; top: 80px; right: 20px; z-index: 5000; }
.toast-notification { background: #222; color: #fff; padding: 12px 20px; margin-bottom: 10px; border-left: 4px solid var(--blue-main); border-radius: 4px; animation: slideIn 0.3s; }
.toast-notification.error { border-left-color: #ff5555; }
.toast-notification.success { border-left-color: #00ff88; }

@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
</style>
<body>
   <nav class="navbar">
      <div class="navbar-logo">
        <img src="logo.svg" alt="Logo" style="height: 35px; margin-right: 10px; vertical-align: middle;">
        <span>FAYLOTTO V4</span>
      </div>
      <div class="navbar-actions">
          <button class="wallet-btn" id="connectBtn">Connect Wallet</button>
          <button class="wallet-btn" id="connectedBtn" style="display: none;">
              <span id="btnAddress">0x...</span>
              <div class="status-dot"></div>
          </button>
      </div>
   </nav>

   <div id="walletModalOverlay" class="modal-overlay">
        <div class="wallet-modal">
            <div class="modal-header">
                <h3>Wallet Dashboard</h3>
                <button id="closeModalBtn" class="close-btn">&times;</button>
            </div>
            <div class="user-identity">
                <img id="userAvatar" src="" alt="Avatar">
                <div class="user-details">
                    <span class="label">Connected Address</span>
                    <span id="modalAddress" class="address-text">0x00...0000</span>
                </div>
            </div>
            <hr class="divider">
            <div class="balance-section">
                <div class="balance-item">
                    <img src="eth.svg" alt="ETH">
                    <div><span class="token-name">Ethereum (ETH)</span><span id="balETH" class="token-value">0.0000</span></div>
                </div>
                <div class="balance-item">
                    <img src="usdt.svg" alt="USDT">
                    <div><span class="token-name">Tether (USDT)</span><span id="balUSDT" class="token-value">0.00</span></div>
                </div>
                <div class="balance-item">
                    <img src="bb.svg" alt="BabyDoge">
                    <div><span class="token-name">BabyDoge</span><span id="balBaby" class="token-value">0.00</span></div>
                </div>
                <div class="balance-item free-balance-glow">
                    <img src="bb.svg" alt="Free" style="filter: hue-rotate(90deg);">
                    <div><span class="token-name" style="color: #00ff88;">üéÅ Free Balance</span><span id="balFreeBaby" class="token-value" style="color: #00ff88;">0.00</span></div>
                </div>
            </div>
            <button id="disconnectActionBtn" class="disconnect-btn">Disconnect Wallet</button>
        </div>
   </div>

  <section id="hero-section">
    <div class="hero-content">
        <h2 class="hero-title"><span class="highlight-text">Faylotto Spin Battle</span></h2>
        <p class="hero-subtitle">Decentralized PvP Betting. Fair, Automated, & Real-time.</p>
        <div class="pool-info">
            <span>Pool Value: </span><span id="pool-usd-value" style="color:#0f0; font-weight:bold;">$...</span>
        </div>
    </div>
  </section>

  <div class="app-body">
      
      <div class="donut-wrap">
        <div class="donut-pointer"></div>
        <svg id="wheel" class="spin-wheel" viewBox="0 0 500 500">
            </svg>
        <div id="centerBtn" class="spin-btn">
            <span id="centerBtnText">SPIN NOW!</span>
            <div id="countdownTimer" class="countdown-timer">00:00</div>
        </div>
      </div>

      <div class="controls">
          <button id="placeBetBtn" class="main-btn">Place Bet</button>
          <button id="finalizeBtn" class="main-btn" style="display:none;">Finalize Round</button>
          <div class="status" id="statusText">Connect wallet to play</div>
      </div>

      <div class="lists-wrapper">
          <div class="list-container">
              <h3>Current Round Bets</h3>
              <div id="bet-list"><p id="bet-list-placeholder">No bets yet.</p></div>
          </div>
          <div class="list-container">
              <h3>Recent Winners</h3>
              <div id="winner-list"><p id="winner-list-placeholder">Loading...</p></div>
          </div>
      </div>
  </div>

  <div class="modal-overlay" id="bet-modal-overlay">
      <div class="modal" id="bet-modal">
        <div class="modal-header"><h2>Place Your Bet</h2><button class="modal-close-btn" id="bet-modal-close-btn">&times;</button></div>
        <div class="modal-body">
            <div class="input-group">
                <input type="number" id="betAmountInput" placeholder="Amount">
                <select id="betCurrencySelect">
                    <option value="ETH">ETH</option>
                    <option value="USDT">USDT</option>
                    <option value="BABYDOGE">BabyDoge</option>
                </select>
            </div>
            <div class="percent-buttons">
                <button class="percent-btn" data-percent="0.25">25%</button>
                <button class="percent-btn" data-percent="0.50">50%</button>
                <button class="percent-btn" data-percent="1.00">MAX</button>
            </div>
        </div>
        <div class="modal-footer"><button id="confirmBetBtn" class="modal-btn">Confirm Bet</button></div>
      </div>
  </div>

  <section class="leaderboard-section">
    <h2 class="section-title">Top Pilots</h2>
    <div class="leaderboard-container">
        <div class="lb-header"><span>Rank</span><span>Pilot</span><span>Wins</span><span>Rewards</span></div>
        <div id="leaderboard-list"><div class="lb-loading">Loading data...</div></div>
    </div>
  </section>

  <div id="victory-overlay">
      <div class="victory-content">
          <h1 class="victory-title">YOU WIN!</h1>
          <button class="claim-victory-btn" onclick="hideVictoryScreen()">CONTINUE</button>
      </div>
  </div>

  <div id="toast-container"></div>

  <audio id="sfx-click" src="clickI.mp3"></audio>
  <audio id="sfx-spin" src="spinI.mp3"></audio>
  <audio id="sfx-win" src="winI.mp3"></audio>
  <audio id="sfx-coin" src="coin.mp3"></audio>

<script>
    // ==========================================
// 1. KONFIGURASI & KONSTANTA (V4)
// ==========================================
const BASE_SEPOLIA_ID = 84532; // Chain ID (Decimal)
const BASE_SEPOLIA_ID_HEX = '0x14a34';
const RPC_URL = "https://sepolia.base.org";
const EXPLORER_URL = "https://sepolia.basescan.org";

// ALAMAT KONTRAK (Sesuaikan!)
const FAYLOTTO_ADDRESS = "0x610a4cd49D9ca1d6d8d816A12EFc02A57f215268";
const ADDR_USDT = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2";
const ADDR_BABYDOGE = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45"; 
const ETH_USD_PRICE_FEED = "0x4aDC67696bA383F43DD60A9e78F2C97Fbbfc7cb1";

// ABI (Isi dengan ABI lengkap Anda!)
const USDT_ABI = [
    "function balanceOf(address owner) view returns (uint256)",
    "function decimals() view returns (uint8)",
    "function approve(address spender, uint256 amount) returns (bool)",
    "function allowance(address owner, address spender) view returns (uint256)"
];
// Tambahkan fungsi getWinners, freeBalances, dll ke ABI ini
const FAYLOTTO_ABI = [
    "function currentRoundId() view returns (uint256)",
    "function getRoundBasic(uint256 rid) view returns (uint256, uint256, uint256, bool, address, uint256, uint256, uint256, uint256, uint256)",
    "function getRoundPlayers(uint256 rid) view returns (address[])",
    "function getPlayerDeposits(uint256 rid, address player) view returns (uint256, uint256, uint256, uint256)",
    "function placeBetNative() payable",
    "function placeBetUSDT(uint256 amount)",
    "function placeBetBabyDoge(uint256 amount)",
    "function finalizeRound(uint256 rid)",
    "function getWinners(uint256 count) view returns (tuple(uint256 winnerId, uint256 roundId, address winner, uint256 rewardETH, uint256 rewardUSDT, uint256 rewardBabyDoge, uint256 timestamp)[])",
    "function freeBalances(address user) view returns (uint256)",
    "function nicknames(address user) view returns (string)",
    "function getLikeCount(uint256 winnerId) view returns (uint256)",
    "function getRatingCountForWinner(uint256 winnerId) view returns (uint256)",
    "function getCommentCountForWinner(uint256 winnerId) view returns (uint256)",
    "event BetNative(uint256 indexed roundId, address indexed player, uint256 amount, uint256 usdWeight)",
    "event BetUSDT(uint256 indexed roundId, address indexed player, uint256 amount, uint256 usdWeight)",
    "event BetBabyDoge(uint256 indexed roundId, address indexed player, uint256 amount, uint256 usdWeight)",
    "event WinnerRecorded(uint256 indexed winnerId, uint256 roundId, address indexed winner, uint256 rewardETH, uint256 rewardUSDT, uint256 rewardBabyDoge, uint256 timestamp)"
];

const SESSION_KEY = "faylotto_v4_session";
const PLAYER_COLORS = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#F9D423", "#FFA62B", "#7B72E9", "#3DCC91", "#FF90B3", "#C0E218", "#3498DB"];

// STATE GLOBAL
let provider, signer, userAddress;
let faylottoContract, usdtContract, babyDogeContract;
let currentRoundId, currentRoundEndTime = 0;
let players = {}, playersArray = [];
let isSpinning = false, isFinalizing = false;
let visualTimer = null;

// === 2. INISIALISASI & EVENT LISTENERS ===
document.addEventListener("DOMContentLoaded", async () => {
    console.log("üöÄ Faylotto V4 Initializing...");

    // 1. Init Provider Read-Only (Agar data tampil walau belum connect)
    provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    usdtContract = new ethers.Contract(ADDR_USDT, USDT_ABI, provider);
    babyDogeContract = new ethers.Contract(ADDR_BABYDOGE, USDT_ABI, provider);

    // 2. Cek Sesi Wallet
    const savedSession = localStorage.getItem(SESSION_KEY);
    if (savedSession) {
        const session = JSON.parse(savedSession);
        if (Date.now() < session.expiry) {
            console.log("‚ôªÔ∏è Auto-connect session...");
            await connectWallet(true); // Silent connect
        } else {
            localStorage.removeItem(SESSION_KEY);
        }
    }

    // 3. Render Awal
    drawSVGWheel();
    fetchAndDisplayRoundData();
    fetchAndDisplayWinners();
    fetchLeaderboard(); // Opsional jika ada logicnya
    setupEventListeners(); // Listener kontrak

    // 4. Event Listeners UI
    document.getElementById("connectBtn").addEventListener("click", () => connectWallet(false));
    document.getElementById("connectedBtn").addEventListener("click", showModal);
    document.getElementById("closeModalBtn").addEventListener("click", hideModal);
    document.getElementById("walletModalOverlay").addEventListener("click", (e) => { if(e.target.id === "walletModalOverlay") hideModal(); });
    document.getElementById("disconnectActionBtn").addEventListener("click", disconnectWallet);
    
    // Bet & Game Controls
    document.getElementById("placeBetBtn").addEventListener("click", showBetModal);
    document.getElementById("finalizeBtn").addEventListener("click", callFinalizeRound);
    document.getElementById("bet-modal-close-btn").addEventListener("click", () => document.getElementById("bet-modal-overlay").classList.remove("show"));
    document.getElementById("confirmBetBtn").addEventListener("click", confirmBet);
    
    // Tombol Tengah (Multifungsi)
    document.getElementById("centerBtn").addEventListener("click", async () => {
        if (!isFinalizing) showBetModal();
        else await callFinalizeRound();
    });
});

// === 3. WALLET LOGIC V4 (SESSION + SIGNATURE) ===
async function connectWallet(isSilent) {
    if (!window.ethereum) { if(!isSilent) alert("Install MetaMask!"); return; }
    try {
        // Gunakan Web3Provider (Ethers v5) agar kompatibel dengan kode game
        const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // Force Network
        await enforceBaseSepolia(web3Provider);

        await web3Provider.send("eth_requestAccounts", []);
        const _signer = web3Provider.getSigner();
        const _addr = await _signer.getAddress();

        // Signature (Hanya jika bukan silent)
        if (!isSilent) {
            const msg = `Welcome to Faylotto V4!\nUser: ${_addr}\nTime: ${new Date().toLocaleString()}`;
            try {
                const sig = await _signer.signMessage(msg);
                const expiry = Date.now() + (7 * 24 * 3600 * 1000);
                localStorage.setItem(SESSION_KEY, JSON.stringify({ address: _addr, signature: sig, expiry: expiry }));
            } catch (e) { return; } // Batal jika tolak sign
        }

        // Set Global State
        provider = web3Provider;
        signer = _signer;
        userAddress = _addr;
        
        // Re-init Contract dengan Signer
        faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, signer);
        usdtContract = new ethers.Contract(ADDR_USDT, USDT_ABI, signer);
        babyDogeContract = new ethers.Contract(ADDR_BABYDOGE, USDT_ABI, signer);

        updateUIConnected();
        fetchBalances();
        setupEventListeners(); // Re-setup dengan provider baru

    } catch (err) { console.error(err); }
}

async function enforceBaseSepolia(prov) {
    const { chainId } = await prov.getNetwork();
    if (chainId !== BASE_SEPOLIA_ID) {
        try {
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_SEPOLIA_ID_HEX }] });
        } catch (err) {
            if (err.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: BASE_SEPOLIA_ID_HEX,
                        chainName: 'Base Sepolia',
                        rpcUrls: [RPC_URL],
                        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                        blockExplorerUrls: [EXPLORER_URL]
                    }]
                });
            }
        }
        // Reload halaman disarankan setelah ganti network untuk reset state provider
        window.location.reload();
    }
}

async function fetchBalances() {
    if (!userAddress) return;
    // ETH
    const ethBal = await provider.getBalance(userAddress);
    document.getElementById("balETH").innerText = parseFloat(ethers.utils.formatEther(ethBal)).toFixed(4);
    
    // Helper ERC20
    const getBal = async (ct, el) => {
        try {
            const b = await ct.balanceOf(userAddress);
            const d = await ct.decimals(); // Asumsi decimals() standar
            document.getElementById(el).innerText = parseFloat(ethers.utils.formatUnits(b, d)).toFixed(2);
        } catch(e) { document.getElementById(el).innerText = "0.00"; }
    };
    await getBal(usdtContract, "balUSDT");
    await getBal(babyDogeContract, "balBaby");

    // Free Balance (V4 Feature)
    try {
        const free = await faylottoContract.freeBalances(userAddress);
        // Asumsi BabyDoge 18 decimals jika gagal ambil dari main contract
        let dec = 18; 
        document.getElementById("balFreeBaby").innerText = parseFloat(ethers.utils.formatUnits(free, dec)).toLocaleString();
    } catch(e) { console.warn("Free balance err", e); }
}

function updateUIConnected() {
    document.getElementById("connectBtn").style.display = "none";
    const btn = document.getElementById("connectedBtn");
    btn.style.display = "flex";
    document.getElementById("btnAddress").innerText = userAddress.slice(0,6)+"..."+userAddress.slice(-4);
    document.getElementById("modalAddress").innerText = userAddress;
    document.getElementById("userAvatar").src = `https://api.dicebear.com/9.x/bottts/svg?seed=${userAddress}`;
}

function disconnectWallet() {
    localStorage.removeItem(SESSION_KEY);
    window.location.reload();
}

// === 4. RODA SVG + GSAP (V4 CORE) ===
const svgWheel = document.getElementById('wheel');
const viewBoxSize = 500;
const svgCx = 250, svgCy = 250, svgOuterR = 225, svgInnerR = 90;

function drawSVGWheel() {
    svgWheel.innerHTML = ''; // Reset
    if (playersArray.length === 0) {
        // Gambar kosong
        const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
        txt.setAttribute("x", 250); txt.setAttribute("y", 250);
        txt.setAttribute("text-anchor", "middle"); txt.setAttribute("dominant-baseline", "middle");
        txt.setAttribute("fill", "#fff"); txt.textContent = "No Bets";
        svgWheel.appendChild(txt);
        return;
    }

    let currentAngle = 0;
    // Total Weight V3 (BigNumber)
    let totalW = ethers.BigNumber.from(0);
    playersArray.forEach(p => totalW = totalW.add(p.weight));

    playersArray.forEach(p => {
        if (totalW.eq(0)) return;
        // Hitung sudut slice
        // (weight / total) * 360
        // Gunakan number untuk drawing (presisi visual tidak perlu BigNumber persis)
        const share = parseFloat(ethers.utils.formatEther(p.weight)) / parseFloat(ethers.utils.formatEther(totalW));
        const sliceAngle = share * 360;
        
        const startAngle = currentAngle;
        const endAngle = currentAngle + sliceAngle;

        // Gambar Path (Slice)
        const x1 = svgCx + svgOuterR * Math.cos((startAngle - 90) * Math.PI / 180);
        const y1 = svgCy + svgOuterR * Math.sin((startAngle - 90) * Math.PI / 180);
        const x2 = svgCx + svgOuterR * Math.cos((endAngle - 90) * Math.PI / 180);
        const y2 = svgCy + svgOuterR * Math.sin((endAngle - 90) * Math.PI / 180);
        
        const largeArc = sliceAngle > 180 ? 1 : 0;
        
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const d = `M ${svgCx} ${svgCy} L ${x1} ${y1} A ${svgOuterR} ${svgOuterR} 0 ${largeArc} 1 ${x2} ${y2} Z`;
        path.setAttribute("d", d);
        path.setAttribute("fill", p.color);
        path.setAttribute("stroke", "#0b0b12");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("data-player", p.id);
        path.classList.add("wheel-slice");
        svgWheel.appendChild(path);

        // Gambar Avatar (Tengah Slice)
        const midA = startAngle + sliceAngle / 2;
        const imgX = svgCx + (svgOuterR * 0.65) * Math.cos((midA - 90) * Math.PI / 180) - 15;
        const imgY = svgCy + (svgOuterR * 0.65) * Math.sin((midA - 90) * Math.PI / 180) - 15;
        
        const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
        img.setAttributeNS("http://www.w3.org/1999/xlink", "href", `https://api.dicebear.com/9.x/bottts/svg?seed=${p.id}`);
        img.setAttribute("x", imgX); img.setAttribute("y", imgY);
        img.setAttribute("width", "30"); img.setAttribute("height", "30");
        svgWheel.appendChild(img);

        currentAngle = endAngle;
    });

    // Lubang Tengah
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", 250); circle.setAttribute("cy", 250);
    circle.setAttribute("r", svgInnerR); circle.setAttribute("fill", "#0b0b12"); // Warna background
    svgWheel.appendChild(circle);
}

function spinWheelGSAP(winnerAddr) {
    if (gsap.isTweening(svgWheel)) return;
    playSound('sfx-spin');
    
    // Cari posisi pemenang
    let targetAngle = 0;
    let totalW = ethers.BigNumber.from(0);
    playersArray.forEach(p => totalW = totalW.add(p.weight));
    
    let currentCumulative = 0;
    let found = false;

    for(let p of playersArray) {
        const share = parseFloat(ethers.utils.formatEther(p.weight)) / parseFloat(ethers.utils.formatEther(totalW));
        const slice = share * 360;
        if (p.id.toLowerCase() === winnerAddr.toLowerCase()) {
            targetAngle = currentCumulative + (slice / 2); // Tengah slice
            found = true;
            break;
        }
        currentCumulative += slice;
    }
    
    if (!found) targetAngle = Math.random() * 360; // Fallback

    // Animasi: Putar minimal 5x (1800 deg) + target
    // Target rotasi harus dikurangi dari 360 karena rotasi searah jarum jam, 
    // sedangkan sudut SVG dihitung searah jarum jam dari jam 12.
    // Agar "Winning Slice" ada di ATAS (jam 12), kita putar roda sedemikian rupa.
    const rotation = (3600) + (360 - targetAngle); 

    gsap.to(svgWheel, {
        rotation: rotation,
        duration: 8,
        ease: "power4.inOut",
        onComplete: () => {
            playSound('sfx-win');
            // Highlight Winner Slice
            const slice = svgWheel.querySelector(`path[data-player="${winnerAddr}"]`);
            if(slice) slice.classList.add("winner-glow");
            
            showVictoryScreen();
            
            setTimeout(() => {
                resetRoundUI(); // Bersihkan untuk ronde baru
                if(slice) slice.classList.remove("winner-glow");
                gsap.set(svgWheel, { rotation: 0 });
            }, 5000);
        }
    });
}

// === 5. GAME LOGIC (V3) ===
async function fetchAndDisplayRoundData() {
    if (!faylottoContract) return;
    try {
        document.getElementById("statusText").innerText = "Syncing...";
        currentRoundId = await faylottoContract.currentRoundId();
        const info = await faylottoContract.getRoundBasic(currentRoundId);
        
        // Info[2] = endTime
        const endTime = info[2].toNumber() * 1000;
        startTimer(endTime);

        // Load Players
        players = {}; playersArray = []; // Reset State Lokal
        const playerAddrs = await faylottoContract.getRoundPlayers(currentRoundId);
        
        // Reset Total Pool UI
        let ethP = ethers.utils.formatEther(info[5]);
        let usdtP = ethers.utils.formatUnits(info[6], 6);
        document.getElementById("pool-usd-value").innerText = `${ethP} ETH + ${usdtP} USDT`;

        for (let addr of playerAddrs) {
            const dep = await faylottoContract.getPlayerDeposits(currentRoundId, addr);
            // dep: [eth, usdt, baby, weight]
            addPlayerLocally(addr, dep[0], dep[1], dep[2], dep[3]);
        }
        drawSVGWheel();
        updateBetList();

    } catch(e) { console.error("Sync Error", e); }
}

function addPlayerLocally(addr, eth, usdt, baby, weight) {
    const key = addr.toLowerCase();
    if (!players[key]) {
        players[key] = {
            id: addr,
            eth: eth, usdt: usdt, baby: baby, weight: weight,
            color: PLAYER_COLORS[Object.keys(players).length % 10]
        };
    } else {
        // Update jika sudah ada (misal user nambah bet)
        players[key].eth = eth; players[key].weight = weight; 
    }
    // Update Array untuk SVG
    playersArray = Object.values(players).sort((a, b) => b.weight.sub(a.weight));
}

function startTimer(end) {
    if (visualTimer) clearInterval(visualTimer);
    visualTimer = setInterval(() => {
        const left = end - Date.now();
        if (left <= 0) {
            document.getElementById("countdownTimer").innerText = "00:00";
            document.getElementById("centerBtnText").innerText = "FINALIZE";
            document.getElementById("finalizeBtn").style.display = "block";
            document.getElementById("placeBetBtn").style.display = "none";
            isFinalizing = true;
            clearInterval(visualTimer);
        } else {
            const m = Math.floor(left/60000);
            const s = Math.floor((left%60000)/1000);
            document.getElementById("countdownTimer").innerText = `${m}:${s<10?'0':''}${s}`;
            isFinalizing = false;
        }
    }, 1000);
}

// Betting
function showBetModal() { document.getElementById("bet-modal-overlay").classList.add("show"); }
async function confirmBet() {
    if (!signer) return alert("Connect Wallet!");
    const amt = document.getElementById("betAmountInput").value;
    const curr = document.getElementById("betCurrencySelect").value;
    if(!amt) return;

    const btn = document.getElementById("confirmBetBtn");
    btn.innerText = "Processing..."; btn.disabled = true;

    try {
        let tx;
        if (curr === 'ETH') {
            tx = await faylottoContract.placeBetNative({ value: ethers.utils.parseEther(amt) });
        } else if (curr === 'USDT') {
            // Cek Allowance dulu (Simplified)
            const allow = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
            const amountWei = ethers.utils.parseUnits(amt, 6);
            if (allow.lt(amountWei)) {
                const approveTx = await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
                await approveTx.wait();
            }
            tx = await faylottoContract.placeBetUSDT(amountWei);
        } else {
             // BabyDoge Logic similar to USDT
             const amountWei = ethers.utils.parseUnits(amt, 18);
             const allow = await babyDogeContract.allowance(userAddress, FAYLOTTO_ADDRESS);
             if (allow.lt(amountWei)) {
                const atx = await babyDogeContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
                await atx.wait();
             }
             tx = await faylottoContract.placeBetBabyDoge(amountWei);
        }
        await tx.wait();
        playSound('sfx-coin');
        document.getElementById("bet-modal-overlay").classList.remove("show");
        fetchBalances(); // Update saldo
    } catch(e) { 
        alert("Transaksi Gagal: " + (e.reason || e.message)); 
    } finally {
        btn.innerText = "Confirm Bet"; btn.disabled = false;
    }
}

// Finalize
async function callFinalizeRound() {
    if(!signer) return;
    const btn = document.getElementById("finalizeBtn");
    btn.disabled = true; btn.innerText = "Finalizing...";
    try {
        const tx = await faylottoContract.finalizeRound(currentRoundId);
        await tx.wait();
        // Event listener akan menangkap WinnerRecorded dan memutar roda
    } catch(e) {
        alert("Finalize Failed");
        btn.disabled = false; btn.innerText = "Finalize Round";
    }
}

// Event Listeners (V3 Fix)
function setupEventListeners() {
    if (!faylottoContract) return;
    faylottoContract.removeAllListeners();

    faylottoContract.on("BetNative", () => { fetchAndDisplayRoundData(); });
    faylottoContract.on("BetUSDT", () => { fetchAndDisplayRoundData(); });
    faylottoContract.on("BetBabyDoge", () => { fetchAndDisplayRoundData(); });
    
    faylottoContract.on("WinnerRecorded", (wid, rid, winner) => {
        if (rid.eq(currentRoundId) && !isSpinning) {
            isSpinning = true;
            spinWheelGSAP(winner);
        }
    });
}

// Helpers UI
function updateBetList() {
    const list = document.getElementById("bet-list");
    list.innerHTML = "";
    if(playersArray.length === 0) { list.innerHTML = "<p>No Bets</p>"; return; }
    playersArray.forEach(p => {
        const div = document.createElement("div");
        div.className = "bet-list-item";
        div.innerHTML = `<span>${p.id.slice(0,6)}...</span><span>${parseFloat(ethers.utils.formatEther(p.weight)).toFixed(2)} Weight</span>`;
        div.style.borderLeft = `3px solid ${p.color}`;
        list.appendChild(div);
    });
}

function fetchAndDisplayWinners() {
    // Implementasi getWinners Anda sebelumnya
    // Panggil getWinners dari kontrak, loop, dan render ke winner-list
    // (Disederhanakan untuk brevity, pakai logika V3 Anda yang sudah fix)
}

function fetchLeaderboard() {
    // Logic leaderboard V3
}

function playSound(id) { document.getElementById(id).currentTime=0; document.getElementById(id).play().catch(()=>{}); }
function showModal() { document.getElementById("walletModalOverlay").classList.add("show"); fetchBalances(); }
function hideModal() { document.getElementById("walletModalOverlay").classList.remove("show"); }
function showVictoryScreen() { document.getElementById("victory-overlay").classList.add("show"); }
function hideVictoryScreen() { document.getElementById("victory-overlay").classList.remove("show"); }
function resetRoundUI() {
    isSpinning = false; isFinalizing = false;
    players = {}; playersArray = [];
    drawSVGWheel();
    fetchAndDisplayRoundData();
    document.getElementById("pool-usd-value").innerText = "$...";
            }
</script>

  <script src="app.js"></script>
</body>
</html>
