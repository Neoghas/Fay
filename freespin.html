<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Wheel</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.6.4/dist/ethers.umd.min.js"></script>
<style>
  body {
    background: radial-gradient(circle, #111 0%, #000 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    overflow: hidden;
  }

  /* Wallet Buttons */
  .wallet-controls {
    position: absolute;
    top: 25px;
    right: 25px;
    display: flex;
    flex-direction: row;
    gap: 10px;
  }

  .wallet-btn {
    background: linear-gradient(145deg, #00b4d8, #0077b6);
    border: none;
    border-radius: 10px;
    color: #fff;
    font-weight: bold;
    padding: 10px 18px;
    cursor: pointer;
    transition: 0.2s;
  }

  .wallet-btn:hover {
    transform: scale(1.05);
    background: linear-gradient(145deg, #48cae4, #0096c7);
  }

  .wallet-address {
    background: #222;
    border-radius: 10px;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: bold;
    color: #0ff;
    border: 1px solid #0ff;
  }

  .wheel-container {
    position: relative;
    width: 350px;
    height: 350px;
  }

  svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  #centerBtn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 85px;
    height: 85px;
    border-radius: 50%;
    background: linear-gradient(145deg, #FFD700, #FFA500);
    color: black;
    font-weight: bold;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6),
      inset 0 2px 4px rgba(255, 255, 255, 0.3);
    border: 3px solid #fff;
    transition: all 0.2s ease;
    z-index: 15;
  }

  #centerBtn:hover {
    transform: translate(-50%, -50%) scale(1.05);
  }

  #centerBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .result {
    margin-top: 30px;
    font-size: 20px;
    text-align: center;
    transition: all 0.5s ease;
    min-height: 30px;
  }

  .glow {
    filter: drop-shadow(0 0 15px gold);
  }
</style>
</head>

<body>
  <div class="wallet-controls">
    <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
    <button id="disconnectBtn" class="wallet-btn" style="display:none;">Disconnect</button>
    <div id="walletAddress" class="wallet-address" style="display:none;">-</div>
  </div>

  <div class="wheel-container">
    <div class="pointer"></div>
    <svg id="wheel" viewBox="0 0 500 500"></svg>
    <div id="centerBtn">FREE<br>SPIN</div>
  </div>
  <div class="result" id="resultText">Press SPIN to play</div>

  <audio id="clickSound" src="click.mp3" preload="auto"></audio>
  <audio id="spinSound" src="spin.mp3" preload="auto" loop></audio>
  <audio id="winSound" src="win.mp3" preload="auto"></audio>

<script>
// === CONTRACT ===
const CONTRACT_ADDRESS = "0x34A7A5ae92EF62e7F6845a6f9f780958537e3ff2";
const ABI = [{"inputs":[{"internalType":"address","name":"_erc20Token","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetERC20","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_BETS_PER_PLAYER","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20Token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"erc20Reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalERC20","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getWinnerCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsERC20","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];
  
let provider, signer, contract, userAddress;  
const btn = document.getElementById("centerBtn");  
const connectBtn = document.getElementById("connectBtn");  
const disconnectBtn = document.getElementById("disconnectBtn");  
const walletAddressDiv = document.getElementById("walletAddress");  
const resultText = document.getElementById("resultText");  
const clickSound = document.getElementById("clickSound");  
const spinSound = document.getElementById("spinSound");  
const winSound = document.getElementById("winSound");  
const svg = document.getElementById("wheel");  
  
const prizes = [  
  { name: "10.000.000", icon: "bb.svg"},  
  { name: "5.000.000", icon: "bb.svg"},  
  { name: "8.500.000", icon: "bb.svg"},  
  { name: "No Prize", icon: "no.png"},  
  { name: "9.000.000", icon: "bb.svg"},
  { name: "1.000.000", icon: "bb.svg"},
  { name: "6.500.000", icon: "bb.svg"},    
  { name: "7.500.000", icon: "bb.svg"},  
  { name: "Try again", icon: "again.png"}  
];  
  
const colors = [  
  "#FFB703","#FB8500","#219EBC","#8ECAE6","#FF69B4","#90EE90",  
  "#FFD700","#ff9f00","#40E0D0"  
];  
  
const radius = 240, cx = 250, cy = 250, total = prizes.length, slice = 360 / total;  
  
// Render wheel dengan icon & teks  
for (let i = 0; i < total; i++) {  
  const startAngle = (i * slice - 90) * Math.PI / 180;  
  const endAngle = ((i + 1) * slice - 90) * Math.PI / 180;  
  const x1 = cx + radius * Math.cos(startAngle);  
  const y1 = cy + radius * Math.sin(startAngle);  
  const x2 = cx + radius * Math.cos(endAngle);  
  const y2 = cy + radius * Math.sin(endAngle);  
  
  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");  
  path.setAttribute("d", `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 0 1 ${x2} ${y2} Z`);  
  path.setAttribute("fill", colors[i]);  
  path.setAttribute("stroke", "#fff");  
  path.setAttribute("stroke-width", "2");  
  svg.appendChild(path);  
  prizes[i].path = path;  
  
  const angle = (i + 0.5) * slice - 90;  
  
  // icon  
  const img = document.createElementNS("http://www.w3.org/2000/svg", "image");  
  const imgX = cx + radius * 0.55 * Math.cos(angle * Math.PI / 180) - 20;  
  const imgY = cy + radius * 0.55 * Math.sin(angle * Math.PI / 180) - 20;  
  img.setAttributeNS("http://www.w3.org/1999/xlink", "href", prizes[i].icon);  
  img.setAttribute("x", imgX);  
  img.setAttribute("y", imgY);  
  img.setAttribute("width", "40");  
  img.setAttribute("height", "40");  
  svg.appendChild(img);  
  
  // teks  
  const text = document.createElementNS("http://www.w3.org/2000/svg", "text");  
  const textX = cx + radius * 0.8 * Math.cos(angle * Math.PI / 180);  
  const textY = cy + radius * 0.8 * Math.sin(angle * Math.PI / 180);  
  text.setAttribute("x", textX);  
  text.setAttribute("y", textY);  
  text.setAttribute("fill", "#fff");  
  text.setAttribute("font-size", "15");  
  text.setAttribute("font-weight", "bold");  
  text.setAttribute("text-anchor", "middle");  
  text.setAttribute("alignment-baseline", "middle");  
  text.setAttribute("transform", `rotate(${angle}, ${textX}, ${textY})`);  
  text.textContent = prizes[i].name;  
  svg.appendChild(text);  
}  
  
let spinning = false, currentRotation = 0, animation = null;  

// === ANIMASI FUTURISTIK PEMENANG (VERSI LEBIH HIDUP) ===
function glowWinnerSector(winnerIndex) {
  const sector = prizes[winnerIndex].path;
  if (!sector) return;

  // Tambahkan glow biru elektrik
  sector.style.filter = "drop-shadow(0 0 25px #00ffff) drop-shadow(0 0 50px #00ffff)";
  sector.style.stroke = "#00ffff";
  sector.style.strokeWidth = "3";

  // === Efek denyut + getar cepat ===
  gsap.to(sector, {
    scale: 1.08,
    rotation: "+=1",
    transformOrigin: "50% 50%",
    duration: 0.3,
    repeat: -1,
    yoyo: true,
    ease: "sine.inOut"
  });

  // === Efek kilatan cahaya yang menyapu area pemenang ===
  const lightSweep = document.createElementNS("http://www.w3.org/2000/svg", "rect");
  lightSweep.setAttribute("x", 0);
  lightSweep.setAttribute("y", 0);
  lightSweep.setAttribute("width", radius * 2);
  lightSweep.setAttribute("height", radius * 2);
  lightSweep.setAttribute("fill", "url(#lightGradient)");
  lightSweep.style.mixBlendMode = "screen";
  svg.appendChild(lightSweep);

  // Gradient animasi cahaya
  const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
  defs.innerHTML = `
    <linearGradient id="lightGradient">
      <stop offset="0%" stop-color="rgba(0,255,255,0)" />
      <stop offset="50%" stop-color="rgba(0,255,255,0.5)" />
      <stop offset="100%" stop-color="rgba(0,255,255,0)" />
    </linearGradient>
  `;
  svg.prepend(defs);

  gsap.fromTo(
    lightSweep,
    { rotation: 0, transformOrigin: "50% 50%", opacity: 0.4 },
    {
      rotation: 360,
      transformOrigin: "50% 50%",
      duration: 2,
      repeat: -1,
      ease: "none",
      opacity: 0.7
    }
  );

  // === Efek gelombang energi keluar dari tengah ===
  const energyPulse = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  energyPulse.setAttribute("cx", cx);
  energyPulse.setAttribute("cy", cy);
  energyPulse.setAttribute("r", 0);
  energyPulse.setAttribute("stroke", "#00ffff");
  energyPulse.setAttribute("stroke-width", "2");
  energyPulse.setAttribute("fill", "none");
  svg.appendChild(energyPulse);

  gsap.to(energyPulse, {
    r: radius + 30,
    opacity: 0,
    duration: 1.5,
    repeat: 3,
    ease: "power2.out",
    onComplete: () => energyPulse.remove()
  });

  // === Hapus efek setelah 6 detik ===
  setTimeout(() => {
    gsap.killTweensOf(sector);
    gsap.killTweensOf(lightSweep);
    lightSweep.remove();
    sector.style.filter = "";
    sector.style.stroke = "#fff";
    sector.style.strokeWidth = "1";
    gsap.to(sector, { scale: 1, rotation: 0, duration: 0.3 });
  }, 6000);
}

// === FUNGSI SPIN (contoh integrasi dengan efek di atas) ===
async function spinWheel() {
  if (spinning) return;
  spinning = true;
  spinSound.play();

  // Pilih pemenang acak
  const winnerIndex = Math.floor(Math.random() * total);
  const sliceAngle = 360 / total;
  const randomExtra = 360 * 5; // 5 putaran ekstra
  const finalRotation = randomExtra + (360 - (winnerIndex * sliceAngle + sliceAngle / 2));

  // Animasi putaran utama
  gsap.to(svg, {
    rotation: finalRotation,
    duration: 5,
    ease: "power4.out",
    onUpdate: () => clickSound.play(),
    onComplete: () => {
      spinning = false;
      winSound.play();
      const winner = prizes[winnerIndex];
      resultText.textContent = `üéâ Anda menang: ${winner.name}! üéâ`;

      // Efek futuristik di sektor pemenang
      glowWinnerSector(winnerIndex);
    }
  });
}
  
// Base Sepolia constants
const BASE_SEPOLIA = {
  chainIdHex: '0x14a34', // 84532
  chainIdDec: 84532,
  chainName: 'Base Sepolia',
  rpcUrls: ['https://sepolia.base.org'],
  nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
  blockExplorerUrls: ['https://sepolia.basescan.org']
};

// === Fungsi utilitas ===
function shortAddress(addr) {
  return addr ? addr.slice(0, 6) + "..." + addr.slice(-4) : "";
}

function hasEthereum() {
  return typeof window !== 'undefined' && !!window.ethereum;
}

function getLocalDateTimeString() {
  return new Date().toLocaleString();
}

// === Signature cache ===
function saveSignature(wallet, signature) {
  const expires = Date.now() + 7 * 24 * 60 * 60 * 1000; // 7 hari
  localStorage.setItem('walletSignature', JSON.stringify({ wallet, signature, expires }));
}

function getSignature() {
  const data = JSON.parse(localStorage.getItem('walletSignature') || '{}');
  if (!data.expires || Date.now() > data.expires) {
    localStorage.removeItem('walletSignature');
    return null;
  }
  return data;
}

// === Fungsi pastikan jaringan Base Sepolia (otomatis) ===
async function ensureBaseSepolia() {
  if (!hasEthereum()) throw new Error("no_ethereum");

  const chainId = await window.ethereum.request({ method: 'eth_chainId' });
  if (chainId === BASE_SEPOLIA.chainIdHex) return true;

  try {
    // Coba switch dulu
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: BASE_SEPOLIA.chainIdHex }]
    });
    return true;
  } catch (err) {
    if (err.code === 4902) {
      // Kalau belum ada, tambahkan
      await window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [BASE_SEPOLIA]
      });
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: BASE_SEPOLIA.chainIdHex }]
      });
      return true;
    } else {
      throw err;
    }
  }
}

// === Fungsi utama: connect wallet ===
async function connectWallet() {
  try {
    if (!hasEthereum()) {
      alert("ü¶ä Silakan instal MetaMask terlebih dahulu.");
      return;
    }

    // Otomatis pastikan jaringan Base Sepolia
    await ensureBaseSepolia();

    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();

    const network = await provider.getNetwork();
    if (network.chainId !== BASE_SEPOLIA.chainIdDec) {
      console.warn("Jaringan bukan Base Sepolia, mencoba ganti otomatis...");
      await ensureBaseSepolia();
    }

    // === Signature otomatis ===
    const stored = getSignature();
    let signature;
    if (stored && stored.wallet.toLowerCase() === userAddress.toLowerCase()) {
      signature = stored.signature;
      console.log("ü™™ Cached signature:", signature);
    } else {
      const message = `welcome ${userAddress} ${getLocalDateTimeString()}`;
      signature = await signer.signMessage(message);
      saveSignature(userAddress, signature);
      console.log("ü™™ Signed message:", message);
    }

    // Inisialisasi kontrak
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    // Update UI
    connectBtn.style.display = "none";
    disconnectBtn.style.display = "inline-block";
    walletAddressDiv.style.display = "inline-block";
    walletAddressDiv.textContent = shortAddress(userAddress);

    // Listener otomatis
    window.ethereum.on('accountsChanged', (accounts) => {
      if (!accounts.length) disconnectWallet();
      else {
        userAddress = accounts[0];
        walletAddressDiv.textContent = shortAddress(userAddress);
      }
    });

    window.ethereum.on('chainChanged', async (chainIdHex) => {
      if (chainIdHex !== BASE_SEPOLIA.chainIdHex) {
        console.log("‚õìÔ∏è Jaringan berubah, mencoba kembali ke Base Sepolia...");
        await ensureBaseSepolia();
      }
    });

  } catch (err) {
    console.error("connectWallet error:", err);
  }
}

// === Fungsi disconnect ===
function disconnectWallet() {
  provider = signer = contract = userAddress = null;
  connectBtn.style.display = "inline-block";
  disconnectBtn.style.display = "none";
  walletAddressDiv.style.display = "none";
}
  
async function spinFromBlockchain({ method = "spinGratis", amount = null } = {}) {
  // method: "placeBetBabyDoge" | "placeBetDummy" | "spinGratis"
  if (!contract || !signer) return alert("‚ö†Ô∏è Connect your wallet first!");
  try {
    btn.disabled = true;
    clickSound && clickSound.play();
    resultText.textContent = "‚è≥ Waiting for blockchain...";
    spinSound && (spinSound.currentTime = 0, spinSound.play());

    // helper: build prize amount -> index map (normalize names like "10.000.000" => 10000000)
    const prizeMap = {};
    prizes.forEach((p, idx) => {
      const n = parseInt((p.name || "").toString().replace(/\./g, "").replace(/,/g, ""));
      if (!Number.isNaN(n)) prizeMap[n] = idx;
    });

    let tx;
    if (method === "placeBetBabyDoge") {
      if (!amount) throw new Error("amount required for placeBetBabyDoge");
      // Ensure approval: amount should be BigInt or string in token base units
      if (typeof babyDogeTokenAddress === "undefined" || typeof ERC20_ABI === "undefined") {
        throw new Error("babyDogeTokenAddress or ERC20_ABI not defined (needed for approve)");
      }
      const token = new ethers.Contract(babyDogeTokenAddress, ERC20_ABI, signer);
      const owner = await signer.getAddress();
      const allowance = await token.allowance(owner, contract.target ? contract.target : contract.address);
      // ethers v6 returns BigInt for allowance
      const amountBN = typeof amount === "bigint" ? amount : BigInt(amount.toString());
      if (allowance < amountBN) {
        // approve exact amount (or you can approve max)
        const approveTx = await token.approve(contract.target ? contract.target : contract.address, amountBN);
        await approveTx.wait();
      }
      tx = await contract.placeBetBabyDoge(amountBN);
    } else if (method === "placeBetDummy") {
      tx = await contract.placeBetDummy();
    } else if (method === "spinGratis") {
      tx = await contract.spinGratis();
    } else {
      throw new Error("Unknown method");
    }

    const receipt = await tx.wait();

    // parse logs to find known events
    let parsedEvents = [];
    for (const log of receipt.logs) {
      try {
        const parsed = contract.interface.parseLog(log);
        parsedEvents.push(parsed);
      } catch (e) {
        // not from this contract/interface or not parsable ‚Äî ignore
      }
    }

    // Try to find specific events in parsedEvents
    const freeWon = parsedEvents.find(e => e.name === "FreeSpinWon");
    const freeNo = parsedEvents.find(e => e.name === "FreeSpinNoPrize");
    const betBaby = parsedEvents.find(e => e.name === "BetBabyDoge");
    const betDummy = parsedEvents.find(e => e.name === "BetDummy");
    const winnerRecorded = parsedEvents.find(e => e.name === "WinnerRecorded" || e.name === "WinnerRecordedEvent");

    // CASE: Free spin immediate result (FreeSpinWon / FreeSpinNoPrize)
    if (freeWon) {
      // Solidity emitted: FreeSpinWon(msg.sender, tier, prizeAmount)
      const winnerAddr = freeWon.args[0];
      const tier = BigInt(freeWon.args[1]).toString(); // e.g. "6"
      const prizeAmountBN = BigInt(freeWon.args[2]); // token units (10**9)
      // Normalize prize amount to human integer (divide by 1e9 if babyDoge decimals = 9)
      const prizeHuman = Number(prizeAmountBN / BigInt(10 ** 9));
      const index = prizeMap[prizeHuman] !== undefined ? prizeMap[prizeHuman] : null;
      const resultLabel = prizeHuman > 0 ? `${prizeHuman.toLocaleString()} (tier ${tier})` : "No Prize";
      resultText.textContent = `üéâ Free spin won: ${resultLabel}`;
      // animateSpin expects index + result string; fallback index 0 if null
      animateSpin(index !== null ? index : 0, resultLabel);
      winSound && winSound.play();
      btn.disabled = false;
      return;
    }

    if (freeNo) {
      resultText.textContent = "üòï Free spin: No prize";
      // try to animate 'No Prize' sector if exists
      const idxNo = prizes.findIndex(p => /no prize/i.test(p.name));
      animateSpin(idxNo !== -1 ? idxNo : 0, "No Prize");
      btn.disabled = false;
      return;
    }

    // CASE: Bet events (these do not immediately decide a winner ‚Äî finalized later by finalizeRound)
    if (betBaby || betDummy) {
      // Show pending state and parse amount / round id
      const ev = betBaby || betDummy;
      // For BetBabyDoge emitted: (roundId, sender, amount) ? From snippet: emit BetBabyDoge(currentRoundId, msg.sender, amount);
      // For BetDummy emitted: (roundId, sender, dummyBetCost)
      const roundId = ev.args[0] ? ev.args[0].toString() : null;
      const sender = ev.args[1] ? ev.args[1] : null;
      const amt = ev.args[2] ? ev.args[2].toString() : null;
      resultText.textContent = `‚úÖ Bet submitted (round ${roundId || "?"}). Waiting for finalize...`;
      // Optionally show a placeholder spin animation (e.g., random sector or "pending")
      const pendingIdx = prizes.findIndex(p => /try again|no prize|try/i.test(p.name.toLowerCase()));
      animateSpin(pendingIdx !== -1 ? pendingIdx : 0, "Pending");
      btn.disabled = false;
      return;
    }

    // CASE: WinnerRecorded available (if finalizeRound got executed in same tx chain)
    if (winnerRecorded) {
      // WinnerRecorded emitted with fields in _recordWinner: (wid, rid, winner, rewardETH, rewardUSDT, rewardBabyDoge, timestamp)
      const wid = winnerRecorded.args[0] ? winnerRecorded.args[0].toString() : null;
      const rid = winnerRecorded.args[1] ? winnerRecorded.args[1].toString() : null;
      const winner = winnerRecorded.args[2] ? winnerRecorded.args[2] : null;
      const rewardETH = winnerRecorded.args[3] ? winnerRecorded.args[3].toString() : "0";
      const rewardUSDT = winnerRecorded.args[4] ? winnerRecorded.args[4].toString() : "0";
      const rewardBaby = winnerRecorded.args[5] ? BigInt(winnerRecorded.args[5]) : BigInt(0);

      // Try to map rewardBaby to a prize index if >0
      let idx = null;
      if (rewardBaby > 0) {
        const human = Number(rewardBaby / BigInt(10 ** 9));
        idx = prizeMap[human] !== undefined ? prizeMap[human] : null;
      }
      const label = `Winner: ${winner} (ETH:${rewardETH}, USDT:${rewardUSDT}, BD:${rewardBaby})`;
      resultText.textContent = `üèÜ Round ${rid} winner: ${winner}`;
      animateSpin(idx !== null ? idx : 0, label);
      winSound && winSound.play();
      btn.disabled = false;
      return;
    }

    // No recognized event found: fallback
    console.warn("No recognizable event found in tx logs", parsedEvents);
    resultText.textContent = "üîç Transaction mined but no direct result event.";
    // fallback animation: spin to random index
    const idxRnd = Math.floor(Math.random() * prizes.length);
    animateSpin(idxRnd, "Unknown result");
    btn.disabled = false;

  } catch (err) {
    console.error(err);
    resultText.textContent = "‚ùå Transaction failed: " + (err && (err.message || err.reason) ? (err.message || err.reason) : err);
    btn.disabled = false;
  }
    }
  
function resetButton() {  
  btn.disabled = false;  
  btn.textContent = "FREE SPIN";  
  spinSound.pause();  
}  
  
connectBtn.addEventListener("click", connectWallet);  
disconnectBtn.addEventListener("click", disconnectWallet);  
btn.addEventListener("click", spinFromBlockchain);
</script>

</body>
</body>
</html>
