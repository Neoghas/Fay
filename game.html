<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Battle Pot — Full Features (Demo)</title>
<style>
  :root{
    --bg:#060814; --panel:#0f1220; --muted:#94a3b8; --accent:#7c3aed;
    --good:#38bdf8; --danger:#fb7185;
  }
  *{box-sizing:border-box}
  body{margin:0;background:
    radial-gradient(800px 300px at 10% 10%, rgba(124,58,237,0.06), transparent),
    linear-gradient(180deg,#030414,#06102a 60%); color:#e6eef8; font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; padding:22px;}
  .wrap{max-width:1150px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:18px;align-items:start;}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:16px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.6);}
  h1{margin:0 0 6px 0;font-size:20px}
  label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
  input, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:#e6eef8}
  button{padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#4f46e5);color:#fff;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .players { max-height:460px; overflow:auto;margin-top:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:8px; }
  .card{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:6px;min-height:62px;position:relative}
  .name{font-weight:700}
  .meta{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .avatar{width:100%;height:72px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);display:flex;align-items:center;justify-content:space-between;padding:10px;transition:all .6s ease}
  .avatar.elim{filter:grayscale(90%) brightness(.5);opacity:.25;transform:scale(.92) rotate(-2deg); text-decoration:line-through}
  .center-stage{display:flex;gap:18px;flex-direction:column}
  .arena{height:420px;border-radius:12px;background:linear-gradient(180deg,#061124,#051022);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .overlay-info{position:absolute;left:18px;top:18px;color:var(--muted);font-size:14px}
  .pot{font-size:20px;font-weight:800}
  .big-winner{position:absolute;right:18px;top:18px;background:rgba(0,0,0,0.45);padding:8px 12px;border-radius:10px;color:#fff}
  .log{max-height:110px;overflow:auto;margin-top:10px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
  .footer-note{font-size:12px;color:var(--muted);margin-top:8px}
  .switch{display:flex;gap:8px;align-items:center}
  .split-input{display:flex;gap:6px}
  .split-input input{width:72px}
  .wallet-box{display:flex;gap:8px;align-items:center}
  @media (max-width:980px){ .wrap{grid-template-columns:1fr} .players{grid-template-columns:repeat(1,1fr)} .arena{height:300px} }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Controls -->
    <div class="panel">
      <h1>Battle Pot — Full Features</h1>
      <div class="muted">Mode: Survival Random Elimination. Semua client-side demo. Untuk production gunakan server / on-chain VRF.</div>

      <label>Connect Wallet (Metamask) — Demo</label>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="connectWalletBtn">Connect Wallet</button>
        <div id="walletAddr" class="muted">Not connected</div>
      </div>
      <div class="footer-note">(Connect hanya membaca address; tidak melakukan transfer di demo ini.)</div>

      <label style="margin-top:12px">Tambah Pemain / Ticket Mode</label>
      <div style="display:flex;gap:8px">
        <input id="newName" placeholder="Nama pemain (ex: Riko)">
        <input id="tickets" type="number" min="1" value="1" style="width:88px">
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="bet" type="number" min="0" value="1" style="width:120px">
        <button id="addBtn">Tambah</button>
      </div>

      <label style="margin-top:12px">Mode Eliminasi</label>
      <div class="switch">
        <label><input type="radio" name="mode" value="weighted" checked> Weighted (by tickets)</label>
        <label style="margin-left:8px"><input type="radio" name="mode" value="equal"> Equal random</label>
      </div>

      <label style="margin-top:12px">Payout Split (Top 3) — jumlah total harus 100%</label>
      <div class="split-input" style="margin-top:6px">
        <input id="split1" type="number" min="0" max="100" value="70">%
        <input id="split2" type="number" min="0" max="100" value="20">%
        <input id="split3" type="number" min="0" max="100" value="10">%
      </div>

      <div class="controls" style="margin-top:12px">
        <button id="startBtn">Start Royale</button>
        <button id="stopBtn" disabled style="background:#ff5a5a">Stop</button>
        <button id="resetBtn" style="background:#444">Reset</button>
      </div>

      <label style="margin-top:12px">Quick Actions</label>
      <div class="controls">
        <button id="autofillBtn">Auto-fill 16 players</button>
        <button id="demoAllBtn">Demo: Start (auto)</button>
      </div>

      <div class="footer-note" style="margin-top:12px">
        Catatan produksi: gunakan server-side randomness (VRF/Chainlink), simpan deposit on-chain / smart contract, audit log, dan prosedur KYC/kompliansi sesuai hukum.
      </div>
    </div>

    <!-- RIGHT: Arena & players -->
    <div class="panel center-stage">
      <div class="arena" id="arena">
        <div class="overlay-info">
          <div class="muted">Players:</div>
          <div id="countPlayers" class="pot">0</div>
          <div class="muted" style="margin-top:6px">Total Pot:</div>
          <div id="totalPot" class="pot">0 USDT</div>
        </div>

        <div class="big-winner" id="winnersBox">Winners: -</div>

        <!-- avatars grid -->
        <div id="avatarsGrid" style="position:relative; width:86%; height:86%; display:flex;flex-wrap:wrap;align-content:flex-start;justify-content:center;gap:12px; padding:12px; pointer-events:none;"></div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1">
          <div class="muted">Last Events</div>
          <div class="log" id="log"></div>
        </div>
        <div style="width:220px">
          <div class="muted">Players List</div>
          <div class="players" id="playersList"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   Battle Pot — Full Prototype
   - Weighted / Equal elimination
   - Top3 payout split
   - Animated eliminations + sounds
   - Wallet connect (Metamask) demo (no real tx)
   =========================== */

const state = {
  players: [], // {id,name,tickets,bet,out:false}
  potPerTicket: 1.0,
  running: false,
  winners: [],
  audioCtx: null
};

/* ---------------------------
   Utilities
--------------------------- */
const $ = id => document.getElementById(id);
function uid(n=6){ return Math.random().toString(36).slice(2,2+n); }
function log(msg){ const el=$('log'); el.innerHTML = `<div>${new Date().toLocaleTimeString()} — ${msg}</div>` + el.innerHTML; if(el.scrollTop<50) el.scrollTop=0; }
function sumTickets(){ return state.players.reduce((s,p)=>s.tickets + s,0); }
function totalPot(){ return state.players.reduce((s,p)=>s + (p.bet || 0),0); }

/* ---------------------------
   Audio (WebAudio oscillator beeps)
--------------------------- */
function playBeep(freq=420,dur=0.08, vol=0.06){
  try{
    if(!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const ctx = state.audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine'; o.frequency.setValueAtTime(freq, ctx.currentTime);
    g.gain.value = vol;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
    setTimeout(()=>{ o.stop(); o.disconnect(); g.disconnect(); }, dur*1000 + 20);
  }catch(e){ /* silent */ }
}

/* ---------------------------
   DOM: add player, render
--------------------------- */
function renderPlayers(){
  $('playersList').innerHTML = '';
  const grid = $('avatarsGrid'); grid.innerHTML = '';
  state.players.forEach(p=>{
    const card = document.createElement('div'); card.className='card';
    card.style.gridColumn='span 1';
    card.innerHTML = `<div class="name">${p.name}</div><div class="meta">${p.tickets} tiket • ${p.bet} USDT</div>`;
    $('playersList').appendChild(card);

    // avatar tile (large)
    const av = document.createElement('div'); av.className='avatar'; av.id = 'av_'+p.id;
    av.innerHTML = `<div style="font-weight:800">${p.name}</div><div class="meta">${p.tickets}</div>`;
    av.style.width = '160px'; av.style.height='84px'; av.style.pointerEvents='none';
    grid.appendChild(av);
  });
  $('countPlayers').innerText = state.players.length;
  $('totalPot').innerText = totalPot().toFixed(2) + ' USDT';
}

/* ---------------------------
   Actions: add / autofill / reset
--------------------------- */
$('addBtn').onclick = ()=>{
  const name = $('newName').value.trim() || ('P'+Math.floor(Math.random()*9999));
  const t = Math.max(1, parseInt($('tickets').value) || 1);
  const b = Math.max(0.01, parseFloat($('bet').value) || 1);
  const id = uid(5);
  state.players.push({ id, name, tickets: t, bet: b, out:false });
  $('newName').value=''; $('tickets').value='1'; $('bet').value='1';
  renderPlayers(); log(`Added ${name} — ${t} tickets, ${b} USDT`);
};

$('autofillBtn').onclick = ()=>{
  const sample = ['Riko','Sari','Joko','Luna','Aldi','Nina','Bayu','Tara','Fikri','Dedi','Maya','Rizal','Hendra','Putri','Gilang','Eka'];
  state.players = [];
  sample.forEach((n,i)=>{
    const t = Math.floor(Math.random()*5)+1;
    const b = (Math.floor(Math.random()*8)+1);
    state.players.push({ id: uid(5), name: n, tickets: t, bet: b, out:false });
  });
  renderPlayers(); log('Auto-filled players');
};

$('resetBtn').onclick = ()=>{
  if(state.running) { alert('Stop dulu sebelum reset'); return; }
  state.players = []; state.winners = []; renderPlayers(); $('winnersBox').innerText='Winners: -'; $('log').innerHTML='';
  log('Reset all');
};

/* ---------------------------
   Wallet connect (Metamask demo)
   - only reads address, does not send tx
--------------------------- */
let connectedAddress = null;
$('connectWalletBtn').onclick = async ()=>{
  if(window.ethereum){
    try{
      const accs = await window.ethereum.request({ method:'eth_requestAccounts' });
      connectedAddress = accs[0];
      $('walletAddr').innerText = connectedAddress;
      log('Wallet connected: ' + connectedAddress);
    }catch(err){ log('Wallet connect rejected'); }
  }else{
    alert('No Ethereum provider found. Install Metamask for real wallet connect.');
  }
};

/* ---------------------------
   Random helpers (weighted/equal)
--------------------------- */
function pickWeightedAlive(alive){
  // build array of owner ids repeated by tickets
  const pool = [];
  alive.forEach(p=>{
    for(let i=0;i<p.tickets;i++) pool.push(p);
  });
  if(pool.length===0) return alive[Math.floor(Math.random()*alive.length)];
  return pool[Math.floor(Math.random()*pool.length)];
}
function pickEqualAlive(alive){
  return alive[Math.floor(Math.random()*alive.length)];
}

/* ---------------------------
   Elimination loop
   Params:
    - mode: 'weighted' or 'equal'
    - topN: how many winners to select (e.g., 3)
    - pace: interval (ms)
--------------------------- */
let eliminationTimer = null;
async function startElimination(){
  if(state.running) return;
  if(state.players.length < 2) { alert('Butuh minimal 2 pemain'); return; }

  const mode = document.querySelector('input[name="mode"]:checked').value;
  const top1 = parseFloat($('split1').value)||0;
  const top2 = parseFloat($('split2').value)||0;
  const top3 = parseFloat($('split3').value)||0;
  if(Math.abs((top1+top2+top3) - 100) > 0.1){ if(!confirm('Split tidak 100%. Lanjutkan?')) return; }

  state.running = true;
  $('startBtn').disabled = true; $('stopBtn').disabled = false;
  $('winnersBox').innerText = 'Winners: -';
  state.winners = [];

  // prepare working set
  state.players.forEach(p=> p.out = false);

  // make a local copy of active players
  const pace = 700; // ms per elimination (tweak)
  const selectFn = (mode === 'weighted') ? pickWeightedAlive : pickEqualAlive;

  log(`Start elimination — mode: ${mode}. Selecting top 3...`);
  playBeep(680,0.12,0.08);

  // elimination loop until only N winners left
  const winnersTarget = 3;
  let active = state.players.filter(p=>!p.out);

  function step(){
    if(!state.running) return;
    active = state.players.filter(p=>!p.out);
    if(active.length <= winnersTarget){
      // remaining are winners; order them by tickets desc for ranking
      const ranked = active.slice().sort((a,b)=>b.tickets - a.tickets);
      state.winners = ranked;
      finalizeWinners(ranked);
      return;
    }
    // pick victim
    const victim = selectFn(active);
    victim.out = true;
    // animate victim
    const el = document.getElementById('av_'+victim.id);
    if(el){
      el.classList.add('elim');
      el.animate([
        { transform: 'scale(1)', opacity:1 },
        { transform: 'scale(.7) rotate(-6deg)', opacity:0.2 }
      ], { duration: pace*0.7, easing: 'cubic-bezier(.2,.9,.3,1)' });
    }
    playBeep(320 + Math.random()*120, 0.06, 0.04);
    log(`Eliminated: ${victim.name} (tickets ${victim.tickets})`);
    renderPlayers();
    // schedule next
    eliminationTimer = setTimeout(step, pace + Math.random()*180);
  }
  step();
}

function stopElimination(){
  state.running = false;
  $('startBtn').disabled = false; $('stopBtn').disabled = true;
  if(eliminationTimer) { clearTimeout(eliminationTimer); eliminationTimer = null; }
  log('Elimination stopped by operator');
}

/* ---------------------------
   Finalize winners and payout (demo)
--------------------------- */
function finalizeWinners(ranked){
  state.running = false; $('startBtn').disabled=false; $('stopBtn').disabled=true;
  // compute pool total
  const pool = totalPot();
  const s1 = (parseFloat($('split1').value)||0)/100;
  const s2 = (parseFloat($('split2').value)||0)/100;
  const s3 = (parseFloat($('split3').value)||0)/100;
  const payouts = [
    { name: ranked[0]?.name||'—', id: ranked[0]?.id||null, amount: +(pool * s1).toFixed(4), rank:1 },
    { name: ranked[1]?.name||'—', id: ranked[1]?.id||null, amount: +(pool * s2).toFixed(4), rank:2 },
    { name: ranked[2]?.name||'—', id: ranked[2]?.id||null, amount: +(pool * s3).toFixed(4), rank:3 }
  ];
  // emit log, highlight winners
  playBeep(1100,0.2,0.12);
  playBeep(880,0.16,0.1);
  $('winnersBox').innerText = 'Winners: ' + payouts.filter(p=>p.id).map(p=>`${p.rank}•${p.name} (${p.amount} USDT)`).join(' | ');
  log('Winners: ' + payouts.map(p=>`${p.rank} ${p.name} => ${p.amount} USDT`).join(' | '));
  // visual highlight
  document.querySelectorAll('.avatar').forEach(av => av.classList.add('elim'));
  payouts.forEach((p,idx)=>{
    if(!p.id) return;
    const el = document.getElementById('av_'+p.id);
    if(el){
      el.classList.remove('elim');
      el.style.transform = 'scale(1.08)';
      el.style.boxShadow='0 14px 40px rgba(124,58,237,0.22)';
      // small winner pulse
      el.animate([{ transform:'scale(1.00)' },{ transform:'scale(1.08)' },{ transform:'scale(1.00)' }], { duration:900 + idx*120, easing:'ease-out' });
    }
  });
}

/* ---------------------------
   Hooks for start/stop/demo
--------------------------- */
$('startBtn').onclick = startElimination;
$('stopBtn').onclick = stopElimination;
$('demoAllBtn').onclick = async ()=>{
  $('autofillBtn').click();
  await new Promise(r=>setTimeout(r,600));
  $('startBtn').click();
};
$('autofillBtn').onclick = ()=>{
  $('autofillBtn').disabled = true;
  // call autofill from earlier; ensure some ticket variance
  const sample = ['Riko','Sari','Joko','Luna','Aldi','Nina','Bayu','Tara','Fikri','Dedi','Maya','Rizal','Hendra','Putri','Gilang','Eka'];
  state.players = [];
  sample.forEach((n,i)=>{
    const t = Math.floor(Math.random()*6)+1;
    const b = Math.max(1, Math.floor(Math.random()*12));
    state.players.push({ id: uid(5), name: n, tickets: t, bet: b, out:false });
  });
  renderPlayers(); log('Auto-filled players');
  setTimeout(()=> $('autofillBtn').disabled=false, 800);
};

/* ---------------------------
   Initial render
--------------------------- */
renderPlayers();
log('Prototype ready — add players or auto-fill then Start.');

/* ---------------------------
   Safety & production notes (console)
--------------------------- */
console.log(`
Battle Pot Demo loaded.
- THIS IS CLIENT-SIDE DEMO: RNG = Math.random(), not secure.
- For production: use server-side VRF (Chainlink/Drand) or on-chain VRF to pick victims/winners.
- For real money: collect deposits into a smart-contract pool (only release via verified winner).
- Keep audit logs, KYC, and legal compliance.
`);
</script>
</body>
</html>
