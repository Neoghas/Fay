<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Arsip Wayang</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        :root {
            --primary: #8b5a2b;
            --dark: #1a1510;
            --light: #e0d8c3;
            --accent: #deb887;
        }

        body { font-family: 'Georgia', serif; background-color: var(--dark); color: var(--light); margin: 0; padding: 0; }
        
        /* Navbar */
        .navbar { 
            padding: 20px; 
            border-bottom: 1px solid #3e2723; 
            background: #2c241b; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .btn-back { 
            text-decoration: none; color: var(--accent); font-weight: bold; font-size: 14px; 
            text-transform: uppercase; border: 1px solid #5d4037; padding: 10px 20px; 
            border-radius: 4px; transition: 0.3s; 
        }
        .btn-back:hover { background: var(--accent); color: var(--dark); }

        #btn-connect {
            background: var(--primary); color: white; border: none; padding: 10px 20px; 
            border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        #btn-connect.connected { background: #27ae60; cursor: default; }

        /* Layout Utama */
        .container { max-width: 1100px; margin: 40px auto; display: flex; flex-wrap: wrap; gap: 40px; padding: 20px; }
        
        /* Kolom Kiri */
        .left-col { flex: 1; min-width: 300px; }
        .img-frame { 
            background: #fdfbf7; border: 10px solid #3e2723; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 5px; 
            overflow: hidden; position: relative; 
        }
        .img-frame img { width: 100%; height: auto; display: block; }
        .id-badge { 
            position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); 
            color: white; padding: 5px 10px; font-family: sans-serif; font-size: 12px; border-radius: 4px; 
        }

        /* Kolom Kanan */
        .right-col { flex: 1.5; min-width: 300px; }
        h1 { font-size: 3em; margin: 0 0 10px 0; color: var(--accent); border-bottom: 2px solid #5d4037; display: inline-block; padding-bottom: 10px; }
        .gaya-tag { background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; vertical-align: middle; margin-left: 15px; }
        .description { font-size: 1.1em; line-height: 1.8; color: #ccc; margin-bottom: 30px; text-align: justify; }

        /* Grid Metadata */
        .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .meta-box { background: #2c241b; padding: 15px; border-radius: 8px; border: 1px solid #3e2723; }
        .meta-label { font-size: 12px; text-transform: uppercase; color: #888; letter-spacing: 1px; display: block; margin-bottom: 5px; }
        .meta-value { font-size: 16px; font-weight: bold; color: var(--accent); }

        /* Silsilah */
        .silsilah-box { background: #241d16; padding: 20px; border-left: 5px solid var(--accent); }
        .silsilah-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #444; padding: 10px 0; }
        
        /* Area Sosial */
        .social-section { margin-top: 40px; border-top: 1px dashed #5d4037; padding-top: 20px; }
        .review-box { background: #241d16; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        
        /* Star Rating & Chips */
        .star-rating span { font-size: 30px; cursor: pointer; color: #444; transition: 0.2s; }
        .star-rating span:hover, .star-rating span.active { color: gold; }
        
        .chip { background: #3e2723; color: #ccc; border: 1px solid #5d4037; padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: 0.2s; margin-bottom: 5px; }
        .chip:hover, .chip.selected { background: var(--accent); color: var(--dark); font-weight: bold; }

        /* Review List */
        .review-card { background: #1e1e1e; padding: 15px; border-radius: 5px; border-left: 3px solid gold; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="navbar">
    <a href="index.html" class="btn-back">← Kembali ke Galeri</a>
    <button id="btn-connect" onclick="connectWallet()">Connect Wallet</button>
</div>

<div id="loading" style="text-align: center; margin-top: 100px; font-size: 20px;">
    ⏳ Membuka Arsip Kuno dari Base Sepolia...
</div>

<div id="content" class="container" style="display: none;">
    <div class="left-col">
        <div class="img-frame">
            <div class="id-badge">ID: #<span id="displayId">0</span></div>
            <img id="displayImg" src="" alt="Wayang">
        </div>
        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 12px;">
            Permanen di Blockchain Base Sepolia
        </div>
    </div>

    <div class="right-col">
        <div>
            <h1 id="displayName">Nama Tokoh</h1>
            <span id="displayGaya" class="gaya-tag">Gaya</span>
        </div>
        
        <p class="description" id="displayDesc">Deskripsi...</p>

        <h3 style="color:var(--accent); border-bottom:1px solid #444; padding-bottom:5px;">Data Fisik & Budaya</h3>
        <div class="meta-grid">
            <div class="meta-box"><span class="meta-label">Golongan</span><span class="meta-value" id="displayGolongan">-</span></div>
            <div class="meta-box"><span class="meta-label">Wanda</span><span class="meta-value" id="displayWanda">-</span></div>
            <div class="meta-box"><span class="meta-label">Material</span><span class="meta-value" id="displayKulit">-</span></div>
            <div class="meta-box"><span class="meta-label">Pembuat</span><span class="meta-value" id="displayPembuat">-</span></div>
        </div>

        <h3 style="color:var(--accent); border-bottom:1px solid #444; padding-bottom:5px;">Silsilah & Asal Usul</h3>
        <div class="silsilah-box">
            <div class="silsilah-row"><span style="color:#aaa">Negara</span><span style="font-weight:bold" id="displayNegara">-</span></div>
            <div class="silsilah-row"><span style="color:#aaa">Ayah</span><span style="font-weight:bold" id="displayAyah">-</span></div>
            <div class="silsilah-row"><span style="color:#aaa">Ibu</span><span style="font-weight:bold" id="displayIbu">-</span></div>
            <div class="silsilah-row"><span style="color:#aaa">Pusaka</span><span style="font-weight:bold" id="displayPusaka">-</span></div>
        </div>

        <div class="social-section">
            
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                <button onclick="kirimLike()" id="btnLike" style="background: none; border: 2px solid var(--accent); color: var(--accent); padding: 10px 20px; border-radius: 30px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                    ❤️ <span id="likeCount">0</span> Suka
                </button>
                <span style="color: #666; font-size: 12px;">(Klik untuk dukung pelestarian)</span>
            </div>

            <div class="review-box">
                <h3 style="color: var(--accent); margin-top: 0;">Beri Penilaian</h3>
                
                <div class="star-rating" style="margin-bottom: 15px;">
                    <span onclick="pilihBintang(1)">★</span>
                    <span onclick="pilihBintang(2)">★</span>
                    <span onclick="pilihBintang(3)">★</span>
                    <span onclick="pilihBintang(4)">★</span>
                    <span onclick="pilihBintang(5)">★</span>
                </div>
                <input type="hidden" id="selectedStar" value="0">

                <div style="margin-bottom: 15px;">
                    <p style="color:#aaa; font-size:12px; margin-bottom:5px;">Pilih Kata Pujian:</p>
                    <div id="pilihanUlasan" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="chip" onclick="pilihTag(this, 'Luar Biasa')">Luar Biasa</button>
                        <button class="chip" onclick="pilihTag(this, 'Sangat Detail')">Sangat Detail</button>
                        <button class="chip" onclick="pilihTag(this, 'Estetik')">Estetik</button>
                        <button class="chip" onclick="pilihTag(this, 'Mistis')">Mistis</button>
                        <button class="chip" onclick="pilihTag(this, 'Masterpiece')">Masterpiece</button>
                        <button class="chip" onclick="pilihTag(this, 'Bersejarah')">Bersejarah</button>
                    </div>
                    <input type="hidden" id="selectedTag" value="">
                </div>

                <button onclick="kirimUlasan()" style="background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold;">
                    Kirim Ulasan (Gas Fee Apply)
                </button>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="color: var(--accent);">Ulasan Pengunjung (<span id="reviewCount">0</span>)</h3>
                <div id="reviewContainer">
                    <p style="color:#666; font-style: italic;">Memuat ulasan...</p>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // --- 1. KONFIGURASI PENTING ---
    const CONTRACT_ADDRESS = "0x5dfe8311e98b0443C471A10e26198b72355Ca713"; // <--- Paste Contract Address Disini
    
    // Konfigurasi Base Sepolia
    const BASE_SEPOLIA_ID = '0x14a34'; // 84532
    const BASE_SEPOLIA_RPC = 'https://sepolia.base.org';
    const BASE_SEPOLIA_CONFIG = {
        chainId: BASE_SEPOLIA_ID,
        chainName: 'Base Sepolia Testnet',
        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
        rpcUrls: [BASE_SEPOLIA_RPC],
        blockExplorerUrls: ['https://sepolia.basescan.org']
    };

    // ABI Lengkap (Termasuk Fungsi Sosial)
    const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct WayangArsipPro.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPro.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];

    let provider;
    let signer;

    // --- 2. INIT & LOAD DATA ---
    async function init() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        if (!id) {
            document.getElementById("loading").innerText = "Error: ID Arsip tidak ditemukan.";
            return;
        }

        // Cek apakah wallet sudah terkoneksi sebelumnya
        if(window.ethereum && window.ethereum.selectedAddress) {
             connectWallet(); // Auto connect visual
        }

        // Load Data Metadata & Sosial
        await loadDetail(id);
        await loadSocialData(id);
    }

    // --- 3. KONEKSI WALLET & NETWORK CHECK ---
    async function connectWallet() {
        if (!window.ethereum) return alert("Install Metamask!");

        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            
            // Cek Network Wajib Base Sepolia
            const network = await provider.getNetwork();
            if (network.chainId !== 84532) {
                await switchNetwork();
            }

            signer = provider.getSigner();
            const address = await signer.getAddress();
            
            const btn = document.getElementById("btn-connect");
            btn.innerText = address.substring(0,6) + "...";
            btn.classList.add("connected");

        } catch (err) {
            console.error(err);
            alert("Gagal koneksi: " + err.message);
        }
    }

    async function switchNetwork() {
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: BASE_SEPOLIA_ID }],
            });
        } catch (switchError) {
            if (switchError.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [BASE_SEPOLIA_CONFIG],
                });
            } else {
                throw switchError;
            }
        }
    }

    // --- 4. LOAD METADATA (IPFS) ---
    async function loadDetail() {
        // 1. Ambil ID dari URL
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        if (!id) {
            document.getElementById("loading").innerText = "ID Arsip tidak ditemukan.";
            return;
        }

        try {
            // 2. Koneksi Blockchain (Read-Only RPC)
            const provider = new ethers.providers.JsonRpcProvider(BASE_SEPOLIA_RPC);
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

            // 3. Ambil URI Metadata
            const uri = await contract.tokenURI(id);
            const httpUri = uri.replace("ipfs://", "https://gateway.pinata.cloud/ipfs/");
            
            // 4. Download JSON
            const response = await axios.get(httpUri);
            const meta = response.data;

            // 5. OPTIMASI GAMBAR (TARGET: 500KB - 700KB)
            const rawImgUrl = meta.image.replace("ipfs://", "https://gateway.pinata.cloud/ipfs/");
            
            // w=1200 : Resolusi Besar (HD), enak dilihat di Laptop/Tablet
            // q=95   : Kompresi sangat sedikit, detail ukiran wayang tajam
            const hdImageUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawImgUrl)}&w=1200&q=95&output=webp`;

            // 6. Helper Function Attributes
            const getAttr = (k) => {
                const f = meta.attributes.find(a => a.trait_type === k);
                return f ? f.value : "-";
            };

            // 7. Masukkan Data ke HTML
            document.getElementById("displayId").innerText = id;
            
            // Set Gambar HD
            const imgEl = document.getElementById("displayImg");
            imgEl.src = hdImageUrl;
            
            // Efek Loading Halus
            imgEl.style.opacity = 0;
            imgEl.onload = () => { imgEl.style.opacity = 1; imgEl.style.transition = "opacity 0.5s"; };

            document.getElementById("displayName").innerText = meta.name;
            document.getElementById("displayGaya").innerText = getAttr("Gaya");
            document.getElementById("displayDesc").innerText = meta.description;
            
            document.getElementById("displayGolongan").innerText = getAttr("Golongan");
            document.getElementById("displayWanda").innerText = getAttr("Wanda");
            document.getElementById("displayKulit").innerText = getAttr("Material Kulit");
            document.getElementById("displayPembuat").innerText = getAttr("Pembuat");
            
            document.getElementById("displayNegara").innerText = getAttr("Negara");
            document.getElementById("displayAyah").innerText = getAttr("Ayah");
            document.getElementById("displayIbu").innerText = getAttr("Ibu");
            document.getElementById("displayPusaka").innerText = getAttr("Pusaka") || "-";

            // Tampilkan Konten
            document.getElementById("loading").style.display = "none";
            document.getElementById("content").style.display = "flex";

        } catch (err) {
            console.error(err);
            document.getElementById("loading").innerText = "Gagal memuat data wayang. Cek koneksi.";
        }
    }

    // --- 5. LOAD DATA SOSIAL (BLOCKCHAIN) ---
    async function loadSocialData(id) {
        try {
            const readProvider = new ethers.providers.JsonRpcProvider(BASE_SEPOLIA_RPC);
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

            // Likes
            const likes = await contract.totalLikes(id);
            document.getElementById("likeCount").innerText = likes.toString();

            // Reviews
            const reviews = await contract.getReviews(id);
try {
    const avgScore = await contract.getAverageRating(id);
    const finalScore = (avgScore / 10).toFixed(1);
    if(avgScore > 0) {
        document.getElementById("displayName").innerHTML += 
            ` <span style="font-size:16px; color:gold; border:1px solid gold; padding:2px 8px; border-radius:10px;">⭐ ${finalScore}</span>`;
    }
} catch (e) {
    console.log("Belum ada rating rata-rata");
}
            document.getElementById("reviewCount").innerText = reviews.length;
            
            const container = document.getElementById("reviewContainer");
            
            if(reviews.length === 0) {
                container.innerHTML = `<p style="color:#666; font-style: italic;">Belum ada ulasan.</p>`;
            } else {
                container.innerHTML = "";
                // Balik array agar review terbaru di atas
                [...reviews].reverse().forEach(r => {
                    // r[0]=address, r[1]=bintang, r[2]=ulasan
                    const bintangStr = "★".repeat(r.bintang);
                    const html = `
                        <div class="review-card">
                            <div style="font-size: 11px; color: #888; margin-bottom:5px;">
                                ${r.reviewer.substring(0,6)}...${r.reviewer.substring(38)}
                            </div>
                            <div style="color: gold; font-size: 16px;">${bintangStr}</div>
                            <div style="color: #eee; margin-top: 5px; font-style: italic;">"${r.ulasan}"</div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            }

        } catch (err) {
            console.error("Gagal load social:", err);
        }
    }

    // --- 6. INTERAKSI: LIKE & REVIEW ---
    async function ensureWallet() {
        if(!signer) {
            await connectWallet();
            if(!signer) throw new Error("Wallet belum terkoneksi");
        }
    }

    async function kirimLike() {
        try {
            await ensureWallet(); // Pastikan konek dulu
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            
            const btn = document.getElementById("btnLike");
            const oriText = btn.innerHTML;
            btn.innerHTML = "⏳ Mining...";
            
            const tx = await contract.kasihLike(id);
            await tx.wait();
            
            alert("Berhasil Like!");
            location.reload();

        } catch(err) {
            alert("Gagal: " + (err.reason || err.message));
            document.getElementById("btnLike").innerHTML = "❤️ Like";
        }
    }

    async function kirimUlasan() {
        try {
            const bintang = document.getElementById("selectedStar").value;
            const tag = document.getElementById("selectedTag").value;
            if(bintang == 0 || tag == "") return alert("Pilih bintang & kata ulasan dulu!");

            await ensureWallet();
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            
            const tx = await contract.kasihUlasan(id, bintang, tag);
            alert("Transaksi review dikirim. Tunggu konfirmasi...");
            await tx.wait();
            
            alert("Review Berhasil!");
            location.reload();

        } catch(err) {
            alert("Gagal: " + (err.reason || err.message));
        }
    }

    // --- 7. UI HELPERS ---
    function pilihBintang(n) {
        document.getElementById("selectedStar").value = n;
        const stars = document.querySelectorAll('.star-rating span');
        stars.forEach((s, index) => {
            if(index < n) s.classList.add('active');
            else s.classList.remove('active');
        });
    }

    function pilihTag(btn, teks) {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById("selectedTag").value = teks;
    }

    // Jalankan Init
    init();

</script>
</body>
</html>
