<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto Slot Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
<style>
    /* --- CSS UTAMA (THEME: CYBERPUNK NEON) --- */
    * { box-sizing: border-box; }
    
    :root {
        /* Warna Utama: Cyberpunk Palette */
        --primary: #00d2ff;       /* Biru Neon Terang */
        --accent: #d000ff;        /* Ungu Neon */
        --bg: #0b0c15;            /* Hitam Kebiruan Gelap */
        --panel: #161822;         /* Panel Gelap */
        --text: #e0e6ed;          /* Putih Tulang */
        --danger: #ff2a6d;        /* Merah Pink Cyber */
        --success: #05ffa1;       /* Hijau Neon */
        
        --shib-color: #ff9f43; 
        --usdt-color: #00d2d3; 
        --eth-color: #5f27cd;
        --gold: #ffdd59;
        
        /* Gradient Background Futuristik */
        --gradient-bg: linear-gradient(145deg, #0b0c15 0%, #1a1025 100%);
        
        /* Efek Glow */
        --glow-primary: 0 0 15px rgba(0, 210, 255, 0.4);
        --glow-accent: 0 0 15px rgba(208, 0, 255, 0.4);
    }

    body {
        font-family: 'Ubuntu', sans-serif;
        background: var(--gradient-bg); 
        color: var(--text); 
        margin: 0;
        display: flex; flex-direction: column; align-items: center;
        min-height: 100vh; padding-bottom: 50px; overflow-x: hidden;
    }

    header {
        width: 100%; padding: 15px 20px; display: flex; justify-content: space-between;
        align-items: center; 
        background: rgba(11, 12, 21, 0.9); /* Transparan Gelap */
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        position: sticky; top: 0; z-index: 100; 
        backdrop-filter: blur(15px); 
        box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }

    .wallet-btn {
        background: linear-gradient(90deg, #03a9f4, #f441a5);
        color: #fff; border: none; padding: 8px 16px;
        border-radius: 20px; cursor: pointer; font-weight: 800; font-size: 0.9rem; 
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: var(--glow-primary);
        letter-spacing: 0.5px;
    }
    .wallet-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 25px var(--primary);
        color: white;
    }
    .wallet-btn.connected { 
        background: transparent; 
        border: 1px solid var(--success); 
        color: var(--success);
        box-shadow: 0 0 10px rgba(5, 255, 161, 0.2);
        cursor: default; 
    }

    .layout-container { width: 94%; max-width: 480px; display: flex; flex-direction: column; align-items: center; margin: 0 auto; }  

    .slot-machine {
        margin-top: 30px; 
        background: linear-gradient(180deg, var(--panel), #0f1016); 
        padding: 20px;
        border-radius: 15px; 
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0,0,0,0.5);
        width: 100%; display: flex; flex-direction: column; align-items: center;
        position: relative;
    }
    /* Efek garis neon di atas slot machine */
    .slot-machine::before {
        content: ''; position: absolute; top: -1px; left: 20%; right: 20%; height: 2px;
        background: linear-gradient(90deg, transparent, var(--accent), transparent);
        box-shadow: 0 0 10px var(--accent);
    }

    .reels-container { 
        display: flex; gap: 8px; 
        background: #050508; 
        padding: 10px; border-radius: 8px; justify-content: center; margin-bottom: 15px; width: 100%; 
        box-shadow: inset 0 0 15px rgba(0,0,0,0.8), 0 0 0 1px #333; 
    }
    .reel { 
        flex: 1; height: 90px; 
        background: linear-gradient(180deg, #e0e0e0 0%, #ffffff 50%, #e0e0e0 100%); /* Efek metallic */
        border-radius: 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; 
        box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        border: 1px solid #000;
    }
    .reel-img { width: 80%; height: 80%; object-fit: contain; transition: transform 0.1s; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }  

    .draw-section { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    
    .btn-draw {
        background: #222; 
        color: #555; 
        border: 1px solid #333;
        padding: 12px 0; width: 70%; border-radius: 30px;
        font-size: 0.9em; font-weight: 800; cursor: not-allowed; transition: 0.3s;
        text-transform: uppercase; letter-spacing: 1px;
    }
    .btn-draw.ready {
        background: linear-gradient(90deg, #03a9f4, #f441a5);
        color: #fff; 
        border: none;
        cursor: pointer; 
        box-shadow: 0 0 20px rgba(255, 0, 85, 0.5); 
        animation: neonPulse 1.5s infinite alternate;
    }
    @keyframes neonPulse { 
        0% { box-shadow: 0 0 10px rgba(255, 0, 85, 0.5); transform: scale(1); } 
        100% { box-shadow: 0 0 25px rgba(255, 0, 204, 0.8), 0 0 5px #fff; transform: scale(1.02); } 
    }
    .status-text { font-size: 0.8em; color: var(--primary); font-weight: bold; text-align: center; text-shadow: 0 0 5px rgba(0, 210, 255, 0.3); }  

    .betting-section { margin-top: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; }  
    .bet-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; margin-top: 15px; }  

    .bet-card {
        background: rgba(255, 255, 255, 0.03); 
        border: 1px solid rgba(255, 255, 255, 0.1); 
        border-radius: 12px; padding: 10px; cursor: pointer; transition: all 0.3s ease;
        display: flex; flex-direction: column; align-items: center; justify-content: center; aspect-ratio: 1/1.2; position: relative;
        backdrop-filter: blur(5px);
    }
    .bet-card:hover { 
        transform: translateY(-5px); 
        border-color: var(--primary); 
        box-shadow: 0 5px 15px rgba(0, 210, 255, 0.2); 
        background: rgba(0, 210, 255, 0.05);
    }
    .bet-card.my-bet { 
        border: 1px solid var(--accent); 
        background: rgba(208, 0, 255, 0.1); 
        box-shadow: 0 0 15px rgba(208, 0, 255, 0.3); 
    }
    .bet-card.open { 
        border-color: var(--success); 
        animation: pulseBorder 2s infinite; 
    }
    @keyframes pulseBorder { 0% { border-color: rgba(5, 255, 161, 0.3); } 50% { border-color: var(--success); } 100% { border-color: rgba(5, 255, 161, 0.3); } }
    .bet-card.selected { 
        transform: scale(0.95); 
        background: rgba(255, 255, 255, 0.1); 
        border-color: #fff;
        box-shadow: 0 0 15px rgba(255,255,255,0.3); 
    }  

    .bet-icon-img { width: 50%; height: 50%; object-fit: contain; margin-bottom: 5px; filter: drop-shadow(0 0 2px rgba(255,255,255,0.3)); }  
    .name { font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; color: #ccc;}  
    .team-count { font-size: 9px; color: #888; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 4px; margin-top: 2px; }  
    .team-count.filled { color: var(--success); border: 1px solid var(--success); background: rgba(5, 255, 161, 0.1); }  

    .pool-dashboard { width: 100%; display: flex; justify-content: space-between; gap: 8px; margin-top: 20px; margin-bottom: 10px; }  
    .pool-box { 
        flex: 1; background: #11121a; 
        border: 1px solid #333; 
        border-radius: 8px; padding: 10px 5px; text-align: center; display: flex; flex-direction: column; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        transition: 0.3s;
    }
    .pool-box:hover { border-color: var(--primary); transform: translateY(-2px); }
    .pool-title { font-size: 0.6em; color: #666; text-transform: uppercase; margin-bottom: 3px; letter-spacing: 1px;}  
    .pool-value { font-size: 0.8em; font-weight: bold; text-shadow: 0 0 5px rgba(255,255,255,0.1); }  
    .text-eth { color: var(--eth-color); } .text-usdt { color: var(--usdt-color); } .text-shib { color: var(--shib-color); }

    .card-stats-container { width: 100%; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; font-size: 0.6em; font-weight: bold; }  
    .c-stat { display: flex; align-items: center; gap: 2px; }

    .main-bet-btn { 
        margin-top: 15px; 
        background: linear-gradient(90deg, var(--primary), var(--accent)); 
        color: white; border: none; 
        padding: 13px 0; width: 50%; border-radius: 50px; 
        font-size: 0.9em; font-weight: bold; cursor: pointer; transition: 0.3s; 
        box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); 
        text-transform: uppercase; letter-spacing: 1px;
    }
    .main-bet-btn:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 0 25px var(--accent); 
        filter: brightness(1.2);
    }  

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }  
    .modal-content { 
        background: #1a1b26; 
        width: 90%; max-width: 380px; padding: 25px; border-radius: 15px; text-align: center; 
        border: 1px solid var(--accent); 
        box-shadow: 0 0 50px rgba(208, 0, 255, 0.2); 
        position: relative;
    }  
    .modal-title { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; color: var(--text); }  
    .pay-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }  
    .pay-btn { 
        display: flex; justify-content: space-between; align-items: center; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 13px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        transition: 0.2s;
    }
    .pay-btn:hover { transform: scale(1.02); filter: brightness(1.1); }
    .btn-eth { background: linear-gradient(90deg, #3c40c6, #575fcf); } 
    .btn-usdt { background: linear-gradient(90deg, #05c46b, #00d2d3); } 
    .btn-shib { background: linear-gradient(90deg, #ff9f43, #ff6b6b); }  
    
    .close-modal { background: none; border: none; color: #666; font-size: 1.5em; position: absolute; top: 10px; right: 15px; cursor: pointer; transition: 0.2s; }
    .close-modal:hover { color: #fff; }  

    .dash-profile { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }  
    .dash-balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; text-align: left; }  
    .dash-item { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); }  
    .dash-label { font-size: 0.65em; color: #888; display: block; text-transform: uppercase; }  
    /* --- WARNA SALDO DI MODAL WALLET --- */

/* Saldo ETH (Mengambil warna dari --eth-color) */
.dash-val.text-eth { 
    color: var(--eth-color) !important; 
    text-shadow: 0 0 5px rgba(98, 126, 234, 0.3); /* Tambah sedikit glow biar keren */
}   

/* Saldo USDT (Mengambil warna dari --usdt-color) */
.dash-val.text-usdt { 
    color: var(--usdt-color) !important; 
    text-shadow: 0 0 5px rgba(38, 161, 123, 0.3);
}  

/* Saldo SHIB (Mengambil warna dari --shib-color) */
.dash-val.text-shib { 
    color: var(--shib-color) !important; 
    text-shadow: 0 0 5px rgba(255, 164, 9, 0.3);
}  
    .btn-disconnect { background: rgba(255, 42, 109, 0.2); border: 1px solid var(--danger); width: 100%; padding: 10px; border-radius: 8px; color: var(--danger); font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-disconnect:hover { background: var(--danger); color: white; }

    /* --- REFERRAL CSS --- */  
    .referral-panel { 
        margin-top: 25px; width: 100%; 
        background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); 
        padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); 
        text-align: center; display: none; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
    }  
    .ref-label { font-size: 0.7em; color: var(--primary); margin-bottom: 5px; letter-spacing: 1px; font-weight: bold; }  
    .ref-box { background: #080808; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; margin-top: 5px; font-size: 0.8em; color: #888; }  
    .btn-copy { 
        background: var(--success) !important; color: #000; border: 2px solid #04b371; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold; transition: 0.2s; 
    }  
    
    .btn-copy:hover { 
    background: #00d2ff;
    color: #000;
    box-shadow: inset 0 0 0 2px #00a8cc, 0 0 15px #69ffc7; 
    }
    
    .ref-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; margin-bottom: 10px; }  
    .ref-stat-item { background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; }  
    .rs-val { font-size: 1.2em; font-weight: bold; color: white; text-shadow: 0 0 5px rgba(255,255,255,0.2); }  
    .rs-lbl { font-size: 0.65em; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; }  

    .comm-info { font-size: 0.65em; color: #666; margin-top: 15px; font-style: italic; border-top: 1px dashed #333; padding-top: 8px;}  

    .withdraw-section { margin-top:15px; padding-top:10px; border-top:1px dashed #444; text-align:left; }  
    .withdraw-title { font-size:0.7em; color:#aaa; margin-bottom:5px; }  
    .btn-withdraw-small { background: rgba(5, 255, 161, 0.2); color: var(--success); border: 1px solid var(--success); padding: 4px 8px; border-radius: 4px; font-weight:bold; cursor:pointer; font-size:0.8em; float:right; transition: 0.2s; }  
    .btn-withdraw-small:hover { background: var(--success); color: #000; }

    #toast { visibility: hidden; min-width: 250px; background: linear-gradient(90deg, #03a9f4, #f441a5);
    color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 999; bottom: 30px; left: 50%; transform: translateX(-50%); border: 1px solid var(--primary); box-shadow: 0 0 20px rgba(0,0,0,0.5); }  
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 7.5s; }  
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }  
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    /* --- WINNER GLAMOUR EXTREME --- */
.winner-glamour { 
    border-color: var(--gold) !important; 
    position: relative;
    
    background: radial-gradient(circle, rgba(255,215,0,0.35) 0%, rgba(255,165,0,0.10) 70%) !important;

    animation: glamourPulseExtreme 0.5s infinite alternate ease-in-out !important; 

    box-shadow: 
        0 0 25px rgba(255,215,0,0.6),
        0 0 50px rgba(255,215,0,0.4),
        0 0 80px rgba(255,215,0,0.2) !important;

    transform-origin: center;
    z-index: 20;
}

/* --- BADGE WINNER --- */
.winner-glamour::before { 
    content: "WINNER";

    position: absolute; 
    top: -18px;
    left: 50%;
    transform: translateX(-50%);

    background: 
        url("cup.png") no-repeat 8px center / 16px auto,
        linear-gradient(45deg, #fff2a8, #ffca28, #ff9100);

    padding: 5px 16px 5px 32px;
    font-size: 0.9em;
    font-weight: 900;
    color: #000;

    border-radius: 20px;
    border: 2px solid #fff;

    box-shadow: 
        0 0 15px rgba(255,215,0,1),
        0 0 30px rgba(255,185,0,0.9),
        0 0 45px rgba(255,165,0,0.8);

    animation: winnerBounceExtreme 0.7s infinite ease-in-out,
               winnerGlow 1.2s infinite alternate ease-in-out;
}

/* --- ANIMASI --- */

/* Border + scale pulsating gila */
@keyframes glamourPulseExtreme {
    0% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(255,215,0,0.5);
    }
    100% {
        transform: scale(1.06);
        box-shadow: 0 0 60px rgba(255,215,0,0.9);
    }
}

/* Lompatan ekstrem untuk badge WINNER */
@keyframes winnerBounceExtreme {
    0% { transform: translateX(-50%) translateY(0); }
    50% { transform: translateX(-50%) translateY(-8px) scale(1.2); }
    100% { transform: translateX(-50%) translateY(0); }
}

/* Glow warna naik turun */
@keyframes winnerGlow {
    0% { filter: drop-shadow(0 0 5px gold); }
    100% { filter: drop-shadow(0 0 20px orange); }
}
    
    /* --- HISTORY CARDS --- */
    .history-section { margin-top: 30px; width: 100%; }  
    .history-card { 
        background: #1a1b26; 
        padding: 15px; border-radius: 12px; margin-bottom: 15px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative; 
        border: 1px solid var(--primary);
    }  
    .history-reels { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }  
    .history-reel-img { width: 40px; height: 40px; object-fit: contain; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }  
    .history-outcome { font-weight: bold; color: var(--text); font-size: 0.9em; text-shadow: 0 0 5px rgba(255,255,255,0.1); }  
    
    .history-tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }  
    .tab-btn { 
        flex: 1; padding: 10px; background: rgba(255,255,255,0.05); 
        border: 1px solid transparent; color: #888; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: 0.3s; 
    }  
    .tab-btn:hover { background: rgba(255,255,255,0.1); color: white; }
    .tab-btn.active { 
        background: rgba(0, 210, 255, 0.1); 
        color: var(--primary); 
        border-color: var(--primary); 
        box-shadow: 0 0 10px rgba(0, 210, 255, 0.1); 
    }  
    .btn-load-more { width: 100%; padding: 12px; background: transparent; border: 1px dashed #555; color: #888; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 0.8em; transition: 0.3s; }  
    .btn-load-more:hover { border-color: var(--primary); color: var(--primary); }  
    .hidden { display: none; }  
    
    .personal-bet-card { 
        background: rgba(255,255,255,0.02); 
        border-left: 3px solid #555; padding: 10px; margin-bottom: 10px; border-radius: 6px; 
        display: flex; justify-content: space-between; align-items: center; 
        transition: 0.2s;
    } 
    .personal-bet-card:hover { background: rgba(255,255,255,0.05); } 
    .pb-info { font-size: 0.8em; }  
    .pb-time { font-size: 0.7em; color: #666; }  
    .pb-animal { font-weight: bold; color: var(--primary); }  
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; text-transform: uppercase; }  
    .badge-win { background: rgba(5, 255, 161, 0.1); color: var(--success); border: 1px solid var(--success); }  
    .badge-lose { background: rgba(255, 42, 109, 0.1); color: var(--danger); border: 1px solid var(--danger); }  

    /* --- SOCIAL BAR --- */  
    .social-bar {  
        display: flex; justify-content: space-between; align-items: center;  
        margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05);  
    }  
    .star-group { display: flex; align-items: center; gap: 2px; }  
    .star-btn { cursor: pointer; font-size: 1.3em; color: #444; transition: 0.2s; line-height: 1; }  
    .star-btn:hover { transform: scale(1.2); }  
    .star-btn.active { color: var(--gold); text-shadow: 0 0 10px rgba(255, 221, 89, 0.6); }  
    .star-count { font-size: 0.7em; color: #888; margin-left: 6px; }  
    .star-btn.hover-gold { color: var(--gold) !important; text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); transform: scale(1.1); }  
    .star-btn.dimmed { color: #333 !important; text-shadow: none !important; transform: scale(1); }  
    
    .like-wrapper { display: flex; align-items: center; gap: 10px; }  
    
    .btn-like-single {  
        background: #111; border: 1px solid #333; color: #aaa; border-radius: 6px; padding: 5px 12px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 6px; transition: 0.3s;  
    }  
    .btn-like-single:hover { border-color: var(--success); color: white; background: rgba(5, 255, 161, 0.1); }  
    .btn-like-single:active { transform: scale(0.95); }  

    /* --- COMMENTS --- */
    .btn-comment-toggle {  
        background: #111; border: 1px solid #333; color: #aaa; border-radius: 6px; padding: 5px 12px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 6px; transition: 0.3s;  
    }  
    .btn-comment-toggle:hover { border-color: var(--primary); color: white; background: rgba(0, 210, 255, 0.1); }  
    .btn-comment-toggle:active { transform: scale(0.95); }  
    
    .comments-container { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }  
    .comment-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; max-height: 300px; overflow-y: auto; }  
    .comment-item { display: flex; gap: 8px; align-items: flex-start; }  
    
    .comment-bubble {  
        background: #252836; padding: 10px 12px; padding-right: 30px; border-radius: 12px; flex: 1; position: relative; min-width: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }  
    .btn-edit-icon { position: absolute; top: 8px; right: 8px; background: none; border: none; color: #666; cursor: pointer; padding: 2px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }  
    .btn-edit-icon:hover { color: var(--primary); transform: scale(1.1); }  
    
    .comment-author { font-weight: bold; color: var(--primary); font-size: 0.85em; cursor: pointer; }  
    .comment-text { color: #ddd; margin-top: 4px; word-wrap: break-word; white-space: pre-wrap; font-size: 0.9em; line-height: 1.4; }  
    .comment-meta { font-size: 0.7em; color: #555; margin-top: 6px; display: flex; gap: 10px; }  
    .comment-actions { color: #777; cursor: pointer; text-decoration: underline; }  
    .comment-actions:hover { color: white; }  

    .comment-input-area { display: flex; gap: 8px; margin-top: 10px; align-items: flex-end; }  
    .input-comment {  
        flex: 1; background: #0f1016; border: 1px solid #333; color: white; padding: 10px; border-radius: 12px; font-size: 0.9em; font-family: inherit; resize: vertical; min-height: 40px; max-height: 200px; overflow: auto; transition: 0.3s;
    }  
    .input-comment:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 210, 255, 0.1); outline: none; }  
    
    .btn-post-comment {  
        background: var(--primary); color: #000; border: none; height: 40px; width: 40px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; box-shadow: 0 0 10px rgba(0, 210, 255, 0.3);
    }
    .btn-post-comment:hover { transform: scale(1.1); box-shadow: 0 0 15px var(--primary); color: white;}

    /* --- HISTORY SECTION (CYBERPUNK STYLE) --- */
    .history-section { margin-top: 30px; width: 100%; }  
    
    .history-card { 
        background: #161822; /* Panel gelap */
        padding: 15px; 
        border-radius: 12px; 
        margin-bottom: 15px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
        position: relative; 
        border: 1px solid var(--primary); /* Aksen neon kiri */
        transition: transform 0.2s;
    }
    .history-card:hover { transform: translateX(2px); }

    .history-reels { 
        display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; 
        background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px;
    }  
    .history-reel-img { 
        width: 40px; height: 40px; object-fit: contain; 
        filter: drop-shadow(0 0 2px rgba(255,255,255,0.2)); 
    }  
    
    .history-outcome { 
        font-weight: 800; color: var(--text); 
        font-size: 0.95em; 
        text-shadow: 0 0 5px rgba(255,255,255,0.1); 
        letter-spacing: 0.5px;
    }  
    
    .history-tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }  
    .tab-btn { 
        flex: 1; padding: 10px; 
        background: rgba(255,255,255,0.03); 
        border: 1px solid rgba(255,255,255,0.05); 
        color: #888; border-radius: 8px; 
        cursor: pointer; font-weight: bold; font-size: 0.85em; 
        transition: all 0.3s; 
        text-transform: uppercase;
    }  
    .tab-btn:hover { 
        background: rgba(255,255,255,0.08); color: white; 
    }
    .tab-btn.active { 
        background: rgba(0, 210, 255, 0.1); 
        color: var(--primary); 
        border-color: var(--primary); 
        box-shadow: 0 0 10px rgba(0, 210, 255, 0.1); 
    }  
    
    .btn-load-more { 
        width: 100%; padding: 12px; 
        background: transparent; 
        border: 1px dashed #444; 
        color: #888; border-radius: 8px; 
        margin-top: 10px; cursor: pointer; 
        font-size: 0.8em; font-weight: bold; 
        transition: 0.3s; 
    }  
    .btn-load-more:hover { 
        border-color: var(--primary); 
        color: var(--primary); 
        background: rgba(0, 210, 255, 0.05);
        box-shadow: 0 0 10px rgba(0, 210, 255, 0.1);
    }  
    .hidden { display: none; }  
    
    .personal-bet-card { 
        background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
        border: 1px solid #fedc57; 
        padding: 12px; margin-bottom: 10px; border-radius: 6px; 
        display: flex; justify-content: space-between; align-items: center; 
        transition: 0.2s;
    } 
    .personal-bet-card:hover { background: rgba(255,255,255,0.05); }

    .pb-info { font-size: 0.8em; }  
    .pb-time { font-size: 0.7em; color: #666; margin-bottom: 2px; }  
    .pb-animal { font-weight: bold; color: var(--primary); text-shadow: 0 0 5px rgba(0, 210, 255, 0.3); }  
    
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; text-transform: uppercase; }  
    .badge-win { 
        background: rgba(5, 255, 161, 0.1); 
        color: var(--success); 
        border: 1px solid var(--success); 
        box-shadow: 0 0 5px rgba(5, 255, 161, 0.2);
    }  
    .badge-lose { 
        background: rgba(255, 42, 109, 0.1); 
        color: var(--danger); 
        border: 1px solid var(--danger); 
    }  

    /* --- SOCIAL & COMMENTS (GLOWING EFFECTS) --- */
    .social-bar {  
        display: flex;  
        justify-content: space-between;  
        align-items: center;  
        margin-top: 15px;  
        padding-top: 12px;  
        border-top: 1px solid rgba(255, 255, 255, 0.05);  
    }  
    
    .star-group { display: flex; align-items: center; gap: 4px; }  
    .star-btn { 
        cursor: pointer; font-size: 1.4em; color: #444; 
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        line-height: 1; 
    }  
    .star-btn:hover { transform: scale(1.3) rotate(10deg); }  
    .star-btn.active { color: var(--gold); text-shadow: 0 0 10px rgba(255, 221, 89, 0.6); }  
    
    .star-btn.hover-gold { color: var(--gold) !important; text-shadow: 0 0 15px rgba(255, 215, 0, 0.8); transform: scale(1.2); }  
    .star-btn.dimmed { color: #333 !important; text-shadow: none !important; transform: scale(0.9); opacity: 0.5; }  
    .star-count { font-size: 0.75em; color: #888; margin-left: 8px; font-weight: bold; }  

    .like-wrapper { display: flex; align-items: center; gap: 10px; }  
    
    /* Tombol Like & Comment seragam */
    .btn-like-single, .btn-comment-toggle {  
        background: #11121a;  
        border: 1px solid rgba(255,255,255,0.1);  
        color: #aaa;  
        border-radius: 8px;  
        padding: 3px 8px;  
        cursor: pointer;  
        font-size: 0.85em;  
        display: flex; align-items: center; gap: 3px;  
        transition: all 0.3s ease;  
    }  
    .btn-like-single:hover { 
        border-color: var(--success); color: #fff; 
        background: rgba(5, 255, 161, 0.1); 
        box-shadow: 0 0 10px rgba(5, 255, 161, 0.2);
    }  
    .btn-comment-toggle:hover { 
        border-color: var(--primary); color: #fff; 
        background: rgba(0, 210, 255, 0.1); 
        box-shadow: 0 0 10px rgba(0, 210, 255, 0.2);
    }
    .btn-like-single:active, .btn-comment-toggle:active { transform: scale(0.95); }  

    /* --- COMMENTS AREA --- */
    .comments-container {  
        display: none;   
        margin-top: 15px;  
        padding-top: 15px;  
        border-top: 1px dashed rgba(255,255,255,0.1);  
        background: rgba(0,0,0,0.25);  
        padding: 15px;  
        border-radius: 12px;  
        animation: slideDown 0.3s ease-out;
    }  
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .comment-list { 
        display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; 
        max-height: 300px; overflow-y: auto; padding-right: 5px;
    }  
    
    .comment-item { display: flex; gap: 10px; align-items: flex-start; }  
    
    .comment-bubble {  
        background: #1f222e;  
        padding: 10px 14px;  
        padding-right: 35px;   
        border-radius: 12px; 
        border-top-left-radius: 2px;
        flex: 1; position: relative; min-width: 0; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.05);
    }  

    .btn-edit-icon { 
        position: absolute; top: 8px; right: 8px; background: none; border: none; color: #555; 
        cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s; display: flex; 
    }  
    .btn-edit-icon:hover { color: var(--primary); background: rgba(0, 210, 255, 0.1); }  
    
    .comment-author { font-weight: 700; color: var(--primary); font-size: 0.85em; cursor: pointer; text-shadow: 0 0 5px rgba(0, 210, 255, 0.2); }  
    .comment-text { color: #e0e6ed; margin-top: 4px; word-wrap: break-word; white-space: pre-wrap; font-size: 0.9em; line-height: 1.5; }  
    .comment-meta { font-size: 0.7em; color: #666; margin-top: 8px; display: flex; gap: 10px; align-items: center; }  
    
    .comment-input-area { display: flex; gap: 10px; margin-top: 10px; align-items: flex-end; background: #111; padding: 5px; border-radius: 15px; border: 1px solid #333; }  
    
    .input-comment {  
        flex: 1; background: transparent; border: none; color: white; padding: 10px; border-radius: 12px; 
        font-size: 0.9em; font-family: inherit; resize: vertical; min-height: 40px; max-height: 150px; overflow: auto; 
    }  
    .input-comment:focus { outline: none; }  
    
    .btn-post-comment {  
        background: linear-gradient(135deg, var(--primary), var(--accent)); 
        color: white; border: none; 
        height: 36px; width: 36px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; 
        transition: 0.3s; box-shadow: 0 0 10px rgba(0, 210, 255, 0.3); margin-bottom: 2px; margin-right: 2px;
    }
    .btn-post-comment:hover { transform: scale(1.1) rotate(-10deg); box-shadow: 0 0 20px var(--primary); }

    /* --- SCROLLBAR CUSTOM --- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0b0c15; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    
    /* --- SOCIAL & COMMENTS STYLING (CYBERPUNK THEME) --- */

    /* Container Utama Bar Sosial */
    .social-bar {  
        display: flex;  
        justify-content: space-between; /* Kunci agar elemen menyebar rata */
        align-items: center;  
        margin-top: 10px;  
        padding-top: 8px;  
        border-top: 1px solid rgba(255,255,255,0.05);  
        width: 100%;
    }
    
    /* Opsional: Agar Tombol Like dan Komen punya lebar sama 
       supaya Bintang benar-benar persis di tengah layar */
    .btn-like-single, .btn-comment-toggle {
        min-width: 60px; /* Atur lebar minimal */
    }  

    /* Grup Bintang Rating */
    .star-group { 
        display: flex; 
        align-items: center; 
        gap: 4px; /* Jarak antar bintang */
    }  
    .star-btn {  
        cursor: pointer;  
        font-size: 1.4em;  
        color: #444; /* Warna mati (abu gelap) */  
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efek membal saat hover */
        line-height: 1;  
    }  
    .star-btn:hover { 
        transform: scale(1.3) rotate(15deg); /* Efek membesar & miring saat hover */
    }  
    
    /* Bintang Menyala (Aktif) */  
    .star-btn.active { 
        color: var(--gold); 
        text-shadow: 0 0 10px rgba(255, 221, 89, 0.8), 0 0 20px rgba(255, 221, 89, 0.4); /* Glow emas */
    }  
    
    /* Hover Effects (Preview & Dimmed) */
    .star-btn.hover-gold {   
        color: var(--gold) !important;   
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);   
        transform: scale(1.2);  
    }  
    .star-btn.dimmed {  
        color: #333 !important;  
        text-shadow: none !important;  
        transform: scale(0.9);  
        opacity: 0.5;
    }  

    .star-count {   
        font-size: 0.75em;   
        color: #aaa;   
        margin-left: 8px;   
        font-weight: bold;
    }  

    /* Wrapper Tombol Like & Comment */
    .like-wrapper { 
        display: flex; 
        align-items: center; 
        gap: 10px; /* Jarak antara tombol Like dan Komen */
    }  
  
    /* Container Area Komentar */
    .comments-container {  
        display: none;   
        margin-top: 15px;  
        padding-top: 15px;  
        border-top: 1px dashed rgba(255,255,255,0.1);  
        background: rgba(0,0,0,0.25);  
        padding: 15px;  
        border-radius: 12px;
        animation: slideDown 0.3s ease-out; /* Animasi muncul */
    }  
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* List Komentar */
    .comment-list {  
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        margin-bottom: 15px;  
        max-height: 300px; 
        overflow-y: auto;  
        padding-right: 5px; /* Ruang untuk scrollbar */
    }  
    
    /* Scrollbar Custom untuk List Komentar */
    .comment-list::-webkit-scrollbar { width: 4px; }
    .comment-list::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    .comment-list::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    .comment-item { display: flex; gap: 10px; align-items: flex-start; }  
  
    /* Bubble Komentar */
    .comment-bubble {  
        background: #1f222e;  
        padding: 10px 14px;  
        padding-right: 35px; /* Ruang untuk icon edit */  
        border-radius: 12px;  
        border-top-left-radius: 2px; /* Aksen chat bubble */
        flex: 1;  
        position: relative;   
        min-width: 0;  
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.05);
    }  

    /* Icon Edit (Pensil) */
    .btn-edit-icon {  
        position: absolute;  
        top: 8px;  
        right: 8px;  
        background: none;  
        border: none;  
        color: #555;  
        cursor: pointer;  
        padding: 4px;  
        border-radius: 4px;
        transition: 0.2s;  
        display: flex;  
        align-items: center;  
        justify-content: center;  
    }  
    .btn-edit-icon:hover {  
        color: var(--primary);  
        background: rgba(0, 210, 255, 0.1);
        transform: scale(1.1);  
    }  
  
    /* Nama User Komentar */
    .comment-author { 
        font-weight: 700; 
        color: var(--primary); 
        font-size: 0.85em; 
        cursor: pointer; /* Kursor jari */
        margin-bottom: 2px;
        transition: 0.2s;
    }
    
    /* Efek saat mouse diarahkan ke nama/avatar */
    .comment-author:hover {
        text-decoration: underline;
        opacity: 0.8;
    }  
  
    /* Isi Teks Komentar */
    .comment-text {   
        color: #e0e0e0;   
        margin-top: 4px;   
        word-wrap: break-word;   
        white-space: pre-wrap;   
        font-size: 0.9em;  
        line-height: 1.5;  
    }  
  
    /* Metadata (Waktu & Status Edit) */
    .comment-meta { 
        font-size: 0.7em; 
        color: #666; 
        margin-top: 8px; 
        display: flex; 
        gap: 10px; 
        align-items: center;
    }  
    
    /* Area Input Komentar */
    .comment-input-area { 
        display: flex; 
        gap: 10px; 
        margin-top: 10px; 
        align-items: flex-end; 
        background: #111; 
        padding: 5px; 
        border-radius: 15px; 
        border: 1px solid #333;
    }  
  
    /* Textarea Input */
    .input-comment {  
        flex: 1;   
        background: transparent;   
        border: none;   
        color: white;  
        padding: 10px;   
        font-size: 0.9em;  
        font-family: inherit;  
        resize: vertical; 
        min-height: 40px; 
        max-height: 150px; 
        overflow: auto;  
    }  
    .input-comment:focus { outline: none; } /* Hilangkan outline default */ 
  
    /* Tombol Kirim (Pesawat Kertas) */
    .btn-post-comment {  
        background: linear-gradient(135deg, var(--primary), var(--accent)); 
        color: #fff; 
        border: none;  
        height: 36px; width: 36px; 
        border-radius: 50%;   
        font-weight: bold; cursor: pointer; display: flex;   
        align-items: center; justify-content: center;  
        transition: 0.3s;
        box-shadow: 0 0 10px rgba(0, 210, 255, 0.3);
        margin-bottom: 2px;
        margin-right: 2px;
    }
    .btn-post-comment:hover {
        transform: scale(1.1) rotate(-10deg);
        box-shadow: 0 0 20px var(--primary);
        }

    h1, h2, h3 {
        background: linear-gradient(90deg, #03a9f4, #f441a5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
    }

    .comment-image-result {
        margin-top: 8px;
        max-width: 100%;
        max-height: 150px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.2);
        cursor: pointer;
        transition: 0.2s;
        display: block; /* Biar turun ke bawah */
    }
    .comment-image-result:hover { opacity: 0.8; }

    /* --- TOMBOL PROFIL (POJOK KANAN BAWAH) --- */
    .btn-view-profile {
        position: absolute; /* Wajib absolute */
        bottom: 8px;        /* Jarak dari bawah */
        right: 8px;         /* Jarak dari kanan */
        
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 6px;
        padding: 4px 6px;
        cursor: pointer;
        transition: 0.2s;
        display: flex; align-items: center; justify-content: center;
        z-index: 5; /* Agar tidak tertutup elemen lain */
    }

    .btn-view-profile:hover {
        background: var(--accent); /* Ungu Neon */
        border-color: var(--accent);
        transform: scale(1.1);
        box-shadow: 0 0 10px var(--accent);
        color: white;
    }

    /* ========================================= */
    /* CSS PLAYER PROFILE (CARD STYLE)      */
    /* ========================================= */

    /* 1. Container Avatar (Lingkaran Luar dengan Glow) */
    .profile-avatar {
        width: 90px; 
        height: 90px;
        margin: 0 auto 15px auto;
        border-radius: 50%;
        padding: 3px; /* Jarak antara border pelangi dan gambar */
        
        /* Efek Border Gradient Cyberpunk berputar */
        background: linear-gradient(135deg, var(--primary), var(--accent)); 
        
        /* Efek Bersinar (Glow) */
        box-shadow: 0 0 25px rgba(0, 210, 255, 0.4); 
        position: relative;
    }

    /* 2. Gambar Avatar (Robot/User) */
    .profile-avatar img, #my-avatar-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        background: #0b0c15; /* Background gelap di belakang robot transparan */
        display: block;
        border: 3px solid #1a1b26; /* Border dalam pemisah */
    }

    /* 3. Teks Nickname Besar */
    #pp-nickname {
        font-size: 1.6em;
        font-weight: 800;
        color: #fff;
        text-shadow: 0 0 15px var(--primary); /* Teks menyala biru */
        margin-bottom: 8px;
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    /* 4. Alamat Wallet (Gaya Coding/Hacker) */
    #pp-address {
        font-family: 'Courier New', monospace; /* Font coding */
        font-size: 0.75em;
        color: #aaa;
        background: rgba(0,0,0,0.4);
        padding: 6px 12px;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.1);
        display: inline-block;
        letter-spacing: 0.5px;
        transition: 0.3s;
    }
    #pp-address:hover {
        border-color: var(--primary);
        color: #fff;
        background: rgba(0, 210, 255, 0.1);
    }

    /* 5. Kotak Statistik (Wins & Bets) */
    .profile-stat-box {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.05);
        padding: 15px 10px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: 0.3s;
    }
    .profile-stat-box:hover {
        background: rgba(255,255,255,0.06);
        border-color: var(--primary);
        transform: translateY(-2px);
    }

    /* Khusus Kotak WIN (Warna Emas) */
    .stat-win-box {
        border-color: rgba(255, 215, 0, 0.3) !important;
        background: radial-gradient(circle, rgba(255, 215, 0, 0.05) 0%, transparent 90%);
        box-shadow: inset 0 0 15px rgba(255, 215, 0, 0.05);
    }

    /* 6. Item List Riwayat (Recent Activity) */
    /* Ini menggantikan style inline JS sebelumnya */
    .pp-history-item {
        padding: 10px;
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        margin-bottom: 6px;
        border-left: 2px solid #333;
        transition: 0.2s;
        font-size: 0.8em;
    }
    .pp-history-item:hover {
        background: rgba(255,255,255,0.05);
        border-left-color: var(--primary);
    }

    /* 7. Scrollbar Custom di dalam Modal */
    #pp-history-list::-webkit-scrollbar {
        width: 4px;
    }
    #pp-history-list::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1); 
    }
    #pp-history-list::-webkit-scrollbar-thumb {
        background: #333; 
        border-radius: 2px;
    }
    #pp-history-list::-webkit-scrollbar-thumb:hover {
        background: var(--primary);
    }

    /* --- CSS UNTUK MODE EDIT --- */
    
    /* Container untuk indikator gambar lama & preview baru */
    .edit-image-container {
        background: rgba(0,0,0,0.3);
        border: 1px solid #333;
        padding: 8px;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    /* Thumbnail gambar di mode edit */
    .edit-thumb {
        width: 50px; height: 50px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #555;
        margin-right: 10px;
    }

    /* Tombol X Merah (Hapus Gambar) */
    .btn-delete-img {
        background: rgba(220, 53, 69, 0.2); /* Merah transparan */
        color: var(--danger);
        border: 1px solid var(--danger);
        width: 30px; height: 30px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; font-weight: bold; font-size: 1.2em;
        transition: 0.2s;
    }
    .btn-delete-img:hover {
        background: var(--danger);
        color: white;
    }

    /* --- HERO SECTION STYLING --- */
    .hero-section {
        text-align: center;
        padding: 40px 20px 20px 20px;
        position: relative;
        overflow: hidden;
    }

    /* Efek Cahaya di Belakang Judul */
    .hero-section::before {
        content: '';
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 900%;
        background: var(--accent);
        filter: blur(80px);
        opacity: 0.3;
        z-index: -1;
    }

    /* Badge Live Status */
    .hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.7em;
        font-weight: bold;
        color: #aaa;
        margin-bottom: 15px;
        letter-spacing: 1px;
    }

    .live-dot {
        width: 8px; height: 8px;
        background-color: var(--success);
        border-radius: 50%;
        box-shadow: 0 0 10px var(--success);
        animation: blink 1.5s infinite;
    }

    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    /* Judul Utama */
    .hero-title {
        font-size: 2.5em;
        font-weight: 900;
        margin: 0;
        line-height: 1.1;
        color: white;
        letter-spacing: -1px;
    }

    /* Teks Gradasi (Ultimate) */
    .hero-gradient {
        background: linear-gradient(90deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
        filter: drop-shadow(0 0 15px rgba(208, 0, 255, 0.4));
    }

    /* Subtitle */
    .hero-subtitle {
        font-size: 0.9em;
        color: #888;
        margin-top: 10px;
        line-height: 1.6;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .hero-subtitle b { color: #ddd; }

    footer {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        background: var(--gradient-bg); /* Warna gelap */
        color: #ddd; /* Warna teks */
        font-size: 12px;
    }

    .social-icons {
        margin-bottom: 10px;
    }

    .social-icons a {
    background: rgba(255, 255, 255, 0.2); /* Transparan seperti kaca */
    border-radius: 10px; /* Agar sedikit membulat */
    padding: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white; /* Warna ikon */
    font-size: 15px;
    margin: 0 5px;
    text-decoration: none;
    transition: transform 0.5s ease, text-shadow 0.5s ease, box-shadow 0.5s ease;
    box-shadow: 0 0 10px rgba(0, 0, 255, 0.6); /* Cahaya biru */
    backdrop-filter: blur(10px); /* Efek blur kaca */
}

/* Efek saat hover */
.social-icons a:hover {
    color: #1a88ff; /* Warna biru neon */
    text-shadow: 0 0 10px #1a88ff, 0 0 20px #1a88ff, 0 0 30px #1a88ff; /* Glow lebih intens */
    box-shadow: 0 0 20px rgba(0, 0, 255, 1), 0 0 30px rgba(0, 0, 255, 0.8); /* Shadow lebih terang */
    transform: rotate(360deg); /* Efek berputar */
}

    /* --- CSS TIMER COUNTDOWN --- */
    .draw-timer {
        font-family: 'Courier New', monospace; /* Font gaya digital */
        font-size: 1.5em;
        font-weight: bold;
        color: var(--primary); /* Warna Biru Neon */
        text-shadow: 0 0 10px var(--primary);
        margin: 10px 0;
        letter-spacing: 2px;
        background: rgba(0, 0, 0, 0.5);
        padding: 5px 20px;
        border-radius: 8px;
        border: 1px solid rgba(0, 210, 255, 0.3);
        display: inline-block;
    }

    /* --- REFERRAL LIST STYLE --- */
    .ref-status-box {
        background: rgba(255,255,255,0.05);
        border: 1px solid #333;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        font-size: 0.8em;
        color: #ccc;
        text-align: left;
    }
    
    .ref-requirement {
        display: flex; justify-content: space-between; margin-bottom: 5px;
    }
    .req-ok { color: var(--success); }
    .req-no { color: var(--danger); }

    .referral-list-container {
        margin-top: 15px;
        max-height: 150px;
        overflow-y: auto;
        background: #0b0c15;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 5px;
    }
    
    .ref-item-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 8px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        font-size: 0.75em;
    }
    .ref-item-row:last-child { border-bottom: none; }
    
    /* Tombol Create Nickname yang diperbaiki */
    .btn-create-nick {
        width: 50%; 
        background: linear-gradient(90deg, var(--primary), var(--accent));
        border: none;
        color: white;
        padding: 10px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
        box-shadow: 0 0 10px var(--primary);
        transition: 0.3s;
    }
    .btn-create-nick:hover { transform: scale(1.05); }

    /* --- STATISTIK HERO (Earnings & Winners) --- */
    .winning-box {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
        border: 1px solid var(--gold); /* Default warna Emas */
        border-radius: 12px;
        padding: 15px 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
        text-align: center;
        transition: 0.3s;
    }
    
    /* Efek Hover */
    .winning-box:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.05);
    }

    /* Efek Kilatan Cahaya (Shine) */
    .winning-box::after {
        content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        animation: shine 3s infinite;
    }
    @keyframes shine { 100% { left: 200%; } }

    /* Angka Statistik */
    .winning-value {
        font-family: 'Courier New', monospace;
        font-weight: 900;
        color: var(--gold);
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        letter-spacing: -0.5px;
    }
</style>
</head>
<body>
<header>
    <div style="display:flex; align-items:center; font-weight:bold; font-size:1.2em;">
        <img src="logo.svg" style="height:30px; margin-right:8px;"> 
        <span style="
            background: linear-gradient(90deg, #03a9f4, #f441a5);
           -webkit-background-clip: text;
           -webkit-text-fill-color: transparent;
            color: transparent;
            filter: drop-shadow(0 0 5px rgba(0, 210, 255, 0.5));
            letter-spacing: 1px;">
            Faylotto
        </span>
    </div>
    <button id="connectBtn" class="wallet-btn" onclick="handleWalletClick()" style="display: flex; align-items: center; gap: 8px;">
    <img src="con.svg" style="width: 20px; height: 20px;">
    <span>Connect</span></button>
</header>

<div class="hero-section">
    <div class="hero-badge">
        <span class="live-dot"></span> LIVE ON BASE
    </div>
    
    <h1 class="hero-title">
        Slot <span class="hero-gradient">Ultimate</span>
    </h1>
    
    <p class="hero-subtitle">
        The First Decentralized Slot Web3 Social.<br>
        <b>Bet Play Together Win & Instant Rewards!</b>
    </p>
</div>

<div class="layout-container">
    <div class="slot-machine">
        <div class="reels-container">
            <div class="reel"><img id="imgReel1" src="what.svg" class="reel-img"></div>
            <div class="reel"><img id="imgReel2" src="what.svg" class="reel-img"></div>
            <div class="reel"><img id="imgReel3" src="what.svg" class="reel-img"></div>
        </div>
        <div class="draw-section">
            <button id="drawBtn" class="btn-draw" onclick="executeDraw()" disabled>DRAW NOW!</button>            
            <div id="drawTimer" class="draw-timer" style="display:none;">00:35</div>            
            <div id="drawStatus" class="status-text">Waiting for players...</div>
        </div>
    </div>

    <div class="betting-section">
        <h3 style="margin-bottom:5px;">SELECT ANIMAL</h3>
        <div class="bet-grid">
            <div class="bet-card" id="card-0" onclick="selectAnimal('tuna', 0)"><img src="tuna.svg" class="bet-icon-img"><span class="name">Tuna</span><span id="count-0" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-0">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-0">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-0">0</span></span></div></div>
            <div class="bet-card" id="card-1" onclick="selectAnimal('crab', 1)"><img src="crab.svg" class="bet-icon-img"><span class="name">Crab</span><span id="count-1" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-1">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-1">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-1">0</span></span></div></div>
            <div class="bet-card" id="card-2" onclick="selectAnimal('shark', 2)"><img src="shark.svg" class="bet-icon-img"><span class="name">Shark</span><span id="count-2" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-2">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-2">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-2">0</span></span></div></div>
            <div class="bet-card" id="card-3" onclick="selectAnimal('octopus', 3)"><img src="octo.svg" class="bet-icon-img"><span class="name">Octopus</span><span id="count-3" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-3">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-3">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-3">0</span></span></div></div>
            <div class="bet-card" id="card-4" onclick="selectAnimal('shrimp', 4)"><img src="shrimp.svg" class="bet-icon-img"><span class="name">Shrimp</span><span id="count-4" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-4">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-4">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-4">0</span></span></div></div>
            <div class="bet-card" id="card-5" onclick="selectAnimal('orcha', 5)"><img src="orcha.svg" class="bet-icon-img"><span class="name">Orcha</span><span id="count-5" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-5">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-5">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-5">0</span></span></div></div>
        </div>

        <center><div style="width:100%; margin-top:20px; font-size:0.7em; color:#00d2ff; text-align:left;">ESTIMATED TOTAL POOLS (ROUND)</div></center>
        <div class="pool-dashboard">
            
            <div class="pool-box">
                <span class="pool-title">ETH</span>
                <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                    <img src="eth.svg" style="width:14px; height:14px;">
                    <span class="pool-value text-eth" id="poolTotalETH">0.0000</span>
                </div>
            </div>

            <div class="pool-box">
                <span class="pool-title">USDT</span>
                <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                    <img src="usdt.svg" style="width:15px; height:15px;">
                    <span class="pool-value text-usdt" id="poolTotalUSDT">0.00</span>
                </div>
            </div>

            <div class="pool-box">
                <span class="pool-title">SHIB</span>
                <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                    <img src="shib.png" style="width:14px; height:14px;">
                    <span class="pool-value text-shib" id="poolTotalSHIB">0</span>
                </div>
            </div>
        </div>

        <button id="mainBetBtn" class="main-bet-btn" onclick="triggerBetModal()" 

        style="display: flex; align-items: center; justify-content: center; gap: 10px;"><img src="bet.png" style="width: 20px;">PLACE BET</button>
        
        <p style="margin-top:15px; color:#ff9f43; font-size:0.7em;">*Min 5 more Players required to Draw</p>

        <div id="hero-stats-container" style="display:none; width:100%; max-width:480px; margin:0 auto 20px auto;">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        
        <div class="winning-box">
            <div style="font-size:0.6em; color:#aaa; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                MY EARNINGS
            </div>
            <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                <img src="trophy.png" style="width:20px; height:20px; object-fit:contain;">
                <span id="heroTotalWon" class="winning-value" style="font-size:1.2em;">0.00</span>
            </div>
        </div>

        <div class="winning-box" style="border-color:var(--primary);">
            <div style="font-size:0.6em; color:#aaa; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                TOTAL WINNERS
            </div>
            <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                <img src="cup.png" style="width:20px; height:20px; object-fit:contain;">
                <span id="heroGlobalCount" class="winning-value" style="font-size:1.2em; color:var(--primary); text-shadow: 0 0 10px var(--primary);">0</span>
            </div>
        </div>

    </div>
        </div>

        <div id="referralPanel" class="referral-panel">
            
            <div id="view-register" style="display:none;">
                <div class="ref-label" style="color:var(--gold);">NEW PLAYER REGISTRATION</div>
                <p style="font-size:0.8em; color:#aaa; margin:5px 0 15px 0;">Create a nickname to start betting & earning.</p>
                
                <input type="text" id="panelRegNick" placeholder="Enter Nickname (Min 3 Chars)" 
                       style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #444; color:white; border-radius:8px; text-align:center;">
                
                <div id="panelRefInfo" style="font-size:0.75em; color:var(--success); margin-bottom:10px; font-style:italic;"></div>
                
                <button class="btn-create-nick" onclick="registerUser()">CREATE NICKNAME</button>
            </div>
        
            <div id="view-profile" style="display:none;">
                <div class="ref-label">Player Profile</div>
                
                <div style="position:relative; width:80px; height:80px; margin:0 auto 10px auto;">
                    <img id="my-avatar-img" src="" style="width:100%; height:100%; border-radius:50%; object-fit:cover; border:2px solid var(--primary); box-shadow:0 0 15px var(--primary); background: rgba(0,0,0,0.3);">
                </div>

                <div style="font-size:1.2em; font-weight:bold; color:white; margin-bottom:5px;" id="displayNick">...</div>
                
                <div class="ref-stats-grid">
                    <div class="ref-stat-item">
                        <span class="rs-val" id="totalInvited">0</span>
                        <span class="rs-lbl">Total Invited</span>
                    </div>
                    <div class="ref-stat-item">
                        <span class="rs-val" style="color:var(--gold);" id="pendingBonus">0</span>
                        <span class="rs-lbl">Pending Bonus</span>
                    </div>
                </div>

                <div class="ref-status-box">
                    <div style="font-size:0.7em; color:#888; text-transform:uppercase; margin-bottom:5px;">Bonus Requirement:</div>
                    
                    <div class="ref-requirement">
                        <span>1. Min 6 Referrals</span>
                        <span id="req-1-status"></span>
                    </div>
                    <div class="ref-requirement">
                        <span>2. Active Bettor</span>
                        <span id="req-2-status"></span>
                    </div>
                </div>
                
                <div id="claimBonusBtnContainer" style="margin-top:10px;"></div>
                
                <div class="ref-label" style="margin-top:15px;">Referral Link</div>
                <div class="ref-box">
                    <span id="displayRefLink" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">...</span>
                    <button class="btn-copy" onclick="copyRefLink()">Copy</button>
                </div>

                <div style="margin-top:15px; text-align:left;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="ref-label">INVITED FRIENDS</span>
                        <button onclick="loadReferralList()" style="background:none; border:none; color:var(--accent); font-size:1.2em; cursor:pointer;"></button>
                    </div>
                    <div id="referralListDisplay" class="referral-list-container">
                        <div style="text-align:center; color:#555; font-size:0.7em; padding:10px;">Click refresh to load list.</div>
                    </div>
                </div>

                <div class="comm-info" style="margin-top:15px;">
                    *0.25% Commission from direct referral winnings.<br>
                    *Bonus Credit is for betting only (Non-withdrawable).
                </div>
            </div>
        </div>
        
        <div class="history-section">
            <div class="history-tabs">
                <button class="tab-btn active" onclick="switchTab('global')">Global Results</button>
                <button class="tab-btn" onclick="switchTab('personal')">My Winnings</button>
            </div>
            <div id="tabGlobal">
                <div id="historyList"></div>
                <button id="btnLoadMore" class="btn-load-more" onclick="loadMoreHistory()">Load Previous Rounds (15)</button>
            </div>
            <div id="tabPersonal" class="hidden">
                <div id="personalHistoryList"><div style="text-align:center; color:#555; font-size:0.8em; padding:20px;">Fetching blockchain data...</div></div>
            </div>
        </div>
    </div>
</div>

<div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('paymentModal')">&times;</button>
        <div class="modal-title">BET ON <span id="modalAnimalName">ANIMAL</span></div>
        <div class="pay-options">
            <button class="pay-btn btn-eth" onclick="processPayment('ETH')">
                <span style="display:flex; align-items:center;">
                    <img src="eth.svg" style="width:30px; height:30px; margin-right:8px;"> 
                   Betting Cost ETH:
                </span> 
                <span>0.0005 ETH</span>
            </button>

            <button class="pay-btn btn-usdt" onclick="processPayment('USDT')">
                <span style="display:flex; align-items:center;">
                    <img src="usdt.svg" style="width:33px; height:33px; margin-right:8px;"> 
                   Betting Cost USDT:
                </span> 
                <span>10 USDT</span>
            </button>

            <button class="pay-btn btn-shib" onclick="processPayment('SHIB')">
                <span style="display:flex; align-items:center;">
                    <img src="shib.png" style="width:30px; height:30px; margin-right:8px;"> 
                   Betting Cost SHIBA:
                </span> 
                <span>110,000 SHIBA</span>
            </button>
        </div>
        <div style="border-top:1px dashed #444; padding-top:10px;">
            <div style="font-size:0.8em; color:#aaa;">Free Credit Balance: <span id="userBonusBalance" style="color:white;">0</span> SHIB</div>
            <button id="btnFreeBet" class="wallet-btn" style="width:100%; margin-top:5px; background:#333;" disabled onclick="processPayment('FREE')">Use Free Credit (10k)</button>
        </div>
    </div>
</div>

<div id="walletInfoModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('walletInfoModal')">&times;</button>
        <div class="dash-profile"><div style="font-weight:bold; margin-bottom:5px;">WALLET & WINNINGS</div><div style="font-size:0.7em; color:#aaa; background:#111; padding:5px; border-radius:4px;" id="dashAddress">...</div></div>
        <div style="font-size:0.7em; color:#888; margin-bottom:5px;">WALLET BALANCE</div>
        <div class="dash-balance-grid"><div class="dash-item"><span class="dash-label">ETH</span><span class="dash-val text-eth" id="balETH">0.000</span></div><div class="dash-item"><span class="dash-label">USDT</span><span class="dash-val text-usdt" id="balUSDT">0.00</span></div><div class="dash-item"><span class="dash-label">SHIB</span><span class="dash-val text-shib" id="balSHIB">0.00</span></div></div>
        <div class="withdraw-section">
            <div class="withdraw-title">GAME CREDIT / WINNINGS / REFERRAL COMMISSIONS</div><br>
            <div class="dash-balance-grid">
                <div class="dash-item"><span class="dash-label">ETH Credit</span><span class="dash-val text-eth" id="credETH">0.000</span><button class="btn-withdraw-small" onclick="withdraw('ETH')">W/D</button></div>
                <div class="dash-item"><span class="dash-label">USDT Credit</span><span class="dash-val text-usdt" id="credUSDT">0.00</span><button class="btn-withdraw-small" onclick="withdraw('USDT')">W/D</button></div>
                <div class="dash-item"><span class="dash-label">SHIB Credit</span><span class="dash-val text-shib" id="credSHIB">0.00</span><button class="btn-withdraw-small" onclick="withdraw('SHIB')">W/D</button></div>
            </div>
        </div>
        <button class="btn-disconnect" onclick="disconnectWallet()">DISCONNECT</button>
    </div>
</div>

    <div id="playerProfileModal" class="modal-overlay">
    <div class="modal-content" style="border-color: var(--accent); box-shadow: 0 0 40px rgba(208, 0, 255, 0.2);">
        <button class="close-modal" onclick="closeModal('playerProfileModal')">&times;</button>
        
        <div style="margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
            <div style="font-size:0.7em; color:var(--primary); letter-spacing:2px; margin-bottom:10px; font-weight:bold;">PLAYER CARD</div>
            
            <div class="profile-avatar" style="overflow:hidden; padding:0; border:2px solid #fff; width:70px; height:70px; margin:0 auto 10px auto; border-radius:50%; box-shadow: 0 0 20px rgba(0, 210, 255, 0.5);">
                <img id="pp-avatar-img" src="" style="width:100%; height:100%; object-fit:cover; background:#1f222e;">
            </div>
            
            <div id="pp-nickname">Loading...</div>
            <div id="pp-address">0x...</div>
        </div>

        <div class="dash-balance-grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="profile-stat-box stat-win-box">
                <span class="dash-label" style="color:var(--gold);">TOTAL WINS</span>
                <span class="dash-val" id="pp-wins" style="color:var(--gold); font-size:1.4em;">0</span>
            </div>
            <div class="profile-stat-box">
                <span class="dash-label">TOTAL BETS</span>
                <span class="dash-val" id="pp-bets" style="font-size:1.4em;">0</span>
            </div>
        </div>

        <div class="withdraw-section" style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
            <div class="withdraw-title">RECENT ACTIVITY (Last 5)</div>
            <div id="pp-history-list" style="max-height:150px; overflow-y:auto; font-size:0.75em; text-align:left; color:#aaa; display:flex; flex-direction:column; gap:5px;">
                Fetching data...
            </div>
        </div>
    </div>
    </div>

<div id="toast">Notification</div>

<footer>
    <div id="footer" class="social-icons">
        <a href="https://x.com/FaylottoXyz" target="_blank"><i class="fa-brands fa-twitter"></i></a>
        <a href="https://t.me/FaylottoXyz" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://t.me/Faylotto" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://discord.gg/6uMYTdCZwJ" target="_blank"><i class="fa-brands fa-discord"></i></a>
        <a href="https://facebook.com/Faylotto" target="_blank"><i class="fa-brands fa-facebook"></i></a>
    </div>
    <p>
       Powered By Faylotto.
      <span>
        <a href="https://docs.faylotto.xyz/policy/AllRightsReserved" style="color: #007bff; text-decoration: none;" target="_blank">
          <span id="year"></span> All rights reserved. 
        </a>
      </span>
      Play responsibly.
      <span>
        <a href="privacypolicy" style="color: #007bff; text-decoration: none;" target="_blank">
          Privacy Policy.
        </a>
      </span>
    </p>
</footer>

<script>
    const CONTRACT_ADDRESS = "0x3eFD287287D8BC9D5B3e1B0cb2C1ad3b6F0545d5";
    const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2";
    const SHIB_ADDRESS = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";
    const BASE_SEPOLIA_ID = 84532; const BASE_SEPOLIA_HEX = "0x14a34";
    const BASE_RPC_URL = "https://sepolia.base.org"; 
    const BASE_WSS_URL = "wss://base-sepolia-rpc.publicnode.com";

    const GAME_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_shibToken","type":"address"},{"internalType":"address","name":"_priceFeedETH","type":"address"},{"internalType":"address","name":"_priceFeedUSDT","type":"address"},{"internalType":"address","name":"_priceFeedSHIB","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"indexed":false,"internalType":"string","name":"outcome","type":"string"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"BattleResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BonusClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"oldCollector","type":"address"},{"indexed":false,"internalType":"address","name":"newCollector","type":"address"}],"name":"FeeCollectorUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint8","name":"animalChoice","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NewBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"RatingSubmitted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"reactionType","type":"uint8"}],"name":"ReactionUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"referrer","type":"address"},{"indexed":false,"internalType":"uint256","name":"newCount","type":"uint256"}],"name":"ReferralCountIncreased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"invitee","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralLinked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"UserRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"enum FaylottoUltimate.Currency","name":"curr","type":"uint8"},{"indexed":false,"internalType":"bool","name":"isRealTransfer","type":"bool"}],"name":"WinDistributed","type":"event"},{"inputs":[],"name":"COST_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_MAIN","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_PLATFORM_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TOTAL_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_REFERRALS_REQUIRED","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TEAMS_ACTIVE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BONUS_AMOUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"","type":"uint8"}],"name":"activeTeamCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"}],"name":"betETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"},{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"bool","name":"_isFreeBet","type":"bool"}],"name":"betToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralBonus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"commentCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"dislikeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint256","name":"_cId","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"name":"emergencyWithdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeDraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeShibCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getActiveTeamCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getBonusBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getGlobalWinCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"}],"name":"getLatestPrice","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"}],"name":"getRoundResult","outputs":[{"components":[{"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"internalType":"struct FaylottoUltimate.RoundResultData","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserWinCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"globalWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nicknameToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_referrerNick","type":"string"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"enum FaylottoUltimate.BetType","name":"bType","type":"uint8"},{"internalType":"uint8","name":"animalChoice","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundHistory","outputs":[{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_eth","type":"address"},{"internalType":"address","name":"_usdt","type":"address"},{"internalType":"address","name":"_shib","type":"address"}],"name":"setPriceFeeds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_reaction","type":"uint8"}],"name":"setReaction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"shibToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_stars","type":"uint8"}],"name":"submitRating","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"enum FaylottoUltimate.Currency","name":"","type":"uint8"}],"name":"userCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRatings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userReactions","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"hasBet","type":"bool"},{"internalType":"uint256","name":"pendingRefBonusCount","type":"uint256"},{"internalType":"uint256","name":"totalReferrals","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawCredit","outputs":[],"stateMutability":"nonpayable","type":"function"}];
    
    const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
        
    const IMAGE_NAMES = ['tuna', 'crab', 'shark', 'octopus', 'shrimp', 'orcha'];
    const IMAGE_LIST = ["tuna.svg", "crab.svg", "shark.svg", "octo.svg", "shrimp.svg", "orcha.svg", "zonk.svg"]; 
    const MIN_SPIN_TIME = 35000;
    const IMGBB_API_KEY = "8903b3e0ea80be404bd2e568cd15521f"; // API Key Anda
    const IMG_SEPARATOR = " ||IMG|| "; // Kode rahasia pemisah Text dan Gambar
    let spinStartTime = 0; let spinIntervals = [];
    let isSpinning = false;
    let provider, signer, userAddress;
    let isConnected = false;
    let currentSelectedAnimal = { name: '', index: -1 };
    let detectedReferrer = "";
    let roundPools = { eth: 0, usdt: 0, shib: 0 };
    let historyCursor = 0; let isInitialLoad = true; let currentMaxRound = 0;
    let globalWinnersCache = {}; let globalHistoryLength = -1;
    let isProcessingResult = false;
    let gameContract;      // Kontrak Utama (via RPC/Metamask) -> Untuk Bet & Transaksi
    let listenerContract;
    let selectedFiles = {}; // Simpan file sementara
    let selectedEditFiles = {};
    let editImageDeleteStatus = {};
    let countdownInterval = null;
    let safetyTimer = null; // Timer pengaman anti-macet
    
    // --- TAMBAHKAN VARIABEL INI ---
    let myBetCounts = [0, 0, 0, 0, 0, 0];

    function getAvatar(address) {
        return `https://api.dicebear.com/7.x/bottts/svg?seed=${address}&backgroundColor=transparent`;
    }

    window.onload = async () => {
        document.querySelectorAll('.reel-img').forEach(img => img.src = "what.svg");
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('ref')) detectedReferrer = urlParams.get('ref');
        
        // 1. Setup RPC Provider (Standar untuk baca data)
        provider = new ethers.JsonRpcProvider(BASE_RPC_URL);
        gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, provider);

        // 2. Setup WSS Provider (KHUSUS LISTENER LIVE DRAW)
        try {
            const wssProvider = new ethers.WebSocketProvider(BASE_WSS_URL);
            
            // Logika Auto-Reconnect sederhana jika WSS putus (Penting!)
            wssProvider.websocket.onerror = (e) => console.error("WSS Error:", e);
            wssProvider.websocket.onclose = (e) => console.log("WSS Closed. Refresh to reconnect.");

            // Buat instance kontrak khusus yang tersambung ke "Jalur Cepat" WSS
            listenerContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, wssProvider);
            console.log(" WSS Listener Connected!");

            // Jalankan Listener pakai kontrak WSS
            setupEventListeners(); 

        } catch (e) {
            console.error("Gagal connect WSS, fallback ke RPC...", e);
            // Jika WSS mati/salah, pakai RPC biasa sebagai cadangan
            listenerContract = gameContract; 
            setupEventListeners();
        }

        refreshGameData(); 
    };

    function handleWalletClick() { isConnected ? openWalletDashboard() : connectWallet(); }
    async function connectWallet() {
        if (!window.ethereum) { showToast("Please Install MetaMask First"); return; }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            userAddress = accounts[0]; await switchNetwork();
            signer = await provider.getSigner();
            gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, signer);
            const storedAuth = localStorage.getItem(`auth_${userAddress}`);
            if (storedAuth && JSON.parse(storedAuth).expiry > Date.now()) finalizeLogin();
            else await requestSignature();
        } catch (error) { console.error(error); }
    }
    async function switchNetwork() { try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_SEPOLIA_HEX }] }); } catch {} }
    async function requestSignature() {
        try {
            const msg = `Welcome To Faylotto\nUser: ${userAddress}\nTs: ${Date.now()}`;
            const sig = await signer.signMessage(msg);
            localStorage.setItem(`auth_${userAddress}`, JSON.stringify({ sig, expiry: Date.now() + 86400000 * 30 }));
            finalizeLogin();
        } catch { showToast("Login Cancelled"); }
    }
    async function finalizeLogin() {
        isConnected = true;     
        const btn = document.getElementById("connectBtn");
        btn.innerHTML = `
            <img src="wallet.svg" style="width: 20px; height: 20px;"> 
            <span>Wallet Info</span>
        `;
        btn.classList.add("connected");
        showToast("Connected"); 
        refreshGameData();
    }

    // --- SOCIAL LOGIC ---
    async function submitRating(rid, stars) {
        if(!isConnected) { showToast("Connect Wallet First"); return; }
        try {
            const u = await gameContract.users(userAddress);
            // Contoh untuk submitRating (terapkan logika sama ke submitLike & triggerBetModal)
if(!u[1]) { 
    showToast("Please Register in Referral Panel below!"); 
    // Scroll otomatis ke panel referral
    document.getElementById('referralPanel').scrollIntoView({behavior: "smooth"});
    return; 
}
            const tx = await gameContract.submitRating(rid, stars, {gasLimit: 500000});
            showToast("Rating..."); await tx.wait(); showToast("Rated!"); updateSocialStats(rid);
        } catch(e){ showToast("Failed: " + (e.reason||"Error")); }
    }

    async function submitLike(rid) {
        if(!isConnected) { showToast("Connect First"); return; }
        
        try {
            const u = await gameContract.users(userAddress);
            if(!u[1]) { 
                showToast("Please Register in Referral Panel below!"); 
                document.getElementById('referralPanel').scrollIntoView({behavior: "smooth"});
                return; 
            }

            // Kirim Transaksi ke Blockchain
            const tx = await gameContract.setReaction(rid, 1); 
            showToast("Liking..."); 
            
            // Tunggu Konfirmasi
            await tx.wait(); 
            showToast("Liked!"); 

            // --- PERBAIKAN UTAMA DI SINI ---
            // Langsung update angka di layar (Optimistic Update)
            const el = document.getElementById(`likes-count-${rid}`);
            if(el) {
                let currentVal = parseInt(el.innerText) || 0;
                el.innerText = currentVal + 1; // Paksa tambah 1
                
                // Beri efek visual warna hijau sesaat
                el.style.color = "var(--success)";
            }

            // Update data asli dari blockchain setelah delay 3 detik (biar RPC sempat sync)
            setTimeout(() => { updateSocialStats(rid); }, 3000);

        } catch(e){ 
            console.error(e);
            showToast("Failed: " + (e.reason||"Error")); 
        }
     }
    
    async function updateSocialStats(rid) {
        try {
            const [score, count, likes] = await Promise.all([
                gameContract.totalRatingScore(rid),
                gameContract.totalRatingCount(rid),
                gameContract.likeCounts(rid)
            ]);

            // Update Bintang (Rating)
            const avg = count > 0n ? Math.round(Number(score)/Number(count)) : 0;
            for(let i=1; i<=5; i++) {
                const s = document.getElementById(`star-${rid}-${i}`);
                if(s && !s.classList.contains('hover-gold')) { 
                    if(i <= avg) s.classList.add('active'); else s.classList.remove('active'); 
                }
            }
            
            // Update Text Count Bintang (Total Score)
            const elCount = document.getElementById(`vote-count-${rid}`);
            if(elCount) elCount.innerText = `(${score})`;

            // Update Like Count
            const elLike = document.getElementById(`likes-count-${rid}`);
            if(elLike) {
                elLike.innerText = likes; // Isi dengan data real dari blockchain
                elLike.style.color = ""; // Reset warna
            }

        } catch(e){}
    }

    function switchTab(tab) {
        if (tab === 'global') {
            document.getElementById('tabGlobal').classList.remove('hidden'); document.getElementById('tabPersonal').classList.add('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active'); document.querySelectorAll('.tab-btn')[1].classList.remove('active');
        } else {
            document.getElementById('tabGlobal').classList.add('hidden'); document.getElementById('tabPersonal').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active'); document.querySelectorAll('.tab-btn')[1].classList.add('active');
            updatePersonalHistory();
        }
    }

    function formatOutcomeText(raw, reels) {
        const r0=Number(reels[0]), r1=Number(reels[1]), r2=Number(reels[2]);
        const gN = (i) => i===6 ? "Zonk" : (IMAGE_NAMES[i] ? IMAGE_NAMES[i].charAt(0).toUpperCase()+IMAGE_NAMES[i].slice(1) : "?");
        if(raw==="TRIPLE") return `<span style="color:var(--gold); font-weight:bold;">${gN(r0)} (TRIPLE)</span>`;
        if(raw==="DOUBLE") {
            let d = r0===r1?gN(r0): (r1===r2?gN(r1):gN(r0)); let s = r0===r1?gN(r2): (r1===r2?gN(r0):gN(r1));
            return `<span style="color:var(--accent);">${d} (Double)</span> - ${s}`;
        }
        if(raw==="ONE_ZONK") return `${gN(r0)} - <span style="color:var(--danger)">Zonk</span> - ${gN(r2)}`;
        return `${gN(r0)} - ${gN(r1)} - ${gN(r2)}`;
    }

    async function fetchBatchHistory(count) {
        const historyList = document.getElementById('historyList');
        if (historyCursor < 1) { document.getElementById('btnLoadMore').style.display = 'none'; return; }
        const start = historyCursor, end = Math.max(1, historyCursor - count + 1);
        const roundPromises = [];
        for (let r = start; r >= end; r--) {
            if (document.getElementById(`history-card-${r}`)) continue;
            roundPromises.push(gameContract.getRoundResult(r).then(res => ({ r, res })).catch(e => null));
        }
        if (roundPromises.length === 0) { historyCursor = end - 1; return; }
        
        try {
            const results = (await Promise.all(roundPromises)).filter(x => x !== null);
            for (let item of results) {
                const { r, res } = item;
                const card = document.createElement('div'); card.className = 'history-card'; card.id = `history-card-${r}`;
                
                let commentCount = 0;
                try { commentCount = await gameContract.commentCounts(r); } catch(e){}

                card.innerHTML = `                    
                    <div style="font-size:0.8em; color:#aaa; margin-bottom:5px;">Round #${r}  ${new Date(Number(res.timestamp) * 1000).toLocaleTimeString()}</div>
                    <div class="history-reels"><img class="history-reel-img" src="${IMAGE_LIST[Number(res.reels[0])]}"><img class="history-reel-img" src="${IMAGE_LIST[Number(res.reels[1])]}"><img class="history-reel-img" src="${IMAGE_LIST[Number(res.reels[2])]}"></div>
                    <div class="history-outcome" style="margin-top:5px;">${formatOutcomeText(res.outcome, res.reels)}</div>
                    <div id="winner-info-${r}" style="margin-top:8px; border-top:1px dashed #444; padding-top:5px; min-height:20px;"><span style="font-size:0.7em; color:#555;">Loading...</span></div>
                    
                    <div class="social-bar">
                        
                        <button class="btn-like-single" onclick="submitLike(${r})">
                            <img src="like.png" style="width: 20px; height: 20px;"> 
                            <span id="likes-count-${r}">0</span>
                        </button>

                        <div class="star-group" onmouseleave="resetStarHover(${r})">
                            <span id="star-${r}-1" class="star-btn" onmouseenter="previewStarRating(${r}, 1)" onclick="submitRating(${r},1)"></span>
                            <span id="star-${r}-2" class="star-btn" onmouseenter="previewStarRating(${r}, 2)" onclick="submitRating(${r},2)"></span>
                            <span id="star-${r}-3" class="star-btn" onmouseenter="previewStarRating(${r}, 3)" onclick="submitRating(${r},3)"></span>
                            <span id="star-${r}-4" class="star-btn" onmouseenter="previewStarRating(${r}, 4)" onclick="submitRating(${r},4)"></span>
                            <span id="star-${r}-5" class="star-btn" onmouseenter="previewStarRating(${r}, 5)" onclick="submitRating(${r},5)"></span>
                            <span id="vote-count-${r}" class="star-count">(0)</span>
                        </div>

                        <button class="btn-comment-toggle" onclick="toggleComments(${r})">
                            <img src="comment.png" style="width: 20px; height: 20px;"> 
                            <span id="comment-count-badge-${r}">${commentCount}</span>
                        </button>

                    </div>
                    </div>

                    <div id="comments-section-${r}" class="comments-container">
                        <div id="comments-list-${r}" class="comment-list">
                            <div style="text-align:center; color:#555; font-size:0.8em;">Loading comments...</div>
                        </div>

                        <div id="preview-box-${r}" style="display:none; padding:10px; background:#111; margin-top:5px; border-radius:8px; position:relative;">
                            <img id="img-preview-${r}" src="" style="height:80px; border-radius:6px; border:1px solid var(--primary);">
                            <button onclick="clearImage(${r})" style="position:absolute; top:5px; left:85px; background:var(--danger); color:white; border:none; width:20px; height:20px; border-radius:50%; cursor:pointer;">&times;</button>
                        </div>

                        <div class="comment-input-area" style="flex-direction: column; align-items: stretch; gap: 8px;">
                            
                            <textarea id="input-comment-${r}" class="input-comment" placeholder="Write comment..." style="width: 100%; min-height: 60px;"></textarea>

                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                
                                <div>
                                    <input type="file" id="file-upload-${r}" 
                                           accept="image/png, image/jpeg, image/gif, image/webp" 
                                           style="display:none;" 
                                           onchange="handleFileSelect(event, ${r})">
                                           
                                    <button class="btn-icon-upload" onclick="document.getElementById('file-upload-${r}').click()" title="Attach Image" 
                                            style="background: transparent; border: 1px solid #444; border-radius: 8px; padding: 5px 10px; width: auto; height: auto; display: flex; align-items: center; gap: 6px;">
                                        <img src="image.png" style="width:20px; height:20px;">
                                        <span style="font-size: 0.8em; color: #888;">Upload Picture...</span>
                                    </button>
                                </div>

                                <button class="btn-post-comment" onclick="postComment(${r})">
                                    <img src="send.svg" style="width:18px; height:18px; object-fit:contain;">
                                </button>
                            </div>

                        </div>
                `;
                historyList.appendChild(card);
                updateSocialStats(r);
            }
            await fetchWinnersFromContract(start, end);
        } catch (err) { console.error("History Error:", err); }
        historyCursor = end - 1; if (historyCursor < 1) document.getElementById('btnLoadMore').style.display = 'none';
    }

    // --- LOGIC HOVER BINTANG ---

    // 1. Saat mouse masuk ke salah satu bintang (Preview Mode)
    function previewStarRating(rid, val) {
        for(let i=1; i<=5; i++) {
            const s = document.getElementById(`star-${rid}-${i}`);
            if(!s) continue;
            
            // Hapus class lama dulu biar bersih
            s.classList.remove('hover-gold', 'dimmed');
            
            if (i <= val) {
                // Bintang 1 sampai yang ditunjuk -> Nyala Emas
                s.classList.add('hover-gold');
            } else {
                // Bintang sisanya -> Mati (Dimmed)
                // Ini penting agar rating asli tertutup sementara
                s.classList.add('dimmed');
            }
        }
    }

    // 2. Saat mouse keluar dari area bintang (Reset ke status asli)
    function resetStarHover(rid) {
        for(let i=1; i<=5; i++) {
            const s = document.getElementById(`star-${rid}-${i}`);
            if(s) {
                // Hapus efek hover
                s.classList.remove('hover-gold', 'dimmed');
                // Otomatis class 'active' yang asli (dari updateSocialStats) akan terlihat kembali
            }
        }
    }

    async function fetchWinnersFromContract(maxRound, minRound) {
        try {
            const totalWinsBig = await gameContract.getGlobalWinCount();
            const totalWins = Number(totalWinsBig);

            if (totalWins === 0) return;

            // 1. KUMPULKAN & GABUNGKAN DATA DULU (Aggregating)
            // Struktur: MatchesFound[RoundID][PlayerAddress] = { eth: 0, usdt: 0, shib: 0, currenciesWon: [] }
            let matchesFound = {}; 
            
            let startIndex = totalWins - 1;
            let limitScan = Math.max(0, totalWins - 100); 

            for (let i = startIndex; i >= limitScan; i--) {
                const winData = await gameContract.globalWinHistory(i);
                const rId = Number(winData.roundId);
                
                if (rId < minRound) break; 

                if (rId <= maxRound && rId >= minRound) {
                    const player = winData.player;
                    const amount = winData.winAmount;
                    const currIdx = Number(winData.currency); 

                    // Siapkan objek per ronde
                    if (!matchesFound[rId]) matchesFound[rId] = {};
                    
                    // Siapkan objek per player di ronde itu
                    if (!matchesFound[rId][player]) {
                        matchesFound[rId][player] = { 
                            eth: 0n, usdt: 0n, shib: 0n, 
                            winCount: 0 // Hitung berapa kali dia menang (untuk diulang)
                        };
                    }

                    // Tambah saldo
                    if (currIdx === 0) matchesFound[rId][player].eth += amount;
                    else if (currIdx === 1) matchesFound[rId][player].usdt += amount;
                    else matchesFound[rId][player].shib += amount;

                    // Tambah counter kemenangan
                    matchesFound[rId][player].winCount++;
                }
            }

            // 2. RENDER UI (Looping Multi-Baris)
            for (let r = maxRound; r >= minRound; r--) {
                const roundWinners = matchesFound[r]; // Objek berisi { PlayerA: Data, PlayerB: Data }
                const div = document.getElementById(`winner-info-${r}`);
                
                if (div && roundWinners) {
                    div.innerHTML = ""; // Bersihkan

                    // Loop setiap player yang menang di ronde ini
                    for (const [playerAddr, data] of Object.entries(roundWinners)) {
                        
                        // --- BUAT STRING TOTAL HADIAH (LENGKAP 3 KOIN) ---
                        let payStr = "";
                        if (data.eth > 0n) payStr += `<div style="color:var(--eth-color);">+${parseFloat(ethers.formatEther(data.eth)).toFixed(4)} ETH</div>`;
                        if (data.usdt > 0n) payStr += `<div style="color:var(--usdt-color);">+${parseFloat(ethers.formatUnits(data.usdt, 18)).toFixed(2)} USDT</div>`;
                        if (data.shib > 0n) payStr += `<div style="color:var(--shib-color);">+${parseFloat(ethers.formatUnits(data.shib, 18)).toLocaleString()} SHIB</div>`;

                        // --- LOOPING TAMPILAN (REPEATER) ---
                        // Jika dia menang 3 jenis koin, kita tampilkan barisnya 3 kali
                        // Tapi isinya tetap "Total Lengkap"
                        
                        for(let k=0; k < data.winCount; k++) {
                             const nickId = `nick-${r}-${playerAddr}-${k}`; // ID Unik

                             const rowHtml = `
                                <div class="winner-info-box" style="display:block; border-top:1px solid rgba(255,255,255,0.1); margin-top:5px; padding-top:5px;">
                                    <div style="display:flex; justify-content:space-between; align-items:start;">
                                        <div style="text-align:left;">
                                            <div style="font-size:0.65em; color:#888;">WINNER</div>
                                            <div style="color:var(--gold); font-weight:bold; font-size:0.85em; display:flex; align-items:center;" id="${nickId}">
                                                <img src="cup.png" style="width:14px; height:14px; margin-right:4px; object-fit:contain;">
                                                Loading...
                                            </div>
                                        </div>
                                        <div style="text-align:right; font-size:0.75em; font-weight:bold;">
                                            ${payStr} </div>
                                    </div>
                                </div>
                            `;
                            div.insertAdjacentHTML('beforeend', rowHtml);

                            // Fetch Nickname
                            gameContract.users(playerAddr).then(u => {
                                const el = document.getElementById(nickId);
                                if(el) {
                                    const name = u[0] ? u[0] : (playerAddr.substring(0,6) + "...");
                                    el.innerHTML = `<img src="cup.png" style="width:14px; height:14px; margin-right:4px; object-fit:contain;"> ${name}`;
                                }
                            }).catch(()=>{});
                        }
                    }

                } else if (div) {
                     div.innerHTML = '<span style="font-size:0.7em; color:#555;">No Winners</span>';
                }
            }

        } catch (e) { 
            console.error("Fetch Winners Error:", e); 
        }
    }
    
    async function loadMoreHistory() { const btn=document.getElementById('btnLoadMore'); btn.innerText="Loading..."; btn.disabled=true; await fetchBatchHistory(15); btn.innerText="Load More"; btn.disabled=false; }

    // --- FUNGSI PERSONAL HISTORY (PERBAIKAN: SEQUENTIAL FETCH) ---
    async function updatePersonalHistory() {
        const list = document.getElementById('personalHistoryList');
        
        if (!isConnected || !userAddress) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Connect Wallet to view history</div>';
            return;
        }

        list.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">Loading data...</div>';
        
        try {
            const myWins = [];
            let index = 0;
            let keepFetching = true;

            // Loop satu per satu (Lebih lambat sedikit tapi 100% Aman dari Error RPC)
            while (keepFetching) {
                try {
                    // Panggil data per index
                    const log = await gameContract.userWinHistory(userAddress, index);
                    
                    // Jika berhasil (data ada), simpan
                    // Konversi data struct ke object biasa agar mudah dibaca
                    myWins.push({
                        amount: log[1],
                        curr: Number(log[2]),
                        roundId: Number(log[3]),
                        timestamp: Number(log[4]),
                        outcome: log[5]
                    });
                    
                    index++;
                    
                    // Batas safety agar browser tidak hang jika data terlalu banyak
                    if (index > 50) keepFetching = false; 

                } catch (e) {
                    // Jika error di sini, artinya data sudah habis (End of Array)
                    // Stop loop dengan aman
                    keepFetching = false;
                }
            }

            // Cek hasil
            if (myWins.length === 0) {
                list.innerHTML = `
                    <div style="text-align:center; padding:20px; color:#666;">
                        No winning history yet.<br>
                        <small>(Good luck!)</small>
                    </div>`;
                return;
            }

            // Render Data (Balik urutan agar terbaru di atas)
            const reversedWins = myWins.reverse();
            list.innerHTML = ''; 

            for (let win of reversedWins) {
                let symbol = win.curr === 0 ? "ETH" : (win.curr === 1 ? "USDT" : "SHIB");
                let decimal = win.curr === 1 ? 18 : 18;
                let val = parseFloat(ethers.formatUnits(win.amount, decimal));
                
                // Format angka
                let valStr = win.curr === 2 
                    ? val.toLocaleString() 
                    : (val < 0.001 ? val.toFixed(6) : val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4}));
                
                let colorHex = win.curr === 0 ? "#627EEA" : (win.curr === 1 ? "#26A17B" : "#FFA409");

                const el = document.createElement('div');
                el.className = 'personal-bet-card';
                el.style.borderLeftColor = 'var(--gold)'; // Gold strip
                el.style.background = 'rgba(255, 215, 0, 0.05)'; // Gold tint

                el.innerHTML = `
                    <div class="pb-info">
                        <div class="pb-time">Round #${win.roundId}  ${new Date(win.timestamp * 1000).toLocaleString()}</div>
                        <div style="font-weight:bold; color:var(--text);">Result: <span style="color:var(--accent);">${win.outcome}</span></div>
                    </div>
                    <div style="text-align:right;">
                        <span class="badge badge-win" style="border-color:var(--gold); color:var(--gold); display: inline-flex; align-items: center; gap: 5px;">
                        <img src="cup.png" style="width: 20px; height: 20px;">VICTORY</span>
                        <div style="margin-top:5px; font-weight:bold; color:${colorHex}; font-size:1.1em;">
                            + ${valStr} <span style="font-size:0.7em;">${symbol}</span>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            }

        } catch (e) {
            console.error("History Logic Error:", e);
            // Error ini hanya muncul jika koneksi internet putus total
            list.innerHTML = `<div style="text-align:center; color:var(--danger); padding:10px;">Network Error. Try refreshing.</div>`;
        }
    }

    // --- FUNGSI LOAD DAFTAR TEMAN (OPTIMAL) ---
    async function loadReferralList() {
        const listDiv = document.getElementById('referralListDisplay');
        listDiv.innerHTML = '<div style="text-align:center; color:#aaa; padding:10px;">Scanning Blockchain...</div>';

        try {
            // 1. AMBIL DATA EVENT (ReferralLinked)
            const filter = gameContract.filters.ReferralLinked(null, userAddress);
            
            // GANTI STRATEGI:
            // Coba ambil dari blok awal kontrak. Jika error, ambil 10000 blok terakhir saja.
            let logs = [];
            try {
                // Blok estimasi kontrak deploy (Ganti dengan blok asli jika tahu)
                // Base Sepolia saat ini sekitar blok 19 Juta.
                // Kita scan dari blok 17 Juta (Aman).
                const SAFE_BLOCK = 17000000; 
                logs = await gameContract.queryFilter(filter, SAFE_BLOCK, "latest");
            } catch (errRPC) {
                console.warn("Full scan failed, trying recent blocks...", errRPC);
                // Fallback: Scan 50.000 blok terakhir saja jika full scan gagal
                const currentBlock = await provider.getBlockNumber();
                logs = await gameContract.queryFilter(filter, currentBlock - 50000, "latest");
            }

            if (logs.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; color:#666; padding:10px;">No referrals found in recent blocks.</div>';
                return;
            }

            listDiv.innerHTML = ''; // Bersihkan loading

            // 2. LOOP DATA (Terbaru di atas)
            // Kita batasi 10 orang terakhir agar tidak berat saat cek HasBet satu-satu
            const recentLogs = logs.reverse().slice(0, 10);

            for (let log of recentLogs) {
                // Decode address teman (Invitee) dari Topic 1
                const inviteeAddr = ethers.dataSlice(log.topics[1], 12);
                const shortAddr = inviteeAddr.substring(0,6) + "..." + inviteeAddr.substring(38);
                const rowId = `ref-row-${log.blockNumber}`;

                // Render Baris HTML (Status awal: Checking...)
                const row = document.createElement('div');
                row.className = 'ref-item-row';
                row.innerHTML = `
                    <div style="display:flex; align-items:center; gap:8px;">
                        <img src="${getAvatar(inviteeAddr)}" style="width:24px; height:24px; border-radius:50%; border:1px solid #444;">
                        <span style="color:var(--primary); font-family:monospace; font-size:0.8em; word-break:break-all;">
                            ${inviteeAddr}
                        </span>
                    </div>
                    
                    <div id="status-${rowId}" style="font-size:0.7em; font-weight:bold; color:#888;">
                        Checking...
                    </div>
                `;
                listDiv.appendChild(row);

                // 3. CEK STATUS BET (ASYNC BACKGROUND)
                // Panggil data struct user: userData[3] adalah hasBet (boolean)
                gameContract.users(inviteeAddr).then(u => {
                    const hasBet = u[3]; // Index 3 = bool hasBet
                    const statusEl = document.getElementById(`status-${rowId}`);
                    
                    if (statusEl) {
                        if (hasBet) {
                            statusEl.innerHTML = `<span style="color:var(--success);">ACTIVE </span>`;
                        } else {
                            statusEl.innerHTML = `<span style="color:var(--danger);">INACTIVE </span>`;
                        }
                    }
                }).catch(() => {
                    const statusEl = document.getElementById(`status-${rowId}`);
                    if(statusEl) statusEl.innerHTML = `?`;
                });
            }

        } catch (e) {
            console.error(e);
            listDiv.innerHTML = '<div style="text-align:center; color:var(--danger); padding:10px;">Network Busy. Try again later.</div>';
        }
    }
    
    async function refreshGameData() {

        try {

            // 1. UPDATE DATA USER (LOGIKA V2)

            if (isConnected) {

                document.getElementById('referralPanel').style.display = 'block'; 



                // Ambil data Struct (Array)

                const userData = await gameContract.users(userAddress);

                

                // [0]: Nick, [1]: Reg, [2]: Ref, [3]: Bet, [4]: BonusCount, [5]: TotalRef

                const isReg = userData[1]; 



                if (isReg) {

                    document.getElementById('view-profile').style.display = 'block';

                    document.getElementById('view-register').style.display = 'none';



                    // --- ISI DATA ---

                    document.getElementById('displayNick').innerText = userData[0];

                    document.getElementById('displayRefLink').innerText = window.location.origin + window.location.pathname + "?ref=" + userData[0];

                    document.getElementById('my-avatar-img').src = getAvatar(userAddress);

                    

                    // V2: AMBIL TOTAL INVITED LANGSUNG (Index 5)

                    const totalRef = Number(userData[5]);

                    document.getElementById('totalInvited').innerText = totalRef; 

                    const myHasBet = userData[3];

                    // V2: PENDING BONUS (Index 4)

                    const pendingCount = Number(userData[4]);

                    const bonusAmount = pendingCount * 10000; // 10k SHIB per active user

                    document.getElementById('pendingBonus').innerText = bonusAmount;



                    // --- LOGIKA SYARAT CLAIM (V2) ---

                    const req1 = document.getElementById('req-1-status');

                    const req2 = document.getElementById('req-2-status');

                    const claimDiv = document.getElementById('claimBonusBtnContainer');



                    // Cek Syarat 1: Minimal 6 Orang

                    const isReq1Pass = totalRef >= 6;

                    req1.innerHTML = isReq1Pass ? "" : `<span style='color:var(--danger)'>${totalRef}/6</span>`;



                    // Cek Syarat 2: Ada Saldo Pending (Artinya ada yg Bet)

                    const isReq2Pass = pendingCount > 0;

                    req2.innerHTML = isReq2Pass ? "" : "";



                    // Tombol Claim

                    if (isReq1Pass && isReq2Pass) {

                        claimDiv.innerHTML = `<button class="wallet-btn" style="width:50%; background:var(--gold); color:black;" onclick="claimReferralBonus()">CLAIM ${bonusAmount} SHIB CREDIT</button>`;

                    } else {

                        if (!isReq1Pass) {

                            claimDiv.innerHTML = `<button class="wallet-btn" style="width:50%; background:#333; color:#666; cursor:not-allowed;">(Need 6 Invites)</button>`;

                        } else {

                            claimDiv.innerHTML = `<button class="wallet-btn" style="width:50%; background:#333; color:#666; cursor:not-allowed;">WAITING FOR BETS</button>`;

                        }

                    }



                } else {

                    document.getElementById('view-profile').style.display = 'none';

                    document.getElementById('view-register').style.display = 'block';

                    if(detectedReferrer) document.getElementById('panelRefInfo').innerText = "Invited by: " + detectedReferrer;

                }

                

                // Update Saldo
                try {



                    // Saldo Bonus (Free Bet)



                    const bonus = await gameContract.freeShibCredits(userAddress);



                    const btnFree = document.getElementById('btnFreeBet');



                    if (btnFree) {



                        const userBonusEl = document.getElementById('userBonusBalance');



                        if(userBonusEl) userBonusEl.innerText = Number(ethers.formatEther(bonus)).toLocaleString();



                        



                        btnFree.disabled = bonus < ethers.parseEther("10000");



                        btnFree.style.background = (bonus >= ethers.parseEther("10000")) ? "var(--success)" : "#333";



                    }



                    



                    // Update Hero Stats (Earnings & Global Wins)



                    const heroStats = document.getElementById('hero-stats-container');



                    if(heroStats) heroStats.style.display = 'block';



                    



                    try {



                        const totalWonRaw = await gameContract.getUserTotalWinnings(userAddress);



                        const totalWonFmt = parseFloat(ethers.formatEther(totalWonRaw)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4});



                        document.getElementById('heroTotalWon').innerText = totalWonFmt;







                        const globalCountRaw = await gameContract.getGlobalWinCount();



                        document.getElementById('heroGlobalCount').innerText = globalCountRaw;



                    } catch (e) { }







                } catch(e){}



            }







            // 2. FETCH DATA RONDE (BETTING)



            const currR = Number(await gameContract.currentRoundId());



            let bets = [];



            let idx = 0;



            while (true) {



                try {



                    const bet = await gameContract.roundBets(currR, idx);



                    bets.push(bet);



                    idx++;



                } catch { break; }



            }







            // 3. RESET VARIABEL



            let counts = [0, 0, 0, 0, 0, 0]; 



            let pools = { eth: 0, usdt: 0, shib: 0 }; 



            myBetCounts = [0, 0, 0, 0, 0, 0]; 



            let animalCurrCounts = Array(6).fill(null).map(() => ({ eth: 0, usdt: 0, shib: 0 }));







            // 4. LOOP ANALISA BET



            bets.forEach(b => {



                let curr = Number(b[2]); // 0=ETH, 1=USDT, 2=SHIB



                let animalIdx = Number(b[4]);



                



                // --- PERBAIKAN PENTING: FORMAT DESIMAL USDT ---



                let decimal = (curr === 1) ? 18 : 18; // Jika USDT (1) pakai 6, lainnya 18



                let amt = parseFloat(ethers.formatUnits(b[1], decimal));







                // Global Pool



                if (curr === 0) pools.eth += amt;



                else if (curr === 1) pools.usdt += amt;



                else pools.shib += amt;







                // Total Count



                counts[animalIdx]++;







                // My Bet Count



                if (isConnected && b[0].toLowerCase() === userAddress.toLowerCase()) {



                    myBetCounts[animalIdx]++;



                }







                // E/U/S Count



                if (curr === 0) animalCurrCounts[animalIdx].eth++;



                else if (curr === 1) animalCurrCounts[animalIdx].usdt++;



                else animalCurrCounts[animalIdx].shib++;



            });







            // 5. RENDER TAMPILAN



            roundPools = pools;



            updatePoolDisplay();







            for (let i = 0; i < 6; i++) {



                document.getElementById(`count-${i}`).innerText = counts[i];



                



                let c = document.getElementById(`card-${i}`);



                c.classList.remove('my-bet', 'open');



                if (myBetCounts[i] > 0) c.classList.add('my-bet'); 



                else c.classList.add('open');







                // Update E/U/S



                document.getElementById(`c-eth-${i}`).innerText = animalCurrCounts[i].eth;



                document.getElementById(`c-usdt-${i}`).innerText = animalCurrCounts[i].usdt;



                document.getElementById(`c-shib-${i}`).innerText = animalCurrCounts[i].shib;



            }







            // 6. Update Status Tombol Draw



            let active = counts.filter(c => c > 0).length;



            const btnDraw = document.getElementById('drawBtn');



            const drawStatus = document.getElementById('drawStatus');







            if (active >= 5) {



                btnDraw.disabled = false;



                btnDraw.classList.add('ready');



                drawStatus.innerText = "READY TO DRAW!";



                drawStatus.style.color = "var(--success)";



            } else {



                btnDraw.disabled = true;



                btnDraw.classList.remove('ready');



                drawStatus.innerText = `Need ${5 - active} more Players active`;



                drawStatus.style.color = "var(--danger)";



            }







            // 7. Update History & Profile



            updateHistorySection(currR);



            



            if (document.getElementById('tabPersonal') && !document.getElementById('tabPersonal').classList.contains('hidden')) {



                updatePersonalHistory();



            }







        } catch (e) {



            console.error("Refresh Error:", e);



        }



    }
        
    function updateHistorySection(roundId) {
        historyCursor = roundId - 1; 
        if (isInitialLoad) {
            document.getElementById('historyList').innerHTML = '';
            fetchBatchHistory(10);
            isInitialLoad = false;
        } else {
            const first = document.getElementById('historyList').firstElementChild;
            if(first) {
                 document.getElementById('historyList').innerHTML = '';
                 fetchBatchHistory(10);
            }
        }
    }

    function updatePoolDisplay() {
        document.getElementById('poolTotalETH').innerText = roundPools.eth.toFixed(4);
        document.getElementById('poolTotalUSDT').innerText = roundPools.usdt.toFixed(2);
        document.getElementById('poolTotalSHIB').innerText = roundPools.shib.toLocaleString();
    }

    function selectAnimal(name, index) {
        currentSelectedAnimal = { name, index };
        for (let i = 0; i < 6; i++) document.getElementById(`card-${i}`).classList.remove('selected');
        document.getElementById(`card-${index}`).classList.add('selected');
    }

    async function processPayment(currencyType) {
        if (currentSelectedAnimal.index === -1) return;
        const idx = currentSelectedAnimal.index;
        closeModal('paymentModal');
        showToast(`Processing Place Bet ${currencyType}...`);
        try {
            let tx;
            if (currencyType === 'ETH') {
                const val = ethers.parseEther("0.0005");
                tx = await gameContract.betETH(idx, { value: val });
            } else if (currencyType === 'USDT') {
                const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
                const amount = ethers.parseUnits("10", 18);
                await checkApprove(usdt, amount);
                tx = await gameContract.betToken(idx, 1, false);
            } else if (currencyType === 'SHIB') {
                const shib = new ethers.Contract(SHIB_ADDRESS, ERC20_ABI, signer);
                const amount = ethers.parseUnits("110000", 18);
                await checkApprove(shib, amount);
                tx = await gameContract.betToken(idx, 2, false);
            } else if (currencyType === 'FREE') {
                tx = await gameContract.betToken(idx, 2, true);
            }
            showToast("Sending Transaction...");
            await tx.wait();
            showToast("Bet Placed Successfully!");
            refreshGameData();
        } catch (err) { console.error(err); showToast("Failed: " + (err.reason || err.message.slice(0,20))); }
    }

    async function checkApprove(tokenContract, amountNeeded) {
        const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESS);
        if (allowance < amountNeeded) {
            showToast("Approving Token...");
            const tx = await tokenContract.approve(CONTRACT_ADDRESS, ethers.MaxUint256);
            await tx.wait();
            showToast("Approved!");
        }
    }

    function startSpinAnimation() {
        if(isSpinning) return; // Cegah double start
        isSpinning = true;
        
        spinIntervals.forEach(clearInterval);
        spinIntervals = [];
        const reels = [document.getElementById('imgReel1'), document.getElementById('imgReel2'), document.getElementById('imgReel3')];
        reels.forEach((reel, index) => {
            let speed = 80 + (index * 10); 
            const interval = setInterval(() => {
                const randIdx = Math.floor(Math.random() * IMAGE_LIST.length);
                reel.src = IMAGE_LIST[randIdx];
            }, speed);
            spinIntervals.push(interval);
        });
    }

    function stopSpinAnimation(i1, i2, i3) {
        // Matikan interval putaran acak
        spinIntervals.forEach(clearInterval);
        spinIntervals = [];
        isSpinning = false; // <--- RESET FLAG DI SINI

        // ... (sisanya sama: set gambar final, efek blur, dll) ...
        const r1 = document.getElementById('imgReel1');
        const r2 = document.getElementById('imgReel2');
        const r3 = document.getElementById('imgReel3');

        // REEL 1
        r1.style.filter = "blur(2px)";
        setTimeout(() => { r1.src = IMAGE_LIST[i1]; r1.style.filter = "none"; }, 100);

        // REEL 2
        r2.style.filter = "blur(4px)";
        let t2 = setInterval(() => { r2.src = IMAGE_LIST[Math.floor(Math.random() * IMAGE_LIST.length)]; }, 80);
        setTimeout(() => { clearInterval(t2); r2.src = IMAGE_LIST[i2]; r2.style.filter = "none"; }, 600);

        // REEL 3
        r3.style.filter = "blur(5px)";
        let t3 = setInterval(() => { r3.src = IMAGE_LIST[Math.floor(Math.random() * IMAGE_LIST.length)]; }, 80);
        setTimeout(() => { 
            clearInterval(t3); 
            r3.src = IMAGE_LIST[i3]; 
            r3.style.filter = "none"; 
            r3.style.transform = "scale(1.2)";
            setTimeout(() => { r3.style.transform = "scale(1)"; }, 200);
        }, 1400);
    }

    // --- FUNGSI RESET GAMBAR KE DEFAULT ---
    function resetReelsToDefault() {
        const reels = [
            document.getElementById('imgReel1'), 
            document.getElementById('imgReel2'), 
            document.getElementById('imgReel3')
        ];

        reels.forEach((img, index) => {
            // Beri efek blur sedikit sebelum ganti
            img.style.transition = "0.5s"; 
            img.style.filter = "blur(5px)"; 
            img.style.opacity = "0.5";      
            
            setTimeout(() => {
                img.src = "what.svg";       // GANTI KE TANDA TANYA
                img.style.filter = "none";
                img.style.opacity = "1";
                img.style.transform = "scale(1)";
            }, 300);
        });
    }

    // --- FUNGSI PENGAMAN CERDAS ---
    async function smartEmergencyStop() {
        if (!isSpinning) return; // Jika sudah berhenti duluan, abaikan

        console.warn(" Event Missed. Fetching result manually...");
        showToast("Syncing result from blockchain...");

        try {
            // 1. TARIK DATA PAKSA DARI KONTRAK
            // Kita ambil data ronde terakhir (Current Round - 1)
            const currId = await gameContract.currentRoundId();
            const lastRoundId = currId - 1n; 
            
            const result = await gameContract.getRoundResult(lastRoundId);
            
            // Konversi Data
            const r1 = Number(result[0][0]);
            const r2 = Number(result[0][1]);
            const r3 = Number(result[0][2]);
            const outcomeStr = result[1];

            // 2. STOP ANIMASI SESUAI HASIL ASLI
            // Ini membuat gambar berhenti di hewan yang benar (bukan reset)
            stopSpinAnimation(r1, r2, r3); 
            
            showToast(`Result: ${outcomeStr}`);

            // 3. NYALAKAN EFEK GLOWING (WINNER)
            // Ini menjawab request Anda: Efek tetap jalan!
            const winnersIndices = new Set([r1, r2, r3]);
            for (let i = 0; i < 6; i++) {
                const card = document.getElementById(`card-${i}`);
                if (winnersIndices.has(i)) card.classList.add('winner-glamour');
                else card.classList.remove('winner-glamour');
            }
            
            // Matikan efek glow setelah 8 detik
            setTimeout(() => { 
                for (let i = 0; i < 6; i++) 
                    document.getElementById(`card-${i}`).classList.remove('winner-glamour'); 
            }, 8000);

            // 4. RESET KE TANDA TANYA (3 Detik kemudian)
            setTimeout(() => {
                resetReelsToDefault();
            }, 3000);

        } catch (e) {
            console.error("Manual Fetch Failed:", e);
            // Jika internet mati total dan gagal tarik data, baru kita reset paksa (opsi terakhir)
            forceStopAnimation(); 
            showToast("Connection Error. Please Refresh.");
        }

        // 5. BERSIHKAN TIMER & STATE
        if (typeof countdownInterval !== 'undefined') clearInterval(countdownInterval);
        const timerEl = document.getElementById('drawTimer');
        if(timerEl) timerEl.style.display = 'none';
        
        isSpinning = false;
        spinStartTime = 0;
        
        // Refresh Saldo
        setTimeout(() => { refreshGameData(); }, 3000);
    }

    function forceStopAnimation() {
        spinIntervals.forEach(clearInterval); spinIntervals = [];
        document.querySelectorAll('.reel-img').forEach(img => { img.style.filter = "none"; img.style.transform = "scale(1)"; img.src = "what.svg"; });
    }

    async function executeDraw() {
        try {
            showToast("Initiating Draw...");
            
            // 1. Kirim Transaksi
            const tx = await gameContract.executeDraw();
            
            // 2. Mulai Visual
            spinStartTime = Date.now(); 
            startSpinAnimation();
            startCountdown(35000); 
            
            showToast("Broadcasting... (Wait 35s)");

            if (safetyTimer) clearTimeout(safetyTimer);
            
            // 2. Set Timer Darurat (Misal 45 Detik)
            // Jika lewat 45 detik belum ada kabar, panggil Smart Stop
            safetyTimer = setTimeout(() => {
                smartEmergencyStop(); 
            }, 40000);
            
            await tx.wait(); 
            
        } catch (err) { 
            console.error(err); 
            
            // Matikan semua jika error (Reject wallet dll)
            if (safetyTimer) clearTimeout(safetyTimer);
            spinIntervals.forEach(clearInterval);
            isSpinning = false;
            
            if (typeof countdownInterval !== 'undefined') clearInterval(countdownInterval);
            document.getElementById('drawTimer').style.display = 'none';
            
            showToast("Draw Failed: " + (err.reason || err.message)); 
        }
    }

    async function withdraw(curr) {
        try {
            showToast(`Withdrawing ${curr}...`);
            let cIdx = curr === 'ETH' ? 0 : (curr === 'USDT' ? 1 : 2);
            const bal = await gameContract.userCredits(userAddress, cIdx);
            if (bal == 0n) { showToast("No balance to withdraw"); return; }
            const tx = await gameContract.withdrawCredit(cIdx, bal);
            await tx.wait();
            showToast("Withdraw Success!");
            openWalletDashboard();
        } catch (err) { showToast("Withdraw Failed: " + (err.reason || err.message)); }
    }

    async function triggerBetModal() {
        if (!isConnected) { showToast("Connect Wallet First"); return; }
        
        // Cek Registrasi Dulu
        try {
            const u = await gameContract.users(userAddress);
            if(!u[1]) { 
                showToast("Please Register in Referral Panel below!"); 
                document.getElementById('referralPanel').scrollIntoView({behavior: "smooth"});
                return; 
            }
        } catch(e) { console.log(e); }

        if (currentSelectedAnimal.index === -1) { showToast("Select Animal First"); return; }
        
        // --- BAGIAN LIMIT MAX 2 SUDAH DIHAPUS ---
        // Sekarang user bisa bet sebanyak apapun
        
        document.getElementById("modalAnimalName").innerText = currentSelectedAnimal.name.toUpperCase();
        document.getElementById('paymentModal').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showToast(msg) {
        const x = document.getElementById("toast"); x.innerText = msg; x.className = "show";
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 8000);
    }

    async function openWalletDashboard() {
        document.getElementById('walletInfoModal').style.display = 'flex';
        document.getElementById('dashAddress').innerText = userAddress;
        try {
            const balEth = await provider.getBalance(userAddress);
            document.getElementById('balETH').innerText = parseFloat(ethers.formatEther(balEth)).toFixed(4);
            const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
            const balUsdt = await usdt.balanceOf(userAddress);
            document.getElementById('balUSDT').innerText = parseFloat(ethers.formatUnits(balUsdt, 18)).toFixed(2);
            const shib = new ethers.Contract(SHIB_ADDRESS, ERC20_ABI, provider);
            const balShib = await shib.balanceOf(userAddress);
            document.getElementById('balSHIB').innerText = parseFloat(ethers.formatUnits(balShib, 18)).toFixed(2);
            const credEth = await gameContract.userCredits(userAddress, 0);
            document.getElementById('credETH').innerText = parseFloat(ethers.formatEther(credEth)).toFixed(4);
            const credUsdt = await gameContract.userCredits(userAddress, 1);
            document.getElementById('credUSDT').innerText = parseFloat(ethers.formatUnits(credUsdt, 18)).toFixed(2);
            const credShib = await gameContract.userCredits(userAddress, 2);
            document.getElementById('credSHIB').innerText = parseFloat(ethers.formatEther(credShib)).toFixed(2);
        } catch (e) { console.error("Dashboard Error", e); }
    }

    function disconnectWallet() { localStorage.removeItem(`auth_${userAddress}`); location.reload(); }
    function copyRefLink() { navigator.clipboard.writeText(document.getElementById('displayRefLink').innerText); showToast("Link Copied"); }
    async function registerUser() {
        const nick = document.getElementById('regNickname').value;
        try {
            const tx = await gameContract.register(nick, detectedReferrer || ""); await tx.wait();
            closeModal('registerModal'); finalizeLogin();
        } catch (e) { showToast("Reg Failed: " + (e.reason || e.message)); }
    }
    async function claimReferralBonus() {
        try { const tx = await gameContract.claimReferralBonus(); await tx.wait(); showToast("Bonus Claimed!"); refreshGameData(); } catch (e) { showToast("Claim Failed"); }
    }

    async function registerUser() {
    // Ambil value dari input baru di panel
    const nick = document.getElementById('panelRegNick').value;
    
    if (!nick || nick.length < 3) {
        showToast("Nickname min 3 chars!");
        return;
    }

    try {
        showToast("Registering...");
        // Panggil kontrak
        const tx = await gameContract.register(nick, detectedReferrer || ""); 
        await tx.wait();
        
        showToast("Registration Success!");
        finalizeLogin(); // Refresh data halaman
    } catch (e) { 
        console.error(e);
        showToast("Reg Failed: " + (e.reason || e.message.slice(0,20))); 
    }
    }

    // --- LOGIC KOMENTAR SUPPORT NEW LINE ---

    async function toggleComments(roundId) {
        const section = document.getElementById(`comments-section-${roundId}`);
        const isHidden = section.style.display === 'none' || section.style.display === '';
        if (isHidden) {
            section.style.display = 'block';
            loadComments(roundId);
        } else {
            section.style.display = 'none';
        }
    }

    async function loadComments(roundId) {
        const listDiv = document.getElementById(`comments-list-${roundId}`);
        listDiv.innerHTML = '<div style="text-align:center; color:#555; font-size:0.8em;">Fetching comments...</div>';
        
        try {
            const count = await gameContract.commentCounts(roundId);
            document.getElementById(`comment-count-badge-${roundId}`).innerText = count;

            if (count == 0n) {
                listDiv.innerHTML = '<div style="text-align:center; color:#555; font-size:0.8em;">No comments yet.</div>';
                return;
            }

            listDiv.innerHTML = ''; 

            for (let i = 0; i < count; i++) {
                const c = await gameContract.roundComments(roundId, i);
                
                const cId = c[0];
                const author = c[1]; 
                const rawData = c[2]; // Data mentah dari Blockchain
                const time = Number(c[3]);
                const isEdited = c[4];
                const avatarUrl = getAvatar(author);

                // --- DEBUGGING (Cek di Console F12) ---
                // Kita lihat apa isi sebenarnya dari rawData
                // console.log(`Comment #${cId} Raw Data:`, rawData); 

                let displayMessage = "";
                let displayImage = "";

                if (rawData.includes("||IMG||")) {
                    const parts = rawData.split("||IMG||");
                    displayMessage = parts[0]; 
                    
                    // Ambil URL dan bersihkan spasi
                    let rawUrl = parts[1] ? parts[1].trim() : "";

                    // --- PERBAIKAN: AUTO FIX LINK LAMA ---
                    // Jika linknya masih versi 'i.ibb.co' (kena blokir), kita ganti di sini
                    if (rawUrl.includes("i.ibb.co") && !rawUrl.includes("i.ibb.co.com")) {
                        rawUrl = rawUrl.replace("i.ibb.co", "i.ibb.co.com");
                    }
                    // -------------------------------------

                    if (rawUrl.startsWith("http")) {
                        displayImage = `<img src="${rawUrl}" class="comment-image-result" onclick="window.open('${rawUrl}','_blank')">`;
                    }
                } else {
                    displayMessage = rawData; 
                }
                // -----------------------------------

                const isMyComment = (userAddress && author.toLowerCase() === userAddress.toLowerCase());
                const dateStr = new Date(time * 1000).toLocaleString([], {hour:'2-digit', minute:'2-digit', day:'numeric', month:'short'});
                const nameElementId = `author-name-${roundId}-${cId}`;

                const safeRawData = encodeURIComponent(rawData);

                const editIconHtml = `
                    <button class="btn-edit-icon" onclick="enableEditMode(${roundId}, ${cId}, '${safeRawData}')" title="Edit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                `;

                const viewProfileHtml = `
                    <button class="btn-view-profile" onclick="openPlayerProfile('${author}')" title="View Profile">
                        <img src="user.png" style="width:16px; height:16px; opacity:0.8;">
                    </button>
                `;

                const item = document.createElement('div');
                item.className = 'comment-item';

                item.innerHTML = `
                    <div class="comment-bubble" id="bubble-${roundId}-${cId}">
                        
                        ${isMyComment ? editIconHtml : ''}

                        <div class="comment-author" id="${nameElementId}" 
                             onclick="openPlayerProfile('${author}')" 
                             style="display:flex; align-items:center; gap:8px; color:var(--accent); cursor:pointer; width:fit-content;">
                            
                            <img src="${avatarUrl}" style="width:24px; height:24px; border-radius:50%; border:1px solid rgba(255,255,255,0.2); background:#000;">
                            <span>Loading...</span>
                        
                        </div>
                        <br>
                        <div class="comment-text" id="text-${roundId}-${cId}"></div> 
                        
                        ${displayImage}

                        <div class="comment-meta">
                            <span>${dateStr}</span>
                            ${isEdited ? '<span>(Edited)</span>' : ''}
                        </div>

                        ${viewProfileHtml}
                    </div>
                `;
                
                item.querySelector(`#text-${roundId}-${cId}`).innerText = displayMessage;
                listDiv.appendChild(item);

                gameContract.users(author).then(u => {
    const nick = u[0]; 
    const el = document.getElementById(nameElementId);
    if (el && nick) {
        // Gunakan innerHTML agar Avatar + Nama baru dirender ulang bersamaan
        el.innerHTML = `
            <img src="${avatarUrl}" style="width:24px; height:24px; border-radius:50%; border:1px solid rgba(255,255,255,0.2); background:#000;">
            <span>${nick}</span>
        `;
    }
}).catch(() => {});
            }
        } catch (e) {
            console.error(e);
            listDiv.innerHTML = '<div style="color:red; font-size:0.8em;">Failed to load.</div>';
        }
    }


    async function postComment(roundId) {
        const input = document.getElementById(`input-comment-${roundId}`);
        const rawText = input.value.trim();
        const file = selectedFiles[roundId];

        if (!isConnected) { showToast("Connect wallet first!"); return; }
        if (!rawText && !file) return;

        const btn = document.querySelector(`#comments-section-${roundId} .btn-post-comment`);
        btn.disabled = true;

        try {
            let finalContent = rawText; 

            // Jika ada gambar
            if (file) {
                showToast("Compressing & Uploading...");
                
                // 1. KOMPRESI GAMBAR DULU
                // File asli (misal 4MB) -> Jadi Blob kecil (misal 150KB)
                const compressedFile = await compressImage(file);
                
                // 2. UPLOAD FILE YANG SUDAH DIKOMPRES
                const imgUrl = await uploadToImgBB(compressedFile);
                
                if (imgUrl) {
                    finalContent = rawText + IMG_SEPARATOR + imgUrl;
                } else {
                    showToast("Image upload failed");
                    btn.disabled = false;
                    return;
                }
            }

            showToast("Posting to blockchain...");
            const tx = await gameContract.addComment(roundId, finalContent);
            await tx.wait();

            showToast("Success!");
            input.value = "";
            clearImage(roundId);
            loadComments(roundId);

        } catch (e) {
            console.error(e);
            showToast("Error posting.");
        } finally {
            btn.disabled = false;
        }
    }

    function enableEditMode(roundId, cId, encodedData) {
        const rawData = decodeURIComponent(encodedData);
        const bubble = document.getElementById(`bubble-${roundId}-${cId}`);
        const uniqueId = `${roundId}-${cId}`;
        
        let textOnly = rawData;
        let oldImgUrl = "";

        // Pisahkan Teks dan URL Gambar Lama
        if (rawData.includes("||IMG||")) {
            const parts = rawData.split("||IMG||");
            textOnly = parts[0];
            oldImgUrl = parts[1] ? parts[1].trim() : "";
        }
        
        // Reset status helper sebelumnya
        delete selectedEditFiles[uniqueId];
        delete editImageDeleteStatus[uniqueId];

        // --- RENDER TAMPILAN MODE EDIT BARU ---
        bubble.innerHTML = `
            <div style="font-size:0.8em; font-weight:bold; color:var(--accent); margin-bottom:5px;">EDIT COMMENT</div>
            
            <textarea id="edit-input-${uniqueId}" 
                   style="width:100%; background:#111; color:white; border:1px solid #555; padding:8px; border-radius:8px; margin-bottom:8px; min-height:60px; font-family:inherit; white-space:pre-wrap; resize:vertical;"></textarea>
            
            ${oldImgUrl ? `
                <div id="edit-old-image-${uniqueId}" class="edit-image-container">
                    <div style="display:flex; align-items:center;">
                        <img src="${oldImgUrl}" class="edit-thumb">
                        <div style="font-size:0.75em; color:var(--primary);">
                            <div>Current image will be kept.</div>
                        </div>
                    </div>
                    <button class="btn-delete-img" onclick="deleteOldImage('${uniqueId}')" title="Delete Image"></button>
                </div>
            ` : ''}

            <div id="edit-preview-new-${uniqueId}" class="edit-image-container" style="display:none; border-color:var(--success);">
                <div style="display:flex; align-items:center;">
                    <img id="edit-thumb-new-${uniqueId}" src="" class="edit-thumb">
                    <div style="font-size:0.75em; color:var(--success);">
                        <div>New image selected!</div>
                        <div style="font-size:0.8em; color:#888;">Added new image.</div>
                    </div>
                </div>
            </div>

            <input type="file" id="file-edit-${uniqueId}" 
                   accept="image/png, image/jpeg, image/gif, image/webp" 
                   style="display:none;" 
                   onchange="handleEditFileSelect(event, ${roundId}, ${cId})">

            <div style="display:flex; justify-content: space-between; align-items: center; margin-top:5px;">
                <div style="display:flex; gap:8px;">
                    <button class="btn-copy" style="background:var(--success); padding: 5px 15px;" 
                            id="btn-save-edit-${uniqueId}"
                            data-old-img="${oldImgUrl}" 
                            onclick="saveEditComment(${roundId}, ${cId})">Save</button>
                    <button class="btn-copy" style="background:#555; padding: 5px 10px;" onclick="loadComments(${roundId})">Cancel</button>
                </div>
                <div>
                     <button id="btn-edit-upload-${uniqueId}" onclick="document.getElementById('file-edit-${uniqueId}').click()" title="Change/Add Image" 
                            style="background: transparent; border: 1px solid #555; border-radius: 8px; padding: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition:0.2s;">
                        <img src="image.png" style="width:17px; height:17px; object-fit:contain; opacity:0.8;">
                    </button>
                </div>
            </div>
        `;
        
        // Masukkan teks ke textarea
        document.getElementById(`edit-input-${uniqueId}`).value = textOnly;
    }

    async function saveEditComment(roundId, cId) {
        const uniqueId = `${roundId}-${cId}`;
        const input = document.getElementById(`edit-input-${uniqueId}`);
        const saveBtn = document.getElementById(`btn-save-edit-${uniqueId}`);
        
        const newText = input.value;
        const oldImgUrl = saveBtn.getAttribute('data-old-img');
        const newFile = selectedEditFiles[uniqueId]; // File baru
        const isDeleteRequested = editImageDeleteStatus[uniqueId]; // Status hapus (true/false)

        // Validasi: Jangan simpan jika teks kosong DAN tidak ada gambar sama sekali (gambar lama dihapus atau tidak ada, gambar baru juga tidak ada)
        const willHaveImage = (oldImgUrl && !isDeleteRequested) || newFile;
        if(!newText.trim() && !willHaveImage) {
            showToast("Comment cannot be empty!");
            return;
        }

        saveBtn.disabled = true;
        saveBtn.innerHTML = `<img src="loading.png" style="width:16px; height:16px; animation: spin 1s linear infinite;">`;

        try {
            showToast("Processing update...");
            
            let finalImgUrl = ""; // Default kosong

            // --- LOGIKA PENENTUAN GAMBAR AKHIR ---
            if (newFile) {
                // KASUS 1: Ada file baru dipilih -> Upload dan pakai URL baru
                showToast("Uploading new image...");
                const compressedFile = (typeof compressImage === 'function') ? await compressImage(newFile) : newFile;
                const uploadedUrl = await uploadToImgBB(compressedFile);
                if (uploadedUrl) {
                    finalImgUrl = uploadedUrl;
                } else {
                    throw new Error("Image upload failed");
                }
            } else if (oldImgUrl && !isDeleteRequested) {
                // KASUS 2: Tidak ada file baru, TAPI gambar lama ADA dan TIDAK DIMINTA HAPUS -> Pakai URL lama
                finalImgUrl = oldImgUrl;
            }
            // KASUS 3: Jika isDeleteRequested = true, maka finalImgUrl tetap "", artinya gambar dihapus.

            // --- PACKING DATA ---
            let finalContent = newText;
            if (finalImgUrl && finalImgUrl.length > 5) {
                finalContent = newText + IMG_SEPARATOR + finalImgUrl;
            }

            // --- KIRIM KE BLOCKCHAIN ---
            showToast("Sending to blockchain...");
            const tx = await gameContract.editComment(roundId, cId, finalContent);
            await tx.wait();
            
            showToast("Comment updated!");
            // Bersihkan memory
            delete selectedEditFiles[uniqueId];
            delete editImageDeleteStatus[uniqueId];
            loadComments(roundId);

        } catch(e) {
            console.error(e);
            showToast("Update failed: " + (e.reason || e.message || "Error"));
            saveBtn.disabled = false;
            saveBtn.innerText = "Save";
        }
    }

        // 1. Helper: Saat file dipilih

    function handleFileSelect(event, rId) {

        const file = event.target.files[0];

        if (!file) return;

        selectedFiles[rId] = file;

        

        const reader = new FileReader();

        reader.onload = function(e) {

            document.getElementById(`preview-box-${rId}`).style.display = 'block';

            document.getElementById(`img-preview-${rId}`).src = e.target.result;

        };

        reader.readAsDataURL(file);

    }



    // 2. Helper: Batal upload

    function clearImage(rId) {

        delete selectedFiles[rId];

        document.getElementById(`preview-box-${rId}`).style.display = 'none';

        document.getElementById(`file-upload-${rId}`).value = "";

    }

     function handleEditFileSelect(event, roundId, cId) {

        const file = event.target.files[0];

        const uniqueId = `${roundId}-${cId}`;

        

        if (file) {

            selectedEditFiles[uniqueId] = file;

            

            // Tampilkan Preview Gambar Baru

            const reader = new FileReader();

            reader.onload = function(e) {

                const previewBox = document.getElementById(`edit-preview-new-${uniqueId}`);

                const previewImg = document.getElementById(`edit-thumb-new-${uniqueId}`);

                previewImg.src = e.target.result;

                previewBox.style.display = 'flex'; // Munculkan container preview



                // Sembunyikan container gambar lama (karena akan diganti yang baru)

                const oldImageBox = document.getElementById(`edit-old-image-${uniqueId}`);

                if (oldImageBox) oldImageBox.style.display = 'none';

            };

            reader.readAsDataURL(file);



            // Ubah warna tombol upload jadi hijau

            const uploadBtn = document.getElementById(`btn-edit-upload-${uniqueId}`);

            if(uploadBtn) uploadBtn.style.borderColor = 'var(--success)';

        }

    }



    // Fungsi saat tombol X merah diklik (Menandai gambar lama untuk dihapus)

    function deleteOldImage(uniqueId) {

        // Tandai status hapus menjadi TRUE

        editImageDeleteStatus[uniqueId] = true;

        

        // Sembunyikan container gambar lama secara visual

        const oldImageBox = document.getElementById(`edit-old-image-${uniqueId}`);

        if (oldImageBox) {

            oldImageBox.style.display = 'none';

            showToast("Image marked for deletion.");

        }

    }
    
    // 3. Helper: Upload ke ImgBB
    async function uploadToImgBB(file) {
        const formData = new FormData();
        formData.append("image", file);
        try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST", body: formData
            });
            const data = await res.json();
            
            if (data.success) {
                let originalUrl = data.data.url;
                
                // --- PERBAIKAN: GANTI DOMAIN AGAR TIDAK DIBLOKIR ---
                // Mengubah 'i.ibb.co' menjadi 'i.ibb.co.com'
                let safeUrl = originalUrl.replace("i.ibb.co", "i.ibb.co.com");
                
                return safeUrl; 
            } else {
                return null;
            }
        } catch(e) { return null; }
    }

    // --- FUNGSI KOMPRESI PINTAR (Target Max 300KB) ---
    function compressImage(file) {
        const MAX_SIZE = 300 * 1024; // 300KB (Batas Atas)
        // Kita tidak set batas bawah (Min) secara keras, karena jika file aslinya 50KB, 
        // tidak mungkin kita paksa jadi 200KB (nanti pecah/blur).
        
        return new Promise((resolve, reject) => {
            // 1. Cek Ukuran Awal
            // Jika file sudah di bawah 300KB, langsung kirim aslinya (Original Quality)
            if (file.size <= MAX_SIZE) {
                console.log(`File original sudah aman: ${(file.size/1024).toFixed(2)}KB`);
                resolve(file);
                return;
            }

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                
                img.onload = async function() {
                    let width = img.width;
                    let height = img.height;
                    
                    // Resize dimensi dulu jika terlalu raksasa (misal > 2000px)
                    // Ini membantu agar proses kompresi lebih ringan
                    const maxDimension = 1500; 
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = Math.round(height * (maxDimension / width));
                            width = maxDimension;
                        } else {
                            width = Math.round(width * (maxDimension / height));
                            height = maxDimension;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // --- LOGIKA LOOPING KOMPRESI (Mencari Sweet Spot) ---
                    let quality = 0.9; // Mulai dari kualitas 90%
                    let compressedBlob = null;
                    
                    // Lakukan loop selama ukuran masih di atas 300KB dan kualitas masih layak (> 0.1)
                    do {
                        compressedBlob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality));
                        
                        console.log(`Percobaan Quality ${quality.toFixed(1)}: ${(compressedBlob.size / 1024).toFixed(2)}KB`);
                        
                        // Jika masih kegedean, kurangi kualitas
                        if (compressedBlob.size > MAX_SIZE) {
                            quality -= 0.1; // Turunkan 10% setiap step
                        } else {
                            // Sudah pas (Under 300KB), berhenti loop
                            break;
                        }
                    } while (quality > 0.1);

                    console.log(` Final Size: ${(compressedBlob.size / 1024).toFixed(2)}KB`);
                    resolve(compressedBlob);
                }
            }
            reader.onerror = error => reject(error);
        });
    }

    async function openPlayerProfile(targetAddress) {
        // 1. Tampilkan Modal & Reset UI
        document.getElementById('playerProfileModal').style.display = 'flex';
        document.getElementById('pp-nickname').innerText = "Loading...";
        document.getElementById('pp-address').innerText = targetAddress.substring(0,10) + "..." + targetAddress.substring(38);
        document.getElementById('pp-wins').innerText = "...";
        document.getElementById('pp-bets').innerText = "...";
        
        const historyDiv = document.getElementById('pp-history-list');
        historyDiv.innerHTML = '<div style="text-align:center; padding:10px; color:#aaa;">Scanning Blockchain...</div>';

        // Update Avatar Robot
        document.getElementById('pp-avatar-img').src = getAvatar(targetAddress);

        try {
            // 2. Ambil Nickname (Data Ringan)
            const u = await gameContract.users(targetAddress);
            document.getElementById('pp-nickname').innerText = u[0] || "Unknown";

            // 3. SCAN HISTORY (Data Berat)
            
            // --- PERBAIKAN UTAMA DI SINI ---
            // Jangan scan dari blok 0. Gunakan blok estimasi Base Sepolia (Nov 2024).
            // Angka ini (17000000) adalah blok sekitar bulan lalu.
            // Ini membuat loading JAUH lebih cepat dan anti-error.
            const SAFE_BLOCK_START = 17000000; 
            // -------------------------------

            // A. Hitung Total Kemenangan
            const filterWin = gameContract.filters.WinDistributed(targetAddress);
            const winLogs = await gameContract.queryFilter(filterWin, SAFE_BLOCK_START, "latest");
            document.getElementById('pp-wins').innerText = winLogs.length;

            // B. Hitung Total Taruhan
            const filterBet = gameContract.filters.NewBet(targetAddress);
            const betLogs = await gameContract.queryFilter(filterBet, SAFE_BLOCK_START, "latest");
            document.getElementById('pp-bets').innerText = betLogs.length;

            // 4. Render Riwayat 5 Terakhir
            historyDiv.innerHTML = '';
            
            if (betLogs.length === 0) {
                historyDiv.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">No recent history.</div>';
                return;
            }

            // Ambil 5 data paling baru
            const recent = betLogs.slice(-5).reverse();

            for (let log of recent) {
                // Decode data hewan (args[1] adalah animalChoice)
                const animalIdx = Number(log.args[1]);
                
                // Pastikan nama hewan ada (safety check)
                const animalName = (IMAGE_NAMES[animalIdx]) ? IMAGE_NAMES[animalIdx].toUpperCase() : "UNKNOWN";
                
                const row = document.createElement('div');
                row.className = 'pp-history-item'; 
            
                row.innerHTML = `
                    <span style="color:#ddd;">
                        Bet <b style="color:var(--primary); text-transform:uppercase;">${animalName}</b>
                    </span>
                    <span style="font-size:0.9em; color:#666; font-family:monospace;">
                        Block #${log.blockNumber}
                    </span>
                `;
                historyDiv.appendChild(row);
            }

        } catch (e) {
            console.error("Profile Error:", e); // Cek Console F12 untuk detail error
            historyDiv.innerHTML = '<div style="color:var(--danger); text-align:center; font-size:0.8em; padding:10px;">Connection Timeout.<br>Try refreshing.</div>';
            
            // Set angka jadi 0 jika gagal, jangan biarkan "..."
            if(document.getElementById('pp-wins').innerText === "...") document.getElementById('pp-wins').innerText = "0";
            if(document.getElementById('pp-bets').innerText === "...") document.getElementById('pp-bets').innerText = "0";
        }
    }

    function startCountdown(durationMs) {

        const timerEl = document.getElementById('drawTimer');

        if (!timerEl) return;

        

        timerEl.style.display = 'block'; // Munculkan timer

        

        // Waktu target berhenti

        const targetTime = Date.now() + durationMs;



        // Bersihkan timer lama jika ada agar tidak tumpang tindih

        if (countdownInterval) clearInterval(countdownInterval);



        countdownInterval = setInterval(() => {

            const now = Date.now();

            const distance = targetTime - now;



            if (distance < 0) {

                // Waktu habis

                clearInterval(countdownInterval);

                timerEl.innerText = "00:00";

                return;

            }



            // Format Detik (00:xx)

            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            timerEl.innerText = `00:${seconds < 10 ? '0' : ''}${seconds}`;

        }, 100); 

    }
    
    function setupEventListeners() {
        
        // 1. Listener Bet Baru
        listenerContract.on("NewBet", () => { 
            console.log("New Bet detected via WSS");
            setTimeout(() => { refreshGameData(); }, 2000); 
        });

        // 2. Listener LIVE DRAW
        listenerContract.on("BattleResult", async (reels, outcome, roundId) => {
            // --- [INI YANG TADI TERLEWAT] ---
            // Matikan Safety Timer agar tidak bentrok
            if (typeof safetyTimer !== 'undefined' && safetyTimer) clearTimeout(safetyTimer);
            // --------------------------------

            const rId = Number(roundId);
            console.log(` RESULT RECEIVED! Round #${rId}`);

            // A. Sync Animasi
            if (!isSpinning) {
                startSpinAnimation();
                if (spinStartTime === 0) spinStartTime = Date.now(); 
            }
            if (spinStartTime === 0) spinStartTime = Date.now();

            // B. Hitung Sisa Waktu
            const DURATION = 35000; 
            const now = Date.now();
            const elapsed = now - spinStartTime;
            let remaining = DURATION - elapsed;

            if (remaining < 0) remaining = 0;

            // C. Jalankan Timer Visual
            if (remaining > 0) {
                startCountdown(remaining); 
                showToast(`Revealing winner in ${Math.ceil(remaining/1000)}s...`);
            } else {
                document.getElementById('drawTimer').innerText = "00:00";
            }

            // D. Tunggu Waktu Habis
            await new Promise(r => setTimeout(r, remaining));

            // E. Stop Timer & Animasi
            if (typeof countdownInterval !== 'undefined') clearInterval(countdownInterval);
            const timerEl = document.getElementById('drawTimer');
            if (timerEl) timerEl.style.display = 'none'; 

            const r1 = Number(reels[0]);
            const r2 = Number(reels[1]);
            const r3 = Number(reels[2]);
            stopSpinAnimation(r1, r2, r3); 

            showToast(`Result: ${outcome}`);
            
            // F. Efek Glamour
            const winnersIndices = new Set([r1, r2, r3]);
            for (let i = 0; i < 6; i++) {
                const card = document.getElementById(`card-${i}`);
                if (winnersIndices.has(i)) card.classList.add('winner-glamour');
                else card.classList.remove('winner-glamour');
            }
            // Hapus efek setelah 8 detik
            setTimeout(() => { 
                for (let i = 0; i < 6; i++) 
                    document.getElementById(`card-${i}`).classList.remove('winner-glamour'); 
            }, 8000);

            // --- FITUR RESET & REFRESH (3 DETIK) ---
            
            // 1. Reset Gambar
            setTimeout(() => {
                resetReelsToDefault();
            }, 3000); 

            // 2. Reset Logika & Data
            spinStartTime = 0;

            setTimeout(() => { 
                console.log("Refreshing Data...");
                refreshGameData(); 
            }, 3000);
        });      
    }
</script>
</body>
                                                                                                                                                                                                     </html>
