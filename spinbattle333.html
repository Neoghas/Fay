<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --red-main: #c0392b;
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  body {
  margin: 0;
  min-height: 100vh; /* Gunakan min-height, bukan height fix */
  background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
  font-family: "Ubuntu", sans-serif;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  /* justify-content: center; Hapus ini agar konten mulai dari atas */
  padding: 20px 0; /* Beri sedikit ruang atas bawah */
  overflow-x: hidden; /* Hanya sembunyikan scroll horizontal jika perlu */
  overflow-y: auto; /* Izinkan scroll vertikal */
  }

/* === HERO SECTION STYLES (SIMPLE) === */
#hero-section {
    position: relative;
    width: 100%;
    min-height: 20vh; /* Tinggi sesuai permintaan */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding-top: 80px;
    padding-bottom: 40px;
    background: var(--bg-dark-2);
    border-bottom: 1px solid rgba(120, 0, 255, 0.2); /* Garis pemisah halus di bawah */
}

/* Latar Belakang Statis yang Ringan */
.hero-static-bg {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0;
    opacity: 0.4;
    /* Pola grid halus statis */
    background-image: 
        linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
    background-size: 30px 30px;
}

/* Konten Hero (Box Title) */
.hero-content {
    position: relative; z-index: 1;
    text-align: center; max-width: 800px; padding: 30px;
    background: rgba(10, 10, 25, 0.5); /* Latar sedikit lebih gelap */
    backdrop-filter: blur(5px); /* Blur ringan */
    border-radius: 15px;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Bayangan agar menonjol */
}

.hero-title {
    background: #000;
    font-size: 2rem; font-weight: 700; margin: 0 0 15px 0;
    font-family: "Ubuntu", sans-serif;
    letter-spacing: 2px; line-height: 1.1;
}
.hero-title .highlight-text {
    background: linear-gradient(90deg, #03a9f4, #f441a5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
    display: block;
}
.hero-subtitle {
    font-size: 1.1rem; color: #ccc; margin: 0 auto 30px auto;
    max-width: 600px; line-height: 1.5;
}

/* Tombol CTA */
.hero-cta-container { display: inline-block; cursor: pointer; }
.play-now-btn {
    background: linear-gradient(90deg, var(--pink-main), var(--blue-main)); color: #ffffff; /* Warna solid langsung */
    border: none; padding: 12px 35px;
    font-size: 16px; font-weight: bold; letter-spacing: 1px;
    border-radius: 12px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; align-items: center; gap: 8px;
}
.play-now-btn:hover {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4);
}
.arrow-icon { font-size: 1.2em; }

/* Responsif Ponsel */
@media (max-width: 768px) {
    .hero-title { font-size: 2.2rem; }
    .hero-subtitle { font-size: 1rem; }
    .hero-content {
        width: 90%;
        padding: 20px;
        margin: 0 auto; /* Tambahkan ini agar simetris di tengah */
        box-sizing: border-box; /* Pastikan padding tidak menambah lebar total */
    }
}

  /* Mode PC (layar besar) */
@media (min-width: 1024px) {
  #hero-section {
    min-height: 5vh; /* lebih pendek di PC */
    padding-top: 60px;
    padding-bottom: 20px;
  }
}

  .app-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  .lists-wrapper {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-top: 20px;
      width: 90%;
      max-width: 820px;
  }

  /* === [DIUBAH] Wallet Buttons Container === */
  .wallet-container {
    position: fixed;
    top: 20px;
    right: 25px;
    display: flex;
    gap: 10px;
    z-index: 1001;
  }
  .wallet-btn, .referral-btn {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 14px; font-weight: bold; padding: 10px 20px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main);
    transition: all 0.3s ease;
  }
  .wallet-btn:hover, .referral-btn:hover { 
      box-shadow: 0 0 25px var(--pink-main); 
      transform: scale(1.05); 
  }
  
  /* [BARU] Tombol Referral */
  .referral-btn {
      background: linear-gradient(90deg, var(--pink-main), var(--blue-main));
      display: none; /* Sembunyi sampai connect */
  }

  /* Mengganti style .wallet-info lama agar sesuai di dalam modal */
  #walletInfo {
    font-size: 14px;
    line-height: 1.6;
    color: #ccc;
  }
  #walletInfo p { margin: 8px 0; }
  #walletInfo span { color: var(--cyan-main); font-weight: bold; }
  #walletInfo hr {
      border: none;
      height: 1px;
      background-color: var(--border-color);
      margin: 12px 0;
  }

  /* [BARU] Style untuk tombol Disconnect */
  .modal-btn-disconnect {
      background: linear-gradient(90deg, var(--pink-main), var(--red-main));
      box-shadow: 0 0 20px var(--pink-main);
  }
  .modal-btn-disconnect:hover {
      box-shadow: 0 0 25px var(--red-main);
  }

  /* === [PERBAIKAN] Memindahkan Modal Wallet ke Pojok Kanan Atas === */

#wallet-modal {
    /* 1. Hapus pemusatan dari class .modal */
    top: 65px;  /* (Tombol 20px + Jarak 45px) */
    left: auto;
    right: 25px;
    
    /* 2. Hapus transform pemusatan & scaling */
    transform: none;

    /* 3. Atur ulang animasi 'show/hide' agar muncul dari atas (bukan zoom) */
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

/* 4. Ganti animasi .modal.show */
#wallet-modal.show {
    transform: translateY(0);
    opacity: 1;
}

/* 5. Hapus latar belakang gelap HANYA untuk modal ini */
#wallet-modal-overlay.show {
     background: transparent;
     backdrop-filter: none;
}

  /* === Controls (Tidak Berubah) === */
  .controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 250px; 
  }
  .main-btn {
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    padding: 12px 30px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s ease;
    width: 100%;
  }
  #placeBetBtn {
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main);
  }
  #placeBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }
  #finalizeBtn {
    background: linear-gradient(90deg, var(--pink-main), var(--blue-main));
    box-shadow: 0 0 20px var(--pink-main);
    display: none;
  }
  #finalizeBtn:hover { box-shadow: 0 0 25px var(--red-main); transform: scale(1.05); }
  .main-btn:disabled {
    background: #555;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
  }
  .status {
    font-size: 13px;
    margin-top: 8px;
    color: var(--blue-main);
    min-height: 1.2em;
    text-align: center;
    max-width: 320px;
  }
  .timer {
      font-size: 16px;
      font-weight: bold;
      color: var(--cyan-main);
      margin-top: 10px;
      height: 20px;
  }

  /* === Bet & Winner Lists (Tidak Berubah) === */
  .list-container {
    width: 100%;
    max-width: 400px;
    max-height: 350px; 
    background: rgba(10, 10, 20, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  .list-container h3 {
    margin: 0 0 10px 0; font-size: 14px;
    color: var(--blue-main); text-align: center;
    text-transform: uppercase;
  }
  .bet-list-item, .winner-list-item {
    background: rgba(20, 20, 40, 0.7);
    border-radius: 4px; padding: 8px 10px;
    margin-bottom: 6px; font-size: 12px;
  }
  .bet-list-item {
    display: flex; justify-content: space-between;
    align-items: center;
  }
  .bet-list-item .player-id { font-weight: bold; color: var(--cyan-main); }
  .bet-list-item .player-bets { text-align: right; color: #eee; }
  .winner-list-item .winner-id {
    font-weight: bold;
    color: var(--cyan-main);
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .winner-list-item .winner-id span {
      font-weight: normal;
      color: #aaa;
  }
  .winner-list-item .prize-line {
      font-size: 11px;
      color: #eee;
  }
  #bet-list-placeholder, #winner-list-placeholder {
    text-align: center; font-size: 13px;
    color: #888; padding-top: 20px;
  }

  @media (min-width: 768px) {
  .list-container {
    max-height: 400px; /* Tinggi maksimal lebih besar di PC */
    /* Atau gunakan height tetap jika ingin selalu tinggi: */
    /* height: 400px; */
  }
  }
  
  /* === Modal Base (Digunakan oleh Bet & Referral) === */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999; display: none; opacity: 0;
    transition: opacity 0.3s ease;
  }
  .modal { /* [DIUBAH] Nama kelas generik */
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 380px;
    background: var(--bg-modal);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 0 40px rgba(180, 0, 255, 0.3);
    z-index: 1000; display: none; opacity: 0;
    transition: all 0.3s ease;
  }
  .modal-overlay.show, .modal.show { display: block; opacity: 1; }
  .modal.show { transform: translate(-50%, -50%) scale(1); }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2);
  }
  .modal-header h2 { margin: 0; font-size: 20px; color: var(--blue-main); }
  .modal-close-btn {
    font-size: 28px; font-weight: bold; color: #fff;
    cursor: pointer; line-height: 1; background: none; border: none;
  }
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .balance-display, .limits-display { font-size: 13px; color: #999; line-height: 1.5; }
  .limits-display p { margin: 2px 0; }
  .balance-display span, .limits-display span { font-weight: bold; color: var(--cyan-main); }
  .input-group { display: flex; gap: 10px; }
  .input-group input, .input-group select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    font-size: 16px;
    padding: 10px 12px;
  }
  .input-group input { flex-grow: 1; width: 65%; }
  .input-group select { width: 35%; }
  .percent-buttons { display: flex; justify-content: space-between; gap: 8px; }
  .percent-btn {
    flex: 1; background: rgba(120, 0, 255, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px; color: #fff;
    padding: 8px 10px; font-size: 13px;
    cursor: pointer; transition: background 0.2s ease;
  }
  .percent-btn:hover { background: rgba(120, 0, 255, 0.4); }
  .modal-footer { padding: 20px; border-top: 1px solid rgba(120, 0, 255, 0.2); }
  
  /* Tombol di footer modal */
  .modal-btn {
    width: 100%;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: bold; padding: 12px 30px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 20px var(--blue-main);
    transition: all 0.3s ease;
  }
  .modal-btn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.02); }
  .modal-btn:disabled {
    background: #555; color: #999;
    box-shadow: none; transform: none; cursor: not-allowed;
  }
  
  /* [BARU] Style khusus untuk Referral Modal */
  .ref-section {
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.1);
  }
  .ref-section:last-child { border-bottom: none; }
  .ref-section h3 {
      font-size: 16px;
      color: var(--cyan-main);
      margin: 0 0 10px 0;
  }
  .ref-info {
      font-size: 14px;
      color: #ccc;
      line-height: 1.6;
  }
  .ref-info span {
      color: #fff;
      font-weight: bold;
  }
  .ref-section .input-group {
      margin-bottom: 10px;
  }

  .reward-icon {
    width: 22px;
    height: 22px;
    margin-right: 6px;
    vertical-align: middle;
  }
  
  @media (max-width: 840px) {
    .lists-wrapper {
        flex-direction: column;
    }
  }

/* --- RODA SVG V4 (PERBAIKAN POSISI DAN UKURAN) --- */
.donut-wrap {
    position: relative;
    width: 100%;
    max-width: 450px; /* Lebar maksimal roda, sesuaikan jika perlu */
    aspect-ratio: 1 / 1; /* Memastikan container selalu kotak */
    margin: 30px auto; /* Margin atas/bawah agar tidak terlalu mepet */
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; /* Membuat container terlihat bulat */
    overflow: hidden; /* Penting agar elemen SVG yang keluar batas tidak terlihat */
    /* Menghilangkan filter drop-shadow dari sini, kita akan taruh di SVG langsung */
}

/* Pastikan SVG mengisi seluruh container */
.spin-wheel {
    width: 100%;
    height: 100%;
    display: block;
    /* Transform-origin di tengah untuk rotasi GSAP */
    transform-origin: center center;
    /* Tambahkan drop-shadow di SVG agar efeknya tidak terpotong overflow */
    filter: drop-shadow(0 0 20px rgba(98, 0, 255, 0.3));
}

/* Penunjuk (pointer) */
.donut-pointer {
    position: absolute;
    /* Sesuaikan 'top' agar panah tepat di atas roda */
    top: -20px; /* Nilai negatif ini sangat penting untuk posisi di atas */
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    width: 0;
    height: 0;
    border-left: 18px solid transparent; /* Ukuran dasar panah */
    border-right: 18px solid transparent;
    border-top: 38px solid var(--cyan-main); /* Ukuran dasar panah */
    filter: drop-shadow(0 0 10px var(--cyan-main)); /* Efek glow */
}

  /* TAMBAHKAN INI KE CSS ANDA */
#donutCanvas {
    width: 100%;
    height: 100%;
    display: block;
}

/* Tombol tengah */
.spin-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Pastikan di tengah container */
    width: 100px; /* Ukuran tombol tengah */
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(145deg, var(--pink-main), #4a0072);
    color: #fff;
    font-weight: bold;
    display: flex;
    flex-direction: column; /* Untuk teks dan timer */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 0 20px rgba(255, 0, 230, 0.5), inset 0 2px 5px rgba(255,255,255,0.3);
    border: 3px solid #fff;
    z-index: 15;
    text-align: center;
    transition: all 0.2s ease;
    font-size: 16px; /* Ukuran font teks tombol */
}
.spin-btn:hover {
    transform: translate(-50%, -50%) scale(1.05);
    box-shadow: 0 0 30px rgba(255, 0, 230, 0.7), inset 0 2px 5px rgba(255,255,255,0.5);
}
.spin-btn:disabled {
    background: #333;
    border-color: #555;
    cursor: not-allowed;
    opacity: 0.7;
}
.countdown-timer {
    font-size: 13px; /* Ukuran font timer */
    color: var(--cyan-main);
    margin-top: 4px;
}
  
  /* === [BARU] Style untuk Fitur Sosial === */
.winner-social {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(120, 0, 255, 0.2);
}

.like-btn {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}
.like-btn.liked {
    color: var(--pink-main); /* Warna pink saat di-like */
}
.like-btn:hover {
    color: #fff;
}

/* === [REVISI FINAL] Style Bintang Rating === */
.rating-stars {
    display: flex;
    gap: 4px;
    /* Kita BALIK urutannya agar :hover ~ berfungsi benar */
    flex-direction: row-reverse; 
}

.star-icon {
    width: 14px;
    height: 14px;
    cursor: pointer;
    mask-image: url('blackstar.svg');
    mask-size: contain;
    mask-repeat: no-repeat;
    mask-position: center;
    background-color: #555; /* Default mati */
    transition: background-color 0.1s ease;
}

/* Saat hover di SATU bintang, 
   SEMUA bintang "sebelumnya" (yang di kanannya di DOM) ikut menyala */
.star-icon:hover,
.star-icon:hover ~ .star-icon {
    background-color: gold;
}

/* Terapkan warna 'active' (rating yang tersimpan) */
/* Pastikan bintang 'active' tetap menyala meskipun tidak di-hover */
.rating-stars:hover .star-icon.active {
    background-color: gold;
}
.star-icon.active {
    background-color: gold;
}

  /* === [BARU] Gaya Komentar Futuristik (Terminal) === */

/* Container terminal utama */
.comments-terminal {
    background: rgba(0, 0, 0, 0.8); /* Latar lebih gelap agar teks terminal terbaca */
    border: 1px solid var(--purple-main);
    border-radius: 6px;
    padding: 10px;
    font-family: 'Courier Prime', monospace; /* Font monospace penting untuk gaya terminal */
    font-size: 12px;
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
    max-height: 300px; /* Batasi tinggi agar tidak terlalu panjang */
    overflow-y: auto; /* Scroll jika komentar banyak */
}

/* Header terminal (misal: > LOG FOR WINNER...) */
.terminal-header {
    color: var(--cyan-main);
    border-bottom: 1px dashed var(--purple-main);
    padding-bottom: 4px;
    margin-bottom: 10px;
    font-size: 10px; 
    opacity: 0.8;
    letter-spacing: 1px;
}

/* Blok satu komentar individu */
.comment-log {
    margin-bottom: 12px;
    padding-left: 8px;
    border-left: 2px solid var(--blue-main); /* Indikator garis di kiri */
}

/* Metadata komentar (Nickname, Waktu, Wallet) */
.log-meta { 
    color: #888; 
    font-size: 10px; 
    margin-bottom: 2px; 
}
.log-nickname { 
    color: var(--pink-main); /* Nickname warna pink neon */
    font-weight: bold; 
}
.log-wallet { 
    color: #555; 
}

/* Isi pesan komentar */
.log-message { 
    color: #eee; 
    line-height: 1.4; 
    white-space: pre-wrap; /* Agar enter/baris baru terbaca */
}

/* Input gaya terminal */
.terminal-input {
    flex-grow: 1; /* Mengisi sisa ruang */
    background: rgba(0,0,0,0.3);
    border: none; 
    border-bottom: 1px solid var(--cyan-main);
    color: var(--cyan-main);
    font-family: 'Courier Prime', monospace;
    padding: 4px 6px; 
    outline: none;
    font-size: 12px;
}
.terminal-input::placeholder {
    color: rgba(0, 255, 255, 0.3);
}

/* Tombol gaya terminal ([ SEND ], [ EDIT LOG ], dll) */
.terminal-btn {
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--cyan-main);
    color: var(--cyan-main); 
    padding: 3px 8px; 
    font-size: 10px;
    cursor: pointer; 
    font-family: 'Courier Prime', monospace;
    transition: all 0.2s ease;
}
.terminal-btn:hover { 
    background: var(--cyan-main); 
    color: #000; /* Teks jadi hitam saat hover agar kontras */
}

  .log-message { 
    /* ... */
    white-space: pre-wrap; /* Ini yang membuat baris baru (enter) terlihat */
  }

/* === [BARU] Navbar Glassmorphism === */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 30px;
    box-sizing: border-box;
    z-index: 1000;

    /* Efek Glassmorphism */
    background: rgba(10, 10, 25, 0.6); /* Latar belakang transparan gelap */
    backdrop-filter: blur(12px); /* Efek blur di belakangnya */
    border-bottom: 1px solid rgba(120, 0, 255, 0.3); /* Garis batas halus */
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); /* Bayangan lembut */
}

.navbar-logo {
    font-family: "Ubuntu", sans-serif;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
    /* Anda bisa menambahkan <img> di sini jika punya file logo */
}

.navbar-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

/* Hapus style .wallet-container yang lama karena sudah tidak dipakai */
/* .wallet-container { ... }  <-- HAPUS INI */

/* Sesuaikan posisi modal wallet agar pas di bawah navbar */
#wallet-modal {
    top: 80px; /* 70px navbar + 10px jarak */
    right: 25px;
    /* ... (sisa style modal tetap sama) ... */
}

  /* ===== Minimal Footer Style ===== */
  footer {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        background: #000; /* Warna gelap */
        color: #ddd; /* Warna teks */
        font-size: 12px;
    }

    .social-icons {
        margin-bottom: 10px;
    }

    .social-icons a {
    background: rgba(255, 255, 255, 0.2); /* Transparan seperti kaca */
    border-radius: 10px; /* Agar sedikit membulat */
    padding: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white; /* Warna ikon */
    font-size: 15px;
    margin: 0 5px;
    text-decoration: none;
    transition: transform 0.5s ease, text-shadow 0.5s ease, box-shadow 0.5s ease;
    box-shadow: 0 0 10px rgba(0, 0, 255, 0.6); /* Cahaya biru */
    backdrop-filter: blur(10px); /* Efek blur kaca */
}

/* Efek saat hover */
.social-icons a:hover {
    color: #1a88ff; /* Warna biru neon */
    text-shadow: 0 0 10px #1a88ff, 0 0 20px #1a88ff, 0 0 30px #1a88ff; /* Glow lebih intens */
    box-shadow: 0 0 20px rgba(0, 0, 255, 1), 0 0 30px rgba(0, 0, 255, 0.8); /* Shadow lebih terang */
    transform: rotate(360deg); /* Efek berputar */
}

/* === Style Modal Profil Player === */
.profile-body {
    align-items: center;
    text-align: center;
    padding-top: 30px !important; /* Tambah jarak atas */
}

/* Avatar Robot dengan Cincin Berputar */
.profile-avatar-container {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto 20px;
}
.profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: #0b0b15;
    border: 2px solid var(--cyan-main);
    padding: 5px; /* Jarak dari border */
    position: relative;
    z-index: 2;
}
.avatar-ring {
    position: absolute;
    top: -10px; left: -10px; right: -10px; bottom: -10px;
    border: 2px dashed var(--pink-main);
    border-radius: 50%;
    animation: spinRight 20s linear infinite;
    opacity: 0.6;
    z-index: 1;
}

/* Info Teks */
#profileNickname {
    color: var(--cyan-main);
    font-size: 24px;
    margin: 0 0 10px 0;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
}
.profile-address-box {
    background: rgba(0, 0, 0, 0.3);
    padding: 8px 15px;
    border-radius: 20px;
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    color: #aaa;
    cursor: pointer;
    display: inline-block;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.2s ease;
}
.profile-address-box:hover {
    border-color: var(--cyan-main);
    color: #fff;
}

/* Grid Statistik */
.profile-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    width: 100%;
    margin-top: 30px;
}
.stat-box {
    background: linear-gradient(135deg, rgba(20, 20, 40, 0.8), rgba(10, 10, 20, 0.9));
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid var(--purple-main);
    text-align: left;
}
.stat-label {
    display: block;
    font-size: 10px;
    color: #88aaff;
    letter-spacing: 1px;
    margin-bottom: 5px;
}
.stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #fff;
}
.active-glow {
    color: var(--cyan-main);
    text-shadow: 0 0 8px var(--cyan-main);
}

  /* === [BARU] Gaya Avatar di Riwayat Pemenang === */
.winner-main-content {
    display: flex;
    gap: 12px;
    align-items: flex-start; /* Rata atas agar rapi jika teks panjang */
}

.winner-avatar-small {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid var(cyan-main); /* Border pink agar mencolok */
    background: #0b0b15;
    padding: 2px;
    flex-shrink: 0; /* Agar avatar tidak mengecil */
    cursor: pointer; /* Menunjukkan bisa diklik */
    transition: transform 0.2s ease;
}
.winner-avatar-small:hover {
    transform: scale(1.1); /* Efek zoom sedikit saat hover */
}

.winner-info-text {
    flex-grow: 1; /* Mengisi sisa ruang */
    width: 100%; /* Memastikan lebar penuh */
}


  /* === VICTORY OVERLAY STYLES === */
#victory-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(5, 5, 16, 0.95); z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
    backdrop-filter: blur(10px);
}
#victory-overlay.show { opacity: 1; pointer-events: auto; }

#victory-canvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1;
}

.victory-content {
    position: relative; z-index: 2; text-align: center;
    transform: scale(0.8); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#victory-overlay.show .victory-content { transform: scale(1); }

.victory-title {
    font-size: 6rem; margin: 0; color: #fff;
    font-family: "Ubuntu", sans-serif; font-weight: 900; font-style: italic;
    text-shadow: 0 0 20px var(--cyan-main), 0 0 40px var(--cyan-main), 0 0 80px var(--cyan-main);
    animation: titlePulse 1s infinite alternate;
}

.victory-glitch {
    font-family: 'Courier Prime', monospace; color: var(--pink-main);
    font-size: 1.2rem; letter-spacing: 4px; margin-bottom: 20px;
    position: relative; display: inline-block;
}
/* Efek glitch sederhana dengan pseudo-elements */
.victory-glitch::before, .victory-glitch::after {
    content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%;
    background: rgba(5, 5, 16, 0.95); clip: rect(0, 0, 0, 0);
}
.victory-glitch::after {
    left: 2px; text-shadow: -1px 0 red; animation: glitch-anim 2s infinite linear alternate-reverse;
}

.victory-subtitle {
    color: #ccc; font-size: 1.2rem; margin-top: 10px;
}

.claim-victory-btn {
    margin-top: 40px; padding: 15px 50px; font-size: 18px;
    background: var(--pink-main); border: none; color: #fff; font-weight: bold;
    border-radius: 4px; cursor: pointer;
    box-shadow: 0 0 30px var(--pink-main);
    transition: all 0.3s ease;
}
.claim-victory-btn:hover {
    background: #fff; color: var(--pink-main); box-shadow: 0 0 50px #fff;
}

@keyframes titlePulse {
    from { text-shadow: 0 0 20px var(--cyan-main), 0 0 40px var(--cyan-main); }
    to { text-shadow: 0 0 40px var(--cyan-main), 0 0 80px var(--cyan-main); }
}
@keyframes glitch-anim {
    0% { clip: rect(30px, 9999px, 10px, 0); }
    5% { clip: rect(85px, 9999px, 66px, 0); }
    /* ... bisa ditambahkan lebih banyak frame untuk glitch yang lebih acak ... */
    100% { clip: rect(90px, 9999px, 100px, 0); }
}

/* Responsif untuk HP */
@media (max-width: 768px) {
    .victory-title { font-size: 4rem; }
    .victory-glitch { font-size: 0.9rem; letter-spacing: 2px; }
}

/* === LEADERBOARD STYLES (UPDATED) === */
.leaderboard-section {
    width: 90%; max-width: 820px; margin: 40px auto;
    text-align: center;
}

.section-title {
    background: linear-gradient(90deg, #03a9f4, #f441a5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent; 
    font-size: 24px; margin-bottom: 20px; letter-spacing: 2px;
    text-shadow: 0 0 10px var(--purple-main);
}

/* [BARU] Style untuk Tab Navigasi */
.lb-tabs {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 15px;
}

.lb-tab-btn {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid var(--purple-main);
    color: #888;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-family: "Ubuntu", sans-serif;
    font-weight: bold;
    font-size: 13px;
    transition: all 0.3s ease;
}

.lb-tab-btn:hover {
    color: #fff;
    border-color: var(--cyan-main);
    background: rgba(98, 0, 255, 0.1);
}

.lb-tab-btn.active {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    color: #fff;
    border: 1px solid transparent;
    box-shadow: 0 0 15px var(--purple-main);
}

/* Container Utama */
.leaderboard-container {
    background: rgba(10, 10, 25, 0.6);
    border: 1px solid var(--purple-main);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 0 30px rgba(98, 0, 255, 0.2);
}

/* [UBAH] Grid Layout disesuaikan jadi 4 Kolom untuk tampilan baru */
.lb-header, .lb-item {
    display: grid;
    /* Rank | Pilot | Total $ | Breakdown Aset */
    grid-template-columns: 0.5fr 1.5fr 1.5fr 2.5fr; 
    padding: 10px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2);
    font-size: 12px; 
    text-align: left;
    align-items: center; /* Agar teks rata tengah secara vertikal */
}

.lb-header {
    color: var(--cyan-main); 
    font-weight: bold; 
    letter-spacing: 1px;
    text-transform: uppercase;
    font-size: 11px;
}

.lb-item {
    color: #ccc; 
    transition: all 0.2s ease;
}

.lb-item:hover {
    background: rgba(98, 0, 255, 0.1); 
    color: #fff;
}

.lb-rank { 
    font-weight: bold; 
    color: var(--pink-main); 
}

.lb-loading { 
    padding: 20px; 
    color: #888; 
    font-style: italic; 
    animation: blink 1s infinite; 
}

/* Highlight untuk Juara 1, 2, 3 */
.lb-item.rank-1 { 
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent); 
    border-left: 3px solid gold; 
}
.lb-item.rank-2 { 
    border-left: 3px solid silver; 
}
.lb-item.rank-3 { 
    border-left: 3px solid #cd7f32; /* Bronze */ 
}

/* Animasi Loading */
@keyframes blink {
    0% { opacity: 0.3; }
    50% { opacity: 1; }
    100% { opacity: 0.3; }
}
  
  /* === [BARU] Gaya Box untuk Setiap Komentar === */

.comment-log {
    display: flex;
    gap: 10px; /* Jarak antara avatar dan teks */
    align-items: flex-start;
    
    /* GAYA BOX BARU */
    background: rgba(0, 0, 0, 0.4); /* Latar belakang box komentar */
    border: 1px solid rgba(0, 255, 255, 0.1); /* Border cyan tipis */
    border-left: 2px solid var(--purple-dark); /* Aksen pink di kiri */
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 10px; /* Jarak antar box komentar */
}

/* Avatar di dalam komentar */
.comment-avatar {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    border: 1px solid var(--cyan-main);
    background: #0b0b15;
    flex-shrink: 0;
    cursor: pointer;
    transition: transform 0.2s;
}
.comment-avatar:hover {
    transform: scale(1.1);
}

/* Konten teks di sebelah kanan avatar */
.comment-content {
    flex-grow: 1;
    width: 100%; /* Memastikan ini mengisi sisa ruang */
    word-wrap: break-word; /* Memastikan teks panjang pindah baris */
    overflow: hidden; /* Mencegah overflow */
}

/* Sisa style meta-data (pastikan font-family sudah ada) */
.log-meta { 
    color: #888; 
    font-size: 10px; 
    margin-bottom: 5px; 
    font-family: 'Courier Prime', monospace;
}
.log-nickname { 
    color: var(--pink-main); 
    font-weight: bold; 
    font-size: 12px;
}
.log-wallet { 
    color: #555; 
}
.log-message { 
    color: #eee; 
    line-height: 1.4; 
    white-space: pre-wrap;
    font-family: 'Courier Prime', monospace;
    font-size: 13px;
}

/* Tombol Edit di dalam box */
.comment-content .terminal-btn {
    opacity: 0.7;
    margin-top: 8px;
}
.comment-content .edit-actions {
    margin-top: 10px;
}

  /* === [REVISI] Ukuran Ikon Aset Pemenang === */
.asset-icon-group {
    display: flex;
    align-items: center;
    gap: 4px; /* Jarak antar ikon jika ada dua */
}

.asset-icon {
    width: 30px;  /* Sesuai permintaan Anda */
    height: 30px; /* Sesuai permintaan Anda */
    vertical-align: middle;
    filter: drop-shadow(0 0 3px var(--cyan-main)); /* Efek glow tipis */
}


  .balance-display {

    font-size: 13px; color: #999; line-height: 1.5;

}

.balance-display p {

    margin-top: 0;

    margin-bottom: 5px;

    font-weight: bold;

    color: #fff; /* Teks "Your Balance:" jadi putih */

}



/* Baris baru untuk ikon + saldo */

.balance-line {

    display: flex;

    align-items: center;

    gap: 8px; /* Jarak antara ikon dan angka */

    font-size: 15px;

    margin-bottom: 5px;

}



/* Ukuran ikon di modal */

.balance-icon {

    width: 22px;

    height: 22px;

}



/* Mengatur span (angka) agar tetap sama */

.balance-line span {

    font-weight: bold; color: var(--cyan-main);

}
  
/* Wrapper pembungkus input/select */
.input-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

/* Style ikon (img atau font-icon) */
.input-icon,
.input-icon-fa {
    position: absolute;
    left: 7px;           /* Jarak ikon dari kiri */
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    color: var(--cyan-main);
    opacity: 0.6;
    pointer-events: none;
}
.input-icon { width: 20px; height: 20px; }
.input-icon-fa { font-size: 14px; }

/* Style untuk input/select DI DALAM wrapper */
.input-icon-wrapper input,
.input-icon-wrapper select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    fonfont-size: 15px;

    /* Ruang untuk ikon kiri */
    padding: 10px 12px 10px 28px;

    width: 100%;
    box-sizing: border-box;
}

/* Style khusus SELECT agar panah terlihat */
.input-icon-wrapper select {
    appearance: none;
    -webkit-appearance: none;

    /* Ikon panah */
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%2Sxmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300FFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.6-3.6%205.4-7.9%205.4-12.9%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: .65em auto;

    padding-right: 10px; /* Ruang untuk panah */
}

    /* === STYLING NOTIFIKASI STATUS (TOAST) === */
#toast-container {
  position: fixed; /* Tetap di layar saat di-scroll */
  top: 90px; /* Di bawah navbar */
  right: 20px;
  z-index: 10000; /* Paling atas */
  width: 300px;
  max-width: 90%;
}

/* Style untuk setiap notifikasi */
.toast-notification {
  background: #333;
  color: white;
  padding: 15px 20px;
  margin-bottom: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  font-family: Arial, sans-serif;
  font-weight: bold;
  font-size: 14px;
  border: 2px solid #555;
  
  /* Flexbox untuk ikon + teks */
  display: flex;
  align-items: center;
  gap: 10px;
  
  /* Animasi fade-in dan fade-out */
  opacity: 0;
  transform: translateX(100%);
  transition: all 0.5s ease-in-out;
}

/* Animasi saat muncul */
.toast-notification.show {
  opacity: 1;
  transform: translateX(0);
}

/* Animasi saat hilang */
.toast-notification.hide {
  opacity: 0;
  transform: translateX(100%);
}

/* Ikon di dalam toast */
.toast-notification img {
  width: 30px;
  height: 30px;
  flex-shrink: 0;
}
.toast-notification span {
  flex-grow: 1;
  word-wrap: break-word;
}

/* Warna berdasarkan tipe */
.toast-notification.success {
  background: #2c4c00;
  border: 2px solid #69a31a;
}
.toast-notification.error {
  background: #4a2c2c;
  border: 2px solid #dc3545;
}
.toast-notification.info {
  background: #56616e;
  border: 2px solid #343a42;
}
.toast-notification.load {
  background: #0a3c66; /* Abu-abu gelap */
  border: border 2px solid #0061b3;
}

.toast-notification.warning {
  background: #997a00;
  border: 2px solid #ffcc00;
}

/* Warna untuk tipe 'spin' (Ungu/Pink) */
.toast-notification.spin {
  background: #501f66;
  border: 2px solid #a03ecc; /* Mengambil warna dari gradien tombol */
}

/* Warna untuk tipe 'wolf' (Biru Cyan) */
.toast-notification.wolf {
  background: #804f00;
  border: 2px solid #e68d00; /* Mengambil warna dari gradien tombol */
}

/* === STYLE BARU UNTUK TOMBOL CLOSE TOAST === */
.toast-close-btn {
  background: none;
  border: none;
  color: #ff4d4d;
  font-size: 24px;  /* Perbesar tombol 'x' */
  font-weight: bold;
  line-height: 1;
  padding: 0 5px;
  margin-left: 10px; /* Jarak dari teks */
  cursor: pointer;
  transition: color 0.2s;
}

/* Tombol close jadi merah saat di-hover */
.toast-close-btn:hover {
  color: #ff8282; 
}

/* Pastikan span-nya tidak menabrak tombol */
.toast-notification span {
  flex-grow: 1; /* Biarkan teks mengambil sisa ruang */
  word-wrap: break-word;
}

  /* Tombol Refresh Model Pil (Teks + Ikon) */
.wheel-refresh-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    
    /* Ukuran menyesuaikan teks */
    padding: 8px 15px;
    border-radius: 20px; /* Bentuk Pil */
    
    background: rgba(0, 0, 0, 0.7); /* Lebih gelap biar teks terbaca */
    border: 1px solid var(--cyan-main);
    color: var(--cyan-main);
    
    cursor: pointer;
    z-index: 20;
    
    /* Flexbox agar ikon dan teks sejajar */
    display: flex;
    align-items: center;
    gap: 8px; /* Jarak antara ikon dan teks */
    
    /* Styling Teks */
    font-family: "Ubuntu", sans-serif;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    
    transition: all 0.3s ease;
}

.wheel-refresh-btn:hover {
    background: var(--cyan-main);
    color: #000;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
    transform: translateY(-2px); /* Efek naik sedikit saat hover */
}

/* Animasi putar ikon */
.wheel-refresh-btn.spinning i {
    animation: spinIcon 1s linear infinite;
}

@keyframes spinIcon {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
  
  @media (min-width: 768px) {
  #donutCanvas {
    /* Ubah ukuran sesuai keinginan Anda, misalnya 500px */
    width: 550px !important;
    height: 550px !important;
  }
</style>
</head>

<body>
   <nav class="navbar">
      <div class="navbar-logo">
    <img src="logo.svg" alt="Faylotto Logo" style="height: 40px; margin-right: 10px;">
    <span style="font-weight:bold; font-size:20px; color:var(--cyan-main);"></span></div>
      <div class="navbar-actions">
          <button class="referral-btn" id="referralBtn">Referral</button>
          <button class="wallet-btn" id="walletBtn">Connect Wallet</button>
      </div>
   </nav>

   <div class="modal-overlay" id="wallet-modal-overlay"></div>
  <div class="modal" id="wallet-modal">
    <div class="modal-header">
      <h2>Wallet Info</h2>
      <button class="modal-close-btn" id="wallet-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body" id="walletInfo"> 
      <p>Address: <span id="walletAddress">-</span></p>
      <p><img src="eth.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">Balance (ETH): <span id="ethBalance">0</span></p>
      <p><img src="usdt.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">Balance (USDT): <span id="usdtBalance">0</span></p>
      <p><img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">BabyDoge: <span id="babyDogeBalance">0</span></p>
      <p>
      <img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">
      <span style="color: var(--cyan-main);">Free BabyDoge Balance:</span> 
      <span id="freeBalance">0</span>
      </p>
      <hr/>
      <p><img src="eth.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">My Deposits (ETH): <span id="myEthDeposit">0</span></p>
      <p><img src="usdt.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">My Deposits (USDT): <span id="myUsdtDeposit">0</span></p>
      <p><img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">My Deposits (BabyDoge): <span id="myBabyDogeDeposit">0</span></p>
      <p><img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px; filter: drop-shadow(0 0 5px var(--cyan-main));">Free Deposits (BabyDoge): <span id="myFreeDeposit">0</span></p>
    </div>
    <div class="modal-footer">
      <button id="disconnectBtn" class="modal-btn modal-btn-disconnect">Disconnect</button>
    </div>
  </div>

  <section id="hero-section">
    <div class="hero-static-bg"></div>
    
    <div class="hero-content">
        <h2 class="hero-title">
         <span class="highlight-text">Faylotto Spin Battle</span></h2>
        <p class="hero-subtitle">
          Spin the wheel of fortune on a decentralized network. Fair, transparent, and automated.
        </p>
        
        <div class="hero-cta-container" onclick="document.querySelector('.app-body').scrollIntoView({behavior: 'smooth'})">
            <button class="play-now-btn">
                Play Now! <span class="arrow-icon">â†“</span>
            </button>
        </div>
    </div>
  </section>

  <div class="app-body" style="margin-top: 80px;"> 
    
    <div class="donut-wrap">
    <div class="donut-pointer"></div>
    <canvas id="donutCanvas"></canvas>
    </div><br>
    <button id="refreshWheelBtn" class="wheel-refresh-btn">
        <i class="fa-solid fa-rotate"></i>
        <span>Refresh Wheel</span>
    </button><br>

    <div class="controls">
      <button id="placeBetBtn" class="main-btn">Place Bet</button>
      <button id="finalizeBtn" class="main-btn">Finalize Round</button>
      <div class="status" id="statusText">Wallet not connected</div>
      <div class="timer" id="timerText"></div>
    </div>
    
    <div class="lists-wrapper">
      <div id="bet-list-container" class="list-container">
          <h3>Current Round Bets</h3>
          <div id="bet-list">
              <p id="bet-list-placeholder">No bets placed yet in this round.</p>
          </div>
      </div>
      
      <div id="winner-list-container" class="list-container">
          <h3>Recent Winners</h3>
          <div id="winner-list">
              <p id="winner-list-placeholder">No winners yet.</p>
          </div>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="bet-modal-overlay"></div>
  <div class="modal" id="bet-modal">
  <div class="modal-header">
    <h2>Place Your Bet</h2>
    <button class="modal-close-btn" id="bet-modal-close-btn">&times;</button>
  </div>
  <div class="modal-body">
    <div class="balance-display">
      <p>Your Balance:</p> 
      <div class="balance-line">
          <img src="eth.svg" class="balance-icon" alt="ETH"> 
          <span id="modalEthBalance">0</span> ETH
      </div>
      
      <div class="balance-line">
          <img src="usdt.svg" class="balance-icon" alt="USDT"> <span id="modalUsdtBalance">0</span> USDT
      </div>
      
      <div class="balance-line">
          <img src="bb.svg" class="balance-icon" alt="BabyDoge"> <span id="modalBabyDogeBalance">0</span> BabyDoge
      </div>

      <div class="balance-line">
          <img src="bb.svg" class="balance-icon" alt="Free"> 
          <span id="modalFreeBalance">0</span> FREE
      </div>
    </div>
    
    <div class="input-group">
      
      <div class="input-icon-wrapper" style="flex-grow: 1; width: 65%;">
          <i class="fa-solid fa-hashtag input-icon-fa"></i>
          <input type="number" id="betAmountInput" placeholder="Custom Amount">
      </div>
      
      <div class="input-icon-wrapper select-wrapper" style="width: 35%;">
          <img src="eth.svg" class="input-icon" id="currency-icon" alt="">
          <select id="betCurrencySelect">
            <option value="ETH" data-icon="eth.svg">ETH</option>
            <option value="USDT" data-icon="usdt.svg">USDT</option>
            <option value="BABYDOGE" data-icon="bb.svg">BabyDoge</option>
            <option value="FREE" data-icon="bb.svg">FREE</option>
          </select>
      </div>

    </div>
    <div class="percent-buttons">
      <button class="percent-btn" data-percent="0.10">MIN</button> 
      <button class="percent-btn" data-percent="0.25">25%</button>
      <button class="percent-btn" data-percent="0.50">50%</button>
      <button class="percent-btn" data-percent="0.75">75%</button>
      <button class="percent-btn" data-percent="1.00">MAX</button>
    </div>
  </div>
  <div class="modal-footer">
    <button id="confirmBetBtn" class="modal-btn">Confirm Bet</button>
  </div>
  <center><p>
<span style="color:#f0f0f0; font-size: 13px;">Note:</span><br>
<span style="color:#ccba00; font-size: 12px;">
  Min bet is 0.00005 ETH Max 0.00256 ETH<br>
  Min bet is 0.5 ETH Max 10 USDT<br>
  Min bet is 1M BabyDoge Max 10M BabyDoge<br>
  Min bet is 500k FreeBabyDoge Max 10B FreeBabyDoge<br>
  Maximum bets are 2 per round
</span>
  </p></center>
</div>
  
  <div class="modal-overlay" id="referral-modal-overlay"></div>
  <div class="modal" id="referral-modal">
    <div class="modal-header">
      <h2>Referral System</h2>
      <button class="modal-close-btn" id="referral-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body">
        
      <div class="ref-section">
          <h3>My Info</h3>
          <div class="ref-info">
              My Nickname: <span id="myNickname">-</span><br/>
              My Referrer: <span id="myReferrer">-</span>
          </div>
      </div>
      
      <div class="ref-section">
          <h3>Create/Update Nickname</h3>
          <div class="input-group">
              <input type="text" id="nicknameInput" placeholder="Enter your nickname">
          </div>
          <button id="createNicknameBtn" class="modal-btn">Create</button>
      </div>

      <div class="ref-section" id="referralLinkSection" style="display: none;">
            <h3>Your Referral Link</h3>
            <div class="input-group">
                <input type="text" id="referralLinkInput" readonly style="cursor: pointer;">
            </div>
            <br><button id="copyReferralBtn" class="modal-btn">Copy Link</button>
      </div>
      
      <div class="ref-section">
    <h3>My Rewards</h3>
    <div class="ref-info">

        <img src="eth.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">
        ETH Rewards: <span id="ethRewards">0</span><br/>

        <img src="usdt.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">
        USDT Rewards: <span id="usdtRewards">0</span><br/>
        
        <img src="bb.svg" width="22" height="22" style="vertical-align: middle; margin-right: 5px;">
        BabyDoge Rewards: <span id="babyDogeRewards">0</span><br/>
        Total Referrals: <span id="referralCount">0</span>

    </div>
      </div>

    </div>
    <div class="modal-footer">
      <button id="claimRewardsBtn" class="modal-btn">Claim Rewards</button>
    </div>
  </div>

  <div class="modal-overlay" id="profile-modal-overlay"></div>
<div class="modal" id="profile-modal">
    <div class="modal-header">
        <h2>Identity_Log</h2> <button class="modal-close-btn" id="profile-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body profile-body">
        <div class="profile-avatar-container">
            <img id="profileAvatar" src="" alt="Avatar" class="profile-avatar-img">
            <div class="avatar-ring"></div>
        </div>
        
        <div class="profile-main-info">
            <h3 id="profileNickname">Loading...</h3>
            <div class="profile-address-box" onclick="copyToClipboard(this.innerText)" title="Click to Copy">
                <span id="profileAddress">0x000...0000</span> <i class="fa-regular fa-copy" style="font-size: 12px; opacity: 0.6;"></i>
            </div>
        </div>

        <div class="profile-stats-grid">
            <div class="stat-box">
                <span class="stat-label">Referral</span>
                <span class="stat-value" id="profileRefCount">-</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Status</span>
                <span class="stat-value active-glow">Active</span>
            </div>
             </div>
    </div>
</div>

  <div id="victory-overlay">
    <canvas id="victory-canvas"></canvas>
    <div class="victory-content">
        <div class="victory-glitch" data-text="NEURAL SYNC COMPLETE">NEURAL SYNC COMPLETE</div>
        <h1 class="victory-title">YOU WIN!</h1>
        <p class="victory-subtitle">Funds transferring to your secure wallet...</p>
        <button class="claim-victory-btn" onclick="hideVictoryScreen()">ACKNOWLEDGE</button>
    </div>
  </div>

  <section class="leaderboard-section">
    <h2 class="section-title">Top Pilot</h2>
    
    <div class="lb-tabs">
        <button class="lb-tab-btn active" onclick="switchLeaderboard('winners')">Top Winners</button>
        <button class="lb-tab-btn" onclick="switchLeaderboard('referrals')">Top Referrals</button>
    </div>

    <div class="leaderboard-container">
        <div class="lb-header" id="lb-header-row">
            <span>Rank</span>
            <span>Pilot</span>
            <span>Est. Value ($)</span>
            <span>Assets Breakdown</span>
        </div>
        
        <div id="leaderboard-list">
            <div class="lb-loading">> Loading Data...</div>
        </div>
    </div>
  </section>

<audio id="sfx-click" src="clickI.mp3" preload="auto"></audio>
<audio id="sfx-spin" src="spinI.mp3" preload="auto"></audio>
<audio id="sfx-win" src="winI.mp3" preload="auto"></audio>
<audio id="sfx-coin" src="coin.mp3" preload="auto"></audio>

  <div id="toast-container"></div>
    
  <footer>
    <div id="footer" class="social-icons">
        <a href="https://x.com/FaylottoXyz" target="_blank"><i class="fa-brands fa-twitter"></i></a>
        <a href="https://t.me/FaylottoXyz" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://t.me/Faylotto" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://discord.gg/6uMYTdCZwJ" target="_blank"><i class="fa-brands fa-discord"></i></a>
        <a href="https://facebook.com/Faylotto" target="_blank"><i class="fa-brands fa-facebook"></i></a>
    </div>
    <p>
      Â© Powered By Faylotto.
      <span>
        <a href="https://docs.faylotto.xyz/policy/AllRightsReserved" style="color: #007bff; text-decoration: none;" target="_blank">
          <span id="year"></span> All rights reserved. 
        </a>
      </span>
      Play responsibly.
      <span>
        <a href="privacypolicy" style="color: #007bff; text-decoration: none;" target="_blank">
          Privacy Policy.
        </a>
      </span>
    </p>
  </footer>

  <script>
    // ==================================================================
    // 1. KONFIGURASI KONTRAK V3 (BASE SEPOLIA)
    // ==================================================================
    
    // âš ï¸ GANTI DENGAN ALAMAT KONTRAK V3 ANDA YANG BARU
    const FAYLOTTO_ADDRESS = "0x998d821efa06D7C24260e41EBC68C9fD3f9219DA"; 
    
    // âš ï¸ GANTI DENGAN ALAMAT TOKEN RESMI DI BASE SEPOLIA
    const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2"; // USDT Base Sepolia
    const BABYDOGE_ADDRESS = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";   // BabyDoge Base Sepolia
    
    // âš ï¸ KONFIGURASI JARINGAN (Base Sepolia)
    const BASE_SEPOLIA_CHAIN_ID = '0x14A34'; // 84532
    const BASE_SEPOLIA_RPC = "https://sepolia.base.org";
    const WSS_URL = "wss://base-sepolia.drpc.org"; 
    
    const HTTPS_URL = BASE_SEPOLIA_RPC; 
    
    const ETH_USD_PRICE_FEED_ADDRESS = "0x4aDC67696bA383F43DD60A9e78F2C97Fbbfc7cb1";
   
    // --- KONFIGURASI UI ---
    const ETH_LOGO_PATH = "eth.svg"; 
    const USDT_LOGO_PATH = "usdt.svg"; 
    const BABYDOGE_LOGO_PATH = "bb.svg"; // âš ï¸ Pastikan Anda punya gambar ini

    const AUTO_CONNECT_KEY = "faylotto_v3_session";
    const AUTO_CONNECT_DURATION = 30 * 24 * 60 * 60 * 1000;

    const USDT_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
      

    const FAYLOTTO_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_babyDogeToken","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"},{"internalType":"address","name":"_nativeUsdPriceFeedAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetBabyDoge","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetFree","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetNative","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetUSDT","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"FreeSpinNoPrize","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"prizeTier","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FreeSpinWon","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"referralCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalEthClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalUsdtClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalBabyDogeClaimed","type":"uint256"}],"name":"LeaderboardReferralStatsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"int256","name":"newNetUsdScore","type":"int256"},{"indexed":false,"internalType":"int256","name":"netEth","type":"int256"},{"indexed":false,"internalType":"int256","name":"netUsdt","type":"int256"},{"indexed":false,"internalType":"int256","name":"netBabyDoge","type":"int256"}],"name":"LeaderboardScoreUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"babyDogeAmount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_BETS_PER_PLAYER","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_NATIVE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_USDT_UNSCALED","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"babyDogeDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeUsdPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeBalances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"freeBetCost","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"freeSpinHistory","outputs":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getFreeSpinHistory","outputs":[{"components":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.FreeSpinWinner[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLatestNativePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLeaderboardPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"internalType":"uint256","name":"babyDogeAmount","type":"uint256"},{"internalType":"uint256","name":"usdWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"usdtReward","type":"uint256"},{"internalType":"uint256","name":"babyDogeReward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalUSDT","type":"uint256"},{"internalType":"uint256","name":"totalBabyDoge","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"},{"internalType":"uint256","name":"totalWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isFreeSpinPaused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"leaderboardPlayers","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"leaderboardStats","outputs":[{"internalType":"int256","name":"netEth","type":"int256"},{"internalType":"int256","name":"netUsdt","type":"int256"},{"internalType":"int256","name":"netBabyDoge","type":"int256"},{"internalType":"int256","name":"netUsdScore","type":"int256"},{"internalType":"uint256","name":"totalReferralEthClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralUsdtClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralBabyDogeClaimed","type":"uint256"},{"internalType":"uint256","name":"referralCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nativeUsdDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextFreeSpinId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetNative","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"quotaTier1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier2","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier3","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier4","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier5","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier6","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier7","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier8","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier9","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsBabyDoge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsUSDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"setBabyDogePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"cost","type":"uint256"}],"name":"setFreeBetCost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"spinCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"spinFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdtDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];
    
    // ==================================================================
    // 3. GLOBAL STATE (V3)
    // ==================================================================
    let provider, signer, userAddress;
    let faylottoContract, usdtContract, babyDogeContract; // Ditambah babyDogeContract
    let rawEthBalance, rawUsdtBalance, rawBabyDogeBalance; // Ditambah rawBabyDogeBalance
    let rawFreeBalance = ethers.BigNumber.from(0);
    let usdtDecimals = 6, babyDogeDecimals = 18; // Default, akan di-fetch
    let currentRoundId;
    let currentRoundEndTime = 0;
    let visualTimer = null;
    let isSpinning = false;
    let isFinalizing = false;
    let players = {};
    let totalWeight = ethers.BigNumber.from(0);
    let ctx, cw, ch, cx, cy;
    let outerR, innerR, currentRotation = 0;
    let playersArray = [];
    let myCurrentEthDeposit = ethers.BigNumber.from(0);
    let myCurrentUsdtDeposit = ethers.BigNumber.from(0);
    let myCurrentBabyDogeDeposit = ethers.BigNumber.from(0); // Ditambah myCurrentBabyDogeDeposit
    let pendingReferrerNickname = null;
    let currentEthPrice = 0, currentBabyDogePrice = 0; 
    let referralModalTimeout = null; 
    let qrCodeObject = null; 
    let userFreeSpinState = { eligible: false, remaining: 0 }; // Untuk spin gratis
    let listeningContract = null;
    let currentLbTab = 'winners';
    
function getProvider() {
    // Cek apakah user punya wallet (misal MetaMask)
    if (window.ethereum) {
        return new ethers.providers.Web3Provider(window.ethereum);
    } else {
        // Jika tidak, gunakan penyedia publik/pihak ketiga untuk data read-only
        try {
            // Coba WebSocket dulu untuk event real-time yang lebih baik
            return new ethers.providers.WebSocketProvider(WSS_URL);
        } catch (e) {
            console.warn("WSS failed, falling back to HTTP", e);
            // Fallback ke HTTP jika WSS gagal
            return new ethers.providers.JsonRpcProvider(HTTPS_URL);
        }
    }
}

// === ELEMEN DOM (LENGKAP) ===
    // (Gunakan DOMParser untuk keamanan, tapi untuk simplisitas, kita pakai getElementById)
    const walletBtn = document.getElementById("walletBtn");
    const walletInfo = document.getElementById("walletInfo");
    const walletAddress = document.getElementById("walletAddress");
    const ethBalance = document.getElementById("ethBalance");
    const usdtBalance = document.getElementById("usdtBalance");
    const babyDogeBalance = document.getElementById("babyDogeBalance"); // BARU
    const myEthDeposit = document.getElementById("myEthDeposit");
    const myUsdtDeposit = document.getElementById("myUsdtDeposit");
    const myBabyDogeDeposit = document.getElementById("myBabyDogeDeposit"); // BARU
    const statusText = document.getElementById("statusText");
    const timerText = document.getElementById("timerText");
    const placeBetBtn = document.getElementById("placeBetBtn");
    const finalizeBtn = document.getElementById("finalizeBtn");
    const winnerList = document.getElementById("winner-list");
    const winnerListPlaceholder = document.getElementById("winner-list-placeholder");
    const betModalOverlay = document.getElementById("bet-modal-overlay");
    const betModal = document.getElementById("bet-modal");
    const betModalCloseBtn = document.getElementById("bet-modal-close-btn");
    const modalEthBalance = document.getElementById("modalEthBalance");
    const modalUsdtBalance = document.getElementById("modalUsdtBalance");
    const modalBabyDogeBalance = document.getElementById("modalBabyDogeBalance"); // BARU
    const betAmountInput = document.getElementById("betAmountInput");
    const betCurrencySelect = document.getElementById("betCurrencySelect");
    const percentButtons = document.querySelectorAll(".percent-btn");
    const confirmBetBtn = document.getElementById("confirmBetBtn");
    const betList = document.getElementById("bet-list");
    const betListPlaceholder = document.getElementById("bet-list-placeholder");
    const referralBtn = document.getElementById("referralBtn");
    const referralModalOverlay = document.getElementById("referral-modal-overlay");
    const referralModal = document.getElementById("referral-modal");
    const referralModalCloseBtn = document.getElementById("referral-modal-close-btn");
    const myNickname = document.getElementById("myNickname");
    const myReferrer = document.getElementById("myReferrer");
    const nicknameInput = document.getElementById("nicknameInput");
    const createNicknameBtn = document.getElementById("createNicknameBtn");
    const ethRewards = document.getElementById("ethRewards");
    const usdtRewards = document.getElementById("usdtRewards");
    const babyDogeRewards = document.getElementById("babyDogeRewards"); // BARU
    const referralCount = document.getElementById("referralCount");
    const claimRewardsBtn = document.getElementById("claimRewardsBtn");
    const walletModalOverlay = document.getElementById("wallet-modal-overlay");
    const walletModal = document.getElementById("wallet-modal");
    const walletModalCloseBtn = document.getElementById("wallet-modal-close-btn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const leaderboardList = document.getElementById("leaderboard-list");
    

    const PLAYER_COLORS = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#F9D423", "#FFA62B", "#7B72E9", "#3DCC91", "#FF90B3", "#C0E218", "#3498DB"];

// === [BARU] FUNGSI UNTUK GANTI JARINGAN ===
/**
 * Mencoba mengganti jaringan atau menambahkannya jika belum ada.
 */
async function switchOrAddNetwork() {
    try {
        // 1. Coba ganti jaringan dulu
        await provider.send('wallet_switchEthereumChain', [{ chainId: BASE_SEPOLIA_CHAIN_ID }]);
    } catch (switchError) {
        // Error code 4902: Jaringan belum ditambahkan ke MetaMask
        if (switchError.code === 4902) {
            try {
                // 2. [FITUR 1] Jika belum ada, paksa tambahkan RPC
                showStatus("Network not found. Adding Sepolia Base...", "wolf");
                await provider.send('wallet_addEthereumChain', [BASE_SEPOLIA_PARAMS]);
            } catch (addError) {
                console.error("Failed to add network:", addError);
                throw new Error("Failed to add Sepolia Base network.");
            }
        } else {
            console.error("Failed to change network:", switchError);
            throw new Error("Failed to change network. Please check your EVM wallet.");
        }
    }
}

// === [REVISI TOTAL] FUNGSI-FUNGSI WALLET ===

async function toggleWallet(isAutoConnect = false) {
        if (userAddress) return; 
        if (!window.ethereum) return showStatus("Please install MetaMask!", "error");
        
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            
            if (isAutoConnect) {
                const accounts = await provider.listAccounts();
                if (accounts.length === 0) {
                    localStorage.removeItem(AUTO_CONNECT_KEY); 
                    return; 
                }
                signer = provider.getSigner(accounts[0]);
            } else {
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
            }
            
            const network = await provider.getNetwork();
            if (network.chainId.toString() !== '84532' && network.chainId.toString() !== '0x14a34') {
                showStatus("Jaringan salah. Tolong ganti ke Base Sepolia.", "warning");
                // (Anda bisa tambahkan auto-switch di sini)
                return;
            }

            userAddress = await signer.getAddress(); 
            
            if (!isAutoConnect) { 
                const message = `Welcome ${userAddress} (${new Date().toLocaleString()})`;
                try {
                    showStatus("Meminta tanda tangan...", "load");
                    await signer.signMessage(message);
                } catch (signError) {
                    showStatus("Tanda tangan ditolak. Login dibatalkan.", "error");
                    provider = null; signer = null; userAddress = null;
                    return; 
                }
            }
            
            // Init Kontrak V3 dengan Signer
            usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
            // [PERBAIKAN 2] Gunakan USDT_ABI (bukan ERC20_ABI yang tidak ada)
            babyDogeContract = new ethers.Contract(BABYDOGE_ADDRESS, USDT_ABI, signer);
            faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, signer);

            walletBtn.innerText = "Dashboard";
            referralBtn.style.display = "block"; 
            walletAddress.innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
            
            const expiry = new Date().getTime() + AUTO_CONNECT_DURATION;
            localStorage.setItem(AUTO_CONNECT_KEY, expiry.toString());
            
            if (!isAutoConnect) showStatus("Wallet Terhubung!", "success");

            // Load User Data V3
            await updateUserBalances(); 
            await fetchAndDisplayRoundData(); 
            await fetchReferralData(); 
            setupEventListeners(); 

            if (pendingReferrerNickname) {
                 await handlePendingReferral(); 
            }

        } catch (err) {
            console.error("Gagal menghubungkan wallet:", err.message);
            statusText.innerText = "Gagal terhubung.";
            provider = null; signer = null; userAddress = null;
            if (!isAutoConnect) showStatus(err.message, "error");
        }
    }

    function checkAutoConnect() {
        const expiry = localStorage.getItem(AUTO_CONNECT_KEY);
        if (expiry && new Date().getTime() < Number(expiry)) {
            toggleWallet(true);
        }
    }
    
    // --- Helper Harga (V3: Tambah BabyDoge) ---
    async function fetchTokenPrices() {
        try {
            // Kita gunakan Coingecko karena mendukung BabyDoge
            const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum,babydoge-coin&vs_currencies=usd");
            const data = await res.json();
            if (data.ethereum) currentEthPrice = data.ethereum.usd; 
            if (data['babydoge-coin']) currentBabyDogePrice = data['babydoge-coin'].usd;
            console.log(`Prices Fetched: ETH=${currentEthPrice}, BabyDoge=${currentBabyDogePrice}`);
        } catch(e) { 
            console.warn("Price fetch failed", e); 
            currentEthPrice = 3000; // Fallback harga ETH
            currentBabyDogePrice = 0.000000001; // Fallback harga BabyDoge
        }
    }
    
// === FUNGSI UTAMA: Ambil Data Pemenang & Fitur Sosial (V3 DIPERBAIKI) ===
async function fetchAndDisplayWinners() {
    let contractInstance = faylottoContract;
    // Fallback provider jika wallet belum connect
    if (!contractInstance) {
       if (!provider) provider = new ethers.providers.JsonRpcProvider("https://sepolia.base.org");
       contractInstance = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    }
    
    try {
        winnerList.innerHTML = "";
        
        // Ambil 10 pemenang terakhir
        const winnersArray = await contractInstance.getWinners(10); 
        
        if (winnersArray.length === 0) {
            winnerList.appendChild(winnerListPlaceholder);
            return;
        }

        // Ambil decimals token (USDT & BabyDoge)
        let usdtDecimalsWinner = 6; // Default
        let babyDecimalsWinner = 18; // Default
        try { 
            if (usdtContract) usdtDecimalsWinner = await usdtContract.decimals(); 
            if (babyDogeContract) babyDecimalsWinner = await babyDogeContract.decimals();
        } catch (e) { console.log("Decimals fetch warning", e); }

        for (const winner of winnersArray) {
            const winnerId = winner.winnerId.toString();
            const roundId = winner.roundId.toString();
            const winnerAddr = winner.winner;
            
            // [FIX 1] Sesuaikan nama variabel dengan Struct Kontrak V3
            const ethAmtBigNum = winner.rewardETH;
            const usdtAmtBigNum = winner.rewardUSDT;     // DULU: rewardERC20 (Salah)
            const babyDogeAmtBigNum = winner.rewardBabyDoge; // BARU: Tambah BabyDoge

            // Format Angka
            const ethAmt = parseFloat(ethers.utils.formatEther(ethAmtBigNum)).toFixed(4);
            const usdtAmt = parseFloat(ethers.utils.formatUnits(usdtAmtBigNum, usdtDecimalsWinner)).toFixed(2);
            const babyDogeAmt = parseFloat(ethers.utils.formatUnits(babyDogeAmtBigNum, babyDecimalsWinner)).toFixed(0);

            const date = new Date(winner.timestamp.toNumber() * 1000).toLocaleString();
            
            // Logic Nama
            let winnerNickname = null;
            try { winnerNickname = await contractInstance.nicknames(winnerAddr); } catch(e) {}
            const shortId = (winnerAddr.slice(0, 6) + "..." + winnerAddr.slice(-4));
            const displayName = (userAddress && winnerAddr.toLowerCase() === userAddress.toLowerCase()) 
                                ? "You" 
                                : (winnerNickname || shortId);

            const avatarUrl = `https://api.dicebear.com/9.x/bottts/svg?seed=${winnerAddr}&baseColor=f0f4f8&backgroundColor=e0f2f7&mouthColor=ffc0cb&faceColor=a7d9f7&sidesColor=ffd700&size=40`;

            // --- LOGIKA Ikon Aset (Termasuk BabyDoge) ---
            let assetIconsHtml = '';
            const hasEth = ethAmtBigNum.gt(0);
            const hasUsdt = usdtAmtBigNum.gt(0);
            const hasBaby = babyDogeAmtBigNum.gt(0);

            if (hasEth || hasUsdt || hasBaby) {
                assetIconsHtml += '<div class="asset-icon-group">';
                if (hasEth) assetIconsHtml += `<img src="${ETH_LOGO_PATH}" alt="ETH" class="asset-icon">`;
                if (hasUsdt) assetIconsHtml += `<img src="${USDT_LOGO_PATH}" alt="USDT" class="asset-icon">`;
                if (hasBaby) assetIconsHtml += `<img src="${BABYDOGE_LOGO_PATH}" alt="Baby" class="asset-icon">`;
                assetIconsHtml += '</div>';
            }

            // --- AMBIL DATA SOSIAL ---
            let likes = 0, ratingCount = 0, commentCount = 0;
            let isLikedByMe = false, myRating = 0;

            try {
                likes = (await contractInstance.getLikeCount(winnerId)).toNumber();
                ratingCount = (await contractInstance.getRatingCountForWinner(winnerId)).toNumber();
                commentCount = (await contractInstance.getCommentCountForWinner(winnerId)).toNumber();
            } catch (e) {}

            if (userAddress && faylottoContract) { 
                try {
                    const signedContract = faylottoContract.connect(signer);
                    isLikedByMe = await signedContract.liked(winnerId, userAddress);
                    myRating = await signedContract.ratings(winnerId, userAddress);
                } catch (e) {}
            }

            const item = document.createElement("div");
            item.className = "winner-list-item";
          
            item.innerHTML = `
              <div class="winner-main-content">
                  <img src="${avatarUrl}" alt="Avatar" class="winner-avatar-small" onclick="showPlayerProfile('${winnerAddr}')">              

                  <div class="winner-info-text">
                      <div class="winner-id" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span>Round: #${roundId}</span>  
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">        
                            <small style="color: #888; font-size: 10px;">${date}</small>
                            ${assetIconsHtml} 
                        </div>
                     </div>

                      <div style="margin-top: 4px; margin-bottom: 4px; font-weight: bold; font-size:14px; color: var(--cyan-main); cursor: pointer;" 
                           onclick="showPlayerProfile('${winnerAddr}')">
                         Winner: ${displayName}
                      </div><br>

                      <div class="prize-line" style="color: #00dd00; font-weight: bold; font-size:13px;">
                         Prize: 
                         ${hasEth ? ethAmt + ' ETH ' : ''} 
                         ${hasUsdt ? '+ ' + usdtAmt + ' USDT ' : ''}
                         ${hasBaby ? '+ ' + babyDogeAmt + ' BabyDoge' : ''}
                      </div><br>
                  </div>
              </div>

              <div class="winner-social" style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(120,0,255,0.2); display:flex; justify-content:space-between; align-items:center;">
                  <button class="like-btn" style="background:none; border:none; cursor:pointer; color: ${isLikedByMe ? '#ff00e6' : '#888'}; font-size:14px; display:flex; align-items:center; gap:4px;" onclick="toggleLike(${winnerId})">
                    <img src="like.svg" style="width:25px; height:25px; vertical-align:middle;">
                    <span style="color:#ff00e6">Like (${likes})</span>
                  </button>
                  
                  <div style="display:flex; align-items:center; gap:6px;">
                      <div class="rating-stars">
                         ${[5, 4, 3, 2, 1].map(i => `
                            <span class="star-icon ${i <= myRating ? 'active' : ''}" onclick="rateWinner(${winnerId}, ${i})"></span>
                         `).join('')}
                      </div>
                      <span style="font-size: 12px; color: #888;">(${ratingCount})</span>
                  </div>

                  <button class="terminal-btn" id="comm-btn-${winnerId}" 
                        style="background:none; border:none; color:var(--cyan-main); font-size:14px; cursor:pointer; display:flex; align-items:center; gap:5px;" 
                        onclick="toggleComments(${winnerId}, '${winnerAddr}')">
                    <img src="comment.svg" style="width:25px; height:25px; vertical-align:middle;">Log
                    <span>(${commentCount})</span>
                  </button>
              </div>

              <div class="comments-terminal" id="terminal-${winnerId}" style="display: none; margin-top: 10px;">
                  <div class="terminal-header">> Log For Winner: ${winnerAddr.slice(0,10)}...</div>
                  <div class="comments-list"></div>
                  <div class="new-comment-section" style="margin-top: 10px; padding-top: 8px; border-top: 1px dashed rgba(120, 0, 255, 0.2); display: flex; gap: 5px; align-items: center;">
                      <span style="color: var(--cyan-main);">></span>
                      <textarea class="terminal-input" id="new-comment-${winnerId}" placeholder="Transmit data..." rows="1" style="resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
                      <button class="terminal-btn" onclick="submitComment(${winnerId})">[ SEND ]</button>
                  </div>
              </div>
            `;
            winnerList.appendChild(item);
        }
    } catch (err) {
        console.error("Failed fetching winners:", err.message);
        // Tampilkan error di UI agar tidak blank
        winnerList.innerHTML = `<p style="color:red; text-align:center;">Error loading winners: ${err.message}</p>`;
    }
}

// ... (Tidak ada perubahan pada fungsi-fungsi ini) ...
async function toggleLike(winnerId) {
  // 1. Ganti alert() dengan showStatus()
  if (!signer || !faylottoContract) {
    showStatus("Please connect wallet first.", "warning");
    return;
  }
  
  // 2. Tambahkan toast 'load'
  showStatus("Processing Like/Unlike...", "load", 3000); // Tampil 3 detik

  try {
    const tx = await faylottoContract.toggleLikeWinner(winnerId);
    await tx.wait();
    
    // 3. Tambahkan toast 'success' (opsional)
    // showStatus("Like updated!", "success", 3000);
    
    fetchAndDisplayWinners(); // Refresh setelah sukses
  } catch (err) {
    console.error("Like failed:", err);
    
    // 4. Tambahkan toast 'error'
    let userMessage = "Like failed.";
    const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;
    else if (err.code === 'ACTION_REJECTED') userMessage = "Transaction rejected.";
    
    showStatus(userMessage, "error");
  }
}

async function rateWinner(winnerId, stars) {
  // 1. Ganti alert() dengan showStatus()
  if (!signer || !faylottoContract) {
    showStatus("Please connect wallet first.", "warning");
    return;
  }
  
  // 2. Tambahkan toast 'load'
  showStatus("Sending your rating...", "load");

  try {
    const tx = await faylottoContract.rateWinner(winnerId, stars);
    await tx.wait();
    
    // 3. Tambahkan toast 'success'
    showStatus("Rating successfully saved!", "success");
    
    fetchAndDisplayWinners(); // Refresh setelah sukses
  } catch (err) {
    console.error("Rating failed:", err);
    
    // 4. Tambahkan toast 'error'
    let userMessage = "Rating failed.";
    const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;
    else if (err.code === 'ACTION_REJECTED') userMessage = "Transaction rejected.";
    
    showStatus(userMessage, "error");
  }
}

async function submitComment(winnerId) {
  // 1. Ganti alert() dengan showStatus()
  if (!signer) {
    showStatus("Connect wallet first.", "warning");
    return;
  }
  
  const input = document.getElementById(`new-comment-${winnerId}`);
  const text = input.value.trim();
  if (!text) return; // Tidak perlu notifikasi jika hanya kosong

  try {
    input.disabled = true;
    const originalValue = input.value;
    input.value = "Transmitting...";
    
    // 2. Tambahkan toast 'load'
    showStatus("Sending comment...", "load");
    
    const tx = await faylottoContract.addCommentToWinner(winnerId, text);
    await tx.wait();
    
    // 3. Tambahkan toast 'success'
    showStatus("Comment sent!", "success");
    
    input.value = "";
    await fetchAndRenderComments(winnerId); // Refresh
  } catch (err) {
    console.error(err);
    
    // 4. Ganti alert() dengan showStatus() 'error'
    let userMessage = "Failed to send comment.";
    const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;
    else if (err.code === 'ACTION_REJECTED') userMessage = "Transaction rejected.";
    
    showStatus(userMessage, "error");
    
    input.value = originalValue; // Kembalikan teks asli jika gagal
  } finally {
    input.disabled = false;
  }
}

function showEditComment(wid, cid) {
  // ... (Tidak ada perubahan pada fungsi ini, sudah benar) ...
  document.getElementById(`msg-${wid}-${cid}`).style.display = 'none';
  document.getElementById(`edit-btn-${wid}-${cid}`).style.display = 'none';
  document.getElementById(`edit-actions-${wid}-${cid}`).style.display = 'block';
}

function cancelEditComment(wid, cid) {
  // ... (Tidak ada perubahan pada fungsi ini, sudah benar) ...
  document.getElementById(`msg-${wid}-${cid}`).style.display = 'block';
  document.getElementById(`edit-btn-${wid}-${cid}`).style.display = 'inline-block';
  document.getElementById(`edit-actions-${wid}-${cid}`).style.display = 'none';
}

async function saveEditComment(wid, cid) {
  // 1. Tambahkan pengecekan signer
  if (!signer) {
      showStatus("Connect wallet first.", "warning");
      return;
  }
  
  const input = document.getElementById(`edit-input-${wid}-${cid}`);
  const newText = input.value.trim();
  
  // 2. Ganti alert() dengan showStatus()
  if (!newText) {
    showStatus("Comment cannot be empty.", "warning");
    return;
  }

  // 3. Tambahkan toast 'load'
  showStatus("Saving edit...", "load");
  
  try {
    const tx = await faylottoContract.editCommentOnWinner(wid, cid, newText);
    await tx.wait();
    
    // 4. Tambahkan toast 'success'
    showStatus("Comment updated!", "success");
    
    fetchAndRenderComments(wid); // Refresh setelah simpan
  } catch (err) {
    console.error("Edit failed:", err);
    
    // 5. Ganti alert() dengan showStatus() 'error'
    let userMessage = "Failed to edit comment.";
    const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;
    else if (err.code === 'ACTION_REJECTED') userMessage = "Transaction rejected.";
    
    showStatus(userMessage, "error");
  }
  // 'finally' block tidak diperlukan di sini karena
  // 'fetchAndRenderComments' akan menggambar ulang UI
  // dan 'cancelEditComment' akan dipanggil secara manual jika gagal.
}


// [WAJIB ADA] Fungsi untuk mengambil dan merender komentar
async function fetchAndRenderComments(winnerId) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const terminalDiv = document.getElementById(`terminal-${winnerId}`);
    if (!terminalDiv) return;
    const commentsListDiv = terminalDiv.querySelector('.comments-list');
    if (!commentsListDiv) return;
    commentsListDiv.innerHTML = "> Loading Neural Logs...";
    let contractInstance = faylottoContract;
    if (!contractInstance) {
        if (!provider) provider = new ethers.providers.JsonRpcProvider(HTTPS_URL);
        contractInstance = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    }
    try {
        const comments = await contractInstance.getAllCommentsForWinner(winnerId);
        if (comments.length === 0) {
            commentsListDiv.innerHTML = "> No Transmissions Found.";
            const commBtn = document.getElementById(`comm-btn-${winnerId}`);
            if (commBtn) {
                commBtn.innerHTML = `<img src="comment.svg" style="width:20px; height:20px; vertical-align:middle;"> <span>(0)</span>`;
            }
            return;
        }
        commentsListDiv.innerHTML = "";
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < comments.length; i++) {
            const c = comments[i];
            const user = c.user;
            const text = c.text;
            const dateObj = new Date(c.timestamp.toNumber() * 1000);
            const time = dateObj.toLocaleString('id-ID', {
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                day: '2-digit', month: '2-digit', year: 'numeric', hour12: false
            });
            const isMyComment = (userAddress && user.toLowerCase() === userAddress.toLowerCase());
            let nickname = null;
            try { nickname = await contractInstance.nicknames(user); } catch (e) {}
            const displayName = nickname || user.slice(0, 6) + '...';
            const avatarUrl = `https://api.dicebear.com/9.x/bottts/svg?seed=${user}&baseColor=f0f4f8&backgroundColor=e0f2f7&mouthColor=ffc0cb&faceColor=a7d9f7&sidesColor=ffd700&size=40`;
            const commentDiv = document.createElement('div');
            commentDiv.className = "comment-log";
            commentDiv.id = `comment-${winnerId}-${i}`;
            let commentHTML = `
                <img src="${avatarUrl}" alt="Avatar" class="comment-avatar" onclick="showPlayerProfile('${user}')">
                <div class="comment-content">
                    <div class="log-meta">
                        <span class="log-nickname" style="cursor: pointer;" onclick="showPlayerProfile('${user}')">
                            ${displayName}
                        </span>
                        <span class="log-wallet" style="cursor: pointer;" onclick="showPlayerProfile('${user}')">
                            (${user.slice(0, 6)}...${user.slice(-4)})
                        </span><br>[${time}]
                    </div><br>
                    <div class="log-message" id="msg-${winnerId}-${i}">${text}</div><br>
            `;
            if (isMyComment) {
                commentHTML += `
                    <div class="edit-actions" style="display:none; margin-top: 10px;" id="edit-actions-${winnerId}-${i}">
                        <textarea class="terminal-input" id="edit-input-${winnerId}-${i}" rows="2">${text}</textarea>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button class="terminal-btn" onclick="saveEditComment(${winnerId}, ${i})">[ SAVE ]</button>
                            <button class="terminal-btn" style="color:#ff5555;border-color:#ff5555" onclick="cancelEditComment(${winnerId}, ${i})">[ CANCEL ]</button>
                        </div>
                    </div>
                    <button class="terminal-btn" id="edit-btn-${winnerId}-${i}" onclick="showEditComment(${winnerId}, ${i})" style="opacity:0.7; margin-top:5px;">[ EDIT LOG ]</button>
                `;
            }
            commentHTML += `</div>`;
            commentDiv.innerHTML = commentHTML;
            fragment.appendChild(commentDiv);
        }
        commentsListDiv.appendChild(fragment);
        const commBtn = document.getElementById(`comm-btn-${winnerId}`);
        if(commBtn) {
            commBtn.innerHTML = `<img src="comment.svg" style="width:20px; height:20px; vertical-align:middle;"> <span>(${comments.length})</span>`;
        }
    } catch (err) {
        console.error("Error fetching comments:", err);
        commentsListDiv.innerHTML = "> Failed: No Signal.";
    }
}
    
function toggleComments(winnerId, winnerAddr) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const terminal = document.getElementById(`terminal-${winnerId}`);
    if (terminal.style.display === 'none') {
        terminal.style.display = 'block';
        fetchAndRenderComments(winnerId);
    } else {
        terminal.style.display = 'none';
    }
}

// GANTI SELURUH FUNGSI setupEventListeners DENGAN INI:
function setupEventListeners() {
    // 1. Tentukan kontrak mana yang akan dipakai (Wallet Signer atau Provider Read-only)
    // Kita prioritaskan faylottoContract yang aktif, jika tidak ada, buat baru dari provider
    let currentContractSource = faylottoContract;
    if (!currentContractSource) {
         // Jika belum connect wallet, gunakan provider read-only
         const tempProvider = provider || new ethers.providers.JsonRpcProvider(HTTPS_URL);
         currentContractSource = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, tempProvider);
    }

    // 2. MATIKAN Listener Lama (KUNCI PERBAIKAN BUG GANDA)
    // Kita cek variabel global 'listeningContract' bukan lokal
    if (listeningContract) {
        console.log("Deleting old listeners...");
        listeningContract.removeAllListeners(); 
    }

    // 3. Update variabel global dengan kontrak sumber yang baru
    listeningContract = currentContractSource;

    if (!listeningContract) return; 
    
    console.log("Installing a new listener...");

    // 4. Pasang Listener pada 'listeningContract' (bukan contractToListen lokal lagi)

    // A. Listener ETH (Native)
    listeningContract.on("BetNative", (roundId, player, amount, usdWeight) => {
        if (currentRoundId && roundId.eq(currentRoundId)) {
            addBetToState(player, amount, ethers.BigNumber.from(0), ethers.BigNumber.from(0), ethers.BigNumber.from(0), usdWeight, true);
            // Tidak perlu panggil updateBetList() disini karena addBetToState sudah melakukannya (isRealtime = true)
            if(statusText) statusText.innerText = "New ETH Bet detected!";
        }
    });

    // B. Listener USDT
    listeningContract.on("BetUSDT", (roundId, player, amount, usdWeight) => {
        if (currentRoundId && roundId.eq(currentRoundId)) {
            addBetToState(player, ethers.BigNumber.from(0), amount, ethers.BigNumber.from(0), ethers.BigNumber.from(0), usdWeight, true);
            if(statusText) statusText.innerText = "New USDT Bet detected!";
        }
    });

    // C. Listener BabyDoge
    listeningContract.on("BetBabyDoge", (roundId, player, amount, usdWeight) => {
        if (currentRoundId && roundId.eq(currentRoundId)) {
            addBetToState(player, ethers.BigNumber.from(0), ethers.BigNumber.from(0), amount, ethers.BigNumber.from(0), usdWeight, true);
            if(statusText) statusText.innerText = "New BabyDoge Bet detected!";
        }
    });
    
    // D. Listener Free Bet
    listeningContract.on("BetFree", (roundId, player, amount) => {
        if (currentRoundId && roundId.eq(currentRoundId)) {
            addBetToState(player, ethers.BigNumber.from(0), ethers.BigNumber.from(0), ethers.BigNumber.from(0), amount, ethers.BigNumber.from(0), true);
            if(statusText) statusText.innerText = "New Free Bet detected!";
        }
    });

    // E. Listener Pemenang
    listeningContract.on("WinnerRecorded", (winnerId, roundId, winner) => {
        if (currentRoundId && roundId.eq(currentRoundId) && !isSpinning) {
             console.log("Winner Event Received:", winner);
             handleRoundFinalized(roundId, winner);
        }
    });
}
    

    // [BARU] Fungsi untuk update HTML daftar bet & menggambar ulang wheel (Versi V3)
function updateBetList() {
    if (Object.keys(players).length === 0) {
        betList.innerHTML = "";
        betList.appendChild(betListPlaceholder);
        rebuildPlayersArrayAndDraw(); 
        return;
    }

    betList.innerHTML = "";
    playersArray = [];
    totalWeight = ethers.BigNumber.from(0); 

    for (const key in players) {
        playersArray.push({
            addr: players[key].id,
            weight: players[key].weight,
            color: players[key].color,
            eth: players[key].eth,
            usdt: players[key].usdt,
            baby: players[key].baby,
            free: players[key].free // [BARU] Masukkan free ke array
        });
        totalWeight = totalWeight.add(players[key].weight);
    }
    
    playersArray.sort((a, b) => b.weight.sub(a.weight).gt(0) ? 1 : -1);

    const fragment = document.createDocumentFragment();
    for (const p of playersArray) {
        const player = p.addr;
        const shortId = (userAddress && player.toLowerCase() === userAddress.toLowerCase()) 
                        ? "You" 
                        : (player.slice(0, 6) + "..." + player.slice(-4));
        
        const item = document.createElement("div");
        item.className = "bet-list-item";
        item.style.borderLeft = `3px solid ${p.color}`;
        
        // Format jumlah
        const ethStr = parseFloat(ethers.utils.formatEther(p.eth)).toFixed(4);
        const usdtStr = parseFloat(ethers.utils.formatUnits(p.usdt, usdtDecimals)).toFixed(2);
        const babyStr = parseFloat(ethers.utils.formatUnits(p.baby, babyDogeDecimals)).toFixed(0);
        const freeStr = parseFloat(ethers.utils.formatUnits(p.free, babyDogeDecimals)).toFixed(0); // [BARU]

        // [PERMINTAAN ANDA] Update HTML di sini
        let depositsHTML = "";
        if (p.eth.gt(0)) depositsHTML += `<span>${ethStr} ETH</span><br>`;
        if (p.usdt.gt(0)) depositsHTML += `<span>${usdtStr} USDT</span><br>`;
        if (p.baby.gt(0)) depositsHTML += `<span>${babyStr} BabyDoge</span><br>`;
        // Tampilkan Free Balance dengan warna berbeda (misal hijau neon)
        if (p.free.gt(0)) depositsHTML += `<span style="color:#00ff88;">${freeStr} Free BabyDoge</span>`; 

        item.innerHTML = `
            <div class="player-id" style="cursor:pointer;" onclick="showPlayerProfile('${player}')">${shortId}</div>
            <div class="player-bets">${depositsHTML || '<span style="color:#888;">No Deposit</span>'}</div>
        `;
        fragment.appendChild(item);
    }
    betList.appendChild(fragment);
    rebuildPlayersArrayAndDraw();
}

    // *** FUNGSI PENTING YANG SEBELUMNYA HILANG ***
    function addBetToState(player, eth, usdt, baby, free, weight, isRealtime) {
        const key = player.toLowerCase();
        
        if (!players[key]) {
            players[key] = {
                id: player,
                eth: ethers.BigNumber.from(0),
                usdt: ethers.BigNumber.from(0),
                baby: ethers.BigNumber.from(0),
                free: ethers.BigNumber.from(0),
                weight: ethers.BigNumber.from(0),
                color: PLAYER_COLORS[Object.keys(players).length % PLAYER_COLORS.length]
            };
        }

        // Akumulasi nilai
        players[key].eth = players[key].eth.add(eth);
        players[key].usdt = players[key].usdt.add(usdt);
        players[key].baby = players[key].baby.add(baby);
        players[key].free = players[key].free.add(free);
        players[key].weight = players[key].weight.add(weight);

        // Jika realtime, kita update UI langsung
        if (isRealtime) updateBetList();
    }

    async function fetchAndDisplayRoundData() {
        let contract = faylottoContract || new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
        if (!contract || isSpinning) return;

        try {
            const latestRoundId = await contract.currentRoundId();
            
            if (currentRoundId && !latestRoundId.eq(currentRoundId)) {
                resetRoundUI(); 
            }
            currentRoundId = latestRoundId;
            
            // [id, start, end, finalized, winner, eth, usdt, baby, playerCount, weight]
            const roundInfo = await contract.getRoundBasic(currentRoundId);

            // Sync Players jika jumlah berbeda
            const onChainCount = roundInfo[8].toNumber(); // index 8 is playerCount in V4/V3
            if (Object.keys(players).length !== onChainCount) {
                const playersList = await contract.getRoundPlayers(currentRoundId);
                players = {}; 
                
                for (const pAddr of playersList) {
                    // [eth, usdt, baby, weight]
                    const d = await contract.getPlayerDeposits(currentRoundId, pAddr);
                    // Catatan: Smart contract menggabungkan Free & Real BabyDoge di index 2
                    // Kita masukkan ke 'baby' di state, 'free' dibiarkan 0 untuk data lama (karena sulit dipisah via view function ini)
                    addBetToState(pAddr, d[0], d[1], d[2], ethers.BigNumber.from(0), d[3], false);
                }
                updateBetList();
            }

            updateMyDeposits();

            // Timer Logic
            const endTime = roundInfo[2].toNumber() * 1000;
            const isFinalized = roundInfo[3];
            
            if (visualTimer) clearInterval(visualTimer);
            
            if (isFinalized) {
                document.getElementById("statusText").innerText = "Round Finalized. Waiting new round...";
                setTimeout(fetchAndDisplayRoundData, 3000);
            } else if (Date.now() < endTime) {
                document.getElementById("statusText").innerText = `Round #${currentRoundId} Live!`;
                const btn = document.getElementById("placeBetBtn");
            btn.style.display = "block";
              btn.disabled = false;
                document.getElementById("finalizeBtn").style.display = "none";
                startVisualTimer(endTime);
            } else {
                document.getElementById("statusText").innerText = "Round Ended!";
                document.getElementById("timerText").innerText = "00:00";
                document.getElementById("placeBetBtn").style.display = "none";
                document.getElementById("finalizeBtn").style.display = "block";
                isFinalizing = true;
            }

        } catch (e) { console.error("Sync Error", e); }
    }

    

// === FUNGSI UTAMA: Handle Finalisasi ===
async function handleRoundFinalized(roundId, winnerAddr) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    if (isSpinning) return;
    isSpinning = true;
    isFinalizing = true;
    placeBetBtn.style.display = "none";
    finalizeBtn.style.display = "none";
    if (visualTimer) clearInterval(visualTimer);
    timerText.innerText = "WINNER!";
    statusText.innerText = "Spinning to the winner...";
    playSound('sfx-spin');
    await new Promise(resolve => setTimeout(resolve, 1000));
    const targetPlayer = playersArray.find(p => p.addr.toLowerCase() === winnerAddr.toLowerCase());
    if (!targetPlayer) {
        console.error("Winner not found in local playersArray!");
        resetAndFetchNewRound();
        return;
    }
    await spinToPlayer(targetPlayer); 
}
  
// GANTI FUNGSI LAMA DENGAN INI
async function resetAndFetchNewRound() {
    console.log("Resetting for new round...");
    
    // 1. Reset Status
    isSpinning = false;
    isFinalizing = false;
    
    // 2. Bersihkan Data Lokal
    resetRoundUI(); // Ini akan mengosongkan players dan playersArray
    
    // 3. Reset Tampilan Tombol
    document.getElementById("finalizeBtn").style.display = "none";
    document.getElementById("placeBetBtn").style.display = "block";
    document.getElementById("placeBetBtn").disabled = true; // Matikan dulu sampai data termuat
    document.getElementById("statusText").innerText = "Loading new round...";

    // 4. Beri jeda, lalu fetch data baru
    await new Promise(resolve => setTimeout(resolve, 3000)); 
    
    // Fetch pemenang terbaru (untuk list riwayat)
    fetchAndDisplayWinners().catch(e => console.log("Winner list sync err", e));
    
    // Fetch data ronde baru (Jantung utama)
    fetchAndDisplayRoundData();
}


// GANTI FUNGSI LAMA ANDA DENGAN YANG INI
async function callFinalizeRound() {
    if (!signer || !faylottoContract) {
        showStatus("Please connect your wallet.", "warning");
        return;
    }
    
    // 1. Tombol "SPIN NOW!" dinonaktifkan saat mengirim
    finalizeBtn.disabled = true;
    statusText.innerText = "Sending finalization transaction...";
    showStatus("Sending finalization transaction...", "load");

    try {
        const tx = await faylottoContract.finalizeRound(currentRoundId);
        
        statusText.innerText = "Finalizing... awaiting confirmation.";
        showStatus("Finalizing... awaiting confirmation.", "load", 15000); 

        const receipt = await tx.wait(); 
        
        showStatus("Round finalized successfully!", "success", 10000); 

        console.log("Finalize transaction confirmed.", receipt);
        const event = receipt.events?.find(e => e.event === 'WinnerRecorded');
        
        if (event) {
            const roundId = event.args[1]; 
            const winnerAddr = event.args[2];
            console.log(`Winner found: ${winnerAddr} for Round ${roundId}`);
            if (!isSpinning) {
                handleRoundFinalized(roundId, winnerAddr);
            }
        } else {
            console.log("Round was empty. Resetting...");
            if (!isSpinning) {
                resetAndFetchNewRound();
            }
        }
    } catch (err) {
        console.error("Finalize failed:", err);
        
        let userMessage = "Finalization failed.";
        const reason = err.reason || (err.data ? faylottoContract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
        if (reason) {
            userMessage = `Error: ${reason.substring(0, 100)}`;
        } else if (err.code === 'ACTION_REJECTED') {
            userMessage = "Transaction rejected by user.";
        }
        showStatus(userMessage, "error");
        
        // [PERBAIKAN DIMULAI DI SINI]
        // Ini adalah perbaikan untuk bug "Finalization Failed"
        
        // 1. Atur teks status
        statusText.innerText = "Finalization failed. Please try again.";
        
        // 2. Sembunyikan tombol "PLACE BET" (yang seharusnya tidak muncul)
        placeBetBtn.style.display = "none";
            
        // 3. Tampilkan dan aktifkan kembali tombol "SPIN NOW!"
        finalizeBtn.style.display = "block";
        finalizeBtn.disabled = false;
        finalizeBtn.innerText = "SPIN NOW!"; // Pastikan teksnya benar
            
        // 4. Reset flag 'isFinalizing' agar tombol bisa ditekan lagi
        isFinalizing = false;
        // [PERBAIKAN SELESAI]
    }
}
    
// --- (Modal Bet V3: Tambah BabyDoge) ---
function showBetModal() {
  if (!signer) return showStatus("Connect wallet first!", "error");
  if (isFinalizing) return showStatus("Round is ending, new bets are closed.", "warning"); 
  
  modalEthBalance.innerText = parseFloat(ethers.utils.formatEther(rawEthBalance || 0)).toFixed(5);
  modalUsdtBalance.innerText = parseFloat(ethers.utils.formatUnits(rawUsdtBalance || 0, usdtDecimals)).toFixed(2);
  modalBabyDogeBalance.innerText = parseFloat(ethers.utils.formatUnits(rawBabyDogeBalance || 0, babyDogeDecimals)).toFixed(2);

  // LOGIKA BARU UNTUK MENAMPILKAN SALDO GRATIS
  const modalFreeBalanceEl = document.getElementById("modalFreeBalance");
  if (modalFreeBalanceEl) {
      // 'prizeAmount' disimpan dalam 18 desimal (seperti ETH), jadi kita format
      modalFreeBalanceEl.innerText = parseFloat(ethers.utils.formatEther(rawFreeBalance || 0)).toFixed(0);
  }

  betAmountInput.value = "";
  
  // Reset tampilan jika sebelumnya memilih FREE
  document.querySelector('.input-icon-wrapper[style*="flex-grow"]').style.display = 'flex';
  document.querySelector('.percent-buttons').style.display = 'flex';
  betCurrencySelect.value = "ETH"; // Default ke ETH
  document.getElementById('currency-icon').src = "eth.svg";


  betModalOverlay.classList.add("show");
  betModal.classList.add("show");
}


function hideBetModal() {
      betModalOverlay.classList.remove("show");
      betModal.classList.remove("show");
    }

// --- (Persentase V3: Tambah BabyDoge) ---
function setAmountByPercent(percent) {
    const currency = betCurrencySelect.value;
    let min, max, decimalsToDisplay, userBalanceBN;
    let decimals = 18; // Default

    // 1. Tentukan Limit & Saldo berdasarkan Currency
    if (currency === 'ETH') {
        userBalanceBN = rawEthBalance || ethers.BigNumber.from(0);
        decimalsToDisplay = 8; // Tampilkan lebih presisi untuk ETH
        min = "0.00005"; 
        max = "0.00265"; 
        decimals = 18;
    } else if (currency === 'USDT') {
        userBalanceBN = rawUsdtBalance || ethers.BigNumber.from(0);
        decimalsToDisplay = 2;
        min = "0.5"; 
        max = "10.0"; 
        decimals = usdtDecimals;
    } else if (currency === 'BABYDOGE') {
        userBalanceBN = rawBabyDogeBalance || ethers.BigNumber.from(0);
        decimalsToDisplay = 0;
        min = "1000000"; 
        max = "10000000000"; 
        decimals = babyDogeDecimals;
    } else if (currency === 'FREE') {
        userBalanceBN = rawFreeBalance || ethers.BigNumber.from(0);
        decimalsToDisplay = 0;
        min = "500000"; 
        max = "10000000000"; 
        decimals = 18; // Asumsi Free pakai 18 desimal
    } else {
        return; 
    }

    // Konversi min/max string ke BigNumber
    const minBN = ethers.utils.parseUnits(min, decimals);
    const maxBN = ethers.utils.parseUnits(max, decimals);

    let amountToSetBN;

    // 2. LOGIKA PERBAIKAN UTAMA DI SINI
    if (percent === 0.10) { 
        // Jika tombol MIN ditekan, langsung set ke Minimum Bet (bukan 10%)
        amountToSetBN = minBN;
    } else {
        // Tentukan "Base Calculation" (Dasar Perhitungan)
        // Jika Saldo User > Max Cap, maka hitung % dari Max Cap.
        // Jika Saldo User < Max Cap, maka hitung % dari Saldo User.
        let calculationBase = userBalanceBN.lt(maxBN) ? userBalanceBN : maxBN;

        if (percent === 1.00) {
            amountToSetBN = calculationBase;
        } else {
            // Hitung persentase dari calculationBase
            // Contoh: 75% -> (Base * 75) / 100
            amountToSetBN = calculationBase.mul(Math.floor(percent * 100)).div(100);
        }
    }

    // 3. Validasi Akhir
    // Jangan biarkan kurang dari Minimum Bet (kecuali saldonya emang 0)
    if (amountToSetBN.lt(minBN) && userBalanceBN.gte(minBN)) {
        amountToSetBN = minBN;
    }
    // Jangan biarkan lebih dari Max Bet (safety check)
    if (amountToSetBN.gt(maxBN)) {
        amountToSetBN = maxBN;
    }
    // Jangan biarkan melebihi saldo user
    if (amountToSetBN.gt(userBalanceBN)) {
        amountToSetBN = userBalanceBN;
    }

    // 4. Tampilkan ke Input
    const formattedAmount = ethers.utils.formatUnits(amountToSetBN, decimals);
    
    // Trik: Hapus desimal berlebih biar tidak error di UI (misal 1.00000000)
    // Parse float dulu baru toFixed sesuai mata uang
    betAmountInput.value = parseFloat(formattedAmount).toFixed(decimalsToDisplay);
}

// GANTI FUNGSI LAMA DENGAN INI
async function confirmBet() {
    const amt = betAmountInput.value;
    const cur = betCurrencySelect.value;
    if (!amt || parseFloat(amt) <= 0) return showStatus("Invalid amount", "warning");

    confirmBetBtn.disabled = true; confirmBetBtn.innerText = "Processing...";
    showStatus("Sending transaction...", "load");

    try {
        let tx;
        if (cur === 'ETH') {
            tx = await faylottoContract.placeBetNative({value: ethers.utils.parseEther(amt)});
        } else if (cur === 'USDT') {
            const wei = ethers.utils.parseUnits(amt, usdtDecimals);
            const allow = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
            if (allow.lt(wei)) { 
                const atx = await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256); await atx.wait(); 
            }
            tx = await faylottoContract.placeBetUSDT(wei);
        } else if (cur === 'BABYDOGE') {
            const wei = ethers.utils.parseUnits(amt, babyDogeDecimals);
            const allow = await babyDogeContract.allowance(userAddress, FAYLOTTO_ADDRESS);
            if (allow.lt(wei)) { 
                const atx = await babyDogeContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256); await atx.wait(); 
            }
            tx = await faylottoContract.placeBetBabyDoge(wei);
        } else if (cur === 'FREE') {
            const wei = ethers.utils.parseUnits(amt, babyDogeDecimals);
            showStatus("Using Free Balance...", "info");
            tx = await faylottoContract.placeBetFree(wei);
        }
        
        showStatus("Transaction Sent! Waiting...", "load", 10000);
        await tx.wait();
        
        playSound('sfx-coin');
        showStatus("Bet Confirmed!", "success");
        
        // 1. Tutup Modal segera
        hideBetModal();
        
        // 2. Update Saldo
        updateUserBalances();

        // 3. Refresh Data Ronde (Tunggu sebentar agar RPC sync)
        setTimeout(fetchAndDisplayRoundData, 2000);

    } catch (e) {
        console.error(e);
        let msg = e.reason || e.message || "Error";
        if (msg.includes("Not enough free balance")) msg = "Saldo Free tidak cukup!";
        showStatus("Failed: " + msg.slice(0,50), "error");
    } finally {
        confirmBetBtn.disabled = false; confirmBetBtn.innerText = "Confirm Bet";
    }
}

    
    // freebet
async function placeBetFree() {
  return faylottoContract.placeBetFree();
}


// --- (Helper Betting V3: Fungsi Baru) ---
    async function placeBetNative(amountStr) {
      const amountWei = ethers.utils.parseEther(amountStr);
      // Validasi Frontend (Opsional)
      if (amountWei.gt(rawEthBalance || 0)) throw new Error("Insufficient ETH balance.");
      // ...
      return faylottoContract.placeBetNative({ value: amountWei });
    }
      
    async function placeBetUSDT(amountStr) {
      const amountUsdt = ethers.utils.parseUnits(amountStr, usdtDecimals);
      if (amountUsdt.gt(rawUsdtBalance || 0)) throw new Error("Insufficient USDT balance.");
      
      const currentAllowance = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
      if (currentAllowance.lt(amountUsdt)) {
        showStatus("Approval needed. Please approve USDT...", "info", 10000); 
        statusText.innerText = "Need approval. Please approve USDT...";
        const approveTx = await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256); // v5
        showStatus("Confirming approval...", "load", 10000); 
        statusText.innerText = "Confirming approval...";
        await approveTx.wait();
        showStatus("Approval successful! Placing bet...", "success");
        statusText.innerText = "Approval successful! Placing bet...";
      }
      return faylottoContract.placeBetUSDT(amountUsdt);
    }
    
    async function placeBetBabyDoge(amountStr) {
        const amountBaby = ethers.utils.parseUnits(amountStr, babyDogeDecimals);
        if (amountBaby.gt(rawBabyDogeBalance || 0)) throw new Error("Insufficient BabyDoge balance.");

        const currentAllowance = await babyDogeContract.allowance(userAddress, FAYLOTTO_ADDRESS);
        if (currentAllowance.lt(amountBaby)) {
            showStatus("Approval needed for BabyDoge...", "info", 10000);
            statusText.innerText = "Need approval. Please approve BabyDoge...";
            const approveTx = await babyDogeContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
            showStatus("Confirming approval...", "load", 10000);
            statusText.innerText = "Confirming approval...";
            await approveTx.wait();
            showStatus("Approval successful! Placing bet...", "success");
            statusText.innerText = "Approval successful! Placing bet...";
        }
        return faylottoContract.placeBetBabyDoge(amountBaby);
    }

// --- (FUNGSI REFERRAL V3: Tambah BabyDoge) ---
    
    async function showReferralModal() {
        if (!signer) return showStatus("Connect wallet first!", "warning");
        await fetchReferralData(); 
        referralModalOverlay.classList.add("show");
        referralModal.classList.add("show");
    }
    function hideReferralModal() {
      referralModalOverlay.classList.remove("show");
      referralModal.classList.remove("show");
    }

    async function fetchReferralData() {
        if (!faylottoContract || !userAddress) return;
        try {
            if (!usdtDecimals) usdtDecimals = await usdtContract.decimals();
            if (!babyDogeDecimals) babyDogeDecimals = await babyDogeContract.decimals(); 

            const nick = await faylottoContract.nicknames(userAddress);
            const referrer = await faylottoContract.referrerOf(userAddress);
            const rewards = await faylottoContract.getReferralRewards(userAddress);
            const count = await faylottoContract.getReferralCount(userAddress);
            
            updateReferralUI(nick, referrer, rewards.ethReward, rewards.usdtReward, rewards.babyDogeReward, count);
        } catch (err) {
            console.error("Failed fetching referral data:", err);
            showStatus("Failed to load your referral data.", "error");
        }
    }

    function updateReferralUI(nick, referrer, ethReward, usdtReward, babyDogeReward, count) {
        myNickname.innerText = nick || "-";
        const linkSection = document.getElementById("referralLinkSection");
        const linkInput = document.getElementById("referralLinkInput");
        if (nick) {
            linkSection.style.display = "block";
            linkInput.value = `${window.location.origin}${window.location.pathname}?ref=${nick}`;
        } else {
            linkSection.style.display = "none";
        }
        
        if (referrer === ethers.constants.AddressZero) {
            myReferrer.innerText = pendingReferrerNickname ? `Pending (${pendingReferrerNickname})` : "-";
            // if (setReferrerSection) setReferrerSection.style.display = "block"; 
        } else {
            myReferrer.innerText = referrer.slice(0, 6) + "..." + referrer.slice(-4);
            // if (setReferrerSection) setReferrerSection.style.display = "none"; 
        }
        
        ethRewards.innerText = parseFloat(ethers.utils.formatEther(ethReward)).toFixed(6);
        usdtRewards.innerText = parseFloat(ethers.utils.formatUnits(usdtReward, usdtDecimals)).toFixed(2);
        babyDogeRewards.innerText = parseFloat(ethers.utils.formatUnits(babyDogeReward, babyDogeDecimals)).toFixed(0); 
        
        referralCount.innerText = count.toString();
        
        if (ethReward.gt(0) || usdtReward.gt(0) || babyDogeReward.gt(0)) { // V3
            claimRewardsBtn.disabled = false;
        } else {
            claimRewardsBtn.disabled = true;
        }
    }

    async function callCreateNickname() {
        const nick = nicknameInput.value;
        if (!nick || nick.length < 3) return showStatus("Nickname must be at least 3 characters.", "warning");
        createNicknameBtn.disabled = true;
        createNicknameBtn.innerText = "Processing...";
        showStatus("Sending transaction...", "load");
        try {
            const tx = await faylottoContract.createNickname(nick);
            await tx.wait();
            showStatus("Nickname created/updated successfully!", "success");
            await fetchReferralData(); 
        } catch (err) {
            console.error("Failed creating nickname:", err.message);
            const reason = err.reason || (err.data ? faylottoContract.interface.parseError(err.data)?.args[0] : null) || err.message;
            showStatus(`Failed: ${reason.substring(0, 100)}`, "error");
        } finally {
            createNicknameBtn.disabled = false;
            createNicknameBtn.innerText = "Create";
        }
    }
        
    async function handlePendingReferral() {
      const refCode = pendingReferrerNickname;
      if (!refCode || !faylottoContract || !userAddress) return;
      try {
        const info = await faylottoContract.referrerOf(userAddress);
        if (info !== ethers.constants.AddressZero) {
          console.log('Anda sudah memiliki inviter.');
          pendingReferrerNickname = null; // Hapus pending
          return;
        }
        
        // Tampilkan modal kustom
        showReferralConfirm(refCode);

      } catch (err) {
        console.error("Gagal mendaftar referral:", err);
        const reason = err.reason || (err.data ? faylottoContract.interface.parseError(err.data)?.args[0] : null) || err.message;
        showStatus(`Gagal mendaftar: ${reason.substring(0, 100)}`, "error");
      }
    }

    async function callClaimRewards() {
        claimRewardsBtn.disabled = true;
        claimRewardsBtn.innerText = "Claiming...";
        showStatus("Processing claim transaction...", "load");
        try {
            const tx = await faylottoContract.claimReferralRewards();
            claimRewardsBtn.innerText = "Confirming...";
            await tx.wait();
            showStatus("Rewards claimed successfully!", "success");
            await fetchReferralData(); 
            await updateUserBalances(); 
        } catch (err) {
            console.error("Error claiming rewards:", err.message);
            let userMessage = "Failed to claim rewards.";
            const reason = err.reason || (err.data ? faylottoContract.interface.parseError(err.data)?.args[0] : null) || err.message;
            if (reason && reason.includes("no referral rewards")) {
                userMessage = "You have no rewards to claim.";
            }
            showStatus(userMessage, "error");
        } finally {
            claimRewardsBtn.innerText = "Claim Rewards";
            claimRewardsBtn.disabled = false; 
        }
    }

    
// --- (Update Saldo V3: Tambah BabyDoge DAN Saldo Gratis) ---
async function updateUserBalances() {
  if (!provider || !userAddress) return;
  try {
    rawEthBalance = await provider.getBalance(userAddress);
    ethBalance.innerText = parseFloat(ethers.utils.formatEther(rawEthBalance)).toFixed(5);
    modalEthBalance.innerText = parseFloat(ethers.utils.formatEther(rawEthBalance)).toFixed(5);
    
    if (usdtContract) {
        usdtDecimals = await usdtContract.decimals();
        rawUsdtBalance = await usdtContract.balanceOf(userAddress);
        usdtBalance.innerText = parseFloat(ethers.utils.formatUnits(rawUsdtBalance, usdtDecimals)).toFixed(2);
        modalUsdtBalance.innerText = parseFloat(ethers.utils.formatUnits(rawUsdtBalance, usdtDecimals)).toFixed(2);
    }
    if (babyDogeContract) {
        babyDogeDecimals = await babyDogeContract.decimals();
        rawBabyDogeBalance = await babyDogeContract.balanceOf(userAddress);
        babyDogeBalance.innerText = parseFloat(ethers.utils.formatUnits(rawBabyDogeBalance, babyDogeDecimals)).toFixed(2);
        modalBabyDogeBalance.innerText = parseFloat(ethers.utils.formatUnits(rawBabyDogeBalance, babyDogeDecimals)).toFixed(2);
    }

    if (faylottoContract) {
        const freeBalanceEl = document.getElementById("freeBalance"); // Ambil elemen modal wallet
        
        // Ambil saldo gratis dari kontrak
        const rawFreeBalanceBN = await faylottoContract.freeBalances(userAddress);
        
        // Simpan ke variabel global
        rawFreeBalance = rawFreeBalanceBN; 
        
        if (freeBalanceEl) {
            // Tampilkan di modal wallet
            const formattedFree = parseFloat(ethers.utils.formatEther(rawFreeBalanceBN)).toFixed(0); 
            freeBalanceEl.innerText = formattedFree;
        }
    }
  } catch (err) { 
    console.error("Failed fetching balances:", err.message);
    showStatus("Failed to fetch balances.", "error");
  }
}


    // --- (Update Deposit V3: Tambah BabyDoge) ---
async function updateMyDeposits() {
    if (!faylottoContract || !currentRoundId || !userAddress) {
        document.getElementById("myEthDeposit").innerText = "0";
        document.getElementById("myUsdtDeposit").innerText = "0";
        document.getElementById("myBabyDogeDeposit").innerText = "0";
        document.getElementById("myFreeDeposit").innerText = "0";
        return;
    }

    try {
        // 1. Ambil data deposit asli dari kontrak
        const d = await faylottoContract.getPlayerDeposits(currentRoundId, userAddress);
        document.getElementById("myEthDeposit").innerText = parseFloat(ethers.utils.formatEther(d.ethAmount)).toFixed(5);
        document.getElementById("myUsdtDeposit").innerText = parseFloat(ethers.utils.formatUnits(d.usdtAmount, usdtDecimals)).toFixed(2);
        document.getElementById("myBabyDogeDeposit").innerText = parseFloat(ethers.utils.formatUnits(d.babyDogeAmount, babyDogeDecimals)).toFixed(0);

        // 2. [BARU] Ambil data deposit FREE dari state lokal 'players'
        // (Karena 'getPlayerDeposits' di kontrak belum return free amount)
        const key = userAddress.toLowerCase();
        if (players[key] && players[key].free) {
            const freeFmt = parseFloat(ethers.utils.formatUnits(players[key].free, babyDogeDecimals)).toFixed(0);
            document.getElementById("myFreeDeposit").innerText = freeFmt;
        } else {
            document.getElementById("myFreeDeposit").innerText = "0";
        }

    } catch(e) {
        console.error("Error update deposits", e);
    }
}

  function startVisualTimer(endTime) {
  // ... (Tidak ada perubahan pada fungsi ini) ...
  if (visualTimer) clearInterval(visualTimer);
  visualTimer = setInterval(() => {
    const now = Date.now();
    const timeLeft = endTime - now;
    if (timeLeft <= 0) {
      clearInterval(visualTimer);
      timerText.innerText = "00:00";
      showFinalizeButton(); 
      return;
    }
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    timerText.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }, 1000);
  }
  
function showFinalizeButton() {
    // [FIX] Baris 'if (isFinalizing) return;' dihapus dari sini.
    // isFinalizing sudah di-set ke 'true' SEBELUM fungsi ini dipanggil.
    
    isFinalizing = true; // Kita tetap set di sini untuk jaga-jaga
    const playerCount = Object.keys(players).length;
    
    if (playerCount > 0) {
        statusText.innerText = "Round Ended! Click 'Finalize' to pick a winner.";
        finalizeBtn.innerText = "Finalize Round"; 
    } else {
        statusText.innerText = "Round Ended! Click 'Start Now' to begin a new round.";
        finalizeBtn.innerText = "Start Round"; 
    }
    
    placeBetBtn.disabled = true;
    placeBetBtn.style.display = "none";
    finalizeBtn.style.display = "block";
    finalizeBtn.disabled = false;
}

  function resetRoundUI() {
        players = {};
        totalWeight = ethers.BigNumber.from(0);
        playersArray = []; 
        if (ctx) {
            currentRotation = 0;
            drawDonut(); 
        }
        updateBetList();
        
        // Reset tampilan pool
        const poolUsdValue = document.getElementById('pool-usd-value');
        if (poolUsdValue) poolUsdValue.innerText = "$...";
        
        const poolEthTotal = document.getElementById('pool-eth-total');
        if (poolEthTotal) poolEthTotal.innerText = "... ETH";
        
        const poolUsdtTotal = document.getElementById('pool-usdt-total');
        if (poolUsdtTotal) poolUsdtTotal.innerText = "... USDT";
        
        placeBetBtn.style.display = "block";
        placeBetBtn.disabled = true;
        finalizeBtn.style.display = "none";
        finalizeBtn.innerText = "Finalize Round"; 
        if(myEthDeposit) myEthDeposit.innerText = "0";
        if(myUsdtDeposit) myUsdtDeposit.innerText = "0";
        if(myBabyDogeDeposit) myBabyDogeDeposit.innerText = "0";
    }
    // [FIX 2] Fungsi drawDonut di-upgrade untuk menampilkan teks
   function drawDonut(rotationDeg = currentRotation) {
    if (!ctx) return;

    // Bersihkan seluruh area canvas (Gunakan cw dan ch asli)
    ctx.clearRect(0, 0, cw, ch);

    ctx.save();
    
    // [FIX 1] Pindahkan titik pusat ke tengah (cx, cy)
    ctx.translate(cx, cy);
    
    // [FIX 2] Terapkan rotasi
    ctx.rotate(rotationDeg * Math.PI / 180);
    
    // [FIX 3] JANGAN translate kembali ke (0,0). 
    // Sekarang, (0,0) adalah titik tengah canvas.

    // Jika tidak ada player, gambar wheel default
    if (!playersArray || playersArray.length === 0) {
        // Gambar gradien dari (0,0) [titik tengah baru]
        const gradient = ctx.createRadialGradient(0, 0, innerR, 0, 0, outerR); 
        gradient.addColorStop(0, '#ff00e6');    // Pink
        gradient.addColorStop(0.7, '#6200ff');  // Ungu
        gradient.addColorStop(1, '#0b0b12');    // Tepi gelap

        ctx.beginPath();
        // [FIX 4] Gambar arc di (0,0) [titik tengah baru]
        ctx.arc(0, 0, outerR, 0, Math.PI * 2); 
        ctx.fillStyle = gradient;
        ctx.fill();
        
        // Potong lingkaran tengah (inner circle)
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        // [FIX 5] Potong lubang di (0,0) [titik tengah baru]
        ctx.arc(0, 0, innerR, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalCompositeOperation = 'source-over'; // Kembalikan mode

        ctx.restore(); // Hapus rotasi dan translasi

        // Gambar teks "No bets yet" di tengah (gunakan cx, cy asli)
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 16px Ubuntu'; // Font sedikit lebih besar
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('No bets yet', cx, cy); // Teks tetap digambar di koordinat asli
        return;
    }

    // 3. Loop 1: Gambar segmen warna
    for (let i = 0; i < playersArray.length; i++) {
        const p = playersArray[i];
        const sa = p.startAngle;
        const ea = p.endAngle;
        ctx.beginPath();
        ctx.moveTo(0, 0); // [FIX 6] Mulai dari (0,0) [titik tengah baru]
        ctx.arc(0, 0, outerR, sa, ea, false); // [FIX 7] Gambar arc di (0,0)
        ctx.closePath();
        ctx.fillStyle = p.color;
        ctx.fill();
    }

    // 4. Potong lingkaran tengah
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(0, 0, innerR, 0, Math.PI * 2); // [FIX 8] Potong lubang di (0,0)
    ctx.fill();

    // 5. Loop 2: Gambar Teks dan Garis Pemisah
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = 'rgba(0,0,0,0.4)'; // Garis lebih gelap agar terlihat
    ctx.lineWidth = 2; // Garis lebih tebal
    ctx.fillStyle = "#FFFFFF";
    ctx.font = "bold 10px Ubuntu";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    for (let i = 0; i < playersArray.length; i++) {
        const p = playersArray[i];
        const midAngle = (p.startAngle + p.endAngle) / 2;
        
        // Tentukan radius (jarak) untuk teks
        const textRadius = innerR + (outerR - innerR) / 2.5; 

        // 5a. Gambar garis pemisah
        ctx.beginPath();
        // [FIX 9] Gambar garis dari lubang dalam ke luar
        ctx.moveTo(Math.cos(p.startAngle) * (innerR + 2), Math.sin(p.startAngle) * (innerR + 2));
        ctx.lineTo(Math.cos(p.startAngle) * outerR, Math.sin(p.startAngle) * outerR);
        ctx.stroke();

        // 5b. Gambar teks
        ctx.save(); // Simpan state (hanya rotasi wheel)
        
        // Rotasi canvas ke tengah segmen
        ctx.rotate(midAngle); 
        
        // Tulis teks di posisi (radius, 0)
        const shortAddr = p.addr.slice(0, 4) + "..." + p.addr.slice(-3);
        ctx.fillText(shortAddr, textRadius, 0); 
        
        ctx.restore(); // Hapus rotasi segmen (kembali ke rotasi wheel)
    }

    ctx.restore(); // Hapus rotasi wheel utama
    }
    
    if (!CanvasRenderingContext2D.prototype.roundRect) {
      CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
        if (w<2*r) r=w/2; if (h<2*r) r=h/2;
        this.beginPath(); this.moveTo(x+r,y);
        this.arcTo(x+w,y,x+w,y+h,r); this.arcTo(x+w,y+h,x,y+h,r);
        this.arcTo(x,y+h,x,y,r); this.arcTo(x,y,x+w,y,r);
        this.closePath(); this.fill();
      };
    }
    function rebuildPlayersArrayAndDraw() {
        playersArray = []; 
        const playerKeys = Object.keys(players);
        for (const key of playerKeys) {
            playersArray.push({
                addr: players[key].id,
                weight: players[key].weight, // Gunakan bobot USD dari V3
                color: players[key].color
            });
        }
        let currentAngle = 0;
        const totalW = totalWeight; // totalUsdWeight dari V3
        for (const p of playersArray) {
            p.startAngle = currentAngle;
            let percentage = 0;
            if (totalW.gt(0)) {
                // Konversi BigNumber ke number untuk kalkulasi JS
                percentage = (p.weight.mul(1000000).div(totalW).toNumber()) / 1000000.0;
            }
            p.endAngle = currentAngle + (percentage * Math.PI * 2);
            currentAngle = p.endAngle;
        }
        drawDonut()
    }
  
  // ======= Weighted random selection (client-side) =======
    function pickWinnerClientSide() {
      // ... (Tidak ada perubahan pada fungsi ini) ...
      if (!playersArray || playersArray.length === 0) return null;
      const total = playersArray.reduce((acc,p)=> acc + p.weight, 0n);
      if (total === 0n) return null;
      const rand = randBigInt(total);
      let cum = 0n;
      for (let i=0;i<playersArray.length;i++){
        cum += playersArray[i].weight;
        if (rand < cum) return playersArray[i];
      }
      return playersArray[playersArray.length-1];
    }

  function randBigInt(max) {
      // ... (Tidak ada perubahan pada fungsi ini) ...
      const bytes = Math.ceil((max.toString(2).length)/8);
      let rand;
      do {
        const arr = new Uint8Array(bytes);
        window.crypto.getRandomValues(arr);
        rand = 0n;
        for (let i=0;i<arr.length;i++) rand = (rand << 8n) + BigInt(arr[i]);
      } while (rand >= max);
      return rand;
    }

// ======= Spin animation =======
function spinToPlayer(targetPlayer) {
  // ... (Tidak ada perubahan pada fungsi ini) ...
  return new Promise((resolveAnimation) => { 
      if (!targetPlayer) {
          resetAndFetchNewRound();
          resolveAnimation(); return;
      }
      const midRad = (targetPlayer.startAngle + targetPlayer.endAngle) / 2;
      const midDeg = (midRad * 180 / Math.PI);
      const targetRotationDeg = 270 - midDeg;
      const duration = Math.floor(Math.random() * (40000 - 30000 + 1)) + 30000;
      const spins = Math.floor(duration / 1200); 
      const finalRotation = (spins * 360) + targetRotationDeg;
      const startRotation = currentRotation; 
      const startTime = performance.now();
      function animate(now) {
        const t = Math.min(1, (now - startTime) / duration);
        const eased = 1 - Math.pow(1 - t, 4);
        currentRotation = startRotation + ((finalRotation - startRotation) * eased); 
        drawDonut(currentRotation);
        if (t < 1) {
          requestAnimationFrame(animate);
        } else {
          isSpinning = false; 
          const spinAudio = document.getElementById('sfx-spin');
          if(spinAudio) { spinAudio.pause(); spinAudio.currentTime = 0; }
          playSound('sfx-win');
          const isWinner = userAddress && (targetPlayer.addr.toLowerCase() === userAddress.toLowerCase());
          if (isWinner) {
              showVictoryScreen();
          } else {
              const winnerName = targetPlayer.addr.slice(0, 6) + "...";
              // [FIX] Ganti alert ke showStatus
              showStatus(`The winner is ${winnerName}! Try again later.`, 'info');
          }
          resetAndFetchNewRound(); 
          resolveAnimation(); 
        } 
      }
      requestAnimationFrame(animate);
  });
}

// [BARU] Fungsi untuk menampilkan/menyembunyikan Modal Wallet
function showWalletModal() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    walletModalOverlay.classList.add("show");
    walletModal.classList.add("show");
}
function hideWalletModal() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    walletModalOverlay.classList.remove("show");
    walletModal.classList.remove("show");
}

    // Function Disconnect Wallet
function disconnectWallet() {
    userAddress = null; provider = null; signer = null;
    walletBtn.innerText = "Connect Wallet";
    referralBtn.style.display = "none";
    statusText.innerText = "Wallet not connected";
    
    hideWalletModal(); 
    
    localStorage.removeItem(AUTO_CONNECT_KEY);
    
    if (visualTimer) clearInterval(visualTimer);
    if (faylottoContract) {
        faylottoContract.removeAllListeners();
        faylottoContract = null; 
    }
    
    resetRoundUI();
    myEthDeposit.innerText = "0"; 
    myUsdtDeposit.innerText = "0";
    winnerList.innerHTML = "";
    winnerList.appendChild(winnerListPlaceholder);

    // Reset info di modal
    walletAddress.innerText = "-";
    ethBalance.innerText = "0";
    usdtBalance.innerText = "0";
    
    fetchAndDisplayRoundData();
    fetchAndDisplayWinners();
    // [FIX] Ganti showToast ke showStatus
    showStatus("Wallet disconnected.", "info");
}
    
function handleCanvasRedraw() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    if (ctx) {
        console.log("Window/Tab is back active. Redrawing canvas...");
        drawDonut(currentRotation);
    }
}

    // --- FUNGSI PROFIL PLAYER ---
async function showPlayerProfile(address) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const modal = document.getElementById('profile-modal');
    const overlay = document.getElementById('profile-modal-overlay');
    document.getElementById('profileNickname').innerText = "Scanning...";
    document.getElementById('profileAddress').innerText = address;
    document.getElementById('profileRefCount').innerText = "-";
    document.getElementById('profileAvatar').src = `https://api.dicebear.com/9.x/bottts/svg?seed=${address}&baseColor=f0f4f8&backgroundColor=e0f2f7&mouthColor=ffc0cb&faceColor=a7d9f7&sidesColor=ffd700`;
    modal.classList.add('show');
    overlay.classList.add('show');
    try {
        const contract = faylottoContract || new ethers.providers.JsonRpcProvider(HTTPS_URL).then(p => new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, p));
        const activeContract = (contract.then) ? await contract : contract;
        const nickname = await activeContract.nicknames(address);
        const refCount = await activeContract.getReferralCount(address);
        document.getElementById('profileNickname').innerText = nickname || "No Nickname Yet";
        document.getElementById('profileRefCount').innerText = refCount.toString();
    } catch (e) {
        showStatus("Failed to load profile. Please connect your wallet.", "warning"); 
        document.getElementById('profileNickname').innerText = "Failed to load";
        document.getElementById('profileRefCount').innerText = "N/A";
    }
}

// --- (Helper PFP - Tidak Berubah) ---
    function getDeterministicPfpUrl(address) {
        const hash = parseInt(address.slice(-1), 16);
        const index = hash % TOTAL_PFP_IMAGES;
        return `${PFP_IMAGE_PATH}pfp-${index}.png`;
    }
  
    // --- (Helper Audio - Tidak Berubah) ---
    function playSound(soundId) {
        const audio = document.getElementById(soundId);
        if (audio) { audio.currentTime = 0; audio.play().catch(e => {}); }
    }

    // === FUNGSI VICTORY OVERLAY ===
let victoryAnimationId = null;
function showVictoryScreen() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const overlay = document.getElementById('victory-overlay');
    overlay.classList.add('show');
    playSound('sfx-win'); 
    startVictoryConfetti();
}
function hideVictoryScreen() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const overlay = document.getElementById('victory-overlay');
    overlay.classList.remove('show');
    stopVictoryConfetti();
}
function startVictoryConfetti() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    const canvas = document.getElementById('victory-canvas');
    const ctx = canvas.getContext('2d');
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;
    const particles = [];
    const particleCount = 150;
    const colors = ['#00ffff', '#ff00e6', '#6200ff', '#ffffff']; 
    for (let i = 0; i < particleCount; i++) {
        particles.push({
            x: Math.random() * width,
            y: Math.random() * height - height, 
            w: Math.random() * 10 + 5,          
            h: Math.random() * 10 + 5,
            speed: Math.random() * 5 + 2,       
            color: colors[Math.floor(Math.random() * colors.length)],
            tilt: Math.random() * 10,           
            tiltAngleIns: Math.random() * 0.07 + 0.05
        });
    }
    function animateConfetti() {
        ctx.clearRect(0, 0, width, height);
        particles.forEach(p => {
            p.tilt += p.tiltAngleIns;
            p.y += p.speed;
            ctx.beginPath();
            ctx.lineWidth = p.w / 2;
            ctx.strokeStyle = p.color;
            ctx.moveTo(p.x + p.tilt + (p.w / 2), p.y);
            ctx.lineTo(p.x + p.tilt, p.y + p.tilt + (p.h / 2));
            ctx.stroke();
            if (p.y > height) {
                p.x = Math.random() * width;
                p.y = -20;
            }
        });
        victoryAnimationId = requestAnimationFrame(animateConfetti);
    }
    animateConfetti();
}
function stopVictoryConfetti() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    if (victoryAnimationId) cancelAnimationFrame(victoryAnimationId);
    const canvas = document.getElementById('victory-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}
    
// GANTI FUNGSI LAMA fetchAndRenderLeaderboard DENGAN INI
function switchLeaderboard(tabName) {

    currentLbTab = tabName;
    // Update UI Tombol
    const btns = document.querySelectorAll('.lb-tab-btn');
    btns.forEach(b => b.classList.remove('active'));
    // Cari tombol yang diklik (cara sederhana)
    if(tabName === 'winners') btns[0].classList.add('active');
    else btns[1].classList.add('active');
    // Refresh data
    fetchAndRenderLeaderboard();
}

async function fetchAndRenderLeaderboard() {
    const list = document.getElementById("leaderboard-list");
    const header = document.getElementById("lb-header-row");
    if (!list) return;

    if (currentLbTab === 'winners') {
        if(header) header.innerHTML = `<span>Rank</span><span>Pilot</span><span>Total Won ($)</span><span>Loot</span>`;
    } else {
        if(header) header.innerHTML = `<span>Rank</span><span>Inviter</span><span>Total Reward ($)</span><span>Assets</span>`;
    }

    list.innerHTML = "<div class='lb-loading' style='animation:none; text-align:center;'>Scanning History...</div>";

    let contract = faylottoContract || new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);

    try {
        let usdtDec = 6, babyDec = 18;
        try {
            if (usdtContract) usdtDec = await usdtContract.decimals();
            if (babyDogeContract) babyDec = await babyDogeContract.decimals();
            if (!currentEthPrice) await fetchTokenPrices();
        } catch (e) {}

        let rawData = [];

        if (currentLbTab === 'winners') {
            // === PERBAIKAN SYNC FAILED ===
            const filter = contract.filters.WinnerRecorded();
            
            // GANTI '0' DENGAN BLOCK DEPLOYMENT KONTRAK ANDA!
            // Jika Anda tidak tahu, gunakan block saat ini dikurangi 50.000 (hanya ambil history baru)
            // Agar aman dan tidak error timeout.
            
            const currentBlock = await provider.getBlockNumber();
            const startBlock = currentBlock - 50000; // Scan 50rb blok terakhir saja agar ringan
            // Kalau mau semua history, ganti startBlock dengan angka pasti, misal: 18000000
            
            // Pastikan tidak minus
            const safeStartBlock = startBlock > 0 ? startBlock : 0;

            console.log(`Scanning from block ${safeStartBlock} to latest...`);
            
            const events = await contract.queryFilter(filter, safeStartBlock, "latest");

            if (events.length === 0) {
                list.innerHTML = "<div class='lb-loading' style='text-align:center;'>No recent winners found.</div>";
                return;
            }

            const winnersMap = {};

            events.forEach(ev => {
                const { winner, rewardETH, rewardUSDT, rewardBabyDoge } = ev.args;
                
                if (!winnersMap[winner]) {
                    winnersMap[winner] = {
                        addr: winner,
                        accEth: ethers.BigNumber.from(0),
                        accUsdt: ethers.BigNumber.from(0),
                        accBaby: ethers.BigNumber.from(0)
                    };
                }
                winnersMap[winner].accEth = winnersMap[winner].accEth.add(rewardETH);
                winnersMap[winner].accUsdt = winnersMap[winner].accUsdt.add(rewardUSDT);
                winnersMap[winner].accBaby = winnersMap[winner].accBaby.add(rewardBabyDoge);
            });

            Object.values(winnersMap).forEach(p => {
                const ethVal = parseFloat(ethers.utils.formatEther(p.accEth)) * (currentEthPrice || 3000);
                const usdtVal = parseFloat(ethers.utils.formatUnits(p.accUsdt, usdtDec));
                const babyVal = parseFloat(ethers.utils.formatUnits(p.accBaby, babyDec)) * (currentBabyDogePrice || 0);
                
                const totalUsd = ethVal + usdtVal + babyVal;

                if (totalUsd > 0) {
                    rawData.push({
                        addr: p.addr,
                        sortValue: totalUsd, 
                        eth: p.accEth,
                        usdt: p.accUsdt,
                        baby: p.accBaby
                    });
                }
            });

        } else {
            // LOGIKA REFERRAL (TIDAK PERLU UBAH)
            const playersList = await contract.getLeaderboardPlayers();
            for (let playerAddr of playersList) {
                const stats = await contract.leaderboardStats(playerAddr);
                const ethVal = parseFloat(ethers.utils.formatEther(stats[4])) * (currentEthPrice || 3000);
                const usdtVal = parseFloat(ethers.utils.formatUnits(stats[5], usdtDec));
                const babyVal = parseFloat(ethers.utils.formatUnits(stats[6], babyDec)) * (currentBabyDogePrice || 0);
                const totalRefUsd = ethVal + usdtVal + babyVal;

                if (totalRefUsd > 0.000001) {
                    rawData.push({
                        addr: playerAddr,
                        sortValue: totalRefUsd,
                        eth: stats[4],
                        usdt: stats[5],
                        baby: stats[6]
                    });
                }
            }
        }

        rawData.sort((a, b) => b.sortValue - a.sortValue);

        if (rawData.length === 0) {
            list.innerHTML = "<div class='lb-loading' style='text-align:center;'>No Pilots qualified yet.</div>";
            return;
        }

        const topList = rawData.slice(0, 20); 
        list.innerHTML = "";
        const fmt = (bn, dec, fix) => parseFloat(ethers.utils.formatUnits(bn, dec)).toFixed(fix);

        topList.forEach((p, index) => {
            const rank = index + 1;
            const isMe = userAddress && p.addr.toLowerCase() === userAddress.toLowerCase();
            const displayName = isMe ? "YOU" : (p.addr.slice(0, 4) + "..." + p.addr.slice(-4));

            list.innerHTML += `
                <div class="lb-item rank-${rank}" style="${isMe ? 'background:rgba(0,255,255,0.05); border-left: 3px solid var(--cyan-main);' : ''}">
                    <div class="lb-rank" style="color:${rank<=3 ? 'gold' : '#fff'}">#${rank}</div>
                    <div style="cursor:pointer; color:${isMe ? 'var(--cyan-main)' : '#ccc'}; font-weight:bold;" onclick="showPlayerProfile('${p.addr}')">${displayName}</div>
                    <div style="color:#00ff88; font-weight:bold;">$ ${p.sortValue.toFixed(2)}</div>
                    <div style="font-size: 11px; color:#aaa; line-height:1.4;">
                        ${p.eth.gt(0) ? `<span style="color:#fff">${fmt(p.eth, 18, 4)} ETH</span><br>` : ''}
                        ${p.usdt.gt(0) ? `<span style="color:#fff">${fmt(p.usdt, usdtDec, 2)} USDT</span><br>` : ''}
                        ${p.baby.gt(0) ? `<span style="color:#fff">${fmt(p.baby, babyDec, 0)} Baby</span>` : ''}
                    </div> 
                </div>
            `;
        });

    } catch (err) {
        // AGAR TAHU ERRORNYA APA:
        console.error("Leaderboard error details:", err);
        list.innerHTML = `<div class='lb-loading' style='color:#ff5555;'>Sync Failed: ${err.code || err.message.slice(0,20)}...</div>`;
    }
}
    
// Fungsi Tutup Modal Profil
function hideProfileModal() {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    document.getElementById('profile-modal').classList.remove('show');
    document.getElementById('profile-modal-overlay').classList.remove('show');
}

// Helper Copy to Clipboard (berguna untuk address)
function copyToClipboard(text) {
    // ... (Tidak ada perubahan pada fungsi ini) ...
    navigator.clipboard.writeText(text);
    showStatus("Address copied: " + text, "success", 3000); // 3000ms = 3 detik
}

// --- (Toast Notification - Tidak Berubah) ---
    function showStatus(message, type = 'info', duration = 10000) { 
        const container = document.getElementById('toast-container');
        if (!container) return;
        let iconName = 'info-icon.svg'; 
        if (type === 'success') iconName = 'success.svg';
        else if (type === 'error') iconName = 'error.svg';
        else if (type === 'load') iconName = 'load.svg';
        else if (type === 'warning') iconName = 'warning.svg';
        else if (type === 'spin') iconName = 'spin.svg';
        else if (type === 'wolf') iconName = 'wolf.svg';
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        const icon = document.createElement('img');
        icon.src = `${iconName}`; 
        icon.alt = "status icon";
        const text = document.createElement('span');
        text.textContent = message;
        const closeButton = document.createElement('button');
        closeButton.className = 'toast-close-btn';
        closeButton.innerHTML = '&times;'; 
        toast.appendChild(icon);
        toast.appendChild(text);
        toast.appendChild(closeButton);
        function removeToast() {
          toast.classList.remove('show');
          toast.classList.add('hide');
          toast.addEventListener('transitionend', () => {
            if (toast.parentNode === container) {
                container.removeChild(toast);
            }
          }, { once: true });
        }
        const hideTimeout = setTimeout(removeToast, duration);
        closeButton.onclick = () => {
          clearTimeout(hideTimeout); 
          removeToast(); 
        };
        container.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('show');
        }, 10); 
    }


// === 4. Inisialisasi & Event Listeners (LENGKAP & DIPERBAIKI) ===

document.addEventListener("DOMContentLoaded", () => {
        console.log("ðŸš€ Faylotto V3 Initializing...");
        
        const canvas = document.getElementById('donutCanvas');
if (canvas) {
    ctx = canvas.getContext('2d');

    // [FIX TAJAM] 1. Baca ukuran CSS (bisa 360px di HP, atau 550px di desktop)
    const rect = canvas.getBoundingClientRect();
    const displayWidth = rect.width;
    const displayHeight = displayWidth;

    // [FIX TAJAM] 2. Dapatkan rasio pixel device (misal 2x untuk Retina)
    const dpr = window.devicePixelRatio || 1;

    // [FIX TAJAM] 3. Set resolusi bitmap (ukuran file) kanvas
    canvas.width = displayWidth * dpr;
    canvas.height = displayHeight * dpr;

    // [FIX TAJAM] 4. Set ukuran CSS (tampilan) agar sesuai
    // Ini "mengecilkan" gambar 720px ke 360px, membuatnya tajam
    canvas.style.width = `${displayWidth}px`;
    canvas.style.height = `${displayHeight}px`;

    // [FIX TAJAM] 5. Scale context. 
    // Semua gambar (garis, teks) akan dikali 2 secara otomatis
    ctx.scale(dpr, dpr);

    // Set global (cx, cy) berdasarkan UKURAN CSS (bukan bitmap)
    cw = displayWidth;
    ch = displayHeight;
    cx = cw / 2; // misal 180 (dari 360 / 2)
    cy = ch / 2; // misal 180 (dari 360 / 2)

    // [FIX RESPONSIVE] Buat radius menjadi RELATIF
    // (Ini menggantikan global state yang kita hapus di Langkah 2)
    // [FIX RESPONSIVE] Buat radius menjadi RELATIF
outerR = displayWidth * 0.45; // Mengambil 45% dari lebar (misal: 360 * 0.45 = 162)
innerR = displayWidth * 0.20; // <-- [PERBAIKAN] Angka ini dinaikkan dari 100
    drawDonut(); 
}

    // 2. Cek Link Referral dari URL
    // (Ini adalah logika dari DOMContentLoaded Anda yang error di baris 297)
    const urlParams = new URLSearchParams(window.location.search);
    const refNick = urlParams.get('ref');
    if (refNick) {
        console.log("ðŸ”— Referral detected:", refNick);
        pendingReferrerNickname = refNick;
    }

    // 3. Panggil Data Awal SEGERA (Tanpa Menunggu Wallet)
    // [FIX] Ini adalah perbaikan untuk bug "tombol tidak aktif"
    
    // Init Provider Read-Only
    provider = new ethers.providers.JsonRpcProvider(HTTPS_URL);
    faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, provider);
    // [PERBAIKAN 2] Gunakan USDT_ABI
    babyDogeContract = new ethers.Contract(BABYDOGE_ADDRESS, USDT_ABI, provider);

    fetchAndDisplayRoundData(); // <-- FUNGSI YANG HILANG SEKARANG ADA
    fetchAndDisplayWinners();
    fetchAndRenderLeaderboard(); // Panggil leaderboard saat load
    checkAutoConnect(); // Coba auto-connect

    // -------------------------------------------------
    // 4. Pasang Semua Event Listeners
    // -------------------------------------------------

    // Listener Tombol Utama
    walletBtn.addEventListener("click", () => {
        if (!userAddress) toggleWallet(); else showWalletModal();
    });
    placeBetBtn.addEventListener("click", showBetModal);
    finalizeBtn.addEventListener("click", callFinalizeRound);

    // Listener Modal Profil
    const profileCloseBtn = document.getElementById('profile-modal-close-btn');
    if (profileCloseBtn) profileCloseBtn.addEventListener('click', hideProfileModal);
    const profileOverlay = document.getElementById('profile-modal-overlay');
    if (profileOverlay) profileOverlay.addEventListener('click', hideProfileModal);

    // Listener Modal Bet
    betModalCloseBtn.addEventListener("click", hideBetModal);
    betModalOverlay.addEventListener("click", hideBetModal);
    confirmBetBtn.addEventListener("click", confirmBet);
    percentButtons.forEach(button => {
        button.addEventListener("click", () => {
            const percent = parseFloat(button.dataset.percent);
            setAmountByPercent(percent);
        });
    });

    // Listener Modal Referral
    if (referralBtn) referralBtn.addEventListener("click", showReferralModal);
    if (referralModalCloseBtn) referralModalCloseBtn.addEventListener("click", hideReferralModal);
    if (referralModalOverlay) referralModalOverlay.addEventListener("click", hideReferralModal);
    if (createNicknameBtn) createNicknameBtn.addEventListener("click", callCreateNickname);
    
    // [PERBAIKAN 3] Hapus referensi ke 'setReferrerBtn' yang tidak ada
    // if (setReferrerBtn) setReferrerBtn.addEventListener("click", callSetReferrer);
    
    if (claimRewardsBtn) claimRewardsBtn.addEventListener("click", callClaimRewards);

    // Listener Modal Wallet
    if (walletModalCloseBtn) walletModalCloseBtn.addEventListener("click", hideWalletModal);
    if (walletModalOverlay) walletModalOverlay.addEventListener("click", hideWalletModal);
    if (disconnectBtn) disconnectBtn.addEventListener("click", disconnectWallet);

    // Setup Listeners Kontrak (setelah wallet connect, tapi juga read-only)
    setupEventListeners();
        
    // Atur tahun di footer
    document.getElementById("year").textContent = new Date().getFullYear();

    // Listener Copy Referral
    const copyBtn = document.getElementById("copyReferralBtn");
    if (copyBtn) {
        copyBtn.addEventListener("click", () => {
            const linkInput = document.getElementById("referralLinkInput");
            if (linkInput) {
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); 
                navigator.clipboard.writeText(linkInput.value)
                    .then(() => showStatus("Link referral disalin!", "success")) // [FIX] Ganti alert ke showStatus
                    .catch(() => {
                        document.execCommand('copy');
                        showStatus("Link referral disalin!", "success"); // [FIX] Ganti alert ke showStatus
                    });
            }
        });
    }

    // Listener ganti ikon di modal bet
    const currencySelect = document.getElementById('betCurrencySelect');
    const currencyIcon = document.getElementById('currency-icon');
    if (currencySelect && currencyIcon) {
        currencySelect.addEventListener('change', (e) => {
            const selectedIconPath = e.target.options[e.target.selectedIndex].dataset.icon;
            if (selectedIconPath) {
                currencyIcon.src = selectedIconPath;
            }
        });
    }

     // ==========================================
// PERBAIKAN STABILITAS RODA (CANVAS)
// ==========================================

function initResponsiveCanvas() {
    const canvas = document.getElementById('donutCanvas');
    const container = document.querySelector('.donut-wrap');
    
    if (!canvas || !container) return;

    ctx = canvas.getContext('2d');

    // Fungsi untuk mengatur ukuran canvas secara dinamis
    function resizeCanvas() {
        // 1. Ambil lebar container saat ini
        const boxWidth = container.clientWidth;
        
        // 2. Atur resolusi internal canvas (agar tajam di HP retina)
        canvas.width = boxWidth;
        canvas.height = boxWidth; // Buat kotak sempurna

        // 3. Update variabel global
        cw = canvas.width;
        ch = canvas.height;
        cx = cw / 2;
        cy = ch / 2;

        // 4. ATUR RADIUS SECARA RELATIF (KUNCI STABILITAS)
        // Radius luar = 40% dari lebar canvas
        // Radius dalam = 25% dari lebar canvas
        outerR = cw * 0.4; 
        innerR = cw * 0.25;

        // 5. Gambar ulang segera
        drawDonut(currentRotation);
    }

    // Panggil saat pertama kali load
    resizeCanvas();

    // Panggil setiap kali layar diubah ukurannya
    window.addEventListener('resize', resizeCanvas);
    
    // Panggil saat orientasi HP berubah (Potrait/Landscape)
    window.addEventListener('orientationchange', () => {
        setTimeout(resizeCanvas, 100);
    });
}

// PANGGIL FUNGSI INI DI DALAM DOMContentLoaded
document.addEventListener("DOMContentLoaded", () => {
    // ... (kode inisialisasi wallet dll biarkan saja) ...

    // INSIALISASI KANVAS BARU
    initResponsiveCanvas();

  // --- Listener Tombol Refresh Wheel ---
    const refreshWheelBtn = document.getElementById("refreshWheelBtn");
    if (refreshWheelBtn) {
        refreshWheelBtn.addEventListener("click", async () => {
            // 1. Efek Visual (Putar Ikon)
            refreshWheelBtn.classList.add("spinning");
            
            // 2. Panggil Fungsi Sync Utama
            // Ini akan mengambil ulang data dari blockchain & menggambar ulang roda
            await fetchAndDisplayRoundData(); 

            // 3. Berhenti Putar Ikon & Kasih Notif
            setTimeout(() => {
                refreshWheelBtn.classList.remove("spinning");
                showStatus("Wheel synced!", "success", 2000);
            }, 500);
        });
    }
    
    // ... (sisa kode event listener Anda) ...
});

     // Tambahkan suara klik ke semua tombol
    document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => playSound('sfx-click'));
    });

    // Listener Perbaikan Canvas & Tab
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') handleCanvasRedraw();
    });
    window.addEventListener("focus", handleCanvasRedraw);

});
  </script>
</body>
</html>
