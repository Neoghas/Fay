<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
<style>
    /* --- CSS UTAMA --- */
    * { box-sizing: border-box; }
    :root {
        --primary: #0052ff; --accent: #00d1ff; --bg: #0f111a;
        --panel: #1e2130; --text: #ffffff; --danger: #ff4b4b; --success: #00d26a;
        --shib-color: #FFA409; --usdt-color: #26A17B; --eth-color: #627EEA;
        --gold: #FFD700; --gradient-bg: linear-gradient(135deg, #0f111a, #1e2130);
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--gradient-bg); color: var(--text); margin: 0;
        display: flex; flex-direction: column; align-items: center;
        min-height: 100vh; padding-bottom: 50px; overflow-x: hidden;
    }
    header {
        width: 100%; padding: 15px 20px; display: flex; justify-content: space-between;
        align-items: center; background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--panel);
        position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .wallet-btn {
        background: var(--primary); color: white; border: none; padding: 8px 16px;
        border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.3s;
        box-shadow: 0 0 10px rgba(0, 82, 255, 0.5);
    }
    .wallet-btn.connected { background: var(--success); border: 1px solid #fff; cursor: default; }
    .layout-container { width: 94%; max-width: 480px; display: flex; flex-direction: column; align-items: center; margin: 0 auto; }

    .slot-machine {
        margin-top: 30px; background: var(--panel); padding: 20px;
        border-radius: 15px; border: 4px solid #333;
        box-shadow: 0 0 30px rgba(0, 82, 255, 0.4);
        width: 100%; display: flex; flex-direction: column; align-items: center;
    }
    .reels-container { display: flex; gap: 8px; background: #000; padding: 10px; border-radius: 8px; justify-content: center; margin-bottom: 15px; width: 100%; box-shadow: inset 0 0 10px rgba(255,255,255,0.1); }
    .reel { flex: 1; height: 90px; background: #fff; border-radius: 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    .reel-img { width: 80%; height: 80%; object-fit: contain; transition: transform 0.1s; }

    .draw-section { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .btn-draw {
        background: linear-gradient(45deg, #333, #555); color: #888; border: 2px solid #444;
        padding: 12px 0; width: 70%; border-radius: 30px;
        font-size: 0.9em; font-weight: 800; cursor: not-allowed; transition: 0.3s;
    }
    .btn-draw.ready {
        background: linear-gradient(45deg, #ff0000, #ff8800); color: white; border: 2px solid #ffaa00;
        cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); } 50% { box-shadow: 0 0 25px rgba(255, 100, 0, 0.8); } 100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); } }
    .status-text { font-size: 0.8em; color: var(--accent); font-weight: bold; text-align: center; }

    .betting-section { margin-top: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; }
    .bet-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-top: 15px; }

    .bet-card {
        background: var(--panel); border: 3px solid #333; border-radius: 12px; padding: 10px; cursor: pointer; transition: 0.2s;
        display: flex; flex-direction: column; align-items: center; justify-content: center; aspect-ratio: 1/1.2; position: relative;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .bet-card:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(0, 82, 255, 0.5); }
    .bet-card.my-bet { border-color: var(--primary); background: rgba(0, 82, 255, 0.2); box-shadow: 0 0 20px rgba(0, 82, 255, 0.6); }
    .bet-card.open { border-color: var(--success); animation: pulseGreen 2s infinite; }
    @keyframes pulseGreen { 0% { border-color: #00d26a; } 50% { border-color: #00ff80; } 100% { border-color: #00d26a; } }
    .bet-card.selected { transform: scale(0.95); background: rgba(255, 255, 255, 0.15); box-shadow: 0 0 15px var(--accent); }

    .bet-icon-img { width: 50%; height: 50%; object-fit: contain; margin-bottom: 5px; }
    .name { font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px;}
    .team-count { font-size: 9px; color: #aaa; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-top: 2px; }
    .team-count.filled { color: var(--success); border: 1px solid var(--success); }

    .pool-dashboard { width: 100%; display: flex; justify-content: space-between; gap: 5px; margin-top: 20px; margin-bottom: 10px; }
    .pool-box { flex: 1; background: #151925; border: 1px solid #333; border-radius: 8px; padding: 8px 5px; text-align: center; display: flex; flex-direction: column; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .pool-title { font-size: 0.6em; color: #aaa; text-transform: uppercase; margin-bottom: 3px; }
    .pool-value { font-size: 0.8em; font-weight: bold; }
    .text-eth { color: var(--eth-color); } .text-usdt { color: var(--usdt-color); } .text-shib { color: var(--shib-color); }

    .card-stats-container { width: 100%; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; font-size: 0.6em; font-weight: bold; }
    .c-stat { display: flex; align-items: center; gap: 2px; }

    .main-bet-btn { margin-top: 15px; background: var(--primary); color: white; border: 3px solid #0027b3; padding: 13px 0; width: 70%; border-radius: 50px; font-size: 0.9em; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 0 15px var(--primary); }
    .main-bet-btn:hover { background: var(--accent); transform: translateY(-2px); box-shadow: 0 0 25px var(--accent); }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--panel); width: 90%; max-width: 380px; padding: 25px; border-radius: 15px; text-align: center; border: 1px solid var(--accent); box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative;}
    .modal-title { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; }
    .pay-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .pay-btn { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 13px; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
    .btn-eth { background: var(--eth-color); } .btn-usdt { background: var(--usdt-color); } .btn-shib { background: var(--shib-color); }
    .close-modal { background: none; border: none; color: #aaa; font-size: 1.5em; position: absolute; top: 10px; right: 15px; cursor: pointer; }

    .dash-profile { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
    .dash-balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; text-align: left; }
    .dash-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; }
    .dash-label { font-size: 0.65em; color: #aaa; display: block; }
    .dash-val { font-size: 0.85em; font-weight: bold; }
    .btn-disconnect { background: var(--danger); width: 100%; padding: 10px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }

    /* --- REFERRAL CSS UPDATED --- */
    .referral-panel { margin-top: 25px; width: 100%; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid #333; text-align: center; display: none; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
    .ref-label { font-size: 0.7em; color: var(--accent); text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }
    .ref-box { background: #080808; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; margin-top: 5px; font-size: 0.8em; color: #888; }
    .btn-copy { background: var(--primary); color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold; }
    .btn-copy:hover { background: var(--accent); }
    
    .ref-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; margin-bottom: 10px; }
    .ref-stat-item { background: #111; border: 1px solid #333; padding: 10px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; }
    .rs-val { font-size: 1.2em; font-weight: bold; color: white; }
    .rs-lbl { font-size: 0.65em; color: #aaa; text-transform: uppercase; }

    .comm-info { font-size: 0.65em; color: #666; margin-top: 15px; font-style: italic; border-top: 1px dashed #333; padding-top: 8px;}

    .withdraw-section { margin-top:15px; padding-top:10px; border-top:1px dashed #444; text-align:left; }
    .withdraw-title { font-size:0.8em; color:#aaa; margin-bottom:5px; }
    .btn-withdraw-small { background: var(--success); color:black; border:none; padding:4px 8px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.8em; float:right; }

    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 999; bottom: 30px; left: 50%; transform: translateX(-50%); }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    .winner-glamour { border-color: var(--gold) !important; background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.3)) !important; animation: glamourPulse 0.8s infinite alternate !important; z-index: 10; transform-origin: center; }
    @keyframes glamourPulse { 0% { box-shadow: 0 0 15px var(--gold), inset 0 0 5px var(--gold); transform: scale(1); border-color: var(--gold); } 100% { box-shadow: 0 0 30px var(--gold), 0 0 45px #FF4500, inset 0 0 20px var(--gold); transform: scale(1.1); border-color: #FFF; } }
    .winner-glamour::before { content: "üèÜ WINNER"; position: absolute; top: -15px; background: linear-gradient(45deg, var(--gold), #FFA500); color: #000; font-weight: bold; font-size: 0.7em; padding: 3px 10px; border-radius: 10px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); animation: bounce 0.8s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    .history-section { margin-top: 30px; width: 100%; }
    .history-card { background: var(--panel); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.3); position: relative; }
    .history-reels { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
    .history-reel-img { width: 40px; height: 40px; object-fit: contain; }
    .history-outcome { font-weight: bold; color: var(--accent); }
    .history-tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
    .tab-btn { flex: 1; padding: 10px; background: #151925; border: 1px solid #333; color: #888; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: 0.3s; }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 82, 255, 0.4); }
    .btn-load-more { width: 100%; padding: 12px; background: #222; border: 1px dashed #555; color: #aaa; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 0.8em; transition: 0.3s; }
    .btn-load-more:hover { background: #333; color: white; border-color: white; }
    .hidden { display: none; }
    .personal-bet-card { background: rgba(255,255,255,0.03); border-left: 3px solid #555; padding: 10px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    .pb-info { font-size: 0.8em; }
    .pb-time { font-size: 0.7em; color: #666; }
    .pb-animal { font-weight: bold; color: var(--accent); }
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; text-transform: uppercase; }
    .badge-win { background: rgba(0, 210, 106, 0.2); color: var(--success); border: 1px solid var(--success); }
    .badge-lose { background: rgba(255, 75, 75, 0.2); color: var(--danger); border: 1px solid var(--danger); }

    /* --- CSS BARU: SOCIAL FIX --- */
    .social-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 8px;
        border-top: 1px solid #333;
    }
    .star-group { display: flex; align-items: center; gap: 2px; }
    .star-btn {
        cursor: pointer;
        font-size: 1.3em;
        color: #444; /* Warna mati */
        transition: 0.2s;
        line-height: 1;
    }
    .star-btn:hover { transform: scale(1.2); }
    /* Class untuk bintang menyala */
    .star-btn.active { color: var(--gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
    
    .star-count { 
        font-size: 0.7em; 
        color: #888; 
        margin-left: 6px; 
    }
    
    .like-wrapper { display: flex; align-items: center; }
    .btn-like-single {
        background: #151925;
        border: 1px solid #333;
        color: #aaa;
        border-radius: 6px;
        padding: 5px 12px;
        cursor: pointer;
        font-size: 0.85em;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: 0.3s;
    }
    .btn-like-single:hover { border-color: var(--success); color: white; }
    .btn-like-single:active { transform: scale(0.95); }

</style>
</head>
<body>
<header>
    <div style="font-weight:bold; font-size:1.2em;">Faylotto <span style="color:var(--accent)">Ultimate</span></div>
    <button id="connectBtn" class="wallet-btn" onclick="handleWalletClick()">Connect Wallet</button>
</header>

<div class="layout-container">
    <div class="slot-machine">
        <div class="reels-container">
            <div class="reel"><img id="imgReel1" src="what.svg" class="reel-img"></div>
            <div class="reel"><img id="imgReel2" src="what.svg" class="reel-img"></div>
            <div class="reel"><img id="imgReel3" src="what.svg" class="reel-img"></div>
        </div>
        <div class="draw-section">
            <button id="drawBtn" class="btn-draw" onclick="executeDraw()" disabled>DRAW NOW!</button>
            <div id="drawStatus" class="status-text">Waiting for players...</div>
        </div>
    </div>

    <div class="betting-section">
        <h3 style="margin-bottom:5px;">SELECT ANIMAL</h3>
        <div class="bet-grid">
            <div class="bet-card" id="card-0" onclick="selectAnimal('tuna', 0)"><img src="tuna.svg" class="bet-icon-img"><span class="name">Tuna</span><span id="count-0" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-0">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-0">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-0">0</span></span></div></div>
            <div class="bet-card" id="card-1" onclick="selectAnimal('crab', 1)"><img src="crab.svg" class="bet-icon-img"><span class="name">Crab</span><span id="count-1" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-1">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-1">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-1">0</span></span></div></div>
            <div class="bet-card" id="card-2" onclick="selectAnimal('shark', 2)"><img src="shark.svg" class="bet-icon-img"><span class="name">Shark</span><span id="count-2" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-2">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-2">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-2">0</span></span></div></div>
            <div class="bet-card" id="card-3" onclick="selectAnimal('octopus', 3)"><img src="octo.svg" class="bet-icon-img"><span class="name">Octopus</span><span id="count-3" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-3">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-3">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-3">0</span></span></div></div>
            <div class="bet-card" id="card-4" onclick="selectAnimal('shrimp', 4)"><img src="shrimp.svg" class="bet-icon-img"><span class="name">Shrimp</span><span id="count-4" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-4">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-4">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-4">0</span></span></div></div>
            <div class="bet-card" id="card-5" onclick="selectAnimal('orcha', 5)"><img src="orcha.svg" class="bet-icon-img"><span class="name">Orcha</span><span id="count-5" class="team-count">0</span><div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-5">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-5">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-5">0</span></span></div></div>
        </div>

        <div style="width:100%; margin-top:20px; font-size:0.7em; color:#aaa; text-align:left;">ESTIMATED POOLS (ROUND)</div>
        <div class="pool-dashboard">
            <div class="pool-box"><span class="pool-title">ETH</span><span class="pool-value text-eth" id="poolTotalETH">0.0000</span></div>
            <div class="pool-box"><span class="pool-title">USDT</span><span class="pool-value text-usdt" id="poolTotalUSDT">0.00</span></div>
            <div class="pool-box"><span class="pool-title">SHIB</span><span class="pool-value text-shib" id="poolTotalSHIB">0</span></div>
        </div>

        <button id="mainBetBtn" class="main-bet-btn" onclick="triggerBetModal()">PLACE BET</button>
        <p style="margin-top:15px; color:#aaa; font-size:0.7em;">*Min 5 teams required to Draw</p>

        <div id="referralPanel" class="referral-panel">
            <div id="view-register" style="display:none;">
                <div class="ref-label" style="color:var(--gold);">NEW PLAYER REGISTRATION</div>
                <p style="font-size:0.8em; color:#aaa; margin:5px 0 15px 0;">Create a nickname to start betting & earning.</p>
                
                <input type="text" id="panelRegNick" placeholder="Enter Nickname (Min 3 Chars)" 
                       style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #444; color:white; border-radius:8px; text-align:center;">
                
                <div id="panelRefInfo" style="font-size:0.75em; color:var(--success); margin-bottom:10px; font-style:italic;"></div>
                
                <button class="wallet-btn" style="width:100%; background:var(--primary);" onclick="registerUser()">CREATE ACCOUNT</button>
            </div>
        
            <div id="view-profile" style="display:none;">
                <div class="ref-label">Player Profile</div>
                <div style="font-size:1.2em; font-weight:bold; color:white; margin-bottom:10px;" id="displayNick">...</div>
                
                <div class="ref-stats-grid">
                    <div class="ref-stat-item">
                        <span class="rs-val" id="totalInvited">0</span>
                        <span class="rs-lbl">Total Invited</span>
                    </div>
                    <div class="ref-stat-item">
                        <span class="rs-val" style="color:var(--gold);" id="pendingBonus">0</span>
                        <span class="rs-lbl">Pending Bonus</span>
                    </div>
                </div>
                
                <div id="claimBonusBtnContainer"></div>
                
                <div class="ref-label">Referral Link</div>
                <div class="ref-box">
                    <span id="displayRefLink" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">...</span>
                    <button class="btn-copy" onclick="copyRefLink()">Copy</button>
                </div>
                <div class="comm-info">*0.25% Commission from winnings is automatically added to your Game Credit.</div>
            </div>
        </div>
        
        <div class="history-section">
            <div class="history-tabs">
                <button class="tab-btn active" onclick="switchTab('global')">Global Results</button>
                <button class="tab-btn" onclick="switchTab('personal')">My Winnings</button>
            </div>
            <div id="tabGlobal">
                <div id="historyList"></div>
                <button id="btnLoadMore" class="btn-load-more" onclick="loadMoreHistory()">Load Previous Rounds (15)</button>
            </div>
            <div id="tabPersonal" class="hidden">
                <div id="personalHistoryList"><div style="text-align:center; color:#555; font-size:0.8em; padding:20px;">Fetching blockchain data...</div></div>
            </div>
        </div>
    </div>
</div>

<div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('paymentModal')">&times;</button>
        <div class="modal-title">BET ON <span id="modalAnimalName">ANIMAL</span></div>
        <div class="pay-options">
            <button class="pay-btn btn-eth" onclick="processPayment('ETH')"><span>ETH</span> <span>0.0005 ETH</span></button>
            <button class="pay-btn btn-usdt" onclick="processPayment('USDT')"><span>USDT</span> <span>10 USDT</span></button>
            <button class="pay-btn btn-shib" onclick="processPayment('SHIB')"><span>SHIB</span> <span>110,000 SHIB</span></button>
        </div>
        <div style="border-top:1px dashed #444; padding-top:10px;">
            <div style="font-size:0.8em; color:#aaa;">Free Credit Balance: <span id="userBonusBalance" style="color:white;">0</span> SHIB</div>
            <button id="btnFreeBet" class="wallet-btn" style="width:100%; margin-top:5px; background:#333;" disabled onclick="processPayment('FREE')">Use Free Credit (10k)</button>
        </div>
    </div>
</div>

<div id="walletInfoModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('walletInfoModal')">&times;</button>
        <div class="dash-profile"><div style="font-weight:bold; margin-bottom:5px;">WALLET & WINNINGS</div><div style="font-size:0.8em; color:#aaa; background:#111; padding:5px; border-radius:4px;" id="dashAddress">...</div></div>
        <div style="font-size:0.7em; color:#888; margin-bottom:5px;">WALLET BALANCE</div>
        <div class="dash-balance-grid"><div class="dash-item"><span class="dash-label">ETH</span><span class="dash-val text-eth" id="balETH">0.000</span></div><div class="dash-item"><span class="dash-label">USDT</span><span class="dash-val text-usdt" id="balUSDT">0.00</span></div><div class="dash-item"><span class="dash-label">SHIB</span><span class="dash-val text-shib" id="balSHIB">0.00</span></div></div>
        <div class="withdraw-section">
            <div class="withdraw-title">GAME CREDIT / WINNINGS / COMMISSIONS</div>
            <div class="dash-balance-grid">
                <div class="dash-item"><span class="dash-label">ETH Credit</span><span class="dash-val text-eth" id="credETH">0.000</span><button class="btn-withdraw-small" onclick="withdraw('ETH')">W/D</button></div>
                <div class="dash-item"><span class="dash-label">USDT Credit</span><span class="dash-val text-usdt" id="credUSDT">0.00</span><button class="btn-withdraw-small" onclick="withdraw('USDT')">W/D</button></div>
                <div class="dash-item"><span class="dash-label">SHIB Credit</span><span class="dash-val text-shib" id="credSHIB">0.00</span><button class="btn-withdraw-small" onclick="withdraw('SHIB')">W/D</button></div>
            </div>
        </div>
        <button class="btn-disconnect" onclick="disconnectWallet()">DISCONNECT</button>
    </div>
</div>

<div id="toast">Notification</div>

<script>
/* ========== CONFIG ========== */
const CONTRACT_ADDRESS = "0x72a20552267B4313f74003E25593592B15b76ad6";
const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2";
const SHIB_ADDRESS = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";
const BASE_SEPOLIA_HEX = "0x14a34";
const BASE_RPC_URL = "https://sepolia.base.org";
const BASE_WSS_URL = "wss://base-sepolia-rpc.publicnode.com";

/* ======= IMPORTANT: paste ABI arrays here ======= */
/* Example:
   const GAME_ABI = [ "function currentRoundId() view returns (uint256)", ... ];
   const ERC20_ABI = [ "function approve(address,uint256) returns (bool)", "function allowance(address,address) view returns (uint256)", "function balanceOf(address) view returns (uint256)" ];
*/
const GAME_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_shibToken","type":"address"},{"internalType":"address","name":"_priceFeedETH","type":"address"},{"internalType":"address","name":"_priceFeedUSDT","type":"address"},{"internalType":"address","name":"_priceFeedSHIB","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"indexed":false,"internalType":"string","name":"outcome","type":"string"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"BattleResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BonusClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"oldCollector","type":"address"},{"indexed":false,"internalType":"address","name":"newCollector","type":"address"}],"name":"FeeCollectorUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint8","name":"animalChoice","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NewBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"RatingSubmitted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"reactionType","type":"uint8"}],"name":"ReactionUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"invitee","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralLinked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"UserRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"enum FaylottoUltimate.Currency","name":"curr","type":"uint8"},{"indexed":false,"internalType":"bool","name":"isRealTransfer","type":"bool"}],"name":"WinDistributed","type":"event"},{"inputs":[],"name":"COST_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_MAIN","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_PLATFORM_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TOTAL_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TEAMS_ACTIVE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BONUS_AMOUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"","type":"uint8"}],"name":"activeTeamCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"}],"name":"betETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"},{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"bool","name":"_isFreeBet","type":"bool"}],"name":"betToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralBonus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"commentCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"dislikeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint256","name":"_cId","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"name":"emergencyWithdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeDraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeShibCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getActiveTeamCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getBonusBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"}],"name":"getLatestPrice","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"}],"name":"getRoundResult","outputs":[{"components":[{"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"internalType":"struct FaylottoUltimate.RoundResultData","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"globalWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nicknameToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_referrerNick","type":"string"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"enum FaylottoUltimate.BetType","name":"bType","type":"uint8"},{"internalType":"uint8","name":"animalChoice","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundHistory","outputs":[{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_eth","type":"address"},{"internalType":"address","name":"_usdt","type":"address"},{"internalType":"address","name":"_shib","type":"address"}],"name":"setPriceFeeds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_reaction","type":"uint8"}],"name":"setReaction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"shibToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_stars","type":"uint8"}],"name":"submitRating","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"enum FaylottoUltimate.Currency","name":"","type":"uint8"}],"name":"userCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRatings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userReactions","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"hasBet","type":"bool"},{"internalType":"uint256","name":"pendingRefBonusCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawCredit","outputs":[],"stateMutability":"nonpayable","type":"function"}];
const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
/* =============================================== */

const IMAGE_NAMES = ['tuna','crab','shark','octopus','shrimp','orcha'];
const IMAGE_LIST = ["tuna.svg","crab.svg","shark.svg","octo.svg","shrimp.svg","orcha.svg","zonk.svg"];
const MIN_SPIN_TIME = 35000;

let provider = null;
let signer = null;
let userAddress = null;
let rpcProvider = null;
let wssProvider = null;

let gameContract = null;      // provider/signer-linked contract for on-chain reads/writes
let listenerContract = null;  // WSS contract for events

let isConnected = false;
let spinStartTime = 0;
let spinIntervals = [];
let currentSelectedAnimal = { name:'', index:-1 };
let detectedReferrer = "";
let roundPools = { eth:0, usdt:0, shib:0 };
let historyCursor = 0;
let isInitialLoad = true;
let myBetCounts = [0,0,0,0,0,0];
let globalHistoryLength = -1;
let isProcessingResult = false;

/* ---------- ONLOAD ---------- */
window.addEventListener('load', async () => {
  document.querySelectorAll('.reel-img').forEach(img => img.src = "what.svg");
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('ref')) detectedReferrer = urlParams.get('ref');

  // RPC provider for reads
  rpcProvider = new ethers.JsonRpcProvider(BASE_RPC_URL);
  gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, rpcProvider);

  // WSS provider (listener)
  await trySetupWss();

  // Initial data
  await refreshGameData();
});

/* ---------- WSS SETUP WITH RECONNECT ---------- */
async function trySetupWss(retries = 0) {
  try {
    if (wssProvider) {
      try { wssProvider._websocket.close(); } catch {}
      wssProvider = null;
      listenerContract && listenerContract.removeAllListeners();
    }
    wssProvider = new ethers.WebSocketProvider(BASE_WSS_URL);
    listenerContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, wssProvider);
    setupEventListeners();
    console.log("WSS connected");
  } catch (err) {
    console.warn("WSS failed:", err);
    // retry backoff
    if (retries < 5) {
      setTimeout(() => trySetupWss(retries + 1), 2000 * (retries + 1));
    } else {
      // fallback to RPC (listenerContract = gameContract)
      listenerContract = gameContract;
      setupEventListeners(); // still set up (will be no-op if no events on rpc)
    }
  }
}

/* ---------- WALLET CONNECT ---------- */
async function handleWalletClick(){ isConnected ? openWalletDashboard() : connectWallet(); }
async function connectWallet() {
  if (!window.ethereum) { showToast("MetaMask not found"); return; }
  try {
    provider = new ethers.BrowserProvider(window.ethereum);
    // request accounts via provider
    const accounts = await provider.send("eth_requestAccounts", []);
    userAddress = accounts[0];
    // optionally switch network
    try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params:[{ chainId: BASE_SEPOLIA_HEX }] }); } catch (e) { console.log("Network switch ignored", e); }
    signer = await provider.getSigner();
    // replace gameContract to signer-backed for txs
    gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, signer);
    isConnected = true;
    document.getElementById("connectBtn").innerText = "Wallet Info";
    document.getElementById("connectBtn").classList.add("connected");
    showToast("Wallet connected");
    await refreshGameData();
  } catch (err) {
    console.error("connectWallet", err);
    showToast("Connect failed");
  }
}

/* ---------- REFRESH / UI UPDATE ---------- */
async function refreshGameData() {
  try {
    // If connected, show referral panel and fetch user data
    if (isConnected && userAddress) {
      document.getElementById('referralPanel').style.display = 'block';
      const u = await gameContract.users(userAddress);
      const isReg = u[1];
      if (isReg) {
        document.getElementById('view-profile').style.display = 'block';
        document.getElementById('view-register').style.display = 'none';
        document.getElementById('displayNick').innerText = u[0] || userAddress;
        document.getElementById('displayRefLink').innerText = window.location.origin + window.location.pathname + "?ref=" + u[0];
        const pendingCount = Number(u[4] || 0n); // pendingRefBonusCount
        document.getElementById('pendingBonus').innerText = (pendingCount * 10000).toLocaleString();
        const claimContainer = document.getElementById('claimBonusBtnContainer');
        if (pendingCount > 0) {
          claimContainer.innerHTML = `<button class="wallet-btn" style="width:100%; margin-bottom:10px; background:var(--gold); color:black;" onclick="claimReferralBonus()">Claim ${pendingCount * 10000} SHIB Bonus</button>`;
        } else claimContainer.innerHTML = '';
        updateReferralCount();
      } else {
        document.getElementById('view-profile').style.display = 'none';
        document.getElementById('view-register').style.display = 'block';
        if (detectedReferrer) document.getElementById('panelRefInfo').innerText = "Invited by: " + detectedReferrer;
      }

      // freeShibCredits
      try {
        const bonus = await gameContract.freeShibCredits(userAddress);
        const bonusNum = Number(ethers.formatEther(bonus));
        document.getElementById('userBonusBalance').innerText = bonusNum.toLocaleString();
        const btnFree = document.getElementById('btnFreeBet');
        if (btnFree) {
          btnFree.disabled = bonus < ethers.parseEther("10000");
          btnFree.style.background = (bonus >= ethers.parseEther("10000")) ? "var(--success)" : "#333";
        }
      } catch (e) { console.warn("freeShibCredits fetch failed", e); }
    } else {
      // hide referral panel if no wallet
      document.getElementById('referralPanel').style.display = 'none';
    }

    // Fetch current round bets (CAUTION: may be large). We try read-by-index as your contract uses public array getter.
    const currRBN = await gameContract.currentRoundId();
    const currR = Number(currRBN);
    // collect bets for current round by index
    const bets = [];
    let idx = 0;
    while (true) {
      try {
        const b = await gameContract.roundBets(currR, idx);
        bets.push(b);
        idx++;
        // safety break if extremely many bets
        if (idx > 1000) break;
      } catch (e) {
        break;
      }
    }

    // compute counts and pools
    const counts = [0,0,0,0,0,0];
    const animalCurrCounts = Array.from({length:6},()=>({eth:0,usdt:0,shib:0}));
    myBetCounts = [0,0,0,0,0,0];
    const pools = {eth:0,usdt:0,shib:0};

    for (const b of bets) {
      const bettor = b[0];
      const amount = b[1];
      const curr = Number(b[2]);
      const animalIdx = Number(b[4]);
      const decimal = (curr === 1) ? 6 : 18;
      const amt = Number(ethers.formatUnits(amount, decimal));
      if (curr === 0) pools.eth += amt;
      else if (curr === 1) pools.usdt += amt;
      else pools.shib += amt;
      counts[animalIdx] = (counts[animalIdx] || 0) + 1;
      if (isConnected && bettor && userAddress && bettor.toLowerCase() === userAddress.toLowerCase()) myBetCounts[animalIdx] = (myBetCounts[animalIdx]||0) + 1;
      if (curr === 0) animalCurrCounts[animalIdx].eth++;
      else if (curr === 1) animalCurrCounts[animalIdx].usdt++;
      else animalCurrCounts[animalIdx].shib++;
    }

    // update UI
    roundPools = pools;
    updatePoolDisplay();

    for (let i=0;i<6;i++){
      const elCount = document.getElementById(`count-${i}`);
      if (elCount) elCount.innerText = counts[i] || 0;
      const card = document.getElementById(`card-${i}`);
      if (card) {
        card.classList.remove('my-bet','open');
        if (myBetCounts[i] > 0) card.classList.add('my-bet'); else card.classList.add('open');
      }
      document.getElementById(`c-eth-${i}`).innerText = animalCurrCounts[i].eth;
      document.getElementById(`c-usdt-${i}`).innerText = animalCurrCounts[i].usdt;
      document.getElementById(`c-shib-${i}`).innerText = animalCurrCounts[i].shib;
    }

    // update draw button
    const active = counts.filter(x=>x>0).length;
    const btnDraw = document.getElementById('drawBtn');
    const drawStatus = document.getElementById('drawStatus');
    if (active >= 5) {
      btnDraw.disabled = false; btnDraw.classList.add('ready');
      drawStatus.innerText = "READY TO DRAW!"; drawStatus.style.color = "var(--success)";
    } else {
      btnDraw.disabled = true; btnDraw.classList.remove('ready');
      drawStatus.innerText = `Need ${5 - active} more teams active`; drawStatus.style.color = "var(--danger)";
    }

    // update history
    updateHistorySection(currR);
    if (!document.getElementById('tabPersonal').classList.contains('hidden')) updatePersonalHistory();

  } catch (err) {
    console.error("refreshGameData error", err);
  }
}

function updatePoolDisplay(){
  document.getElementById('poolTotalETH').innerText = roundPools.eth.toFixed(4);
  document.getElementById('poolTotalUSDT').innerText = roundPools.usdt.toFixed(2);
  document.getElementById('poolTotalSHIB').innerText = roundPools.shib.toLocaleString();
}

/* ---------- SELECT / MODAL / BET ---------- */
function selectAnimal(name,index){
  currentSelectedAnimal = { name, index };
  for (let i=0;i<6;i++) document.getElementById(`card-${i}`).classList.remove('selected');
  document.getElementById(`card-${index}`).classList.add('selected');
}

async function triggerBetModal(){
  if (!isConnected) { showToast("Connect Wallet First"); return; }
  try {
    const u = await gameContract.users(userAddress);
    if (!u[1]) { showToast("Please Register in Referral Panel below!"); document.getElementById('referralPanel').scrollIntoView({behavior:"smooth"}); return; }
  } catch (e) { console.warn("check users err", e); }
  if (currentSelectedAnimal.index === -1) { showToast("Select Animal First"); return; }
  document.getElementById("modalAnimalName").innerText = currentSelectedAnimal.name.toUpperCase();
  document.getElementById('paymentModal').style.display = 'flex';
}

function closeModal(id){ document.getElementById(id).style.display = 'none'; }

async function processPayment(currencyType){
  if (currentSelectedAnimal.index === -1) return;
  const idx = currentSelectedAnimal.index;
  closeModal('paymentModal');
  showToast(`Processing ${currencyType}...`);
  try {
    let tx;
    if (currencyType === 'ETH') {
      const val = ethers.parseEther("0.0005");
      tx = await gameContract.betETH(idx, { value: val });
    } else if (currencyType === 'USDT') {
      const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
      const amount = ethers.parseUnits("10", 6);
      await checkApprove(usdt, amount);
      tx = await gameContract.betToken(idx, 1, false);
    } else if (currencyType === 'SHIB') {
      const shib = new ethers.Contract(SHIB_ADDRESS, ERC20_ABI, signer);
      const amount = ethers.parseUnits("110000", 18);
      await checkApprove(shib, amount);
      tx = await gameContract.betToken(idx, 2, false);
    } else if (currencyType === 'FREE') {
      tx = await gameContract.betToken(idx, 2, true);
    } else {
      throw new Error("Unknown currency");
    }
    showToast("Sending transaction...");
    await tx.wait();
    showToast("Bet placed!");
    await refreshGameData();
  } catch (err) {
    console.error("processPayment err", err);
    showToast("Failed: " + (err?.reason || err?.message || "Error"));
  }
}

async function checkApprove(tokenContract, amountNeeded){
  try {
    const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESS);
    if (BigInt(allowance) < BigInt(amountNeeded)) {
      showToast("Approving token...");
      const tx = await tokenContract.connect(signer).approve(CONTRACT_ADDRESS, ethers.MaxUint256);
      await tx.wait();
      showToast("Approve confirmed");
    }
  } catch (e) {
    console.error("approve err", e);
    throw e;
  }
}

/* ---------- SPIN ANIMATION ---------- */
function startSpinAnimation(){
  forceStopAnimation();
  const reels = [document.getElementById('imgReel1'), document.getElementById('imgReel2'), document.getElementById('imgReel3')];
  reels.forEach((reel, index) => {
    let speed = 70 + index * 20;
    const intv = setInterval(()=> {
      const r = Math.floor(Math.random() * IMAGE_LIST.length);
      reel.src = IMAGE_LIST[r];
    }, speed);
    spinIntervals.push(intv);
  });
}

function stopSpinAnimation(i1,i2,i3){
  spinIntervals.forEach(clearInterval); spinIntervals = [];
  const r1 = document.getElementById('imgReel1'), r2 = document.getElementById('imgReel2'), r3 = document.getElementById('imgReel3');
  r1.style.filter = "blur(2px)"; setTimeout(()=>{ r1.src = IMAGE_LIST[i1]; r1.style.filter = "none"; }, 120);
  r2.style.filter = "blur(4px)"; let t2 = setInterval(()=> { r2.src = IMAGE_LIST[Math.floor(Math.random()*IMAGE_LIST.length)]; }, 80); spinIntervals.push(t2);
  setTimeout(()=>{ clearInterval(t2); r2.src = IMAGE_LIST[i2]; r2.style.filter = "none"; }, 600);
  r3.style.filter = "blur(5px)"; let t3 = setInterval(()=> { r3.src = IMAGE_LIST[Math.floor(Math.random()*IMAGE_LIST.length)]; }, 80); spinIntervals.push(t3);
  setTimeout(()=>{ clearInterval(t3); r3.src = IMAGE_LIST[i3]; r3.style.filter = "none"; r3.style.transform = "scale(1.12)"; setTimeout(()=>{ r3.style.transform = "scale(1)"; }, 220); }, 1400);
}

function forceStopAnimation(){
  spinIntervals.forEach(clearInterval); spinIntervals = [];
  document.querySelectorAll('.reel-img').forEach(img => { img.style.filter='none'; img.style.transform='scale(1)'; img.src='what.svg'; });
}

/* ---------- EXECUTE DRAW (Tx) ---------- */
async function executeDraw() {
  try {
    if (!isConnected) { showToast("Connect wallet to execute draw"); return; }
    showToast("Sending executeDraw...");
    const tx = await gameContract.executeDraw();
    // Start client spin animation immediately for UX
    startSpinAnimation();
    spinStartTime = Date.now();
    await tx.wait();
    showToast("Draw broadcasted. Awaiting result event...");
    // result is handled by BattleResult event listener
  } catch (e) {
    console.error("executeDraw err", e);
    forceStopAnimation();
    showToast("Draw failed: " + (e?.reason || e?.message || "Error"));
  }
}

/* ---------- EVENT LISTENERS ---------- */
function setupEventListeners(){
  if (!listenerContract) return;
  // Remove old listeners to avoid duplicates
  try { listenerContract.removeAllListeners("NewBet"); listenerContract.removeAllListeners("BattleResult"); } catch(e){}

  // NewBet ‚Üí refresh small
  listenerContract.on("NewBet", (...args) => {
    console.log("NewBet event", args);
    try { refreshGameData(); } catch(e){ console.warn(e); }
  });

  // BattleResult ‚Üí show animation & reveal after MIN_SPIN_TIME
  listenerContract.on("BattleResult", async (reels, outcome, roundId) => {
    try {
      const rId = Number(roundId);
      console.log("BattleResult", reels, outcome, rId);
      // If not spinning yet -> start local spin
      if (!spinIntervals.length) { startSpinAnimation(); spinStartTime = Date.now(); }
      if (spinStartTime === 0) spinStartTime = Date.now();
      const elapsed = Date.now() - spinStartTime;
      const remaining = MIN_SPIN_TIME - elapsed;
      const delay = remaining > 0 ? remaining : 0;
      if (delay > 0) showToast(`Revealing winner in ${Math.ceil(delay/1000)}s...`);
      await new Promise(res => setTimeout(res, delay));
      const r1 = Number(reels[0]), r2 = Number(reels[1]), r3 = Number(reels[2]);
      stopSpinAnimation(r1,r2,r3);
      showToast(`Result: ${outcome}`);
      const winnersIndices = new Set([r1,r2,r3]);
      for (let i=0;i<6;i++){
        const c = document.getElementById(`card-${i}`);
        if (c) {
          if (winnersIndices.has(i)) c.classList.add('winner-glamour'); else c.classList.remove('winner-glamour');
        }
      }
      setTimeout(()=>{ for(let i=0;i<6;i++){ const c=document.getElementById(`card-${i}`); if(c) c.classList.remove('winner-glamour'); } },8000);
      spinStartTime = 0;
      await refreshGameData();
    } catch (e) { console.error("BattleResult handler", e); forceStopAnimation(); }
  });

  // Optional: catch provider disconnect and attempt reconnect
  if (wssProvider && wssProvider._websocket) {
    wssProvider._websocket.onclose = (ev)=> {
      console.warn("WSS closed", ev);
      // try reconnect after short delay
      setTimeout(()=> trySetupWss(), 2000);
    }
  }
}

/* ---------- HISTORY + WINNERS ---------- */
/* fetchBatchHistory / fetchWinnersFromContract kept similar to yours but with safe guards */
async function fetchBatchHistory(count){
  const historyList = document.getElementById('historyList');
  // get current round id
  try {
    const curr = Number(await gameContract.currentRoundId());
    if (historyCursor === 0) historyCursor = curr - 1;
    if (historyCursor < 1) { document.getElementById('btnLoadMore').style.display = 'none'; return; }
    const start = historyCursor;
    const end = Math.max(1, historyCursor - count + 1);
    const promises = [];
    for (let r = start; r >= end; r--) {
      if (document.getElementById(`history-card-${r}`)) continue;
      promises.push(gameContract.getRoundResult(r).then(res => ({r,res})).catch(()=>null));
    }
    const results = (await Promise.all(promises)).filter(x=>x!==null);
    for (const item of results) {
      const { r, res } = item;
      const card = document.createElement('div'); card.className='history-card'; card.id = `history-card-${r}`;
      card.innerHTML = `
        <div style="font-size:0.8em; color:#aaa; margin-bottom:5px;">Round #${r} ‚Ä¢ ${new Date(Number(res.timestamp)*1000).toLocaleTimeString()}</div>
        <div class="history-reels">
          <img class="history-reel-img" src="${IMAGE_LIST[Number(res.reels[0])]}">
          <img class="history-reel-img" src="${IMAGE_LIST[Number(res.reels[1])]}">
          <img class="history-reel-img" src="${IMAGE_LIST[Number(res.reels[2])]}">
        </div>
        <div class="history-outcome" style="margin-top:5px;">${formatOutcomeText(res.outcome, res.reels)}</div>
        <div id="winner-info-${r}" style="margin-top:8px; border-top:1px dashed #444; padding-top:5px; min-height:20px;"><span style="font-size:0.7em; color:#555;">Loading...</span></div>
        <div class="social-bar"> ... </div>
      `;
      historyList.appendChild(card);
    }
    // fetch winners details for those rounds (last 100 global wins scan) ‚Äî heavy, consider contract helper
    await fetchWinnersFromContract(start, end);
    historyCursor = end - 1;
    if (historyCursor < 1) document.getElementById('btnLoadMore').style.display = 'none';
  } catch (e) {
    console.error("fetchBatchHistory", e);
  }
}

async function fetchWinnersFromContract(maxRound, minRound){
  // WARNING: This tries to scan latest ~100 entries; if globalWinHistory is huge this is heavy.
  try {
    if (globalHistoryLength === -1) {
      // try linear probe up to a reasonable bound
      globalHistoryLength = 0;
      while (true) {
        try { await gameContract.globalWinHistory(globalHistoryLength); globalHistoryLength++; if (globalHistoryLength > 5000) break; } catch(e){ break; }
      }
    }
    if (globalHistoryLength === 0) return;
    const endScan = globalHistoryLength - 1;
    const startScan = Math.max(0, endScan - 100);
    const promises = [];
    for (let i = endScan; i >= startScan; i--) promises.push(gameContract.globalWinHistory(i).catch(()=>null));
    const winnersData = (await Promise.all(promises)).filter(x=>x);
    const map = {};
    for (const d of winnersData) {
      const rId = Number(d[3]);
      if (rId <= maxRound && rId >= minRound) {
        if (!map[rId]) map[rId] = {eth:0n,usdt:0n,shib:0n, topAddr:d[0], topAmt:d[1]};
        if (Number(d[2])===0) map[rId].eth += d[1]; else if (Number(d[2])===1) map[rId].usdt += d[1]; else map[rId].shib += d[1];
        if (d[1] > map[rId].topAmt) { map[rId].topAmt = d[1]; map[rId].topAddr = d[0]; }
      }
    }
    // render
    for (let r=maxRound; r>=minRound; r--) {
      const div = document.getElementById(`winner-info-${r}`); if (!div) continue;
      if (!map[r]) { div.innerHTML = '<span style="font-size:0.7em; color:#666;">No Winners</span>'; continue; }
      const d = map[r];
      let pay = "";
      if (d.eth>0n) pay += `<div style="color:#627EEA">+${parseFloat(ethers.formatEther(d.eth)).toFixed(4)} ETH</div>`;
      if (d.usdt>0n) pay += `<div style="color:#26A17B">+${parseFloat(ethers.formatUnits(d.usdt,6)).toFixed(2)} USDT</div>`;
      if (d.shib>0n) pay += `<div style="color:#FFA409">+${parseFloat(ethers.formatUnits(d.shib,18)).toLocaleString()} SHIB</div>`;
      div.innerHTML = `<div class="winner-info-box"><div style="display:flex;justify-content:space-between;"><div style="text-align:left;"><div style="font-size:0.65em;color:#888">WINNER</div><div style="color:var(--gold);font-weight:bold">${d.topAddr.substring(0,6)}...</div></div><div style="text-align:right;font-weight:bold">${pay}</div></div></div>`;
      // try replace topAddr with nickname if exists
      gameContract.users(d.topAddr).then(u => { if (u && u[0]) { const el = div.querySelector('.winner-info-box div > div > div:nth-child(2)'); if(el) el.innerText = `üèÜ ${u[0]}`; } }).catch(()=>{});
    }
  } catch (e) { console.error("fetchWinnersFromContract", e); }
}

/* ---------- PERSONAL HISTORY ---------- */
async function updatePersonalHistory(){
  const list = document.getElementById('personalHistoryList');
  if (!isConnected || !userAddress) { list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Connect Wallet to view history</div>'; return; }
  list.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">Loading data...</div>';
  try {
    const wins = [];
    let idx = 0;
    while (true) {
      try {
        const w = await gameContract.userWinHistory(userAddress, idx);
        wins.push({ amount: w[1], curr: Number(w[2]), roundId: Number(w[3]), timestamp: Number(w[4]), outcome: w[5] });
        idx++;
        if (idx >= 50) break; // safety limit
      } catch (e) { break; }
    }
    if (wins.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No winning history yet.</div>'; return; }
    list.innerHTML = '';
    const reversed = wins.reverse();
    for (const win of reversed) {
      const symbol = win.curr === 0 ? "ETH" : (win.curr === 1 ? "USDT" : "SHIB");
      const decimal = win.curr === 1 ? 6 : 18;
      const val = parseFloat(ethers.formatUnits(win.amount, decimal));
      const valStr = win.curr === 2 ? val.toLocaleString() : (val < 0.001 ? val.toFixed(6) : val.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:4}));
      const colorHex = win.curr === 0 ? "#627EEA" : (win.curr===1? "#26A17B" : "#FFA409");
      const el = document.createElement('div'); el.className='personal-bet-card';
      el.innerHTML = `<div class="pb-info"><div class="pb-time">Round #${win.roundId} ‚Ä¢ ${new Date(win.timestamp*1000).toLocaleString()}</div><div style="font-weight:bold; color:var(--text);">Result: <span style="color:var(--accent);">${win.outcome}</span></div></div><div style="text-align:right;"><span class="badge badge-win" style="border-color:var(--gold); color:var(--gold);">üèÜ VICTORY</span><div style="margin-top:5px;font-weight:bold;color:${colorHex};font-size:1.1em;">+ ${valStr} <span style="font-size:0.7em">${symbol}</span></div></div>`;
      list.appendChild(el);
    }
  } catch (e) { console.error("updatePersonalHistory", e); list.innerHTML = '<div style="text-align:center; color:var(--danger); padding:10px;">Network Error</div>'; }
}

/* ---------- REFERRAL COUNT ---------- */
async function updateReferralCount(){
  if (!isConnected || !userAddress) return;
  try {
    const filter = gameContract.filters.ReferralLinked(null, userAddress);
    // choose a safe start block to limit scanning (tune for your deployment)
    const safeStartBlock = 18000000;
    const logs = await gameContract.queryFilter(filter, safeStartBlock, "latest");
    document.getElementById('totalInvited').innerText = logs.length;
  } catch (e) { console.warn("updateReferralCount failed", e); document.getElementById('totalInvited').innerText = "0"; }
}

/* ---------- REGISTER / CLAIM / WITHDRAW ---------- */
async function registerUser(){
  const nick = document.getElementById('panelRegNick').value;
  if (!nick || nick.length < 3) { showToast("Nickname min 3 chars!"); return; }
  try {
    showToast("Registering...");
    const tx = await gameContract.register(nick, detectedReferrer || "");
    await tx.wait();
    showToast("Registration Success!");
    await refreshGameData();
  } catch (e) {
    console.error("registerUser", e);
    showToast("Reg failed: " + (e?.reason || e?.message || "Error"));
  }
}

async function claimReferralBonus(){
  try {
    const tx = await gameContract.claimReferralBonus();
    await tx.wait();
    showToast("Bonus claimed!");
    await refreshGameData();
  } catch (e) { console.error("claimReferralBonus", e); showToast("Claim failed"); }
}

async function withdraw(curr){
  try {
    showToast("Withdrawing...");
    const cIdx = curr === 'ETH' ? 0 : (curr === 'USDT' ? 1 : 2);
    const bal = await gameContract.userCredits(userAddress, cIdx);
    if (BigInt(bal) === 0n) { showToast("No balance"); return; }
    const tx = await gameContract.withdrawCredit(cIdx, bal);
    await tx.wait();
    showToast("Withdraw OK");
    openWalletDashboard();
  } catch (e) {
    console.error("withdraw", e);
    showToast("Withdraw failed: " + (e?.reason || e?.message || "Error"));
  }
}

/* ---------- WALLET DASHBOARD & UI HELPERS ---------- */
async function openWalletDashboard(){
  if (!isConnected || !userAddress) { showToast("Connect wallet"); return; }
  document.getElementById('walletInfoModal').style.display = 'flex';
  document.getElementById('dashAddress').innerText = userAddress;
  try {
    const balEth = await rpcProvider.getBalance(userAddress);
    document.getElementById('balETH').innerText = parseFloat(ethers.formatEther(balEth)).toFixed(4);
    const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, rpcProvider);
    const balUsdt = await usdt.balanceOf(userAddress);
    document.getElementById('balUSDT').innerText = parseFloat(ethers.formatUnits(balUsdt,6)).toFixed(2);
    const shib = new ethers.Contract(SHIB_ADDRESS, ERC20_ABI, rpcProvider);
    const balShib = await shib.balanceOf(userAddress);
    document.getElementById('balSHIB').innerText = parseFloat(ethers.formatUnits(balShib,18)).toFixed(2);
    const credEth = await gameContract.userCredits(userAddress, 0);
    document.getElementById('credETH').innerText = parseFloat(ethers.formatEther(credEth)).toFixed(4);
    const credUsdt = await gameContract.userCredits(userAddress, 1);
    document.getElementById('credUSDT').innerText = parseFloat(ethers.formatUnits(credUsdt,6)).toFixed(2);
    const credShib = await gameContract.userCredits(userAddress, 2);
    document.getElementById('credSHIB').innerText = parseFloat(ethers.formatEther(credShib)).toFixed(2);
  } catch (e) { console.error("openWalletDashboard", e); }
}

function disconnectWallet(){ try { if (listenerContract) listenerContract.removeAllListeners(); } catch{} localStorage.removeItem(`auth_${userAddress}`); location.reload(); }
function copyRefLink(){ navigator.clipboard.writeText(document.getElementById('displayRefLink').innerText); showToast("Copied"); }

/* ---------- UTILS ---------- */
function showToast(msg){
  const t = document.getElementById("toast"); t.innerText = msg; t.className = "show";
  setTimeout(()=>{ t.className = t.className.replace("show",""); }, 3000);
}

function switchTab(tab){
  if (tab === 'global'){ document.getElementById('tabGlobal').classList.remove('hidden'); document.getElementById('tabPersonal').classList.add('hidden'); document.querySelectorAll('.tab-btn')[0].classList.add('active'); document.querySelectorAll('.tab-btn')[1].classList.remove('active'); }
  else { document.getElementById('tabGlobal').classList.add('hidden'); document.getElementById('tabPersonal').classList.remove('hidden'); document.querySelectorAll('.tab-btn')[0].classList.remove('active'); document.querySelectorAll('.tab-btn')[1].classList.add('active'); updatePersonalHistory(); }
}

/* ---------- HISTORY UI ---------- */
async function updateHistorySection(roundId) {
  historyCursor = roundId - 1;
  if (isInitialLoad) { document.getElementById('historyList').innerHTML = ''; await fetchBatchHistory(10); isInitialLoad = false; }
  else { document.getElementById('historyList').innerHTML = ''; await fetchBatchHistory(10); }
}

async function loadMoreHistory(){ const btn = document.getElementById('btnLoadMore'); btn.disabled = true; btn.innerText = "Loading..."; await fetchBatchHistory(15); btn.innerText="Load Previous Rounds (15)"; btn.disabled = false; }

/* ========== END SCRIPT ========== */
          </script>
