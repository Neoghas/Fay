<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto - Nickname Market</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #00d2ff;
            --accent: #ff007a;
            --bg: #0f1016;
            --card: #1a1b26;
            --gold: #ffd700;
            --success: #00ff9d;
        }
        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 20px;
        }
        
        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 20px;
        }
        .btn-connect {
            background: var(--primary); color: #000; border: none; padding: 8px 15px;
            border-radius: 8px; cursor: pointer; font-weight: bold;
        }

        /* --- GRID LAYOUT (REVISI) --- */
        .market-grid {
            display: grid;
            /* MOBILE DEFAULT: 2 Kolom (1fr 1fr) */
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; /* Jarak antar kartu lebih rapat di HP */
        }

        /* --- PREMIUM CARD STYLES --- */
.nick-card {
    background: linear-gradient(145deg, #1a1b26, #111); /* Gradasi background halus */
    border: 1px solid #333;
    padding: 15px;
    border-radius: 16px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

.nick-card:hover {
    transform: translateY(-5px) scale(1.02);
    border-color: var(--gold);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.15); /* Glow Emas tipis */
}

/* Header: Avatar & Seller */
.card-header-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-bottom: 8px;
}

.seller-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid var(--primary);
    object-fit: cover;
    background: #000;
}

.seller-info {
    display: flex;
    flex-direction: column;
}

.seller-label { font-size: 0.65em; color: #666; text-transform: uppercase; }
.seller-address { font-size: 0.85em; color: #aaa; font-family: monospace; }

/* Body: Premium Nickname */
.nick-title-premium {
    font-size: 1.6em;
    font-weight: 900;
    margin-bottom: 5px;
    text-align: center;
    /* Efek Emas Mengkilap */
    background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 0px rgba(0,0,0,0.5));
    letter-spacing: 1px;
}

/* Info Bar: Time & Price */
.info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0,0,0,0.3);
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 0.8em;
}

.time-info { color: #888; display: flex; align-items: center; gap: 4px; }
.price-tag { color: var(--success); font-weight: bold; font-size: 1.1em; }
        
        /* Typography Adjustment untuk Mobile */
        .nick-title { 
            font-size: 1.1em; /* Font judul diperkecil sedikit */
            font-weight: 900; 
            background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 0px rgba(0,0,0,0.5)); 
            margin-bottom: 5px;
            white-space: nowrap; /* Mencegah judul turun baris */
            overflow: hidden;
            text-overflow: ellipsis; /* Titik-titik jika kepanjangan */
        }
        
        .nick-seller {
            font-size: 0.75em; 
            color: #888; 
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Biar address panjang jadi 0x123... */
        }

        .nick-price { 
            color: var(--success); 
            font-size: 1em; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        
        /* Tombol Action */
        .btn-action {
            width: 100%; padding: 8px; border: none; border-radius: 6px;
            font-weight: bold; cursor: pointer; margin-top: auto; font-size: 0.8em;
        }
        .btn-buy { background: var(--success); color: black; }
        .btn-sell { background: var(--accent); color: white; }
        .btn-use { background: var(--primary); color: black; }
        .btn-cancel { background: #555; color: white; }

        /* --- TAMPILAN PC (LAYAR LEBAR) --- */
        @media (min-width: 800px) {
            .market-grid {
                /* PC MODE: 4 Kolom */
                grid-template-columns: repeat(4, 1fr); 
                gap: 15px;
            }
            .nick-card { padding: 15px; }
            .nick-title { font-size: 1.4em; }
            .btn-action { font-size: 1em; padding: 10px; }
        }
        
        .btn-buy { background: var(--success); color: black; }
        .btn-sell { background: var(--accent); color: white; }
        .btn-use { background: var(--primary); color: black; }
        .btn-cancel { background: #555; color: white; }

        /* INPUT SELL */
        .sell-input {
            width: 100%; padding: 8px; margin-bottom: 8px;
            background: #111; border: 1px solid #444; color: white; border-radius: 5px;
        }

        /* Pastikan CSS ini ada di dalam <style> */
.history-section { margin-top: 20px; }
.table-responsive { overflow-x: auto; }
.market-table { width: 100%; border-collapse: collapse; background: #15161c; border-radius: 8px; margin-top: 10px; }
.market-table th, .market-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #2a2b36; }
.market-table th { background-color: #222; color: #888; text-transform: uppercase; font-size: 0.85em; }
        
.badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
/* --- 1. SETUP WARNA (Sell = Hijau, Buy = Biru) --- */

/* 1. Badge SELL - ON SALE (Hijau) */
.badge-sell-active {
    background: rgba(0, 255, 157, 0.1); 
    color: #00ff9d;                     
    border: 1px solid #00ff9d;          
}

/* 2. Badge SELL - SOLDOUT (Merah) - INI YANG BARU */
.badge-sell-sold {
    background: rgba(255, 77, 77, 0.1); 
    color: #ff4d4d;                     
    border: 1px solid #ff4d4d;          
}

/* 3. Badge BUY (Biru) */
.badge-buy {
    background: rgba(0, 210, 255, 0.1); 
    color: #00d2ff;                     
    border: 1px solid #00d2ff;          
}

/* --- 2. SETUP STATUS TEKS --- */

/* Status: On Sale üõí (Hijau) */
.status-sale {
    color: #00ff9d; 
    font-weight: bold;
}

/* Status: SOLDOUT ‚úÖ (Merah) */
.status-sold {
    color: #ff4d4d; /* Merah Neon */
    font-weight: bold;
}

/* Status: Taken ‚úÖ / Hasil Buy (Biru) */
.status-success {
    color: #00d2ff; /* Biru Neon */
    font-weight: bold;
}

    /* --- TABS (FIXED LAYOUT) --- */
        .market-tabs { 
            display: flex; 
            width: 100%;        /* Pastikan lebar penuh */
            gap: 10px;          /* Jarak antar tombol */
            margin-bottom: 20px; 
            flex-direction: row; /* Paksa arah horizontal */
            flex-wrap: nowrap;   /* KUNCI: Dilarang turun baris (tumpang tindih) */
        }

        .tab-btn {
            flex: 1;            /* Membagi lebar sama rata (50% : 50%) */
            min-width: 0;       /* Mencegah tombol melebar melebihi container */
            
            padding: 8px 5px;   /* Padding tipis agar tidak terlalu tinggi */
            
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: #aaa; 
            cursor: pointer; 
            border-radius: 12px; 
            
            /* Typography */
            font-weight: 700;
            font-size: 0.8em;   /* Ukuran font pas untuk HP */
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            white-space: nowrap; /* Teks dilarang terpotong ke bawah */
            
            /* Flex Layout Internal Tombol */
            display: flex;             
            align-items: center;       
            justify-content: center;   
            gap: 6px; 
            transition: all 0.3s ease; 
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-btn.active {
            background: var(--primary); 
            color: #000;                
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 210, 255, 0.3); 
            transform: translateY(-1px); 
        }

        /* Tweak Khusus Layar Sangat Kecil (HP Sempit) */
        @media (max-width: 380px) {
            .tab-btn {
                font-size: 0.7em; /* Kecilkan font sedikit lagi jika HP sempit */
                gap: 4px;
            }
        }

        /* --- PREMIUM SEARCH BAR --- */
.search-container {
    margin-bottom: 20px;
    position: relative;
}

.search-wrapper {
    display: flex;
    align-items: center;
    background: rgba(25, 26, 35, 0.8); /* Gelap Transparan */
    border: 1px solid #333;
    border-radius: 12px;
    padding: 12px 15px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.search-wrapper:focus-within {
    border-color: var(--primary); /* Glow Biru saat aktif */
    box-shadow: 0 0 15px rgba(0, 210, 255, 0.2);
    transform: translateY(-2px);
}

.search-icon {
    font-size: 1.2em;
    margin-right: 10px;
    filter: grayscale(100%);
    opacity: 0.7;
}

#searchInput {
    width: 100%;
    background: transparent;
    border: none;
    color: white;
    font-size: 1em;
    font-weight: 500;
    outline: none;
}

#searchInput::placeholder {
    color: #555;
    font-style: italic;
}

        /* --- TOMBOL CLEAR FUTURISTIK --- */
.search-clear {
    font-size: 1.2em;
    color: #555;
    cursor: pointer;
    
    /* Keadaan Awal: Tersembunyi & Kecil */
    opacity: 0;
    visibility: hidden;
    transform: scale(0.5) rotate(-90deg);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efek membal (Bouncy) */
    
    margin-left: 10px;
    padding: 5px;
}

/* Keadaan Aktif: Muncul */
.search-clear.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1) rotate(0deg); /* Normal */
    color: #888;
}

/* Keadaan Hover: Berputar & Menyala Merah */
.search-clear.visible:hover {
    color: #ff0055; /* Merah Neon */
    text-shadow: 0 0 10px rgba(255, 0, 85, 0.6); /* Efek Glow */
    transform: scale(1.2) rotate(90deg); /* Animasi Putar Mekanis */
}

        /* GAYA ICON GAMBAR (PNG) - KEMBALI KE STYLE GRAY */
.search-icon-img {
    width: 24px;
    height: 24px;
    margin-right: 10px;
    
    /* Membuat icon jadi abu-abu */
    filter: grayscale(100%); 
    
    /* Transparansi agar tidak terlalu mencolok (menyatu dengan background) */
    opacity: 0.6; 
    
    transition: all 0.3s ease;
}

/* OPSI TAMBAHAN: Biar icon menyala/berwarna saat diklik */
.search-wrapper:focus-within .search-icon-img {
    filter: grayscale(0%); /* Warna asli muncul saat mengetik */
    opacity: 1;
}

.search-clear-img {
    width: 15px;
    height: 15px;
    cursor: pointer;
    margin-left: 10px;
    
    /* Animasi (Sama seperti sebelumnya) */
    opacity: 0;
    visibility: hidden;
    transform: scale(0.5) rotate(-90deg);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* State Visible */
.search-clear-img.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1) rotate(0deg);
}

        /* --- NOTIFIKASI HASIL PENCARIAN KOSONG --- */
.no-results-box {
    grid-column: 1 / -1; /* Wajib: Agar pesan mengisi lebar penuh grid */
    text-align: center;
    padding: 50px 20px;
    background: rgba(255, 255, 255, 0.02);
    border: 1px dashed rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    margin-top: 20px;
    
    /* Animasi Muncul */
    opacity: 0;
    animation: fadeIn 0.5s forwards;
}

@keyframes fadeIn {
    to { opacity: 1; }
}

.no-results-icon {
    /* Hapus font-size lama */
    margin-bottom: 15px;
    display: flex;           /* Gunakan flex biar ketengah */
    justify-content: center; /* Gunakan flex biar ketengah */
}

/* Tambahkan style khusus untuk gambarnya */
.no-results-icon img {
    width: 80px;    /* Atur ukuran gambar (sesuaikan selera) */
    height: auto;
    /* Efek Futuristik: */
    filter: grayscale(80%) opacity(0.6) drop-shadow(0 0 10px rgba(0, 210, 255, 0.3));
    transition: all 0.3s ease;
}

.no-results-text {
    font-size: 1.1em;
    color: #888;
    font-weight: bold;
}

.no-results-sub {
    font-size: 0.85em;
    color: #555;
    margin-top: 5px;
}

.no-results-box:hover .no-results-icon img {
    filter: grayscale(0%) opacity(1) drop-shadow(0 0 15px rgba(0, 210, 255, 0.6));
    transform: scale(1.05);
}
        
    </style>
</head>
<body>

    <header>
        <a href="index">Back to Game</a>
        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">Connect Wallet</button>
    </header>

    <div class="market-tabs">
        <button class="tab-btn active" onclick="switchTab('buy')" id="tab-buy">üõí Global Market</button>
        <button class="tab-btn" onclick="switchTab('inventory')" id="tab-inventory">üéí My Inventory</button>
    </div>

    <div class="search-container">
    <div class="search-wrapper">
    <img src="search.png" class="search-icon-img">
    <input type="text" id="searchInput" placeholder="Search nickname..." onkeyup="filterMarket()" oninput="toggleClear()">      
    <img src="x.svg" id="clearBtn" class="search-clear-img" onclick="clearSearch()">
        </div>
    </div>

    <div id="view-buy" class="market-view">
        <div id="market-list" class="market-grid">
            <div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">
                Scanning Listings... <br> (This may take a few seconds)
            </div>
        </div>
    </div>

    <div id="view-inventory" class="market-view" style="display:none;">
    
    <div style="background:rgba(0, 210, 255, 0.1); border:1px solid var(--primary); padding:15px; border-radius:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <div style="font-size:0.8em; color:#aaa;">CURRENT ACTIVE NICKNAME</div>
            <div id="active-nick-display" style="font-size:1.5em; font-weight:bold; color:white;">-</div>
        </div>
        <div style="color:var(--success); font-weight:bold;">‚úÖ IN USE</div>
    </div>

    <h3 style="color:#aaa; border-bottom:1px solid #333; padding-bottom:10px;">Collection & Sell</h3>
    <div id="inventory-list" class="market-grid">
        <div style="grid-column:1/-1; text-align:center; color:#666;">Loading inventory...</div>
    </div>

    <div class="history-section">
        <h3 style="color:var(--gold); border-bottom:1px solid #333; padding-bottom:10px; margin-top:30px;">
            üìú Market Status & History
        </h3>
        <div class="table-responsive">
    <table class="market-table">
        <thead>
            <tr>
                <th>Type</th>
                <th>Nickname</th>
                <th>Price</th>
                <th>Status</th>
                <th>Date</th> </tr>
        </thead>
        <tbody id="history-body">
            <tr><td colspan="5" style="text-align:center;">Loading history...</td></tr>
        </tbody>
    </table>
        </div>
    </div>

    </div>

    <script>
        // --- 1. CONFIGURATION ---
    const CONTRACT_ADDRESS = "0x8F1Dc1362fa27115094471DC71a00752D6fF8F07"; 

    // Konfigurasi Base Sepolia
    const BASE_SEPOLIA_CHAIN_ID = '0x14a34'; // 84532 dalam Hex
    const BASE_SEPOLIA_CONFIG = {
        chainId: BASE_SEPOLIA_CHAIN_ID,
        chainName: 'Base Sepolia Testnet',
        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
        rpcUrls: ['https://sepolia.base.org'],
        blockExplorerUrls: ['https://sepolia.basescan.org']
    };

    // PASTE ABI V4 DISINI
    const GAME_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_shibToken","type":"address"},{"internalType":"address","name":"_priceFeedETH","type":"address"},{"internalType":"address","name":"_priceFeedUSDT","type":"address"},{"internalType":"address","name":"_priceFeedSHIB","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"indexed":false,"internalType":"string","name":"outcome","type":"string"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"BattleResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BonusClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"oldCollector","type":"address"},{"indexed":false,"internalType":"address","name":"newCollector","type":"address"}],"name":"FeeCollectorUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint8","name":"animalChoice","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NewBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameDelisted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameListed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"oldPrice","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"NicknamePriceUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameSold","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"RatingSubmitted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"reactionType","type":"uint8"}],"name":"ReactionUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"referrer","type":"address"},{"indexed":false,"internalType":"uint256","name":"newCount","type":"uint256"}],"name":"ReferralCountIncreased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"invitee","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralLinked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"UserRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"curr","type":"uint8"},{"indexed":false,"internalType":"bool","name":"isRealTransfer","type":"bool"}],"name":"WinDistributed","type":"event"},{"inputs":[],"name":"COST_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_MAIN","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_PLATFORM_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TOTAL_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_REFERRALS_REQUIRED","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TEAMS_ACTIVE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BONUS_AMOUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"","type":"uint8"}],"name":"activeTeamCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"},{"internalType":"string","name":"_imageCid","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"}],"name":"betETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"bool","name":"_isFreeBet","type":"bool"}],"name":"betToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"buyNickname","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"cancelSale","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralBonus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"commentCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"dislikeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint256","name":"_cId","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"},{"internalType":"string","name":"_newImage","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"name":"emergencyWithdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeDraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeShibCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getActiveTeamCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getBonusBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentJackpot","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getGlobalWinCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLeaderboardReferral","outputs":[{"components":[{"internalType":"address","name":"userAddr","type":"address"},{"internalType":"uint256","name":"score","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"avatarUrl","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSlotBattleUltimate.LeaderboardData[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLeaderboardWinners","outputs":[{"components":[{"internalType":"address","name":"userAddr","type":"address"},{"internalType":"uint256","name":"score","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"avatarUrl","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSlotBattleUltimate.LeaderboardData[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"}],"name":"getRoundResult","outputs":[{"components":[{"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"internalType":"struct FaylottoSlotBattleUltimate.RoundResultData","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserTotalWinnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserWinCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"globalWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"","type":"uint8"}],"name":"jackpots","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"myNicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickMarketplace","outputs":[{"internalType":"bool","name":"isForSale","type":"bool"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"address","name":"seller","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nicknameToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_referrerNick","type":"string"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"enum FaylottoSlotBattleUltimate.BetType","name":"bType","type":"uint8"},{"internalType":"uint8","name":"animalChoice","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageCid","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundHistory","outputs":[{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"uint256","name":"_price","type":"uint256"}],"name":"sellNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_url","type":"string"}],"name":"setAvatar","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_reaction","type":"uint8"}],"name":"setReaction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"shibToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_stars","type":"uint8"}],"name":"submitRating","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_newNick","type":"string"}],"name":"switchNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"topReferrers","outputs":[{"internalType":"address","name":"userAddr","type":"address"},{"internalType":"uint256","name":"score","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"avatarUrl","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"topWinners","outputs":[{"internalType":"address","name":"userAddr","type":"address"},{"internalType":"uint256","name":"score","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"avatarUrl","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"","type":"uint8"}],"name":"userCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRatings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userReactions","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"hasBet","type":"bool"},{"internalType":"uint256","name":"pendingRefBonusCount","type":"uint256"},{"internalType":"uint256","name":"totalReferrals","type":"uint256"},{"internalType":"bool","name":"bonusClaimed","type":"bool"},{"internalType":"uint256","name":"wonETH","type":"uint256"},{"internalType":"uint256","name":"wonUSDT","type":"uint256"},{"internalType":"uint256","name":"wonSHIB","type":"uint256"},{"internalType":"string","name":"avatarUrl","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawCredit","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    const DEPLOY_BLOCK = 34655685;
        
    let provider, signer, gameContract;
    let userAddress = null;

    // --- 2. CORE FUNCTIONS (UPDATED) ---

    async function connectWallet() {
        if (window.ethereum) {
            try {
                // A. PAKSA GANTI JARINGAN KE BASE SEPOLIA (Sama seperti sebelumnya)
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [BASE_SEPOLIA_CONFIG],
                            });
                        } catch (addError) { return; }
                    } else { return; }
                }

                // B. SETUP PROVIDER
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // C. LOGIKA CACHE SIGNATURE (1 BULAN)
                const STORAGE_KEY = `faylotto_session_${userAddress}`; // Kunci unik per wallet
                const cachedSession = localStorage.getItem(STORAGE_KEY);
                let isSessionValid = false;

                // 1. Cek apakah ada data tersimpan?
                if (cachedSession) {
                    const data = JSON.parse(cachedSession);
                    const now = Date.now();
                    
                    // 2. Cek apakah masih berlaku (belum expired)?
                    if (now < data.expiry) {
                        console.log("‚úÖ Auto-Login: Signature valid dari Local Storage.");
                        isSessionValid = true;
                    } else {
                        console.log("‚ö†Ô∏è Sesi habis, meminta tanda tangan ulang...");
                        localStorage.removeItem(STORAGE_KEY); // Hapus yang lama
                    }
                }

                // 3. Jika Tidak Valid / Belum Ada, Minta Tanda Tangan Baru
                if (!isSessionValid) {
                    const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const localTime = new Date().toLocaleString();
                    const uniqueCode = Date.now();
                    
                    const message = `Welcome To Faylotto Market\n\nUser: ${userAddress}\nZone: ${timeZone} (${localTime})\nCode: ${uniqueCode}`;
                    
                    try {
                        const signature = await signer.signMessage(message);
                        
                        // 4. SIMPAN KE LOCAL STORAGE (Durasi 30 Hari)
                        const EXPIRY_DAYS = 30;
                        const expiryTime = Date.now() + (EXPIRY_DAYS * 24 * 60 * 60 * 1000);
                        
                        const sessionData = {
                            signature: signature,
                            expiry: expiryTime,
                            loginTime: Date.now()
                        };
                        
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(sessionData));
                        console.log("‚úÖ Login Baru: Signature disimpan selama 30 hari.");

                    } catch (signErr) {
                        alert("Login Gagal: Anda harus menandatangani pesan untuk masuk.");
                        userAddress = null;
                        signer = null;
                        return;
                    }
                }

                // D. LOAD KONTRAK & DATA (Jalan jika sesi valid atau baru saja sign)
                gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, signer);
                
                document.getElementById('connectBtn').innerText = userAddress.substring(0,6) + "..." + userAddress.slice(-4);
                document.getElementById('connectBtn').style.background = "var(--success)";
                document.getElementById('connectBtn').style.color = "black";
                
                // Load Data Market
                loadMyInventory();
                loadMarketListings();

            } catch (err) {
                console.error("Connection Error:", err);
                alert("Terjadi kesalahan koneksi.");
            }
        } else {
            alert("Please install Metamask!");
        }
    }

    function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.market-view').forEach(v => v.style.display = 'none');
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`view-${tab}`).style.display = 'block';

            if(tab === 'inventory') loadMyInventory();
            if(tab === 'buy') loadMarketListings();
        }

        // --- 3. LOAD MARKET (SCAN EVENTS) ---
        async function loadMarketListings() {
    if(!gameContract) return;
    const container = document.getElementById('market-list');
    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">Scanning Blockchain...</div>';
    
    try {
        // 1. Ambil Log Listing
        const filter = gameContract.filters.NicknameListed();
        const logs = await gameContract.queryFilter(filter, DEPLOY_BLOCK, "latest");

        const uniqueListings = new Map();

        // Loop Log (Reverse)
        for (const log of logs.reverse()) {
            const seller = log.args[0];
            const nick = log.args[1];
            const price = log.args[2];
            const timestamp = log.args[3]; // AMBIL TIMESTAMP DARI EVENT
            
            if (!uniqueListings.has(nick)) {
                uniqueListings.set(nick, { seller, price, timestamp }); 
            }
        }

        container.innerHTML = ""; 
        let activeCount = 0;

        for (let [nick, data] of uniqueListings) {
            const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
            const saleData = await gameContract.nickMarketplace(nickHash);
            
            const isForSale = saleData[0];
            const currentPriceBig = saleData[1];
            const currentSeller = saleData[2];

            if (isForSale) {
                activeCount++;
                const priceEth = ethers.formatEther(currentPriceBig);

                // --- FITUR BARU: AMBIL AVATAR PENJUAL ---
                let avatarUrl = "https://effigy.im/a/" + currentSeller + ".png"; // Default Placeholder (Effigy)
                try {
                    const sellerProfile = await gameContract.users(currentSeller);
                    if(sellerProfile.avatarUrl && sellerProfile.avatarUrl.length > 5) {
                        avatarUrl = sellerProfile.avatarUrl;
                    }
                } catch(err) { console.log("No avatar set"); }

                // --- FITUR BARU: FORMAT WAKTU ---
                // Konversi Timestamp block (detik) ke format tanggal
                const listDate = new Date(Number(data.timestamp) * 1000);
                const dateString = listDate.toLocaleDateString() + " " + listDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const card = document.createElement('div');
                card.className = 'nick-card';
                
                const isMyListing = (userAddress && currentSeller.toLowerCase() === userAddress.toLowerCase());
                const shortSeller = currentSeller.substring(0,6) + "..." + currentSeller.substring(38);

                let btnAction = isMyListing 
                    ? `<button class="btn-action btn-cancel" onclick="cancelSale('${nick}')">Cancel Sale</button>` 
                    : `<button class="btn-action btn-buy" onclick="buyNickname('${nick}', '${priceEth}')">BUY NOW</button>`;

                // --- HTML BARU ---
                card.innerHTML = `
                    <div class="card-header-row">
                        <img src="${avatarUrl}" class="seller-avatar" alt="avt" onerror="this.src='https://effigy.im/a/${currentSeller}.png'">
                        <div class="seller-info">
                            <span class="seller-label">Seller</span>
                            <span class="seller-address">${shortSeller}</span>
                        </div>
                    </div>

                    <div class="nick-title-premium">${nick}</div>

                    <div class="info-bar">
                        <div class="time-info" title="Listed at: ${dateString}">
                            üïê <span style="font-size:0.9em">${timeSince(listDate)} ago</span>
                        </div>
                        <div class="price-tag">${priceEth} ETH</div>
                    </div>

                    ${btnAction}
                `;
                container.appendChild(card);
            }
        }

        if (activeCount === 0) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555; padding:50px;">Market is empty.</div>`;
        }

    } catch (e) {
        console.error("Market Load Error:", e);
        container.innerHTML = `<div style="color:red; text-align:center; grid-column:1/-1;">Error loading market data.</div>`;
    }
}

// Helper Function: "2 hours ago", "5 mins ago"
function timeSince(date) {
    var seconds = Math.floor((new Date() - date) / 1000);
    var interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + "y";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + "mo";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + "d";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + "h";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + "m";
    return Math.floor(seconds) + "s";
}

        // --- SCRIPT KHUSUS KONTRAK V4 (YANG SUDAH DEPLOY) ---
        async function loadMyInventory() {
    if(!gameContract || !userAddress) return;
    
    const container = document.getElementById('inventory-list');
    const tableBody = document.getElementById('history-body');
    
    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:20px;">Updating Collection...</div>';
    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Scanning history...</td></tr>';

    try {
        // ==========================================
        // BAGIAN 1: GRID KOLEKSI & SELL (FIX GANDA)
        // ==========================================
        const userData = await gameContract.users(userAddress);
        const activeNick = userData[0]; 
        document.getElementById('active-nick-display').innerText = activeNick;

        // 1. Ambil Data Mentah dari Blockchain
        let rawNicks = [];
        let index = 0;
        while(true) {
            try {
                const nick = await gameContract.myNicknames(userAddress, index);
                rawNicks.push(nick);
                index++;
            } catch (e) { break; }
        }

        // üî• FIX UTAMA: Filter Duplikat Data üî•
        // Gunakan 'Set' untuk membuang nama yang sama persis
        const uniqueNicks = [...new Set(rawNicks)];

        // üî• FIX TAMPILAN: Bersihkan wadah SETELAH data siap (Mencegah tumpuk)
        container.innerHTML = ""; 
        
        if (uniqueNicks.length === 0) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555; padding:20px;">You don't own any nicknames yet.</div>`;
        } else {
            // Loop data yang sudah bersih (uniqueNicks)
            for (let nick of uniqueNicks) {
                const isActive = (nick === activeNick);
                const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
                const saleData = await gameContract.nickMarketplace(nickHash);
                
                const isForSale = saleData[0]; 
                const priceBig = saleData[1];  

                // Render Kartu
                const div = document.createElement('div');
                div.className = 'nick-card';
                
                let actionHtml = '';
                if (isForSale) {
                    const priceEth = ethers.formatEther(priceBig);
                    actionHtml = `
                        <div style="font-size:0.8em; color:var(--gold); text-align:center; margin-bottom:5px;">Listed: ${priceEth} ETH</div>
                        <button class="btn-action btn-cancel" onclick="cancelSale('${nick}')">‚ùå Cancel Sale</button>
                    `;
                } else {
                    let switchBtn = isActive 
                        ? `<div style="text-align:center; color:var(--success); font-weight:bold; padding:8px;">‚úÖ ACTIVE</div>`
                        : `<button class="btn-action btn-use" onclick="switchNick('${nick}')" style="margin-bottom:5px;">üîÑ USE</button>`;

                    actionHtml = `
                        ${switchBtn}
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <input type="number" id="price-${nick}" class="sell-input" placeholder="ETH" style="margin-bottom:0; width:60%;">
                            <button class="btn-action btn-sell" onclick="sellNickname('${nick}')" style="width:40%; margin-top:0;">SELL</button>
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div class="nick-title-premium" style="margin-top:25px;">${nick}</div>
                    <div style="text-align:center; margin-bottom:10px;">
                        <span class="owner-badge">Item</span>
                    </div>
                    ${actionHtml}
                `;
                container.appendChild(div);
            }
        }

        // ==========================================
        // BAGIAN 2: TABEL HISTORY (LOGIKA DIPERBAIKI)
        // ==========================================
        
        const filterList = gameContract.filters.NicknameListed();
        const filterSold = gameContract.filters.NicknameSold();
        
        // Ambil Data dari Block Awal (DEPLOY_BLOCK)
        const logsList = await gameContract.queryFilter(filterList, DEPLOY_BLOCK, "latest");
        const logsSold = await gameContract.queryFilter(filterSold, DEPLOY_BLOCK, "latest");

        let myHistory = [];
        const processedIDs = new Set(); // Anti-Duplikat

        // A. PROSES DATA TERJUAL & TERBELI (Logs Sold)
        await Promise.all(logsSold.map(async (log) => {
            const uniqueID = `${log.transactionHash}_${log.index}`;
            if (processedIDs.has(uniqueID)) return;
            processedIDs.add(uniqueID);

            // Parsing Data Event Sold: [buyer, seller, nick, price, timestamp]
            const buyer = log.args[0].toLowerCase();
            const seller = log.args[1].toLowerCase();
            const nick = log.args[2];
            const price = ethers.formatEther(log.args[3]);
            const timestamp = Number(log.args[4]);

            // LOGIKA PEMISAHAN BUYER DAN SELLER
            // Gunakan else if agar tidak ganda jika user beli dari diri sendiri (testnet)
            
            if (buyer === userAddress.toLowerCase()) {
                // SAYA SEBAGAI PEMBELI -> 'Taken' (Biru)
                myHistory.push({
                    type: 'Buy',
                    nick: nick,
                    price: price,
                    status: 'Taken ‚úÖ',
                    cssClass: 'status-success', 
                    badgeType: 'badge-buy', 
                    timestamp: timestamp
                });
            } 
            else if (seller === userAddress.toLowerCase()) {
                // SAYA SEBAGAI PENJUAL -> 'Soldout' (Merah)
                myHistory.push({
                    type: 'Sell',
                    nick: nick,
                    price: price,
                    status: 'SOLDOUT ‚úÖ',
                    cssClass: 'status-sold', 
                    badgeType: 'badge-sell-sold', 
                    timestamp: timestamp
                });
            }
        }));

        // B. PROSES DATA LISTING (Logs Listed)
        // Hanya tampilkan jika statusnya MASIH ON SALE di Smart Contract
        const latestListingsMap = new Map();



        for (const log of logsList) {

            const seller = log.args[0].toLowerCase();

            // Hanya proses jika saya penjualnya

            if (seller === userAddress.toLowerCase()) {

                const nick = log.args[1];

                // Simpan ke Map. Karena log urut dari lama ke baru, 

                // data lama otomatis tertimpa data baru.

                // Hasilnya: Map hanya berisi "Jejak Terakhir" setiap nickname.

                latestListingsMap.set(nick, log);

            }

        }



        // 2. Proses Validasi (Cek ke Smart Contract)

        // Kita hanya memproses data yang sudah disaring di Map

        await Promise.all(Array.from(latestListingsMap.values()).map(async (log) => {

            const uniqueID = `${log.transactionHash}_${log.index}`;

            

            // Cek ID Unik (Safety)

            if (processedIDs.has(uniqueID)) return;



            const nick = log.args[1];

            

            // Cek Status Realtime: Apakah MASIH dijual sekarang?

            const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));

            const saleData = await gameContract.nickMarketplace(nickHash);

            const isStillForSale = saleData[0];



            if (isStillForSale) {

                processedIDs.add(uniqueID); // Catat ID

                

                myHistory.push({

                    type: 'Sell',

                    nick: nick,

                    price: ethers.formatEther(log.args[2]),

                    status: 'On Sale üõí',

                    cssClass: 'status-sale', 

                    badgeType: 'badge-sell-active', 

                    timestamp: Number(log.args[3]) 

                });

            }

        }));

        // Sorting (Terbaru di atas)
        myHistory.sort((a, b) => b.timestamp - a.timestamp);

        // Render Tabel
        tableBody.innerHTML = "";
        if (myHistory.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No transaction history yet.</td></tr>';
        } else {
            myHistory.forEach(item => {
                const dateObj = new Date(item.timestamp * 1000);
                // Format Tanggal Pendek (Tgl/Bln Jam:Menit)
                const dateStr = dateObj.toLocaleDateString('id-ID', {day:'numeric', month:'short'});
                const timeStr = dateObj.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});

                const row = `
                    <tr>
                        <td><span class="badge ${item.badgeType}">${item.type}</span></td>
                        <td style="font-weight:bold; background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 0px rgba(0,0,0,0.5));">${item.nick}</td>
                        <td style="color:#00d2ff;">${item.price} ETH</td> <td class="${item.cssClass}">${item.status}</td>
                        <td style="color:#888; font-size:0.85em;">${dateStr} ${timeStr}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

    } catch (e) {
        console.error("Error History:", e);
        tableBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">Error loading history.</td></tr>`;
    }
                }

        async function loadMarketListings() {

    if(!gameContract) return;

    const container = document.getElementById('market-list');

    const tableBody = document.getElementById('history-body');

    

    // Tampilkan Loading

    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">Scanning Blockchain...</div>';

    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Syncing history...</td></tr>';

    

    try {

        // --- A. AMBIL DATA DARI BLOCKCHAIN ---

        // 1. Ambil Event Listing (Jualan)

        const filterListed = gameContract.filters.NicknameListed();

        const logsListed = await gameContract.queryFilter(filterListed, DEPLOY_BLOCK, "latest");



        // 2. Ambil Event Sold (Laku)

        const filterSold = gameContract.filters.NicknameSold();

        const logsSold = await gameContract.queryFilter(filterSold, DEPLOY_BLOCK, "latest");



        // --- B. PROSES DATA GRID (KARTU BARANG) ---

        

        const uniqueListings = new Map();



        // Loop Listing (Reverse biar terbaru dulu)

        for (const log of logsListed.reverse()) {

            const nick = log.args[1];

            if (!uniqueListings.has(nick)) {

                uniqueListings.set(nick, { 

                    seller: log.args[0], 

                    price: log.args[2],

                    block: log.blockNumber 

                }); 

            }

        }



        container.innerHTML = ""; 

        let activeItems = []; // Simpan item aktif untuk tabel nanti

        let activeCount = 0;



        // Cek Status Realtime ke Smart Contract

        for (let [nick, data] of uniqueListings) {

            const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));

            // Panggil mapping nickMarketplace dari kontrak

            const saleData = await gameContract.nickMarketplace(nickHash);

            

            const isForSale = saleData[0];

            const currentPriceBig = saleData[1];

            const currentSeller = saleData[2];



            if (isForSale) {

                activeCount++;

                const priceEth = ethers.formatEther(currentPriceBig);



                // 1. Render Kartu Grid (Seperti Biasa)

                const card = document.createElement('div');

                card.className = 'nick-card';

                const isMyListing = (userAddress && currentSeller.toLowerCase() === userAddress.toLowerCase());



                let btnAction = isMyListing 

                    ? `<button class="btn-action btn-cancel" onclick="cancelSale('${nick}')">Your Listing (Cancel)</button>`

                    : `<button class="btn-action btn-buy" onclick="buyNickname('${nick}', '${priceEth}')">BUY NOW</button>`;



                card.innerHTML = `

                    <div class="nick-title">${nick}</div>

                    <div style="font-size:0.8em; color:#888; margin-bottom:5px;">Seller: ${currentSeller.substring(0,6)}...</div>

                    <div class="nick-price">${priceEth} ETH</div>

                    ${btnAction}

                `;

                container.appendChild(card);



                // 2. Simpan ke array untuk Tabel (Status: On Sale)

                activeItems.push({

                    type: 'Sell',

                    nick: nick,

                    price: priceEth,

                    status: 'On Sale üõí',

                    cssClass: 'status-sale',

                    badgeClass: 'badge-sell',

                    block: data.block // Pakai blok listing

                });

            }

        }



        if (activeCount === 0) {

            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555; padding:50px;">Market is empty.</div>`;

        }



        // --- C. PROSES DATA TABEL (GABUNGAN AKTIF + SOLD) ---

        

        let historyData = [...activeItems]; // Masukkan yang aktif dulu



        // Masukkan yang sudah SOLD (Laku)

        for (const log of logsSold) {

            const nick = log.args[2]; // arg ke-3 di event NicknameSold adalah nickname string

            const price = ethers.formatEther(log.args[3]);

            

            historyData.push({

                type: 'Buy', // Karena ini transaksi pembelian

                nick: nick,

                price: price,

                status: 'Soldout ‚úÖ',

                cssClass: 'status-taken', // atau status-sold

                badgeClass: 'badge-buy',

                block: log.blockNumber

            });

        }



        // Urutkan berdasarkan Block Number (Terbaru di atas)

        historyData.sort((a, b) => b.block - a.block);



        // Render ke Tabel HTML

        tableBody.innerHTML = "";

        

        if (historyData.length === 0) {

            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No history yet.</td></tr>';

        } else {

            historyData.forEach(item => {

                const row = `

                    <tr>

                        <td><span class="badge ${item.badgeClass}">${item.type}</span></td>

                        <td style="font-weight:bold; color:white;">${item.nick}</td>

                        <td>${item.price} ETH</td>

                        <td class="${item.cssClass}">${item.status}</td>

                    </tr>

                `;

                tableBody.innerHTML += row;

            });

        }



    } catch (e) {

        console.error("Load Error:", e);

        let msg = e.message;

        if(msg.includes("max block range")) msg = "Please update DEPLOY_BLOCK variable!";

        

        container.innerHTML = `<div style="color:red; text-align:center;">Error: ${msg}</div>`;

        tableBody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Error loading history</td></tr>`;

    }

        }
        
        // --- 5. TRANSAKSI (BUY, SELL, SWITCH) ---

        async function buyNickname(nick, priceEth) {
            try {
                const tx = await gameContract.buyNickname(nick, {
                    value: ethers.parseEther(priceEth)
                });
                alert("Buying... Please wait.");
                await tx.wait();
                alert("Success! You now own: " + nick);
                loadMarketListings();
                loadMyInventory();
            } catch(e) { alert("Error: " + e.message); }
        }

        async function sellNickname(nick) {
    // 1. Debugging Awal (Cek apakah tombol merespon)
    console.log("Tombol Sell ditekan untuk:", nick);

    // 2. Cek Koneksi Kontrak
    if (!gameContract) {
        alert("Koneksi ke Smart Contract terputus. Silakan refresh halaman.");
        return;
    }

    // 3. Ambil Elemen Input dengan Aman
    const inputId = `price-${nick}`;
    const inputEl = document.getElementById(inputId);

    // Jika elemen tidak ditemukan, hentikan proses (Jangan crash)
    if (!inputEl) {
        alert(`Error Sistem: Input harga dengan ID '${inputId}' tidak ditemukan di HTML.`);
        return;
    }

    const priceInput = inputEl.value;

    // 4. Validasi Input
    if (!priceInput || parseFloat(priceInput) <= 0) {
        alert("Harap masukkan harga jual yang valid (Wajib lebih dari 0 ETH)!");
        return;
    }

    try {
        // 5. Konversi Harga & Eksekusi
        // Pastikan dikonversi ke string dulu agar parseEther aman
        const priceWei = ethers.parseEther(priceInput.toString());
        
        console.log(`Mengirim Transaksi: Sell ${nick} seharga ${priceInput} ETH`);
        
        // Panggil Kontrak
        const tx = await gameContract.sellNickname(nick, priceWei);
        
        alert("Transaksi dikirim! Silakan cek MetaMask Anda...");
        
        await tx.wait();
        
        alert("Berhasil! Nickname sudah terdaftar di pasar.");
        
        // Refresh Halaman
        if(typeof loadMyInventory === 'function') loadMyInventory();

    } catch (e) {
        console.error("Error Sell:", e);
        
        // Parsing pesan error agar mudah dibaca user
        let msg = e.reason || e.message || "Unknown Error";
        if (msg.includes("user rejected")) {
            msg = "Anda membatalkan transaksi di MetaMask.";
        } else if (msg.includes("Not yours")) {
            msg = "Nickname ini bukan milik Anda!";
        }
        
        alert("GAGAL: " + msg);
    }
        }

        async function cancelSale(nick) {
    if(!gameContract) return;
    try {
        const tx = await gameContract.cancelSale(nick);
        
        // Ubah tombol jadi Loading
        const btn = document.activeElement;
        if(btn) btn.innerText = "Processing...";
        
        // TUNGGU SAMPAI TRANSAKSI SUKSES DI BLOCKCHAIN
        await tx.wait(); 
        
        alert("‚úÖ Sale Cancelled Successfully!");
        
        // Refresh Halaman Otomatis untuk memperbarui status kartu
        loadMyInventory();
        
    } catch(e) { 
        console.error(e);
        alert("‚ùå Error: " + (e.reason || e.message)); 
    }
        }

        async function switchNick(nick) {
            try {
                const tx = await gameContract.switchNickname(nick);
                alert("Switching...");
                await tx.wait();
                alert("Profile Updated!");
                loadMyInventory();
            } catch(e) { alert("Error: " + e.message); }
        }

        // --- SMART SEARCH V4 (FIXED IMAGE & LOGIC) ---
function filterMarket() {
    // 1. Definisi Variabel
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    
    // 2. Tentukan Tab Mana yang Aktif
    const viewBuy = document.getElementById('view-buy');
    let targetContainer;
    
    // Cek apakah tab Buy sedang tampil?
    if (viewBuy && viewBuy.style.display !== 'none') {
        targetContainer = document.getElementById('market-list');
    } else {
        targetContainer = document.getElementById('inventory-list');
    }

    // Safety check: Jika container belum siap, stop biar gak error
    if (!targetContainer) return;

    // 3. Loop Filter Kartu
    const cards = targetContainer.getElementsByClassName('nick-card');
    let foundCount = 0;
    
    for (let i = 0; i < cards.length; i++) {
        const card = cards[i];
        const titleEl = card.querySelector('.nick-title, .nick-title-premium');
        
        if (titleEl) {
            const txtValue = titleEl.textContent || titleEl.innerText;
            if (txtValue.toLowerCase().indexOf(filter) > -1) {
                card.style.display = ""; // Muncul
                foundCount++;
                // Highlight border kalau sedang search
                if (filter.length > 0) card.style.borderColor = "var(--primary)";
                else card.style.borderColor = ""; 
            } else {
                card.style.display = "none"; // Sembunyi
                card.style.borderColor = "";
            }
        }
    }

    // 4. LOGIKA NOTIFIKASI "NO RESULTS" (BAGIAN INI YANG PENTING)
    
    // Cek dulu: Apakah pesan error SUDAH ADA di layar?
    let noResMsg = document.getElementById('no-results-msg');
    
    // KONDISI A: Tidak ada hasil DAN User sedang mengetik sesuatu
    if (foundCount === 0 && filter.length > 0) {
        
        if (!noResMsg) {
            // JIKA BELUM ADA -> BARU KITA BUAT (Create Element)
            noResMsg = document.createElement('div');
            noResMsg.id = 'no-results-msg';
            noResMsg.className = 'no-results-box';
            
            // üëá INI KODE GAMBAR ANDA üëá
            // Pastikan file 'radar.svg' ada di folder yang sama dengan file HTML
            noResMsg.innerHTML = `
                <div class="no-results-icon">
                    <img src="radar.svg" alt="Radar Scan" style="width:80px; opacity:0.6;">
                </div>
                <div class="no-results-text">No Nickname Found</div>
                <div class="no-results-sub">Try searching for "${input.value}" with different keywords</div>
            `;
            
            targetContainer.appendChild(noResMsg);
            
        } else {
            // JIKA SUDAH ADA -> CUKUP UPDATE TEKSNYA SAJA (Jangan create ulang!)
            // Ini mencegah macet
            const subText = noResMsg.querySelector('.no-results-sub');
            if(subText) subText.innerText = `Try searching for "${input.value}" with different keywords`;
            
            noResMsg.style.display = "block"; // Pastikan terlihat
            
            // Pindahkan ke container yang aktif (kalau user pindah tab saat search)
            if(noResMsg.parentNode !== targetContainer) {
                targetContainer.appendChild(noResMsg);
            }
        }
        
    } 
    // KONDISI B: Ada hasil ATAU Input kosong
    else {
        // Sembunyikan pesan jika ada
        if (noResMsg) {
            noResMsg.style.display = "none";
        }
    }
}

        // --- FITUR CLEAR SEARCH (ADD-ON) ---

// 1. Fungsi Mengatur Visibilitas Tombol (Dipanggil saat mengetik)
function toggleClear() {
    const input = document.getElementById('searchInput');
    const btn = document.getElementById('clearBtn');
    
    if (input.value.length > 0) {
        btn.classList.add('visible'); // Munculkan tombol
    } else {
        btn.classList.remove('visible'); // Sembunyikan tombol
    }
}

// 2. Fungsi Eksekusi Hapus (Dipanggil saat klik X)
function clearSearch() {
    const input = document.getElementById('searchInput');
    
    // a. Hapus Teks
    input.value = '';
    
    // b. Sembunyikan Tombol X lagi
    toggleClear();
    
    // c. Reset Tampilan Market (Panggil Filter ulang dengan teks kosong)
    filterMarket();
    
    // d. UX Premium: Kembalikan kursor ke input agar user bisa langsung ketik lagi
    input.focus();
}
        
        // Auto connect jika sudah pernah connect di halaman utama (opsional)
        window.onload = connectWallet; 
    </script>
</body>
</html>
