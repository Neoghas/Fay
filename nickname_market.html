<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto - Nickname Market</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #00d2ff;
            --accent: #ff007a;
            --bg: #0f1016;
            --card: #1a1b26;
            --gold: #ffd700;
            --success: #00ff9d;
        }
        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 20px;
        }
        
        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 20px;
        }
        .btn-connect {
            background: var(--primary); color: #000; border: none; padding: 8px 15px;
            border-radius: 8px; cursor: pointer; font-weight: bold;
        }

        /* --- GRID LAYOUT --- */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px;
        }
        @media (min-width: 800px) {
            .market-grid { grid-template-columns: repeat(4, 1fr); gap: 15px; }
        }

        /* --- CARD STYLES --- */
        .nick-card {
            background: linear-gradient(145deg, #1a1b26, #111);
            border: 1px solid #333;
            padding: 15px;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .nick-title-premium {
            font-size: 1.6em; font-weight: 900; margin-bottom: 5px; text-align: center;
            background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #b8860b 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 0px rgba(0,0,0,0.5));
        }
        .info-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; margin-bottom: 12px; font-size: 0.8em;
        }
        .price-tag { color: var(--success); font-weight: bold; font-size: 1.1em; }
        
        /* Tombol Action */
        .btn-action {
            width: 100%; padding: 8px; border: none; border-radius: 6px;
            font-weight: bold; cursor: pointer; margin-top: auto; font-size: 0.8em;
        }
        .btn-buy { background: var(--success); color: black; }
        .btn-sell { background: var(--accent); color: white; }
        .btn-use { background: var(--primary); color: black; }
        .btn-cancel { background: #555; color: white; }

        /* INPUT SELL */
        .sell-input {
            width: 100%; padding: 8px; margin-bottom: 8px;
            background: #111; border: 1px solid #444; color: white; border-radius: 5px;
        }

        /* TABLES & BADGES */
        .history-section { margin-top: 20px; }
        .table-responsive { overflow-x: auto; }
        .market-table { width: 100%; border-collapse: collapse; background: #15161c; border-radius: 8px; margin-top: 10px; }
        .market-table th, .market-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #2a2b36; }
        .market-table th { background-color: #222; color: #888; text-transform: uppercase; font-size: 0.85em; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        
        .badge-sell-active { background: rgba(0, 255, 157, 0.1); color: #00ff9d; border: 1px solid #00ff9d; }
        .badge-sell-sold { background: rgba(255, 77, 77, 0.1); color: #ff4d4d; border: 1px solid #ff4d4d; }
        .badge-buy { background: rgba(0, 210, 255, 0.1); color: #00d2ff; border: 1px solid #00d2ff; }
        
        .status-sale { color: #00ff9d; font-weight: bold; }
        .status-sold { color: #ff4d4d; font-weight: bold; }
        .status-success { color: #00d2ff; font-weight: bold; }

        /* TABS */
        .market-tabs { display: flex; width: 100%; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            flex: 1; padding: 8px 5px; background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); color: #aaa; cursor: pointer; border-radius: 12px; 
            font-weight: 700; font-size: 0.8em; transition: all 0.3s ease;
        }
        .tab-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }

        /* SEARCH & FILTER */
        .search-container { margin-bottom: 20px; }
        /* =========================================
   UPDATE GAYA SEARCH BAR PREMIUM
   ========================================= */

/* 1. Container Utama Search Bar */
.search-wrapper {
    display: flex;
    align-items: center;
    background: rgba(25, 26, 35, 0.8); /* Latar Gelap Transparan */
    border: 1px solid #333; /* Border Awal Abu gelap */
    border-radius: 12px;
    padding: 12px 15px;
    transition: all 0.3s ease; /* Animasi halus untuk border */
}

/* 2. Efek Saat Wrapper di-Hover atau Input di-Fokus */
/* :focus-within mendeteksi jika kita sedang mengetik di dalam wrapper */
.search-wrapper:hover,
.search-wrapper:focus-within {
    border-color: var(--primary); /* Ubah border jadi Biru Neon */
    box-shadow: 0 0 15px rgba(0, 210, 255, 0.3); /* Tambah Glow Biru */
    transform: translateY(-1px); /* Efek naik sedikit */
}


/* =========================================
   UPDATE GAYA ICON SEARCH (search.png)
   ========================================= */

.search-icon-img {
    /* Atur Ukuran Pas */
    width: 24px;
    height: 24px;
    margin-right: 12px; /* Jarak ke teks input */
    
    /* State Awal: Abu-abu & agak transparan agar menyatu */
    filter: grayscale(100%); 
    opacity: 0.6; 
    
    transition: all 0.3s ease; /* Animasi halus untuk perubahan warna */
}

/* Saat Wrapper di-Hover/Fokus, Icon Kembali Berwarna */
.search-wrapper:hover .search-icon-img,
.search-wrapper:focus-within .search-icon-img {
    filter: grayscale(0%); /* Warna asli muncul */
    opacity: 1; /* Transparansi hilang */
    transform: scale(1.1); /* Sedikit membesar biar interaktif */
}
        #searchInput { width: 100%; background: transparent; border: none; color: white; font-size: 1em; outline: none; }
        
        .filter-panel-simple {
            display: flex; flex-wrap: wrap; gap: 20px; background: rgba(13, 18, 30, 0.85);
            border: 1px solid rgba(0, 210, 255, 0.3); padding: 20px; border-radius: 12px; margin-bottom: 25px;
        }
        .filter-box { display: flex; flex-direction: column; gap: 8px; }
        .filter-label { font-size: 0.85rem; color: #00d2ff; font-weight: bold; }
        .cyber-select, .cyber-input {
            background-color: #0f172a; color: white; border: 1px solid #334155; padding: 10px; border-radius: 8px;
        }

        /* --- STYLE TOMBOL CLEAR (X) --- */
.search-clear-img {
    width: 12px;  /* SAYA REKOMENDASIKAN 24PX AGAR MUDAH DITAP DI HP */
    height: 12px; 
    cursor: pointer; 
    margin-left: 10px;
    opacity: 0; 
    visibility: hidden; 
    transform: scale(0.5) rotate(-90deg); 
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.search-clear-img.visible { 
    opacity: 1; 
    visibility: visible; 
    transform: scale(1) rotate(0deg); 
}

.search-clear-img:hover { 
    transform: scale(1.2) rotate(90deg); 
    filter: drop-shadow(0 0 5px #ff0055); 
}

/* --- STYLE 'NO RESULTS' (RADAR) --- */
.no-results-box {
    grid-column: 1 / -1; 
    text-align: center; 
    padding: 60px 20px;
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp { 
    from { opacity: 0; transform: translateY(20px); } 
    to { opacity: 1; transform: translateY(0); } 
}

.no-results-icon img { 
    width: 100px; 
    opacity: 0.6; 
    margin-bottom: 20px; 
    filter: grayscale(100%); 
}

.no-results-text { 
    font-size: 1.4em; 
    font-weight: bold; 
    color: #fff; 
    margin-bottom: 5px; 
}

.no-results-sub { 
    font-size: 0.9em; 
    color: #666; 
}

    /* Base Toast Style */
#toast {

    /* --- Layout & Posisi --- */

    visibility: hidden;

    min-width: 220px; /* Dikecilkan dari 300px agar compact */

    max-width: 85%;

    position: fixed;

    z-index: 99999;

    

    /* GANTI POSISI: Turun ke bawah Header */

    top: 90px; /* Jarak aman dari atas agar tidak menutupi navbar */

    right: 20px;

    left: auto; 

    

    /* --- STYLE COMPACT (PREMIUM) --- */

    background-color: rgba(51, 51, 51, 0.95);

    backdrop-filter: blur(8px);

    box-shadow: 0 10px 30px rgba(0,0,0,0.2); /* Shadow sedikit diperhalus */

    border-radius: 10px; /* Radius dikecilkan sedikit */

    border: 1px solid rgba(255,255,255,0.15); /* Border lebih tipis */

    

    /* Typography & Spacing yang lebih Ramping */

    color: #fff;

    /* Padding diperkecil (Atas/Bawah 10px, Kanan 35px utk tombol close) */

    padding: 10px 35px 10px 15px; 

    

    display: flex;

    align-items: center;

    font-family: 'Ubuntu', sans-serif;

    font-weight: 500;

    font-size: 11px; /* Font dikecilkan ke 13px */

    letter-spacing: 0.3px;



    /* --- ANIMASI KELUAR (EXIT) --- */

    opacity: 0;

    transform: translateX(20px) scale(0.9); 

    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0.4s; 

}



/* --- STATE MUNCUL (ENTER) --- */

#toast.show {

    visibility: visible;

    opacity: 1;

    transform: translateX(0) scale(1);

    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0s;

}
    
/* 1. Icon Utama */

#toast .toast-icon {

    width: 23px;  /* Dikecilkan dari 24px */

    height: 23px; 

    margin-right: 10px; 

    object-fit: contain;

}



/* 2. Tombol Close (X) */

#toast .toast-close {

    position: absolute;

    top: 10px;   /* Disesuaikan dengan padding baru */

    right: 10px; /* Disesuaikan dengan padding baru */

    width: 9px; /* Dikecilkan sedikit */

    height: 9px;

    cursor: pointer;

    opacity: 0.6;

    transition: 0.2s;

}

#toast .toast-close:hover { opacity: 1; transform: scale(1.1); }

#toast.info {
    background: rgba(0, 53, 107, 0.35);
    border: 1px solid rgba(0, 100, 204, 0.4);
    color: #fff;
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0, 100, 255, 0.25);
}

#toast.success {
    background: rgba(0, 77, 7, 0.35);
    color: #fff;
    border: 1px solid rgba(0, 184, 15, 0.4);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0,255,0,0.2);
}

#toast.error {
    background: rgba(107, 0, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(184, 0, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 22px rgba(255,0,0,0.25);
    }

#toast.warning {
    background: rgba(102, 98, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(179, 171, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 20px rgba(255,255,0,0.25);
}

#toast.wolf {
    background: rgba(125, 65, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(204, 106, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(255,140,0,0.25);
}

#toast.load {
    background: rgba(49, 77, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(104, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(0,255,0,0.25);
}
    
#toast.loading {
    background: rgba(52, 90, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(94, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(94, 163, 0, 0.25);
}

/* --- ANIMASI DARI ATAS --- */
@keyframes slideDown {
    from {top: -50px; opacity: 0;}
    to {top: 30px; opacity: 1;}
}

@keyframes fadeOut {
    from {top: 30px; opacity: 1;}
    to {top: -50px; opacity: 0;}
        }

        /* --- MODAL BACKDROP (GLASS EFFECT) --- */
.modal-backdrop {
    position: fixed;
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0, 0, 0, 0.85); /* Lebih gelap biar fokus */
    backdrop-filter: blur(8px); /* Blur background belakang modal */
    z-index: 10000; 
    display: flex; 
    justify-content: center; 
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease; /* Animasi smooth */
}

/* Kelas helper untuk memunculkan modal via JS */
.modal-backdrop.show {
    opacity: 1;
    visibility: visible;
}

/* --- MODAL CONTENT BOX --- */
.modal-content {
    background: linear-gradient(145deg, #1a1b26, #0f1016); /* Gradasi Halus */
    border: 1px solid rgba(0, 210, 255, 0.3); /* Border Biru Neon Tipis */
    width: 90%; 
    max-width: 420px; 
    padding: 25px; 
    border-radius: 20px;
    box-shadow: 0 0 30px rgba(0, 210, 255, 0.15); /* Glow Biru */
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.modal-backdrop.show .modal-content {
    transform: scale(1); /* Efek Pop-Up */
}

/* --- MODAL HEADER --- */
.modal-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 25px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 10px;
}

.modal-header h3 {
    margin: 0;
    color: var(--primary); /* Biru Neon */
    font-size: 1.4em;
    letter-spacing: 1px;
}

.close-btn { 
    font-size: 2em; 
    cursor: pointer; 
    color: #ff0055; 
    line-height: 0.5;
    transition: transform 0.2s;
}
.close-btn:hover { transform: rotate(90deg); }

/* --- DEAL SECTION (FORM) --- */
.deal-section { margin-bottom: 20px; text-align: left; }

.deal-section label { 
    display: block; 
    font-size: 0.85em; 
    color: #aaa; /* Abu terang biar kebaca */
    margin-bottom: 8px; 
    font-weight: 600;
}

/* KARTU TARGET ITEM */
.selected-target-card {
    background: rgba(0, 0, 0, 0.3); 
    padding: 15px;
    border-radius: 12px; 
    text-align: center; 
    border: 1px dashed var(--gold); /* Border putus-putus Emas */
}

.selected-target-card h2 {
    margin: 0;
    color: var(--gold);
    font-size: 1.5em;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}

/* INPUT & SELECT (Full Width di HP) */
.cyber-input, .cyber-select {
    width: 100%; /* Paksa full width agar rapi di modal sempit */
    box-sizing: border-box; /* Agar padding tidak melebarkan elemen */
    background: #0f1016;
    border: 1px solid #333;
    color: white;
    padding: 12px;
    border-radius: 8px;
    outline: none;
    font-size: 1em;
}

.cyber-input:focus, .cyber-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 10px rgba(0, 210, 255, 0.2);
}

/* ICON PANAH TENGAH */
.swap-icon {
    text-align: center;
    font-size: 1.8em;
    margin: 10px 0;
    animation: bounce 2s infinite;
}
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

/* FOOTER TOMBOL */
.modal-footer {
    margin-top: 25px;
}
.modal-footer .btn-action {
    width: 100%;
    padding: 12px;
    font-size: 1.1em;
    letter-spacing: 1px;
}

/* --- INBOX PANEL --- */
#offer-inbox-panel {
    background: rgba(13, 18, 30, 0.6);
    border-radius: 16px;
    padding: 20px;
    margin-top: 20px;
    border: 1px solid rgba(255,255,255,0.05);
}

#offer-inbox-panel h3 {
    margin-top: 0;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

/* KARTU OFFER DI DALAM INBOX */
.offer-card {
    background: linear-gradient(145deg, #1f212e, #15161c);
    border: 1px solid rgba(255, 0, 122, 0.3); /* Border Merah Muda redup */
    padding: 20px;
    border-radius: 12px;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.offer-card:hover {
    border-color: #ff007a;
    box-shadow: 0 0 15px rgba(255, 0, 122, 0.2);
}

/* BADGE "INCOMING" DI POJOK KARTU */
.offer-badge {
    position: absolute; 
    top: 10px; 
    right: 10px; 
    background: rgba(255, 0, 122, 0.2);
    color: #ff007a; 
    padding: 4px 10px; 
    border-radius: 20px; 
    font-size: 0.7em;
    font-weight: bold;
    border: 1px solid #ff007a;
}

.offer-detail-box {
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    margin: 10px 0;
    border: 1px dashed #444;
        }

        /* --- LIVE FEED BAR (RUNNING TEXT) --- */
.live-feed-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 35px;
    background: #0f1016;
    border-top: 1px solid var(--primary);
    display: flex;
    align-items: center;
    z-index: 9000;
    font-family: 'Courier New', monospace; /* Font ala hacker/terminal */
    box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
}

.feed-label {
    background: var(--primary);
    color: black;
    font-weight: bold;
    padding: 0 15px;
    height: 100%;
    display: flex;
    align-items: center;
    font-size: 0.8em;
    z-index: 2; /* Supaya di atas teks jalan */
}

.feed-window {
    flex: 1;
    overflow: hidden; /* Sembunyikan teks yang lewat */
    position: relative;
    height: 100%;
    display: flex;
    align-items: center;
}

.feed-content {
    display: flex;
    gap: 50px; /* Jarak antar berita */
    white-space: nowrap; /* Jangan turun baris */
    animation: scrollLeft 20s linear infinite; /* Animasi Jalan */
    padding-left: 100%; /* Mulai dari kanan layar */
}

.feed-item {
    font-size: 0.85em;
    color: #00ff9d;
    display: flex;
    align-items: center;
    gap: 5px;
}

.feed-item b { color: white; }
.feed-highlight { color: var(--gold); }

/* ANIMASI JALAN DARI KANAN KE KIRI */
@keyframes scrollLeft {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}

/* Supaya konten utama tidak ketutup bar di bawah */
body { padding-bottom: 50px; }

        /* --- SOSIAL BAR DI KARTU --- */
.social-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 10px;
    margin-top: 10px;
}

/* TOMBOL LIKE (LOVE) */
.like-btn {
    cursor: pointer;
    font-size: 1.2em;
    color: #666;
    transition: all 0.3s;
    display: flex; align-items: center; gap: 5px;
}
.like-btn:hover { color: #ff0055; transform: scale(1.1); }
.like-btn.liked { color: #ff0055; animation: heartBeat 0.5s; }

@keyframes heartBeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

/* RATING DISPLAY (KECIL DI KARTU) */
.rating-display {
    font-size: 0.9em;
    color: var(--gold);
    cursor: pointer;
    display: flex; align-items: center; gap: 5px;
}
.rating-display:hover { text-decoration: underline; }

/* --- RATING MODAL STYLES --- */
.star-rating {
    font-size: 2.5em;
    color: #444; /* Warna bintang mati */
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 10px 0;
    cursor: pointer;
}
.star-rating span:hover,
.star-rating span.active {
    color: var(--gold); /* Warna bintang hidup */
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
}

/* QUOTE CHIPS (TOMBOL KATA-KATA) */
.quote-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}
.quote-chip {
    background: rgba(255,255,255,0.05);
    border: 1px solid #444;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    color: #aaa;
    cursor: pointer;
    transition: all 0.2s;
}
.quote-chip:hover { border-color: var(--primary); color: white; }
.quote-chip.selected {
    background: var(--primary);
    color: black;
    border-color: var(--primary);
    font-weight: bold;
    box-shadow: 0 0 10px rgba(0, 210, 255, 0.4);
}

        /* --- REVIEW LIST STYLES --- */
.review-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    transition: all 0.2s;
}

.review-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--primary);
}

.review-header {
    display: flex;
    justify-content: space-between;
    font-size: 0.8em;
    color: #888;
    margin-bottom: 8px;
    border-bottom: 1px dashed rgba(255,255,255,0.1);
    padding-bottom: 5px;
}

.review-stars {
    color: var(--gold);
    font-size: 1em;
    margin-bottom: 5px;
}

.review-text {
    font-size: 0.95em;
    color: #ddd;
    font-style: italic;
    line-height: 1.4;
}

.reviewer-addr {
    font-family: monospace;
    color: var(--primary);
}

        /* --- FEED HEADER STYLE (Facebook Style) --- */
.feed-header-sticky {
    position: sticky;
    top: 0; /* Menempel di atas saat scroll */
    z-index: 50; /* Di atas kartu */
    background: rgba(15, 16, 22, 0.95); /* Gelap hampir solid */
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 15px 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    margin-top: -10px; /* Kompensasi padding body */
}

.feed-title {
    font-size: 1.1em;
    font-weight: 800;
    color: #fff;
    letter-spacing: 1px;
    display: flex; align-items: center; gap: 10px;
}

.live-dot {
    width: 10px; height: 10px;
    background: #00ff9d;
    border-radius: 50%;
    box-shadow: 0 0 10px #00ff9d;
    animation: blink 2s infinite;
}

@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

.feed-stats {
    font-size: 0.85em;
    color: #888;
    font-family: monospace;
    background: rgba(255,255,255,0.05);
    padding: 2px 8px;
    border-radius: 4px;
}

/* LOADING PULSE (Tetap Dipakai) */
.loading-pulse {
    width: 40px; height: 40px;
    border: 3px solid rgba(255,255,255,0.1);
    border-top-color: var(--primary);
    border-radius: 50%;
    margin: 0 auto 15px auto;
    animation: spin 1s linear infinite;
}

        /* --- STYLE KHUSUS MYTHICAL (PALINDROM) --- */

/* 1. Border & Glow Ungu Misterius */
.card-mythical {
    border: 1px solid #d900ff !important;
    background: linear-gradient(145deg, #180024, #0f1016);
    box-shadow: 0 0 15px rgba(217, 0, 255, 0.4);
    position: relative;
    overflow: hidden;
    animation: mythicPulse 3s infinite alternate;
}

/* 2. Efek Kilau Emas Berjalan (Opsional: Bikin makin mahal) */
.card-mythical::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: shine 3s infinite;
}

/* 3. Badge Khusus */
.card-mythical-badge {
    background: linear-gradient(90deg, #aa00ff, #ff00cc);
    color: #9300ca !important;
    font-weight: bold;
    border: 1px solid #ff99cc;
    box-shadow: 0 0 8px #aa00ff;
}

/* ANIMASI DENYUT */
@keyframes mythicPulse {
    0% { box-shadow: 0 0 10px rgba(217, 0, 255, 0.3); border-color: #aa00ff; }
    100% { box-shadow: 0 0 25px rgba(217, 0, 255, 0.8); border-color: #ff00cc; }
}

@keyframes shine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
    }

        /* --- 1. EFEK RARE (BIRU NEON) --- */
.card-rare {
    border: 1px solid #00d2ff !important; /* Biru Cyan */
    background: linear-gradient(145deg, #001a24, #0f1016);
    box-shadow: 0 0 10px rgba(0, 210, 255, 0.2);
    position: relative;
    transition: transform 0.3s;
}

/* Animasi Denyut Biru Halus */
.card-rare:hover {
    transform: translateY(-5px); /* Naik sedikit pas dihover */
    box-shadow: 0 0 20px rgba(0, 210, 255, 0.6);
    border-color: #00ffff !important;
}

.card-rare-badge {
    background: linear-gradient(90deg, #0055ff, #00d2ff);
    box-shadow: 0 0 8px #00d2ff;
    border: 1px solid #80e5ff;
    color: # !important;
}

/* --- 2. EFEK LEGENDARY (EMAS MEWAH) --- */
.card-legendary {
    border: 1px solid #ffd700 !important; /* Emas Murni */
    background: linear-gradient(145deg, #241c00, #0f1016);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    position: relative;
    overflow: hidden;
    animation: goldPulse 4s infinite alternate; /* Berdenyut Emas */
}

/* Kilau Emas Mengalir (Shine Effect) */
.card-legendary::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(to right, transparent, rgba(255, 215, 0, 0.1), transparent);
    transform: rotate(45deg);
    animation: goldShine 5s infinite linear;
}

.card-legendary-badge {
    background: linear-gradient(90deg, #ff8c00, #ffd700);
    box-shadow: 0 0 10px #ffd700;
    border: 1px solid #ffffcc;
    color: black !important; /* Teks hitam biar kontras dengan emas */
    text-shadow: none;
}

/* --- ANIMASI KEYFRAMES --- */

@keyframes goldPulse {
    0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); border-color: #b8860b; }
    100% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); border-color: #ffd700; }
}

@keyframes goldShine {
    0% { transform: translateX(-150%) rotate(45deg); }
    100% { transform: translateX(150%) rotate(45deg); }
}
    </style>
</head>
<body>

    <header>
        <a href="index" style="color:white; text-decoration:none;">Back to Game</a>
        <button class="btn-connect" onclick="loadIncomingOffers()" style="margin-right:10px; background:#ff007a; color:white;">
        üì© Inbox
        </button>
        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">Connect Wallet</button>
    </header>

    <div class="market-tabs">
        <button class="tab-btn active" onclick="switchTab('buy')" id="tab-buy">üõí Global Market</button>
        <button class="tab-btn" onclick="switchTab('inventory')" id="tab-inventory">üéí My Inventory</button>
    </div>

    <div id="market-search-panel">

    <div class="search-container">
        <div class="search-wrapper">
            <img src="search.png" class="search-icon-img">
            <input type="text" id="searchInput" placeholder="Search Nickname..." 
                   onkeyup="runSmartFilter()" 
                   oninput="toggleClear()">      
            <img src="x.svg" id="clearBtn" class="search-clear-img" onclick="clearSearch()">
        </div>
    </div>

    <div class="filter-panel-simple">
        <div class="filter-box">
            <label class="filter-label">Sort By</label>
            <select id="sortSelect" onchange="runSmartFilter()" class="cyber-select">
                <option value="newest">üÜï Terbaru (Newest)</option>
                <option value="price_low">üìâ Harga Terendah</option>
                <option value="price_high">üìà Harga Tertinggi</option>
                <option value="rarity_high">üëë Rarity Tertinggi</option>
            </select>
        </div>

        <div class="filter-box">
            <label class="filter-label">Price Range (ETH)</label>
            <div class="price-input-group">
                <input type="number" id="minPrice" placeholder="0.01" onkeyup="runSmartFilter()" class="cyber-input" style="width:80px;">
                <span style="margin:0 5px;">-</span>
                <input type="number" id="maxPrice" placeholder="Max" onkeyup="runSmartFilter()" class="cyber-input" style="width:80px;">
            </div>
        </div>
    </div>

    </div>

    <div id="view-buy" class="market-view">
    
    <div class="feed-header-sticky">
        <div class="feed-title">
            <span class="live-dot"></span> LIVE MARKET FEED
        </div>
        <div class="feed-stats" id="marketStats">
            Waiting for data...
        </div>
    </div>

    <div id="market-list" class="market-grid" style="padding-top: 20px;">
        <div style="grid-column:1/-1; text-align:center; color:#666; margin-top:50px;">
            <div class="loading-pulse"></div>
            Syncing Blockchain...
        </div>
    </div>

    <div id="scroll-sentinel" style="height: 50px; margin-top: 20px;"></div>

    </div>

    <div id="view-inventory" class="market-view" style="display:none;">
        <div style="background:rgba(0, 210, 255, 0.1); border:1px solid var(--primary); padding:15px; border-radius:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-size:0.8em; color:#aaa;">CURRENT ACTIVE NICKNAME</div>
                <div id="active-nick-display" style="font-size:1.5em; font-weight:bold; color:white;">-</div>
            </div>
            <div style="color:var(--success); font-weight:bold;">‚úÖ IN USE</div>
        </div>

        <h3 style="color:#aaa; border-bottom:1px solid #333; padding-bottom:10px;">Collection & Sell</h3>
        <div id="inventory-list" class="market-grid">
            <div style="grid-column:1/-1; text-align:center; color:#666;">Loading inventory...</div>
        </div>

        <div class="history-section">
            <h3 style="color:var(--gold); border-bottom:1px solid #333; padding-bottom:10px; margin-top:30px;">
                üìú Market Status & History
            </h3>
            <div class="table-responsive">
                <table class="market-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Nickname</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Date</th> 
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <tr><td colspan="5" style="text-align:center;">Loading history...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="negoModal" class="modal-backdrop">
    <div class="modal-content">
        
        <div class="modal-header">
            <h3><span style="font-size:1.2em;">ü§ù</span> Make an Offer</h3>
            <span class="close-btn" onclick="closeNegoModal()">√ó</span>
        </div>
        
        <div class="modal-body">
            
            <div class="deal-section">
                <label>Nickname Target (You Will Receive)</label>
                <div class="selected-target-card">
                    <h2 id="modalTargetNick">TARGET</h2>
                </div>
            </div>

            <div class="swap-icon">üîÑ</div>

            <div class="deal-section">
                <label>Your Nickname (The One You Give It)</label>
                <select id="mySwapSelect" class="cyber-select">
                    <option value="">-- Select Your Nickname --</option>
                </select>
            </div>

            <div class="deal-section">
                <label>ADD ETH (If Trade-in)</label>
                <div style="position:relative;">
                    <input type="number" id="swapEthAmount" class="cyber-input" placeholder="0.00">
                    <span style="position:absolute; right:15px; top:12px; color:#666; font-weight:bold;">ETH</span>
                </div>
                <div style="font-size:0.75em; color:#666; margin-top:8px; font-style:italic;">
                    *Leave 0 ETH for pure Swap. Add amount ETH for Trade-in.
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-action btn-sell" onclick="sendSwapRequest()" 
                    style="background: linear-gradient(90deg, #ff007a, #ff5e00); border:none; color:white;">
                üöÄ SEND OFFER NOW
            </button>
        </div>
    </div>
    </div>

<div id="offer-inbox-panel" style="display:none; margin-top:20px;">
    <h3 style="color:var(--primary); border-bottom:1px solid #333; padding-bottom:10px;">üì® Incoming Offers</h3>
    <div id="inbox-list" class="market-grid">
        <div style="grid-column:1/-1; text-align:center; color:#666;">Scanning offers...</div>
    </div>
</div>

    <div id="ratingModal" class="modal-backdrop" style="display:none;">
    <div class="modal-content" style="text-align:center;">
        <div class="modal-header">
            <h3>‚≠ê Rate Seller</h3>
            <span class="close-btn" onclick="closeRatingModal()">√ó</span>
        </div>
        
        <div class="modal-body">
            <h2 id="ratingTargetNick" style="color:var(--gold); margin-bottom:5px;">Target</h2>
            <p style="color:#666; font-size:0.9em;">How was your experience?</p>

            <div class="star-rating">
                <span onclick="setStar(1)">‚òÖ</span>
                <span onclick="setStar(2)">‚òÖ</span>
                <span onclick="setStar(3)">‚òÖ</span>
                <span onclick="setStar(4)">‚òÖ</span>
                <span onclick="setStar(5)">‚òÖ</span>
            </div>
            <input type="hidden" id="selectedStar" value="0">

            <div style="margin-top:20px; text-align:left;">
                <label style="color:var(--primary); font-size:0.8em; font-weight:bold;">QUICK FEEDBACK (Select One)</label>
                <div class="quote-container" id="quoteList">
                    </div>
                <input type="hidden" id="selectedQuote" value="">
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-action" onclick="submitRatingToContract()" style="background:var(--success); color:black;">‚úÖ SUBMIT RATING</button>
        </div>
    </div>
    </div>

    <div id="reviewListModal" class="modal-backdrop" style="display:none;">
    <div class="modal-content" style="max-width: 500px; height: 70vh; display:flex; flex-direction:column;">
        
        <div class="modal-header">
            <h3>üìú Reviews: <span id="reviewTargetTitle" style="color:var(--gold);">...</span></h3>
            <span class="close-btn" onclick="closeReviewList()">√ó</span>
        </div>
        
        <div class="modal-body" style="flex:1; overflow-y:auto; padding-right:5px;" id="reviewListContainer">
            <div style="text-align:center; color:#666; margin-top:50px;">Loading reviews...</div>
        </div>

        <div class="modal-footer" style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
            <button class="btn-action" onclick="switchToRateModal()" style="background:var(--primary); color:black; font-weight:bold;">
                ‚ûï ADD YOUR REVIEW
            </button>
        </div>

    </div>
    </div>

    <div class="live-feed-bar">
    <div class="feed-label">‚ö° LIVE OFFERS</div>
    <div class="feed-window">
        <div class="feed-content" id="liveFeedTrack">
            <span class="feed-item">Scanning Blockchain for live offers...</span>
        </div>
    </div>
    </div>

    <div id="toast"></div>

    <script>
        // --- 1. CONFIGURATION ---
        // Karena logic Market sudah dipisah, Alamat ini adalah Alamat Contract MARKET
        const CONTRACT_ADDRESS = "0x7f6DA2218cAe47cA187e47c33974e1d14BA91749"; 
        const DEPLOY_BLOCK = 34806731; // Sesuaikan jika perlu

        // Base Sepolia Configuration
        const BASE_SEPOLIA_CHAIN_ID = '0x14a34'; // 84532
        const BASE_SEPOLIA_CONFIG = {
            chainId: BASE_SEPOLIA_CHAIN_ID,
            chainName: 'Base Sepolia Testnet',
            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
            rpcUrls: ['https://sepolia.base.org'],
            blockExplorerUrls: ['https://sepolia.basescan.org']
        };

        // ABI LENGKAP UNTUK MARKET (Termasuk Struct & Event Baru)
        const GAME_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":true,"internalType":"address","name":"author","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":true,"internalType":"address","name":"author","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameDelisted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"marketId","type":"uint256"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameListed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"oldPrice","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"NicknamePriceUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameSold","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickA","type":"string"},{"indexed":false,"internalType":"string","name":"nickB","type":"string"},{"indexed":false,"internalType":"address","name":"ownerA","type":"address"},{"indexed":false,"internalType":"address","name":"ownerB","type":"address"}],"name":"SwapAccepted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"myNick","type":"string"},{"indexed":false,"internalType":"string","name":"targetNick","type":"string"}],"name":"SwapCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"myNick","type":"string"},{"indexed":false,"internalType":"string","name":"targetNick","type":"string"},{"indexed":false,"internalType":"uint256","name":"ethOffered","type":"uint256"},{"indexed":false,"internalType":"address","name":"initiator","type":"address"}],"name":"SwapRequested","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"Unliked","type":"event"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"string","name":"_text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"buyNickname","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"cancelSale","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_myNick","type":"string"},{"internalType":"string","name":"_targetNick","type":"string"}],"name":"cancelSwap","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentMarketId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"uint256","name":"_commentId","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_myNick","type":"string"},{"internalType":"string","name":"_offeredNick","type":"string"}],"name":"executeSwap","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"gameContractAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"average","type":"uint256"},{"internalType":"uint256","name":"count","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"getComments","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"internalType":"struct Market.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"getRaters","outputs":[{"components":[{"internalType":"address","name":"rater","type":"address"},{"internalType":"uint8","name":"stars","type":"uint8"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct Market.RatingData[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"uint8","name":"_stars","type":"uint8"}],"name":"giveRating","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"address","name":"","type":"address"}],"name":"hasRated","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"likeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"marketIdToHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"myNicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickHandHistory","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickMarketplace","outputs":[{"internalType":"uint256","name":"marketId","type":"uint256"},{"internalType":"bool","name":"isForSale","type":"bool"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"address","name":"seller","type":"address"},{"internalType":"uint256","name":"listedAt","type":"uint256"},{"internalType":"enum Market.Rarity","name":"rarity","type":"uint8"},{"internalType":"uint256","name":"ownerCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"nicknameComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"nicknameRatings","outputs":[{"internalType":"address","name":"rater","type":"address"},{"internalType":"uint8","name":"stars","type":"uint8"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"uint8","name":"_stars","type":"uint8"},{"internalType":"string","name":"_commentText","type":"string"}],"name":"rateAndComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"string","name":"_nick","type":"string"}],"name":"registerNicknameFromGame","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_myNick","type":"string"},{"internalType":"string","name":"_targetNick","type":"string"}],"name":"requestSwap","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"uint256","name":"_price","type":"uint256"}],"name":"sellNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_game","type":"address"}],"name":"setGameContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"swapRequests","outputs":[{"internalType":"address","name":"initiator","type":"address"},{"internalType":"string","name":"myNick","type":"string"},{"internalType":"string","name":"targetNick","type":"string"},{"internalType":"uint256","name":"ethOffered","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_newNick","type":"string"}],"name":"switchNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"toggleLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"totalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"}],"stateMutability":"view","type":"function"}];
        
        const REVIEW_QUOTES = [
    "‚ö° Fast Response",
    "‚úÖ Trusted Seller",
    "üíé Premium Name",
    "ü§ù Good Deal",
    "üî• Recommended",
    "üì¶ Smooth Process",
    "üí∞ Reasonable Price"
];
        const BATCH_SIZE = 12;
        
        let provider, signer, gameContract;
        let userAddress = null;
        let rawMarketData = [];
        let currentTargetNick = "";
        let currentRateNick = "";
        let toastTimeout;
        let allFilteredData = []; // Menyimpan semua hasil filter
        let currentRenderIndex = 0; // Melacak sampai mana kita merender

        // --- 2. CORE FUNCTIONS ---
async function connectWallet() {
    if (window.ethereum) {
        try {
            // 1. SWITCH CHAIN (LOGIKA STANDAR)
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BASE_SEPOLIA_CONFIG],
                        });
                    } catch (addError) { return; }
                } else { return; }
            }

            // 2. SETUP PROVIDER & ADDRESS
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();

            // -------------------------------------------------------------
            // üî• LOGIKA BARU: SIGNATURE & LOCAL STORAGE (SESSION 1 BULAN) üî•
            // -------------------------------------------------------------
            
            // Kunci penyimpanan unik per wallet (supaya kalau ganti akun tidak bentrok)
            const STORAGE_KEY = `faylotto_auth_${userAddress.toLowerCase()}`;
            
            // Cek apakah ada data sesi tersimpan?
            const cachedSession = localStorage.getItem(STORAGE_KEY);
            let isSessionValid = false;

            // A. CEK VALIDASI SESI LAMA
            if (cachedSession) {
                const sessionData = JSON.parse(cachedSession);
                const now = Date.now();
                
                // Syarat Valid: Alamat sama DAN Waktu belum expired
                if (sessionData.address === userAddress && now < sessionData.expiry) {
                    console.log("‚úÖ Auto-Login: Sesi valid (Signature cached).");
                    isSessionValid = true; 
                } else {
                    // Jika expired, hapus sampah lama
                    console.log("‚ö†Ô∏è Sesi habis, meminta tanda tangan ulang...");
                    localStorage.removeItem(STORAGE_KEY);
                }
            }

            // B. JIKA BELUM ADA / TIDAK VALID -> MINTA SIGNATURE BARU
            if (!isSessionValid) {
                if(typeof showToast === 'function') showToast("Please sign message to login...", 'info');
                
                // Format Pesan Sesuai Permintaan
                const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const localTime = new Date().toLocaleString();
                const uniqueId = Date.now(); // ID Unik berdasarkan Timestamp (ms)

                const message = `Welcome To Faylotto Nickname Market\n\nUser: ${userAddress}\nZone: ${timeZone} (${localTime})\nSession ID: ${uniqueId}`;

                try {
                    // Minta User Sign di MetaMask (Gratis, tidak pakai gas)
                    const signature = await signer.signMessage(message);
                    
                    // Hitung Waktu Expired (30 Hari ke depan)
                    // 30 hari * 24 jam * 60 menit * 60 detik * 1000 milidetik
                    const expiryDate = Date.now() + (30 * 24 * 60 * 60 * 1000);

                    // Simpan Data ke Local Storage
                    const newSession = {
                        address: userAddress,
                        signature: signature,
                        expiry: expiryDate,
                        loginTime: Date.now()
                    };
                    
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(newSession));
                    if(typeof showToast === 'function') showToast("Login Successful! Session saved for 30 days.", 'success');

                } catch (signErr) {
                    console.error("Signature Rejected:", signErr);
                    if(typeof showToast === 'function') showToast("Login Failed: You rejected the signature.", 'error');
                    // Reset variabel jika user menolak, supaya UI tidak berubah jadi connect
                    userAddress = null;
                    signer = null;
                    return; 
                }
            }

            // -------------------------------------------------------------
            // 3. JIKA LOLOS AUTH, LANJUT LOAD APP
            // -------------------------------------------------------------
            
            // Inisialisasi Contract (Market)
            gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, signer);
            
            // Update Tombol Connect
            const btn = document.getElementById('connectBtn');
            if(btn) {
                btn.innerText = userAddress.substring(0,6) + "..." + userAddress.slice(-4);
                btn.style.background = "var(--success)";
                btn.style.color = "black";
            }
            
            // Load Data
            if(typeof loadMyInventory === 'function') loadMyInventory();
            if(typeof loadMarketListings === 'function') loadMarketListings();
            if(typeof startLiveFeed === 'function') startLiveFeed();

        } catch (err) {
            console.error("Connection Error:", err);
            if(typeof showToast === 'function') showToast("A connection error occurred.", 'error');
        }
    } else {
        if(typeof showToast === 'function') showToast("Please install EVM Wallet!", 'warning');
    }
}

        function switchTab(tab) {
    // 1. Matikan Inbox Panel (PENTING!)
    const inboxPanel = document.getElementById('offer-inbox-panel');
    if(inboxPanel) inboxPanel.style.display = 'none';

    // 2. Logic Lama
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.market-view').forEach(v => v.style.display = 'none');
    
    document.getElementById(`tab-${tab}`).classList.add('active');
    document.getElementById(`view-${tab}`).style.display = 'block';

    const filterPanel = document.getElementById('market-search-panel');
    if (filterPanel) {
        filterPanel.style.display = (tab === 'buy') ? 'block' : 'none';
    }
    if(tab === 'inventory') loadMyInventory();
    if(tab === 'buy') loadMarketListings();
        }

        // --- 3. LOAD MARKET LISTINGS (GLOBAL) ---
        async function loadMarketListings() {
            if(!gameContract) return;

            rawMarketData = [];
            const container = document.getElementById('market-list');
            if(container) container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">Scanning Blockchain...</div>';
            
            try {
                // Ambil Event NicknameListed dari Contract
                // Event Baru: (marketId, seller, nickname, price, timestamp)
                const filter = gameContract.filters.NicknameListed();
                const logs = await gameContract.queryFilter(filter, DEPLOY_BLOCK, "latest");

                const uniqueListings = new Map();

                // Loop Log (Terbaru)
                for (const log of logs.reverse()) {
                    // Args Index Baru: 0=Id, 1=Seller, 2=Nick, 3=Price, 4=Time
                    const nick = log.args[2]; 
                    const timestamp = log.args[4]; 
                    
                    if (!uniqueListings.has(nick)) {
                        uniqueListings.set(nick, { timestamp }); 
                    }
                }

                if(uniqueListings.size === 0) {
                     if(container) container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">Market is empty.</div>';
                     return;
                }

                for (let [nick, data] of uniqueListings) {
                    const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
                    const saleData = await gameContract.nickMarketplace(nickHash);
                    
                    // Struct Baru: [marketId, isForSale, price, seller, listedAt, rarity, ...]
                    const isForSale = saleData[1]; // Index 1 isForSale (Bool)

                    if (isForSale) {
                        const currentPriceBig = saleData[2]; // Index 2 Price
                        const currentSeller = saleData[3];   // Index 3 Seller
                        const currentTimestamp = Number(saleData[4]);
                        const currentRarity = Number(saleData[5]); // Index 5 Rarity
                        
                        const priceEth = ethers.formatEther(currentPriceBig);
                        const avatarUrl = `https://api.dicebear.com/7.x/identicon/svg?seed=${nick}`;

                        // Push ke Array Global
                        rawMarketData.push({
                            nickname: nick,
                            priceEth: parseFloat(priceEth),
                            rarity: currentRarity,
                            marketId: Number(saleData[0]),
                            timestamp: currentTimestamp,
                            seller: currentSeller,
                            avatarUrl: avatarUrl,
                            isMyListing: (userAddress && currentSeller.toLowerCase() === userAddress.toLowerCase())
                        });
                    }
                }
                
                runSmartFilter(); // Render hasil scan

            } catch (e) {
                console.error("Market Load Error:", e);
                if(container) container.innerHTML = `<div style="color:red; text-align:center; grid-column:1/-1;">Error: ${e.message}</div>`;
            }
        }

        // --- LOAD INVENTORY (CLEAN HISTORY VERSION) ---
async function loadMyInventory() {

    if(!gameContract || !userAddress) return;

    

    const container = document.getElementById('inventory-list');

    const tableBody = document.getElementById('history-body');

    

    // UI Loading

    if(container) container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:20px;"><div class="loading-pulse"></div>Updating Collection...</div>';

    if(tableBody) tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Scanning Clean History...</td></tr>';



    try {

        // ==========================================

        // 1. PERSIAPAN DATA (FIX ACTIVE NICKNAME)

        // ==========================================

        let activeNick = "-";

        

        try {

            const userData = await gameContract.users(userAddress);

            

            // --- LOGIKA PINTAR DETEKSI DATA ---

            // Cek 1: Apakah dia mengembalikan String langsung? (Misal: "Ethereum")

            if (typeof userData === 'string') {

                activeNick = userData;

            } 

            // Cek 2: Apakah dia Array/Result? (Misal: ['Ethereum'])

            else if (Array.isArray(userData) || (typeof userData === 'object' && userData[0])) {

                activeNick = userData[0];

            }

            // Cek 3: Apakah struct punya property nickname?

            else if (userData.nickname) {

                activeNick = userData.nickname;

            }



            // Validasi Kosong

            if (!activeNick || activeNick === "") activeNick = "-";



        } catch (err) {

            console.warn("Gagal ambil active nick:", err);

        }



        // Tampilkan di Header Inventory

        if(document.getElementById('active-nick-display')) {

            // Jika "Unknown", beri warna merah/abu agar user sadar

            if(activeNick === "Unknown") {

                 document.getElementById('active-nick-display').innerHTML = `<span style="color:#666;">Unknown (Sold)</span>`;

            } else {

                 document.getElementById('active-nick-display').innerText = activeNick;

            }

        }



        // Wadah untuk menyimpan item yang SEDANG DIJUAL

        let activeSellItems = [];



        // ==========================================

        // 2. PROSES GRID KOLEKSI

        // ==========================================

        let rawNicks = [];

        let index = 0;

        

        while(true) {

            try {

                const nick = await gameContract.myNicknames(userAddress, index);

                rawNicks.push(nick);

                index++;

            } catch (e) { break; }

        }

        

        const uniqueNicks = [...new Set(rawNicks)];

        

        if(container) container.innerHTML = ""; 

        

        if (uniqueNicks.length === 0) {

            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555; padding:40px;">You don't own any nicknames yet.</div>`;

        } else {

            for (let nick of uniqueNicks) {

                // --- BANDINGKAN NICKNAME ---

                // Pastikan Active Nick dan Nick sekarang sama persis string-nya

                const isActive = (nick === activeNick);



                const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));

                const saleData = await gameContract.nickMarketplace(nickHash);

                

                const isForSale = saleData[1]; 

                const priceBig = saleData[2];

                const listedAt = Number(saleData[4]);



                if (isForSale) {

                    activeSellItems.push({

                        type: 'Sell',

                        nick: nick,

                        price: ethers.formatEther(priceBig),

                        status: 'On Sale üõí',

                        cssClass: 'status-sale',

                        badgeType: 'badge-sell-active',

                        timestamp: listedAt 

                    });

                }

            // Render Kartu Grid (Visual)
            const div = document.createElement('div');
            div.className = 'nick-card';

            // --- 2. FORMAT WAKTU (FIX NAMA VARIABEL) ---
            let timeDisplay = "";
            // üî• PERBAIKAN: Gunakan 'listedAt', BUKAN 'listedAtVal' üî•
            if (listedAt > 0) { 
                const d = new Date(listedAt * 1000); 
                // Contoh: 12 Dec, 14:30
                timeDisplay = d.toLocaleDateString([], {day:'numeric', month:'short'}) + ", " + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }

            let actionHtml = '';
            if (isForSale) {
                const priceEth = ethers.formatEther(priceBig);
                actionHtml = `
                    <div style="display:flex; justify-content:space-between; font-size:0.75em; color:#aaa; margin-bottom:5px; border-bottom:1px solid #333; padding-bottom:5px;">
                        <span>Listed: ${priceEth} ETH</span>
                        <span>${timeDisplay}</span>
                    </div>
                    <button class="btn-action btn-cancel" onclick="cancelSale('${nick}')">‚ùå Cancel Sale</button>
                `;
            } else {
                let switchBtn = isActive 
                    ? `<div style="text-align:center; color:var(--success); font-weight:bold; padding:8px;">‚úÖ ACTIVE</div>`
                    : `<button class="btn-action btn-use" onclick="switchNick('${nick}')" style="margin-bottom:5px;">üîÑ USE</button>`;

                actionHtml = `
                    ${switchBtn}
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="number" id="price-${nick}" class="sell-input" placeholder="ETH" style="margin-bottom:0; width:60%;">
                        <button class="btn-action btn-sell" onclick="sellNickname('${nick}')" style="width:40%; margin-top:0;">SELL</button>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="nick-title-premium" style="margin-top:25px;">${nick}</div>
                <div style="text-align:center; margin-bottom:10px;">
                    <span class="owner-badge">Item</span>
                </div>
                ${actionHtml}
            `;
            if(container) container.appendChild(div);
            }
        }

        // ==========================================
        // 3. PROSES TABEL BERSIH (GABUNGAN)
        // ==========================================
        
        // A. Ambil Data TRANSAKSI SUKSES SAJA (Sold/Bought)
        // Kita TIDAK mengambil data "Listed" dari log, supaya listing yg dicancel tidak muncul
        const filterSold = gameContract.filters.NicknameSold();
        const logsSold = await gameContract.queryFilter(filterSold, DEPLOY_BLOCK, "latest");

        let cleanHistory = [];
        const processedIDs = new Set(); 

        // Masukkan Data Penjualan/Pembelian (History Permanen)
        await Promise.all(logsSold.map(async (log) => {
            const uniqueID = `${log.transactionHash}_${log.index}`;
            if (processedIDs.has(uniqueID)) return;
            processedIDs.add(uniqueID);

            // Event: NicknameSold(buyer, seller, nickname, price, timestamp)
            // Index Args:          0       1        2        3        4
            const buyer = log.args[0].toLowerCase();
            const seller = log.args[1].toLowerCase();
            const nick = log.args[2]; 
            const price = ethers.formatEther(log.args[3]); 
            const timestamp = Number(log.args[4]);

            if (buyer === userAddress.toLowerCase()) {
                cleanHistory.push({ type: 'Buy', nick, price, status: 'Taken ‚úÖ', cssClass: 'status-success', badgeType: 'badge-buy', timestamp });
            } 
            else if (seller === userAddress.toLowerCase()) {
                cleanHistory.push({ type: 'Sell', nick, price, status: 'SOLDOUT ‚úÖ', cssClass: 'status-sold', badgeType: 'badge-sell-sold', timestamp });
            }
        }));

        // B. GABUNGKAN DENGAN ITEM YANG SEDANG AKTIF DIJUAL
        // Item yang dicancel tidak akan masuk ke sini, karena di loop atas (langkah 2) isForSale-nya False.
        cleanHistory = cleanHistory.concat(activeSellItems);

        // C. Sorting (Terbaru Paling Atas)
        cleanHistory.sort((a, b) => b.timestamp - a.timestamp);

        // D. Render Tabel Final
        if(tableBody) {
            tableBody.innerHTML = "";
            if (cleanHistory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No active listings or history.</td></tr>';
            } else {
                cleanHistory.forEach(item => {
                    const dateObj = new Date(item.timestamp * 1000);
                    const dateStr = dateObj.toLocaleDateString('id-ID', {day:'numeric', month:'short'});
                    const timeStr = dateObj.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});

                    const row = `
                        <tr>
                            <td><span class="badge ${item.badgeType}">${item.type}</span></td>
                            <td style="font-weight:bold; background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 0px rgba(0,0,0,0.5));">${item.nick}</td>
                            <td style="color:#00d2ff;">${item.price} ETH</td> 
                            <td class="${item.cssClass}">${item.status}</td>
                            <td style="color:#888; font-size:0.85em;">${dateStr} ${timeStr}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
        }

    } catch (e) {
        console.error("Error History:", e);
        if(tableBody) tableBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">Error loading history: ${e.message}</td></tr>`;
    }
}

        // --- 5. FILTERING SYSTEM (V2: INFINITE SCROLL READY) ---
function runSmartFilter() {
    const container = document.getElementById('market-list');
    if (!container) return;
    
    const searchInput = document.getElementById('searchInput');
    const searchText = searchInput ? searchInput.value.toLowerCase() : "";
    const sortSelect = document.getElementById('sortSelect');
    const sortType = sortSelect ? sortSelect.value : "newest";
    const minP = parseFloat(document.getElementById('minPrice').value) || 0;
    const maxP = parseFloat(document.getElementById('maxPrice').value) || 999999;

    toggleClear();

    // 1. FILTER DATA (Tapi jangan render dulu)
    let results = rawMarketData.filter(item => {
        if (!item.nickname.toLowerCase().includes(searchText)) return false;
        if (item.priceEth < minP || item.priceEth > maxP) return false;
        return true;
    });

    // 2. SORTING
    results.sort((a, b) => {
        if (sortType === 'newest') return b.marketId - a.marketId;
        if (sortType === 'price_low') return a.priceEth - b.priceEth;
        if (sortType === 'price_high') return b.priceEth - a.priceEth;
        if (sortType === 'rarity_high') return b.rarity - a.rarity;
        return 0;
    });

    // 3. SIMPAN KE GLOBAL & RESET
    allFilteredData = results;
    currentRenderIndex = 0;
    container.innerHTML = ""; // Bersihkan layar

    // 4. UPDATE STATS HEADER
    const statsEl = document.getElementById('marketStats');
    if(statsEl) statsEl.innerHTML = `Found ${results.length} Items`;

    // 5. RENDER BATCH PERTAMA
    renderNextBatch();
}

        // --- FUNGSI RENDER BERTAHAP (INFINITE) ---
function renderNextBatch() {
    const container = document.getElementById('market-list');
    
    // Jika tidak ada data sama sekali
    if (allFilteredData.length === 0) {
        container.innerHTML = `
            <div class="no-results-box" style="grid-column:1/-1; text-align:center; padding:60px 20px;">
                <div class="no-results-icon"><img src="radar.svg" style="width:100px; opacity:0.6; filter:grayscale(100%);"></div>
                <div class="no-results-text">No Nickname Found</div>
            </div>`;
        return;
    }

    // Hitung batas data yang mau diambil
    const nextIndex = currentRenderIndex + BATCH_SIZE;
    const batchItems = allFilteredData.slice(currentRenderIndex, nextIndex);

    // Loop Batch Ini Saja
    batchItems.forEach(item => {
        // ... (KODE RENDER KARTU ANDA YANG LAMA DISINI) ...
        // COPY DARI SCRIPT SEBELUMNYA (Bagian A, B, C, D)
        
        let rarityClass = "card-common";
        let rarityLabel = "COMMON";
        let rarityIcon = "‚ö™"; // Icon default

        if (item.rarity == 1) {
            rarityClass = "card-rare";
            rarityLabel = "RARE";
            rarityIcon = "üîµ";
        } 
        else if (item.rarity == 2) {
            rarityClass = "card-legendary";
            rarityLabel = "LEGENDARY";
            rarityIcon = "üü°";
        } 
        else if (item.rarity == 3) {
            // üî• INI BAGIAN PALINDROM / MYTHICAL üî•
            rarityClass = "card-mythical";
            rarityLabel = "MYTHICAL";
            rarityIcon = "üü£"; // Atau icon api/petir
        }

        let actionButtons = '';
        if (item.isMyListing) {
            actionButtons = `<button class="btn-action btn-cancel" onclick="cancelSale('${item.nickname}')">Cancel Listing</button>`;
        } else {
            actionButtons = `
                <div style="display:flex; gap:5px; width:100%; margin-top:auto;">
                    <button class="btn-action btn-buy" style="flex:1;" onclick="buyNickname('${item.nickname}', '${item.priceEth}')">‚ö° BUY</button>
                    <button class="btn-action" style="flex:1; background:#ff007a; color:white;" onclick="openOfferModal('${item.nickname}')">ü§ù BID</button>
                </div>
            `;
        }

        let fullTime = "Recently";
        if (item.timestamp && Number(item.timestamp) > 0) {
            const dateObj = new Date(Number(item.timestamp) * 1000);
            const dateStr = dateObj.toLocaleDateString('id-ID', {day:'numeric', month:'short'});
            const timeStr = dateObj.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            fullTime = `${dateStr}, ${timeStr}`;
        }

        const likeId = `like-${item.nickname}`;
        const rateId = `rate-${item.nickname}`;

        const cardHTML = `
            <div class="nick-card ${rarityClass}">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px; margin-bottom:10px;">
                    <span style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:0.75em; color:#aaa; font-family:monospace;">#${item.marketId}</span>
                    <span style="font-size:0.75em; color:#666;" title="Listed Time">${fullTime}</span>
                </div>
                <div style="text-align:center; padding:5px;">
                    <span class="${rarityClass}-badge" style="background:rgba(255,255,255,0.1); padding:3px 8px; border-radius:4px; font-size:0.75em; font-weight:bold; border:1px solid rgba(255,255,255,0.2);">
                        ${rarityIcon} ${rarityLabel}
                    </span>
                </div><br>
                <div class="nick-title-premium">${item.nickname}</div>
                <div class="info-bar">
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <span style="font-size:0.7em; color:#888;">SELLER</span>
                        <span style="font-size:0.85em; color:#ccc;">${item.seller.substring(0, 6)}...</span>
                    </div>
                </div>
                <div class="info-bar" style="margin-top:5px;">
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <span style="font-size:0.7em; color:#888;">PRICE</span>
                        <span class="price-tag">${parseFloat(item.priceEth).toFixed(4)} ETH</span>
                    </div>
                </div>
                <div style="margin-top:10px;">${actionButtons}</div>
                <div class="social-bar">
                    <div class="like-btn" onclick="toggleLike('${item.nickname}')">‚ù§Ô∏è <span id="${likeId}">...</span></div>
                    <div class="rating-display" onclick="openReviewList('${item.nickname}')">‚≠ê <span id="${rateId}">...</span></div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', cardHTML);
        fetchSocialStats(item.nickname);
    });

    // Update Index
    currentRenderIndex = nextIndex;
                                                                                                                                                                }

// --- HELPER: TOMBOL CLEAR ---

function toggleClear() {
    const input = document.getElementById('searchInput');
    const btn = document.getElementById('clearBtn');
    if (input && btn) {
        if (input.value.length > 0) {
            btn.classList.add('visible');
        } else {
            btn.classList.remove('visible');
        }
    }
}

function clearSearch() {
    const input = document.getElementById('searchInput');
    if (input) {
        input.value = '';
        input.focus(); // Kembalikan kursor ke input
        runSmartFilter(); // Jalankan filter ulang (hasil reset)
    }
}
        
        // --- 6. ACTIONS (BUY/SELL) ---
        async function buyNickname(nick, priceEth) {
            try {
                const tx = await gameContract.buyNickname(nick, { value: ethers.parseEther(priceEth.toString()) });
                showToast("Buying...", 'loading');
                await tx.wait();
                showToast("Success!", 'success');
                loadMarketListings(); loadMyInventory();
            } catch(e) { showToast(e.message, 'error'); }
        }

        async function sellNickname(nick) {
            const input = document.getElementById(`price-${nick}`);
            if(!input || !input.value) return showToast("Enter Price!", 'warning');
            try {
                const priceWei = ethers.parseEther(input.value.toString());
                const tx = await gameContract.sellNickname(nick, priceWei);
                showToast("Listing item...", 'loading');
                await tx.wait();
                showToast("Listed Successfully!", 'success');
                loadMyInventory();
            } catch(e) { showToast(e.reason || e.message, 'error'); }
        }

        async function cancelSale(nick) {
            try {
                const tx = await gameContract.cancelSale(nick);
                showToast("Cancelling...", 'loading');
                await tx.wait();
                showToast("List Canceled!", 'success');
                loadMyInventory();
            } catch(e) { showToast(e.reason || e.message, 'error'); }
        }

        async function switchNick(nick) {
            try {
                const tx = await gameContract.switchNickname(nick);
                showToast("Switching...", 'loading');
                await tx.wait();
                showToast("Active Nickname Updated!", 'success');
                loadMyInventory();
            } catch(e) { showToast(e.reason || e.message, 'error'); }
        }

        // 1. MEMBUKA MODAL NEGO

async function openOfferModal(targetNick) {

    if(!gameContract || !userAddress) {

        showToast("Please connect wallet first!", 'wolf');

        return;

    }

    

    // Validasi: Tidak bisa nego barang sendiri

    try {

        const nickHash = ethers.keccak256(ethers.toUtf8Bytes(targetNick));

        const owner = await gameContract.nickOwner(nickHash);

        if(owner.toLowerCase() === userAddress.toLowerCase()) {

            showToast("You cannot offer on your own item!", 'error');

            return;

        }

    } catch(e) {}



    currentTargetNick = targetNick;

    document.getElementById('modalTargetNick').innerText = targetNick;

    

    // Load Inventory User ke Dropdown

    const select = document.getElementById('mySwapSelect');

    select.innerHTML = '<option value="">Loading...</option>';

    

    let options = '<option value="">-- Select Your Nickname --</option>';

    let index = 0;

    let found = 0;

    

    while(true) {

        try {

            const myNick = await gameContract.myNicknames(userAddress, index);

            // Hanya tampilkan yang TIDAK sedang dijual (agar aman)

            const hash = ethers.keccak256(ethers.toUtf8Bytes(myNick));

            const sale = await gameContract.nickMarketplace(hash);

            // sale[1] adalah isForSale. Jika true, jangan ditampilkan di dropdown swap

            if(!sale[1]) {

                options += `<option value="${myNick}">${myNick}</option>`;

                found++;

            }

            index++;

        } catch(e) { break; }

    }

    

    if(found === 0) {

        options = '<option value="">You have no available nickname to swap</option>';

    }

    

    select.innerHTML = options;

    const modal = document.getElementById('negoModal');
    modal.style.display = 'flex'; // Munculkan container dulu
    
    // Beri jeda 10ms agar transisi CSS 'opacity' terbaca browser
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
}



function closeNegoModal() {
    const modal = document.getElementById('negoModal');
    modal.classList.remove('show'); // Hilangkan opacity dulu
    
    // Tunggu animasi selesai (0.3s) baru hilangkan elemen
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}



// 2. EKSEKUSI REQUEST SWAP (BARTER/TUKAR TAMBAH)

async function sendSwapRequest() {

    const myNick = document.getElementById('mySwapSelect').value;

    const ethAmount = document.getElementById('swapEthAmount').value || "0";

    

    if(!myNick) {

        showToast("You MUST select a nickname to Trade-ins or Swap!", 'warning');

        return;

    }



    try {

        // Parse ETH

        const weiAmount = ethers.parseEther(ethAmount.toString());

        

        // Panggil Contract: requestSwap(_myNick, _targetNick) payable

        const tx = await gameContract.requestSwap(myNick, currentTargetNick, {

            value: weiAmount

        });

        

        closeNegoModal();

        showToast("Sending Offer... Waiting for confirmation.", 'loading');

        await tx.wait();

        showToast("Offer Sent Successfully! üì®", 'success');

        

    } catch(e) {

        console.error(e);

        showToast("Failed: " + (e.reason || e.message), 'error');

    }

}

// 3. LOAD INCOMING OFFERS (INBOX)
async function loadIncomingOffers() {
    // A. Matikan Tab Lain
    document.querySelectorAll('.market-view').forEach(v => v.style.display = 'none');
    document.getElementById('market-search-panel').style.display = 'none';
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    // B. Nyalakan Panel Inbox
    const panel = document.getElementById('offer-inbox-panel');
    panel.style.display = 'block'; 
    
    const container = document.getElementById('inbox-list');
    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#666;">Scanning offers...</div>';

    try {
        // ... (Sisa kode fetch log sama persis dengan yang Anda punya) ...
        const filter = gameContract.filters.SwapRequested();
        const logs = await gameContract.queryFilter(filter, DEPLOY_BLOCK, "latest");
        
        container.innerHTML = "";
        let count = 0;

        for(const log of logs.reverse()) {
            const offerNick = log.args[0]; 
            const targetNick = log.args[1]; 
            const ethVal = log.args[2];    
            const bidder = log.args[3];    

            // Validasi Pemilik
            const targetHash = ethers.keccak256(ethers.toUtf8Bytes(targetNick));
            const owner = await gameContract.nickOwner(targetHash);
            
            // Validasi Aktif
            const offerHash = ethers.keccak256(ethers.toUtf8Bytes(offerNick));
            const swapData = await gameContract.swapRequests(targetHash, offerHash);
            const isActive = swapData[5]; 

            if (owner.toLowerCase() === userAddress.toLowerCase() && isActive) {
                count++;
                const ethStr = ethers.formatEther(ethVal);
                
                const div = document.createElement('div');
                div.className = 'nick-card offer-card';
                div.innerHTML = `
                    <div style="background:var(--accent); color:white; padding:2px 8px; border-radius:4px; font-size:0.7em; position:absolute; top:10px; right:10px;">INCOMING</div>
                    <div style="font-size:0.8em; color:#aaa; margin-top:20px;">Target Item:</div>
                    <div style="font-size:1.2em; font-weight:bold; color:white;">${targetNick}</div>
                    
                    <div style="margin:15px 0; text-align:center; border:1px dashed #333; padding:10px; border-radius:8px;">
                        <div style="font-size:0.8em; color:#888;">OFFER RECEIVED</div>
                        <div style="color:var(--gold); font-weight:bold; font-size:1.1em;">${offerNick}</div>
                        <div style="font-size:0.9em; color:#00ff9d;">+ ${ethStr} ETH</div>
                    </div>
                    
                    <div style="font-size:0.7em; color:#666; margin-bottom:10px;">From: ${bidder.substring(0,6)}...</div>
                    <button class="btn-action" onclick="acceptSwap('${targetNick}', '${offerNick}')" style="background:var(--primary); color:black;">‚úÖ ACCEPT DEAL</button>
                `;
                container.appendChild(div);
            }
        }

        if(count === 0) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:#555;">
                <div style="font-size:2em; margin-bottom:10px;">üì≠</div>
                No active offers received.
            </div>`;
        }

    } catch(e) {
        console.error(e);
        container.innerHTML = '<div style="color:red; text-align:center;">Error loading offers.</div>';
    }
}



// 4. TERIMA TAWARAN

async function acceptSwap(myNick, offeredNick) {

    try {

        const tx = await gameContract.executeSwap(myNick, offeredNick);

        showToast("Accepting offer...", 'loading');

        await tx.wait();

        showToast("Swap Success! Items Exchanged.", 'success');

        loadMyInventory(); // Refresh inventory

        loadIncomingOffers(); // Refresh inbox

    } catch(e) {

        showToast("Failed: " + e.message, 'error');

    }

                  }

        // Toast Helper
        function showToast(msg, type = 'info') {
    const x = document.getElementById("toast");

    const icons = {
        info: 'info-icon.svg',
        load: 'load.svg',
        loading: 'loading.svg',
        success: 'success.svg',
        error: 'error.svg',
        warning: 'warning.svg',
        wolf: 'wolf.svg'
    };

    // URL Icon Close X Merah (Ganti dengan 'x.svg' lokal Anda jika sudah ada)
    // Saya pakai link dummy merah agar Anda bisa langsung lihat hasilnya.
    const closeIcon = 'x.svg'; 

    if (!icons[type]) type = 'info';

    // --- UPDATE HTML DISINI ---
    // 1. Icon utama
    // 2. Pesan (bungkus span style flex:1 agar rapi)
    // 3. Tombol Close (x.svg) dengan onclick remove class
    x.innerHTML = `
        <img src="${icons[type]}" class="toast-icon" alt="${type}"> 
        <span style="flex:1;">${msg}</span>
        <img src="${closeIcon}" class="toast-close" onclick="this.parentElement.className = this.parentElement.className.replace('show', '')" alt="close">
    `;

    // Reset Class & Trigger Reflow
    x.className = ''; 
    void x.offsetWidth; 
    x.className = `show ${type}`;

    // Timer Logic
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { 
        x.className = x.className.replace("show", ""); 
    }, 10000); 
        }

        // --- 8. LOGIKA SOCIAL (LIKE & RATE) ---

// A. Fetch Data (Like Count & Avg Rating) secara Async
async function fetchSocialStats(nick) {
    try {
        const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
        
        // 1. Ambil Like Count
        const likes = await gameContract.likeCounts(nickHash);
        document.getElementById(`like-${nick}`).innerText = likes.toString();

        // 2. Ambil Rating (Avg, Count)
        // Return kontrak: (average, count). Average skala 10 (45 = 4.5)
        const rateData = await gameContract.getAverageRating(nick);
        const avg = Number(rateData[0]) / 10; // Konversi ke desimal
        const count = Number(rateData[1]);
        
        if(count > 0) {
            document.getElementById(`rate-${nick}`).innerText = `${avg.toFixed(1)} (${count})`;
        } else {
            document.getElementById(`rate-${nick}`).innerText = "Rate";
        }

    } catch(e) { console.log("Social fetch error", e); }
}

// B. Toggle Like
async function toggleLike(nick) {
    if(!gameContract) return showToast("Connect Wallet first!", "warning");
    
    // Animasi Optimistik (Langsung update angka sebelum transaksi selesai biar UX enak)
    const el = document.getElementById(`like-${nick}`);
    let current = parseInt(el.innerText) || 0;
    el.innerText = current + 1; // Nambah dulu (nanti divalidasi blockchain)
    el.parentElement.classList.add("liked");

    try {
        const tx = await gameContract.toggleLike(nick);
        await tx.wait();
        fetchSocialStats(nick); // Refresh data asli dari blockchain
    } catch(e) {
        el.innerText = current; // Balikin angka kalau gagal
        el.parentElement.classList.remove("liked");
        showToast("Like failed/cancelled", "error");
    }
}

// C. Buka Modal Rating
function openRatingModal(nick) {
    currentRateNick = nick;
    document.getElementById('ratingTargetNick').innerText = nick;
    
    // Reset State
    setStar(0);
    document.getElementById('selectedQuote').value = "";
    
    // Render Pilihan Quote (Chips)
    const container = document.getElementById('quoteList');
    container.innerHTML = "";
    REVIEW_QUOTES.forEach(quote => {
        const chip = document.createElement('div');
        chip.className = 'quote-chip';
        chip.innerText = quote;
        chip.onclick = () => selectQuote(chip, quote);
        container.appendChild(chip);
    });

    const modal = document.getElementById('ratingModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
}

function closeRatingModal() {
    const modal = document.getElementById('ratingModal');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
}

// D. Helper Bintang & Quote
function setStar(n) {
    document.getElementById('selectedStar').value = n;
    const stars = document.querySelectorAll('.star-rating span');
    stars.forEach((s, index) => {
        if(index < n) s.classList.add('active');
        else s.classList.remove('active');
    });
}

function selectQuote(el, text) {
    // Hapus kelas selected dari semua chip
    document.querySelectorAll('.quote-chip').forEach(c => c.classList.remove('selected'));
    // Tambah ke yang dipilih
    el.classList.add('selected');
    document.getElementById('selectedQuote').value = text;
}

// E. Submit Rating ke Blockchain
async function submitRatingToContract() {
    const stars = document.getElementById('selectedStar').value;
    const quote = document.getElementById('selectedQuote').value;
    
    if(stars == 0) return showToast("Please select stars!", "warning");
    if(!quote) return showToast("Please select a feedback quote!", "warning");

    try {
        // Panggil: rateAndComment(_nick, _stars, _commentText)
        const tx = await gameContract.rateAndComment(currentRateNick, stars, quote);
        
        closeRatingModal();
        showToast("Submitting rating...", "loading");
        await tx.wait();
        
        showToast("Rated Successfully! ‚≠ê", "success");
        fetchSocialStats(currentRateNick); // Refresh tampilan kartu
        
    } catch(e) {
        showToast("Error: " + (e.reason || e.message), "error");
    }
}

        // --- 10. FITUR RIWAYAT ULASAN PUBLIK ---

async function openReviewList(nick) {
    document.getElementById('reviewListModal').style.display = 'flex';
    document.getElementById('reviewTargetTitle').innerText = nick;
    const container = document.getElementById('reviewListContainer');
    
    // Animasi Loading
    container.innerHTML = '<div style="text-align:center; padding:20px;">Scanning Blockchain History... <br> ‚è≥</div>';
    
    // Animasi Modal Masuk
    setTimeout(() => document.getElementById('reviewListModal').classList.add('show'), 10);

    try {
        // 1. Ambil Data Rating (Bintang)
        const raters = await gameContract.getRaters(nick);
        
        // 2. Ambil Data Komentar (Teks)
        const comments = await gameContract.getComments(nick);

        container.innerHTML = "";

        if (raters.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:#666;">
                    <div style="font-size:3em; filter:grayscale(100%); opacity:0.5;">‚≠ê</div>
                    No reviews yet. Be the first!
                </div>`;
            return;
        }

        // 3. Mapping Komentar agar mudah dicocokkan dengan Rater
        // Kita pakai Map: Key = Address User -> Value = Array of Comments
        const commentMap = new Map();
        comments.forEach(c => {
            const author = c.author.toLowerCase(); // Index 1 di Struct Comment
            const text = c.text;                   // Index 2 di Struct Comment
            // Simpan komentar terakhir user tersebut
            commentMap.set(author, text);
        });

        // 4. Render Loop (Reverse agar terbaru di atas)
        // Clone array dulu biar gak ngerusak urutan asli, lalu reverse
        [...raters].reverse().forEach(r => {
            // Struct RatingData: [0]rater, [1]stars, [2]timestamp
            const raterAddr = r[0];
            const stars = Number(r[1]);
            const timestamp = Number(r[2]);
            
            // Format Waktu
            const dateObj = new Date(timestamp * 1000);
            const dateStr = dateObj.toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'2-digit'});

            // Generate Bintang Visual (‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê)
            let starVisual = "";
            for(let i=0; i<5; i++) {
                starVisual += (i < stars) ? "‚≠ê" : "‚òÜ";
            }

            // Cek apakah user ini meninggalkan komentar teks?
            // Kita ambil dari Map yang sudah dibuat di langkah 3
            let userComment = commentMap.get(raterAddr.toLowerCase());
            
            // Jika tidak ada komentar teks, pakai default
            if (!userComment || userComment === "") {
                userComment = '<span style="opacity:0.5;">(No written comment)</span>';
            } else {
                userComment = `"${userComment}"`; // Tambah tanda kutip biar keren
            }

            // HTML Item Review
            const itemHTML = `
                <div class="review-item">
                    <div class="review-header">
                        <span class="reviewer-addr">${raterAddr.substring(0,6)}...${raterAddr.slice(-4)}</span>
                        <span>${dateStr}</span>
                    </div>
                    <div class="review-stars">${starVisual}</div>
                    <div class="review-text">${userComment}</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', itemHTML);
        });

    } catch (e) {
        console.error(e);
        container.innerHTML = '<div style="color:red; text-align:center;">Error loading reviews.</div>';
    }
}

function closeReviewList() {
    const modal = document.getElementById('reviewListModal');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
}

        // --- FUNGSI PINDAH MODAL (DARI LIST KE INPUT RATE) ---
function switchToRateModal() {
    // 1. Ambil Nickname dari Judul Modal List
    const nick = document.getElementById('reviewTargetTitle').innerText;
    
    // 2. Tutup Modal List
    closeReviewList();
    
    // 3. Buka Modal Rating (Beri jeda sedikit biar smooth)
    setTimeout(() => {
        openRatingModal(nick);
    }, 300);
}

        // --- 9. LIVE FEED ENGINE (REALTIME + HISTORY) ---
async function startLiveFeed() {
    if(!gameContract) return;
    const track = document.getElementById('liveFeedTrack');
    
    // Helper: Fungsi bikin HTML Item biar rapi
    const createItemHTML = (bidder, offerNick, ethVal, targetNick, isNew = false) => {
        const badge = isNew ? '<span style="background:red; color:white; padding:0 4px; border-radius:2px; font-size:0.8em; margin-right:5px;">LIVE</span>' : '';
        return `
            <span class="feed-item">
                ${badge}
                üë§ ${bidder.substring(0,6)}... offers 
                <span class="feed-highlight">${offerNick}</span> 
                + ${parseFloat(ethers.formatEther(ethVal)).toFixed(4)} ETH 
                for <b>${targetNick}</b> üîÑ
            </span>
        `;
    };

    try {
        // ===============================================
        // 1. LOAD DATA LAMA (SEJARAH) - Agar gak kosong
        // ===============================================
        const currentBlock = await provider.getBlockNumber();
        const fromBlock = currentBlock - 2000; // Ambil agak banyak

        const filter = gameContract.filters.SwapRequested();
        const logs = await gameContract.queryFilter(filter, fromBlock, "latest");

        let initialContent = "";
        
        if(logs.length === 0) {
            initialContent = `<span class="feed-item" style="color:#666;">Waiting for offers... Market is quiet. üí§</span>`;
        } else {
            // Ambil 10 Terakhir saja & Reverse
            const recentLogs = logs.slice(-10).reverse();
            for(const log of recentLogs) {
                const offerNick = log.args[0];
                const targetNick = log.args[1];
                const ethVal = log.args[2];
                const bidder = log.args[3];
                
                initialContent += createItemHTML(bidder, offerNick, ethVal, targetNick, false);
            }
        }

        // Masukkan konten awal (Diduplikat agar scroll seamless)
        track.innerHTML = initialContent + initialContent;

        // ===============================================
        // 2. üî• PASANG CCTV (EVENT LISTENER) üî•
        // ===============================================
        // Ini yang bikin update otomatis tanpa refresh
        
        gameContract.on("SwapRequested", (offerNick, targetNick, ethVal, bidder, event) => {
            console.log("‚ö° NEW LIVE OFFER DETECTED!");

            // 1. Buat HTML Item Baru (Pakai Badge LIVE)
            const newItem = createItemHTML(bidder, offerNick, ethVal, targetNick, true);

            // 2. Suntikkan ke dalam Bar (Prepend = Taruh Paling Depan)
            track.insertAdjacentHTML('afterbegin', newItem);
            
            // 3. Opsional: Munculkan Toast juga biar user sadar
            showToast(`New Offer Incoming: ${offerNick} ‚û°Ô∏è ${targetNick}`, "success");
        });

    } catch(e) {
        console.error("Feed Error:", e);
        track.innerHTML = `<span class="feed-item" style="color:red;">Feed Offline</span>`;
    }
}
        // --- INFINITE SCROLL OBSERVER ---
const scrollObserver = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting) {
        // Jika elemen sentinel terlihat di layar bawah, muat lebih banyak data
        if (allFilteredData.length > currentRenderIndex) {
            console.log("Loading more items...");
            renderNextBatch();
        }
    }
}, { rootMargin: "200px" }); // Muat 200px sebelum mentok bawah

// Pasang Observer saat halaman siap
window.addEventListener('load', () => {
    const sentinel = document.getElementById('scroll-sentinel');
    if(sentinel) scrollObserver.observe(sentinel);
});

        window.onload = connectWallet;
    </script>
</body>
</html>
