<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto - Nickname Market</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #00d2ff;
            --accent: #ff007a;
            --bg: #0f1016;
            --card: #1a1b26;
            --gold: #ffd700;
            --success: #00ff9d;
        }
        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 20px;
        }
        
        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 20px;
        }
        .btn-back {
            background: #333; color: white; border: none; padding: 8px 15px; 
            border-radius: 8px; cursor: pointer; text-decoration: none; font-weight: bold;
        }
        .btn-connect {
            background: var(--primary); color: #000; border: none; padding: 8px 15px;
            border-radius: 8px; cursor: pointer; font-weight: bold;
        }

        /* TABS */
        .market-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            flex: 1; padding: 12px; background: #222; border: 1px solid #444;
            color: #888; cursor: pointer; border-radius: 8px; font-weight: bold;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .tab-btn.active {
            background: linear-gradient(45deg, var(--primary), #0088aa);
            color: white; border-color: var(--primary);
        }

        /* GRID LAYOUT */
        .market-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;
        }

        /* CARD STYLE */
        .nick-card {
            background: var(--card); border: 1px solid #333; padding: 15px;
            border-radius: 12px; position: relative; overflow: hidden;
            transition: 0.3s;
        }
        .nick-card:hover { transform: translateY(-3px); border-color: var(--gold); }
        
        .nick-title { font-size: 1.4em; font-weight: 900; color: var(--gold); margin-bottom: 5px; }
        .nick-price { color: var(--success); font-size: 1.1em; font-weight: bold; margin-bottom: 15px; }
        
        .btn-action {
            width: 100%; padding: 10px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; margin-top: 5px;
        }
        .btn-buy { background: var(--success); color: black; }
        .btn-sell { background: var(--accent); color: white; }
        .btn-use { background: var(--primary); color: black; }
        .btn-cancel { background: #555; color: white; }

        /* INPUT SELL */
        .sell-input {
            width: 100%; padding: 8px; margin-bottom: 8px;
            background: #111; border: 1px solid #444; color: white; border-radius: 5px;
        }
    </style>
</head>
<body>

    <header>
        <a href="index" class="btn-back">‚¨Ö Back to Game</a>
        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">Connect Wallet</button>
    </header>

    <div class="market-tabs">
        <button class="tab-btn active" onclick="switchTab('buy')" id="tab-buy">üõí Global Market</button>
        <button class="tab-btn" onclick="switchTab('inventory')" id="tab-inventory">üéí My Inventory</button>
    </div>

    <div id="view-buy" class="market-view">
        <div id="market-list" class="market-grid">
            <div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">
                Scanning Blockchain for Listings... <br> (This may take a few seconds)
            </div>
        </div>
    </div>

    <div id="view-inventory" class="market-view" style="display:none;">
        
        <div style="background:rgba(0, 210, 255, 0.1); border:1px solid var(--primary); padding:15px; border-radius:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-size:0.8em; color:#aaa;">CURRENT ACTIVE NICKNAME</div>
                <div id="active-nick-display" style="font-size:1.5em; font-weight:bold; color:white;">-</div>
            </div>
            <div style="color:var(--success); font-weight:bold;">‚úÖ IN USE</div>
        </div>

        <h3 style="color:#aaa; border-bottom:1px solid #333; padding-bottom:10px;">Collection & Sell</h3>
        <div id="inventory-list" class="market-grid">
            <div style="grid-column:1/-1; text-align:center; color:#666;">Loading inventory...</div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const CORE_ADDRESS = "0x_ALAMAT_CORE_ANDA";     // <-- Isi Alamat Core (Game)
        const MARKET_ADDRESS = "0x_ALAMAT_MARKET_ANDA"; // <-- Isi Alamat Market
        
        const BASE_SEPOLIA_CHAIN_ID = '0x14a34'; 

        // ABI CORE (Hanya fungsi yang dibutuhkan frontend market)
        const CORE_ABI = [
            "function users(address) view returns (string, bool, address, bool, uint256, uint256, bool, uint256, uint256, uint256, string)",
            "function myNicknames(address, uint256) view returns (string)",
            "function switchNickname(string) external"
        ];
    
    // Konfigurasi Base Sepolia
    const BASE_SEPOLIA_CHAIN_ID = '0x14a34'; // 84532 dalam Hex
    const BASE_SEPOLIA_CONFIG = {
        chainId: BASE_SEPOLIA_CHAIN_ID,
        chainName: 'Base Sepolia Testnet',
        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
        rpcUrls: ['https://sepolia.base.org'],
        blockExplorerUrls: ['https://sepolia.basescan.org']
    };

    let provider, signer, gameContract;
    let coreContract, marketContract;
    let userAddress = null;

    // --- 2. CORE FUNCTIONS (UPDATED) ---

    async function connectWallet() {
        if (window.ethereum) {
            try {
                // A. PAKSA GANTI JARINGAN KE BASE SEPOLIA (Sama seperti sebelumnya)
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [BASE_SEPOLIA_CONFIG],
                            });
                        } catch (addError) { return; }
                    } else { return; }
                }

                // B. SETUP PROVIDER
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // C. LOGIKA CACHE SIGNATURE (1 BULAN)
                const STORAGE_KEY = `faylotto_session_${userAddress}`; // Kunci unik per wallet
                const cachedSession = localStorage.getItem(STORAGE_KEY);
                let isSessionValid = false;

                // 1. Cek apakah ada data tersimpan?
                if (cachedSession) {
                    const data = JSON.parse(cachedSession);
                    const now = Date.now();
                    
                    // 2. Cek apakah masih berlaku (belum expired)?
                    if (now < data.expiry) {
                        console.log("‚úÖ Auto-Login: Signature valid dari Local Storage.");
                        isSessionValid = true;
                    } else {
                        console.log("‚ö†Ô∏è Sesi habis, meminta tanda tangan ulang...");
                        localStorage.removeItem(STORAGE_KEY); // Hapus yang lama
                    }
                }

                // 3. Jika Tidak Valid / Belum Ada, Minta Tanda Tangan Baru
                if (!isSessionValid) {
                    const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const localTime = new Date().toLocaleString();
                    const uniqueCode = Date.now();
                    
                    const message = `Welcome To Faylotto Market\n\nUser: ${userAddress}\nZone: ${timeZone} (${localTime})\nCode: ${uniqueCode}`;
                    
                    try {
                        const signature = await signer.signMessage(message);
                        
                        // 4. SIMPAN KE LOCAL STORAGE (Durasi 30 Hari)
                        const EXPIRY_DAYS = 30;
                        const expiryTime = Date.now() + (EXPIRY_DAYS * 24 * 60 * 60 * 1000);
                        
                        const sessionData = {
                            signature: signature,
                            expiry: expiryTime,
                            loginTime: Date.now()
                        };
                        
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(sessionData));
                        console.log("‚úÖ Login Baru: Signature disimpan selama 30 hari.");

                    } catch (signErr) {
                        alert("Login Gagal: Anda harus menandatangani pesan untuk masuk.");
                        userAddress = null;
                        signer = null;
                        return;
                    }
                }

                // D. LOAD KONTRAK & DATA (Jalan jika sesi valid atau baru saja sign)
                gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, signer);
                
                document.getElementById('connectBtn').innerText = userAddress.substring(0,6) + "..." + userAddress.slice(-4);
                document.getElementById('connectBtn').style.background = "var(--success)";
                document.getElementById('connectBtn').style.color = "black";
                
                // Load Data Market
                loadMyInventory();
                loadMarketListings();

            } catch (err) {
                console.error("Connection Error:", err);
                alert("Terjadi kesalahan koneksi.");
            }
        } else {
            alert("Please install Metamask!");
        }
    }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.market-view').forEach(v => v.style.display = 'none');
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`view-${tab}`).style.display = 'block';

            if(tab === 'inventory') loadMyInventory();
            if(tab === 'buy') loadMarketListings();
        }

        // --- 3. LOAD MARKET (SCAN EVENTS) ---
        async function loadMarketListings() {
            if(!gameContract) return;
            const container = document.getElementById('market-list');
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">Scanning Blockchain for active listings...<br><span style="font-size:0.8em;">(This process reads historical logs)</span></div>';
            
            try {
                // 1. Ambil Event 'NicknameListed' (Sejarah Listing)
                // Filter: listing yang terjadi dari blok awal sampai sekarang
                const filter = gameContract.filters.NicknameListed();
                
                // TIPS: Untuk testnet, "fromBlock: 0" mungkin lambat. 
                // Jika lambat, ganti 0 dengan nomor blok deploy kontrak Anda (misal 18000000).
                const logs = await gameContract.queryFilter(filter, 0, "latest"); 

                // 2. Siapkan Wadah Data Unik (Gunakan Map untuk mencegah duplikat nickname)
                // Karena satu nickname bisa dilist berkali-kali (list -> cancel -> list lagi)
                const uniqueListings = new Map();

                // Loop dari TERBARU ke TERLAMA (Reverse)
                for (const log of logs.reverse()) {
                    const seller = log.args[0];
                    const nick = log.args[1];
                    const price = log.args[2];
                    
                    // Jika nickname ini belum dicek, masukkan ke antrian cek
                    if (!uniqueListings.has(nick)) {
                        uniqueListings.set(nick, { seller, price }); 
                    }
                }

                container.innerHTML = ""; // Bersihkan loading
                let activeCount = 0;

                if (uniqueListings.size === 0) {
                     container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555; padding:50px;">Market is empty. Be the first to sell!</div>`;
                     return;
                }

                // 3. Validasi Status Terkini (Cek Mapping Kontrak)
                // Kita harus cek apakah barangnya MASIH ada di marketplace?
                // (Bisa jadi sudah laku/cancel setelah event listing terjadi)
                
                for (let [nick, data] of uniqueListings) {
                    const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
                    const saleData = await gameContract.nickMarketplace(nickHash);
                    
                    // Struct: [isForSale, price, seller]
                    const isForSale = saleData[0];
                    const currentPriceBig = saleData[1];
                    const currentSeller = saleData[2];

                    // HANYA TAMPILKAN JIKA MASIH DIJUAL (isForSale == true)
                    if (isForSale) {
                        activeCount++;
                        const priceEth = ethers.formatEther(currentPriceBig);

                        const card = document.createElement('div');
                        card.className = 'nick-card';
                        
                        // Cek apakah ini jualan saya sendiri?
                        const isMyListing = (currentSeller.toLowerCase() === userAddress.toLowerCase());

                        let btnAction = '';
                        if (isMyListing) {
                            btnAction = `<button class="btn-action btn-cancel" onclick="cancelSale('${nick}')">Your Listing (Cancel)</button>`;
                        } else {
                            btnAction = `<button class="btn-action btn-buy" onclick="buyNickname('${nick}', '${priceEth}')">BUY NOW</button>`;
                        }

                        card.innerHTML = `
                            <div class="nick-title">${nick}</div>
                            <div style="font-size:0.8em; color:#888; margin-bottom:5px;">Seller: ${currentSeller.substring(0,6)}...</div>
                            <div class="nick-price">${priceEth} ETH</div>
                            ${btnAction}
                        `;
                        container.appendChild(card);
                    }
                }

                if (activeCount === 0) {
                    container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555; padding:50px;">No active listings found.</div>`;
                }

            } catch (e) {
                console.error("Market Load Error:", e);
                container.innerHTML = `<div style="color:red; text-align:center; grid-column:1/-1;">
                    Failed to load market data (RPC Error).<br>
                    <small>${e.message}</small>
                </div>`;
            }
        }

        // --- 4. LOAD INVENTORY (FIXED) ---
async function loadMyInventory() {
    if(!gameContract) return;
    const container = document.getElementById('inventory-list');
    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666;">Loading your collection...</div>';
    
    try {
        // 1. Cek Nickname yang Sedang Aktif
        const userData = await gameContract.users(userAddress);
        const activeNick = userData[0]; 
        document.getElementById('active-nick-display').innerText = activeNick;

        // 2. Ambil Semua Nickname Milik User
        let myNicks = [];
        let index = 0;
        while(true) {
            try {
                const nick = await gameContract.myNicknames(userAddress, index);
                myNicks.push(nick);
                index++;
            } catch (e) { break; }
        }

        container.innerHTML = ""; 

        if (myNicks.length === 0) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555; padding:20px;">You don't own any nicknames yet.</div>`;
            return;
        }

        // 3. Render Setiap Nickname
        await Promise.all(myNicks.map(async (nick) => {
            const isActive = (nick === activeNick);
            
            // Cek Status Jual
            const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
            const saleData = await gameContract.nickMarketplace(nickHash);
            const isForSale = saleData[0]; 
            const priceBig = saleData[1];  

            const div = document.createElement('div');
            div.className = 'nick-card';
            
            let statusLabel = '';
            let actionHtml = '';

            // Label Status (Active / Idle)
            if (isActive) {
                statusLabel = `<div style="color:var(--success); font-weight:bold; font-size:0.8em; margin-bottom:10px;">‚úÖ CURRENTLY ACTIVE</div>`;
            } else {
                statusLabel = `<div style="color:#666; font-size:0.8em; margin-bottom:10px;">üí§ In Inventory</div>`;
            }

            // LOGIKA TOMBOL AKSI
            if (isForSale) {
                // KONDISI 1: SEDANG DIJUAL (Tampilkan tombol Cancel)
                const priceEth = ethers.formatEther(priceBig);
                actionHtml = `
                    <div style="background:rgba(255,215,0,0.1); border:1px solid var(--gold); padding:8px; border-radius:5px; margin-bottom:10px;">
                        Listed for: <b style="color:var(--gold);">${priceEth} ETH</b>
                    </div>
                    <button class="btn-action btn-cancel" onclick="cancelSale('${nick}')">
                        ‚ùå Cancel Sale
                    </button>
                `;
            } 
            else {
                // KONDISI 2: TIDAK DIJUAL (Tampilkan tombol Switch & Sell)
                
                // Tombol Switch hanya muncul kalau TIDAK aktif
                let switchBtn = '';
                if (!isActive) {
                    switchBtn = `
                        <button class="btn-action btn-use" onclick="switchNick('${nick}')" style="margin-bottom:15px;">
                            üîÑ Switch to this
                        </button>
                    `;
                }

                // Tombol Sell selalu muncul
                let sellForm = `
                    <div style="border-top:1px solid #333; padding-top:10px; margin-top:10px;">
                        <div style="font-size:0.8em; color:#888; margin-bottom:5px;">Sell this nickname:</div>
                        <div style="display:flex; gap:5px;">
                            
                            <input type="number" id="price-${nick}" class="sell-input" placeholder="Price (ETH)" style="margin-bottom:0;">
                            
                            <button class="btn-action btn-sell" onclick="sellNickname('${nick}')" style="width:auto; padding:0 15px; margin-top:0;">
                                SELL
                            </button>
                        </div>
                    </div>
                `;
                
                actionHtml = switchBtn + sellForm;
            }

            div.innerHTML = `
                <div class="nick-title" style="color:white; word-break:break-all;">${nick}</div>
                ${statusLabel}
                ${actionHtml}
            `;
            container.appendChild(div);
        }));

    } catch (e) {
        console.error("Inventory Error:", e);
        container.innerHTML = `<div style="color:red;">Error loading inventory.</div>`;
    }
}

        // --- 5. TRANSAKSI (BUY, SELL, SWITCH) ---

        async function buyNickname(nick, priceEth) {
            try {
                const tx = await gameContract.buyNickname(nick, {
                    value: ethers.parseEther(priceEth)
                });
                alert("Buying... Please wait.");
                await tx.wait();
                alert("Success! You now own: " + nick);
                loadMarketListings();
                loadMyInventory();
            } catch(e) { alert("Error: " + e.message); }
        }

        async function sellNickname(nick) {
    // 1. Debugging Awal (Cek apakah tombol merespon)
    console.log("Tombol Sell ditekan untuk:", nick);

    // 2. Cek Koneksi Kontrak
    if (!gameContract) {
        alert("Koneksi ke Smart Contract terputus. Silakan refresh halaman.");
        return;
    }

    // 3. Ambil Elemen Input dengan Aman
    const inputId = `price-${nick}`;
    const inputEl = document.getElementById(inputId);

    // Jika elemen tidak ditemukan, hentikan proses (Jangan crash)
    if (!inputEl) {
        alert(`Error Sistem: Input harga dengan ID '${inputId}' tidak ditemukan di HTML.`);
        return;
    }

    const priceInput = inputEl.value;

    // 4. Validasi Input
    if (!priceInput || parseFloat(priceInput) <= 0) {
        alert("Harap masukkan harga jual yang valid (Wajib lebih dari 0 ETH)!");
        return;
    }

    try {
        // 5. Konversi Harga & Eksekusi
        // Pastikan dikonversi ke string dulu agar parseEther aman
        const priceWei = ethers.parseEther(priceInput.toString());
        
        console.log(`Mengirim Transaksi: Sell ${nick} seharga ${priceInput} ETH`);
        
        // Panggil Kontrak
        const tx = await gameContract.sellNickname(nick, priceWei);
        
        alert("Transaksi dikirim! Silakan cek MetaMask Anda...");
        
        await tx.wait();
        
        alert("Berhasil! Nickname sudah terdaftar di pasar.");
        
        // Refresh Halaman
        if(typeof loadMyInventory === 'function') loadMyInventory();

    } catch (e) {
        console.error("Error Sell:", e);
        
        // Parsing pesan error agar mudah dibaca user
        let msg = e.reason || e.message || "Unknown Error";
        if (msg.includes("user rejected")) {
            msg = "Anda membatalkan transaksi di MetaMask.";
        } else if (msg.includes("Not yours")) {
            msg = "Nickname ini bukan milik Anda!";
        }
        
        alert("GAGAL: " + msg);
    }
        }

        async function cancelSale(nick) {
            try {
                const tx = await gameContract.cancelSale(nick);
                alert("Cancelling...");
                await tx.wait();
                alert("Sale Cancelled!");
                loadMarketListings();
            } catch(e) { alert("Error: " + e.message); }
        }

        async function switchNick(nick) {
            try {
                const tx = await gameContract.switchNickname(nick);
                alert("Switching...");
                await tx.wait();
                alert("Profile Updated!");
                loadMyInventory();
            } catch(e) { alert("Error: " + e.message); }
        }
        
        // Auto connect jika sudah pernah connect di halaman utama (opsional)
        // window.onload = connectWallet; 
    </script>
</body>
</html>
