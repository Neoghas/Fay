<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto - Nickname Market V4.2</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #00d2ff; --accent: #ff007a; --bg: #0f1016; --card: #1a1b26; --gold: #ffd700; --success: #00ff9d; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .btn-back { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; text-decoration: none; font-weight: bold; }
        .btn-connect { background: var(--primary); color: #000; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .market-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; background: #222; border: 1px solid #444; color: #888; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .tab-btn.active { background: linear-gradient(45deg, var(--primary), #0088aa); color: white; border-color: var(--primary); }

        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .nick-card { background: var(--card); border: 1px solid #333; padding: 15px; border-radius: 12px; transition: 0.3s; }
        .nick-title { font-size: 1.4em; font-weight: 900; color: var(--gold); margin-bottom: 5px; word-break: break-all; }
        
        .btn-action { width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-buy { background: var(--success); color: black; }
        .btn-sell { background: var(--accent); color: white; width:auto; padding: 8px 15px; }
        .btn-cancel { background: #555; color: white; }
        .sell-input { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; margin-bottom:5px; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="btn-back">‚¨Ö Back to Game</a>
        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">Connect Wallet</button>
    </header>

    <div class="market-tabs">
        <button class="tab-btn active" onclick="switchTab('buy')" id="tab-buy">üõí Global Market</button>
        <button class="tab-btn" onclick="switchTab('inventory')" id="tab-inventory">üéí My Inventory</button>
    </div>

    <div id="view-buy" class="market-view">
        <div id="market-list" class="market-grid">
            <div style="grid-column:1/-1; text-align:center; color:#666;">Loading market...</div>
        </div>
    </div>

    <div id="view-inventory" class="market-view" style="display:none;">
        <div style="background:rgba(0,210,255,0.1); border:1px solid var(--primary); padding:15px; border-radius:10px; margin-bottom:20px;">
            <div style="font-size:0.8em; color:#aaa;">CURRENT ACTIVE NICKNAME</div>
            <div id="active-nick-display" style="font-size:1.5em; font-weight:bold; color:white;">-</div>
        </div>
        <div id="inventory-list" class="market-grid">
            <div style="grid-column:1/-1; text-align:center; color:#666;">Loading inventory...</div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CORE_ADDRESS = "0x47aDDDEFFBc48f1E1C21d8429622A717DBD75749";     // Core Contract
        const MARKET_ADDRESS = "0x9aF429F3E26d5f8951f53F812382b216c6224587";   // Market Contract
        const BASE_SEPOLIA_CHAIN_ID = '0x14a34'; 

        // ABI FINAL (Core & Market V4.2)
        const CORE_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_shibToken","type":"address"},{"internalType":"address","name":"_priceFeedETH","type":"address"},{"internalType":"address","name":"_priceFeedUSDT","type":"address"},{"internalType":"address","name":"_priceFeedSHIB","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"indexed":false,"internalType":"string","name":"outcome","type":"string"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"BattleResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BonusClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"oldCollector","type":"address"},{"indexed":false,"internalType":"address","name":"newCollector","type":"address"}],"name":"FeeCollectorUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint8","name":"animalChoice","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NewBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"RatingSubmitted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"reactionType","type":"uint8"}],"name":"ReactionUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"referrer","type":"address"},{"indexed":false,"internalType":"uint256","name":"newCount","type":"uint256"}],"name":"ReferralCountIncreased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"invitee","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralLinked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"UserRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"curr","type":"uint8"},{"indexed":false,"internalType":"bool","name":"isRealTransfer","type":"bool"}],"name":"WinDistributed","type":"event"},{"inputs":[],"name":"COST_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_MAIN","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_PLATFORM_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TOTAL_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_REFERRALS_REQUIRED","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TEAMS_ACTIVE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BONUS_AMOUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"","type":"uint8"}],"name":"activeTeamCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"},{"internalType":"string","name":"_imageCid","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"}],"name":"betETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"bool","name":"_isFreeBet","type":"bool"}],"name":"betToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralBonus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"commentCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"dislikeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint256","name":"_cId","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"},{"internalType":"string","name":"_newImage","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"name":"emergencyWithdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeDraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"address","name":"_seller","type":"address"},{"internalType":"address","name":"_buyer","type":"address"}],"name":"executeMarketTrade","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeShibCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getActiveTeamCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getBonusBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentJackpot","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getGlobalWinCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLeaderboardReferral","outputs":[{"components":[{"internalType":"address","name":"userAddr","type":"address"},{"internalType":"uint256","name":"score","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"avatarUrl","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSlotBattleUltimate.LeaderboardData[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLeaderboardWinners","outputs":[{"components":[{"internalType":"address","name":"userAddr","type":"address"},{"internalType":"uint256","name":"score","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"avatarUrl","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSlotBattleUltimate.LeaderboardData[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"}],"name":"getRoundResult","outputs":[{"components":[{"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"internalType":"struct FaylottoSlotBattleUltimate.RoundResultData","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserTotalWinnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserWinCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"globalWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"address","name":"_user","type":"address"}],"name":"isNicknameOwner","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"","type":"uint8"}],"name":"jackpots","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"myNicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nicknameToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_referrerNick","type":"string"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"enum FaylottoSlotBattleUltimate.BetType","name":"bType","type":"uint8"},{"internalType":"uint8","name":"animalChoice","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageCid","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundHistory","outputs":[{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_url","type":"string"}],"name":"setAvatar","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_reaction","type":"uint8"}],"name":"setReaction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_market","type":"address"}],"name":"setslotNicknameMarketAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"shibToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"slotNicknameMarketAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_stars","type":"uint8"}],"name":"submitRating","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"topReferrers","outputs":[{"internalType":"address","name":"userAddr","type":"address"},{"internalType":"uint256","name":"score","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"avatarUrl","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"topWinners","outputs":[{"internalType":"address","name":"userAddr","type":"address"},{"internalType":"uint256","name":"score","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"avatarUrl","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"","type":"uint8"}],"name":"userCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userProfiles","outputs":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"hasBet","type":"bool"},{"internalType":"uint256","name":"pendingRefBonusCount","type":"uint256"},{"internalType":"uint256","name":"totalReferrals","type":"uint256"},{"internalType":"bool","name":"bonusClaimed","type":"bool"},{"internalType":"uint256","name":"wonETH","type":"uint256"},{"internalType":"uint256","name":"wonUSDT","type":"uint256"},{"internalType":"uint256","name":"wonSHIB","type":"uint256"},{"internalType":"string","name":"avatarUrl","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRatings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userReactions","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"hasBet","type":"bool"},{"internalType":"uint256","name":"pendingRefBonusCount","type":"uint256"},{"internalType":"uint256","name":"totalReferrals","type":"uint256"},{"internalType":"bool","name":"bonusClaimed","type":"bool"},{"internalType":"uint256","name":"wonETH","type":"uint256"},{"internalType":"uint256","name":"wonUSDT","type":"uint256"},{"internalType":"uint256","name":"wonSHIB","type":"uint256"},{"internalType":"string","name":"avatarUrl","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoSlotBattleUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawCredit","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        const MARKET_ABI = [{"inputs":[{"internalType":"address","name":"_coreAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BidAccepted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BidCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BidPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameDelisted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameListed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameSold","type":"event"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"uint256","name":"_bidIndex","type":"uint256"}],"name":"acceptBid","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"activeMarketNames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"buyNickname","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"uint256","name":"_bidIndex","type":"uint256"}],"name":"cancelBid","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"cancelSale","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"coreContract","outputs":[{"internalType":"contract IFaylottoSlotBattleUltimate","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAllActiveListings","outputs":[{"components":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"address","name":"seller","type":"address"}],"internalType":"struct FaylottoSlotNicknameMarket.MarketItem[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"getBidsForNickname","outputs":[{"components":[{"internalType":"address","name":"bidder","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSlotNicknameMarket.Bid[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickMarketplace","outputs":[{"internalType":"bool","name":"isForSale","type":"bool"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"address","name":"seller","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"nicknameBids","outputs":[{"internalType":"address","name":"bidder","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"placeBid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"uint256","name":"_price","type":"uint256"}],"name":"sellNickname","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        let provider, signer;
        let coreContract, marketContract;
        let userAddress = null;

        // --- CONNECT WALLET ---
        async function connectWallet() {
            if (!window.ethereum) return alert("Install Metamask!");
            try {
                // Switch Chain
                try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }] }); }
                catch(e) { if(e.code===4902) try { await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: BASE_SEPOLIA_CHAIN_ID, rpcUrls: ['https://sepolia.base.org'], chainName: 'Base Sepolia', nativeCurrency: {name:'ETH', decimals:18, symbol:'ETH'} }] }); } catch(ee){} }

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // INIT CONTRACTS
                coreContract = new ethers.Contract(CORE_ADDRESS, CORE_ABI, signer);
                marketContract = new ethers.Contract(MARKET_ADDRESS, MARKET_ABI, signer);

                document.getElementById('connectBtn').innerText = userAddress.substring(0,6) + "...";
                
                loadMarketListings();
                loadMyInventory();

            } catch (err) { console.error(err); alert("Connection Error"); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.market-view').forEach(v => v.style.display = 'none');
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`view-${tab}`).style.display = 'block';
            if(tab==='inventory') loadMyInventory();
            if(tab==='buy') loadMarketListings();
        }

        // --- LOAD GLOBAL MARKET (NO MORE RPC ERROR) ---
        async function loadMarketListings() {
            if (!marketContract) return;
            const container = document.getElementById('market-list');
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666;">Fetching live market...</div>';
            
            try {
                // Panggil getAllActiveListings (Jauh lebih cepat & aman daripada scan blok)
                const listings = await marketContract.getAllActiveListings();
                container.innerHTML = "";

                if (listings.length === 0) {
                     container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555;">Market is empty.</div>`;
                     return;
                }

                listings.forEach((item) => {
                    const nick = item.nickname;
                    const priceEth = ethers.formatEther(item.price);
                    const seller = item.seller;
                    const isMyListing = (userAddress && seller.toLowerCase() === userAddress.toLowerCase());

                    let action = isMyListing 
                        ? `<button class="btn-action btn-cancel" onclick="cancelSale('${nick}')">Cancel Sale</button>`
                        : `<button class="btn-action btn-buy" onclick="buyNickname('${nick}', '${priceEth}')">BUY NOW (${priceEth} ETH)</button>`;

                    const div = document.createElement('div');
                    div.className = 'nick-card';
                    div.innerHTML = `<div class="nick-title">${nick}</div><div style="color:var(--gold); font-weight:bold;">${priceEth} ETH</div><div style="font-size:0.8em; color:#888;">Seller: ${seller.substring(0,6)}...</div>${action}`;
                    container.appendChild(div);
                });
            } catch (e) { console.error("Market Load Error:", e); container.innerHTML = "Error loading market."; }
        }

        // --- LOAD INVENTORY (SAFE MODE) ---
        async function loadMyInventory() {
            if (!coreContract) return;
            const container = document.getElementById('inventory-list');
            container.innerHTML = 'Loading...';

            try {
                const userData = await coreContract.users(userAddress);
                const activeNick = userData[0]; 
                document.getElementById('active-nick-display').innerText = activeNick;

                // Loop Inventory (Robust)
                let myNicks = [];
                let idx = 0;
                while (idx < 50) { // Limit 50 to prevent hang
                    try {
                        const n = await coreContract.myNicknames(userAddress, idx);
                        if (!n) break;
                        myNicks.push(n);
                        idx++;
                    } catch { break; }
                }

                container.innerHTML = "";
                if (myNicks.length === 0) { container.innerHTML = "No nicknames found."; return; }

                for (const nick of myNicks) {
                    const isActive = (nick === activeNick);
                    const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
                    
                    // Cek Status Jual
                    let isForSale = false;
                    let priceEth = "0";
                    try {
                        const saleData = await marketContract.nickMarketplace(nickHash);
                        isForSale = saleData[0];
                        priceEth = ethers.formatEther(saleData[1]);
                    } catch(e) {}

                    // Cek Apakah Nickname Rusak (Broken Database Check)
                    let isCorrupted = false;
                    try {
                        const owner = await coreContract.nickOwner(nickHash);
                        if (owner === "0x0000000000000000000000000000000000000000") isCorrupted = true;
                    } catch(e) {}

                    const div = document.createElement('div');
                    div.className = 'nick-card';

                    let actionHtml = '';
                    
                    if (isCorrupted) {
                        actionHtml = `<div style="color:red; font-size:0.8em; padding:10px; border:1px dashed red;">‚ö†Ô∏è DATABASE ERROR<br>Nickname ini rusak (0x000).<br>Tidak bisa dijual.</div>`;
                    } else if (isForSale) {
                        actionHtml = `<div style="color:var(--gold);">Listed: ${priceEth} ETH</div><button class="btn-action btn-cancel" onclick="cancelSale('${nick}')">Cancel Sale</button>`;
                    } else {
                        actionHtml = `
                            ${!isActive ? `<button class="btn-action btn-use" onclick="switchNick('${nick}')" style="margin-bottom:10px;">Switch Active</button>` : ''}
                            <div style="display:flex; gap:5px;">
                                <input type="number" id="sell-price-${nick}" class="sell-input" placeholder="ETH" style="margin:0;">
                                <button class="btn-action btn-sell" onclick="sellNickname('${nick}')" style="margin:0; width:auto;">SELL</button>
                            </div>`;
                    }

                    div.innerHTML = `<div class="nick-title" style="color:${isActive ? 'var(--success)' : 'white'}">${nick}</div>${actionHtml}`;
                    container.appendChild(div);
                }
            } catch (e) { console.error(e); }
        }

        // --- TRANSACTIONS (DEBUG MODE) ---
        async function sellNickname(nick) {
            const inputId = `sell-price-${nick}`;
            const inputEl = document.getElementById(inputId);
            if (!inputEl) return alert("Error HTML ID");
            const price = inputEl.value;
            
            if (!price || parseFloat(price) <= 0) return alert("Masukkan harga valid");
            
            console.log(`Menjual ${nick} seharga ${price} ETH`);

            try {
                // 1. Cek Ulang Kepemilikan (Pre-Check)
                const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
                const realOwner = await coreContract.nickOwner(nickHash);
                
                if (realOwner.toLowerCase() !== userAddress.toLowerCase()) {
                    alert(`GAGAL: Nickname "${nick}" rusak (Owner 0x000).\nSilakan DAFTAR nickname BARU untuk testing.`);
                    return;
                }

                // 2. Kirim Transaksi
                const priceWei = ethers.parseEther(price);
                const tx = await marketContract.sellNickname(nick, priceWei);
                alert("Transaksi Terkirim! Menunggu konfirmasi...");
                await tx.wait();
                alert("Sukses!");
                loadMyInventory();
                loadMarketListings();

            } catch (e) {
                console.error(e);
                alert("Gagal: " + (e.reason || e.message));
            }
        }

        async function buyNickname(n, p) { try { await (await marketContract.buyNickname(n, {value:ethers.parseEther(p)})).wait(); loadMarketListings(); } catch(e){alert(e.reason||e.message)} }
        async function cancelSale(n) { try { await (await marketContract.cancelSale(n)).wait(); loadMyInventory(); } catch(e){alert(e.reason||e.message)} }
        async function switchNick(n) { try { await (await coreContract.switchNickname(n)).wait(); loadMyInventory(); } catch(e){alert(e.reason||e.message)} }

    </script>
</body>
</html>
