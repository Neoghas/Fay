<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto - Nickname Market</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #00d2ff;
            --accent: #ff007a;
            --bg: #0f1016;
            --card: #1a1b26;
            --gold: #ffd700;
            --success: #00ff9d;
        }
        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 20px;
        }
        
        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 20px;
        }
        .btn-connect {
            background: var(--primary); color: #000; border: none; padding: 8px 15px;
            border-radius: 8px; cursor: pointer; font-weight: bold;
        }

        /* --- GRID LAYOUT --- */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px;
        }
        @media (min-width: 800px) {
            .market-grid { grid-template-columns: repeat(4, 1fr); gap: 15px; }
        }

        /* --- CARD STYLES --- */
        .nick-card {
            background: linear-gradient(145deg, #1a1b26, #111);
            border: 1px solid #333;
            padding: 15px;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .nick-title-premium {
            font-size: 1.6em; font-weight: 900; margin-bottom: 5px; text-align: center;
            background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #b8860b 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 0px rgba(0,0,0,0.5));
        }
        .info-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; margin-bottom: 12px; font-size: 0.8em;
        }
        .price-tag { color: var(--success); font-weight: bold; font-size: 1.1em; }
        
        /* Tombol Action */
        .btn-action {
            width: 100%; padding: 8px; border: none; border-radius: 6px;
            font-weight: bold; cursor: pointer; margin-top: auto; font-size: 0.8em;
        }
        .btn-buy { background: var(--success); color: black; }
        .btn-sell { background: var(--accent); color: white; }
        .btn-use { background: var(--primary); color: black; }
        .btn-cancel { background: #555; color: white; }

        /* INPUT SELL */
        .sell-input {
            width: 100%; padding: 8px; margin-bottom: 8px;
            background: #111; border: 1px solid #444; color: white; border-radius: 5px;
        }

        /* TABLES & BADGES */
        .history-section { margin-top: 20px; }
        .table-responsive { overflow-x: auto; }
        .market-table { width: 100%; border-collapse: collapse; background: #15161c; border-radius: 8px; margin-top: 10px; }
        .market-table th, .market-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #2a2b36; }
        .market-table th { background-color: #222; color: #888; text-transform: uppercase; font-size: 0.85em; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        
        .badge-sell-active { background: rgba(0, 255, 157, 0.1); color: #00ff9d; border: 1px solid #00ff9d; }
        .badge-sell-sold { background: rgba(255, 77, 77, 0.1); color: #ff4d4d; border: 1px solid #ff4d4d; }
        .badge-buy { background: rgba(0, 210, 255, 0.1); color: #00d2ff; border: 1px solid #00d2ff; }
        
        .status-sale { color: #00ff9d; font-weight: bold; }
        .status-sold { color: #ff4d4d; font-weight: bold; }
        .status-success { color: #00d2ff; font-weight: bold; }

        /* TABS */
        .market-tabs { display: flex; width: 100%; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            flex: 1; padding: 8px 5px; background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); color: #aaa; cursor: pointer; border-radius: 12px; 
            font-weight: 700; font-size: 0.8em; transition: all 0.3s ease;
        }
        .tab-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }

        /* SEARCH & FILTER */
        .search-container { margin-bottom: 20px; }
        /* =========================================
   UPDATE GAYA SEARCH BAR PREMIUM
   ========================================= */

/* 1. Container Utama Search Bar */
.search-wrapper {
    display: flex;
    align-items: center;
    background: rgba(25, 26, 35, 0.8); /* Latar Gelap Transparan */
    border: 1px solid #333; /* Border Awal Abu gelap */
    border-radius: 12px;
    padding: 12px 15px;
    transition: all 0.3s ease; /* Animasi halus untuk border */
}

/* 2. Efek Saat Wrapper di-Hover atau Input di-Fokus */
/* :focus-within mendeteksi jika kita sedang mengetik di dalam wrapper */
.search-wrapper:hover,
.search-wrapper:focus-within {
    border-color: var(--primary); /* Ubah border jadi Biru Neon */
    box-shadow: 0 0 15px rgba(0, 210, 255, 0.3); /* Tambah Glow Biru */
    transform: translateY(-1px); /* Efek naik sedikit */
}


/* =========================================
   UPDATE GAYA ICON SEARCH (search.png)
   ========================================= */

.search-icon-img {
    /* Atur Ukuran Pas */
    width: 24px;
    height: 24px;
    margin-right: 12px; /* Jarak ke teks input */
    
    /* State Awal: Abu-abu & agak transparan agar menyatu */
    filter: grayscale(100%); 
    opacity: 0.6; 
    
    transition: all 0.3s ease; /* Animasi halus untuk perubahan warna */
}

/* Saat Wrapper di-Hover/Fokus, Icon Kembali Berwarna */
.search-wrapper:hover .search-icon-img,
.search-wrapper:focus-within .search-icon-img {
    filter: grayscale(0%); /* Warna asli muncul */
    opacity: 1; /* Transparansi hilang */
    transform: scale(1.1); /* Sedikit membesar biar interaktif */
}
        #searchInput { width: 100%; background: transparent; border: none; color: white; font-size: 1em; outline: none; }
        
        .filter-panel-simple {
            display: flex; flex-wrap: wrap; gap: 20px; background: rgba(13, 18, 30, 0.85);
            border: 1px solid rgba(0, 210, 255, 0.3); padding: 20px; border-radius: 12px; margin-bottom: 25px;
        }
        .filter-box { display: flex; flex-direction: column; gap: 8px; }
        .filter-label { font-size: 0.85rem; color: #00d2ff; font-weight: bold; }
        .cyber-select, .cyber-input {
            background-color: #0f172a; color: white; border: 1px solid #334155; padding: 10px; border-radius: 8px;
        }

        /* --- STYLE TOMBOL CLEAR (X) --- */
.search-clear-img {
    width: 12px;  /* SAYA REKOMENDASIKAN 24PX AGAR MUDAH DITAP DI HP */
    height: 12px; 
    cursor: pointer; 
    margin-left: 10px;
    opacity: 0; 
    visibility: hidden; 
    transform: scale(0.5) rotate(-90deg); 
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.search-clear-img.visible { 
    opacity: 1; 
    visibility: visible; 
    transform: scale(1) rotate(0deg); 
}

.search-clear-img:hover { 
    transform: scale(1.2) rotate(90deg); 
    filter: drop-shadow(0 0 5px #ff0055); 
}

/* --- STYLE 'NO RESULTS' (RADAR) --- */
.no-results-box {
    grid-column: 1 / -1; 
    text-align: center; 
    padding: 60px 20px;
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp { 
    from { opacity: 0; transform: translateY(20px); } 
    to { opacity: 1; transform: translateY(0); } 
}

.no-results-icon img { 
    width: 100px; 
    opacity: 0.6; 
    margin-bottom: 20px; 
    filter: grayscale(100%); 
}

.no-results-text { 
    font-size: 1.4em; 
    font-weight: bold; 
    color: #fff; 
    margin-bottom: 5px; 
}

.no-results-sub { 
    font-size: 0.9em; 
    color: #666; 
}

        /* TOAST */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 15px; }
        .toast-card {
            min-width: 300px; background: rgba(13, 18, 30, 0.95); border-left: 4px solid; color: #fff;
            padding: 15px 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            animation: slideInRight 0.4s forwards; display: flex; align-items: center; gap: 12px;
        }
        .toast-success { border-left-color: #00ff88; }
        .toast-error { border-left-color: #ff0055; }
        .toast-info { border-left-color: #00d2ff; }
        .toast-warning { border-left-color: #ffd700; }
        
        @keyframes slideInRight { from { transform: translateX(120%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <header>
        <a href="index" style="color:white; text-decoration:none;">Back to Game</a>
        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">Connect Wallet</button>
    </header>

    <div class="market-tabs">
        <button class="tab-btn active" onclick="switchTab('buy')" id="tab-buy">üõí Global Market</button>
        <button class="tab-btn" onclick="switchTab('inventory')" id="tab-inventory">üéí My Inventory</button>
    </div>

    <div id="market-search-panel">

    <div class="search-container">
        <div class="search-wrapper">
            <img src="search.png" class="search-icon-img">
            <input type="text" id="searchInput" placeholder="Search Nickname..." 
                   onkeyup="runSmartFilter()" 
                   oninput="toggleClear()">      
            <img src="x.svg" id="clearBtn" class="search-clear-img" onclick="clearSearch()">
        </div>
    </div>

    <div class="filter-panel-simple">
        <div class="filter-box">
            <label class="filter-label">Sort By</label>
            <select id="sortSelect" onchange="runSmartFilter()" class="cyber-select">
                <option value="newest">üÜï Terbaru (Newest)</option>
                <option value="price_low">üìâ Harga Terendah</option>
                <option value="price_high">üìà Harga Tertinggi</option>
                <option value="rarity_high">üëë Rarity Tertinggi</option>
            </select>
        </div>

        <div class="filter-box">
            <label class="filter-label">Price Range (ETH)</label>
            <div class="price-input-group">
                <input type="number" id="minPrice" placeholder="0.01" onkeyup="runSmartFilter()" class="cyber-input" style="width:80px;">
                <span style="margin:0 5px;">-</span>
                <input type="number" id="maxPrice" placeholder="Max" onkeyup="runSmartFilter()" class="cyber-input" style="width:80px;">
            </div>
        </div>
    </div>

    </div>

    <div id="view-buy" class="market-view">
        <div id="market-list" class="market-grid">
            <div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">
                Scanning Listings...
            </div>
        </div>
    </div>

    <div id="view-inventory" class="market-view" style="display:none;">
        <div style="background:rgba(0, 210, 255, 0.1); border:1px solid var(--primary); padding:15px; border-radius:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-size:0.8em; color:#aaa;">CURRENT ACTIVE NICKNAME</div>
                <div id="active-nick-display" style="font-size:1.5em; font-weight:bold; color:white;">-</div>
            </div>
            <div style="color:var(--success); font-weight:bold;">‚úÖ IN USE</div>
        </div>

        <h3 style="color:#aaa; border-bottom:1px solid #333; padding-bottom:10px;">Collection & Sell</h3>
        <div id="inventory-list" class="market-grid">
            <div style="grid-column:1/-1; text-align:center; color:#666;">Loading inventory...</div>
        </div>

        <div class="history-section">
            <h3 style="color:var(--gold); border-bottom:1px solid #333; padding-bottom:10px; margin-top:30px;">
                üìú Market Status & History
            </h3>
            <div class="table-responsive">
                <table class="market-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Nickname</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Date</th> 
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <tr><td colspan="5" style="text-align:center;">Loading history...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // --- 1. CONFIGURATION ---
        // Karena logic Market sudah dipisah, Alamat ini adalah Alamat Contract MARKET
        const CONTRACT_ADDRESS = "0x9E1273d40A16ddB092AceBbA0716983a31be58af"; 
        const DEPLOY_BLOCK = 34750547; // Sesuaikan jika perlu

        // Base Sepolia Configuration
        const BASE_SEPOLIA_CHAIN_ID = '0x14a34'; // 84532
        const BASE_SEPOLIA_CONFIG = {
            chainId: BASE_SEPOLIA_CHAIN_ID,
            chainName: 'Base Sepolia Testnet',
            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
            rpcUrls: ['https://sepolia.base.org'],
            blockExplorerUrls: ['https://sepolia.basescan.org']
        };

        // ABI LENGKAP UNTUK MARKET (Termasuk Struct & Event Baru)
        const GAME_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameDelisted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"marketId","type":"uint256"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameListed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"oldPrice","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"NicknamePriceUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NicknameSold","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"nickA","type":"string"},{"indexed":false,"internalType":"string","name":"nickB","type":"string"},{"indexed":false,"internalType":"address","name":"ownerA","type":"address"},{"indexed":false,"internalType":"address","name":"ownerB","type":"address"}],"name":"SwapAccepted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"myNick","type":"string"},{"indexed":false,"internalType":"string","name":"targetNick","type":"string"}],"name":"SwapCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"myNick","type":"string"},{"indexed":false,"internalType":"string","name":"targetNick","type":"string"},{"indexed":false,"internalType":"uint256","name":"ethOffered","type":"uint256"},{"indexed":false,"internalType":"address","name":"initiator","type":"address"}],"name":"SwapRequested","type":"event"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"buyNickname","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"}],"name":"cancelSale","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_myNick","type":"string"},{"internalType":"string","name":"_targetNick","type":"string"}],"name":"cancelSwap","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentMarketId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_myNick","type":"string"},{"internalType":"string","name":"_offeredNick","type":"string"}],"name":"executeSwap","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"gameContractAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"marketIdToHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"myNicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickHandHistory","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickMarketplace","outputs":[{"internalType":"uint256","name":"marketId","type":"uint256"},{"internalType":"bool","name":"isForSale","type":"bool"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"address","name":"seller","type":"address"},{"internalType":"uint256","name":"listedAt","type":"uint256"},{"internalType":"enum Market.Rarity","name":"rarity","type":"uint8"},{"internalType":"uint256","name":"ownerCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nickOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"string","name":"_nick","type":"string"}],"name":"registerNicknameFromGame","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_myNick","type":"string"},{"internalType":"string","name":"_targetNick","type":"string"}],"name":"requestSwap","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_nick","type":"string"},{"internalType":"uint256","name":"_price","type":"uint256"}],"name":"sellNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_game","type":"address"}],"name":"setGameContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"swapRequests","outputs":[{"internalType":"address","name":"initiator","type":"address"},{"internalType":"string","name":"myNick","type":"string"},{"internalType":"string","name":"targetNick","type":"string"},{"internalType":"uint256","name":"ethOffered","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_newNick","type":"string"}],"name":"switchNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"}],"stateMutability":"view","type":"function"}];
        
        let provider, signer, gameContract;
        let userAddress = null;
        let rawMarketData = []; // Wadah untuk filter

        // --- 2. CORE FUNCTIONS ---
async function connectWallet() {
    if (window.ethereum) {
        try {
            // 1. SWITCH CHAIN (LOGIKA STANDAR)
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BASE_SEPOLIA_CONFIG],
                        });
                    } catch (addError) { return; }
                } else { return; }
            }

            // 2. SETUP PROVIDER & ADDRESS
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();

            // -------------------------------------------------------------
            // üî• LOGIKA BARU: SIGNATURE & LOCAL STORAGE (SESSION 1 BULAN) üî•
            // -------------------------------------------------------------
            
            // Kunci penyimpanan unik per wallet (supaya kalau ganti akun tidak bentrok)
            const STORAGE_KEY = `faylotto_auth_${userAddress.toLowerCase()}`;
            
            // Cek apakah ada data sesi tersimpan?
            const cachedSession = localStorage.getItem(STORAGE_KEY);
            let isSessionValid = false;

            // A. CEK VALIDASI SESI LAMA
            if (cachedSession) {
                const sessionData = JSON.parse(cachedSession);
                const now = Date.now();
                
                // Syarat Valid: Alamat sama DAN Waktu belum expired
                if (sessionData.address === userAddress && now < sessionData.expiry) {
                    console.log("‚úÖ Auto-Login: Sesi valid (Signature cached).");
                    isSessionValid = true; 
                } else {
                    // Jika expired, hapus sampah lama
                    console.log("‚ö†Ô∏è Sesi habis, meminta tanda tangan ulang...");
                    localStorage.removeItem(STORAGE_KEY);
                }
            }

            // B. JIKA BELUM ADA / TIDAK VALID -> MINTA SIGNATURE BARU
            if (!isSessionValid) {
                if(typeof showToast === 'function') showToast("Please sign message to login...", "info");
                
                // Format Pesan Sesuai Permintaan
                const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const localTime = new Date().toLocaleString();
                const uniqueId = Date.now(); // ID Unik berdasarkan Timestamp (ms)

                const message = `Welcome To Faylotto Nickname Market\n\nUser: ${userAddress}\nZone: ${timeZone} (${localTime})\nSession ID: ${uniqueId}`;

                try {
                    // Minta User Sign di MetaMask (Gratis, tidak pakai gas)
                    const signature = await signer.signMessage(message);
                    
                    // Hitung Waktu Expired (30 Hari ke depan)
                    // 30 hari * 24 jam * 60 menit * 60 detik * 1000 milidetik
                    const expiryDate = Date.now() + (30 * 24 * 60 * 60 * 1000);

                    // Simpan Data ke Local Storage
                    const newSession = {
                        address: userAddress,
                        signature: signature,
                        expiry: expiryDate,
                        loginTime: Date.now()
                    };
                    
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(newSession));
                    if(typeof showToast === 'function') showToast("Login Successful! Session saved for 30 days.", "success");

                } catch (signErr) {
                    console.error("Signature Rejected:", signErr);
                    if(typeof showToast === 'function') showToast("Login Failed: You rejected the signature.", "error");
                    // Reset variabel jika user menolak, supaya UI tidak berubah jadi connect
                    userAddress = null;
                    signer = null;
                    return; 
                }
            }

            // -------------------------------------------------------------
            // 3. JIKA LOLOS AUTH, LANJUT LOAD APP
            // -------------------------------------------------------------
            
            // Inisialisasi Contract (Market)
            gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, signer);
            
            // Update Tombol Connect
            const btn = document.getElementById('connectBtn');
            if(btn) {
                btn.innerText = userAddress.substring(0,6) + "..." + userAddress.slice(-4);
                btn.style.background = "var(--success)";
                btn.style.color = "black";
            }
            
            // Load Data
            if(typeof loadMyInventory === 'function') loadMyInventory();
            if(typeof loadMarketListings === 'function') loadMarketListings();

        } catch (err) {
            console.error("Connection Error:", err);
            if(typeof showToast === 'function') showToast("Terjadi kesalahan koneksi.", "error");
        }
    } else {
        if(typeof showToast === 'function') showToast("Please install EVM Wallet!", "warning");
    }
}

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.market-view').forEach(v => v.style.display = 'none');
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`view-${tab}`).style.display = 'block';

            const filterPanel = document.getElementById('market-search-panel');
            if (filterPanel) {
                // Tampilkan filter hanya di tab BUY
                filterPanel.style.display = (tab === 'buy') ? 'block' : 'none';
            }
            if(tab === 'inventory') loadMyInventory();
            if(tab === 'buy') loadMarketListings();
        }

        // --- 3. LOAD MARKET LISTINGS (GLOBAL) ---
        // FIX: Menggunakan logika struct & event baru
        async function loadMarketListings() {
            if(!gameContract) return;

            rawMarketData = [];
            const container = document.getElementById('market-list');
            if(container) container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">Scanning Blockchain...</div>';
            
            try {
                // Ambil Event NicknameListed dari Contract
                // Event Baru: (marketId, seller, nickname, price, timestamp)
                const filter = gameContract.filters.NicknameListed();
                const logs = await gameContract.queryFilter(filter, DEPLOY_BLOCK, "latest");

                const uniqueListings = new Map();

                // Loop Log (Terbaru)
                for (const log of logs.reverse()) {
                    // Args Index Baru: 0=Id, 1=Seller, 2=Nick, 3=Price, 4=Time
                    const nick = log.args[2]; 
                    const timestamp = log.args[4]; 
                    
                    if (!uniqueListings.has(nick)) {
                        uniqueListings.set(nick, { timestamp }); 
                    }
                }

                if(uniqueListings.size === 0) {
                     if(container) container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:40px;">Market is empty.</div>';
                     return;
                }

                for (let [nick, data] of uniqueListings) {
                    const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
                    const saleData = await gameContract.nickMarketplace(nickHash);
                    
                    // Struct Baru: [marketId, isForSale, price, seller, listedAt, rarity, ...]
                    const isForSale = saleData[1]; // Index 1 isForSale (Bool)

                    if (isForSale) {
                        const currentPriceBig = saleData[2]; // Index 2 Price
                        const currentSeller = saleData[3];   // Index 3 Seller
                        const currentRarity = Number(saleData[5]); // Index 5 Rarity
                        
                        const priceEth = ethers.formatEther(currentPriceBig);
                        const avatarUrl = `https://api.dicebear.com/7.x/identicon/svg?seed=${nick}`;

                        // Push ke Array Global
                        rawMarketData.push({
                            nickname: nick,
                            priceEth: parseFloat(priceEth),
                            rarity: currentRarity,
                            marketId: Number(saleData[0]),
                            seller: currentSeller,
                            avatarUrl: avatarUrl,
                            isMyListing: (userAddress && currentSeller.toLowerCase() === userAddress.toLowerCase())
                        });
                    }
                }
                
                runSmartFilter(); // Render hasil scan

            } catch (e) {
                console.error("Market Load Error:", e);
                if(container) container.innerHTML = `<div style="color:red; text-align:center; grid-column:1/-1;">Error: ${e.message}</div>`;
            }
        }

        // --- LOAD INVENTORY (CLEAN HISTORY VERSION) ---
async function loadMyInventory() {
    if(!gameContract || !userAddress) return;
    
    const container = document.getElementById('inventory-list');
    const tableBody = document.getElementById('history-body');
    
    // UI Loading
    if(container) container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:20px;">Updating Collection...</div>';
    if(tableBody) tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Scanning Clean History...</td></tr>';

    try {
        // ==========================================
        // 1. PERSIAPAN DATA
        // ==========================================
        const userData = await gameContract.users(userAddress);
        const activeNick = userData[0] || "-";
        if(document.getElementById('active-nick-display')) {
            document.getElementById('active-nick-display').innerText = activeNick;
        }

        // Wadah untuk menyimpan item yang SEDANG DIJUAL (Active Listings)
        let activeSellItems = [];

        // ==========================================
        // 2. PROSES GRID KOLEKSI & CARI YANG AKTIF
        // ==========================================
        let rawNicks = [];
        let index = 0;
        
        // Loop Nickname User
        while(true) {
            try {
                const nick = await gameContract.myNicknames(userAddress, index);
                rawNicks.push(nick);
                index++;
            } catch (e) { break; }
        }
        
        const uniqueNicks = [...new Set(rawNicks)];
        
        // Render Grid
        if(container) container.innerHTML = ""; 
        
        if (uniqueNicks.length === 0) {
            if(container) container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555; padding:20px;">You don't own any nicknames yet.</div>`;
        } else {
            for (let nick of uniqueNicks) {
                const isActive = (nick === activeNick);
                const nickHash = ethers.keccak256(ethers.toUtf8Bytes(nick));
                const saleData = await gameContract.nickMarketplace(nickHash);
                
                // Struct: [0]marketId, [1]isForSale, [2]price, [3]seller, [4]listedAt
                const isForSale = saleData[1]; 
                const priceBig = saleData[2];  
                const listedAt = Number(saleData[4]); // Ambil waktu listing

                // --- LOGIKA UTAMA PEMBERSIHAN ---
                // Jika barang SEDANG DIJUAL, simpan ke array activeSellItems untuk tabel nanti
                if (isForSale) {
                    activeSellItems.push({
                        type: 'Sell',
                        nick: nick,
                        price: ethers.formatEther(priceBig),
                        status: 'On Sale üõí',
                        cssClass: 'status-sale',
                        badgeType: 'badge-sell-active',
                        timestamp: listedAt // Gunakan waktu real dari struct
                    });
                }

                // Render Kartu Grid (Visual)
                const div = document.createElement('div');
                div.className = 'nick-card';
                
                let actionHtml = '';
                if (isForSale) {
                    const priceEth = ethers.formatEther(priceBig);
                    actionHtml = `
                        <div style="font-size:0.8em; color:var(--gold); text-align:center; margin-bottom:5px;">Listed: ${priceEth} ETH</div>
                        <button class="btn-action btn-cancel" onclick="cancelSale('${nick}')">‚ùå Cancel Sale</button>
                    `;
                } else {
                    let switchBtn = isActive 
                        ? `<div style="text-align:center; color:var(--success); font-weight:bold; padding:8px;">‚úÖ ACTIVE</div>`
                        : `<button class="btn-action btn-use" onclick="switchNick('${nick}')" style="margin-bottom:5px;">üîÑ USE</button>`;

                    actionHtml = `
                        ${switchBtn}
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <input type="number" id="price-${nick}" class="sell-input" placeholder="ETH" style="margin-bottom:0; width:60%;">
                            <button class="btn-action btn-sell" onclick="sellNickname('${nick}')" style="width:40%; margin-top:0;">SELL</button>
                        </div>
                    `;
                }
                div.innerHTML = `
                    <div class="nick-title-premium" style="margin-top:25px;">${nick}</div>
                    <div style="text-align:center; margin-bottom:10px;">
                        <span class="owner-badge">Item</span>
                    </div>
                    ${actionHtml}
                `;
                if(container) container.appendChild(div);
            }
        }

        // ==========================================
        // 3. PROSES TABEL BERSIH (GABUNGAN)
        // ==========================================
        
        // A. Ambil Data TRANSAKSI SUKSES SAJA (Sold/Bought)
        // Kita TIDAK mengambil data "Listed" dari log, supaya listing yg dicancel tidak muncul
        const filterSold = gameContract.filters.NicknameSold();
        const logsSold = await gameContract.queryFilter(filterSold, DEPLOY_BLOCK, "latest");

        let cleanHistory = [];
        const processedIDs = new Set(); 

        // Masukkan Data Penjualan/Pembelian (History Permanen)
        await Promise.all(logsSold.map(async (log) => {
            const uniqueID = `${log.transactionHash}_${log.index}`;
            if (processedIDs.has(uniqueID)) return;
            processedIDs.add(uniqueID);

            // Event: NicknameSold(buyer, seller, nickname, price, timestamp)
            // Index Args:          0       1        2        3        4
            const buyer = log.args[0].toLowerCase();
            const seller = log.args[1].toLowerCase();
            const nick = log.args[2]; 
            const price = ethers.formatEther(log.args[3]); 
            const timestamp = Number(log.args[4]);

            if (buyer === userAddress.toLowerCase()) {
                cleanHistory.push({ type: 'Buy', nick, price, status: 'Taken ‚úÖ', cssClass: 'status-success', badgeType: 'badge-buy', timestamp });
            } 
            else if (seller === userAddress.toLowerCase()) {
                cleanHistory.push({ type: 'Sell', nick, price, status: 'SOLDOUT ‚úÖ', cssClass: 'status-sold', badgeType: 'badge-sell-sold', timestamp });
            }
        }));

        // B. GABUNGKAN DENGAN ITEM YANG SEDANG AKTIF DIJUAL
        // Item yang dicancel tidak akan masuk ke sini, karena di loop atas (langkah 2) isForSale-nya False.
        cleanHistory = cleanHistory.concat(activeSellItems);

        // C. Sorting (Terbaru Paling Atas)
        cleanHistory.sort((a, b) => b.timestamp - a.timestamp);

        // D. Render Tabel Final
        if(tableBody) {
            tableBody.innerHTML = "";
            if (cleanHistory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No active listings or history.</td></tr>';
            } else {
                cleanHistory.forEach(item => {
                    const dateObj = new Date(item.timestamp * 1000);
                    const dateStr = dateObj.toLocaleDateString('id-ID', {day:'numeric', month:'short'});
                    const timeStr = dateObj.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});

                    const row = `
                        <tr>
                            <td><span class="badge ${item.badgeType}">${item.type}</span></td>
                            <td style="font-weight:bold; color:white;">${item.nick}</td>
                            <td style="color:#00d2ff;">${item.price} ETH</td> 
                            <td class="${item.cssClass}">${item.status}</td>
                            <td style="color:#888; font-size:0.85em;">${dateStr} ${timeStr}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
        }

    } catch (e) {
        console.error("Error History:", e);
        if(tableBody) tableBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">Error loading history: ${e.message}</td></tr>`;
    }
}

        // --- 5. FILTERING SYSTEM (UPGRADED) ---
function runSmartFilter() {
    const container = document.getElementById('market-list');
    if (!container) return;
    
    // 1. Ambil Nilai Input
    const searchInput = document.getElementById('searchInput');
    const searchText = searchInput.value.toLowerCase();
    const sortType = document.getElementById('sortSelect').value;
    const minP = parseFloat(document.getElementById('minPrice').value) || 0;
    const maxP = parseFloat(document.getElementById('maxPrice').value) || 999999;

    // 2. Kontrol Tombol Clear (X) - Otomatis muncul jika ada teks
    toggleClear(); 

    // 3. Proses Filter
    let results = rawMarketData.filter(item => {
        if (!item.nickname.toLowerCase().includes(searchText)) return false;
        if (item.priceEth < minP || item.priceEth > maxP) return false;
        return true;
    });

    // 4. Sorting
    results.sort((a, b) => {
        if (sortType === 'newest') return b.marketId - a.marketId;
        if (sortType === 'price_low') return a.priceEth - b.priceEth;
        if (sortType === 'price_high') return b.priceEth - a.priceEth;
        if (sortType === 'rarity_high') return b.rarity - a.rarity;
        return 0;
    });

    // 5. Render Hasil
    container.innerHTML = "";
    
    // --- JIKA KOSONG -> TAMPILKAN GAMBAR RADAR ---
    if (results.length === 0) {
        // Cek apakah kosong karena search atau memang belum ada data sama sekali?
        if (rawMarketData.length > 0) {
            // Kosong karena filter (Search tidak ketemu)
            container.innerHTML = `
                <div class="no-results-box">
                    <div class="no-results-icon">
                        <img src="radar.svg" alt="Radar Scan">
                    </div>
                    <div class="no-results-text">No Nickname Found</div>
                    <div class="no-results-sub">
                        Try searching for "${searchInput.value}" with different keywords
                    </div>
                </div>
            `;
        } else {
            // Kosong karena memang belum ada data di market
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#666;">Market is currently empty.</div>`;
        }
        return;
    }

    // --- JIKA ADA HASIL -> RENDER KARTU ---
    results.forEach(item => {
        let rarityClass = "card-common";
        if (item.rarity === 1) rarityClass = "card-rare";
        if (item.rarity === 2) rarityClass = "card-legendary";
        if (item.rarity === 3) rarityClass = "card-mythical";

        let btnAction = item.isMyListing
            ? `<button class="btn-action btn-cancel" onclick="cancelSale('${item.nickname}')">Cancel Listing</button>`
            : `<button class="btn-action btn-buy" onclick="buyNickname('${item.nickname}', '${item.priceEth}')">‚ö° BUY NOW</button>`;

        const cardHTML = `
            <div class="nick-card ${rarityClass}">
                <div style="text-align:center; padding:10px;">
                    <img src="${item.avatarUrl}" class="seller-avatar" style="width:50px; height:50px;">
                </div>
                <div class="nick-title-premium">${item.nickname}</div>
                <div class="info-bar">
                    <span>Seller: ${item.seller.substring(0, 6)}...</span>
                    <span class="price-tag">${item.priceEth.toFixed(4)} ETH</span>
                </div>
                ${btnAction}
            </div>
        `;
        container.insertAdjacentHTML('beforeend', cardHTML);
    });
}

// --- HELPER: TOMBOL CLEAR ---

function toggleClear() {
    const input = document.getElementById('searchInput');
    const btn = document.getElementById('clearBtn');
    if (input && btn) {
        if (input.value.length > 0) {
            btn.classList.add('visible');
        } else {
            btn.classList.remove('visible');
        }
    }
}

function clearSearch() {
    const input = document.getElementById('searchInput');
    if (input) {
        input.value = '';
        input.focus(); // Kembalikan kursor ke input
        runSmartFilter(); // Jalankan filter ulang (hasil reset)
    }
}
        
        // --- 6. ACTIONS (BUY/SELL) ---
        async function buyNickname(nick, priceEth) {
            try {
                const tx = await gameContract.buyNickname(nick, { value: ethers.parseEther(priceEth.toString()) });
                showToast("Buying...", "loading");
                await tx.wait();
                showToast("Success!", "success");
                loadMarketListings(); loadMyInventory();
            } catch(e) { showToast(e.message, "error"); }
        }

        async function sellNickname(nick) {
            const input = document.getElementById(`price-${nick}`);
            if(!input || !input.value) return showToast("Enter Price!", "warning");
            try {
                const priceWei = ethers.parseEther(input.value.toString());
                const tx = await gameContract.sellNickname(nick, priceWei);
                showToast("Listing item...", "loading");
                await tx.wait();
                showToast("Listed Successfully!", "success");
                loadMyInventory();
            } catch(e) { showToast(e.reason || e.message, "error"); }
        }

        async function cancelSale(nick) {
            try {
                const tx = await gameContract.cancelSale(nick);
                showToast("Cancelling...", "loading");
                await tx.wait();
                showToast("Cancelled!", "success");
                loadMyInventory();
            } catch(e) { showToast(e.reason || e.message, "error"); }
        }

        async function switchNick(nick) {
            try {
                const tx = await gameContract.switchNickname(nick);
                showToast("Switching...", "loading");
                await tx.wait();
                showToast("Active Nickname Updated!", "success");
                loadMyInventory();
            } catch(e) { showToast(e.reason || e.message, "error"); }
        }

        // Toast Helper
        function showToast(msg, type) {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = `toast-card toast-${type}`;
            d.innerText = msg;
            c.appendChild(d);
            setTimeout(() => d.remove(), 4000);
        }

        window.onload = connectWallet;
    </script>
</body>
</html>
