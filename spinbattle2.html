<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Faylotto Spin Battle — Wheel Donut</title>

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" integrity="" crossorigin="anonymous"></script>
  <!-- Ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0f1a;
      --card:#0f1622;
      --accent:#7c5cff;
      --muted:#9aa7c7;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(circle at 10% 10%, #071024 0%, #01040a 60%);
      color:#e6eef8;
      padding:28px;
    }

    .app {
      width:980px;
      max-width:95%;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:14px;
      padding:22px;
      box-shadow: 0 8px 30px rgba(1,8,20,0.6);
      position:relative;
    }

    .topbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .brand h1{font-size:18px;margin:0}
    .wallet-btn {
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.04);
      padding:8px 14px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:center;
      font-size:14px;
    }
    .wallet-dot{width:10px;height:10px;border-radius:50%;background:#32d74b;box-shadow:0 0 6px #32d74b44;}
    .wallet-addr{font-family:monospace;font-size:13px;color:var(--muted);max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    .layout {
      display:flex;
      gap:24px;
      align-items:flex-start;
    }

    /* Wheel area */
    .wheel-area{
      width:540px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:12px;
      padding:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      justify-content:center;
    }

    canvas#wheel {
      width:420px;
      height:420px;
      border-radius:50%;
      background: conic-gradient(#081021, #07101d);
      box-shadow: 0 12px 30px rgba(0,0,0,0.6), inset 0 4px 20px rgba(255,255,255,0.02);
    }

    .wheel-center {
      position:relative;
      margin-top:-380px;
      pointer-events:none;
      width:420px;
      height:420px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .donut-hole {
      width:140px;height:140px;border-radius:50%;
      background:linear-gradient(180deg,#0a111a,#071021);
      border:6px solid rgba(255,255,255,0.02);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      box-shadow:0 8px 20px rgba(0,0,0,0.6);
      pointer-events:none;
    }
    .donut-hole h2{margin:0;font-size:16px}
    .donut-hole p{margin:0;font-size:12px;color:var(--muted)}

    .spin-controls{
      display:flex;
      gap:12px;
      margin-top:6px;
      align-items:center;
    }
    .btn {
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border:1px solid rgba(255,255,255,0.04);
      padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600;
    }
    .btn.primary {
      background:linear-gradient(180deg,var(--accent), #5a44f2);
      color:white;border:none;box-shadow:0 8px 30px rgba(92, 64, 255, 0.18);
    }
    .muted { color:var(--muted); font-size:13px; }

    /* Right panel */
    .info-panel{
      width:320px;
      background:var(--card);
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:300px;
    }
    .info-panel h3{margin:0 0 6px 0}
    .info-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.01);font-size:14px}
    .small {font-size:12px;color:var(--muted)}

    /* Modal */
    .modal-overlay {
      position:fixed;inset:0;background:rgba(2,6,15,0.6);display:none;align-items:center;justify-content:center;z-index:60;
    }
    .modal {
      width:460px;background:linear-gradient(180deg,#091123,#07101a);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.04);
      box-shadow:0 20px 60px rgba(0,0,0,0.7);
    }
    .modal .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal .modal-body{display:flex;flex-direction:column;gap:10px}
    .field {display:flex;flex-direction:column;gap:6px}
    input[type="number"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px;
    }
    .token-select{display:flex;gap:8px}
    .token-item{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .token-item.active{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-color:rgba(124,92,255,0.6);}

    .pct-row{display:flex;gap:8px}
    .pct-btn{flex:1;padding:8px;border-radius:8px;text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .deposit-info{display:flex;gap:8px;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
    .disconnect{margin-top:6px;padding:10px;border-radius:10px;background:#1a2230;border:1px solid rgba(255,255,255,0.03);cursor:pointer}

    .note { font-size:12px;color:var(--muted) }
    .tiny { font-size:11px;color:var(--muted) }
    .addr { font-family:monospace; font-size:13px; color: #cfe3ff; }

    @media (max-width:900px){
      .layout{flex-direction:column;align-items:center}
      .wheel-area{width:100%}
      .info-panel{width:100%}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img src="" alt="" style="width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,#7c5cff,#4da6ff)">
        <div>
          <h1>Faylotto Spin Battle</h1>
          <div class="small">Visual wheel & place-bet UI — connected to contract</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center">
        <div class="small">Round ID: <span id="roundId">-</span></div>
        <button id="walletBtn" class="wallet-btn" title="Open wallet / place bet">
          <span class="wallet-dot" id="walletDot" style="display:none"></span>
          <span id="walletLabel">Connect</span>
        </button>
      </div>
    </div>

    <div class="layout">
      <div class="wheel-area">
        <div style="position:relative">
          <canvas id="wheel" width="840" height="840"></canvas>
          <div class="wheel-center">
            <div class="donut-hole">
              <h2 id="wheelTitle">Spin Battle</h2>
              <p id="wheelSubtitle" class="small">Visual weights from on-chain deposits</p>
            </div>
          </div>
        </div>

        <div class="spin-controls">
          <button id="spinBtn" class="btn primary">Spin</button>
          <button id="placeBetBtn" class="btn">Place Bet</button>
          <div class="muted tiny">Predicted by client — on-chain decides final winner</div>
        </div>

        <div class="muted tiny">Last winner: <span id="lastWinner">-</span></div>
      </div>

      <div class="info-panel">
        <h3>Round Info</h3>
        <div class="info-row"><div>Players</div><div id="playersCount">0</div></div>
        <div class="info-row"><div>Total ETH</div><div id="totalETH">0</div></div>
        <div class="info-row"><div>Total USDT</div><div id="totalUSDT">0</div></div>
        <div style="height:8px"></div>
        <h3>Your Deposits</h3>
        <div class="info-row"><div>ETH</div><div id="yourETH">0</div></div>
        <div class="info-row"><div>USDT</div><div id="yourUSDT">0</div></div>
        <div style="height:8px"></div>
        <h3>Actions</h3>
        <div style="display:flex;gap:8px;">
          <button id="refreshBtn" class="btn">Refresh</button>
          <button id="openPlaceBet" class="btn">Open Bet</button>
        </div>
        <div style="flex:1"></div>
        <div class="small">Contract status & quick tools</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h3 id="modalTitle">Place Bet</h3>
        <div>
          <button id="closeModal" class="btn">Close</button>
        </div>
      </div>
      <div class="modal-body">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="tiny">Wallet</div>
            <div class="addr" id="modalAddr">Not connected</div>
          </div>
          <div>
            <div class="tiny">Status</div>
            <div id="modalStatus" class="small">Disconnected</div>
          </div>
        </div>

        <div class="field">
          <div class="tiny">Token</div>
          <div class="token-select">
            <div id="tokenETH" class="token-item active">ETH</div>
            <div id="tokenUSDT" class="token-item">USDT</div>
          </div>
        </div>

        <div class="field">
          <div class="tiny">Amount</div>
          <input id="amountInput" type="number" step="any" placeholder="0.0001" min="0" />
        </div>

        <div class="field">
          <div class="tiny">Quick %</div>
          <div class="pct-row">
            <div class="pct-btn" data-pct="5">5%</div>
            <div class="pct-btn" data-pct="10">10%</div>
            <div class="pct-btn" data-pct="25">25%</div>
            <div class="pct-btn" data-pct="50">50%</div>
            <div class="pct-btn" data-pct="75">75%</div>
            <div class="pct-btn" data-pct="100">100%</div>
          </div>
        </div>

        <div>
          <div class="tiny">Your current round deposits</div>
          <div class="deposit-info"><div>ETH deposited</div><div id="modalYourETH">0</div></div>
          <div class="deposit-info"><div>USDT deposited</div><div id="modalYourUSDT">0</div></div>
        </div>

        <div style="display:flex;gap:8px;">
          <button id="modalPlaceBet" class="btn primary" style="flex:1">Place Bet</button>
          <button id="modalDisconnect" class="disconnect" style="flex:1">Disconnect</button>
        </div>

        <div class="note">Min ETH: <b>0.0001</b> • Max ETH: <b>0.00256</b> — Min USDT: <b>0.5</b> • Max USDT: <b>10</b></div>
      </div>
    </div>
  </div>

<script>
/*
  Frontend JS: wheel donut with GSAP + ethers integration
  - Edit CONTRACT_ADDRESS and USDT_CONTRACT_ADDRESS to point to deployed contract addresses.
  - Uses ethers.js v6
*/

const CONTRACT_ADDRESS = "0xcB1262c9a322dD3191aeA92077fE65A59c71e0a7";
const USDT_CONTRACT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2"; // ERC20 token (USDT) address
const CHAIN_ID = 11155111; // Sepolia example; adjust to network used

// Minimal ABI fragments we call
const ABI = [{"inputs":[{"internalType":"address","name":"_erc20Token","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetERC20","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_BETS_PER_PLAYER","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20Token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"erc20Reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalERC20","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getWinnerCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsERC20","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

  const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

let provider, signer, contract;
let currentRound = null;
let players = []; // array of {address, eth, erc20, weight}
let yourAddress = null;
let erc20Decimals = 18;

const walletBtn = document.getElementById('walletBtn');
const walletLabel = document.getElementById('walletLabel');
const walletDot = document.getElementById('walletDot');
const modalOverlay = document.getElementById('modalOverlay');
const closeModal = document.getElementById('closeModal');
const tokenETH = document.getElementById('tokenETH');
const tokenUSDT = document.getElementById('tokenUSDT');
const amountInput = document.getElementById('amountInput');
const pctBtns = document.querySelectorAll('.pct-btn');
const modalAddr = document.getElementById('modalAddr');
const modalStatus = document.getElementById('modalStatus');
const modalPlaceBet = document.getElementById('modalPlaceBet');
const modalDisconnect = document.getElementById('modalDisconnect');
const placeBetBtn = document.getElementById('placeBetBtn');
const openPlaceBet = document.getElementById('openPlaceBet');
const spinBtn = document.getElementById('spinBtn');
const refreshBtn = document.getElementById('refreshBtn');

const playersCountEl = document.getElementById('playersCount');
const totalETHEl = document.getElementById('totalETH');
const totalUSDTEl = document.getElementById('totalUSDT');
const yourETHEl = document.getElementById('yourETH');
const yourUSDTEl = document.getElementById('yourUSDT');
const roundIdEl = document.getElementById('roundId');
const lastWinnerEl = document.getElementById('lastWinner');
const modalYourETH = document.getElementById('modalYourETH');
const modalYourUSDT = document.getElementById('modalYourUSDT');

const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const size = canvas.width;
const cx = size/2;
const cy = size/2;
const outerR = size*0.45;
const innerR = size*0.2;
let rotation = 0;

// limits
const MIN_ETH = 0.0001;
const MAX_ETH = 0.00256;
const MIN_USDT = 0.5;
const MAX_USDT = 10;

// utilities
function short(addr){
  if(!addr) return '-';
  return addr.slice(0,6) + '...' + addr.slice(-4);
}
function toNum(x){
  try{ return Number(x.toString()); } catch(e){ return 0; }
}

// connect wallet
async function connectWallet(){
  if(window.ethereum === undefined){
    alert("Please install MetaMask or compatible wallet.");
    return;
  }
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  yourAddress = await signer.getAddress();
  const network = await provider.getNetwork();
  // instantiate contract
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  // attempt to fetch token decimals for display (ERC20)
  try {
    const erc20 = new ethers.Contract(USDT_CONTRACT_ADDRESS, ["function decimals() view returns (uint8)","function balanceOf(address) view returns (uint256)"], provider);
    erc20Decimals = await erc20.decimals();
  } catch(e){
    console.warn("Could not read token decimals", e);
    erc20Decimals = 18;
  }

  walletLabel.textContent = short(yourAddress);
  walletDot.style.display = 'inline-block';
  modalAddr.textContent = yourAddress;
  modalStatus.textContent = "Connected";
  walletLabel.title = yourAddress;

  // show connected state
  walletBtn.onclick = () => openModal();
  fetchRoundAndPlayers();
}

// disconnect wallet (client-side)
function disconnectWallet(){
  provider = null;
  signer = null;
  contract = null;
  yourAddress = null;
  walletLabel.textContent = "Connect";
  walletDot.style.display = 'none';
  modalAddr.textContent = "Not connected";
  modalStatus.textContent = "Disconnected";
  modalOverlay.style.display = 'none';
}

// open/close modal
function openModal(){
  modalOverlay.style.display = 'flex';
}
function closeModalFn(){
  modalOverlay.style.display = 'none';
}

// wire modal close
closeModal.onclick = closeModalFn;
modalOverlay.onclick = (e)=>{ if(e.target===modalOverlay) closeModalFn(); }
walletBtn.addEventListener('click', async ()=>{
  if(!yourAddress) await connectWallet();
  else openModal();
});
placeBetBtn.addEventListener('click', async ()=>{
  if(!yourAddress) {
    await connectWallet();
  }
  openModal();
});
openPlaceBet.addEventListener('click', ()=>{
  if(!yourAddress) connectWallet();
  openModal();
});
modalDisconnect.addEventListener('click', ()=>{
  disconnectWallet();
});

// token selection
let selectedToken = 'ETH';
tokenETH.addEventListener('click', ()=>{ selectedToken='ETH'; tokenETH.classList.add('active'); tokenUSDT.classList.remove('active'); updateAmountPlaceholder(); });
tokenUSDT.addEventListener('click', ()=>{ selectedToken='USDT'; tokenUSDT.classList.add('active'); tokenETH.classList.remove('active'); updateAmountPlaceholder(); });

function updateAmountPlaceholder(){
  if(selectedToken==='ETH') amountInput.placeholder = MIN_ETH;
  else amountInput.placeholder = MIN_USDT;
}

// percentage buttons: compute percent of user's balance (on-chain). We will fetch balances (ETH and USDT) then apply.
let userBalances = {eth:0, erc20:0};

pctBtns.forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const pct = Number(btn.dataset.pct);
    // ensure balances are loaded
    if(!provider || !yourAddress){ alert("Connect wallet first"); return; }
    if(selectedToken === 'ETH'){
      // get ETH balance
      let bal = userBalances.eth;
      if(bal===0){
        const raw = await provider.getBalance(yourAddress);
        bal = Number(ethers.formatEther(raw));
        userBalances.eth = bal;
      }
      const val = (bal * pct)/100;
      amountInput.value = Number(val.toFixed(8));
    } else {
      let bal = userBalances.erc20;
      if(bal===0){
        try{
          const erc20 = new ethers.Contract(USDT_CONTRACT_ADDRESS, ["function balanceOf(address) view returns (uint256)"], provider);
          const raw = await erc20.balanceOf(yourAddress);
          bal = Number(ethers.formatUnits(raw, erc20Decimals));
          userBalances.erc20 = bal;
        }catch(e){
          console.warn(e);
          alert("Failed fetching token balance");
          return;
        }
      }
      const val = (bal * pct)/100;
      amountInput.value = Number(val.toFixed(6));
    }
  });
});

// core: fetch round and players
async function fetchRoundAndPlayers(){
  if(!contract) return;
  try{
    // currentRoundId is stored in contract as public currentRoundId? In ABI it's not included. We'll try to call getRoundPlayers for id  (we'll try reading contract.currentRoundId if available)
    let currentRoundId = 1;
    try{
      currentRoundId = await contract.currentRoundId();
    }catch(e){
      // fallback: assume 1
      currentRoundId = 1;
    }
    roundIdEl.textContent = currentRoundId.toString();

    const playersAddrs = await contract.getRoundPlayers(currentRoundId);
    // fetch each player's deposits
    players = [];
    let totalETH = 0;
    let totalERC = 0;
    for(let addr of playersAddrs){
      const dep = await contract.getPlayerDeposits(currentRoundId, addr);
      const ethAmt = Number(ethers.formatEther(dep.ethAmount));
      const ercAmt = Number(ethers.formatUnits(dep.erc20Amount, erc20Decimals));
      totalETH += ethAmt;
      totalERC += ercAmt;
      players.push({address:addr, eth:ethAmt, erc:ercAmt});
    }
    // populate weights (simple: normalize both assets by converting ERC20 to ETH-equivalent? We can't price; we'll weight by eth + erc (treated equally) but scale so both matter)
    // For demonstration we convert erc share by dividing by MAX_USDT (10) to scale similar magnitudes
    players = players.map(p=>{
      const weight = Math.max(0.0000001, p.eth + (p.erc / ${MAX_USDT || 10})); // placeholder scaling (client-side)
      return {...p, weight};
    });

    playersCountEl.textContent = players.length;
    totalETHEl.textContent = totalETH.toFixed(6);
    totalUSDTEl.textContent = totalERC.toFixed(6);

    // update your deposits if connected
    if(yourAddress){
      const yourDep = await contract.getPlayerDeposits(currentRoundId, yourAddress);
      const yourEth = Number(ethers.formatEther(yourDep.ethAmount));
      const yourErc = Number(ethers.formatUnits(yourDep.erc20Amount, erc20Decimals));
      yourETHEl.textContent = yourEth;
      yourUSDTEl.textContent = yourErc;
      modalYourETH.textContent = yourEth;
      modalYourUSDT.textContent = yourErc;
    }

    // draw wheel
    drawWheel();
  }catch(err){
    console.error("fetchRoundAndPlayers err:", err);
  }
}

// Draw wheel donut using players[] weights
function drawWheel(){
  ctx.clearRect(0,0,size,size);
  // background ring
  const totalWeight = players.reduce((s,p)=>s+p.weight,0) || 1;
  let start = 0;
  if(players.length === 0){
    // draw default 6 sectors
    const colors = ['#2b2f63','#3a2b50','#253047','#2c3b2f','#3b2530','#2a2a3a'];
    const sectors = 6;
    for(let i=0;i<sectors;i++){
      const ang = (2*Math.PI* i)/sectors;
      const ang2 = (2*Math.PI*(i+1))/sectors;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,outerR,ang,ang2);
      ctx.arc(cx,cy,innerR,ang2,ang,true);
      ctx.closePath();
      ctx.fillStyle = colors[i % colors.length];
      ctx.fill();
      // label
      const mid = (ang+ang2)/2;
      const tx = cx + Math.cos(mid)*(innerR+ (outerR-innerR)/2);
      const ty = cy + Math.sin(mid)*(innerR+ (outerR-innerR)/2);
      ctx.save();
      ctx.translate(tx,ty);
      ctx.rotate(mid);
      ctx.fillStyle = '#cfe3ff';
      ctx.font = 'bold 14px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Empty', 0,0);
      ctx.restore();
    }
    return;
  }

  // dynamic sectors
  for(let i=0;i<players.length;i++){
    const p = players[i];
    const slice = (p.weight / totalWeight) * (2*Math.PI);
    const ang = start;
    const ang2 = start + slice;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    // color: generate from address hash
    const color = colorFromString(p.address);
    ctx.arc(cx,cy,outerR,ang,ang2);
    ctx.arc(cx,cy,innerR,ang2,ang,true);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    // label
    const mid = (ang+ang2)/2;
    const tx = cx + Math.cos(mid)*(innerR+ (outerR-innerR)/2);
    const ty = cy + Math.sin(mid)*(innerR+ (outerR-innerR)/2);
    ctx.save();
    ctx.translate(tx,ty);
    ctx.rotate(mid);
    ctx.fillStyle = '#e6f0ff';
    ctx.font = 'bold 12px monospace';
    ctx.textAlign = 'center';
    const name = short(p.address);
    ctx.fillText(name, 0, 0);
    ctx.restore();
    start = ang2;
  }
}

// helper color from string
function colorFromString(s){
  let h = 0;
  for(let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i))|0;
  const hue = Math.abs(h) % 360;
  return `hsl(${hue} 70% 35%)`;
}

// Spin animation — picks a random target based on weights (client-side visualization)
function spinWheel(){
  if(players.length === 0){
    // small spin
    gsap.to(this, {duration:3, onUpdate:()=>{}, onComplete:()=>{ alert("No players yet"); }});
    return;
  }
  // pick by weighted random
  const total = players.reduce((s,p)=>s+p.weight,0);
  let r = Math.random()*total;
  let pickIdx = 0;
  for(let i=0;i<players.length;i++){
    r -= players[i].weight;
    if(r<=0){ pickIdx=i; break; }
  }
  // compute angular target so that chosen player lands at pointer (top)
  // compute cumulative angle for pick
  let start = 0;
  for(let i=0;i<pickIdx;i++) start += (players[i].weight/total)*(2*Math.PI);
  const pickSlice = (players[pickIdx].weight/total)*(2*Math.PI);
  const midAngle = start + pickSlice/2;
  // convert to rotation so that midAngle aligns with top ( -Math.PI/2 )
  const currentRot = rotation;
  // we will rotate many rounds + align
  const targetRot = currentRot + (Math.PI*4) - (midAngle - (-Math.PI/2)); // 4*PI spin
  // animate rotation variable and redraw via requestAnimationFrame
  const duration = 4.2;
  gsap.to(window, {
    duration,
    ease: "power4.out",
    onStart: ()=>{
      spinBtn.disabled = true;
      spinBtn.textContent = "Spinning...";
    },
    onComplete: ()=>{
      spinBtn.disabled = false;
      spinBtn.textContent = "Spin";
      alert("Visual winner: " + players[pickIdx].address + "\nNOTE: final on-chain winner determined by contract finalizeRound.");
    },
    onUpdate: function() {
      const v = gsap.getProperty(this, "rotation") // not used
    }
  });

  // animate rotation variable and redraw
  const tl = gsap.timeline({
    onUpdate: function(){ drawRotated(rotation); },
    onComplete: function(){ drawRotated(rotation); }
  });
  tl.to({r:rotation}, {r:targetRot, duration, ease:"power4.out", onUpdate:function(){ rotation = this.targets()[0].r; }});
}

// draw wheel rotated visually
function drawRotated(rot){
  ctx.save();
  ctx.clearRect(0,0,size,size);
  // create offscreen to rotate canvas? simpler: translate/rotate entire ctx
  ctx.translate(cx,cy);
  ctx.rotate(rot);
  ctx.translate(-cx,-cy);
  // draw slices again but using same routine with rotation applied
  const totalWeight = players.reduce((s,p)=>s+p.weight,0) || 1;
  let start = 0;
  for(let i=0;i<players.length;i++){
    const p = players[i];
    const slice = (p.weight / totalWeight) * (2*Math.PI);
    const ang = start;
    const ang2 = start + slice;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    const color = colorFromString(p.address);
    ctx.arc(cx,cy,outerR,ang,ang2);
    ctx.arc(cx,cy,innerR,ang2,ang,true);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    // label
    const mid = (ang+ang2)/2;
    const tx = cx + Math.cos(mid)*(innerR+ (outerR-innerR)/2);
    const ty = cy + Math.sin(mid)*(innerR+ (outerR-innerR)/2);
    ctx.save();
    ctx.translate(tx,ty);
    ctx.rotate(mid);
    ctx.fillStyle = '#e6f0ff';
    ctx.font = 'bold 12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(short(p.address), 0, 0);
    ctx.restore();
    start = ang2;
  }
  ctx.restore();

  // draw static pointer at top
  ctx.beginPath();
  ctx.moveTo(cx, cy - outerR - 12);
  ctx.lineTo(cx - 12, cy - outerR + 18);
  ctx.lineTo(cx + 12, cy - outerR + 18);
  ctx.closePath();
  ctx.fillStyle = '#fffb';
  ctx.fill();
}

// place bet action (client -> contract)
modalPlaceBet.addEventListener('click', async ()=>{
  const valStr = amountInput.value;
  if(!valStr || isNaN(valStr) || Number(valStr) <= 0) { alert("Enter a valid amount"); return; }
  const amount = Number(valStr);
  if(!contract || !signer){ alert("Connect wallet first"); return; }

  try{
    if(selectedToken === 'ETH'){
      if(amount < MIN_ETH || amount > MAX_ETH) { alert(`ETH amount must be between ${MIN_ETH} and ${MAX_ETH}`); return; }
      // send tx to placeBetETH with value
      const tx = await signer.sendTransaction({ to: CONTRACT_ADDRESS, data: contract.interface.encodeFunctionData("placeBetETH"), value: ethers.parseEther(amount.toString()) });
      alert("Transaction sent: " + tx.hash);
      await tx.wait();
      alert("Bet confirmed on-chain");
    } else {
      if(amount < MIN_USDT || amount > MAX_USDT){ alert(`USDT amount must be between ${MIN_USDT} and ${MAX_USDT}`); return; }
      // need to ensure approval is done on USDT contract to this contract
      const erc20Abi = ["function approve(address spender, uint256 amount) returns (bool)", "function allowance(address owner,address spender) view returns (uint256)"];
      const token = new ethers.Contract(USDT_CONTRACT_ADDRESS, erc20Abi, signer);
      const decimals = erc20Decimals;
      const amtUnits = ethers.parseUnits(amount.toString(), decimals);
      const allowance = await token.allowance(yourAddress, CONTRACT_ADDRESS);
      if(allowance < amtUnits){
        const approveTx = await token.approve(CONTRACT_ADDRESS, amtUnits);
        await approveTx.wait();
      }
      const tx = await contract.placeBetERC20(amtUnits);
      alert("Transaction sent: " + tx.hash);
      await tx.wait();
      alert("Bet confirmed on-chain");
    }

    // refresh UI
    await fetchRoundAndPlayers();
    closeModalFn();
  }catch(err){
    console.error(err);
    alert("Tx failed: " + (err?.message || err));
  }
});

// refresh button
refreshBtn.addEventListener('click', fetchRoundAndPlayers);
spinBtn.addEventListener('click', spinWheel);

// initial draw
drawWheel();

// simple auto-refresh loop (every 12s) to keep wheel-ish in sync — only if connected
setInterval(async ()=>{
  if(contract) await fetchRoundAndPlayers();
}, 12000);

// attempt to detect accounts changed (metaMask)
if(window.ethereum){
  window.ethereum.on && window.ethereum.on('accountsChanged', (accounts)=> {
    if(accounts.length === 0) disconnectWallet();
    else { yourAddress = accounts[0]; walletLabel.textContent = short(yourAddress); modalAddr.textContent = yourAddress; }
  });
  window.ethereum.on && window.ethereum.on('chainChanged', (chainId)=> {
    // do nothing here, but could force refresh
  });
}

// small init for UI
updateAmountPlaceholder();

</script>
</body>
  </html>
