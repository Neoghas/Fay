<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&family=Courier+Prime&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --red-main: #c0392b;
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  
  /* === BASE STYLES === */
  body {
    margin: 0;
    min-height: 100vh;
    background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
    font-family: "Ubuntu", sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0;
    overflow-x: hidden;
    padding-bottom: 50px;
  }

  /* === NAVBAR === */
  .navbar {
    position: fixed; top: 0; left: 0; width: 100%; height: 70px;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 20px; box-sizing: border-box; z-index: 1000;
    background: rgba(10, 10, 25, 0.85); backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(120, 0, 255, 0.3);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
  }
  .navbar-logo { font-size: 20px; font-weight: bold; color: #fff; display: flex; align-items: center; }
  .navbar-actions { display: flex; gap: 10px; }
  
  .wallet-btn, .referral-btn {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 12px; font-weight: bold; padding: 8px 16px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main);
    transition: all 0.3s ease;
  }
  .referral-btn { background: linear-gradient(90deg, var(--pink-main), var(--blue-main)); display: none; }
  .wallet-btn:hover, .referral-btn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }

  /* === HERO SECTION === */
  #hero-section {
    position: relative; width: 100%; padding-top: 100px; padding-bottom: 40px;
    display: flex; flex-direction: column; align-items: center; text-align: center;
  }
  .hero-title {
    font-size: 2.5rem; margin: 0 0 10px 0; letter-spacing: 2px;
    background: linear-gradient(90deg, #03a9f4, #f441a5);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .hero-subtitle { font-size: 1rem; color: #ccc; max-width: 600px; margin: 0 auto 20px auto; padding: 0 20px; }

  /* === GAME AREA === */
  .app-body { display: flex; flex-direction: column; align-items: center; width: 100%; position: relative; z-index: 5; }
  
  /* Roda Putar */
  .donut-wrap {
    position: relative; width: 340px; height: 340px;
    margin: 20px auto; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
  }
  #donutCanvas { width: 100%; height: 100%; display: block; filter: drop-shadow(0 0 20px rgba(98, 0, 255, 0.4)); }
  .donut-pointer {
    position: absolute; top: -15px; left: 50%; transform: translateX(-50%); z-index: 10;
    width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent;
    border-top: 30px solid var(--cyan-main); filter: drop-shadow(0 0 10px var(--cyan-main));
  }
  .spin-btn {
    position: absolute; width: 90px; height: 90px; border-radius: 50%;
    background: linear-gradient(145deg, var(--pink-main), #4a0072);
    color: #fff; font-weight: bold; display: flex; flex-direction: column;
    align-items: center; justify-content: center; cursor: pointer;
    box-shadow: 0 0 20px rgba(255, 0, 230, 0.5), inset 0 2px 5px rgba(255,255,255,0.3);
    border: 3px solid #fff; z-index: 100; /* Z-INDEX TINGGI AGAR BISA DIKLIK */
    transition: transform 0.2s;
  }
  .spin-btn:active { transform: scale(0.95); }

  /* Kontrol & Status */
  .controls { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; width: 300px; }
  .main-btn {
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: bold; padding: 12px 30px;
    cursor: pointer; text-transform: uppercase; width: 100%;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main); transition: all 0.3s ease;
  }
  .main-btn:hover { box-shadow: 0 0 30px var(--pink-main); transform: scale(1.02); }
  .main-btn:disabled { background: #444; box-shadow: none; transform: none; cursor: not-allowed; opacity: 0.7; }
  
  .status { font-size: 13px; color: var(--cyan-main); min-height: 20px; text-align: center; text-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }
  .timer { font-size: 18px; font-weight: bold; color: #fff; margin-top: 5px; text-shadow: 0 0 10px var(--pink-main); }

  /* === LISTS (Bets & Winners) === */
  .lists-wrapper { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; width: 90%; max-width: 600px; }
  .list-container {
    background: rgba(10, 10, 25, 0.6); border: 1px solid var(--border-color);
    border-radius: 12px; padding: 15px; max-height: 300px; overflow-y: auto;
  }
  .list-container h3 { margin: 0 0 15px 0; color: var(--cyan-main); text-align: center; font-size: 14px; text-transform: uppercase; }
  
  .bet-list-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px;
  }
  .bet-list-item .player-id { font-weight: bold; color: #fff; }
  .bet-list-item .player-bets { text-align: right; color: #ccc; font-size: 12px; }

  .winner-list-item {
      background: rgba(20, 20, 40, 0.5); border-radius: 8px; padding: 10px; margin-bottom: 8px;
      border-left: 3px solid var(--pink-main);
  }
  .winner-main-content { display: flex; gap: 10px; align-items: flex-start; }
  .winner-avatar-small { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--cyan-main); cursor: pointer; }
  .winner-info-text { width: 100%; font-size: 12px; }
  .asset-icon { width: 16px; height: 16px; vertical-align: middle; margin-left: 2px; }
  
  /* === LEADERBOARD & TABS === */
  .leaderboard-section { width: 90%; max-width: 600px; margin: 40px auto; }
  .section-title { 
      text-align: center; font-size: 22px; margin-bottom: 20px; 
      background: linear-gradient(90deg, #03a9f4, #f441a5); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .lb-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
  .lb-tabs button {
      background: rgba(0,0,0,0.5); border: 1px solid var(--purple-main); color: #aaa;
      padding: 8px 20px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer;
      transition: all 0.3s;
  }
  .lb-tabs button.active {
      background: var(--pink-main); color: #fff; border-color: var(--pink-main); box-shadow: 0 0 15px var(--pink-main);
  }
  
  .leaderboard-container {
      background: rgba(10, 10, 25, 0.8); border: 1px solid var(--purple-main); border-radius: 12px; overflow: hidden;
  }
  .lb-header, .lb-item {
      display: grid; align-items: center; padding: 12px 15px; font-size: 12px; gap: 5px;
  }
  .lb-header {
      background: rgba(30, 30, 60, 0.9); border-bottom: 1px solid var(--purple-main); color: var(--cyan-main); font-weight: bold; text-transform: uppercase;
  }
  .lb-item { border-bottom: 1px solid rgba(255,255,255,0.05); color: #ddd; }
  .lb-item:hover { background: rgba(255,255,255,0.05); }
  .lb-rank { font-weight: bold; font-family: 'Courier Prime', monospace; }
  .lb-item.rank-1 .lb-rank { color: gold; }
  .lb-item.rank-2 .lb-rank { color: silver; }
  .lb-item.rank-3 .lb-rank { color: #cd7f32; }

  /* === MODALS === */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
    z-index: 2000; display: none; opacity: 0; transition: opacity 0.3s;
  }
  .modal {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 360px; background: var(--bg-modal);
    border: 1px solid var(--border-color); border-radius: 16px;
    z-index: 2001; display: none; opacity: 0; transition: all 0.3s;
    box-shadow: 0 0 30px rgba(98, 0, 255, 0.3);
  }
  .modal-overlay.show, .modal.show { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
  .modal-header {
      display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .modal-header h2 { margin: 0; font-size: 18px; color: var(--cyan-main); }
  .modal-close-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }
  
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; max-height: 70vh; overflow-y: auto; }
  
  /* Referral Specific Styles */
  .ref-section {
      padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .ref-section:last-child { border-bottom: none; }
  .ref-section h3 { margin: 0 0 8px 0; color: #aaa; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
  .ref-info { font-size: 14px; line-height: 1.6; }
  
  .input-group { display: flex; width: 100%; gap: 5px; }
  .input-group input, .input-group select {
      flex: 1; background: #000; border: 1px solid #333; color: #fff;
      padding: 10px; border-radius: 8px; font-family: inherit;
  }
  .modal-footer { padding: 15px 20px; border-top: 1px solid rgba(255,255,255,0.1); }
  .modal-btn {
      width: 100%; background: var(--pink-main); border: none; border-radius: 8px;
      color: #fff; padding: 12px; font-weight: bold; cursor: pointer;
      transition: 0.3s;
  }
  .modal-btn:hover { background: #fff; color: var(--pink-main); }

  /* Toast Notification */
  #toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; }
  .toast {
      background: #222; color: #fff; padding: 12px 20px; margin-bottom: 10px;
      border-radius: 8px; border-left: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; font-size: 13px;
  }
  .toast.success { border-color: #00ff88; }
  .toast.error { border-color: #ff4d4d; }
  .toast.warning { border-color: #ffcc00; }
  .toast.info { border-color: var(--blue-main); }
  @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
  
  /* Media Queries */
  @media (min-width: 768px) {
      .lists-wrapper { flex-direction: row; max-width: 850px; }
      .list-container { flex: 1; }
      #donutCanvas { width: 400px; height: 400px; }
      .donut-wrap { width: 400px; height: 400px; }
  }
</style>
</head>
<body>

   <nav class="navbar">
      <div class="navbar-logo">
        <span style="color:var(--pink-main); margin-right:5px;">FAYLOTTO</span> <small style="font-size:10px; opacity:0.7;">BETA</small>
      </div>
      <div class="navbar-actions">
          <button class="referral-btn" id="referralBtn">Referral</button>
          <button class="wallet-btn" id="walletBtn">Connect Walle</button>
      </div>
   </nav>

   <!-- Hero & Game -->
   <section id="hero-section">
       <h2 class="hero-title">Spin Battle</h2>
       <p class="hero-subtitle">Decentralized P2E. Play with Crypto or Free Balance.</p>
   </section>

   <div class="app-body">
       <!-- Roda -->
       <div class="donut-wrap">
            <div class="donut-pointer"></div>
            <canvas id="donutCanvas"></canvas>
            <!-- TOMBOL SPIN: Ditambahkan onclick langsung -->
            <button class="spin-btn" id="finalizeBtn" style="display:none;" onclick="callFinalizeRound()">SPIN</button>
       </div>

       <!-- Kontrol -->
       <div class="controls">
           <button id="placeBetBtn" class="main-btn">Place Bet</button>
           <div class="status" id="statusText">Connect Wallet to Play</div>
           <div class="timer" id="timerText"></div>
           <div id="pool-info" style="text-align:center; font-size:12px; color:#888;">
               Pool Value: <span id="pool-usd-value" style="color:#00ff88; font-weight:bold;">$...</span>
           </div>
       </div>

       <!-- Lists -->
       <div class="lists-wrapper">
           <div id="bet-list-container" class="list-container">
               <h3>Live Bets</h3>
               <div id="bet-list"><p style="text-align:center; color:#555;">No bets yet.</p></div>
           </div>
           <div id="winner-list-container" class="list-container">
               <h3>Recent Winners</h3>
               <div id="winner-list"><p style="text-align:center; color:#555;">No winners yet.</p></div>
           </div>
       </div>
   </div>

   <!-- Leaderboard Section -->
   <section class="leaderboard-section">
        <h2 class="section-title">Leaderboard</h2>
        
        <!-- Tombol Ganti Mode -->
        <div class="lb-tabs">
            <button id="btn-lb-score" class="active" onclick="switchLbMode('score')">TOP PROFIT</button>
            <button id="btn-lb-ref" onclick="switchLbMode('ref')">TOP REFERRAL</button>
        </div>

        <div class="leaderboard-container">
            <!-- Header Kolom -->
            <div class="lb-header" id="lb-header-row" style="grid-template-columns: 0.5fr 2fr 1.5fr 2fr;">
                <span>Rank</span>
                <span>Pilot</span>
                <span>Net Profit ($)</span>
                <span>Assets</span> 
            </div>
            
            <div id="leaderboard-list">
                <div class="lb-loading">> Connect wallet to load...</div>
            </div>
        </div>
   </section>

   <!-- MODAL BET -->
   <div class="modal-overlay" id="bet-modal-overlay"></div>
   <div class="modal" id="bet-modal">
       <div class="modal-header">
           <h2>Place Bet</h2>
           <button class="modal-close-btn" id="bet-modal-close-btn">&times;</button>
       </div>
       <div class="modal-body">
           <div class="ref-section">
               <h3>Select Currency</h3>
               <div class="input-group">
                   <select id="betCurrencySelect">
                       <option value="ETH">ETH</option>
                       <option value="USDT">USDT</option>
                       <option value="BABYDOGE">BabyDoge</option>
                       <option value="FREE">Free Balance</option>
                   </select>
               </div>
               <div style="margin-top:5px; font-size:11px; color:#888; text-align:right;">
                   Balance: <span id="modalBalanceDisplay" style="color:var(--cyan-main);">0</span>
               </div>
           </div>
           <div class="ref-section">
               <h3>Amount</h3>
               <div class="input-group">
                   <input type="number" id="betAmountInput" placeholder="0.00">
               </div>
               <div style="display:flex; gap:5px; margin-top:5px;">
                   <button class="wallet-btn" style="flex:1; padding:5px;" onclick="setAmountByPercent(0.25)">25%</button>
                   <button class="wallet-btn" style="flex:1; padding:5px;" onclick="setAmountByPercent(0.5)">50%</button>
                   <button class="wallet-btn" style="flex:1; padding:5px;" onclick="setAmountByPercent(1.0)">MAX</button>
               </div>
           </div>
       </div>
       <div class="modal-footer">
           <button class="modal-btn" id="confirmBetBtn">CONFIRM</button>
       </div>
   </div>

   <!-- MODAL REFERRAL -->
   <div class="modal-overlay" id="referral-modal-overlay"></div>
   <div class="modal" id="referral-modal">
     <div class="modal-header">
       <h2>Referral System</h2>
       <button class="modal-close-btn" id="referral-modal-close-btn">&times;</button>
     </div>
     <div class="modal-body">
         
       <div class="ref-section">
           <h3>My Info</h3>
           <div class="ref-info">
               My Nickname: <span id="myNickname" style="color:var(--cyan-main);">-</span><br/>
               Referrer: <span id="myReferrer">-</span>
           </div>
       </div>
       
       <div class="ref-section">
           <h3>Set Nickname</h3>
           <div class="input-group">
               <input type="text" id="nicknameInput" placeholder="Enter nickname">
               <button class="wallet-btn" id="createNicknameBtn" style="width:auto;">Set</button>
           </div>
       </div>
 
       <div class="ref-section" id="referralLinkSection" style="display: none;">
             <h3>Your Link</h3>
             <div class="input-group">
                 <input type="text" id="referralLinkInput" readonly onclick="this.select()">
                 <button class="wallet-btn" id="copyReferralBtn" style="width:auto;"><i class="fa-regular fa-copy"></i></button>
             </div>
       </div>
       
       <div class="ref-section">
         <h3>Rewards</h3>
         <div class="ref-info">
             <div style="margin-bottom: 4px; display:flex; align-items:center;">
                 <img src="eth.svg" width="18" style="margin-right:5px;">
                 ETH: <span id="ethRewards" style="color:var(--cyan-main); margin-left:auto;">0</span>
             </div>
             <div style="margin-bottom: 4px; display:flex; align-items:center;">
                 <img src="usdt.svg" width="18" style="margin-right:5px;">
                 USDT: <span id="usdtRewards" style="color:var(--cyan-main); margin-left:auto;">0</span>
             </div>
             <div style="margin-bottom: 4px; display:flex; align-items:center;">
                 <img src="bb.svg" width="18" style="margin-right:5px;">
                 BabyDoge: <span id="babyDogeRewards" style="color:var(--cyan-main); margin-left:auto;">0</span>
             </div>
             <hr style="border:0; border-top:1px solid #333; margin: 8px 0;">
             <div style="display:flex; align-items:center;">
                <i class="fa-solid fa-users" style="color:#aaa; margin-right:5px;"></i>
                Total Refs: <span id="referralCount" style="margin-left:auto;">0</span>
             </div>
         </div>
       </div>
 
     </div>
     <div class="modal-footer">
       <button id="claimRewardsBtn" class="modal-btn" disabled>Claim Rewards</button>
     </div>
   </div>

   <div id="toast-container"></div>

<script>
    // ================= CONFIGURATION =================
    // ⚠️ GANTI DENGAN ALAMAT KONTRAK TERBARU ANDA DI SINI ⚠️
    const FAYLOTTO_ADDRESS = "0x998d821efa06D7C24260e41EBC68C9fD3f9219DA"; 
    
    const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2"; 
    const BABYDOGE_ADDRESS = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";   
    const RPC_URL = "https://sepolia.base.org";
    const WSS_URL = "wss://base-sepolia.drpc.org"; 
    
    const PLAYER_COLORS = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#F9D423", "#FFA62B", "#7B72E9", "#3DCC91", "#FF90B3", "#C0E218", "#3498DB"];
    
    // ================= ABI LENGKAP (FIXED) =================
    const FAYLOTTO_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_babyDogeToken","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"},{"internalType":"address","name":"_nativeUsdPriceFeedAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetBabyDoge","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetFree","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetNative","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetUSDT","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"FreeSpinNoPrize","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"prizeTier","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FreeSpinWon","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"referralCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalEthClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalUsdtClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalBabyDogeClaimed","type":"uint256"}],"name":"LeaderboardReferralStatsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"int256","name":"newNetUsdScore","type":"int256"},{"indexed":false,"internalType":"int256","name":"netEth","type":"int256"},{"indexed":false,"internalType":"int256","name":"netUsdt","type":"int256"},{"indexed":false,"internalType":"int256","name":"netBabyDoge","type":"int256"}],"name":"LeaderboardScoreUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"babyDogeAmount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_BETS_PER_PLAYER","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_NATIVE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_USDT_UNSCALED","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"babyDogeDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeUsdPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeBalances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"freeBetCost","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"freeSpinHistory","outputs":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getFreeSpinHistory","outputs":[{"components":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.FreeSpinWinner[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLatestNativePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLeaderboardPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"internalType":"uint256","name":"babyDogeAmount","type":"uint256"},{"internalType":"uint256","name":"usdWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"usdtReward","type":"uint256"},{"internalType":"uint256","name":"babyDogeReward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalUSDT","type":"uint256"},{"internalType":"uint256","name":"totalBabyDoge","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"},{"internalType":"uint256","name":"totalWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isFreeSpinPaused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"leaderboardPlayers","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"leaderboardStats","outputs":[{"internalType":"int256","name":"netEth","type":"int256"},{"internalType":"int256","name":"netUsdt","type":"int256"},{"internalType":"int256","name":"netBabyDoge","type":"int256"},{"internalType":"int256","name":"netUsdScore","type":"int256"},{"internalType":"uint256","name":"totalReferralEthClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralUsdtClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralBabyDogeClaimed","type":"uint256"},{"internalType":"uint256","name":"referralCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nativeUsdDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextFreeSpinId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetNative","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"quotaTier1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier2","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier3","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier4","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier5","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier6","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier7","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier8","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier9","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsBabyDoge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsUSDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"setBabyDogePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"cost","type":"uint256"}],"name":"setFreeBetCost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"spinCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"spinFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdtDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];
  
    const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
      
    // ================= GLOBAL STATE =================
    let provider, signer, userAddress;
    let faylottoContract, usdtContract, babyDogeContract;
    let usdtDecimals = 6, babyDogeDecimals = 18;
    let rawBalances = { eth: 0, usdt: 0, baby: 0, free: 0 };
    let currentRoundId, currentLbMode = 'score';
    let players = {}; 
    let visualTimer = null;
    let ctx, cw, ch, cx, cy, outerR, innerR;

    // ================= INITIALIZATION =================
    window.addEventListener('DOMContentLoaded', async () => {
        console.log("Initializing V3 Single Contract...");
        provider = new ethers.providers.JsonRpcProvider(RPC_URL);
        faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
        usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
        babyDogeContract = new ethers.Contract(BABYDOGE_ADDRESS, ERC20_ABI, provider);

        initCanvas();
        
        // Load Data Awal
        await fetchAndDisplayRoundData();
        fetchAndDisplayWinners();
        fetchAndRenderLeaderboard();
        
        // UI Listeners
        document.getElementById('walletBtn').addEventListener('click', connectWallet);
        document.getElementById('referralBtn').addEventListener('click', showReferralModal);
        document.getElementById('referral-modal-close-btn').addEventListener('click', () => document.getElementById('referral-modal').classList.remove('show'));
        document.getElementById('bet-modal-close-btn').addEventListener('click', () => document.getElementById('bet-modal').classList.remove('show'));
        document.getElementById('placeBetBtn').addEventListener('click', showBetModal);
        document.getElementById('confirmBetBtn').addEventListener('click', confirmBet);
        document.getElementById('createNicknameBtn').addEventListener('click', callCreateNickname);
        document.getElementById('claimRewardsBtn').addEventListener('click', callClaimRewards);
        
        // Copy Link
        document.getElementById('copyReferralBtn').addEventListener('click', () => {
            const el = document.getElementById('referralLinkInput');
            el.select(); document.execCommand('copy');
            showStatus("Link copied!", "success");
        });
        
        document.getElementById('betCurrencySelect').addEventListener('change', updateModalBalanceDisplay);
        
        // Auto Refresh
        setInterval(fetchAndDisplayRoundData, 10000); 
    });

    // ================= CONNECT WALLET (FIXED) =================
    async function connectWallet() {
    if (!window.ethereum) return showStatus("Install MetaMask", "error");
    try {
        // Switch to Base Sepolia network
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0x1383c' }], // 84532 in hex
            });
        } catch (switchError) {
            // If chain not added (error code 4902), add it
            if (switchError.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x1383c',
                        chainName: 'Base Sepolia',
                        rpcUrls: ['https://sepolia.base.org'],
                        nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                        blockExplorerUrls: ['https://sepolia.basescan.org']
                    }],
                });
            } else {
                throw switchError; // Rethrow other errors
            }
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        faylottoContract = faylottoContract.connect(signer);
        usdtContract = usdtContract.connect(signer);
        babyDogeContract = babyDogeContract.connect(signer);

        document.getElementById('walletBtn').innerText = userAddress.slice(0,6)+"..."+userAddress.slice(-4);
        document.querySelector('.referral-btn').style.display = 'block';
        
        showStatus("Wallet Connected!", "success");
        updateUserBalances();
    } catch (e) { 
        console.error(e);
        showStatus("Failed to Connect: " + (e.message || "Unknown error"), "error"); 
    }
    }
    // ================= GAME CORE LOGIC =================
    async function fetchAndDisplayRoundData() {
        try {
            const contract = faylottoContract;
            const rid = await contract.currentRoundId();
            currentRoundId = rid;
            
            const r = await contract.getRoundBasic(rid);
            // r: id, startTime, endTime, finalized, winner, totalETH, totalUSDT, totalBabyDoge, playersCount, totalWeight
            
            // Update Timer
            const endTime = r.endTime.toNumber() * 1000;
            startVisualTimer(endTime);
            
            if (Date.now() < endTime) {
                document.getElementById('statusText').innerText = "Round #" + rid + " Live!";
                document.getElementById('placeBetBtn').disabled = false;
                document.getElementById('finalizeBtn').style.display = 'none';
            } else {
                document.getElementById('statusText').innerText = "Round Ended!";
                document.getElementById('placeBetBtn').disabled = true;
                document.getElementById('finalizeBtn').style.display = 'flex';
            }

            // [FIX] Tampilkan juga Pool BabyDoge
            const poolText = `${parseFloat(ethers.utils.formatEther(r.totalETH)).toFixed(4)} ETH + ${parseFloat(ethers.utils.formatUnits(r.totalUSDT, 6)).toFixed(2)} USDT + ${parseFloat(ethers.utils.formatUnits(r.totalBabyDoge, 18)).toFixed(0)} Baby`;
            document.getElementById('pool-usd-value').innerText = poolText;

            // Fetch Players for Wheel
            const playerList = await contract.getRoundPlayers(rid);
            players = {}; 
            let totalWeight = ethers.BigNumber.from(0);

            for (const pAddr of playerList) {
                const deps = await contract.getPlayerDeposits(rid, pAddr);
                players[pAddr] = {
                    id: pAddr,
                    weight: deps.usdWeight,
                    color: PLAYER_COLORS[Object.keys(players).length % PLAYER_COLORS.length],
                    eth: deps.ethAmount,
                    usdt: deps.usdtAmount,
                    baby: deps.babyDogeAmount
                };
                totalWeight = totalWeight.add(deps.usdWeight);
            }
            
            updateBetList();
            drawDonut(players, totalWeight);

        } catch (e) {
            console.error("Sync Error:", e);
        }
    }

    // [FIX] TOMBOL SPIN LOGIC
    async function callFinalizeRound() {
        if(!signer) { showStatus("Connect Wallet to Spin!", "warning"); return; }
        
        showStatus("Calculating Winner...", "info"); // Feedback Klik

        try {
            const tx = await faylottoContract.finalizeRound(currentRoundId);
            showStatus("Spinning... Wait for Tx", "info");
            await tx.wait();
            showStatus("Round Finalized!", "success");
            fetchAndDisplayRoundData();
            fetchAndDisplayWinners();
        } catch(e) {
            console.error(e);
            // Tampilkan alasan error jika ada
            let msg = "Spin Failed";
            if (e.reason) msg += ": " + e.reason;
            showStatus(msg, "error"); 
        }
    }

    function startVisualTimer(endTime) {
        if (visualTimer) clearInterval(visualTimer);
        visualTimer = setInterval(() => {
            const left = endTime - Date.now();
            if (left <= 0) {
                document.getElementById('timerText').innerText = "00:00";
                clearInterval(visualTimer);
                return;
            }
            const m = Math.floor(left / 60000);
            const s = Math.floor((left % 60000) / 1000);
            document.getElementById('timerText').innerText = `${m}:${s.toString().padStart(2,'0')}`;
        }, 1000);
    }

    function updateBetList() {
        const list = document.getElementById('bet-list');
        const pKeys = Object.keys(players);
        if (pKeys.length === 0) {
            list.innerHTML = "<p style='text-align:center; color:#555;'>No bets yet.</p>";
            return;
        }
        list.innerHTML = "";
        pKeys.forEach(k => {
            const p = players[k];
            const eth = parseFloat(ethers.utils.formatEther(p.eth));
            const usdt = parseFloat(ethers.utils.formatUnits(p.usdt, 6));
            const baby = parseFloat(ethers.utils.formatUnits(p.baby, 18));
            let txt = "";
            if(eth > 0) txt += `${eth.toFixed(4)} ETH `;
            if(usdt > 0) txt += `${usdt.toFixed(2)} USDT `;
            if(baby > 0) txt += `${baby.toFixed(0)} Baby`;
            list.innerHTML += `<div class="bet-list-item" style="border-left: 3px solid ${p.color}"><div class="player-id">${p.id.slice(0,6)}...</div><div class="player-bets">${txt}</div></div>`;
        });
    }

    // ================= CANVAS WHEEL =================
    function initCanvas() {
        const canvas = document.getElementById('donutCanvas');
        const container = document.querySelector('.donut-wrap');
        ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        cw = rect.width; ch = rect.height;
        cx = cw / 2; cy = ch / 2;
        outerR = cw * 0.45; innerR = cw * 0.25;
        drawDonut({}, ethers.BigNumber.from(0));
    }

    function drawDonut(playersMap, totalWeight) {
        if (!ctx) return;
        ctx.clearRect(0, 0, cw, ch);
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(-Math.PI / 2);
        const pKeys = Object.keys(playersMap);
        if (pKeys.length === 0 || totalWeight.eq(0)) {
            ctx.beginPath(); ctx.arc(0, 0, outerR, 0, Math.PI*2); ctx.fillStyle = '#222'; ctx.fill();
            ctx.beginPath(); ctx.arc(0, 0, innerR, 0, Math.PI*2); ctx.fillStyle = '#000'; ctx.fill();
        } else {
            let currentAngle = 0;
            pKeys.forEach(k => {
                const p = playersMap[k];
                const slice = p.weight.mul(10000).div(totalWeight).toNumber() / 10000;
                const endAngle = currentAngle + (slice * Math.PI * 2);
                ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0, 0, outerR, currentAngle, endAngle); ctx.fillStyle = p.color; ctx.fill();
                currentAngle = endAngle;
            });
            ctx.beginPath(); ctx.arc(0, 0, innerR, 0, Math.PI*2); ctx.fillStyle = '#0b0b12'; ctx.fill();
        }
        ctx.restore();
    }

    // ================= BET MODAL LOGIC =================
    function showBetModal() {
        if(!signer) return showStatus("Connect Wallet", "warning");
        document.getElementById('bet-modal').classList.add('show');
        updateModalBalanceDisplay();
    }
    
    function updateModalBalanceDisplay() {
        const cur = document.getElementById('betCurrencySelect').value;
        let bal = "0";
        if (cur === 'ETH') bal = ethers.utils.formatEther(rawBalances.eth || 0);
        else if (cur === 'USDT') bal = ethers.utils.formatUnits(rawBalances.usdt || 0, 6);
        else if (cur === 'BABYDOGE') bal = ethers.utils.formatUnits(rawBalances.baby || 0, 18);
        else if (cur === 'FREE') bal = ethers.utils.formatUnits(rawBalances.free || 0, 18);
        document.getElementById('modalBalanceDisplay').innerText = parseFloat(bal).toFixed(4);
    }
    
    function setAmountByPercent(pct) {
        const cur = document.getElementById('betCurrencySelect').value;
        let balBN;
        if (cur === 'ETH') balBN = rawBalances.eth;
        else if (cur === 'USDT') balBN = rawBalances.usdt;
        else if (cur === 'BABYDOGE') balBN = rawBalances.baby;
        else balBN = rawBalances.free;
        if(!balBN) return;
        const amt = balBN.mul(pct * 100).div(100);
        let fmt = "0";
        if (cur === 'ETH' || cur === 'BABYDOGE' || cur === 'FREE') fmt = ethers.utils.formatEther(amt);
        else fmt = ethers.utils.formatUnits(amt, 6);
        document.getElementById('betAmountInput').value = fmt;
    }

    async function updateUserBalances() {
        if (!userAddress) return;
        try {
            rawBalances.eth = await provider.getBalance(userAddress);
            rawBalances.usdt = await usdtContract.balanceOf(userAddress);
            rawBalances.baby = await babyDogeContract.balanceOf(userAddress);
            rawBalances.free = await faylottoContract.freeBalances(userAddress);
        } catch(e) {}
    }
    
    async function confirmBet() {
        const cur = document.getElementById('betCurrencySelect').value;
        const amt = document.getElementById('betAmountInput').value;
        if(!amt || parseFloat(amt) <= 0) return showStatus("Invalid amount", "warning");
        try {
            let tx;
            if (cur === 'ETH') {
                tx = await faylottoContract.placeBetNative({value: ethers.utils.parseEther(amt)});
            } else if (cur === 'FREE') {
                const wei = ethers.utils.parseUnits(amt, 18); 
                tx = await faylottoContract.placeBetFree(wei);
            } else if (cur === 'USDT') {
                 const wei = ethers.utils.parseUnits(amt, 6);
                 const allow = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
                 if(allow.lt(wei)) {
                     showStatus("Approving USDT...", "info");
                     const txApp = await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
                     await txApp.wait();
                 }
                 tx = await faylottoContract.placeBetUSDT(wei);
            } else if (cur === 'BABYDOGE') {
                 const wei = ethers.utils.parseUnits(amt, 18);
                 const allow = await babyDogeContract.allowance(userAddress, FAYLOTTO_ADDRESS);
                 if(allow.lt(wei)) {
                     showStatus("Approving BabyDoge...", "info");
                     const txApp = await babyDogeContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
                     await txApp.wait();
                 }
                 tx = await faylottoContract.placeBetBabyDoge(wei);
            }
            showStatus("Betting...", "info");
            await tx.wait();
            showStatus("Bet Placed!", "success");
            document.getElementById('bet-modal').classList.remove('show');
            fetchAndDisplayRoundData();
        } catch(e) { 
            console.error(e);
            let msg = e.reason || e.message.slice(0,50);
            showStatus("Failed: " + msg, "error"); 
        }
    }

    // ================= UTILS =================
    function showStatus(msg, type) {
        const div = document.createElement('div');
        div.className = `toast ${type}`;
        div.innerText = msg;
        document.getElementById('toast-container').appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }
</script>
</body>
</html>


