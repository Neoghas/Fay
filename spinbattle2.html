<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&family=Courier+Prime&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  
  /* === BASE STYLES === */
  body {
    margin: 0; min-height: 100vh;
    background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
    font-family: "Ubuntu", sans-serif; color: #fff;
    display: flex; flex-direction: column; align-items: center;
    padding: 0; overflow-x: hidden; padding-bottom: 50px;
  }

  /* === NAVBAR === */
  .navbar {
    position: fixed; top: 0; left: 0; width: 100%; height: 70px;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 20px; box-sizing: border-box; z-index: 1000;
    background: rgba(10, 10, 25, 0.85); backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(120, 0, 255, 0.3);
  }
  .navbar-logo { font-size: 20px; font-weight: bold; color: #fff; }
  .navbar-actions { display: flex; gap: 10px; }
  
  .wallet-btn, .referral-btn {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 12px; font-weight: bold; padding: 8px 16px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main); transition: 0.3s;
  }
  .referral-btn { background: linear-gradient(90deg, var(--pink-main), var(--blue-main)); display: none; }
  
  /* === HERO === */
  #hero-section { margin-top: 100px; text-align: center; padding-bottom: 20px; }
  .hero-title {
    font-size: 2.5rem; margin: 0 0 10px 0; letter-spacing: 2px;
    background: linear-gradient(90deg, #03a9f4, #f441a5);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  
  /* === WHEEL AREA === */
  .app-body { display: flex; flex-direction: column; align-items: center; width: 100%; z-index: 5; }
  
  .donut-wrap {
    position: relative; width: 340px; height: 340px; margin: 20px auto;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 30px rgba(98,0,255,0.2);
  }
  #donutCanvas { width: 100%; height: 100%; display: block; }
  
  /* POINTER: Segitiga penunjuk arah bawah (posisi jam 12) */
  .donut-pointer {
    position: absolute; top: -10px; left: 50%; transform: translateX(-50%); z-index: 10;
    width: 0; height: 0; 
    border-left: 20px solid transparent; border-right: 20px solid transparent;
    border-top: 40px solid var(--cyan-main); 
    filter: drop-shadow(0 0 10px var(--cyan-main));
  }
  
  .spin-btn {
    position: absolute; width: 90px; height: 90px; border-radius: 50%;
    background: linear-gradient(145deg, var(--pink-main), #4a0072);
    color: #fff; font-weight: bold; display: none; /* Hidden by default */
    align-items: center; justify-content: center; cursor: pointer;
    box-shadow: 0 0 20px rgba(255, 0, 230, 0.5); border: 3px solid #fff; z-index: 100;
  }
  .spin-btn:active { transform: scale(0.95); }

  /* === CONTROLS === */
  .controls { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; width: 300px; }
  .main-btn {
    border: none; border-radius: 12px; color: white; width: 100%;
    font-size: 16px; font-weight: bold; padding: 12px 30px; cursor: pointer;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main);
  }
  .main-btn:disabled { background: #444; box-shadow: none; cursor: not-allowed; }
  .status { font-size: 13px; color: var(--cyan-main); text-align: center; }
  .timer { font-size: 18px; font-weight: bold; color: #fff; text-shadow: 0 0 10px var(--pink-main); }

  /* === LISTS === */
  .lists-wrapper { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; width: 90%; max-width: 600px; }
  .list-container {
    background: rgba(10, 10, 25, 0.6); border: 1px solid var(--border-color);
    border-radius: 12px; padding: 15px; max-height: 300px; overflow-y: auto;
  }
  .list-container h3 { color: var(--cyan-main); text-align: center; font-size: 14px; margin-top: 0; }
  
  .bet-list-item {
      display: flex; justify-content: space-between; padding: 8px; 
      border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px;
  }
  
  /* Winner List Styling Fix */
  .winner-list-item {
      background: rgba(20, 20, 40, 0.5); border-radius: 8px; padding: 10px; margin-bottom: 8px;
      border-left: 3px solid var(--pink-main); display: flex; gap: 10px; align-items: center;
  }
  .winner-avatar { width: 35px; height: 35px; border-radius: 50%; background: #444; }
  
  /* === MODAL & TOAST === */
  .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:none; }
  .modal { 
    position: fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    width:90%; max-width:350px; background:var(--bg-modal); 
    border:1px solid var(--border-color); border-radius:16px; z-index:2001; display:none;
  }
  .modal.show, .modal-overlay.show { display:block; }
  .modal-header { padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; }
  .modal-body { padding:20px; display:flex; flex-direction:column; gap:15px; }
  
  #toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; }
  .toast { background: #222; color: #fff; padding: 12px 20px; margin-bottom: 10px; border-left: 4px solid #fff; border-radius: 5px; }
  .toast.success { border-color: #00ff88; } .toast.error { border-color: #ff4d4d; }

  /* Leaderboard simplified */
  .leaderboard-section { width: 90%; max-width: 600px; margin: 40px auto; }
  .leaderboard-container { background: rgba(10,10,25,0.8); border: 1px solid var(--purple-main); border-radius: 12px; padding: 10px; }
  .lb-item { display: grid; grid-template-columns: 0.5fr 2fr 1.5fr 1fr; padding: 10px; border-bottom: 1px solid #333; font-size: 12px; }
  
  @media (min-width: 768px) {
      .lists-wrapper { flex-direction: row; max-width: 850px; }
      #donutCanvas, .donut-wrap { width: 400px; height: 400px; }
  }
</style>
</head>
<body>

   <nav class="navbar">
      <div class="navbar-logo"><span style="color:var(--pink-main);">FAYLOTTO</span></div>
      <div class="navbar-actions">
          <button class="referral-btn" id="referralBtn">Ref</button>
          <button class="wallet-btn" id="walletBtn">Connect</button>
      </div>
   </nav>

   <section id="hero-section">
       <h2 class="hero-title">Spin Battle</h2>
       <p style="color:#ccc;">Decentralized P2E. Play with Crypto.</p>
   </section>

   <div class="app-body">
       <div class="donut-wrap">
            <div class="donut-pointer"></div>
            <canvas id="donutCanvas"></canvas>
            <button class="spin-btn" id="finalizeBtn" onclick="spinWheelAction()">SPIN</button>
       </div>

       <div class="controls">
           <button id="placeBetBtn" class="main-btn">Place Bet</button>
           <div class="status" id="statusText">Connect Wallet</div>
           <div class="timer" id="timerText"></div>
           <div id="pool-info" style="text-align:center; font-size:11px; color:#aaa; margin-top:5px;">
               Pool: <span id="pool-usd-value" style="color:#00ff88;">0 ETH</span>
           </div>
       </div>

       <div class="lists-wrapper">
           <div class="list-container">
               <h3>Live Bets</h3>
               <div id="bet-list"></div>
           </div>
           <div class="list-container">
               <h3>Recent Winners</h3>
               <div id="winner-list"></div>
           </div>
       </div>
   </div>
   
   <section class="leaderboard-section">
       <h3 style="text-align:center; color:var(--pink-main);">Leaderboard</h3>
       <div class="leaderboard-container" id="leaderboard-list">Loading...</div>
   </section>

   <div class="modal-overlay" id="bet-modal-overlay"></div>
   <div class="modal" id="bet-modal">
       <div class="modal-header"><h3>Place Bet</h3><span onclick="document.getElementById('bet-modal').classList.remove('show');document.getElementById('bet-modal-overlay').classList.remove('show')" style="cursor:pointer;">X</span></div>
       <div class="modal-body">
           <select id="betCurrencySelect" style="width:100%; padding:10px; background:#000; color:#fff; border:1px solid #333;">
               <option value="ETH">ETH</option>
               <option value="USDT">USDT</option>
               <option value="BABYDOGE">BabyDoge</option>
               <option value="FREE">Free Balance</option>
           </select>
           <input type="number" id="betAmountInput" placeholder="Amount" style="width:100%; padding:10px; background:#000; color:#fff; border:1px solid #333;">
           <button class="main-btn" id="confirmBetBtn">CONFIRM</button>
       </div>
   </div>

   <div id="toast-container"></div>

<script>
    // ================= CONFIGURATION =================
    const FAYLOTTO_ADDRESS = "0x998d821efa06D7C24260e41EBC68C9fD3f9219DA"; 
    const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2"; 
    const BABYDOGE_ADDRESS = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";   
    const RPC_URL = "https://sepolia.base.org";
    
    const COLORS = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#F9D423", "#FFA62B", "#7B72E9"];
    
    // ABI (Placeholders)
    const FAYLOTTO_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_babyDogeToken","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"},{"internalType":"address","name":"_nativeUsdPriceFeedAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetBabyDoge","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetFree","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetNative","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdWeight","type":"uint256"}],"name":"BetUSDT","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"FreeSpinNoPrize","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"prizeTier","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FreeSpinWon","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"referralCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalEthClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalUsdtClaimed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalBabyDogeClaimed","type":"uint256"}],"name":"LeaderboardReferralStatsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"int256","name":"newNetUsdScore","type":"int256"},{"indexed":false,"internalType":"int256","name":"netEth","type":"int256"},{"indexed":false,"internalType":"int256","name":"netUsdt","type":"int256"},{"indexed":false,"internalType":"int256","name":"netBabyDoge","type":"int256"}],"name":"LeaderboardScoreUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"babyDogeAmount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_BETS_PER_PLAYER","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_NATIVE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_USDT_UNSCALED","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_BABYDOGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_BET_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"babyDogeDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"babyDogeUsdPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeBalances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"freeBetCost","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"freeSpinHistory","outputs":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getFreeSpinHistory","outputs":[{"components":[{"internalType":"uint256","name":"spinId","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"prizeTier","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.FreeSpinWinner[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLatestNativePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLeaderboardPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"internalType":"uint256","name":"babyDogeAmount","type":"uint256"},{"internalType":"uint256","name":"usdWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"usdtReward","type":"uint256"},{"internalType":"uint256","name":"babyDogeReward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalUSDT","type":"uint256"},{"internalType":"uint256","name":"totalBabyDoge","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"},{"internalType":"uint256","name":"totalWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isFreeSpinPaused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"leaderboardPlayers","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"leaderboardStats","outputs":[{"internalType":"int256","name":"netEth","type":"int256"},{"internalType":"int256","name":"netUsdt","type":"int256"},{"internalType":"int256","name":"netBabyDoge","type":"int256"},{"internalType":"int256","name":"netUsdScore","type":"int256"},{"internalType":"uint256","name":"totalReferralEthClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralUsdtClaimed","type":"uint256"},{"internalType":"uint256","name":"totalReferralBabyDogeClaimed","type":"uint256"},{"internalType":"uint256","name":"referralCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nativeUsdDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextFreeSpinId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetNative","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"quotaTier1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier2","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier3","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier4","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier5","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier6","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier7","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier8","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quotaTier9","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsBabyDoge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsUSDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setBabyDoge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"setBabyDogePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"cost","type":"uint256"}],"name":"setFreeBetCost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"spinCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"spinFree","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseFreeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdtDecimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardUSDT","type":"uint256"},{"internalType":"uint256","name":"rewardBabyDoge","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];
    const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

    let provider, signer, userAddress, contract, usdtContract, babyContract;
    let players = {}, totalWeight = ethers.BigNumber.from(0);
    let currentRoundId;
    let ctx, cw, ch, cx, cy, outerR, innerR;
    
    // === SPIN VARIABLES (THE FIX) ===
    let isSpinning = false;
    let spinStartTime = 0;
    let currentRotation = 0;
    let targetRotation = 0;
    let spinSpeed = 0;
    const SPIN_DURATION = 35000; // 35 DETIK SESUAI PERMINTAAN

    // UI LISTENERS
    document.getElementById('walletBtn').addEventListener('click', connect);
    document.getElementById('placeBetBtn').addEventListener('click', () => {
        document.getElementById('bet-modal').classList.add('show');
        document.getElementById('bet-modal-overlay').classList.add('show');
    });
    document.getElementById('confirmBetBtn').addEventListener('click', placeBet);

    window.addEventListener('DOMContentLoaded', async () => {
        provider = new ethers.providers.JsonRpcProvider(RPC_URL);
        contract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
        initCanvas();
        
        // Roda: Render static pertama kali
        drawWheel(0);
        
        // Load data
        fetchData();
        setInterval(fetchData, 5000); // Sync every 5s
    });

    async function connect() {
        if (!window.ethereum) return alert("Install Metamask");
        const web3 = new ethers.providers.Web3Provider(window.ethereum);
        await web3.send("eth_requestAccounts", []);
        signer = web3.getSigner();
        userAddress = await signer.getAddress();
        contract = contract.connect(signer);
        usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
        babyContract = new ethers.Contract(BABYDOGE_ADDRESS, ERC20_ABI, signer);
        
        document.getElementById('walletBtn').innerText = userAddress.slice(0,6)+"...";
        fetchData();
    }

    async function fetchData() {
        if(isSpinning) return; // Jangan refresh data saat roda berputar
        
        try {
            currentRoundId = await contract.currentRoundId();
            const r = await contract.getRoundBasic(currentRoundId);
            
            const endTime = r.endTime.toNumber() * 1000;
            const now = Date.now();
            
            if (now < endTime) {
                document.getElementById('statusText').innerText = "Live!";
                document.getElementById('placeBetBtn').disabled = false;
                document.getElementById('finalizeBtn').style.display = 'none';
                updateTimer(endTime);
            } else {
                document.getElementById('statusText').innerText = "Round Ended";
                document.getElementById('placeBetBtn').disabled = true;
                document.getElementById('finalizeBtn').style.display = 'flex';
                document.getElementById('timerText').innerText = "00:00";
            }

            // Update Pool Text
            const ethVal = parseFloat(ethers.utils.formatEther(r.totalETH)).toFixed(4);
            const usdtVal = parseFloat(ethers.utils.formatUnits(r.totalUSDT, 6)).toFixed(2);
            const babyVal = parseFloat(ethers.utils.formatUnits(r.totalBabyDoge, 18)).toFixed(0);
            document.getElementById('pool-usd-value').innerText = `${ethVal} ETH + ${usdtVal} USDT + ${babyVal} Baby`;

            // Load Players
            const pAddrs = await contract.getRoundPlayers(currentRoundId);
            let tempPlayers = {};
            let tempTotal = ethers.BigNumber.from(0);
            
            for(let i=0; i<pAddrs.length; i++) {
                const addr = pAddrs[i];
                const dep = await contract.getPlayerDeposits(currentRoundId, addr);
                tempPlayers[addr] = {
                    addr: addr,
                    weight: dep.usdWeight,
                    color: COLORS[i % COLORS.length]
                };
                tempTotal = tempTotal.add(dep.usdWeight);
            }
            
            players = tempPlayers;
            totalWeight = tempTotal;
            drawWheel(currentRotation); // Redraw static wheel with names
            updateBetList();
            updateWinnersList();
            updateLeaderboard();

        } catch(e) { console.error(e); }
    }
    
    function updateTimer(endTime) {
        const diff = endTime - Date.now();
        if(diff <= 0) return;
        const m = Math.floor(diff/60000);
        const s = Math.floor((diff%60000)/1000);
        document.getElementById('timerText').innerText = `${m}:${s<10?'0'+s:s}`;
    }

    // ================= SPIN LOGIC (FIXED 35 SECONDS) =================
    async function spinWheelAction() {
        if(!signer) return alert("Connect Wallet");
        
        try {
            // 1. Start Spin Animation (Visual Loop)
            isSpinning = true;
            spinStartTime = Date.now();
            spinSpeed = 0.5; // Kecepatan awal tinggi
            requestAnimationFrame(animateSpin);
            
            showToast("Transaction processing...", "info");

            // 2. Call Contract
            const tx = await contract.finalizeRound(currentRoundId);
            await tx.wait();
            showToast("Winner determined on blockchain!", "success");
            
            // 3. Get Winner Data
            // Kita perlu mengambil data ronde yang BARU SAJA selesai (currentRoundId)
            const roundData = await contract.getRoundBasic(currentRoundId);
            const winnerAddr = roundData.winner;
            
            // 4. Hitung Target Angle untuk Pemenang
            // Pointer ada di ATAS (270 derajat atau -PI/2)
            // Kita harus memutar roda sedemikian rupa sehingga potongan pemenang mendarat di atas.
            
            let cumulativeWeight = ethers.BigNumber.from(0);
            let winnerStartAngle = 0;
            let winnerEndAngle = 0;
            
            const pKeys = Object.keys(players);
            for(let k of pKeys) {
                const p = players[k];
                const weight = p.weight;
                
                // Hitung start/end angle pemain ini
                const startA = cumulativeWeight.mul(10000).div(totalWeight).toNumber() / 10000 * Math.PI * 2;
                const endA = cumulativeWeight.add(weight).mul(10000).div(totalWeight).toNumber() / 10000 * Math.PI * 2;
                
                if(p.addr.toLowerCase() === winnerAddr.toLowerCase()) {
                    winnerStartAngle = startA;
                    winnerEndAngle = endA;
                    break;
                }
                cumulativeWeight = cumulativeWeight.add(weight);
            }
            
            // Sudut tengah slice pemenang
            const winnerMidAngle = (winnerStartAngle + winnerEndAngle) / 2;
            
            // Pointer di Canvas saya set di -PI/2 (Jam 12).
            // Target rotasi = (3 * PI / 2) - winnerMidAngle + (beberapa putaran penuh)
            // Kita tambahkan putaran ekstra agar animasi mulus
            const extraSpins = 10 * Math.PI * 2; 
            targetRotation = (Math.PI * 1.5) - winnerMidAngle + extraSpins;

        } catch(e) {
            console.error(e);
            isSpinning = false; // Stop jika error
            showToast("Spin failed: " + (e.reason || e.message), "error");
        }
    }

    function animateSpin() {
        if(!isSpinning) return;
        
        const elapsed = Date.now() - spinStartTime;
        const duration = SPIN_DURATION; // 35000 ms
        
        if (elapsed < duration) {
            // Fase Animasi
            if (targetRotation === 0) {
                // Jika Tx belum confirm, putar konstan cepat
                currentRotation += 0.2;
            } else {
                // Jika Tx confirm dan target diketahui, kita lakukan easing
                // Logika simple: Interpolasi dari current ke target
                // Tapi kita harus memastikan waktunya pas 35 detik.
                
                // Progress sisa waktu
                const remaining = duration - elapsed;
                // Putar perlahan menuju target
                // Ini logika easing sederhana:
                const diff = targetRotation - currentRotation;
                currentRotation += diff * 0.05; // Easing factor
            }
            drawWheel(currentRotation);
            requestAnimationFrame(animateSpin);
        } else {
            // Waktu Habis (35 detik lewat)
            isSpinning = false;
            drawWheel(currentRotation);
            showToast("Round Finished!", "success");
            // Refresh data akhir
            fetchData();
        }
    }

    // ================= CANVAS & DRAWING (WITH NAMES) =================
    function initCanvas() {
        const c = document.getElementById('donutCanvas');
        const wrap = document.querySelector('.donut-wrap');
        ctx = c.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        c.width = wrap.clientWidth * dpr;
        c.height = wrap.clientHeight * dpr;
        ctx.scale(dpr, dpr);
        cw = wrap.clientWidth; ch = wrap.clientHeight;
        cx = cw/2; cy = ch/2;
        outerR = cw*0.45; innerR = cw*0.25;
    }

    function drawWheel(rotation) {
        ctx.clearRect(0,0,cw,ch);
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(rotation);
        
        const pKeys = Object.keys(players);
        if(pKeys.length === 0 || totalWeight.eq(0)) {
            // Empty Wheel
            ctx.beginPath(); ctx.arc(0,0,outerR,0,Math.PI*2); ctx.fillStyle='#222'; ctx.fill();
        } else {
            let currentAngle = 0;
            for(let k of pKeys) {
                const p = players[k];
                const slice = p.weight.mul(10000).div(totalWeight).toNumber()/10000 * Math.PI * 2;
                const endAngle = currentAngle + slice;
                
                // Draw Slice
                ctx.beginPath(); ctx.moveTo(0,0);
                ctx.arc(0,0,outerR,currentAngle, endAngle);
                ctx.fillStyle = p.color; ctx.fill();
                
                // Draw Text (Name) - FIX: Add Name Text
                if(slice > 0.1) {
                    ctx.save();
                    ctx.rotate(currentAngle + slice/2);
                    ctx.textAlign = "right";
                    ctx.fillStyle = "white";
                    ctx.font = "bold 12px Ubuntu";
                    ctx.shadowColor="rgba(0,0,0,0.8)"; ctx.shadowBlur=4;
                    ctx.fillText(p.addr.substring(0,6)+"...", outerR - 10, 4);
                    ctx.restore();
                }
                
                currentAngle = endAngle;
            }
        }
        
        // Inner hole
        ctx.beginPath(); ctx.arc(0,0,innerR,0,Math.PI*2); ctx.fillStyle='#0b0b12'; ctx.fill();
        ctx.restore();
    }

    // ================= WINNER LIST DISPLAY (FIX BUG 95000 ETH) =================
    async function updateWinnersList() {
        const list = document.getElementById('winner-list');
        try {
            // Get last 5 winners
            const winners = await contract.getWinners(5);
            let html = "";
            
            // Reverse agar yang terbaru di atas
            [...winners].reverse().forEach(w => {
                // BUG FIX: Cek satu per satu dengan teliti
                let winText = "";
                
                // Format values
                const ethVal = ethers.utils.formatEther(w.rewardETH);
                const usdtVal = ethers.utils.formatUnits(w.rewardUSDT, 6);
                const babyVal = ethers.utils.formatUnits(w.rewardBabyDoge, 18);

                // Logika Display Eksklusif (Prioritas)
                if (parseFloat(ethVal) > 0.0001) {
                    winText = `${parseFloat(ethVal).toFixed(4)} ETH`;
                } 
                else if (parseFloat(usdtVal) > 0.1) {
                    winText = `${parseFloat(usdtVal).toFixed(2)} USDT`;
                } 
                else if (parseFloat(babyVal) > 1) {
                    // Gunakan toLocaleString agar angka besar terbaca (95,000,000)
                    winText = `${parseFloat(babyVal).toLocaleString()} Baby`;
                } else {
                    winText = "No Prize";
                }

                html += `
                <div class="winner-list-item">
                    <div class="winner-avatar" style="background:${COLORS[w.winnerId%COLORS.length]}"></div>
                    <div>
                        <div style="font-size:11px; color:var(--cyan-main);">Round #${w.roundId}</div>
                        <div style="font-weight:bold;">${w.winner.slice(0,6)}...</div>
                        <div style="color:#00ff88; font-size:12px;">Won: ${winText}</div>
                    </div>
                </div>`;
            });
            
            list.innerHTML = html || "<div style='text-align:center; padding:10px; color:#555;'>No winners yet</div>";
        } catch(e) { console.error(e); }
    }

    // ================= BETTING & HELPERS =================
    async function placeBet() {
        if(!signer) return;
        const currency = document.getElementById('betCurrencySelect').value;
        const amt = document.getElementById('betAmountInput').value;
        if(!amt) return;
        
        try {
            let tx;
            if(currency === 'ETH') {
                tx = await contract.placeBetNative({value: ethers.utils.parseEther(amt)});
            } else if (currency === 'FREE') {
                tx = await contract.placeBetFree(ethers.utils.parseEther(amt));
            } else if (currency === 'USDT') {
                const wei = ethers.utils.parseUnits(amt, 6);
                const allow = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
                if(allow.lt(wei)) {
                    showToast("Approving USDT...", "info");
                    await (await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256)).wait();
                }
                tx = await contract.placeBetUSDT(wei);
            } else if (currency === 'BABYDOGE') {
                const wei = ethers.utils.parseUnits(amt, 18);
                const allow = await babyContract.allowance(userAddress, FAYLOTTO_ADDRESS);
                if(allow.lt(wei)) {
                    showToast("Approving BabyDoge...", "info");
                    await (await babyContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256)).wait();
                }
                tx = await contract.placeBetBabyDoge(wei);
            }
            
            showToast("Betting...", "info");
            await tx.wait();
            showToast("Bet Placed!", "success");
            document.getElementById('bet-modal').classList.remove('show');
            document.getElementById('bet-modal-overlay').classList.remove('show');
            fetchData();
        } catch(e) {
            console.error(e);
            showToast("Error: " + (e.reason||e.message).slice(0,30), "error");
        }
    }

    function updateBetList() {
        const div = document.getElementById('bet-list');
        div.innerHTML = "";
        const pKeys = Object.keys(players);
        if(pKeys.length === 0) return div.innerHTML = "<div style='text-align:center; color:#555;'>No bets</div>";
        
        pKeys.forEach(k => {
            const p = players[k];
            // Tampilkan Weight sebagai representasi taruhan (simplified)
            const val = parseFloat(p.weight.toString()); 
            div.innerHTML += `
            <div class="bet-list-item" style="border-left:3px solid ${p.color}">
                <span>${p.addr.slice(0,6)}...</span>
                <span>$${(val/1e18).toFixed(2)} Value</span>
            </div>`;
        });
    }

    async function updateLeaderboard() {
        const div = document.getElementById('leaderboard-list');
        try {
            const p = await contract.getLeaderboardPlayers();
            // Simple sort by profit logic needed here, simplified fetch:
            div.innerHTML = "";
            let count = 0;
            for(let addr of p) {
               if(count >= 5) break;
               const stats = await contract.leaderboardStats(addr);
               const profit = ethers.utils.formatEther(stats.netUsdScore);
               div.innerHTML += `
               <div class="lb-item">
                   <span style="color:gold;">#${count+1}</span>
                   <span>${addr.slice(0,6)}...</span>
                   <span style="color:#00ff88;">$${parseFloat(profit).toFixed(2)}</span>
                   <span>Profit</span>
               </div>`;
               count++;
            }
            if(count===0) div.innerHTML = "<div style='text-align:center; padding:10px; color:#555;'>No data</div>";
        } catch(e){}
    }

    function showToast(msg, type) {
        const d = document.createElement('div');
        d.className = `toast ${type}`; d.innerText = msg;
        document.getElementById('toast-container').appendChild(d);
        setTimeout(()=>d.remove(), 3000);
    }
</script>
</body>
</html>
