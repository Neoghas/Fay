<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --red-main: #c0392b;
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  body {
    margin: 0;
    height: 100vh;
    background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
    font-family: "Ubuntu", sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .app-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  .lists-wrapper {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-top: 20px;
      width: 90%;
      max-width: 820px;
  }

  /* === [DIUBAH] Wallet Buttons Container === */
  .wallet-container {
    position: fixed;
    top: 20px;
    right: 25px;
    display: flex;
    gap: 10px;
    z-index: 1001;
  }
  .wallet-btn, .referral-btn {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 14px; font-weight: bold; padding: 10px 20px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main);
    transition: all 0.3s ease;
  }
  .wallet-btn:hover, .referral-btn:hover { 
      box-shadow: 0 0 25px var(--pink-main); 
      transform: scale(1.05); 
  }
  
  /* [BARU] Tombol Referral */
  .referral-btn {
      background: linear-gradient(90deg, var(--pink-main), var(--blue-main));
      display: none; /* Sembunyi sampai connect */
  }

  .wallet-info {
    position: fixed; top: 65px; right: 25px;
    background: rgba(20, 20, 40, 0.9);
    border: 2px solid var(--border-color);
    border-radius: 12px; padding: 12px 16px;
    font-size: 13px; line-height: 1.5;
    min-width: 240px; display: none;
    box-shadow: 0 0 20px rgba(180, 0, 255, 0.3); z-index: 1001;
  }
  .wallet-info span { color: var(--cyan-main); font-weight: bold; }
  .wallet-info hr {
      border: none;
      height: 1px;
      background-color: var(--border-color);
      margin: 8px 0;
  }

  /* === Wheel (Tidak Berubah) === */
  .wheel-container {
    position: relative; width: 320px; height: 320px;
    border-radius: 50%;
    background: radial-gradient(circle at center, #101020 30%, var(--purple-dark) 100%);
    box-shadow: 0 0 40px rgba(98,0,255,0.5), inset 0 0 25px rgba(0,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    padding-top: 30px; box-sizing: border-box;
  }
  .wheel-pointer {
    position: absolute; width: 0; height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 30px solid var(--blue-main);
    top: 0px; left: 50%;
    transform: translateX(-50%); z-index: 10;
    filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.15));
  }
  #wheel-svg {
    width: 100%; height: 100%;
    transform-origin: center center;
    overflow: visible;
  }
  .wheel-center {
    fill: var(--bg-dark-1);
    stroke: var(--purple-light);
    stroke-width: 2;
    filter: drop-shadow(0 0 10px var(--purple-light));
  }
  .slice {
    stroke: var(--bg-dark-1); stroke-width: 1.5;
    transition: filter 0.2s ease;
  }
  .slice:hover { filter: brightness(1.2); }

  /* === Controls (Tidak Berubah) === */
  .controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 250px; 
  }
  .main-btn {
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    padding: 12px 30px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s ease;
    width: 100%;
  }
  #placeBetBtn {
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main);
  }
  #placeBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }
  #finalizeBtn {
    background: linear-gradient(90deg, var(--pink-main), var(--red-main));
    box-shadow: 0 0 20px var(--pink-main);
    display: none;
  }
  #finalizeBtn:hover { box-shadow: 0 0 25px var(--red-main); transform: scale(1.05); }
  .main-btn:disabled {
    background: #555;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
  }
  .status {
    font-size: 13px;
    margin-top: 8px;
    color: var(--blue-main);
    min-height: 1.2em;
    text-align: center;
    max-width: 320px;
  }
  .timer {
      font-size: 16px;
      font-weight: bold;
      color: var(--cyan-main);
      margin-top: 10px;
      height: 20px;
  }

  /* === Bet & Winner Lists (Tidak Berubah) === */
  .list-container {
    width: 100%;
    max-width: 400px;
    height: 150px;
    background: rgba(10, 10, 20, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    overflow-y: auto;
    flex: 1;
  }
  .list-container h3 {
    margin: 0 0 10px 0; font-size: 14px;
    color: var(--blue-main); text-align: center;
    text-transform: uppercase;
  }
  .bet-list-item, .winner-list-item {
    background: rgba(20, 20, 40, 0.7);
    border-radius: 4px; padding: 8px 10px;
    margin-bottom: 6px; font-size: 12px;
  }
  .bet-list-item {
    display: flex; justify-content: space-between;
    align-items: center;
  }
  .bet-list-item .player-id { font-weight: bold; color: var(--cyan-main); }
  .bet-list-item .player-bets { text-align: right; color: #eee; }
  .winner-list-item .winner-id {
    font-weight: bold;
    color: var(--cyan-main);
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .winner-list-item .winner-id span {
      font-weight: normal;
      color: #aaa;
  }
  .winner-list-item .prize-line {
      font-size: 11px;
      color: #eee;
  }
  #bet-list-placeholder, #winner-list-placeholder {
    text-align: center; font-size: 13px;
    color: #888; padding-top: 20px;
  }

  /* === Modal Base (Digunakan oleh Bet & Referral) === */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999; display: none; opacity: 0;
    transition: opacity 0.3s ease;
  }
  .modal { /* [DIUBAH] Nama kelas generik */
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 380px;
    background: var(--bg-modal);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 0 40px rgba(180, 0, 255, 0.3);
    z-index: 1000; display: none; opacity: 0;
    transition: all 0.3s ease;
  }
  .modal-overlay.show, .modal.show { display: block; opacity: 1; }
  .modal.show { transform: translate(-50%, -50%) scale(1); }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2);
  }
  .modal-header h2 { margin: 0; font-size: 20px; color: var(--blue-main); }
  .modal-close-btn {
    font-size: 28px; font-weight: bold; color: #fff;
    cursor: pointer; line-height: 1; background: none; border: none;
  }
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .balance-display, .min-display { font-size: 13px; color: #999; line-height: 1.5; }
  .balance-display span, .min-display span { font-weight: bold; color: var(--cyan-main); }
  .input-group { display: flex; gap: 10px; }
  .input-group input, .input-group select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    font-size: 16px;
    padding: 10px 12px;
  }
  .input-group input { flex-grow: 1; width: 65%; }
  .input-group select { width: 35%; }
  .percent-buttons { display: flex; justify-content: space-between; gap: 8px; }
  .percent-btn {
    flex: 1; background: rgba(120, 0, 255, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px; color: #fff;
    padding: 8px 10px; font-size: 13px;
    cursor: pointer; transition: background 0.2s ease;
  }
  .percent-btn:hover { background: rgba(120, 0, 255, 0.4); }
  .modal-footer { padding: 20px; border-top: 1px solid rgba(120, 0, 255, 0.2); }
  
  /* Tombol di footer modal */
  .modal-btn {
    width: 100%;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: bold; padding: 12px 30px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 20px var(--blue-main);
    transition: all 0.3s ease;
  }
  .modal-btn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.02); }
  .modal-btn:disabled {
    background: #555; color: #999;
    box-shadow: none; transform: none; cursor: not-allowed;
  }
  
  /* [BARU] Style khusus untuk Referral Modal */
  .ref-section {
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.1);
  }
  .ref-section:last-child { border-bottom: none; }
  .ref-section h3 {
      font-size: 16px;
      color: var(--cyan-main);
      margin: 0 0 10px 0;
  }
  .ref-info {
      font-size: 14px;
      color: #ccc;
      line-height: 1.6;
  }
  .ref-info span {
      color: #fff;
      font-weight: bold;
  }
  .ref-section .input-group {
      margin-bottom: 10px;
  }
  
  @media (max-width: 840px) {
    .lists-wrapper {
        flex-direction: column;
    }
  }
</style>
</head>

<body>
  <div class="wallet-container">
    <button class="referral-btn" id="referralBtn">Referral</button> <button class="wallet-btn" id="walletBtn">Connect Wallet</button>
  </div>

  <div class="wallet-info" id="walletInfo">
    <p>Address: <span id="walletAddress">-</span></p>
    <p>Balance (ETH): <span id="ethBalance">0</span></p>
    <p>Balance (USDT): <span id="usdtBalance">0</span></p>
    <hr/>
    <p>My Deposits (ETH): <span id="myEthDeposit">0</span></p>
    <p>My Deposits (USDT): <span id="myUsdtDeposit">0</span></p>
  </div>

  <div class="app-body">
    <div class="wheel-container">
      <div class="wheel-pointer"></div>
      <svg id="wheel-svg" viewBox="0 0 100 100">
          <g transform="rotate(-90, 50, 50)" id="slices-group"></g>
          <circle class="wheel-center" cx="50" cy="50" r="25" />
      </svg>
      <template id="slice-template">
          <path class="slice" stroke-width="1.5">
              <title></title>
          </path>
      </template>
    </div>

    <div class="controls">
      <button id="placeBetBtn" class="main-btn">Place Bet</button>
      <button id="finalizeBtn" class="main-btn">Finalize Round</button>
      <div class="status" id="statusText">Wallet not connected</div>
      <div class="timer" id="timerText"></div>
    </div>
    
    <div class="lists-wrapper">
      <div id="bet-list-container" class="list-container">
          <h3>Current Round Bets</h3>
          <div id="bet-list">
              <p id="bet-list-placeholder">No bets placed yet in this round.</p>
          </div>
      </div>
      
      <div id="winner-list-container" class="list-container">
          <h3>Recent Winners</h3>
          <div id="winner-list">
              <p id="winner-list-placeholder">No winners yet.</p>
          </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="bet-modal-overlay"></div>
  <div class="modal" id="bet-modal">
    <div class="modal-header">
      <h2>Place Your Bet</h2>
      <button class="modal-close-btn" id="bet-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="balance-display">
        <p>Your Balance:<br/>
          <span id="modalEthBalance">0</span> ETH<br/>
          <span id="modalUsdtBalance">0</span> USDT
        </p>
      </div>
      <div class="min-display">
        Mins: <span>0.00005 ETH</span> / <span>0.5 USDT</span>
      </div>
      <div class="input-group">
        <input type="number" id="betAmountInput" placeholder="Custom Amount">
        <select id="betCurrencySelect">
          <option value="ETH">ETH</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      <div class="percent-buttons">
        <button class="percent-btn" data-percent="0.10">10%</button>
        <button class="percent-btn" data-percent="0.25">25%</button>
        <button class="percent-btn" data-percent="0.50">50%</button>
        <button class="percent-btn" data-percent="0.57">57%</button>
      </div>
    </div>
    <div class="modal-footer">
      <button id="confirmBetBtn" class="modal-btn">Confirm Bet</button>
    </div>
  </div>
  
  <div class="modal-overlay" id="referral-modal-overlay"></div>
  <div class="modal" id="referral-modal">
    <div class="modal-header">
      <h2>Referral System</h2>
      <button class="modal-close-btn" id="referral-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body">
        
      <div class="ref-section">
          <h3>My Info</h3>
          <div class="ref-info">
              My Nickname: <span id="myNickname">-</span><br/>
              My Referrer: <span id="myReferrer">-</span>
          </div>
      </div>
      
      <div class="ref-section">
          <h3>Create/Update Nickname</h3>
          <div class="input-group">
              <input type="text" id="nicknameInput" placeholder="Enter your nickname">
          </div>
          <button id="createNicknameBtn" class="modal-btn">Create</button>
      </div>

      <div class="ref-section" id="setReferrerSection">
          <h3>Set Your Referrer (One Time)</h3>
          <div class="input-group">
              <input type="text" id="referrerNicknameInput" placeholder="Referrer's nickname">
          </div>
          <button id="setReferrerBtn" class="modal-btn">Set Referrer</button>
      </div>
      
      <div class="ref-section">
          <h3>My Rewards</h3>
          <div class="ref-info">
              ETH Rewards: <span id="ethRewards">0</span><br/>
              USDT Rewards: <span id="usdtRewards">0</span><br/>
              Total Referrals: <span id="referralCount">0</span>
          </div>
      </div>

    </div>
    <div class="modal-footer">
      <button id="claimRewardsBtn" class="modal-btn">Claim Rewards</button>
    </div>
  </div>

<script>
// ===========================================
// === 1. KONFIGURASI KONTRAK ===
// ===========================================
// ⚠️ GANTI INI DENGAN ALAMAT KONTRAK ANDA DI SEPOLIA
const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2"; 
const FAYLOTTO_ADDRESS = "0x7CD731477dbD9655A605E1B788F5A064415471D3"; 
// ===========================================

// === 2. ABI LENGKAP ===
const USDT_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
  
const FAYLOTTO_ABI = [{"inputs":[{"internalType":"address","name":"_erc20Token","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetERC20","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20Token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"erc20Reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalERC20","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getWinnerCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsERC20","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];


// ===========================================
// === 3. LOGIKA APLIKASI ===
// ===========================================

// --- Variabel Global ---
let provider, signer, userAddress;
let usdtContract, faylottoContract;
let rawEthBalance, rawUsdtBalance, usdtDecimals = 6;
let currentRoundId;
let currentRoundEndTime = 0;
let visualTimer = null;
let isSpinning = false;
let isFinalizing = false;
let players = {};
let totalWeight = ethers.BigNumber.from(0);

// --- Elemen DOM ---
const walletBtn = document.getElementById("walletBtn");
const walletInfo = document.getElementById("walletInfo");
const walletAddress = document.getElementById("walletAddress");
const ethBalance = document.getElementById("ethBalance");
const usdtBalance = document.getElementById("usdtBalance");
const myEthDeposit = document.getElementById("myEthDeposit");
const myUsdtDeposit = document.getElementById("myUsdtDeposit");
const statusText = document.getElementById("statusText");
const timerText = document.getElementById("timerText");
const placeBetBtn = document.getElementById("placeBetBtn");
const finalizeBtn = document.getElementById("finalizeBtn");
const winnerList = document.getElementById("winner-list");
const winnerListPlaceholder = document.getElementById("winner-list-placeholder");
// Modal Bet
const betModalOverlay = document.getElementById("bet-modal-overlay");
const betModal = document.getElementById("bet-modal");
const betModalCloseBtn = document.getElementById("bet-modal-close-btn");
const modalEthBalance = document.getElementById("modalEthBalance");
const modalUsdtBalance = document.getElementById("modalUsdtBalance");
const betAmountInput = document.getElementById("betAmountInput");
const betCurrencySelect = document.getElementById("betCurrencySelect");
const percentButtons = document.querySelectorAll(".percent-btn");
const confirmBetBtn = document.getElementById("confirmBetBtn");
// Roda & List
const wheelSVG = document.getElementById("wheel-svg");
const slicesGroup = document.getElementById("slices-group");
const sliceTemplate = document.getElementById("slice-template");
const betList = document.getElementById("bet-list");
const betListPlaceholder = document.getElementById("bet-list-placeholder");
// [BARU] Elemen DOM Referral
const referralBtn = document.getElementById("referralBtn");
const referralModalOverlay = document.getElementById("referral-modal-overlay");
const referralModal = document.getElementById("referral-modal");
const referralModalCloseBtn = document.getElementById("referral-modal-close-btn");
const myNickname = document.getElementById("myNickname");
const myReferrer = document.getElementById("myReferrer");
const nicknameInput = document.getElementById("nicknameInput");
const createNicknameBtn = document.getElementById("createNicknameBtn");
const setReferrerSection = document.getElementById("setReferrerSection");
const referrerNicknameInput = document.getElementById("referrerNicknameInput");
const setReferrerBtn = document.getElementById("setReferrerBtn");
const ethRewards = document.getElementById("ethRewards");
const usdtRewards = document.getElementById("usdtRewards");
const referralCount = document.getElementById("referralCount");
const claimRewardsBtn = document.getElementById("claimRewardsBtn");


// === FUNGSI UTAMA: Toggle Connect / Disconnect ===
async function toggleWallet() {
  if (!userAddress) {
    if (!window.ethereum) return alert("Please install MetaMask.");
    try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
        faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, signer);

        walletBtn.innerText = "Disconnect";
        referralBtn.style.display = "block"; // [BARU] Tampilkan tombol referral
        walletInfo.style.display = "block";
        walletAddress.innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
        
        await updateUserBalances();
        await fetchAndDisplayRoundData();
        await fetchAndDisplayWinners();
        await fetchReferralData(); // [BARU] Ambil data referral
        setupEventListeners();

    } catch (err) {
        console.error("Failed to connect wallet:", err);
        statusText.innerText = "Failed to connect. Check console & contract addresses.";
        provider = null; signer = null; userAddress = null;
    }
  } else {
    // Logika Disconnect
    userAddress = null; provider = null; signer = null;
    walletBtn.innerText = "Connect Wallet";
    referralBtn.style.display = "none"; // [BARU] Sembunyikan tombol referral
    statusText.innerText = "Wallet not connected";
    walletInfo.style.display = "none";
    if (visualTimer) clearInterval(visualTimer);
    faylottoContract.removeAllListeners();
    resetRoundUI();
    myEthDeposit.innerText = "0"; 
    myUsdtDeposit.innerText = "0";
    winnerList.innerHTML = "";
    winnerList.appendChild(winnerListPlaceholder);
  }
}

// === FUNGSI UTAMA: Ambil Data Ronde & Mulai Timer ===
async function fetchAndDisplayRoundData() {
    if (!faylottoContract) return;
    try {
        statusText.innerText = "Syncing round data...";
        currentRoundId = await faylottoContract.currentRoundId();
        const roundInfo = await faylottoContract.getRoundBasic(currentRoundId);
        
        if (roundInfo.finalized) {
            statusText.innerText = "Round finalized. Waiting for new round...";
            showFinalizeButton();
            return;
        }

        resetRoundUI();
        
        const playersList = await faylottoContract.getRoundPlayers(currentRoundId);
        for (const playerAddress of playersList) {
            const deposits = await faylottoContract.getPlayerDeposits(currentRoundId, playerAddress);
            addBetToState(playerAddress, deposits.ethAmount, deposits.erc20Amount, false);
        }
        updateWheelVisuals();
        updateBetList();
        await updateMyDeposits();

        currentRoundEndTime = roundInfo.endTime.toNumber() * 1000;
        startVisualTimer(currentRoundEndTime);

        statusText.innerText = `Round ${currentRoundId.toString()} is live!`;
        placeBetBtn.disabled = false;
        placeBetBtn.style.display = "block";
        finalizeBtn.style.display = "none";
        isFinalizing = false;
    } catch (err) {
        console.error("Error fetching round data:", err);
        statusText.innerText = "Error syncing data. Please refresh.";
    }
}

// === FUNGSI UTAMA: Ambil Data Pemenang ===
async function fetchAndDisplayWinners() {
    if (!faylottoContract) return;
    try {
        winnerList.innerHTML = "";
        const winnersArray = await faylottoContract.getWinners(10); 
        
        if (winnersArray.length === 0) {
            winnerList.appendChild(winnerListPlaceholder);
            return;
        }

        for (const winner of winnersArray) {
            const winnerAddr = winner.winner;
            const roundId = winner.roundId.toString();
            const ethAmount = parseFloat(ethers.utils.formatEther(winner.rewardETH)).toFixed(4);
            const usdtAmount = parseFloat(ethers.utils.formatUnits(winner.rewardERC20, usdtDecimals)).toFixed(2);
            
            const shortId = (winnerAddr.toLowerCase() === userAddress.toLowerCase()) ? "You" : (winnerAddr.slice(0, 6) + "..." + winnerAddr.slice(-4));
            
            let prizeHtml = "";
            if (winner.rewardETH.gt(0)) prizeHtml += `${ethAmount} ETH`;
            if (winner.rewardETH.gt(0) && winner.rewardERC20.gt(0)) prizeHtml += " + ";
            if (winner.rewardERC20.gt(0)) prizeHtml += `${usdtAmount} USDT`;

            const item = document.createElement("div");
            item.className = "winner-list-item";
            item.innerHTML = `
              <div class="winner-id">
                ${shortId}
                <span>Round ${roundId}</span>
              </div>
              <div class="prize-line">Won: ${prizeHtml}</div>
            `;
            winnerList.appendChild(item);
        }
    } catch (err) {
        console.error("Error fetching winners:", err);
        winnerList.appendChild(winnerListPlaceholder);
    }
}


// === FUNGSI UTAMA: Memulai Event Listener ===
function setupEventListeners() {
    if (!faylottoContract) return;
    faylottoContract.removeAllListeners();

    faylottoContract.on("BetETH", (roundId, player, amount) => {
        if (roundId.eq(currentRoundId)) {
            addBetToState(player, amount, ethers.BigNumber.from(0), true);
            updateWheelVisuals();
            updateBetList();
            if (player.toLowerCase() === userAddress.toLowerCase()) updateMyDeposits();
        }
    });
    faylottoContract.on("BetERC20", (roundId, player, amount) => {
        if (roundId.eq(currentRoundId)) {
            addBetToState(player, ethers.BigNumber.from(0), amount, true);
            updateWheelVisuals();
            updateBetList();
            if (player.toLowerCase() === userAddress.toLowerCase()) updateMyDeposits();
        }
    });

    faylottoContract.on("RoundFinalized", (roundId, winner, rewardETH, rewardERC20) => {
        if (roundId.eq(currentRoundId)) {
            handleRoundFinalized(roundId, winner);
        }
    });
    
    // [BARU] Event listener untuk update UI referral
    faylottoContract.on("NicknameCreated", (user) => {
        if (user.toLowerCase() === userAddress.toLowerCase()) fetchReferralData();
    });
    faylottoContract.on("ReferralSet", (user) => {
        if (user.toLowerCase() === userAddress.toLowerCase()) fetchReferralData();
    });
}

// === FUNGSI UTAMA: Handle Finalisasi ===
async function handleRoundFinalized(roundId, winner) {
    if (isSpinning) return;
    isSpinning = true;
    isFinalizing = true;
    placeBetBtn.disabled = true;
    placeBetBtn.style.display = "none";
    finalizeBtn.style.display = "none";
    if (visualTimer) clearInterval(visualTimer);
    timerText.innerText = "ROUND ENDED";
    statusText.innerText = "Picking a winner...";

    await new Promise(resolve => setTimeout(resolve, 1000));
    spinToWinner(winner); 
}

// === FUNGSI UTAMA: Reset & Ambil Ronde Baru ===
async function resetAndFetchNewRound() {
    console.log("Mereset untuk ronde baru...");
    isSpinning = false;
    isFinalizing = false;
    
    await new Promise(resolve => setTimeout(resolve, 3000));
    await fetchAndDisplayWinners(); // Refresh daftar pemenang
    await fetchAndDisplayRoundData(); // Ambil ronde baru
}

// === FUNGSI UTAMA: Panggil Finalize dari Tombol ===
async function callFinalizeRound() {
    if (!signer || !faylottoContract) return alert("Please connect your wallet.");

    finalizeBtn.disabled = true;
    statusText.innerText = "Sending finalization transaction...";

    try {
        const tx = await faylottoContract.finalizeRound(currentRoundId);
        statusText.innerText = "Finalizing... awaiting confirmation.";
        await tx.wait();
        console.log("Finalize transaction confirmed.");
    } catch (err) {
        console.error("Finalize call failed:", err);
        alert(err.reason || "Failed to finalize. (Perhaps it's not time yet, or someone else just called it)");
        statusText.innerText = "Finalization failed. Still waiting...";
        finalizeBtn.disabled = false;
    }
}

// === FUNGSI MODAL TARUHAN (Bet Modal) ===
function showBetModal() {
  if (!signer) return alert("Connect wallet first!");
  if (isFinalizing) return alert("Round is ending, new bets are closed.");
  
  modalEthBalance.innerText = ethers.utils.formatEther(rawEthBalance || 0);
  modalUsdtBalance.innerText = ethers.utils.formatUnits(rawUsdtBalance || 0, usdtDecimals);
  betAmountInput.value = "";
  
  betModalOverlay.classList.add("show");
  betModal.classList.add("show");
}
function hideBetModal() {
  betModalOverlay.classList.remove("show");
  betModal.classList.remove("show");
}
function setAmountByPercent(percent) {
  const currency = betCurrencySelect.value;
  let balanceToUse, decimals;
  if (currency === 'ETH') {
    balanceToUse = rawEthBalance; decimals = 18;
  } else {
    balanceToUse = rawUsdtBalance; decimals = usdtDecimals;
  }
  if (!balanceToUse) return;
  const amount = balanceToUse.mul(Math.floor(percent * 1000)).div(1000);
  betAmountInput.value = ethers.utils.formatUnits(amount, decimals);
}

// === FUNGSI MODAL: Konfirmasi & Kirim Transaksi ===
async function confirmBet() {
  const amountStr = betAmountInput.value;
  const currency = betCurrencySelect.value;
  if (!amountStr || parseFloat(amountStr) <= 0) return alert("Please enter a valid amount.");
  confirmBetBtn.disabled = true;
  confirmBetBtn.innerText = "Processing...";
  try {
    let tx;
    if (currency === 'ETH') {
      tx = await placeBetETH(amountStr);
    } else {
      tx = await placeBetUSDT(amountStr);
    }
    statusText.innerText = `Bet sent! Awaiting confirmation...`;
    await tx.wait();
    statusText.innerText = `Bet confirmed! Good luck.`;
    hideBetModal();
    await updateUserBalances();
    await updateMyDeposits();
  } catch (err) {
    console.error(err);
    const errorMessage = err.reason || err.message || "Transaction failed!";
    alert(`Error: ${errorMessage}`);
    statusText.innerText = "Transaction failed.";
  } finally {
    confirmBetBtn.disabled = false;
    confirmBetBtn.innerText = "Confirm Bet";
  }
}
async function placeBetETH(amountStr) {
  const amountWei = ethers.utils.parseEther(amountStr);
  if (amountWei.gt(rawEthBalance)) throw new Error("Insufficient ETH balance.");
  const minEth = ethers.utils.parseEther("0.00005");
  if (amountWei.lt(minEth)) throw new Error("Minimum bet is 0.00005 ETH");
  return faylottoContract.placeBetETH({ value: amountWei });
}
async function placeBetUSDT(amountStr) {
  const amountUsdt = ethers.utils.parseUnits(amountStr, usdtDecimals);
  if (amountUsdt.gt(rawUsdtBalance)) throw new Error("Insufficient USDT balance.");
  const minUsdt = ethers.utils.parseUnits("0.5", usdtDecimals);
  if (amountUsdt.lt(minUsdt)) throw new Error(`Minimum bet is 0.5 USDT`);
  const currentAllowance = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
  if (currentAllowance.lt(amountUsdt)) {
    statusText.innerText = "Need approval. Please approve in MetaMask...";
    const approveTx = await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
    await approveTx.wait();
    statusText.innerText = "Approval successful! Placing bet...";
  }
  return faylottoContract.placeBetERC20(amountUsdt);
}


// ===========================================
// === [BARU] FUNGSI-FUNGSI REFERRAL ===
// ===========================================

// --- Tampilkan & Sembunyikan Modal Referral ---
async function showReferralModal() {
    if (!signer) return alert("Connect wallet first!");
    
    // Selalu ambil data terbaru saat modal dibuka
    await fetchReferralData(); 
    
    referralModalOverlay.classList.add("show");
    referralModal.classList.add("show");
}
function hideReferralModal() {
  referralModalOverlay.classList.remove("show");
  referralModal.classList.remove("show");
}

// --- Ambil Data Referral dari Kontrak ---
async function fetchReferralData() {
    if (!faylottoContract) return;
    try {
        const nick = await faylottoContract.nicknames(userAddress);
        const referrer = await faylottoContract.referrerOf(userAddress);
        const rewards = await faylottoContract.getReferralRewards(userAddress);
        const count = await faylottoContract.getReferralCount(userAddress);
        
        // Panggil fungsi untuk update UI
        updateReferralUI(nick, referrer, rewards, count);
        
    } catch (err) {
        console.error("Error fetching referral data:", err);
        alert("Could not load referral data.");
    }
}

// --- Update UI Modal Referral ---
function updateReferralUI(nick, referrer, rewards, count) {
    // 1. Update Info Saya
    myNickname.innerText = nick || "-";
    if (referrer === ethers.constants.AddressZero) {
        myReferrer.innerText = "-";
        setReferrerSection.style.display = "block"; // Tampilkan section
    } else {
        myReferrer.innerText = referrer.slice(0, 6) + "..." + referrer.slice(-4);
        setReferrerSection.style.display = "none"; // Sembunyikan section
    }

    // 2. Update Rewards Saya
    ethRewards.innerText = parseFloat(ethers.utils.formatEther(rewards.ethReward)).toFixed(6);
    usdtRewards.innerText = parseFloat(ethers.utils.formatUnits(rewards.erc20Reward, usdtDecimals)).toFixed(2);
    referralCount.innerText = count.toString();
    
    // 3. Atur Tombol Claim
    if (rewards.ethReward.gt(0) || rewards.erc20Reward.gt(0)) {
        claimRewardsBtn.disabled = false;
    } else {
        claimRewardsBtn.disabled = true;
    }
}

// --- Panggil Kontrak: createNickname ---
async function callCreateNickname() {
    const nick = nicknameInput.value;
    if (!nick || nick.length < 3) return alert("Nickname must be at least 3 characters.");
    
    createNicknameBtn.disabled = true;
    createNicknameBtn.innerText = "Processing...";
    try {
        const tx = await faylottoContract.createNickname(nick);
        await tx.wait();
        alert("Nickname created/updated successfully!");
        await fetchReferralData(); // Refresh UI
    } catch (err) {
        console.error("Error creating nickname:", err);
        alert(err.reason || "Failed to create nickname.");
    } finally {
        createNicknameBtn.disabled = false;
        createNicknameBtn.innerText = "Create";
    }
}

// --- Panggil Kontrak: setReferralByNickname ---
async function callSetReferrer() {
    const refNick = referrerNicknameInput.value;
    if (!refNick) return alert("Please enter a referrer's nickname.");
    
    setReferrerBtn.disabled = true;
    setReferrerBtn.innerText = "Processing...";
    try {
        const tx = await faylottoContract.setReferralByNickname(refNick);
        await tx.wait();
        alert("Referrer set successfully!");
        await fetchReferralData(); // Refresh UI (akan menyembunyikan section ini)
    } catch (err) {
        console.error("Error setting referrer:", err);
        alert(err.reason || "Failed to set referrer. (Nickname might not exist, or you already have one)");
    } finally {
        setReferrerBtn.disabled = false;
        setReferrerBtn.innerText = "Set Referrer";
    }
}

// --- Panggil Kontrak: claimReferralRewards ---
async function callClaimRewards() {
    claimRewardsBtn.disabled = true;
    claimRewardsBtn.innerText = "Claiming...";
    try {
        const tx = await faylottoContract.claimReferralRewards();
        await tx.wait();
        alert("Rewards claimed successfully!");
        await fetchReferralData(); // Refresh UI (rewards akan jadi 0)
        await updateUserBalances(); // Refresh saldo dompet
    } catch (err) {
        console.error("Error claiming rewards:", err);
        alert(err.reason || "Failed to claim rewards. (You might have no rewards)");
    } finally {
        // Tombol akan di-set ke disabled oleh fetchReferralData jika saldo 0
        claimRewardsBtn.innerText = "Claim Rewards";
    }
}

// === FUNGSI HELPER (Tidak berubah) ===
async function updateUserBalances() {
  if (!provider || !userAddress || !usdtContract) return;
  try {
    rawEthBalance = await provider.getBalance(userAddress);
    ethBalance.innerText = parseFloat(ethers.utils.formatEther(rawEthBalance)).toFixed(5);
    usdtDecimals = await usdtContract.decimals();
    rawUsdtBalance = await usdtContract.balanceOf(userAddress);
    usdtBalance.innerText = parseFloat(ethers.utils.formatUnits(rawUsdtBalance, usdtDecimals)).toFixed(2);
  } catch (err) { 
    console.error("Error fetching balances:", err);
    usdtBalance.innerText = "Error";
  }
}
async function updateMyDeposits() {
    if (!faylottoContract || !currentRoundId || !userAddress) {
        myEthDeposit.innerText = "0";
        myUsdtDeposit.innerText = "0";
        return;
    }
    try {
        const deposits = await faylottoContract.getPlayerDeposits(currentRoundId, userAddress);
        myEthDeposit.innerText = parseFloat(ethers.utils.formatEther(deposits.ethAmount)).toFixed(5);
        myUsdtDeposit.innerText = parseFloat(ethers.utils.formatUnits(deposits.erc20Amount, usdtDecimals)).toFixed(2);
    } catch (err) {
        console.error("Could not fetch user deposits:", err);
        myEthDeposit.innerText = "Error";
        myUsdtDeposit.innerText = "Error";
    }
}
function startVisualTimer(endTime) {
  if (visualTimer) clearInterval(visualTimer);
  
  visualTimer = setInterval(() => {
    const now = Date.now();
    const timeLeft = endTime - now;

    if (timeLeft <= 0) {
      clearInterval(visualTimer);
      timerText.innerText = "00:00";

      // === [PERUBAHAN DIMULAI DI SINI] ===
      // Periksa jumlah pemain sebelum menampilkan tombol Finalize
      const playerCount = Object.keys(players).length;

      if (playerCount > 0) {
        // JIKA ADA PEMAIN: Tampilkan tombol finalize seperti biasa
        showFinalizeButton();
      } else {
        // JIKA TIDAK ADA PEMAIN: Reset/Loop ronde
        statusText.innerText = "Round ended. No players. Restarting...";
        placeBetBtn.disabled = true; // Nonaktifkan taruhan
        finalizeBtn.style.display = "none"; // Pastikan finalize tersembunyi

        // Panggil ulang fetchAndDisplayRoundData setelah 3 detik untuk "me-loop"
        // Ini akan terus memeriksa sampai ada pemain yang masuk.
        setTimeout(fetchAndDisplayRoundData, 3000);
      }
      // === [PERUBAHAN SELESAI] ===
      
      return;
    }

    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    timerText.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }, 1000);
}
function showFinalizeButton() {
    if (isFinalizing) return;
    statusText.innerText = "Round Ended! Click 'Finalize' to pick a winner.";
    placeBetBtn.disabled = true;
    placeBetBtn.style.display = "none";
    finalizeBtn.style.display = "block";
    finalizeBtn.disabled = false;
    isFinalizing = true;
}
function resetRoundUI() {
    players = {};
    totalWeight = ethers.BigNumber.from(0);
    slicesGroup.innerHTML = ''; 
    gsap.set(wheelSVG, { rotation: 0 }); 
    updateBetList();
    placeBetBtn.style.display = "block";
    placeBetBtn.disabled = true;
    finalizeBtn.style.display = "none";
    myEthDeposit.innerText = "0";
    myUsdtDeposit.innerText = "0";
}
function addBetToState(playerId, ethAmount, usdtAmount, isEvent = false) {
  const playerKey = playerId.toLowerCase(); 
  if (!players[playerKey]) {
    players[playerKey] = {
      id: playerId,
      eth: ethers.BigNumber.from(0),
      usdt: ethers.BigNumber.from(0),
      color: `hsl(${Math.floor(Math.random() * 360)}, 90%, 60%)`,
      data: { startAngle: 0, endAngle: 0 }
    };
  }
  const player = players[playerKey];
  if (isEvent) {
      player.eth = player.eth.add(ethAmount);
      player.usdt = player.usdt.add(usdtAmount);
  } else {
      player.eth = ethAmount;
      player.usdt = usdtAmount;
  }
  const ethWeight = player.eth;
  const usdtFactor = ethers.BigNumber.from(10).pow(18 - usdtDecimals);
  const usdtWeight = player.usdt.mul(usdtFactor);
  player.weight = ethWeight.add(usdtWeight);
  totalWeight = ethers.BigNumber.from(0);
  for (const pid in players) {
      totalWeight = totalWeight.add(players[pid].weight);
  }
}
function updateBetList() {
  betList.innerHTML = ""; 
  const playerIds = Object.keys(players);
  if (playerIds.length === 0) {
    betList.innerHTML = '<p id="bet-list-placeholder">No bets placed yet in this round.</p>';
    return;
  }
  playerIds.forEach(id => {
    const player = players[id];
    const ethAmount = parseFloat(ethers.utils.formatEther(player.eth)).toFixed(5);
    const usdtAmount = parseFloat(ethers.utils.formatUnits(player.usdt, usdtDecimals)).toFixed(2);
    const shortId = (id.toLowerCase() === userAddress.toLowerCase()) ? "You" : (id.slice(0, 6) + "..." + id.slice(-4));
    let betsHtml = "";
    if (player.eth.gt(0)) betsHtml += `${ethAmount} ETH`;
    if (player.eth.gt(0) && player.usdt.gt(0)) betsHtml += " + ";
    if (player.usdt.gt(0)) betsHtml += `${usdtAmount} USDT`;
    const item = document.createElement("div");
    item.className = "bet-list-item";
    item.innerHTML = `
      <div class="player-id" style="color: ${player.color}">${shortId}</div>
      <div class="player-bets">${betsHtml}</div>
    `;
    betList.appendChild(item);
  });
}
function updateWheelVisuals() {
  let currentAngle = 0;
  for (const playerId in players) {
    const player = players[playerId];
    let percentage = 0;
    if (totalWeight.gt(0)) {
      percentage = player.weight.mul(10000).div(totalWeight).toNumber() / 10000;
    }
    const angle = percentage * 360;
    const startAngle = currentAngle;
    const endAngle = currentAngle + angle;
    if (!player.sliceElement) {
        const newSliceFragment = sliceTemplate.content.cloneNode(true);
        player.sliceElement = newSliceFragment.querySelector("path");
        player.titleElement = newSliceFragment.querySelector("title");
        player.sliceElement.setAttribute("fill", player.color);
        slicesGroup.appendChild(newSliceFragment);
    }
    const shortId = (player.id.toLowerCase() === userAddress.toLowerCase()) ? "You" : player.id.slice(0,6);
    player.titleElement.textContent = `${shortId}: ${(percentage * 100).toFixed(2)}%`;
    gsap.to(player.data, {
        startAngle: startAngle,
        endAngle: endAngle,
        duration: 0.7,
        ease: "power2.out",
        onUpdate: () => {
            const d = describeArc(50, 50, 45, player.data.startAngle, player.data.endAngle);
            player.sliceElement.setAttribute("d", d);
        }
    });
    currentAngle = endAngle;
  }
}
function spinToWinner(winnerId) {
    const winner = players[winnerId.toLowerCase()];
    if (!winner) {
        console.error("Pemenang tidak ditemukan! Mereset...");
        resetAndFetchNewRound();
        return;
    }
    const startAngle = winner.data.startAngle;
    const endAngle = winner.data.endAngle;
    const sliceWidth = endAngle - startAngle;
    const targetMiddleAngle = startAngle + sliceWidth / 2;
    const finalTargetAngle = targetMiddleAngle;
    let currentRotation = gsap.getProperty(wheelSVG, "rotation");
    let currentPosition = currentRotation % 360;
    const fullSpins = 5 * 360;
    let distanceToTarget = -finalTargetAngle - currentPosition;
    if (distanceToTarget > 0) distanceToTarget -= 360;
    const totalSpinAmount = fullSpins + Math.abs(distanceToTarget);
    gsap.to(wheelSVG, {
        duration: 6,
        rotation: `-=${totalSpinAmount}`,
        ease: "power3.out",
        onComplete: () => {
            const isWinner = (winnerId.toLowerCase() === userAddress.toLowerCase());
            const winnerName = isWinner ? "You" : winnerId.slice(0, 6) + "...";
            statusText.innerText = `Winner is ${winnerName}!`;
            alert(`Pemenangnya adalah ${winnerName}!`);
            resetAndFetchNewRound();
        }
    });
}
function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
    var angleInRadians = (angleInDegrees) * Math.PI / 180.0;
    return {
        x: centerX + (radius * Math.cos(angleInRadians)),
        y: centerY + (radius * Math.sin(angleInRadians))
    };
}
function describeArc(x, y, radius, startAngle, endAngle) {
    if (endAngle - startAngle >= 360) endAngle = startAngle + 359.99;
    if (endAngle <= startAngle + 0.01) endAngle = startAngle + 0.01;
    var start = polarToCartesian(x, y, radius, endAngle);
    var end = polarToCartesian(x, y, radius, startAngle);
    var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
    var d = ["M", x, y, "L", start.x, start.y, "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y, "Z"].join(" ");
    return d;
}

// === 4. Inisialisasi & Event Listeners ===
walletBtn.addEventListener("click", toggleWallet);
placeBetBtn.addEventListener("click", showBetModal);
finalizeBtn.addEventListener("click", callFinalizeRound);

// Listener Modal Bet
betModalCloseBtn.addEventListener("click", hideBetModal);
betModalOverlay.addEventListener("click", hideBetModal);
confirmBetBtn.addEventListener("click", confirmBet);
percentButtons.forEach(button => {
  button.addEventListener("click", () => {
    const percent = parseFloat(button.dataset.percent);
    setAmountByPercent(percent);
  });
});

// [BARU] Listener Modal Referral
referralBtn.addEventListener("click", showReferralModal);
referralModalCloseBtn.addEventListener("click", hideReferralModal);
referralModalOverlay.addEventListener("click", hideReferralModal);
createNicknameBtn.addEventListener("click", callCreateNickname);
setReferrerBtn.addEventListener("click", callSetReferrer);
claimRewardsBtn.addEventListener("click", callClaimRewards);
</script>
</body>
  </html>
