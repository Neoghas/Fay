<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --red-main: #c0392b; /* [BARU] Warna untuk tombol finalize */
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  body {
    margin: 0;
    height: 100vh;
    background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
    font-family: "Ubuntu", sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  /* === Wallet Button & Info (Tidak Berubah) === */
  .wallet-btn {
    position: fixed; top: 20px; right: 25px;
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 14px; font-weight: bold; padding: 10px 20px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main);
    transition: all 0.3s ease; z-index: 1001;
  }
  .wallet-btn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }
  .wallet-info {
    position: fixed; top: 65px; right: 25px;
    background: rgba(20, 20, 40, 0.9);
    border: 2px solid var(--border-color);
    border-radius: 12px; padding: 12px 16px;
    font-size: 13px; line-height: 1.5;
    min-width: 240px; display: none;
    box-shadow: 0 0 20px rgba(180, 0, 255, 0.3); z-index: 1001;
  }
  .wallet-info span { color: var(--cyan-main); font-weight: bold; }

  /* === Wheel Container & SVG (Tidak Berubah) === */
  .wheel-container {
    position: relative; width: 320px; height: 320px;
    border-radius: 50%;
    background: radial-gradient(circle at center, #101020 30%, var(--purple-dark) 100%);
    box-shadow: 0 0 40px rgba(98,0,255,0.5), inset 0 0 25px rgba(0,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    padding-top: 30px; box-sizing: border-box;
  }
  .wheel-pointer {
    position: absolute; width: 0; height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 30px solid var(--blue-main);
    top: 0px; left: 50%;
    transform: translateX(-50%); z-index: 10;
    filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.15));
  }
  #wheel-svg {
    width: 100%; height: 100%;
    transform-origin: center center;
    overflow: visible;
  }
  .wheel-center {
    fill: var(--bg-dark-1);
    stroke: var(--purple-light);
    stroke-width: 2;
    filter: drop-shadow(0 0 10px var(--purple-light));
  }
  .slice {
    stroke: var(--bg-dark-1); stroke-width: 1.5;
    transition: filter 0.2s ease;
  }
  .slice:hover { filter: brightness(1.2); }

  /* === Controls (DIUBAH) === */
  .controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    /* [BARU] Pastikan tombol pas */
    width: 250px; 
  }
  
  /* [DIUBAH] Tombol sekarang punya style dasar */
  .main-btn {
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    padding: 12px 30px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s ease;
    width: 100%; /* Tombol sekarang full-width */
  }
  
  #placeBetBtn {
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main);
  }
  #placeBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }

  /* [BARU] Tombol Finalize */
  #finalizeBtn {
    background: linear-gradient(90deg, var(--pink-main), var(--red-main));
    box-shadow: 0 0 20px var(--pink-main);
    display: none; /* Sembunyi by default */
  }
  #finalizeBtn:hover { box-shadow: 0 0 25px var(--red-main); transform: scale(1.05); }
  
  .main-btn:disabled {
    background: #555;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
  }

  .status {
    font-size: 13px;
    margin-top: 8px;
    color: var(--blue-main);
    min-height: 1.2em;
    text-align: center;
    max-width: 320px;
  }
  .timer {
      font-size: 16px;
      font-weight: bold;
      color: var(--cyan-main);
      margin-top: 10px;
      height: 20px;
  }

  /* === Bet List (Tidak Berubah) === */
  #bet-list-container {
    margin-top: 20px;
    width: 90%;
    max-width: 400px;
    height: 150px;
    background: rgba(10, 10, 20, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  #bet-list-container h3 {
    margin: 0 0 10px 0; font-size: 14px;
    color: var(--blue-main); text-align: center;
    text-transform: uppercase;
  }
  .bet-list-item {
    background: rgba(20, 20, 40, 0.7);
    border-radius: 4px; padding: 8px 10px;
    margin-bottom: 6px; font-size: 12px;
    display: flex; justify-content: space-between;
    align-items: center;
  }
  .bet-list-item .player-id { font-weight: bold; color: var(--cyan-main); }
  .bet-list-item .player-bets { text-align: right; color: #eee; }
  #bet-list-placeholder {
    text-align: center; font-size: 13px;
    color: #888; padding-top: 20px;
  }

  /* === MODAL POPUP (Tidak Berubah) === */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999; display: none; opacity: 0;
    transition: opacity 0.3s ease;
  }
  .bet-modal {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 380px;
    background: var(--bg-modal);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 0 40px rgba(180, 0, 255, 0.3);
    z-index: 1000; display: none; opacity: 0;
    transition: all 0.3s ease;
  }
  .modal-overlay.show, .bet-modal.show { display: block; opacity: 1; }
  .bet-modal.show { transform: translate(-50%, -50%) scale(1); }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2);
  }
  .modal-header h2 { margin: 0; font-size: 20px; color: var(--blue-main); }
  .modal-close-btn {
    font-size: 28px; font-weight: bold; color: #fff;
    cursor: pointer; line-height: 1; background: none; border: none;
  }
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .balance-display, .min-display { font-size: 13px; color: #999; line-height: 1.5; }
  .balance-display span, .min-display span { font-weight: bold; color: var(--cyan-main); }
  .input-group { display: flex; gap: 10px; }
  .input-group input, .input-group select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    font-size: 16px;
    padding: 10px 12px;
  }
  .input-group input { flex-grow: 1; width: 65%; }
  .input-group select { width: 35%; }
  .percent-buttons { display: flex; justify-content: space-between; gap: 8px; }
  .percent-btn {
    flex: 1; background: rgba(120, 0, 255, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px; color: #fff;
    padding: 8px 10px; font-size: 13px;
    cursor: pointer; transition: background 0.2s ease;
  }
  .percent-btn:hover { background: rgba(120, 0, 255, 0.4); }
  .modal-footer { padding: 20px; border-top: 1px solid rgba(120, 0, 255, 0.2); }
  #confirmBetBtn {
    width: 100%;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: bold; padding: 12px 30px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 20px var(--blue-main);
    transition: all 0.3s ease;
  }
  #confirmBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.02); }
  #confirmBetBtn:disabled {
    background: #555; color: #999;
    box-shadow: none; transform: none; cursor: not-allowed;
  }
</style>
</head>

<body>
  <button class="wallet-btn" id="walletBtn">Connect Wallet</button>

  <div class="wallet-info" id="walletInfo">
    <p>Address: <span id="walletAddress">-</span></p>
    <p>Balance (ETH): <span id="ethBalance">0</span></p>
    <p>Balance (USDT): <span id="usdtBalance">0</span></p>
  </div>

  <div class="wheel-container">
    <div class="wheel-pointer"></div>
    <svg id="wheel-svg" viewBox="0 0 100 100">
        <g transform="rotate(-90, 50, 50)" id="slices-group"></g>
        <circle class="wheel-center" cx="50" cy="50" r="25" />
    </svg>
    <template id="slice-template">
         <path class="slice" stroke-width="1.5">
            <title></title>
         </path>
    </template>
  </div>

  <div class="controls">
    <button id="placeBetBtn" class="main-btn">Place Bet</button>
    <button id="finalizeBtn" class="main-btn">Finalize Round</button> <div class="status" id="statusText">Wallet not connected</div>
    <div class="timer" id="timerText"></div>
  </div>
  
  <div id="bet-list-container">
      <h3>Current Round Bets</h3>
      <div id="bet-list">
          <p id="bet-list-placeholder">No bets placed yet in this round.</p>
      </div>
  </div>

  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="bet-modal" id="bet-modal">
    <div class="modal-header">
      <h2>Place Your Bet</h2>
      <button class="modal-close-btn" id="modal-close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="balance-display">
        <p>Your Balance:<br/>
          <span id="modalEthBalance">0</span> ETH<br/>
          <span id="modalUsdtBalance">0</span> USDT
        </p>
      </div>
      <div class="min-display">
        Mins: <span>0.00005 ETH</span> / <span>0.5 USDT</span>
      </div>
      <div class="input-group">
        <input type="number" id="betAmountInput" placeholder="Custom Amount">
        <select id="betCurrencySelect">
          <option value="ETH">ETH</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      <div class="percent-buttons">
        <button class="percent-btn" data-percent="0.10">10%</button>
        <button class="percent-btn" data-percent="0.25">25%</button>
        <button class="percent-btn" data-percent="0.50">50%</button>
        <button class="percent-btn" data-percent="0.57">57%</button>
      </div>
    </div>
    <div class="modal-footer">
      <button id="confirmBetBtn">Confirm Bet</button>
    </div>
  </div>

<script>
// ===========================================
// === 1. KONFIGURASI KONTRAK ===
// ===========================================
// ⚠️ GANTI INI DENGAN ALAMAT KONTRAK ANDA DI SEPOLIA
const USDT_ADDRESS = "0x...AlamatTokenUSDT_DiSepolia"; 
const FAYLOTTO_ADDRESS = "0x...AlamatFaylotto_DiSepolia"; 
// ===========================================

// === 2. ABI LENGKAP ===
// (Salin-tempel ABI lengkap Anda di sini, SAMA SEPERTI SEBELUMNYA)
// ===========================================
const USDT_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)"
];
const FAYLOTTO_ABI = [
  "constructor(address _erc20Token, address _feeCollector)",
  "event BetETH(uint256 indexed roundId, address indexed player, uint256 amount)",
  "event BetERC20(uint256 indexed roundId, address indexed player, uint256 amount)",
  "event CommentAdded(uint256 indexed winnerId, uint256 commentId, address indexed user, string text)",
  "event CommentEdited(uint256 indexed winnerId, uint256 commentId, address indexed user, string newText)",
  "event NicknameCreated(address indexed user, string nickname)",
  "event Rated(uint256 indexed winnerId, address indexed user, uint8 stars)",
  "event ReferralRewardClaimed(address indexed user, uint256 ethAmount, uint256 erc20Amount)",
  "event ReferralSet(address indexed user, address indexed referrer)",
  "event RoundCreated(uint256 indexed roundId, uint256 startTime, uint256 endTime)",
  "event RoundFinalized(uint256 indexed roundId, address indexed winner, uint256 rewardETH, uint256 rewardERC20)",
  "event WinnerLiked(uint256 indexed winnerId, address indexed user, bool liked)",
  "event WinnerRecorded(uint256 indexed winnerId, uint256 roundId, address indexed winner, uint256 rewardETH, uint256 rewardERC20, uint256 timestamp)",
  "function REF_BP() view returns (uint256)",
  "function MAX_PLAYERS() view returns (uint256)",
  "function addCommentToWinner(uint256 winnerId, string text)",
  "function adminWithdrawETH(address to, uint256 amount)",
  "function adminWithdrawERC20(address to, uint256 amount)",
  "function claimReferRewards()",
  "function createNickname(string nickname)",
  "function currentRoundId() view returns (uint256)",
  "function editCommentOnWinner(uint256 winnerId, uint256 commentId, string newText)",
  "function erc20Token() view returns (address)",
  "function feeBP() view returns (uint256)",
  "function feeCollector() view returns (address)",
  "function finalizeRound(uint256 rid)",
  "function getAllCommentsForWinner(uint256 winnerId) view returns ((address user, string text, uint256 timestamp)[] memory)",
  "function getAllLikes(uint256 winnerId) view returns (address[] memory)",
  "function getAverageRatingForWinner(uint256 winnerId) view returns (uint256 avgTimes1e18)",
  "function getCommentCountForWinner(uint256 winnerId) view returns (uint256)",
  "function getLikeCount(uint256 winnerId) view returns (uint256)",
  "function getPlayerDeposits(uint256 rid, address player) view returns (uint256 ethAmount, uint256 erc20Amount)",
  "function getRatingCountForWinner(uint256 winnerId) view returns (uint256)",
  "function getReferralCount(address user) view returns (uint256)",
  "function getReferralList(address user) view returns (address[] memory)",
  "function getReferralRewards(address user) view returns (uint256 ethReward, uint256 erc20Reward)",
  "function getRoundBasic(uint256 rid) view returns (uint256 id, uint256 startTime, uint256 endTime, bool finalized, address winner, uint256 totalETH, uint256 totalERC20, uint256 playersCount)",
  "function getRoundPlayers(uint256 rid) view returns (address[] memory)",
  "function getWinnerCount() view returns (uint256)",
  "function getWinners(uint256 limit) view returns ((uint256 winnerId, uint256 roundId, address winner, uint256 rewardETH, uint256 rewardERC20, uint256 timestamp)[] memory)",
  "function likeCount(uint256) view returns (uint256)",
  "function liked(uint256, address) view returns (bool)",
  "function likedBy(uint256, uint256) view returns (address)",
  "function nextRoundId() view returns (uint256)",
  "function nicknameOwner(string) view returns (address)",
  "function nicknames(address) view returns (string)",
  "function owner() view returns (address)",
  "function placeBetERC20(uint256 amount)",
  "function placeBetETH() payable",
  "function rateWinner(uint256 winnerId, uint8 stars)",
  "function ratingCountByWinner(uint256) view returns (uint256)",
  "function ratingTotalStars(uint256) view returns (uint256)",
"function ratings(uint256, address) view returns (uint8)",
  "function referralRewardsETH(address) view returns (uint256)",
  "function referralRewardsERC20(address) view returns (uint256)",
  "function referrals(address, uint256) view returns (address)",
  "function referrerOf(address) view returns (address)",
  "function roundLength() view returns (uint256)",
  "function setERC20(address token)",
  "function setFeeBP(uint256 newFeeBP)",
  "function setFeeCollector(address newCollector)",
  "function setReferralByNickname(string refNickname)",
  "function setRoundLength(uint256 secs)",
  "function toggleLikeWinner(uint256 winnerId)",
  "function winners(uint256) view returns (uint256 winnerId, uint256 roundId, address winner, uint256 rewardETH, uint256 rewardERC20, uint256 timestamp)",
  "function winnerList(uint256) view returns (uint256 winnerId, uint256 roundId, address winner, uint256 rewardETH, uint256 rewardERC20, uint256 timestamp)"
];

// ===========================================
// === 3. LOGIKA APLIKASI (DISEMPURNAKAN) ===
// ===========================================

// --- Variabel Global ---
let provider, signer, userAddress;
let usdtContract, faylottoContract;
let rawEthBalance, rawUsdtBalance, usdtDecimals = 6;
let currentRoundId;
let currentRoundEndTime = 0;
let visualTimer = null;
let isSpinning = false;
let isFinalizing = false;

// --- State Roda Dinamis ---
let players = {};
let totalWeight = ethers.BigNumber.from(0);

// --- Elemen DOM ---
const walletBtn = document.getElementById("walletBtn");
const walletInfo = document.getElementById("walletInfo");
const walletAddress = document.getElementById("walletAddress");
const ethBalance = document.getElementById("ethBalance");
const usdtBalance = document.getElementById("usdtBalance");
const statusText = document.getElementById("statusText");
const timerText = document.getElementById("timerText");
const placeBetBtn = document.getElementById("placeBetBtn");
const finalizeBtn = document.getElementById("finalizeBtn"); // [BARU]
// Modal
const modalOverlay = document.getElementById("modal-overlay");
const betModal = document.getElementById("bet-modal");
const modalCloseBtn = document.getElementById("modal-close-btn");
const modalEthBalance = document.getElementById("modalEthBalance");
const modalUsdtBalance = document.getElementById("modalUsdtBalance");
const betAmountInput = document.getElementById("betAmountInput");
const betCurrencySelect = document.getElementById("betCurrencySelect");
const percentButtons = document.querySelectorAll(".percent-btn");
const confirmBetBtn = document.getElementById("confirmBetBtn");
// Roda & List
const wheelSVG = document.getElementById("wheel-svg");
const slicesGroup = document.getElementById("slices-group");
const sliceTemplate = document.getElementById("slice-template");
const betList = document.getElementById("bet-list");
const betListPlaceholder = document.getElementById("bet-list-placeholder");


// === FUNGSI UTAMA: Toggle Connect / Disconnect ===
async function toggleWallet() {
  if (!userAddress) {
    if (!window.ethereum) return alert("Please install MetaMask.");
    try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
        faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, signer);

        walletBtn.innerText = "Disconnect";
        walletInfo.style.display = "block";
        walletAddress.innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
        
        await updateUserBalances();
        await fetchAndDisplayRoundData();
        setupEventListeners();
    } catch (err) {
        console.error("Failed to connect wallet:", err);
        statusText.innerText = "Failed to connect. Check console & contract addresses.";
        provider = null; signer = null; userAddress = null;
    }
  } else {
    // Logika Disconnect
    userAddress = null; provider = null; signer = null;
    walletBtn.innerText = "Connect Wallet";
    statusText.innerText = "Wallet not connected";
    walletInfo.style.display = "none";
    if (visualTimer) clearInterval(visualTimer);
    faylottoContract.removeAllListeners();
    resetRoundUI();
  }
}

// === FUNGSI UTAMA: Ambil Data Ronde & Mulai Timer ===
async function fetchAndDisplayRoundData() {
    if (!faylottoContract) return;
    try {
        statusText.innerText = "Syncing round data...";
        currentRoundId = await faylottoContract.currentRoundId();
        const roundInfo = await faylottoContract.getRoundBasic(currentRoundId);
        
        if (roundInfo.finalized) {
            statusText.innerText = "Round finalized. Waiting for new round...";
            // Jika ronde sudah difinalisasi, kita tetap HARUS memanggilnya
            // untuk memicu _createNewRound di kontrak.
            showFinalizeButton();
            return;
        }

        resetRoundUI();
        
        const playersList = await faylottoContract.getRoundPlayers(currentRoundId);
        for (const playerAddress of playersList) {
            const deposits = await faylottoContract.getPlayerDeposits(currentRoundId, playerAddress);
            addBetToState(playerAddress, deposits.ethAmount, deposits.erc20Amount);
        }
        updateWheelVisuals();
        updateBetList();

        currentRoundEndTime = roundInfo.endTime.toNumber() * 1000;
        startVisualTimer(currentRoundEndTime);

        statusText.innerText = `Round ${currentRoundId.toString()} is live!`;
        placeBetBtn.disabled = false;
        placeBetBtn.style.display = "block"; // Tampilkan tombol bet
        finalizeBtn.style.display = "none"; // Sembunyikan tombol finalize
        isFinalizing = false;
    } catch (err) {
        console.error("Error fetching round data:", err);
        statusText.innerText = "Error syncing data. Please refresh.";
    }
}

// === FUNGSI UTAMA: Memulai Event Listener ===
function setupEventListeners() {
    if (!faylottoContract) return;
    faylottoContract.removeAllListeners();

    // Dengarkan taruhan BARU
    faylottoContract.on("BetETH", (roundId, player, amount) => {
        if (roundId.eq(currentRoundId)) {
            addBetToState(player, amount, ethers.BigNumber.from(0), true); // 'true' berarti 'tambahkan'
            updateWheelVisuals();
            updateBetList();
        }
    });
    faylottoContract.on("BetERC20", (roundId, player, amount) => {
        if (roundId.eq(currentRoundId)) {
            addBetToState(player, ethers.BigNumber.from(0), amount, true); // 'true' berarti 'tambahkan'
            updateWheelVisuals();
            updateBetList();
        }
    });

    // Dengarkan event KUNCI: RoundFinalized
    faylottoContract.on("RoundFinalized", (roundId, winner, rewardETH, rewardERC20) => {
        if (roundId.eq(currentRoundId)) {
            handleRoundFinalized(roundId, winner);
        }
    });
}

// === FUNGSI UTAMA: Handle Finalisasi ===
async function handleRoundFinalized(roundId, winner) {
    if (isSpinning) return;
    isSpinning = true;
    isFinalizing = true;
    placeBetBtn.disabled = true;
    placeBetBtn.style.display = "none";
    finalizeBtn.style.display = "none";
    if (visualTimer) clearInterval(visualTimer);
    timerText.innerText = "ROUND ENDED";
    statusText.innerText = "Picking a winner...";

    await new Promise(resolve => setTimeout(resolve, 1000));
    spinToWinner(winner); 
}

// === FUNGSI UTAMA: Reset & Ambil Ronde Baru ===
async function resetAndFetchNewRound() {
    console.log("Mereset untuk ronde baru...");
    isSpinning = false;
    isFinalizing = false;
    
    await new Promise(resolve => setTimeout(resolve, 3000)); // Jeda 3 detik
    await fetchAndDisplayRoundData(); // Ambil ronde BARU (kontrak sudah membuat yg baru)
}

// === [BARU] FUNGSI UTAMA: Panggil Finalize dari Tombol ===
async function callFinalizeRound() {
    if (!signer) return alert("Please connect your wallet to finalize.");
    if (!faylottoContract) return alert("Contract not loaded.");

    finalizeBtn.disabled = true;
    statusText.innerText = "Sending finalization transaction...";

    try {
        const tx = await faylottoContract.finalizeRound(currentRoundId);
        statusText.innerText = "Finalizing... awaiting confirmation.";
        await tx.wait();
        // Event listener "RoundFinalized" akan mengambil alih dari sini
        console.log("Finalize transaction confirmed. Event listener will now take over.");
        // Kita tidak perlu melakukan apa-apa lagi
    } catch (err) {
        console.error("Finalize call failed:", err);
        alert(err.reason || "Failed to finalize. (Perhaps it's not time yet, or someone else just called it)");
        statusText.innerText = "Finalization failed. Still waiting...";
        finalizeBtn.disabled = false; // Aktifkan lagi jika gagal
    }
}

// === FUNGSI MODAL (Tidak berubah) ===
function showBetModal() {
  if (!signer) return alert("Connect wallet first!");
  if (isFinalizing) return alert("Round is ending, new bets are closed.");
  
  modalEthBalance.innerText = ethers.utils.formatEther(rawEthBalance || 0);
  modalUsdtBalance.innerText = ethers.utils.formatUnits(rawUsdtBalance || 0, usdtDecimals);
  betAmountInput.value = "";
  
  modalOverlay.classList.add("show");
  betModal.classList.add("show");
}
function hideBetModal() {
  modalOverlay.classList.remove("show");
  betModal.classList.remove("show");
}
function setAmountByPercent(percent) {
  const currency = betCurrencySelect.value;
  let balanceToUse, decimals;
  if (currency === 'ETH') {
    balanceToUse = rawEthBalance; decimals = 18;
  } else {
    balanceToUse = rawUsdtBalance; decimals = usdtDecimals;
  }
  if (!balanceToUse) return;
  const amount = balanceToUse.mul(Math.floor(percent * 1000)).div(1000);
  betAmountInput.value = ethers.utils.formatUnits(amount, decimals);
}

// === FUNGSI MODAL: Konfirmasi & Kirim Transaksi (Tidak berubah) ===
async function confirmBet() {
  const amountStr = betAmountInput.value;
  const currency = betCurrencySelect.value;
  
  if (!amountStr || parseFloat(amountStr) <= 0) return alert("Please enter a valid amount.");
  
  confirmBetBtn.disabled = true;
  confirmBetBtn.innerText = "Processing...";
  
  try {
    let tx;
    if (currency === 'ETH') {
      tx = await placeBetETH(amountStr);
    } else {
      tx = await placeBetUSDT(amountStr);
    }
    
    statusText.innerText = `Bet sent! Awaiting confirmation...`;
    await tx.wait();
    
    statusText.innerText = `Bet confirmed! Good luck.`;
    hideModal();
    await updateUserBalances();
    // Event listener akan meng-update roda
    
  } catch (err) {
    console.error(err);
    const errorMessage = err.reason || err.message || "Transaction failed!";
    alert(`Error: ${errorMessage}`);
    statusText.innerText = "Transaction failed.";
  } finally {
    confirmBetBtn.disabled = false;
    confirmBetBtn.innerText = "Confirm Bet";
  }
}
async function placeBetETH(amountStr) {
  const amountWei = ethers.utils.parseEther(amountStr);
  if (amountWei.gt(rawEthBalance)) throw new Error("Insufficient ETH balance.");
  const minEth = ethers.utils.parseEther("0.00005");
  if (amountWei.lt(minEth)) throw new Error("Minimum bet is 0.00005 ETH");
  return faylottoContract.placeBetETH({ value: amountWei });
}
async function placeBetUSDT(amountStr) {
  const amountUsdt = ethers.utils.parseUnits(amountStr, usdtDecimals);
  if (amountUsdt.gt(rawUsdtBalance)) throw new Error("Insufficient USDT balance.");
  const minUsdt = ethers.utils.parseUnits("0.5", usdtDecimals);
  if (amountUsdt.lt(minUsdt)) throw new Error(`Minimum bet is 0.5 USDT`);
  
  const currentAllowance = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
  if (currentAllowance.lt(amountUsdt)) {
    statusText.innerText = "Need approval. Please approve in MetaMask...";
    const approveTx = await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
    await approveTx.wait();
    statusText.innerText = "Approval successful! Placing bet...";
  }
  return faylottoContract.placeBetERC20(amountUsdt);
}

// === FUNGSI HELPER ===
async function updateUserBalances() {
  if (!provider || !userAddress || !usdtContract) return;
  try {
    rawEthBalance = await provider.getBalance(userAddress);
    ethBalance.innerText = parseFloat(ethers.utils.formatEther(rawEthBalance)).toFixed(5);
    
    usdtDecimals = await usdtContract.decimals();
    rawUsdtBalance = await usdtContract.balanceOf(userAddress);
    usdtBalance.innerText = parseFloat(ethers.utils.formatUnits(rawUsdtBalance, usdtDecimals)).toFixed(2);
  } catch (err) { 
    console.error("Error fetching balances:", err);
    usdtBalance.innerText = "Error";
  }
}

function startVisualTimer(endTime) {
  if (visualTimer) clearInterval(visualTimer);

  visualTimer = setInterval(() => {
    const now = Date.now();
    const timeLeft = endTime - now;

    if (timeLeft <= 0) {
      clearInterval(visualTimer);
      timerText.innerText = "00:00";
      // [DIUBAH] Panggil fungsi untuk menampilkan tombol finalize
      showFinalizeButton();
      return;
    }

    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    timerText.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }, 1000);
}

// [BARU] Fungsi untuk menukar tombol
function showFinalizeButton() {
    if (isFinalizing) return; // Jangan lakukan apa-apa jika sudah finalisasi
    statusText.innerText = "Round Ended! Click 'Finalize' to pick a winner.";
    placeBetBtn.disabled = true;
    placeBetBtn.style.display = "none"; // Sembunyikan tombol bet
    finalizeBtn.style.display = "block"; // Tampilkan tombol finalize
    finalizeBtn.disabled = false;
    isFinalizing = true;
}

function resetRoundUI() {
    players = {};
    totalWeight = ethers.BigNumber.from(0);
    slicesGroup.innerHTML = ''; 
    gsap.set(wheelSVG, { rotation: 0 }); 
    updateBetList();
    // [BARU] Pastikan tombol kembali ke state awal
    placeBetBtn.style.display = "block";
    placeBetBtn.disabled = true; // Akan diaktifkan oleh fetchAndDisplayRoundData
    finalizeBtn.style.display = "none";
}

// [DIUBAH] addBetToState sekarang punya parameter 'isEvent'
function addBetToState(playerId, ethAmount, usdtAmount, isEvent = false) {
  if (!players[playerId]) {
    players[playerId] = {
      id: playerId,
      eth: ethers.BigNumber.from(0),
      usdt: ethers.BigNumber.from(0),
      color: `hsl(${Math.floor(Math.random() * 360)}, 90%, 60%)`,
      data: { startAngle: 0, endAngle: 0 }
    };
  }
  
  const player = players[playerId];
  
  if (isEvent) {
      // Jika dari event, tambahkan
      player.eth = player.eth.add(ethAmount);
      player.usdt = player.usdt.add(usdtAmount);
  } else {
      // Jika dari fetch (awal), set/timpa
      player.eth = ethAmount;
      player.usdt = usdtAmount;
  }
  
  // Hitung ulang bobot
  const ethWeight = player.eth;
  const usdtFactor = ethers.BigNumber.from(10).pow(18 - usdtDecimals);
  const usdtWeight = player.usdt.mul(usdtFactor);
  player.weight = ethWeight.add(usdtWeight);
  
  // Hitung ulang totalWeight
  totalWeight = ethers.BigNumber.from(0);
  for (const pid in players) {
      totalWeight = totalWeight.add(players[pid].weight);
  }
}

// (Fungsi updateBetList & updateWheelVisuals tidak berubah)
function updateBetList() {
  betList.innerHTML = ""; 
  const playerIds = Object.keys(players);
  if (playerIds.length === 0) {
    betList.innerHTML = '<p id="bet-list-placeholder">No bets placed yet in this round.</p>';
    return;
  }
  playerIds.forEach(id => {
    const player = players[id];
    const ethAmount = parseFloat(ethers.utils.formatEther(player.eth)).toFixed(5);
    const usdtAmount = parseFloat(ethers.utils.formatUnits(player.usdt, usdtDecimals)).toFixed(2);
    const shortId = (id.toLowerCase() === userAddress.toLowerCase()) ? "You" : (id.slice(0, 6) + "..." + id.slice(-4));
    let betsHtml = "";
    if (player.eth.gt(0)) betsHtml += `${ethAmount} ETH`;
    if (player.eth.gt(0) && player.usdt.gt(0)) betsHtml += " + ";
    if (player.usdt.gt(0)) betsHtml += `${usdtAmount} USDT`;
    const item = document.createElement("div");
    item.className = "bet-list-item";
    item.innerHTML = `
      <div class="player-id" style="color: ${player.color}">${shortId}</div>
      <div class="player-bets">${betsHtml}</div>
    `;
    betList.appendChild(item);
  });
}
function updateWheelVisuals() {
  let currentAngle = 0;
  for (const playerId in players) {
    const player = players[playerId];
    let percentage = 0;
    if (totalWeight.gt(0)) {
      percentage = player.weight.mul(10000).div(totalWeight).toNumber() / 10000;
    }
    const angle = percentage * 360;
    const startAngle = currentAngle;
    const endAngle = currentAngle + angle;
    if (!player.sliceElement) {
        const newSliceFragment = sliceTemplate.content.cloneNode(true);
        player.sliceElement = newSliceFragment.querySelector("path");
        player.titleElement = newSliceFragment.querySelector("title");
        player.sliceElement.setAttribute("fill", player.color);
        slicesGroup.appendChild(newSliceFragment);
    }
    const shortId = (player.id.toLowerCase() === userAddress.toLowerCase()) ? "You" : player.id.slice(0,6);
    player.titleElement.textContent = `${shortId}: ${(percentage * 100).toFixed(2)}%`;
    gsap.to(player.data, {
        startAngle: startAngle,
        endAngle: endAngle,
        duration: 0.7,
        ease: "power2.out",
        onUpdate: () => {
            const d = describeArc(50, 50, 45, player.data.startAngle, player.data.endAngle);
            player.sliceElement.setAttribute("d", d);
        }
    });
    currentAngle = endAngle;
  }
}

// (Fungsi spinToWinner & helper SVG tidak berubah)
function spinToWinner(winnerId) {
    const winner = players[winnerId];
    if (!winner) {
        console.error("Pemenang tidak ditemukan! Mereset...");
        resetAndFetchNewRound();
        return;
    }
    const startAngle = winner.data.startAngle;
    const endAngle = winner.data.endAngle;
    const sliceWidth = endAngle - startAngle;
    const targetMiddleAngle = startAngle + sliceWidth / 2;
    const finalTargetAngle = targetMiddleAngle;
    let currentRotation = gsap.getProperty(wheelSVG, "rotation");
    let currentPosition = currentRotation % 360;
    const fullSpins = 5 * 360;
    let distanceToTarget = -finalTargetAngle - currentPosition;
    if (distanceToTarget > 0) distanceToTarget -= 360;
    const totalSpinAmount = fullSpins + Math.abs(distanceToTarget);
    gsap.to(wheelSVG, {
        duration: 6,
        rotation: `-=${totalSpinAmount}`,
        ease: "power3.out",
        onComplete: () => {
            const isWinner = (winnerId.toLowerCase() === userAddress.toLowerCase());
            const winnerName = isWinner ? "You" : winnerId.slice(0, 6) + "...";
            statusText.innerText = `Winner is ${winnerName}!`;
            alert(`Pemenangnya adalah ${winnerName}!`);
            resetAndFetchNewRound();
        }
    });
}
function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
    var angleInRadians = (angleInDegrees) * Math.PI / 180.0;
    return {
        x: centerX + (radius * Math.cos(angleInRadians)),
        y: centerY + (radius * Math.sin(angleInRadians))
    };
}
function describeArc(x, y, radius, startAngle, endAngle) {
    if (endAngle - startAngle >= 360) endAngle = startAngle + 359.99;
    if (endAngle <= startAngle + 0.01) endAngle = startAngle + 0.01;
    var start = polarToCartesian(x, y, radius, endAngle);
    var end = polarToCartesian(x, y, radius, startAngle);
    var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
    var d = ["M", x, y, "L", start.x, start.y, "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y, "Z"].join(" ");
    return d;
}

// === 4. Inisialisasi & Event Listeners ===
walletBtn.addEventListener("click", toggleWallet);
placeBetBtn.addEventListener("click", showBetModal);
finalizeBtn.addEventListener("click", callFinalizeRound); // [BARU]

modalCloseBtn.addEventListener("click", hideBetModal);
modalOverlay.addEventListener("click", hideBetModal);
confirmBetBtn.addEventListener("click", confirmBet);
percentButtons.forEach(button => {
  button.addEventListener("click", () => {
    const percent = parseFloat(button.dataset.percent);
    setAmountByPercent(percent);
  });
});
</script>
</body>
</html>
