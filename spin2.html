<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎰 FAYLOTTO Spin Bet Battle</title>
    <script src="https://unpkg.com/ethers@6/dist/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* [SAME CSS AS BEFORE - COPY DARI SEBELUMNYA] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #0f0f23 0%, #1a0033 50%, #2d1b69 100%); color: white; min-height: 100vh; overflow-x: hidden; }
        /* ... rest of CSS ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎰 FAYLOTTO</h1>
            <h2 style="font-size: 1.2rem; opacity: 0.8; text-align: center;">Spin Bet Battle</h2>
        </div>

        <div class="network-info" id="networkInfo"><span class="loading"></span>Memuat...</div>

        <div class="wheel-wrapper">
            <div class="wheel-pointer"></div>
            <div class="wheel" id="wheel"></div>
            <div class="center-circle">
                <div>SPIN</div>
                <div style="font-size: 12px;" id="spinPriceDisplay">Loading...</div>
            </div>
        </div>
        
        <div class="controls">
            <div style="font-size: 28px; font-weight: 700; margin-bottom: 20px; color: #4ecdc4;" id="balance">
                Connect Wallet
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 25px; margin: 10px 0; font-size: 20px; font-family: 'Orbitron';" id="priceInfo">
                💰 Loading price...
            </div>
            
            <button class="btn" id="connectBtn">🔗 Connect MetaMask</button>
            <button class="btn" id="spinBtn" disabled>🎰 SPIN (0 ETH)</button>
            
            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        // ✅ GANTI INI DENGAN ALAMAT KONTRAK BARU!
        const CONTRACT_ADDRESS = "0x179c8F2fef1b02A3E1C8Be8C4723De65Cf7e4183"; 
        
        const ABI = [{"inputs":[{"internalType":"address","name":"_lpointAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"BetLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"result","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"randomNumber","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"contractBalance","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalBets","type":"uint256"},{"indexed":false,"internalType":"string","name":"highestAvailablePrize","type":"string"},{"indexed":false,"internalType":"bool","name":"prizeAvailable","type":"bool"},{"indexed":false,"internalType":"uint256","name":"winChance","type":"uint256"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"BetUnliked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"prizeName","type":"string"}],"name":"ETHAwarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"freeSpinNumber","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"random","type":"uint256"}],"name":"FreeSpinPlayed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"LPointAwarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"rating","type":"uint8"}],"name":"RatingAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"oldRating","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"newRating","type":"uint8"}],"name":"RatingEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"inviter","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"}],"name":"ReferralAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"inviter","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"ReferralRewardEarned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"uid","type":"string"}],"name":"UIDGenerated","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[{"internalType":"string","name":"refereeUID","type":"string"}],"name":"addReferralByUID","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"claimedReferralRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dailyQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dailyUsedQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"depositLPoint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"freeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeSpinData","outputs":[{"internalType":"uint256","name":"freeSpinsUsed","type":"uint256"},{"internalType":"uint256","name":"lastActive","type":"uint256"},{"internalType":"uint256","name":"walletCreated","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"freeSpinQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"generateUID","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getPublicBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"result","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"randomNumber","type":"uint256"},{"internalType":"uint256","name":"contractBalance","type":"uint256"},{"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"internalType":"uint256","name":"totalBets","type":"uint256"},{"internalType":"string","name":"highestAvailablePrize","type":"string"},{"internalType":"bool","name":"prizeAvailable","type":"bool"},{"internalType":"uint256","name":"winChance","type":"uint256"}],"internalType":"struct FaylottoSpinBetBattle.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getUserBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"result","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"randomNumber","type":"uint256"},{"internalType":"uint256","name":"contractBalance","type":"uint256"},{"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"internalType":"uint256","name":"totalBets","type":"uint256"},{"internalType":"string","name":"highestAvailablePrize","type":"string"},{"internalType":"bool","name":"prizeAvailable","type":"bool"},{"internalType":"uint256","name":"winChance","type":"uint256"}],"internalType":"struct FaylottoSpinBetBattle.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"lastPrizeTimestamps","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastResetTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lpointToken","outputs":[{"internalType":"contract LPointToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minInactiveTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minWalletAge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"publicHistoryLimit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrals","outputs":[{"internalType":"address","name":"inviter","type":"address"},{"internalType":"uint256","name":"rewardEarned","type":"uint256"},{"internalType":"string","name":"uid","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"spinBetPaid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"spinPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBetsEver","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"uidToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawLPoint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

        let provider, signer, contract, account;
        let spinPriceWei;
        let isSpinning = false;

        async function initMetaMask() {
            const { ethereum } = window;
            if (!ethereum) return false;

            provider = new ethers.BrowserProvider(ethereum);
            try {
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== 84532) {
                    document.getElementById('networkInfo').innerHTML = '⚠️ Switch to Base Sepolia (84532)';
                    return false;
                }
                document.getElementById('networkInfo').innerHTML = '✅ Base Sepolia Ready';
            } catch (e) { return false; }
            return true;
        }

        async function connectWallet() {
            try {
                const accounts = await provider.send("eth_requestAccounts", []);
                account = accounts[0];
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                document.getElementById('connectBtn').innerHTML = `✅ ${account.slice(0,6)}...${account.slice(-4)}`;
                document.getElementById('connectBtn').disabled = true;
                
                await updateUI();
                showStatus('✅ Connected! Ready to spin!', 'success');
                renderWheel();
                
            } catch (error) {
                showStatus('❌ ' + error.message, 'error');
            }
        }

        async function updateUI() {
            if (!account || !contract) return;
            
            try {
                // Wallet balance
                const balance = await provider.getBalance(account);
                const ethBalance = parseFloat(ethers.formatEther(balance)).toFixed(4);
                document.getElementById('balance').innerHTML = `💰 ${ethBalance} ETH`;

                // ✅ EXACT SPIN PRICE
                spinPriceWei = await contract.spinPrice();
                const priceEth = parseFloat(ethers.formatEther(spinPriceWei)).toFixed(6);
                
                document.getElementById('priceInfo').innerHTML = `💰 Spin Cost: ${priceEth} ETH`;
                document.getElementById('spinBtn').innerHTML = `🎰 SPIN (${priceEth} ETH)`;
                
                // Can spin?
                const canSpin = balance >= spinPriceWei;
                document.getElementById('spinBtn').disabled = isSpinning || !canSpin;
                
                if (!canSpin) {
                    showStatus(`💸 Need ${priceEth} ETH minimum`, 'error');
                }
                
            } catch (error) {
                console.error('Update error:', error);
            }
        }

        async function spinWheel() {
            if (isSpinning || !spinPriceWei) return;
            
            try {
                isSpinning = true;
                document.getElementById('spinBtn').disabled = true;
                showStatus('🎰 Placing bet...', 'info');
                
                // ✅ EXACT AMOUNT + HIGH GAS
                const tx = await contract.placeBet({
                    value: spinPriceWei,
                    gasLimit: 800000n  // Extra gas untuk kompleks logic
                });
                
                showStatus(`⏳ Tx: ${tx.hash.slice(0,12)}...`, 'info');
                const receipt = await tx.wait();
                
                // Wheel spin animation
                const randomRotation = (Math.floor(Math.random() * 5) + 8) * 360;
                document.getElementById('wheel').style.transform = `rotate(${randomRotation}deg)`;
                
                showStatus('🎉 SPIN SUCCESS! Check wallet!', 'success');
                
                setTimeout(() => {
                    isSpinning = false;
                    updateUI();
                }, 4500);
                
            } catch (error) {
                console.error('Spin error:', error);
                showStatus(`❌ ${error.reason || error.message || 'Spin failed'}`, 'error');
                isSpinning = false;
                document.getElementById('spinBtn').disabled = false;
            }
        }

        function showStatus(msg, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = msg;
            statusEl.className = `status ${type}`;
        }

        function renderWheel() {
            const wheel = document.getElementById('wheel');
            wheel.innerHTML = '';
            const segments = ["1 ETH Jackpot","0.7 ETH Big Win","Won MacBook!","iPhone/Worth ETH","0.1 ETH Monthly","0.05 ETH Monthly","0.01 ETH Bi-weekly","0.005 ETH Weekly","0.001 ETH 5-day","0.0005 ETH 4-day","0.000256 ETH 2-day","0.0001 ETH Daily","0.00008 ETH Daily","0.00005 ETH Daily","Won 2 LPoint","Won 5 LPoint","Won 7 LPoint","Try Again","No Prize","No Prize"];
            const total = segments.length;
            const angle = 360 / total;
            for (let i = 0; i < total; i++) {
                const segment = document.createElement('div');
                segment.className = 'wheel-segment';
                segment.style.background = `hsl(${i * 18}, 70%, 50%)`;
                segment.style.transform = `rotate(${i * angle}deg)`;
                segment.innerHTML = `<div style="transform: skewY(${angle}deg) rotate(${angle/2}deg); width: 90%; font-size: 11px;">${segments[i]}</div>`;
                wheel.appendChild(segment);
            }
        }

        // EVENTS
        document.getElementById('connectBtn').onclick = connectWallet;
        document.getElementById('spinBtn').onclick = spinWheel;

        // INIT
        async function init() {
            const ready = await initMetaMask();
            if (ready) {
                setInterval(updateUI, 3000);
                renderWheel();
            }
        }

        window.addEventListener('load', init);
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => location.reload());
            window.ethereum.on('chainChanged', () => location.reload());
        }
    </script>
</body>
</html>
