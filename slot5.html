<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto - Ultimate Referral</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <style>
        /* --- CSS RESET & THEME --- */
        :root {
            --bg: #0f111a; --panel: #1e2130; --primary: #0052ff; 
            --gold: #FFD700; --green: #00d26a; --text: #fff; --border: #333;
            --eth: #627EEA; --usdt: #26A17B; --shib: #FFA409;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { max-width: 480px; width: 100%; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: var(--panel); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .logo { font-weight: 800; font-size: 1.2em; letter-spacing: 1px; }
        .btn-connect { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-connect.active { background: var(--panel); border: 1px solid var(--green); color: var(--green); cursor: default; }

        /* --- PLAYER PANEL (REGISTRATION & DASHBOARD) --- */
        .player-panel { 
            background: linear-gradient(145deg, #1a1d29, #151720); 
            border: 1px solid #444; border-radius: 12px; padding: 20px; margin-bottom: 25px; 
            text-align: center; position: relative; overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 82, 255, 0.1);
        }
        
        .panel-msg { color: #888; font-size: 0.9em; font-style: italic; }

        /* REGISTRATION FORM */
        .reg-title { color: var(--gold); margin: 0 0 10px 0; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; }
        .ref-badge { background: rgba(0, 210, 106, 0.15); color: var(--green); display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75em; margin-bottom: 10px; border: 1px solid var(--green); }
        .input-nick { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #555; background: #0b0d12; color: white; margin-bottom: 10px; text-align: center; font-weight: bold; outline: none; transition: 0.3s; }
        .input-nick:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,82,255,0.3); }
        .btn-reg { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        /* DASHBOARD */
        .dash-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px; }
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; text-align: left; }
        .dash-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .dash-lbl { font-size: 0.65em; color: #aaa; text-transform: uppercase; display: block; margin-bottom: 3px; }
        .dash-val { font-size: 1.1em; font-weight: bold; color: white; }
        
        .earnings-box { grid-column: span 2; background: #0b0d12; border: 1px dashed #444; }
        .earn-row { display: flex; justify-content: space-between; font-size: 0.85em; margin-top: 5px; font-weight: bold; }
        .btn-withdraw-all { width: 100%; margin-top: 8px; background: #333; color: white; border: none; padding: 6px; cursor: pointer; font-size: 0.75em; border-radius: 4px; transition:0.2s; }
        .btn-withdraw-all:hover { background: var(--green); color: black; }

        .ref-link-box { margin-top: 15px; background: #0b0d12; padding: 10px; border-radius: 6px; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; color: #888; }
        .btn-copy { background: transparent; color: var(--primary); border: none; font-weight: bold; cursor: pointer; }

        /* GAME */
        .slot-box { background: var(--panel); padding: 15px; border-radius: 15px; border: 2px solid #333; text-align: center; margin-bottom: 20px; }
        .reels { display: flex; gap: 5px; justify-content: center; margin-bottom: 15px; background: #000; padding: 10px; border-radius: 8px; }
        .reel-img { width: 60px; height: 60px; object-fit: contain; background: white; border-radius: 4px; }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .card { background: #151925; border: 2px solid #333; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; position: relative; }
        .card.selected { border-color: var(--primary); background: rgba(0, 82, 255, 0.1); box-shadow: 0 0 15px rgba(0, 82, 255, 0.3); }
        .card img { width: 40px; height: 40px; margin-bottom: 5px; }
        .card-count { position: absolute; top: 5px; right: 5px; background: #000; font-size: 0.6em; padding: 2px 5px; border-radius: 4px; color: #aaa; }

        .btn-action { width: 100%; padding: 14px; margin-top: 15px; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 1em; }
        .btn-bet { background: var(--gold); color: black; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .btn-draw { background: #333; color: #666; cursor: not-allowed; }
        .btn-draw.ready { background: #ff4b4b; color: white; cursor: pointer; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0px #ff4b4b; } 50% { box-shadow: 0 0 15px #ff4b4b; } }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--panel); width: 90%; max-width: 350px; padding: 25px; border-radius: 15px; border: 1px solid var(--primary); text-align: center; }
        .pay-btn { width: 100%; padding: 12px; margin-bottom: 8px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; display: flex; justify-content: space-between; }
        
        #toast { visibility: hidden; background: #333; color: #fff; padding: 12px 20px; border-radius: 5px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 200; border: 1px solid #555; font-size: 0.9em; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">Fay<span style="color:var(--primary)">lotto</span></div>
        <button id="btnConnect" class="btn-connect" onclick="connectWallet()">Connect Wallet</button>
    </div>

    <div class="player-panel" id="playerPanel">
        <div id="panelMsg" class="panel-msg">Connect wallet to view profile & referral...</div>

        <div id="regForm" style="display:none;">
            <h3 class="reg-title">Create Player Profile</h3>
            <div id="refBadge" class="ref-badge" style="display:none;"></div>
            <p style="font-size:0.8em; color:#aaa; margin-bottom:10px;">Register to unlock Betting & Referral System.</p>
            <input type="text" id="regNick" class="input-nick" placeholder="Enter Nickname (Min 3 chars)" maxlength="12">
            <button class="btn-reg" onclick="registerUser()">REGISTER NOW</button>
        </div>

        <div id="dashboard" style="display:none;">
            <div class="dash-header">
                <div style="font-size:1.1em; font-weight:bold; color:white;">Hi, <span id="dashNick" style="color:var(--primary)">Player</span></div>
                <div style="font-size:0.75em; color:#aaa;">Verified âœ…</div>
            </div>
            
            <div class="dash-grid">
                <div class="dash-item">
                    <span class="dash-lbl">Pending Bonus</span>
                    <span class="dash-val" id="dashBonus" style="color:var(--gold)">0</span>
                    <span style="font-size:0.6em; color:#666;">SHIB</span>
                </div>
                <div class="dash-item" onclick="claimBonus()" style="cursor:pointer; background:var(--primary); display:flex; align-items:center; justify-content:center; border:none;">
                     <span style="font-weight:bold; color:white; font-size:0.8em;">CLAIM BONUS âž”</span>
                </div>

                <div class="dash-item earnings-box">
                    <span class="dash-lbl" style="color:#fff;">ðŸ’° Wallet Credits (Wins + Refs)</span>
                    <div class="earn-row">
                        <span style="color:var(--eth)">ETH: <span id="creditETH">0.000</span></span>
                        <span style="color:var(--usdt)">USDT: <span id="creditUSDT">0.00</span></span>
                    </div>
                    <div class="earn-row">
                         <span style="color:var(--shib)">SHIB: <span id="creditSHIB">0.00</span></span>
                    </div>
                    <button class="btn-withdraw-all" onclick="withdrawAll()">WITHDRAW ALL CREDITS</button>
                </div>
            </div>

            <div class="ref-link-box">
                <span id="refLink" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-right:5px;">Loading link...</span>
                <button class="btn-copy" onclick="copyRef()">COPY</button>
            </div>
            <div style="margin-top:8px; font-size:0.7em; color:#666;">
                *Invite friends! If they bet, you get <b>10k SHIB</b> + <b>0.25%</b> of their wins.
            </div>
        </div>
    </div>

    <div class="slot-box">
        <div class="reels">
            <img id="r1" src="what.svg" class="reel-img">
            <img id="r2" src="what.svg" class="reel-img">
            <img id="r3" src="what.svg" class="reel-img">
        </div>
        <div id="drawStatus" style="font-size:0.85em; color:#888;">Waiting for bets...</div>
    </div>

    <div class="grid">
        <div class="card" onclick="selectAnimal(0)" id="card-0"><img src="tuna.svg"><div style="font-size:0.7em; font-weight:bold;">TUNA</div><span id="cnt-0" class="card-count">0</span></div>
        <div class="card" onclick="selectAnimal(1)" id="card-1"><img src="crab.svg"><div style="font-size:0.7em; font-weight:bold;">CRAB</div><span id="cnt-1" class="card-count">0</span></div>
        <div class="card" onclick="selectAnimal(2)" id="card-2"><img src="shark.svg"><div style="font-size:0.7em; font-weight:bold;">SHARK</div><span id="cnt-2" class="card-count">0</span></div>
        <div class="card" onclick="selectAnimal(3)" id="card-3"><img src="octo.svg"><div style="font-size:0.7em; font-weight:bold;">OCTO</div><span id="cnt-3" class="card-count">0</span></div>
        <div class="card" onclick="selectAnimal(4)" id="card-4"><img src="shrimp.svg"><div style="font-size:0.7em; font-weight:bold;">SHRIMP</div><span id="cnt-4" class="card-count">0</span></div>
        <div class="card" onclick="selectAnimal(5)" id="card-5"><img src="orcha.svg"><div style="font-size:0.7em; font-weight:bold;">ORCHA</div><span id="cnt-5" class="card-count">0</span></div>
    </div>

    <button class="btn-action btn-bet" onclick="openPayModal()">PLACE BET</button>
    <button id="btnDraw" class="btn-action btn-draw" onclick="executeDraw()" disabled>WAITING PLAYERS (0/5)</button>
</div>

<div id="payModal" class="modal">
    <div class="modal-box">
        <h3 style="margin-top:0">Select Currency</h3>
        <button class="pay-btn" style="background:var(--eth)" onclick="placeBet('ETH')"><span>ETH</span><span>0.0005</span></button>
        <button class="pay-btn" style="background:var(--usdt)" onclick="placeBet('USDT')"><span>USDT</span><span>10.00</span></button>
        <button class="pay-btn" style="background:var(--shib)" onclick="placeBet('SHIB')"><span>SHIB</span><span>110,000</span></button>
        
        <div style="border-top:1px dashed #555; margin-top:10px; padding-top:10px;">
             <div style="font-size:0.7em; color:#aaa; margin-bottom:5px;">Free Credit: <span id="freeBal" style="color:white;">0</span> SHIB</div>
             <button id="btnFree" class="pay-btn" style="background:#333; justify-content:center;" onclick="placeBet('FREE')" disabled>USE FREE CREDIT (10k)</button>
        </div>
        
        <button class="pay-btn" style="background:transparent; border:1px solid #555; color:#aaa; margin-top:10px; justify-content:center;" onclick="document.getElementById('payModal').style.display='none'">CANCEL</button>
    </div>
</div>

<div id="toast">Notification</div>

<script>
    // CONFIG
    const ADDR = "0x72a20552267B4313f74003E25593592B15b76ad6";
    const USDT = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2";
    const SHIB = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";
    const CHAIN_ID = "0x14a34"; 

    const ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_shibToken","type":"address"},{"internalType":"address","name":"_priceFeedETH","type":"address"},{"internalType":"address","name":"_priceFeedUSDT","type":"address"},{"internalType":"address","name":"_priceFeedSHIB","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"indexed":false,"internalType":"string","name":"outcome","type":"string"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"BattleResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BonusClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"oldCollector","type":"address"},{"indexed":false,"internalType":"address","name":"newCollector","type":"address"}],"name":"FeeCollectorUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint8","name":"animalChoice","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NewBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"RatingSubmitted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"reactionType","type":"uint8"}],"name":"ReactionUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"invitee","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralLinked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"UserRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"enum FaylottoUltimate.Currency","name":"curr","type":"uint8"},{"indexed":false,"internalType":"bool","name":"isRealTransfer","type":"bool"}],"name":"WinDistributed","type":"event"},{"inputs":[],"name":"COST_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_MAIN","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_PLATFORM_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TOTAL_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TEAMS_ACTIVE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BONUS_AMOUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"","type":"uint8"}],"name":"activeTeamCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"}],"name":"betETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"},{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"bool","name":"_isFreeBet","type":"bool"}],"name":"betToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralBonus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"commentCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"dislikeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint256","name":"_cId","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"name":"emergencyWithdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeDraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeShibCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getActiveTeamCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getBonusBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"}],"name":"getLatestPrice","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"}],"name":"getRoundResult","outputs":[{"components":[{"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"internalType":"struct FaylottoUltimate.RoundResultData","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"globalWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nicknameToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_referrerNick","type":"string"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"enum FaylottoUltimate.BetType","name":"bType","type":"uint8"},{"internalType":"uint8","name":"animalChoice","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundHistory","outputs":[{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_eth","type":"address"},{"internalType":"address","name":"_usdt","type":"address"},{"internalType":"address","name":"_shib","type":"address"}],"name":"setPriceFeeds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_reaction","type":"uint8"}],"name":"setReaction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"shibToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_stars","type":"uint8"}],"name":"submitRating","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"enum FaylottoUltimate.Currency","name":"","type":"uint8"}],"name":"userCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRatings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userReactions","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"hasBet","type":"bool"},{"internalType":"uint256","name":"pendingRefBonusCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawCredit","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        
    const ERC20 = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
        
    const IMAGES = ["tuna.svg", "crab.svg", "shark.svg", "octo.svg", "shrimp.svg", "orcha.svg", "zonk.svg"];
    let provider, signer, contract, userAddr;
    let selectedIdx = -1;
    let detectedReferrer = "";
    let spinInterval;

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        detectedReferrer = params.get('ref') || "";
        
        provider = new ethers.JsonRpcProvider("https://sepolia.base.org");
        contract = new ethers.Contract(ADDR, ABI, provider);
        
        checkSession();
        refreshData();
        setInterval(refreshData, 5000);
    }

    async function checkSession() {
        const sess = localStorage.getItem('fay_auth');
        if(sess) {
            const data = JSON.parse(sess);
            if(data.expiry > Date.now()) connectWallet(true);
        }
    }

    async function connectWallet(silent = false) {
        if(!window.ethereum) return showToast("No Wallet Found");
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            const acc = await provider.send("eth_requestAccounts", []);
            userAddr = acc[0];
            try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_ID }] }); } catch{}

            signer = await provider.getSigner();
            contract = new ethers.Contract(ADDR, ABI, signer);

            if(!silent) {
                const msg = `Login Faylotto: ${userAddr} @ ${Date.now()}`;
                await signer.signMessage(msg);
                localStorage.setItem('fay_auth', JSON.stringify({ expiry: Date.now() + 2592000000 }));
            }

            document.getElementById('btnConnect').innerText = "Connected";
            document.getElementById('btnConnect').classList.add('active');
            checkUserStatus();

        } catch(e) { console.error(e); }
    }

    // --- PANEL & DASHBOARD LOGIC ---
    async function checkUserStatus() {
        try {
            const [u, freeBal, cEth, cUsdt, cShib] = await Promise.all([
                contract.users(userAddr),
                contract.freeShibCredits(userAddr),
                contract.userCredits(userAddr, 0),
                contract.userCredits(userAddr, 1),
                contract.userCredits(userAddr, 2)
            ]);

            document.getElementById('panelMsg').style.display = 'none';

            // Update Free Balance di Modal Bet
            document.getElementById('freeBal').innerText = parseFloat(ethers.formatEther(freeBal)).toLocaleString();
            const btnFree = document.getElementById('btnFree');
            if(freeBal >= ethers.parseEther("10000")) { btnFree.disabled=false; btnFree.style.background="var(--green)"; btnFree.style.color="black"; }

            if(u.isRegistered) {
                document.getElementById('regForm').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                document.getElementById('dashNick').innerText = u.nickname;
                const bonus = Number(u.pendingRefBonusCount) * 10000;
                document.getElementById('dashBonus').innerText = bonus.toLocaleString();
                
                // Update Earnings
                document.getElementById('creditETH').innerText = parseFloat(ethers.formatEther(cEth)).toFixed(4);
                document.getElementById('creditUSDT').innerText = parseFloat(ethers.formatUnits(cUsdt, 6)).toFixed(2);
                document.getElementById('creditSHIB').innerText = parseFloat(ethers.formatEther(cShib)).toFixed(2);

                const link = `${window.location.origin}${window.location.pathname}?ref=${u.nickname}`;
                document.getElementById('refLink').innerText = link;
            } else {
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('regForm').style.display = 'block';
                if(detectedReferrer) {
                    const badge = document.getElementById('refBadge');
                    badge.style.display = 'inline-block';
                    badge.innerHTML = `Invited by: <b>${detectedReferrer}</b>`;
                }
            }
        } catch(e) { console.error(e); }
    }

    // --- TRANSACTIONS ---
    async function registerUser() {
        const nick = document.getElementById('regNick').value;
        if(nick.length < 3) return showToast("Min 3 chars");
        try {
            showToast("Registering...");
            const tx = await contract.register(nick, detectedReferrer);
            await tx.wait();
            showToast("Success! Welcome!");
            checkUserStatus();
        } catch(e) { showToast("Register Failed"); }
    }

    async function claimBonus() {
        try {
            showToast("Claiming Bonus...");
            const tx = await contract.claimReferralBonus();
            await tx.wait();
            showToast("Bonus Claimed!");
            checkUserStatus();
        } catch(e) { showToast("Nothing to claim"); }
    }

    async function withdrawAll() {
        try {
            // Cek saldo satu per satu simple loop
            showToast("Processing Withdrawal...");
            const credits = [
                await contract.userCredits(userAddr, 0),
                await contract.userCredits(userAddr, 1),
                await contract.userCredits(userAddr, 2)
            ];
            
            let withdrawn = false;
            if(credits[0] > 0n) { await (await contract.withdrawCredit(0, credits[0])).wait(); withdrawn=true; }
            if(credits[1] > 0n) { await (await contract.withdrawCredit(1, credits[1])).wait(); withdrawn=true; }
            if(credits[2] > 0n) { await (await contract.withdrawCredit(2, credits[2])).wait(); withdrawn=true; }

            if(withdrawn) showToast("All Credits Withdrawn!");
            else showToast("Balance Empty");
            checkUserStatus();
        } catch(e) { showToast("Withdraw Error"); }
    }

    async function refreshData() {
        let active = 0;
        for(let i=0; i<6; i++) {
            try {
                const c = await contract.activeTeamCounts(i);
                document.getElementById(`cnt-${i}`).innerText = c;
                if(Number(c)>0) active++;
            } catch(e){}
        }
        const btn = document.getElementById('btnDraw');
        if(active >= 5) {
            btn.disabled = false; btn.classList.add('ready'); btn.innerText = "EXECUTE DRAW!";
            document.getElementById('drawStatus').innerText = "Ready to Spin!";
        } else {
            btn.disabled = true; btn.classList.remove('ready'); btn.innerText = `WAITING PLAYERS (${active}/5)`;
            document.getElementById('drawStatus').innerText = `Need ${5-active} more active teams`;
        }
    }

    // --- GAME ---
    function selectAnimal(i) { selectedIdx = i; document.querySelectorAll('.card').forEach(c=>c.classList.remove('selected')); document.getElementById(`card-${i}`).classList.add('selected'); }
    function openPayModal() { 
        if(!userAddr) return showToast("Connect Wallet First");
        if(selectedIdx === -1) return showToast("Select Team First");
        document.getElementById('payModal').style.display = 'flex';
    }
    
    async function placeBet(curr) {
        document.getElementById('payModal').style.display = 'none';
        try {
            let tx;
            if(curr==='ETH') tx = await contract.betETH(selectedIdx, {value: ethers.parseEther("0.0005")});
            else if(curr==='FREE') tx = await contract.betToken(selectedIdx, 2, true);
            else {
                const tokenAddr = curr==='USDT'?USDT:SHIB;
                const amt = curr==='USDT'?ethers.parseUnits("10",6):ethers.parseUnits("110000",18);
                const token = new ethers.Contract(tokenAddr, ERC20, signer);
                if((await token.allowance(userAddr, ADDR)) < amt) {
                    showToast("Approving..."); await (await token.approve(ADDR, ethers.MaxUint256)).wait();
                }
                tx = await contract.betToken(selectedIdx, curr==='USDT'?1:2, false);
            }
            showToast("Betting..."); await tx.wait(); showToast("Bet Placed!"); refreshData(); checkUserStatus();
        } catch(e) { showToast("Bet Failed"); }
    }

    async function executeDraw() {
        try {
            const tx = await contract.executeDraw();
            startSpin();
            showToast("Spinning..."); await tx.wait(); showToast("Draw Confirmed!");
            const rId = await contract.currentRoundId();
            waitForResult(Number(rId)-1);
        } catch(e) { clearInterval(spinInterval); showToast("Draw Error"); }
    }

    function startSpin() {
        const reels = [document.getElementById('r1'), document.getElementById('r2'), document.getElementById('r3')];
        spinInterval = setInterval(()=> { reels.forEach(r=> r.src = IMAGES[Math.floor(Math.random()*7)]) }, 100);
    }
    
    async function waitForResult(rid) {
        const iv = setInterval(async()=>{
            try {
                const res = await contract.getRoundResult(rid);
                if(res.outcome !== "") {
                    clearInterval(iv); clearInterval(spinInterval);
                    document.getElementById('r1').src = IMAGES[Number(res.reels[0])];
                    document.getElementById('r2').src = IMAGES[Number(res.reels[1])];
                    document.getElementById('r3').src = IMAGES[Number(res.reels[2])];
                    showToast("Result: " + res.outcome);
                    refreshData(); checkUserStatus(); // Update earnings
                }
            } catch(e){}
        }, 3000);
    }

    function copyRef() { navigator.clipboard.writeText(document.getElementById('refLink').innerText); showToast("Link Copied!"); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.className="show"; setTimeout(()=>t.className="", 3000); }
</script>
</body>
</html>
