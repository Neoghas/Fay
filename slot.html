<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Faylotto Ultimate ‚Äî Premium UI</title>

<!-- Ethers.js v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-1: #071021;
    --bg-2: #04112a;
    --card: rgba(255,255,255,0.03);
    --muted: #9aa4b2;
    --accent: #20e3b2;
    --accent-2: #3dd5ff;
    --neon: #6ee7b7;
    --glass: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6f4f1}
  body{margin:0;background:radial-gradient(1200px 600px at 10% 10%, rgba(32,227,178,0.06), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2));min-height:100vh;padding:20px}
  .wrap{max-width:1100px;margin:0 auto}

  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo {width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#042018}
  h1{font-size:18px;margin:0}
  .wallet{
    display:flex;gap:10px;align-items:center;
  }
  .btn{
    border:0;padding:10px 14px;border-radius:10px;background:transparent;color:var(--neon);cursor:pointer;font-weight:600;outline:none;
  }
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021612;border:none;padding:10px 16px;border-radius:12px;box-shadow:0 6px 20px rgba(32,227,178,0.12)}
  .small{font-size:12px;color:var(--muted)}

  /* Main panel */
  .grid-main{display:grid;grid-template-columns: 1fr 420px;gap:18px}
  @media(max-width:980px){.grid-main{grid-template-columns:1fr;}}
  .panel{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}

  /* Slot area */
  .slot-area{text-align:center;padding:12px}
  .reels{display:flex;gap:14px;justify-content:center;margin-bottom:12px}
  .reel{
    width:112px;height:112px;border-radius:12px;background:#ffffff;display:flex;align-items:center;justify-content:center;font-size:42px;color:#f3bc2f;
    box-shadow: inset 0 -6px 18px rgba(0,0,0,0.25), 0 12px 30px rgba(3,8,18,0.6);
    transform: translateY(0); transition: transform 450ms cubic-bezier(.2,.9,.2,1);
  }

  /* reel spin animation (CSS fallback for visual) */
  .reel.spin { animation: reelSpin 900ms cubic-bezier(.24,.9,.1,1); }
  @keyframes reelSpin {
    0% { transform: translateY(-18px) rotateX(0deg); filter: blur(0.6px); }
    40% { transform: translateY(6px) rotateX(12deg); filter: blur(1.2px); }
    70% { transform: translateY(-4px) rotateX(4deg); filter: blur(0.4px); }
    100% { transform: translateY(0) rotateX(0deg); filter: blur(0); }
  }

  .draw-btn{margin-top:6px;width:70%;padding:14px;border-radius:24px;background:linear-gradient(90deg,#334155 0%, #1f2937 100%);color:#cbd5e1;border:none;font-weight:700;letter-spacing:1px;box-shadow: inset 0 -2px 12px rgba(255,255,255,0.02)}
  .draw-btn.enabled{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021612}

  .status-line{margin-top:10px;font-size:13px;color:var(--muted)}

  /* Animal cards */
  .animals{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:18px}
  @media(max-width:700px){.animals{grid-template-columns:repeat(2,1fr)}}
  .animal{
    padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:2px solid rgba(255,255,255,0.03);cursor:pointer;transition:all 200ms;
    display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;min-height:120px;position:relative;
  }
  .animal .icon{font-size:38px}
  .animal .name{font-weight:700}
  .animal .meta{font-size:12px;color:var(--muted)}
  .animal.selected{box-shadow:0 8px 30px rgba(32,227,178,0.08);border:2px solid rgba(32,227,178,0.18);transform:translateY(-6px)}
  .animal:hover{transform:translateY(-4px);box-shadow:0 6px 22px rgba(0,0,0,0.5)}

  /* Pools */
  .pools{display:flex;gap:10px;margin-top:12px}
  .pool{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));text-align:center}
  .pool .value{font-size:20px;font-weight:700;color:var(--accent)}

  /* Controls */
  .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .select {padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;min-width:120px}
  .small-muted{font-size:12px;color:var(--muted);margin-top:6px}

  /* footer small grid right */
  .side-panel{display:flex;flex-direction:column;gap:12px}
  .card-mini{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01))}
  .history{max-height:260px;overflow:auto;padding-right:6px;font-size:13px;color:var(--muted)}

  /* fancy glow header */
  .neon-title{background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800}

  /* footer */
  footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">FY</div>
        <div>
          <h1 class="neon-title">Faylotto <span style="color:#cfeee1">Ultimate</span></h1>
          <div class="small">Premium Visual ‚Äî Animations & Web3</div>
        </div>
      </div>

      <div class="wallet">
        <div id="network" class="small">Chain: -</div>
        <button id="connectBtn" class="btn">Connect Wallet</button>
        <div id="addr" class="small" style="min-width:140px;text-align:right">Not connected</div>
      </div>
    </header>

    <main class="grid-main">
      <!-- Left: Slot + options -->
      <section class="panel">
        <div class="slot-area">
          <div class="reels" aria-hidden="true">
            <div id="reel0" class="reel">‚ùì</div>
            <div id="reel1" class="reel">‚ùì</div>
            <div id="reel2" class="reel">‚ùì</div>
          </div>

          <button id="drawBtn" class="draw-btn" title="Execute Draw (anyone can call)">DRAW NOW!</button>
          <div class="status-line" id="statusLine">Waiting for players...</div>

          <div class="controls" style="justify-content:center;margin-top:14px">
            <select id="currency" class="select">
              <option value="ETH">ETH</option>
              <option value="USDT">USDT</option>
              <option value="SHIB">SHIB</option>
            </select>
            <select id="freeBet" class="select">
              <option value="false">Main Bet</option>
              <option value="true">Free SHIB (if available)</option>
            </select>
            <button id="approveBtn" class="btn">Approve Token</button>
            <button id="betBtn" class="btn-primary">Place Bet</button>
          </div>

          <div class="pools" id="pools">
            <div class="pool">
              <div class="small">ETH</div>
              <div class="value" id="poolETH">0.000</div>
            </div>
            <div class="pool">
              <div class="small">USDT</div>
              <div class="value" id="poolUSDT">0</div>
            </div>
            <div class="pool">
              <div class="small">SHIB</div>
              <div class="value" id="poolSHIB">0</div>
            </div>
          </div>
        </div>

        <!-- Animals selection -->
        <div class="animals" id="animalGrid" style="margin-top:18px">
          <!-- cards populated by JS -->
        </div>
      </section>

      <!-- Right: side info -->
      <aside class="side-panel">
        <div class="card-mini">
          <div class="small">Round</div>
          <div style="font-weight:800;font-size:20px" id="currentRound">-</div>
          <div class="small-muted">Active Teams: <span id="activeTeams">0</span></div>
        </div>

        <div class="card-mini">
          <div class="small">User Credits</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1;text-align:center">
              <div class="small">ETH</div>
              <div id="creditETH" style="font-weight:700">0</div>
            </div>
            <div style="flex:1;text-align:center">
              <div class="small">USDT</div>
              <div id="creditUSDT" style="font-weight:700">0</div>
            </div>
            <div style="flex:1;text-align:center">
              <div class="small">SHIB</div>
              <div id="creditSHIB" style="font-weight:700">0</div>
            </div>
          </div>

          <div style="margin-top:10px" class="small">Free SHIB:</div>
          <div id="freeSHIB" style="font-weight:700">0</div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="claimBtn" class="btn">Claim Bonus</button>
            <button id="withdrawBtn" class="btn">Withdraw Credit</button>
          </div>
        </div>

        <div class="card-mini">
          <div class="small">Recent Rounds</div>
          <div class="history" id="history"></div>
        </div>
      </aside>
    </main>

    <footer>Made for Faylotto ‚Äî Premium UI. Replace contract placeholders in script.</footer>
  </div>

<script>
(async () => {
  // ----------------- CONFIG: GANTI INI -----------------
  const CONTRACT_ADDRESS = "0xCONTRACT_ADDRESS_REPLACE_ME";
  const USDT_ADDRESS = "0xUSDT_ADDRESS_REPLACE_ME";
  const SHIB_ADDRESS = "0xSHIB_ADDRESS_REPLACE_ME";

  // Minimal ABI adapted for this UI. Jika signature berbeda, sesuaikan.
  const CONTRACT_ABI = [
    "function currentRoundId() view returns (uint256)",
    "function getRoundResult(uint256) view returns (tuple(uint8[3] reels,string outcome,uint256 timestamp,address winner))",
    "function getActiveTeamCount() view returns (uint256)",
    "function userCredits(address,uint8) view returns (uint256)",
    "function freeShibCredits(address) view returns (uint256)",
    "function betETH(uint8) payable external",
    "function betToken(uint8,uint8,bool) external",
    "function executeDraw() external",
    "function claimReferralBonus() external",
    "function withdrawCredit(uint8,uint256) external",
    "event BattleResult(uint8[3] reels, string outcome, uint256 roundId)"
  ];
  // ----------------------------------------------------

  // Mapping animal icons + names (0..5)
  const ANIMALS = [
    { id:0, name:"TUNA", icon:"üêü" },
    { id:1, name:"CRAB", icon:"ü¶Ä" },
    { id:2, name:"SHARK", icon:"ü¶à" },
    { id:3, name:"OCTOPUS", icon:"üêô" },
    { id:4, name:"SHRIMP", icon:"üç§" },
    { id:5, name:"ORCHA", icon:"üê¨" }
  ];

  // Ethers provider/signer/contract
  let provider, signer, contract, userAddr;
  // UI elements
  const connectBtn = document.getElementById("connectBtn");
  const addrEl = document.getElementById("addr");
  const networkEl = document.getElementById("network");
  const currentRoundEl = document.getElementById("currentRound");
  const activeTeamsEl = document.getElementById("activeTeams");
  const poolETH = document.getElementById("poolETH");
  const poolUSDT = document.getElementById("poolUSDT");
  const poolSHIB = document.getElementById("poolSHIB");
  const claimBtn = document.getElementById("claimBtn");
  const withdrawBtn = document.getElementById("withdrawBtn");
  const creditETH = document.getElementById("creditETH");
  const creditUSDT = document.getElementById("creditUSDT");
  const creditSHIB = document.getElementById("creditSHIB");
  const freeSHIB = document.getElementById("freeSHIB");
  const statusLine = document.getElementById("statusLine");
  const reelEls = [document.getElementById("reel0"), document.getElementById("reel1"), document.getElementById("reel2")];
  const drawBtn = document.getElementById("drawBtn");
  const animalGrid = document.getElementById("animalGrid");
  const betBtn = document.getElementById("betBtn");
  const approveBtn = document.getElementById("approveBtn");
  const currencySelect = document.getElementById("currency");
  const freeBetSelect = document.getElementById("freeBet");
  const historyEl = document.getElementById("history");

  // Selected animal
  let selectedAnimal = 0;
  // Build animal cards
  function renderAnimals(){
    animalGrid.innerHTML = "";
    for(const a of ANIMALS){
      const div = document.createElement("div");
      div.className = "animal"+(a.id===selectedAnimal?" selected":"");
      div.dataset.id = a.id;
      div.innerHTML = `<div class="icon">${a.icon}</div><div class="name">${a.name}</div><div class="meta">Pick ${a.id}</div>`;
      div.onclick = () => {
        selectedAnimal = a.id;
        document.querySelectorAll(".animal").forEach(x=>x.classList.remove("selected"));
        div.classList.add("selected");
      };
      animalGrid.appendChild(div);
    }
  }
  renderAnimals();

  // Helper small UI
  function setStatus(msg, transient=true){
    statusLine.innerText = msg;
    if(transient) setTimeout(()=>{ if(statusLine.innerText === msg) statusLine.innerText = ""; }, 6000);
  }

  // Connect wallet
  async function connect(){
    if(!window.ethereum) { alert("Install MetaMask or other Web3 wallet."); return; }
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddr = await signer.getAddress();
    addrEl.innerText = `${userAddr.slice(0,6)}...${userAddr.slice(-4)}`;
    const net = await provider.getNetwork();
    networkEl.innerText = `Chain: ${net.name || net.chainId}`;
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    subscribeEvents();
    pollAll();
    connectBtn.innerText = "Connected";
  }
  connectBtn.addEventListener("click", connect);

  // Subscribe to on-chain BattleResult event for live update
  function subscribeEvents(){
    if(!contract) return;
    contract.on("BattleResult", (reels, outcome, roundId, ev) => {
      console.log("BattleResult", reels, outcome, roundId.toString());
      // reels might be array-like; convert to numbers
      const r = Array.from(reels).map(x => Number(x));
      playReelAnimationThenShowResult(r, outcome, Number(roundId));
      // refresh UI & history
      setTimeout(()=> pollAll(), 1200);
    });
  }

  // Reel spin animation then show actual result
  function playReelAnimationThenShowResult(reels, outcome, roundId){
    // Quick spin visual: add class then replace innerText
    reelEls.forEach((el, idx) => {
      el.classList.add("spin");
      el.innerText = "üé∞";
    });
    // after animation, show actual icons (map animal id -> emoji)
    setTimeout(()=>{
      reelEls.forEach((el, idx) => {
        const id = reels[idx];
        const animal = ANIMALS.find(a=>a.id === id);
        el.innerText = animal ? animal.icon : "‚ùì";
        el.classList.remove("spin");
      });
      setStatus(`Round #${roundId} ‚Äî ${outcome}`);
    }, 900);
  }

  // Polling: get round, active teams, credits, pools (estimated)
  async function pollAll(){
    try {
      if(!contract) return;
      const roundBN = await contract.currentRoundId();
      const round = roundBN.toNumber();
      currentRoundEl.innerText = round;

      // Active teams
      const activeCount = await contract.getActiveTeamCount();
      activeTeamsEl.innerText = String(activeCount);

      // Credits
      const ethCredit = await contract.userCredits(userAddr, 0);
      const usdtCredit = await contract.userCredits(userAddr, 1);
      const shibCredit = await contract.userCredits(userAddr, 2);
      const freeShib = await contract.freeShibCredits(userAddr);
      creditETH.innerText = ethCredit.toString();
      creditUSDT.innerText = usdtCredit.toString();
      creditSHIB.innerText = shibCredit.toString();
      freeSHIB.innerText = freeShib.toString();

      // Try to show last 6 rounds
      const latest = Math.max(round - 1, 1);
      let out = "";
      for(let r = latest; r >= Math.max(1, latest - 5); r--){
        try {
          const res = await contract.getRoundResult(r);
          const reels = Array.from(res.reels).map(x=>Number(x));
          const icons = reels.map(id => (ANIMALS.find(a=>a.id===id)||{icon:"?"}).icon).join(" ");
          const when = new Date(Number(res.timestamp)*1000).toLocaleString();
          out += `#${r} ${res.outcome} ‚Äî ${icons} ‚Äî winner: ${res.winner} ‚Äî ${when}\n`;
        } catch(e){
          // ignore
        }
      }
      historyEl.innerText = out || "-";
      // Pools: we can't read internal "pool" variables easily without contract getters
      // Placeholders / estimations can be computed on-chain; here we display simple counts
      // For now show zeros (UI friendly)
      poolETH.innerText = "0.000";
      poolUSDT.innerText = "0";
      poolSHIB.innerText = "0";
    } catch(err){
      console.error("pollAll err", err);
    }
  }

  // Place bet logic
  betBtn.addEventListener("click", async () => {
    try {
      if(!contract) return setStatus("Connect first", true);
      const animal = selectedAnimal;
      const currency = currencySelect.value;
      const isFree = (freeBetSelect.value === "true");
      setStatus("Sending bet...");
      if(currency === "ETH"){
        // COST_ETH = 0.0005 ether
        const cost = ethers.utils.parseEther("0.0005");
        const tx = await contract.betETH(animal, { value: cost });
        await tx.wait();
        setStatus("Bet (ETH) placed ‚úÖ");
      } else if(currency === "USDT"){
        if(isFree) return setStatus("USDT does not support free bet", true);
        // enum Currency.USDT = 1
        const tx = await contract.betToken(animal, 1, false);
        await tx.wait();
        setStatus("Bet (USDT) placed ‚úÖ");
      } else {
        // SHIB
        const tx = await contract.betToken(animal, 2, isFree);
        await tx.wait();
        setStatus(isFree ? "Free SHIB bet placed ‚úÖ" : "Bet (SHIB) placed ‚úÖ");
      }
      setTimeout(()=> pollAll(), 900);
    } catch(err){
      console.error(err);
      setStatus("Bet failed: " + (err?.message || err), true);
    }
  });

  // Approve token (USDT/SHIB)
  approveBtn.addEventListener("click", async () => {
    try {
      if(!provider) return setStatus("Connect wallet first", true);
      const currency = currencySelect.value;
      if(currency === "ETH") return setStatus("ETH needs no approval", true);
      const tokenAddr = (currency === "USDT") ? USDT_ADDRESS : SHIB_ADDRESS;
      const tokenAbi = ["function approve(address spender, uint256 amount) public returns (bool)"];
      const tok = new ethers.Contract(tokenAddr, tokenAbi, signer);
      const tx = await tok.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
      setStatus("Approve tx pending...");
      await tx.wait();
      setStatus("Token approved ‚úÖ");
    } catch(e){
      console.error(e);
      setStatus("Approve failed: " + (e?.message||e), true);
    }
  });

  // Execute draw
  drawBtn.addEventListener("click", async () => {
    try {
      if(!contract) return setStatus("Connect first", true);
      setStatus("Calling executeDraw...");
      const tx = await contract.executeDraw();
      await tx.wait();
      setStatus("Draw executed ‚úÖ");
      setTimeout(()=> pollAll(), 1100);
    } catch(e){
      console.error(e);
      setStatus("Execute failed: " + (e?.message || e), true);
    }
  });

  // Claim bonus
  claimBtn.addEventListener("click", async () => {
    try {
      if(!contract) return setStatus("Connect first", true);
      setStatus("Claiming...");
      const tx = await contract.claimReferralBonus();
      await tx.wait();
      setStatus("Claim success ‚úÖ");
      pollAll();
    } catch(e){
      console.error(e);
      setStatus("Claim failed: " + (e?.message || e), true);
    }
  });

  // Withdraw credit (opens prompt for demo)
  withdrawBtn.addEventListener("click", async () => {
    try {
      if(!contract) return setStatus("Connect first", true);
      const curr = prompt("Currency (ETH/USDT/SHIB)");
      if(!curr) return;
      const raw = prompt("Amount (raw unit - wei for ETH or token decimals)");
      if(!raw) return;
      const map = { "ETH":0, "USDT":1, "SHIB":2 };
      if(!(curr in map)) return alert("Invalid currency");
      setStatus("Withdrawing...");
      const tx = await contract.withdrawCredit(map[curr], ethers.BigNumber.from(raw));
      await tx.wait();
      setStatus("Withdraw success ‚úÖ");
      pollAll();
    } catch(e){
      console.error(e);
      setStatus("Withdraw failed: " + (e?.message||e), true);
    }
  });

  // Auto poll every 12s if connected
  setInterval(()=> { if(contract && signer) pollAll(); }, 12000);

  // Detect account/network change
  if(window.ethereum){
    window.ethereum.on("accountsChanged", (accounts) => {
      if(accounts.length === 0){ addrEl.innerText = "Not connected"; }
      else { connect(); }
    });
    window.ethereum.on("chainChanged", (id) => { networkEl.innerText = "Chain changed"; setTimeout(()=>connect(), 600); });
  }

  // Friendly tip: if user navigates away, remove event listeners (not strictly necessary)
  window.addEventListener("beforeunload", () => { if(contract) contract.removeAllListeners("BattleResult"); });

  // initial small UI prompt
  setStatus("UI ready ‚Äî connect wallet to begin", false);

})();
</script>
</body>
</html>
