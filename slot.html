<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto Ultimate - Base Sepolia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #0052ff; /* Base Color */
            --accent: #00ff9d;
            --bg: #0a0b1e;
            --card: #14162d;
            --text: #ffffff;
            --danger: #ff4d4d;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        /* Layout Utilities */
        .container { max-width: 1200px; margin: 0 auto; }
        .grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        .row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .col { flex: 1; }

        /* Typography & Elements */
        h1, h2, h3 { margin-top: 0; color: var(--accent); }
        button {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; width: 100%;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #555; cursor: not-allowed; }
        button.secondary { background: #333; border: 1px solid #555; }
        button.danger { background: var(--danger); }
        
        input, select, textarea {
            width: 100%; padding: 10px; background: #000; border: 1px solid #444;
            color: white; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px;
        }

        /* Specific Modules */
        #wallet-status { font-size: 0.9em; color: #aaa; margin-bottom: 20px; text-align: right; }
        .animal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .animal-btn { 
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px solid #333; background: #1a1a1a;
        }
        .animal-btn.selected { border-color: var(--accent); background: rgba(0, 255, 157, 0.1); }
        
        .reels-display { 
            display: flex; justify-content: center; gap: 15px; font-size: 2em; 
            background: #000; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--accent);
        }
        .reel { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: #222; border-radius: 5px; }

        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { background: transparent; border-bottom: 2px solid transparent; border-radius: 0; }
        .tab-btn.active { border-color: var(--accent); color: var(--accent); }

        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 1; bottom: 30px; right: 30px;
        }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<div class="container">
    <div class="row">
        <h1 class="col">ü¶Å Faylotto Ultimate</h1>
        <div id="wallet-status">Belum terkoneksi</div>
    </div>
    
    <button id="connectBtn" onclick="connectWallet()">üîå Connect Wallet (Base Sepolia)</button>

    <div id="registerSection" class="card hidden" style="margin-top: 20px; border-color: var(--danger);">
        <h2>‚ö†Ô∏è Registrasi Diperlukan</h2>
        <input type="text" id="regNickname" placeholder="Buat Nickname (Min 3 huruf)">
        <input type="text" id="regReferrer" placeholder="Nickname Referrer (Opsional)">
        <button onclick="registerUser()">Daftar Sekarang</button>
    </div>

    <div id="dashboard" class="hidden">
        
        <div class="grid" style="margin-top: 20px;">
            <div class="card">
                <h3>üë§ Profil Saya</h3>
                <p><strong>Nick:</strong> <span id="dispNick">-</span></p>
                <p><strong>Bonus Ref (SHIB):</strong> <span id="dispBonus">0</span></p>
                <p><strong>Pending Ref Count:</strong> <span id="dispPendingRef">0</span></p>
                <button onclick="claimBonus()" class="secondary">Klaim Bonus Referral</button>
            </div>
            <div class="card">
                <h3>üí∞ Saldo Kontrak (Winnings)</h3>
                <div class="row">
                    <span>ETH:</span> <span id="creditETH">0</span>
                    <button class="secondary" style="width:auto; padding: 5px 10px;" onclick="withdraw('ETH')">WD</button>
                </div>
                <div class="row">
                    <span>USDT:</span> <span id="creditUSDT">0</span>
                    <button class="secondary" style="width:auto; padding: 5px 10px;" onclick="withdraw('USDT')">WD</button>
                </div>
                <div class="row">
                    <span>SHIB:</span> <span id="creditSHIB">0</span>
                    <button class="secondary" style="width:auto; padding: 5px 10px;" onclick="withdraw('SHIB')">WD</button>
                </div>
            </div>
        </div>

        <div class="grid" style="margin-top: 20px;">
            <div class="card">
                <h3>üé≤ Pasang Taruhan</h3>
                
                <label>Pilih Mata Uang:</label>
                <select id="betCurrency">
                    <option value="0">ETH (0.0005 ETH)</option>
                    <option value="1">USDT (10 USDT)</option>
                    <option value="2">SHIB (110,000 SHIB)</option>
                </select>

                <label style="display:flex; align-items:center; gap:10px; margin: 10px 0;">
                    <input type="checkbox" id="isFreeBet" style="width:auto;"> Gunakan Free Credit (Khusus SHIB)
                </label>

                <p>Pilih Hewan:</p>
                <div class="animal-grid" id="animalSelector">
                    <button class="animal-btn" onclick="selectAnimal(0)">0<br>üêµ</button>
                    <button class="animal-btn" onclick="selectAnimal(1)">1<br>ü¶Å</button>
                    <button class="animal-btn" onclick="selectAnimal(2)">2<br>üêº</button>
                    <button class="animal-btn" onclick="selectAnimal(3)">3<br>üêÆ</button>
                    <button class="animal-btn" onclick="selectAnimal(4)">4<br>üêØ</button>
                    <button class="animal-btn" onclick="selectAnimal(5)">5<br>üêî</button>
                </div>
                <input type="hidden" id="selectedAnimal" value="-1">
                
                <div style="margin-top: 15px;">
                    <button id="approveBtn" class="hidden" onclick="approveToken()">Approve Token</button>
                    <button id="betBtn" onclick="placeBet()">Pasang Taruhan</button>
                </div>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è Kontrol Permainan</h3>
                <p>Round ID Saat Ini: <strong id="currentRoundId">#</strong></p>
                <p>Tim Aktif: <strong id="activeTeams">0</strong> / 5 Min</p>
                
                <div class="reels-display">
                    <div class="reel" id="reel1">‚ùì</div>
                    <div class="reel" id="reel2">‚ùì</div>
                    <div class="reel" id="reel3">‚ùì</div>
                </div>
                <div style="text-align:center; color: var(--accent); margin-bottom:10px;" id="roundOutcome">
                    Menunggu Putaran...
                </div>

                <button onclick="executeDraw()" id="drawBtn" class="danger">PUTAR RODA (Draw)</button>
                <p style="font-size:0.8em; color:#666; margin-top:5px;">*Siapapun bisa memutar jika syarat terpenuhi</p>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>üí¨ Sosial & Reaksi (Round Terakhir)</h3>
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('comments')">Komentar</button>
                <button class="tab-btn" onclick="showTab('rating')">Rating & Reaksi</button>
            </div>

            <div id="tab-comments">
                <div id="commentsList" style="max-height: 200px; overflow-y:auto; margin-bottom:10px; border:1px solid #333; padding:10px;">
                    </div>
                <div class="row">
                    <input type="text" id="commentText" placeholder="Tulis komentar...">
                    <button style="width: auto;" onclick="submitComment()">Kirim</button>
                </div>
            </div>

            <div id="tab-rating" class="hidden">
                <div class="row">
                    <button class="secondary" onclick="sendReaction(1)">üëç Like</button>
                    <button class="secondary" onclick="sendReaction(2)">üëé Dislike</button>
                </div>
                <div class="row" style="margin-top:10px;">
                    <select id="starRating">
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê</option>
                        <option value="2">‚≠ê‚≠ê</option>
                        <option value="1">‚≠ê</option>
                    </select>
                    <button style="width: auto;" onclick="submitRating()">Beri Rating</button>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="toast">Notifikasi</div>

<script>
    // --- KONFIGURASI PENTING (GANTI ALAMAT DI SINI) ---
    const CONTRACT_ADDRESS = "0x.....ALAMAT_KONTRAK_ANDA_DISINI....."; 
    const USDT_ADDRESS = "0x.....ALAMAT_USDT_DISINI.....";
    const SHIB_ADDRESS = "0x.....ALAMAT_SHIB_DISINI.....";
    
    // --- KONFIGURASI JARINGAN (BASE SEPOLIA) ---
    const BASE_SEPOLIA_ID = "0x14a34"; // 84532
    const BASE_SEPOLIA_CONFIG = {
        chainId: BASE_SEPOLIA_ID,
        chainName: "Base Sepolia Testnet",
        rpcUrls: ["https://sepolia.base.org"],
        blockExplorerUrls: ["https://sepolia.basescan.org"],
        nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 }
    };

    // --- ABI (MINIMAL UNTUK UI) ---
    const ABI = [
        "function register(string, string) external",
        "function users(address) view returns (string, bool, address, bool, uint256)",
        "function betETH(uint8) external payable",
        "function betToken(uint8, uint8, bool) external", // Currency enum: 0=ETH, 1=USDT, 2=SHIB
        "function executeDraw() external",
        "function claimReferralBonus() external",
        "function withdrawCredit(uint8, uint256) external",
        "function userCredits(address, uint8) view returns (uint256)",
        "function freeShibCredits(address) view returns (uint256)",
        "function currentRoundId() view returns (uint256)",
        "function getActiveTeamCount() view returns (uint256)",
        "function getRoundResult(uint256) view returns (tuple(uint8[3] reels, string outcome, uint256 timestamp, address winner))",
        "function addComment(uint256, string) external",
        "function setReaction(uint256, uint8) external",
        "function submitRating(uint256, uint8) external",
        "function roundComments(uint256, uint256) view returns (uint256, address, string, uint256, bool)",
        "function commentCounts(uint256) view returns (uint256)",
        "event BattleResult(uint8[3] reels, string outcome, uint256 roundId)"
    ];

    const TOKEN_ABI = [
        "function approve(address spender, uint256 amount) external returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    // --- STATE VARIABLES ---
    let provider, signer, contract;
    let userAddress;
    let currentRound = 0;
    
    // --- 1. WALLET CONNECTION & NETWORK SWITCHING ---
    async function connectWallet() {
        if (!window.ethereum) return showToast("Metamask tidak terdeteksi!");

        provider = new ethers.BrowserProvider(window.ethereum);
        
        try {
            await provider.send("eth_requestAccounts", []);
            const network = await provider.getNetwork();

            // Cek Jaringan Base Sepolia
            if (("0x" + network.chainId.toString(16)) !== BASE_SEPOLIA_ID) {
                try {
                    await window.ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: BASE_SEPOLIA_ID }],
                    });
                } catch (switchError) {
                    // Jika jaringan belum ada, tambahkan
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: "wallet_addEthereumChain",
                                params: [BASE_SEPOLIA_CONFIG],
                            });
                        } catch (addError) {
                            return showToast("Gagal menambahkan jaringan Base Sepolia.");
                        }
                    } else {
                        return showToast("Gagal pindah jaringan.");
                    }
                }
            }

            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

            // Handle Signature Auth
            await handleSignatureAuth();

            document.getElementById('connectBtn').classList.add('hidden');
            document.getElementById('wallet-status').innerText = `Connected: ${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
            
            checkRegistration();

        } catch (error) {
            console.error(error);
            showToast("Koneksi gagal: " + error.message);
        }
    }

    // --- 2. SIGNATURE AUTHENTICATION (LOCAL STORAGE) ---
    async function handleSignatureAuth() {
        const storageKey = `auth_${userAddress}`;
        const storedAuth = JSON.parse(localStorage.getItem(storageKey));
        const now = Date.now();

        // Cek apakah auth valid (kurang dari 30 hari)
        if (storedAuth && storedAuth.expiry > now) {
            console.log("Auth valid dari storage.");
            return;
        }

        // Jika tidak ada atau expired, minta sign
        const localTime = new Date().toLocaleString();
        const message = `Welcome ${userAddress} ${localTime}`;
        
        try {
            const signature = await signer.signMessage(message);
            const expiry = now + (30 * 24 * 60 * 60 * 1000); // 30 Hari
            
            localStorage.setItem(storageKey, JSON.stringify({
                signature: signature,
                expiry: expiry,
                message: message
            }));
            showToast("Login Berhasil (Disimpan 30 Hari)");
        } catch (err) {
            showToast("Signature ditolak user.");
            throw new Error("Signature required");
        }
    }

    // --- 3. CORE GAME LOGIC ---

    async function checkRegistration() {
        const userData = await contract.users(userAddress);
        if (userData[1] === true) { // isRegistered
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('registerSection').classList.add('hidden');
            document.getElementById('dispNick').innerText = userData[0];
            document.getElementById('dispPendingRef').innerText = userData[4];
            loadGameData();
        } else {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('registerSection').classList.remove('hidden');
        }
    }

    async function registerUser() {
        const nick = document.getElementById('regNickname').value;
        const ref = document.getElementById('regReferrer').value;
        try {
            const tx = await contract.register(nick, ref);
            showToast("Mendaftarkan... Tunggu konfirmasi.");
            await tx.wait();
            showToast("Berhasil Daftar!");
            checkRegistration();
        } catch (err) {
            showToast("Gagal daftar: " + err.reason);
        }
    }

    async function loadGameData() {
        // Credits
        const cETH = await contract.userCredits(userAddress, 0);
        const cUSDT = await contract.userCredits(userAddress, 1);
        const cSHIB = await contract.userCredits(userAddress, 2);
        const freeShib = await contract.freeShibCredits(userAddress);
        
        document.getElementById('creditETH').innerText = ethers.formatEther(cETH);
        document.getElementById('creditUSDT').innerText = ethers.formatUnits(cUSDT, 6); // USDT 6 decimals
        document.getElementById('creditSHIB').innerText = ethers.formatUnits(cSHIB, 18);
        document.getElementById('dispBonus').innerText = ethers.formatUnits(freeShib, 18);

        // Game State
        currentRound = await contract.currentRoundId();
        document.getElementById('currentRoundId').innerText = currentRound.toString();
        
        const activeTeams = await contract.getActiveTeamCount();
        document.getElementById('activeTeams').innerText = activeTeams.toString();

        loadComments(currentRound - 1n); // Load comments round sebelumnya/aktif
    }

    function selectAnimal(index) {
        document.querySelectorAll('.animal-btn').forEach(b => b.classList.remove('selected'));
        document.querySelectorAll('.animal-btn')[index].classList.add('selected');
        document.getElementById('selectedAnimal').value = index;
    }

    async function placeBet() {
        const animal = document.getElementById('selectedAnimal').value;
        if (animal == "-1") return showToast("Pilih hewan dulu!");
        
        const curr = document.getElementById('betCurrency').value; // 0, 1, 2
        const isFree = document.getElementById('isFreeBet').checked;

        try {
            let tx;
            if (curr == "0") { // ETH
                tx = await contract.betETH(animal, { value: ethers.parseEther("0.0005") });
            } else { // Token
                // Cek allowance dulu jika USDT/SHIB Main Bet
                if (!isFree) {
                    const tokenAddr = (curr == "1") ? USDT_ADDRESS : SHIB_ADDRESS;
                    const cost = (curr == "1") ? ethers.parseUnits("10", 6) : ethers.parseUnits("110000", 18);
                    
                    const tokenContract = new ethers.Contract(tokenAddr, TOKEN_ABI, signer);
                    const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESS);
                    
                    if (allowance < cost) {
                        showToast("Perlu Approve Token Dulu!");
                        document.getElementById('approveBtn').classList.remove('hidden');
                        document.getElementById('approveBtn').onclick = () => approveToken(tokenAddr, cost);
                        return;
                    }
                }
                tx = await contract.betToken(animal, curr, isFree);
            }
            showToast("Mengirim taruhan...");
            await tx.wait();
            showToast("Taruhan Masuk!");
            loadGameData();
        } catch (err) {
            console.error(err);
            showToast("Bet Gagal: " + (err.reason || err.message));
        }
    }

    async function approveToken(tokenAddr, amount) {
        try {
            const tokenContract = new ethers.Contract(tokenAddr, TOKEN_ABI, signer);
            const tx = await tokenContract.approve(CONTRACT_ADDRESS, amount);
            showToast("Approving...");
            await tx.wait();
            showToast("Approved! Klik Pasang Taruhan lagi.");
            document.getElementById('approveBtn').classList.add('hidden');
        } catch (err) {
            showToast("Approve Gagal");
        }
    }

    async function executeDraw() {
        try {
            const tx = await contract.executeDraw();
            showToast("Memutar Roda... üé∞");
            
            // Listen event
            contract.once("BattleResult", (reels, outcome, rId) => {
                document.getElementById('reel1').innerText = getEmoji(reels[0]);
                document.getElementById('reel2').innerText = getEmoji(reels[1]);
                document.getElementById('reel3').innerText = getEmoji(reels[2]);
                document.getElementById('roundOutcome').innerText = outcome;
                showToast(`Hasil: ${outcome}`);
                loadGameData();
            });

            await tx.wait();
        } catch (err) {
            showToast("Draw Gagal: " + err.reason);
        }
    }

    async function claimBonus() {
        try {
            const tx = await contract.claimReferralBonus();
            await tx.wait();
            showToast("Bonus Diklaim!");
            loadGameData();
        } catch (e) { showToast("Gagal klaim"); }
    }

    async function withdraw(ticker) {
        const amt = prompt(`Masukkan jumlah ${ticker} yg mau di WD:`);
        if(!amt) return;
        
        let currId = 0, parsedAmt;
        if(ticker === 'ETH') { currId = 0; parsedAmt = ethers.parseEther(amt); }
        if(ticker === 'USDT') { currId = 1; parsedAmt = ethers.parseUnits(amt, 6); }
        if(ticker === 'SHIB') { currId = 2; parsedAmt = ethers.parseUnits(amt, 18); }

        try {
            const tx = await contract.withdrawCredit(currId, parsedAmt);
            await tx.wait();
            showToast("Withdraw Berhasil!");
            loadGameData();
        } catch(e) { showToast("WD Gagal: " + e.reason); }
    }

    // --- 4. SOCIAL FEATURES ---
    async function loadComments(rId) {
        if (rId < 1) return;
        const count = await contract.commentCounts(rId);
        const list = document.getElementById('commentsList');
        list.innerHTML = "";

        // Load 10 komentar terakhir saja agar ringan
        let start = count > 10n ? count - 10n : 0n;
        for (let i = start; i < count; i++) {
            const c = await contract.roundComments(rId, i);
            const div = document.createElement('div');
            div.style.borderBottom = "1px solid #444";
            div.style.padding = "5px";
            div.innerHTML = `<small style='color:#aaa'>${c[1].substring(0,6)}...</small><br>${c[2]}`;
            list.appendChild(div);
        }
    }

    async function submitComment() {
        const txt = document.getElementById('commentText').value;
        const roundId = currentRound > 1 ? currentRound - 1n : 1n; // Komentar untuk ronde yg baru selesai atau aktif
        try {
            const tx = await contract.addComment(roundId, txt);
            await tx.wait();
            document.getElementById('commentText').value = "";
            loadComments(roundId);
        } catch(e) { showToast("Gagal komen"); }
    }

    async function sendReaction(type) {
        const roundId = currentRound > 1 ? currentRound - 1n : 1n;
        try {
            const tx = await contract.setReaction(roundId, type);
            await tx.wait();
            showToast("Reaksi terkirim");
        } catch(e) { showToast("Gagal reaksi"); }
    }

    async function submitRating() {
        const stars = document.getElementById('starRating').value;
        const roundId = currentRound > 1 ? currentRound - 1n : 1n;
        try {
            const tx = await contract.submitRating(roundId, stars);
            await tx.wait();
            showToast("Rating terkirim");
        } catch(e) { showToast("Gagal rating"); }
    }

    // --- UTILS ---
    function getEmoji(num) {
        const emojis = ['üêµ','ü¶Å','üêº','üêÆ','üêØ','üêî'];
        return emojis[num] || '‚ùì';
    }

    function showTab(tabName) {
        document.getElementById('tab-comments').classList.add('hidden');
        document.getElementById('tab-rating').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        event.target.classList.add('active');
    }

    function showToast(msg) {
        const x = document.getElementById("toast");
        x.innerText = msg;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }
</script>

</body>
                        </html>
