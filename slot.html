<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faylotto Ultimate - Base Sepolia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
<style>
    /* --- CSS DITINGKATKAN UNTUK LEBIH MEWAH: GRADIENTS, SHADOWS, ANIMATIONS LEBIH HALUS --- */
    * { box-sizing: border-box; }
    :root {
        --primary: #0052ff; --accent: #00d1ff; --bg: #0f111a;
        --panel: #1e2130; --text: #ffffff; --danger: #ff4b4b; --success: #00d26a;
        --shib-color: #FFA409; --usdt-color: #26A17B; --eth-color: #627EEA;
        --gold: #FFD700; --gradient-bg: linear-gradient(135deg, #0f111a, #1e2130);
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--gradient-bg); color: var(--text); margin: 0;
        display: flex; flex-direction: column; align-items: center;
        min-height: 100vh; padding-bottom: 50px; overflow-x: hidden;
    }
    header {
        width: 100%; padding: 15px 20px; display: flex; justify-content: space-between;
        align-items: center; background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--panel);
        position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .wallet-btn {
        background: var(--primary); color: white; border: none; padding: 8px 16px;
        border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.3s;
        box-shadow: 0 0 10px rgba(0, 82, 255, 0.5);
    }
    .wallet-btn.connected { background: var(--success); border: 1px solid #fff; cursor: default; }
    .layout-container {
        width: 94%; max-width: 480px; display: flex; flex-direction: column;
        align-items: center; margin: 0 auto;
    }

    .slot-machine {
        margin-top: 30px; background: var(--panel); padding: 20px;
        border-radius: 15px; border: 4px solid #333;
        box-shadow: 0 0 30px rgba(0, 82, 255, 0.4);
        width: 100%; display: flex; flex-direction: column; align-items: center;
    }
    .reels-container { display: flex; gap: 8px; background: #000; padding: 10px; border-radius: 8px; justify-content: center; margin-bottom: 15px; width: 100%; box-shadow: inset 0 0 10px rgba(255,255,255,0.1); }
    .reel { flex: 1; height: 90px; background: #fff; border-radius: 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    .reel-img { width: 80%; height: 80%; object-fit: contain; transition: transform 0.1s; }

    .draw-section { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .btn-draw {
        background: linear-gradient(45deg, #333, #555); color: #888; border: 2px solid #444;
        padding: 12px 0; width: 70%; border-radius: 30px;
        font-size: 0.9em; font-weight: 800; cursor: not-allowed; transition: 0.3s;
    }
    .btn-draw.ready {
        background: linear-gradient(45deg, #ff0000, #ff8800); color: white; border: 2px solid #ffaa00;
        cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); } 50% { box-shadow: 0 0 25px rgba(255, 100, 0, 0.8); } 100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); } }
    .status-text { font-size: 0.8em; color: var(--accent); font-weight: bold; text-align: center; }

    .betting-section { margin-top: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; }
    .bet-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-top: 15px; }

    .bet-card {
        background: var(--panel);
        border: 3px solid #333; /* Default Neutral */
        border-radius: 12px; padding: 10px; cursor: pointer; transition: 0.2s;
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; aspect-ratio: 1/1.2; position: relative;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* Hover Effect Default */
    .bet-card:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(0, 82, 255, 0.5); }

    /* 1. MY BET (USER SUDAH BET) -> BIRU */
    .bet-card.my-bet {
        border-color: var(--primary); /* Biru */
        background: rgba(0, 82, 255, 0.2);
        box-shadow: 0 0 20px rgba(0, 82, 255, 0.6);
    }

    /* 2. OPEN (MASIH BISA DIBET) -> HIJAU */
    .bet-card.open {
        border-color: var(--success); /* Hijau */
        animation: pulseGreen 2s infinite;
    }
    @keyframes pulseGreen { 0% { border-color: #00d26a; } 50% { border-color: #00ff80; } 100% { border-color: #00d26a; } }

    /* SELECTED STATE (Saat diklik untuk mau bet) */
    .bet-card.selected {
        transform: scale(0.95);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 15px var(--accent);
    }

    .bet-icon-img { width: 50%; height: 50%; object-fit: contain; margin-bottom: 5px; }
    .name { font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px;}
    .team-count { font-size: 9px; color: #aaa; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-top: 2px; }
    .team-count.filled { color: var(--success); border: 1px solid var(--success); }

    .pool-dashboard { width: 100%; display: flex; justify-content: space-between; gap: 5px; margin-top: 20px; margin-bottom: 10px; }
    .pool-box { flex: 1; background: #151925; border: 1px solid #333; border-radius: 8px; padding: 8px 5px; text-align: center; display: flex; flex-direction: column; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .pool-title { font-size: 0.6em; color: #aaa; text-transform: uppercase; margin-bottom: 3px; }
    .pool-value { font-size: 0.8em; font-weight: bold; }
    .text-eth { color: var(--eth-color); } .text-usdt { color: var(--usdt-color); } .text-shib { color: var(--shib-color); }

    .card-stats-container { width: 100%; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; font-size: 0.6em; font-weight: bold; }
    .c-stat { display: flex; align-items: center; gap: 2px; }

    .main-bet-btn { margin-top: 15px; background: var(--primary); color: white; border: 3px solid #0027b3; padding: 13px 0; width: 70%; border-radius: 50px; font-size: 0.9em; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 0 15px var(--primary); }
    .main-bet-btn:hover { background: var(--accent); transform: translateY(-2px); box-shadow: 0 0 25px var(--accent); }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--panel); width: 90%; max-width: 380px; padding: 25px; border-radius: 15px; text-align: center; border: 1px solid var(--accent); box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative;}
    .modal-title { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; }
    .pay-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .pay-btn { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 13px; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
    .btn-eth { background: var(--eth-color); } .btn-usdt { background: var(--usdt-color); } .btn-shib { background: var(--shib-color); }

    .close-modal { background: none; border: none; color: #aaa; font-size: 1.5em; position: absolute; top: 10px; right: 15px; cursor: pointer; }

    .dash-profile { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
    .dash-balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; text-align: left; }
    .dash-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; }
    .dash-label { font-size: 0.65em; color: #aaa; display: block; }
    .dash-val { font-size: 0.85em; font-weight: bold; }
    .btn-disconnect { background: var(--danger); width: 100%; padding: 10px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }

    .referral-panel { margin-top: 20px; width: 100%; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid #333; text-align: center; display: none; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
    .ref-box { background: #000; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; margin-top: 5px; font-size: 0.8em; color: #888; }
    .btn-copy { background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }

    .withdraw-section { margin-top:15px; padding-top:10px; border-top:1px dashed #444; text-align:left; }
    .withdraw-title { font-size:0.8em; color:#aaa; margin-bottom:5px; }
    .btn-withdraw-small { background: var(--success); color:black; border:none; padding:4px 8px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.8em; float:right; }

    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 999; bottom: 30px; left: 50%; transform: translateX(-50%); }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    /* --- EFEK WINNER GLAMOR DITINGKATKAN --- */
    .winner-glamour {
        border-color: var(--gold) !important; /* Emas Solid */
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.3)) !important;
        animation: glamourPulse 0.8s infinite alternate !important;
        z-index: 10; /* Pastikan di atas layer lain */
        transform-origin: center;
    }

    /* Animasi Denyut Emas */
    @keyframes glamourPulse {
        0% {
            box-shadow: 0 0 15px var(--gold), inset 0 0 5px var(--gold);
            transform: scale(1);
            border-color: var(--gold);
        }
        100% {
            box-shadow: 0 0 30px var(--gold), 0 0 45px #FF4500, inset 0 0 20px var(--gold); /* Glow Emas & Merah */
            transform: scale(1.1); /* Sedikit membesar */
            border-color: #FFF; /* Kilatan Putih */
        }
    }

    /* Tambahan: Winner Badge (Opsional, agar lebih jelas) */
    .winner-glamour::before {
        content: "üèÜ WINNER";
        position: absolute;
        top: -15px;
        background: linear-gradient(45deg, var(--gold), #FFA500);
        color: #000;
        font-weight: bold;
        font-size: 0.7em;
        padding: 3px 10px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        animation: bounce 0.8s infinite;
    }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* --- TAMBAHAN UNTUK HISTORY SECTION --- */
    .history-section { margin-top: 30px; width: 100%; }
    .history-card { background: var(--panel); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
    .history-reels { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
    .history-reel-img { width: 40px; height: 40px; object-fit: contain; }
    .history-outcome { font-weight: bold; color: var(--accent); }

    /* --- STYLE BARU UNTUK TAB & HISTORY --- */
    .history-tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
    .tab-btn { flex: 1; padding: 10px; background: #151925; border: 1px solid #333; color: #888; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: 0.3s; }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 82, 255, 0.4); }
    
    .btn-load-more { width: 100%; padding: 12px; background: #222; border: 1px dashed #555; color: #aaa; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 0.8em; transition: 0.3s; }
    .btn-load-more:hover { background: #333; color: white; border-color: white; }
    .hidden { display: none; }

    /* Style untuk Personal Bet Card */
    .personal-bet-card { background: rgba(255,255,255,0.03); border-left: 3px solid #555; padding: 10px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    .pb-info { font-size: 0.8em; }
    .pb-time { font-size: 0.7em; color: #666; }
    .pb-animal { font-weight: bold; color: var(--accent); }

    /* Status Badge untuk Personal History */
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; text-transform: uppercase; }
    .badge-win { background: rgba(0, 210, 106, 0.2); color: var(--success); border: 1px solid var(--success); }
    .badge-lose { background: rgba(255, 75, 75, 0.2); color: var(--danger); border: 1px solid var(--danger); }
    
    .winner-info-box {
        margin-top: 8px; padding-top: 8px; border-top: 1px dashed #444;
        font-size: 0.75em; display: flex; align-items: center; justify-content: space-between;
    }
    .w-user { color: var(--gold); font-weight: bold; display: flex; align-items: center; gap: 4px; }
    .w-amt { color: white; font-weight: bold; }
</style>
</head>
<body>
<header>
    <div style="font-weight:bold; font-size:1.2em;">Faylotto <span style="color:var(--accent)">Ultimate</span></div>
    <button id="connectBtn" class="wallet-btn" onclick="handleWalletClick()">Connect Wallet</button>
</header>

<div class="layout-container">

    <div class="slot-machine">
        <div class="reels-container">
            <div class="reel"><img id="imgReel1" src="what.svg" class="reel-img"></div>
            <div class="reel"><img id="imgReel2" src="what.svg" class="reel-img"></div>
            <div class="reel"><img id="imgReel3" src="what.svg" class="reel-img"></div>
        </div>
        <div class="draw-section">
            <button id="drawBtn" class="btn-draw" onclick="executeDraw()" disabled>DRAW NOW!</button>
            <div id="drawStatus" class="status-text">Waiting for players...</div>
        </div>
    </div>

    <div class="betting-section">
        <h3 style="margin-bottom:5px;">SELECT ANIMAL</h3>

        <div class="bet-grid">
            <div class="bet-card" id="card-0" onclick="selectAnimal('tuna', 0)">
                <img src="tuna.svg" class="bet-icon-img"><span class="name">Tuna</span><span id="count-0" class="team-count">0</span>
                <div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-0">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-0">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-0">0</span></span></div>
            </div>
            <div class="bet-card" id="card-1" onclick="selectAnimal('crab', 1)">
                <img src="crab.svg" class="bet-icon-img"><span class="name">Crab</span><span id="count-1" class="team-count">0</span>
                <div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-1">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-1">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-1">0</span></span></div>
            </div>
            <div class="bet-card" id="card-2" onclick="selectAnimal('shark', 2)">
                <img src="shark.svg" class="bet-icon-img"><span class="name">Shark</span><span id="count-2" class="team-count">0</span>
                <div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-2">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-2">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-2">0</span></span></div>
            </div>
            <div class="bet-card" id="card-3" onclick="selectAnimal('octopus', 3)">
                <img src="octo.svg" class="bet-icon-img"><span class="name">Octopus</span><span id="count-3" class="team-count">0</span>
                <div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-3">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-3">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-3">0</span></span></div>
            </div>
            <div class="bet-card" id="card-4" onclick="selectAnimal('shrimp', 4)">
                <img src="shrimp.svg" class="bet-icon-img"><span class="name">Shrimp</span><span id="count-4" class="team-count">0</span>
                <div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-4">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-4">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-4">0</span></span></div>
            </div>
            <div class="bet-card" id="card-5" onclick="selectAnimal('orcha', 5)">
                <img src="orcha.svg" class="bet-icon-img"><span class="name">Orcha</span><span id="count-5" class="team-count">0</span>
                <div class="card-stats-container"><span class="c-stat text-eth">E:<span id="c-eth-5">0</span></span><span class="c-stat text-usdt">U:<span id="c-usdt-5">0</span></span><span class="c-stat text-shib">S:<span id="c-shib-5">0</span></span></div>
            </div>
        </div>

        <div style="width:100%; margin-top:20px; font-size:0.7em; color:#aaa; text-align:left;">ESTIMATED POOLS (ROUND)</div>
        <div class="pool-dashboard">
            <div class="pool-box"><span class="pool-title">ETH</span><span class="pool-value text-eth" id="poolTotalETH">0.0000</span></div>
            <div class="pool-box"><span class="pool-title">USDT</span><span class="pool-value text-usdt" id="poolTotalUSDT">0.00</span></div>
            <div class="pool-box"><span class="pool-title">SHIB</span><span class="pool-value text-shib" id="poolTotalSHIB">0</span></div>
        </div>

        <button id="mainBetBtn" class="main-bet-btn" onclick="triggerBetModal()">PLACE BET</button>
        <p style="margin-top:15px; color:#aaa; font-size:0.7em;">*Min 5 teams required to Draw</p>

        <div id="referralPanel" class="referral-panel">
            <div class="ref-label">Player Profile</div>
            <div style="font-size:1.2em; font-weight:bold; color:white; margin-bottom:10px;" id="displayNick">...</div>
            <div id="claimBonusBtnContainer"></div>
            <div class="ref-label">Referral Link</div>
            <div class="ref-box">
                <span id="displayRefLink" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">...</span>
                <button class="btn-copy" onclick="copyRefLink()">Copy</button>
            </div>
        </div>
    </div>
</div>

    <div class="history-section">
            <div class="history-tabs">
                <button class="tab-btn active" onclick="switchTab('global')">Global Results</button>
                <button class="tab-btn" onclick="switchTab('personal')">My Bets</button>
            </div>

            <div id="tabGlobal">
                <div id="historyList"></div>
                <button id="btnLoadMore" class="btn-load-more" onclick="loadMoreHistory()">Load Previous Rounds (15)</button>
            </div>

            <div id="tabPersonal" class="hidden">
                <div id="personalHistoryList">
                    <div style="text-align:center; color:#555; font-size:0.8em; padding:20px;">Fetching blockchain data...</div>
                </div>
            </div>
    </div>

<div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('paymentModal')">&times;</button>
        <div class="modal-title">BET ON <span id="modalAnimalName">ANIMAL</span></div>
        <div class="pay-options">
            <button class="pay-btn btn-eth" onclick="processPayment('ETH')"><span>ETH</span> <span>0.0005 ETH</span></button>
            <button class="pay-btn btn-usdt" onclick="processPayment('USDT')"><span>USDT</span> <span>10 USDT</span></button>
            <button class="pay-btn btn-shib" onclick="processPayment('SHIB')"><span>SHIB</span> <span>110,000 SHIB</span></button>
        </div>
        <div style="border-top:1px dashed #444; padding-top:10px;">
            <div style="font-size:0.8em; color:#aaa;">Free Credit Balance: <span id="userBonusBalance" style="color:white;">0</span> SHIB</div>
            <button id="btnFreeBet" class="wallet-btn" style="width:100%; margin-top:5px; background:#333;" disabled onclick="processPayment('FREE')">Use Free Credit (10k)</button>
        </div>
    </div>
</div>

<div id="registerModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">REGISTER PROFILE</div>
        <input type="text" id="regNickname" class="input-field" placeholder="Enter Nickname (Min 3 Chars)" style="width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:none;">
        <div id="refInfoDisplay" style="font-size:0.8em; color:var(--success); margin-bottom:10px;"></div>
        <button class="wallet-btn" style="width:100%;" onclick="registerUser()">REGISTER NOW</button>
    </div>
</div>

<div id="walletInfoModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('walletInfoModal')">&times;</button>
        <div class="dash-profile">
            <div style="font-weight:bold; margin-bottom:5px;">WALLET & WINNINGS</div>
            <div style="font-size:0.8em; color:#aaa; background:#111; padding:5px; border-radius:4px;" id="dashAddress">...</div>
        </div>

        <div style="font-size:0.7em; color:#888; margin-bottom:5px;">WALLET BALANCE</div>
        <div class="dash-balance-grid">
            <div class="dash-item"><span class="dash-label">ETH</span><span class="dash-val text-eth" id="balETH">0.000</span></div>
            <div class="dash-item"><span class="dash-label">USDT</span><span class="dash-val text-usdt" id="balUSDT">0.00</span></div>
            <div class="dash-item"><span class="dash-label">SHIB</span><span class="dash-val text-shib" id="balSHIB">0.00</span></div>
        </div>

        <div class="withdraw-section">
            <div class="withdraw-title">GAME CREDIT / WINNINGS (IN CONTRACT)</div>
            <div class="dash-balance-grid">
                <div class="dash-item">
                    <span class="dash-label">ETH Credit</span><span class="dash-val text-eth" id="credETH">0.000</span>
                    <button class="btn-withdraw-small" onclick="withdraw('ETH')">W/D</button>
                </div>
                <div class="dash-item">
                    <span class="dash-label">USDT Credit</span><span class="dash-val text-usdt" id="credUSDT">0.00</span>
                    <button class="btn-withdraw-small" onclick="withdraw('USDT')">W/D</button>
                </div>
                <div class="dash-item">
                    <span class="dash-label">SHIB Credit</span><span class="dash-val text-shib" id="credSHIB">0.00</span>
                    <button class="btn-withdraw-small" onclick="withdraw('SHIB')">W/D</button>
                </div>
            </div>
        </div>

        <button class="btn-disconnect" onclick="disconnectWallet()">DISCONNECT</button>
    </div>
</div>

<div id="toast">Notification</div>

<script>
    // --- KONFIGURASI PENTING --- 
    const CONTRACT_ADDRESS = "0x72a20552267B4313f74003E25593592B15b76ad6";
    const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2";
    const SHIB_ADDRESS = "0xba63AFBf0060a9123aAAc1213b587d0462bD4d45";
    const BASE_SEPOLIA_ID = 84532;
    const BASE_SEPOLIA_HEX = "0x14a34";

    // --- ABI LENGKAP --- 
    const GAME_ABI = [{"inputs":[{"internalType":"address","name":"_usdtToken","type":"address"},{"internalType":"address","name":"_shibToken","type":"address"},{"internalType":"address","name":"_priceFeedETH","type":"address"},{"internalType":"address","name":"_priceFeedUSDT","type":"address"},{"internalType":"address","name":"_priceFeedSHIB","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"indexed":false,"internalType":"string","name":"outcome","type":"string"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"BattleResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BonusClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"oldCollector","type":"address"},{"indexed":false,"internalType":"address","name":"newCollector","type":"address"}],"name":"FeeCollectorUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint8","name":"animalChoice","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"NewBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"RatingSubmitted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"reactionType","type":"uint8"}],"name":"ReactionUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"invitee","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralLinked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"UserRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"enum FaylottoUltimate.Currency","name":"curr","type":"uint8"},{"indexed":false,"internalType":"bool","name":"isRealTransfer","type":"bool"}],"name":"WinDistributed","type":"event"},{"inputs":[],"name":"COST_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_FREE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_SHIB_MAIN","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"COST_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_PLATFORM_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TOTAL_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TEAMS_ACTIVE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BONUS_AMOUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"","type":"uint8"}],"name":"activeTeamCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"}],"name":"betETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_animal","type":"uint8"},{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"bool","name":"_isFreeBet","type":"bool"}],"name":"betToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralBonus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"commentCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"dislikeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint256","name":"_cId","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"name":"emergencyWithdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeDraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeShibCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getActiveTeamCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getBonusBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"}],"name":"getLatestPrice","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"}],"name":"getRoundResult","outputs":[{"components":[{"internalType":"uint8[3]","name":"reels","type":"uint8[3]"},{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"internalType":"struct FaylottoUltimate.RoundResultData","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"globalWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"nicknameToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_referrerNick","type":"string"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"enum FaylottoUltimate.BetType","name":"bType","type":"uint8"},{"internalType":"uint8","name":"animalChoice","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isEdited","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"roundHistory","outputs":[{"internalType":"string","name":"outcome","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"winner","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_eth","type":"address"},{"internalType":"address","name":"_usdt","type":"address"},{"internalType":"address","name":"_shib","type":"address"}],"name":"setPriceFeeds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_reaction","type":"uint8"}],"name":"setReaction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"shibToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"uint8","name":"_stars","type":"uint8"}],"name":"submitRating","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalRatingScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdtToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"enum FaylottoUltimate.Currency","name":"","type":"uint8"}],"name":"userCredits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRatings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userReactions","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userWinHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"winAmount","type":"uint256"},{"internalType":"enum FaylottoUltimate.Currency","name":"currency","type":"uint8"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"outcomeType","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"string","name":"nickname","type":"string"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"bool","name":"hasBet","type":"bool"},{"internalType":"uint256","name":"pendingRefBonusCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum FaylottoUltimate.Currency","name":"_curr","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawCredit","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    const ERC20_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

    // --- VARIABLES & STATE ---
    const IMAGE_NAMES = ['tuna', 'crab', 'shark', 'octopus', 'shrimp', 'orcha'];
    const IMAGE_LIST = ["tuna.svg", "crab.svg", "shark.svg", "octo.svg", "shrimp.svg", "orcha.svg", "zonk.svg"]; 
    
    // Konfigurasi Spin 35 Detik
    const MIN_SPIN_TIME = 35000; 
    let spinStartTime = 0;
    let spinIntervals = [];
    let historyCursor = 0; // Menandai ronde terakhir yang sudah diload
    let isInitialLoad = true;
    let currentMaxRound = 0;
    let cachedBattleResults = [];

    let provider, signer, userAddress, gameContract;
    let isConnected = false;
    let currentSelectedAnimal = { name: '', index: -1 };
    let detectedReferrer = "";
    let roundPools = { eth: 0, usdt: 0, shib: 0 };
    
    // --- MAIN LOGIC ---
    window.onload = async () => {
        document.querySelectorAll('.reel-img').forEach(img => img.src = "what.svg");
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('ref')) detectedReferrer = urlParams.get('ref');
        
        provider = new ethers.JsonRpcProvider("https://sepolia.base.org");
        gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, provider);
        
        setupEventListeners();
        refreshGameData(); 
    };

    function handleWalletClick() { isConnected ? openWalletDashboard() : connectWallet(); }

    async function connectWallet() {
        if (!window.ethereum) { showToast("MetaMask not installed!"); return; }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            userAddress = accounts[0];
            await switchNetwork();
            signer = await provider.getSigner();
            gameContract = new ethers.Contract(CONTRACT_ADDRESS, GAME_ABI, signer);

            const storedAuth = localStorage.getItem(`auth_${userAddress}`);
            if (storedAuth && JSON.parse(storedAuth).expiry > Date.now()) {
                finalizeLogin();
            } else {
                await requestSignature();
            }
        } catch (error) { console.error(error); showToast("Connection failed"); }
    }

    async function switchNetwork() {
        try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_SEPOLIA_HEX }] }); }
        catch (err) { console.log("Network switch ignored or failed"); }
    }

    async function requestSignature() {
        try {
            const msg = `Login Faylotto\nUser: \( {userAddress}\nTs: \){Date.now()}`;
            const sig = await signer.signMessage(msg);
            localStorage.setItem(`auth_${userAddress}`, JSON.stringify({ sig, expiry: Date.now() + 86400000 * 30 }));
            finalizeLogin();
        } catch { showToast("Sign rejected"); }
    }

    async function finalizeLogin() {
        isConnected = true;
        document.getElementById("connectBtn").innerText = userAddress.substring(0,6)+"..."+userAddress.slice(-4);
        document.getElementById("connectBtn").classList.add("connected");
        showToast("Wallet Connected");

        try {
            const userData = await gameContract.users(userAddress);
            if (!userData[1]) { 
                if (detectedReferrer) document.getElementById('refInfoDisplay').innerText = "Invited by: " + detectedReferrer;
                document.getElementById('registerModal').style.display = 'flex';
            } else {
                refreshGameData();
            }
        } catch (e) { console.error("Login Check Error:", e); }
    }

    async function refreshGameData() {
        try {
            if (isConnected) {
                const userData = await gameContract.users(userAddress);
                if (userData[1]) {
                    document.getElementById('referralPanel').style.display = 'block';
                    document.getElementById('displayNick').innerText = userData[0];
                    document.getElementById('displayRefLink').innerText = window.location.origin + window.location.pathname + "?ref=" + userData[0];
                    const pending = Number(userData[4]);
                    const claimContainer = document.getElementById('claimBonusBtnContainer');
                    claimContainer.innerHTML = '';
                    if (pending > 0) {
                        const btn = document.createElement('button');
                        btn.className = 'wallet-btn';
                        btn.style.marginBottom = '10px';
                        btn.innerText = `Claim ${pending * 10000} SHIB Bonus`;
                        btn.onclick = claimReferralBonus;
                        claimContainer.appendChild(btn);
                    }
                }

                const bonus = await gameContract.freeShibCredits(userAddress);
                document.getElementById('userBonusBalance').innerText = Number(ethers.formatEther(bonus)).toLocaleString();
                const btnFree = document.getElementById('btnFreeBet');
                if (bonus >= ethers.parseEther("10000")) {
                    btnFree.disabled = false; btnFree.style.background = "var(--success)";
                } else {
                    btnFree.disabled = true; btnFree.style.background = "#333";
                }
            }

            const currentRound = Number(await gameContract.currentRoundId());
            let bets = [];
            let index = 0;
            while (true) {
                try {
                    const bet = await gameContract.roundBets(currentRound, index);
                    bets.push(bet);
                    index++;
                } catch { break; }
            }

            let myBetAnimals = Array(6).fill(false);
            let animalCurrCounts = Array(6).fill().map(() => ({eth: 0, usdt: 0, shib: 0}));
            let pools = {eth: 0, usdt: 0, shib: 0};
            let activeCount = 0;

            bets.forEach(bet => {
                const animal = Number(bet[4]);
                const curr = Number(bet[2]);
                const bType = Number(bet[3]); 
                let dec = curr === 1 ? 6 : 18;
                const amt = parseFloat(ethers.formatUnits(bet[1], dec));

                if (bet[0].toLowerCase() === userAddress?.toLowerCase()) {
                    myBetAnimals[animal] = true;
                }

                if (curr === 0) {
                    animalCurrCounts[animal].eth++;
                    if (bType === 0) pools.eth += amt;
                } else if (curr === 1) {
                    animalCurrCounts[animal].usdt++;
                    if (bType === 0) pools.usdt += amt;
                } else if (curr === 2) {
                    animalCurrCounts[animal].shib++;
                    if (bType === 0) pools.shib += amt;
                }
            });

            roundPools = pools;
            updatePoolDisplay();

            for (let i = 0; i < 6; i++) {
                const count = Number(await gameContract.activeTeamCounts(i)); 
                const card = document.getElementById(`card-${i}`);
                const badge = document.getElementById(`count-${i}`);

                badge.innerText = `${count}`;
                if (count > 0) badge.classList.add("filled"); else badge.classList.remove("filled");

                card.classList.remove('my-bet', 'open', 'selected');
                card.onclick = () => selectAnimal(IMAGE_NAMES[i], i);

                if (myBetAnimals[i]) {
                    card.classList.add('my-bet');
                } else {
                    card.classList.add('open');
                }

                document.getElementById(`c-eth-${i}`).innerText = animalCurrCounts[i].eth;
                document.getElementById(`c-usdt-${i}`).innerText = animalCurrCounts[i].usdt;
                document.getElementById(`c-shib-${i}`).innerText = animalCurrCounts[i].shib;

                if (count > 0) activeCount++;
            }

            const MIN_TEAMS_REQUIRED = 5;
            const btnDraw = document.getElementById('drawBtn');
            const status = document.getElementById('drawStatus');

            if (activeCount >= MIN_TEAMS_REQUIRED) {
                btnDraw.disabled = false; btnDraw.classList.add('ready');
                status.innerText = "READY TO DRAW!";
                status.style.color = "var(--success)";
            } else {
                btnDraw.disabled = true; btnDraw.classList.remove('ready');
                const need = MIN_TEAMS_REQUIRED - activeCount;
                status.innerText = `Need ${need} more teams active to Draw`;
                status.style.color = "var(--danger)";
            }

            updateHistorySection(currentRound); 
            
            // Jika tab personal sedang aktif, refresh juga personal history
            if (!document.getElementById('tabPersonal').classList.contains('hidden')) {
                updatePersonalHistory();
            }

        } catch (e) { console.error("Refresh Error:", e); }
    }

    function updatePoolDisplay() {
        document.getElementById('poolTotalETH').innerText = roundPools.eth.toFixed(4);
        document.getElementById('poolTotalUSDT').innerText = roundPools.usdt.toFixed(2);
        document.getElementById('poolTotalSHIB').innerText = roundPools.shib.toLocaleString();
    }

    function selectAnimal(name, index) {
        currentSelectedAnimal = { name, index };
        for (let i = 0; i < 6; i++) document.getElementById(`card-${i}`).classList.remove('selected');
        document.getElementById(`card-${index}`).classList.add('selected');
    }

    async function processPayment(currencyType) {
        if (currentSelectedAnimal.index === -1) return;
        const idx = currentSelectedAnimal.index;
        closeModal('paymentModal');
        showToast(`Processing ${currencyType}...`);

        try {
            let tx;
            if (currencyType === 'ETH') {
                const val = ethers.parseEther("0.0005");
                tx = await gameContract.betETH(idx, { value: val });
            } else if (currencyType === 'USDT') {
                const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
                const amount = ethers.parseUnits("10", 6);
                await checkApprove(usdt, amount);
                tx = await gameContract.betToken(idx, 1, false);
            } else if (currencyType === 'SHIB') {
                const shib = new ethers.Contract(SHIB_ADDRESS, ERC20_ABI, signer);
                const amount = ethers.parseUnits("110000", 18);
                await checkApprove(shib, amount);
                tx = await gameContract.betToken(idx, 2, false);
            } else if (currencyType === 'FREE') {
                tx = await gameContract.betToken(idx, 2, true);
            }

            showToast("Sending Transaction...");
            await tx.wait();
            showToast("Bet Placed Successfully!");
            refreshGameData();

        } catch (err) {
            console.error(err);
            showToast("Failed: " + (err.reason || err.message.slice(0,20)));
        }
    }

    async function checkApprove(tokenContract, amountNeeded) {
        const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESS);
        if (allowance < amountNeeded) {
            showToast("Approving Token...");
            const tx = await tokenContract.approve(CONTRACT_ADDRESS, ethers.MaxUint256);
            await tx.wait();
            showToast("Approved!");
        }
    }

    // --- ANIMATION LOGIC (UPDATED FOR SUSPENSE) ---

    function startSpinAnimation() {
        // Reset interval jika ada
        spinIntervals.forEach(clearInterval);
        spinIntervals = [];

        const reels = [
            document.getElementById('imgReel1'),
            document.getElementById('imgReel2'), 
            document.getElementById('imgReel3')
        ];

        // Putar setiap reel secara Chaotic (Acak dan kecepatan beda)
        reels.forEach((reel, index) => {
            let speed = 80 + (index * 10); 
            const interval = setInterval(() => {
                const randIdx = Math.floor(Math.random() * IMAGE_LIST.length);
                reel.src = IMAGE_LIST[randIdx];
            }, speed);
            spinIntervals.push(interval);
        });
    }

    function stopSpinAnimation(i1, i2, i3) {
        // Stop putaran chaotic
        spinIntervals.forEach(clearInterval);
        spinIntervals = [];

        const reel1 = document.getElementById('imgReel1');
        const reel2 = document.getElementById('imgReel2');
        const reel3 = document.getElementById('imgReel3');

        // Stop Bertahap (Reel 1)
        reel1.style.filter = "blur(2px)";
        setTimeout(() => {
            reel1.src = IMAGE_LIST[i1];
            reel1.style.filter = "none";
        }, 100);

        // Stop Bertahap (Reel 2) - Delay 600ms
        reel2.style.filter = "blur(4px)";
        let tempInt2 = setInterval(() => { reel2.src = IMAGE_LIST[Math.floor(Math.random() * IMAGE_LIST.length)]; }, 80);
        setTimeout(() => {
            clearInterval(tempInt2);
            reel2.src = IMAGE_LIST[i2];
            reel2.style.filter = "none";
        }, 600);

        // Stop Bertahap (Reel 3) - Delay 1400ms (Suspense Zonk/Triple)
        reel3.style.filter = "blur(5px)";
        let tempInt3 = setInterval(() => { reel3.src = IMAGE_LIST[Math.floor(Math.random() * IMAGE_LIST.length)]; }, 80);
        setTimeout(() => {
            clearInterval(tempInt3);
            reel3.src = IMAGE_LIST[i3];
            reel3.style.filter = "none";
            reel3.style.transform = "scale(1.2)";
            setTimeout(() => { reel3.style.transform = "scale(1)"; }, 200);
        }, 1400); 
    }

    async function executeDraw() {
        try {
            showToast("Initiating Draw...");
            const tx = await gameContract.executeDraw();
            
            // Start Animation & Record Time
            startSpinAnimation();
            spinStartTime = Date.now(); 

            showToast("Spinning... (Good Luck!)");
            await tx.wait();
            // Stop logic is handled by Event Listener + Check Result
        } catch (err) { showToast("Draw Error: " + (err.reason || err.message)); }
    }

    async function checkRoundResult(roundId) {
        // Logic Wait 35 Detik
        const elapsed = Date.now() - spinStartTime;
        const remainingTime = MIN_SPIN_TIME - elapsed;
        const delay = remainingTime > 0 ? remainingTime : 0;

        setTimeout(async () => {
            try {
                const result = await gameContract.getRoundResult(roundId);
                const r1 = Number(result[0][0]);
                const r2 = Number(result[0][1]);
                const r3 = Number(result[0][2]);
                const rawOutcome = result[1];

                stopSpinAnimation(r1, r2, r3);

                const winnersIndices = new Set([r1, r2, r3]);
                for (let i = 0; i < 6; i++) {
                    const card = document.getElementById(`card-${i}`);
                    if (winnersIndices.has(i) && i < 6) card.classList.add('winner-glamour');
                    else card.classList.remove('winner-glamour');
                }
                setTimeout(() => {
                    for (let i = 0; i < 6; i++) document.getElementById(`card-${i}`).classList.remove('winner-glamour');
                }, 8000);

                const getName = (idx) => IMAGE_NAMES[idx] ? IMAGE_NAMES[idx].toUpperCase() : "ZONK";
                let displayOutcome = "";
                
                if (rawOutcome === "TRIPLE") displayOutcome = `${getName(r1)} (TRIPLE)`;
                else if (rawOutcome === "DOUBLE") displayOutcome = `${getName(r1)} (DOUBLE)`;
                else if (rawOutcome === "ONE_ZONK") displayOutcome = `${getName(r1)} - ZONK - ${getName(r3)}`;
                else displayOutcome = `${getName(r1)} - ${getName(r2)} - ${getName(r3)}`;

                let winnerInfo = "No Winners";
                const filter = gameContract.filters.WinDistributed();
                const events = await gameContract.queryFilter(filter, -100);
                
                if (events.length > 0) {
                    const lastEvent = events[events.length - 1];
                    const args = lastEvent.args;
                    const wAddr = args[0];
                    const wAmnt = args[1];
                    const wCurr = Number(args[2]);
                    
                    let symbol = wCurr === 0 ? "ETH" : (wCurr === 1 ? "USDT" : "SHIB");
                    let decimal = wCurr === 1 ? 6 : 18;
                    let formattedAmount = parseFloat(ethers.formatUnits(wAmnt, decimal));
                    
                    if(formattedAmount < 0.0001) formattedAmount = formattedAmount.toFixed(6);
                    else formattedAmount = formattedAmount.toLocaleString(undefined, {maximumFractionDigits: 4});

                    winnerInfo = `Winner: ${wAddr.substring(0,6)}...${wAddr.slice(-4)} | Profit: ${formattedAmount} ${symbol}`;
                }

                showToast(`Result: ${displayOutcome} | ${winnerInfo}`);
                refreshGameData();

            } catch (e) {
                console.error("Error displaying result:", e);
            }
        }, delay);
    }

    async function withdraw(curr) {
        try {
            showToast(`Withdrawing ${curr}...`);
            let cIdx = curr === 'ETH' ? 0 : (curr === 'USDT' ? 1 : 2);
            const bal = await gameContract.userCredits(userAddress, cIdx);
            if (bal == 0n) { showToast("No balance to withdraw"); return; }
            const tx = await gameContract.withdrawCredit(cIdx, bal);
            await tx.wait();
            showToast("Withdraw Success!");
            openWalletDashboard();
        } catch (err) { showToast("Withdraw Failed: " + (err.reason || err.message)); }
    }

    function triggerBetModal() {
        if (!isConnected) { showToast("Connect Wallet First"); return; }
        if (currentSelectedAnimal.index === -1) { showToast("Select Animal First"); return; }
        document.getElementById("modalAnimalName").innerText = currentSelectedAnimal.name.toUpperCase();
        document.getElementById('paymentModal').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function showToast(msg) {
        const x = document.getElementById("toast");
        x.innerText = msg; x.className = "show";
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
    }

    async function openWalletDashboard() {
        document.getElementById('walletInfoModal').style.display = 'flex';
        document.getElementById('dashAddress').innerText = userAddress;
        try {
            const balEth = await provider.getBalance(userAddress);
            document.getElementById('balETH').innerText = parseFloat(ethers.formatEther(balEth)).toFixed(4);

            const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
            const balUsdt = await usdt.balanceOf(userAddress);
            document.getElementById('balUSDT').innerText = parseFloat(ethers.formatUnits(balUsdt, 6)).toFixed(2);

            const shib = new ethers.Contract(SHIB_ADDRESS, ERC20_ABI, provider);
            const balShib = await shib.balanceOf(userAddress);
            document.getElementById('balSHIB').innerText = parseFloat(ethers.formatUnits(balShib, 18)).toFixed(2);

            const credEth = await gameContract.userCredits(userAddress, 0);
            document.getElementById('credETH').innerText = parseFloat(ethers.formatEther(credEth)).toFixed(4);

            const credUsdt = await gameContract.userCredits(userAddress, 1);
            document.getElementById('credUSDT').innerText = parseFloat(ethers.formatUnits(credUsdt, 6)).toFixed(2);

            const credShib = await gameContract.userCredits(userAddress, 2);
            document.getElementById('credSHIB').innerText = parseFloat(ethers.formatEther(credShib)).toFixed(2);

        } catch (e) { console.error("Dashboard Error", e); }
    }

    function disconnectWallet() {
        localStorage.removeItem(`auth_${userAddress}`);
        location.reload();
    }

    function copyRefLink() {
        navigator.clipboard.writeText(document.getElementById('displayRefLink').innerText);
        showToast("Link Copied");
    }

    async function registerUser() {
        const nick = document.getElementById('regNickname').value;
        try {
            const tx = await gameContract.register(nick, detectedReferrer || "");
            await tx.wait();
            closeModal('registerModal');
            finalizeLogin();
        } catch (e) { showToast("Reg Failed: " + (e.reason || e.message)); }
    }

    async function claimReferralBonus() {
        try {
            const tx = await gameContract.claimReferralBonus();
            await tx.wait();
            showToast("Bonus Claimed!");
            refreshGameData();
        } catch (e) { showToast("Claim Failed"); }
    }

    function switchTab(tab) {

        if (tab === 'global') {

            document.getElementById('tabGlobal').classList.remove('hidden');

            document.getElementById('tabPersonal').classList.add('hidden');

            document.querySelectorAll('.tab-btn')[0].classList.add('active');

            document.querySelectorAll('.tab-btn')[1].classList.remove('active');

        } else {

            document.getElementById('tabGlobal').classList.add('hidden');

            document.getElementById('tabPersonal').classList.remove('hidden');

            document.querySelectorAll('.tab-btn')[0].classList.remove('active');

            document.querySelectorAll('.tab-btn')[1].classList.add('active');

            updatePersonalHistory(); 

        }

    }



    async function updateHistorySection(roundIdFromContract) {

        currentMaxRound = Number(roundIdFromContract);

        const historyList = document.getElementById('historyList');



        if (isInitialLoad) {

            historyList.innerHTML = ''; 

            historyCursor = currentMaxRound - 1; 

            await fetchBatchHistory(10); 

            isInitialLoad = false;

        } else {

            // Realtime update: Cukup refresh 10 data teratas agar sinkron

            const firstCard = historyList.firstElementChild;

            if (firstCard) {

                historyList.innerHTML = '';

                historyCursor = currentMaxRound - 1;

                await fetchBatchHistory(10);

            }

        }

    }



    async function loadMoreHistory() {

        const btn = document.getElementById('btnLoadMore');

        btn.innerText = "Loading...";

        btn.disabled = true;

        await fetchBatchHistory(15);

        btn.innerText = "Load Previous Rounds (15)";

        btn.disabled = false;

    }

    async function fetchBatchHistory(count) {
        const historyList = document.getElementById('historyList');
        if (historyCursor < 1) {
            document.getElementById('btnLoadMore').style.display = 'none';
            return;
        }

        const start = historyCursor;
        const end = Math.max(1, historyCursor - count + 1);

        for (let r = start; r >= end; r--) {
            try {
                const result = await gameContract.getRoundResult(r);
                const formattedText = formatOutcomeText(result[1], result[0]);

                const card = document.createElement('div');
                card.className = 'history-card';
                card.id = `history-card-${r}`;
                
                card.innerHTML = `
                    <div style="font-size:0.8em; color:#aaa; margin-bottom:5px;">
                        Round #${r} ‚Ä¢ ${new Date(Number(result[2]) * 1000).toLocaleTimeString()}
                    </div>
                    <div class="history-reels">
                        <img class="history-reel-img" src="${IMAGE_LIST[Number(result[0][0])]}">
                        <img class="history-reel-img" src="${IMAGE_LIST[Number(result[0][1])]}">
                        <img class="history-reel-img" src="${IMAGE_LIST[Number(result[0][2])]}">
                    </div>
                    <div class="history-outcome" style="margin-top:5px;">${formattedText}</div>
                    
                    <div id="winner-info-${r}" style="margin-top:8px; border-top:1px dashed #444; padding-top:5px;">
                        <span style="font-size:0.7em; color:#666;">Loading winner data...</span>
                    </div>
                `;
                historyList.appendChild(card);

                // Fetch winner async
                findAndDisplayWinner(r);

            } catch (err) {
                console.log(`Skip history round ${r}`, err);
            }
        }
        historyCursor = end - 1;
        if (historyCursor < 1) document.getElementById('btnLoadMore').style.display = 'none';
    }

    async function findAndDisplayWinner(roundId) {
        const container = document.getElementById(`winner-info-${roundId}`);
        if (!container) return;

        try {
            // 1. Cari Block Number dari BattleResult
            // Kita cari range block luas agar pasti ketemu
            const battleFilter = gameContract.filters.BattleResult(null, null, roundId);
            
            // NOTE: Base Sepolia menyimpan log cukup lama, kita coba tarik 50.000 block terakhir
            // Jika ini gagal di console, berarti RPC limit.
            const battleEvents = await gameContract.queryFilter(battleFilter, -50000); 

            if (battleEvents.length === 0) {
                container.innerHTML = '<span style="font-size:0.7em; color:#444;">Data too old/archived</span>';
                return;
            }

            const exactBlock = battleEvents[0].blockNumber;

            // 2. Cari WinDistributed di Block yang SAMA
            const winFilter = gameContract.filters.WinDistributed();
            const winEvents = await gameContract.queryFilter(winFilter, exactBlock, exactBlock);

            if (winEvents.length === 0) {
                container.innerHTML = '<span style="font-size:0.7em; color:#666;">No Winners (Pool Accumulated)</span>';
                return;
            }

            // 3. Proses Data Winner (Agregat Total)
            let totalPayoutETH = 0n;
            let totalPayoutUSDT = 0n;
            let totalPayoutSHIB = 0n;
            let biggestWinnerAddr = "";
            let biggestWinAmount = 0n;
            let biggestWinCurr = 0; // default eth

            for(let evt of winEvents) {
                const args = evt.args;
                const amt = args[1]; // BigInt
                const curr = Number(args[2]);

                if (curr === 0) totalPayoutETH += amt;
                else if (curr === 1) totalPayoutUSDT += amt;
                else if (curr === 2) totalPayoutSHIB += amt;

                // Cari winner terbesar untuk ditampilkan namanya
                // (Logic sederhana: kita anggap ETH base currency comparison atau ambil winner pertama aja)
                if (amt > biggestWinAmount) {
                    biggestWinAmount = amt;
                    biggestWinnerAddr = args[0];
                    biggestWinCurr = curr;
                }
            }

            // Ambil Nickname Pemenang Terbesar
            let nick = "Unknown";
            try {
                const uData = await gameContract.users(biggestWinnerAddr);
                nick = uData[0];
            } catch {}

            // Format Teks Total
            let payoutText = "";
            if(totalPayoutETH > 0n) payoutText += `${parseFloat(ethers.formatEther(totalPayoutETH)).toFixed(4)} ETH `;
            if(totalPayoutUSDT > 0n) payoutText += `${parseFloat(ethers.formatUnits(totalPayoutUSDT, 6)).toFixed(2)} USDT `;
            if(totalPayoutSHIB > 0n) payoutText += `${parseFloat(ethers.formatUnits(totalPayoutSHIB, 18)).toLocaleString()} SHIB`;

            container.innerHTML = `
                <div class="winner-info-box" style="display:block;">
                    <div style="color:var(--gold); font-weight:bold; font-size:0.8em;">
                        üèÜ ${nick} <span style="font-weight:normal; color:#888;">(${biggestWinnerAddr.substring(0,4)}...)</span>
                    </div>
                    <div style="color:white; font-size:0.75em; margin-top:2px;">
                        Total Win: <span style="color:var(--success);">${payoutText}</span>
                    </div>
                </div>
            `;

        } catch (e) {
            console.error(`Error finding winner for round ${roundId}:`, e);
            container.innerHTML = '';
        }
    }

   async function updatePersonalHistory() {
        const list = document.getElementById('personalHistoryList');
        
        if (!isConnected || !userAddress) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Connect Wallet first</div>';
            return;
        }

        list.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">Scanning last 24h history...</div>';
        
        try {
            const currentBlock = await provider.getBlockNumber();
            // PERUBAHAN: Range diperbesar ke 50.000 Blok (~28 Jam di Base)
            const fromBlock = Math.max(0, currentBlock - 50000); 

            // 1. Ambil Event Bet
            const betFilter = gameContract.filters.NewBet(userAddress);
            const myBets = await gameContract.queryFilter(betFilter, fromBlock, "latest");
            
            if (myBets.length === 0) {
                list.innerHTML = `
                    <div style="text-align:center; padding:20px; color:#666;">
                        No bets found in last 50k blocks.<br>
                        <small>(Try betting on a new round)</small>
                    </div>`;
                return;
            }

            // 2. Cache Result Global (Optimasi: Hanya fetch jika belum ada)
            if (cachedBattleResults.length === 0) {
                const resFilter = gameContract.filters.BattleResult();
                cachedBattleResults = await gameContract.queryFilter(resFilter, fromBlock, "latest");
            }

            const reversedBets = myBets.reverse();
            list.innerHTML = ''; 

            for (let bet of reversedBets) {
                const args = bet.args;
                const animalIdx = Number(args[1]);
                const betBlock = bet.blockNumber; 
                const animalName = IMAGE_NAMES[animalIdx] ? IMAGE_NAMES[animalIdx].toUpperCase() : "UNKNOWN";

                // Matching Logic
                let matchedRound = null;
                cachedBattleResults.sort((a,b) => a.blockNumber - b.blockNumber);

                for (let res of cachedBattleResults) {
                    if (res.blockNumber > betBlock) {
                        matchedRound = res;
                        break;
                    }
                }

                if (!matchedRound) {
                    // Tampilkan Pending
                    const el = document.createElement('div');
                    el.className = 'personal-bet-card';
                    el.style.borderLeft = '3px solid #666';
                    el.innerHTML = `
                        <div class="pb-info">
                            <div class="pb-time">Block: ${betBlock} (Waiting Draw)</div>
                            <div>Bet: <span class="pb-animal" style="color:white;">${animalName}</span></div>
                        </div>
                        <span class="badge" style="background:#222; border:1px solid #444;">PENDING</span>
                    `;
                    list.appendChild(el);
                    continue;
                }

                // Kalkulasi Hasil
                const rArgs = matchedRound.args;
                const reels = rArgs[0].map(Number);
                const isWin = reels.includes(animalIdx);
                
                // Panggil Helper Format Teks untuk hasil result
                // Kita panggil fungsi format yang BARU tadi (namun perlu rawOutcome string)
                // Karena kita tidak punya rawOutcome string di event BattleResult (hanya di struct),
                // Kita generate manual stringnya untuk display simple:
                const resDisplay = `${IMAGE_NAMES[reels[0]]}-${IMAGE_NAMES[reels[1]]}-${IMAGE_NAMES[reels[2]]}`.toUpperCase();

                const statusHtml = isWin 
                    ? `<span class="badge badge-win">VICTORY</span>` 
                    : `<span class="badge badge-lose">DEFEAT</span>`;

                const el = document.createElement('div');
                el.className = 'personal-bet-card';
                el.style.borderLeftColor = isWin ? 'var(--success)' : 'var(--danger)';
                
                el.innerHTML = `
                    <div class="pb-info">
                        <div class="pb-time">Round Done (Blk ${matchedRound.blockNumber})</div>
                        <div>Your Bet: <span class="pb-animal">${animalName}</span></div>
                        <div style="font-size:0.7em; color:#aaa; margin-top:2px;">Result: ${resDisplay}</div>
                    </div>
                    <div style="text-align:right;">
                        ${statusHtml}
                        <img src="${IMAGE_LIST[animalIdx]}" style="width:25px; height:25px; display:block; margin-top:5px; margin-left:auto;">
                    </div>
                `;
                list.appendChild(el);
            }

        } catch (e) {
            console.error("History Error:", e);
            list.innerHTML = `<div style="text-align:center; padding:10px; color:var(--danger);">Network Limit. Try refreshing.</div>`;
        }
   }
    
    // Helper: Format Teks Outcome yang Lebih Cerdas
    function formatOutcomeText(rawOutcome, reels) {
        const r0 = Number(reels[0]);
        const r1 = Number(reels[1]);
        const r2 = Number(reels[2]);
        
        const getN = (idx) => {
            if (idx === 6) return "Zonk"; 
            if (!IMAGE_NAMES[idx]) return "Unknown";
            return IMAGE_NAMES[idx].charAt(0).toUpperCase() + IMAGE_NAMES[idx].slice(1);
        };

        const n0 = getN(r0);
        const n1 = getN(r1);
        const n2 = getN(r2);

        if (rawOutcome === "TRIPLE") {
            return `<span style="color:var(--gold); font-weight:bold;">${n0} (TRIPLE)</span>`;
        } 
        else if (rawOutcome === "DOUBLE") {
            // Logika: Cari mana yang kembar, mana yang beda
            let doubleName = "";
            let singleName = "";

            if (r0 === r1) { doubleName = n0; singleName = n2; }
            else if (r1 === r2) { doubleName = n1; singleName = n0; }
            else { doubleName = n0; singleName = n1; } // r0 === r2

            return `<span style="color:var(--accent);">${doubleName} (Double)</span> - ${singleName}`;
        } 
        else if (rawOutcome === "ONE_ZONK") {
            return `${n0} - <span style="color:var(--danger)">Zonk</span> - ${n2}`;
        } 
        else {
            // NO_MATCH
            return `${n0} - ${n1} - ${n2}`;
        }
    }

    function setupEventListeners() {
        gameContract.on("NewBet", () => {
            refreshGameData();
        });

        gameContract.on("BattleResult", (reels, outcome, roundId) => {
            checkRoundResult(Number(roundId));
        });
    }

</script>
</body>
    </html>
