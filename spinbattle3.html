<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root {
    --purple-main: #6200ff;
    --purple-light: #6c00ff;
    --purple-dark: #1a0040;
    --blue-main: #00b3ff;
    --pink-main: #ff00e6;
    --cyan-main: #00ffff;
    --red-main: #c0392b;
    --bg-dark-1: #0b0b12;
    --bg-dark-2: #000;
    --bg-modal: #0d0d1a;
    --border-color: rgba(120, 0, 255, 0.4);
  }
  body {
  margin: 0;
  min-height: 100vh; /* Gunakan min-height, bukan height fix */
  background: radial-gradient(circle at center, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
  font-family: "Ubuntu", sans-serif;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  /* justify-content: center; Hapus ini agar konten mulai dari atas */
  padding: 20px 0; /* Beri sedikit ruang atas bawah */
  overflow-x: hidden; /* Hanya sembunyikan scroll horizontal jika perlu */
  overflow-y: auto; /* Izinkan scroll vertikal */
  }

/* === HERO SECTION STYLES (SIMPLE) === */
#hero-section {
    position: relative;
    width: 100%;
    min-height: 20vh; /* Tinggi sesuai permintaan */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding-top: 80px;
    padding-bottom: 40px;
    background: var(--bg-dark-2);
    border-bottom: 1px solid rgba(120, 0, 255, 0.2); /* Garis pemisah halus di bawah */
}

/* Latar Belakang Statis yang Ringan */
.hero-static-bg {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0;
    opacity: 0.4;
    /* Pola grid halus statis */
    background-image: 
        linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
    background-size: 30px 30px;
}

/* Konten Hero (Box Title) */
.hero-content {
    position: relative; z-index: 1;
    text-align: center; max-width: 800px; padding: 30px;
    background: rgba(10, 10, 25, 0.5); /* Latar sedikit lebih gelap */
    backdrop-filter: blur(5px); /* Blur ringan */
    border-radius: 15px;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Bayangan agar menonjol */
}

.hero-title {
    background: #000;
    font-size: 2rem; font-weight: 700; margin: 0 0 15px 0;
    font-family: "Ubuntu", sans-serif;
    letter-spacing: 2px; line-height: 1.1;
}
.hero-title .highlight-text {
    background: linear-gradient(90deg, #03a9f4, #f441a5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
    display: block;
}
.hero-subtitle {
    font-size: 1.1rem; color: #ccc; margin: 0 auto 30px auto;
    max-width: 600px; line-height: 1.5;
}

/* Tombol CTA */
.hero-cta-container { display: inline-block; cursor: pointer; }
.play-now-btn {
    background: linear-gradient(90deg, var(--pink-main), var(--blue-main)); color: #ffffff; /* Warna solid langsung */
    border: none; padding: 12px 35px;
    font-size: 16px; font-weight: bold; letter-spacing: 1px;
    border-radius: 12px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; align-items: center; gap: 8px;
}
.play-now-btn:hover {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4);
}
.arrow-icon { font-size: 1.2em; }

/* Responsif Ponsel */
@media (max-width: 768px) {
    .hero-title { font-size: 2.2rem; }
    .hero-subtitle { font-size: 1rem; }
    .hero-content {
        width: 90%;
        padding: 20px;
        margin: 0 auto; /* Tambahkan ini agar simetris di tengah */
        box-sizing: border-box; /* Pastikan padding tidak menambah lebar total */
    }
}

  /* Mode PC (layar besar) */
@media (min-width: 1024px) {
  #hero-section {
    min-height: 5vh; /* lebih pendek di PC */
    padding-top: 60px;
    padding-bottom: 20px;
  }
}

  .app-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  .lists-wrapper {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-top: 20px;
      width: 90%;
      max-width: 820px;
  }

  /* === [DIUBAH] Wallet Buttons Container === */
  .wallet-container {
    position: fixed;
    top: 20px;
    right: 25px;
    display: flex;
    gap: 10px;
    z-index: 1001;
  }
  .wallet-btn, .referral-btn {
    background: linear-gradient(90deg, var(--purple-main), var(--blue-main));
    border: none; border-radius: 12px; color: white;
    font-size: 14px; font-weight: bold; padding: 10px 20px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 15px var(--blue-main);
    transition: all 0.3s ease;
  }
  .wallet-btn:hover, .referral-btn:hover { 
      box-shadow: 0 0 25px var(--pink-main); 
      transform: scale(1.05); 
  }
  
  /* [BARU] Tombol Referral */
  .referral-btn {
      background: linear-gradient(90deg, var(--pink-main), var(--blue-main));
      display: none; /* Sembunyi sampai connect */
  }

  /* Mengganti style .wallet-info lama agar sesuai di dalam modal */
  #walletInfo {
    font-size: 14px;
    line-height: 1.6;
    color: #ccc;
  }
  #walletInfo p { margin: 8px 0; }
  #walletInfo span { color: var(--cyan-main); font-weight: bold; }
  #walletInfo hr {
      border: none;
      height: 1px;
      background-color: var(--border-color);
      margin: 12px 0;
  }

  /* [BARU] Style untuk tombol Disconnect */
  .modal-btn-disconnect {
      background: linear-gradient(90deg, var(--pink-main), var(--red-main));
      box-shadow: 0 0 20px var(--pink-main);
  }
  .modal-btn-disconnect:hover {
      box-shadow: 0 0 25px var(--red-main);
  }

  /* === [PERBAIKAN] Memindahkan Modal Wallet ke Pojok Kanan Atas === */

#wallet-modal {
    /* 1. Hapus pemusatan dari class .modal */
    top: 65px;  /* (Tombol 20px + Jarak 45px) */
    left: auto;
    right: 25px;
    
    /* 2. Hapus transform pemusatan & scaling */
    transform: none;

    /* 3. Atur ulang animasi 'show/hide' agar muncul dari atas (bukan zoom) */
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

/* 4. Ganti animasi .modal.show */
#wallet-modal.show {
    transform: translateY(0);
    opacity: 1;
}

/* 5. Hapus latar belakang gelap HANYA untuk modal ini */
#wallet-modal-overlay.show {
     background: transparent;
     backdrop-filter: none;
}

  /* === Controls (Tidak Berubah) === */
  .controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 250px; 
  }
  .main-btn {
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    padding: 12px 30px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s ease;
    width: 100%;
  }
  #placeBetBtn {
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    box-shadow: 0 0 20px var(--blue-main);
  }
  #placeBetBtn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.05); }
  #finalizeBtn {
    background: linear-gradient(90deg, var(--pink-main), var(--blue-main));
    box-shadow: 0 0 20px var(--pink-main);
    display: none;
  }
  #finalizeBtn:hover { box-shadow: 0 0 25px var(--red-main); transform: scale(1.05); }
  .main-btn:disabled {
    background: #555;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
  }
  .status {
    font-size: 13px;
    margin-top: 8px;
    color: var(--blue-main);
    min-height: 1.2em;
    text-align: center;
    max-width: 320px;
  }
  .timer {
      font-size: 16px;
      font-weight: bold;
      color: var(--cyan-main);
      margin-top: 10px;
      height: 20px;
  }

  /* === Bet & Winner Lists (Tidak Berubah) === */
  .list-container {
    width: 100%;
    max-width: 400px;
    max-height: 350px; 
    background: rgba(10, 10, 20, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  .list-container h3 {
    margin: 0 0 10px 0; font-size: 14px;
    color: var(--blue-main); text-align: center;
    text-transform: uppercase;
  }
  .bet-list-item, .winner-list-item {
    background: rgba(20, 20, 40, 0.7);
    border-radius: 4px; padding: 8px 10px;
    margin-bottom: 6px; font-size: 12px;
  }
  .bet-list-item {
    display: flex; justify-content: space-between;
    align-items: center;
  }
  .bet-list-item .player-id { font-weight: bold; color: var(--cyan-main); }
  .bet-list-item .player-bets { text-align: right; color: #eee; }
  .winner-list-item .winner-id {
    font-weight: bold;
    color: var(--cyan-main);
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .winner-list-item .winner-id span {
      font-weight: normal;
      color: #aaa;
  }
  .winner-list-item .prize-line {
      font-size: 11px;
      color: #eee;
  }
  #bet-list-placeholder, #winner-list-placeholder {
    text-align: center; font-size: 13px;
    color: #888; padding-top: 20px;
  }

  @media (min-width: 768px) {
  .list-container {
    max-height: 400px; /* Tinggi maksimal lebih besar di PC */
    /* Atau gunakan height tetap jika ingin selalu tinggi: */
    /* height: 400px; */
  }
  }
  
  /* === Modal Base (Digunakan oleh Bet & Referral) === */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999; display: none; opacity: 0;
    transition: opacity 0.3s ease;
  }
  .modal { /* [DIUBAH] Nama kelas generik */
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 380px;
    background: var(--bg-modal);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 0 40px rgba(180, 0, 255, 0.3);
    z-index: 1000; display: none; opacity: 0;
    transition: all 0.3s ease;
  }
  .modal-overlay.show, .modal.show { display: block; opacity: 1; }
  .modal.show { transform: translate(-50%, -50%) scale(1); }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2);
  }
  .modal-header h2 { margin: 0; font-size: 20px; color: var(--blue-main); }
  .modal-close-btn {
    font-size: 28px; font-weight: bold; color: #fff;
    cursor: pointer; line-height: 1; background: none; border: none;
  }
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .balance-display, .limits-display { font-size: 13px; color: #999; line-height: 1.5; }
  .limits-display p { margin: 2px 0; }
  .balance-display span, .limits-display span { font-weight: bold; color: var(--cyan-main); }
  .input-group { display: flex; gap: 10px; }
  .input-group input, .input-group select {
    background: #06060c;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: #fff;
    font-family: "Ubuntu", sans-serif;
    font-size: 16px;
    padding: 10px 12px;
  }
  .input-group input { flex-grow: 1; width: 65%; }
  .input-group select { width: 35%; }
  .percent-buttons { display: flex; justify-content: space-between; gap: 8px; }
  .percent-btn {
    flex: 1; background: rgba(120, 0, 255, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px; color: #fff;
    padding: 8px 10px; font-size: 13px;
    cursor: pointer; transition: background 0.2s ease;
  }
  .percent-btn:hover { background: rgba(120, 0, 255, 0.4); }
  .modal-footer { padding: 20px; border-top: 1px solid rgba(120, 0, 255, 0.2); }
  
  /* Tombol di footer modal */
  .modal-btn {
    width: 100%;
    background: linear-gradient(90deg, var(--blue-main), var(--pink-main));
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: bold; padding: 12px 30px;
    cursor: pointer; text-transform: uppercase;
    box-shadow: 0 0 20px var(--blue-main);
    transition: all 0.3s ease;
  }
  .modal-btn:hover { box-shadow: 0 0 25px var(--pink-main); transform: scale(1.02); }
  .modal-btn:disabled {
    background: #555; color: #999;
    box-shadow: none; transform: none; cursor: not-allowed;
  }
  
  /* === Style Khusus Modal Referral === */

/* Body modal agar lebih rapi */
#referral-modal .modal-body {
    display: flex;
    flex-direction: column;
    gap: 20px; /* Jarak antar section */
    padding-bottom: 10px; /* Sedikit jarak sebelum footer */
}

/* Section dalam referral */
.ref-section {
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(120, 0, 255, 0.2); /* Garis pemisah lebih terlihat */
}

.ref-section:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.ref-section h3 {
    font-size: 15px;
    color: var(--cyan-main);
    margin: 0 0 10px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Kotak info (My Info, Rewards) */
.ref-info {
    background: rgba(0, 0, 0, 0.2);
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    color: #ccc;
    line-height: 1.6;
}

.ref-info span {
    color: #fff;
    font-weight: bold;
}

/* Input khusus link referral agar terlihat beda */
#referralLinkInput {
    background: rgba(0, 255, 255, 0.1);
    border-color: var(--cyan-main);
    color: var(--cyan-main);
    font-size: 12px;
    cursor: pointer;
}

  #nicknameInput {
    background: rgba(0, 255, 255, 0.1);
    border-color: var(--cyan-main);
    color: #fff;
    font-size: 15px;

  }

/* Footer khusus untuk tombol Claim */
#referral-modal .modal-footer {
    padding: 15px 20px;
    border-top: 1px solid rgba(120, 0, 255, 0.2);
    background: rgba(0, 0, 0, 0.2); /* Sedikit lebih gelap */
}

/* Tombol Claim memenuhi lebar */
#claimRewardsBtn {
    width: 100%;
    padding: 12px;
    font-size: 16px;
}

  /* === Cyberpunk Data Box Style === */
.ref-info {
    position: relative;
    /* Latar gelap dengan sedikit transparansi */
    background: linear-gradient(90deg, rgba(5, 5, 16, 0.9) 0%, rgba(10, 10, 30, 0.8) 100%);
    /* Border kiri tebal berwarna cyan (var(--cyan-main) jika ada, atau #00ffff) */
    border-left: 4px solid #00ffff; 
    border-top: 1px solid rgba(0, 255, 255, 0.2);
    border-bottom: 1px solid rgba(0, 255, 255, 0.2);
    /* Efek sudut terpotong di kanan atas */
    clip-path: polygon(0 0, 95% 0, 100% 15%, 100% 100%, 0 100%);
    padding: 15px 20px;
    margin-bottom: 15px;
    color: #aaccff; /* Warna teks label agak kebiruan */
    font-family: 'Courier Prime', 'Courier New', monospace; /* Font gaya terminal */
    font-size: 13px;
    letter-spacing: 0.5px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); /* Bayangan luar */
    overflow: hidden;
}

/* Efek garis scanline halus berjalan di background */
.ref-info::before {
    content: "";
    position: absolute;
    top: -50%; left: 0;
    width: 100%; height: 20px;
    background: linear-gradient(to bottom, transparent, rgba(0, 255, 255, 0.1), transparent);
    animation: scanline 4s linear infinite;
    pointer-events: none;
}

/* Styling khusus untuk nilai data (span) */
.ref-info span {
    color: #ff00e6; /* Warna Pink Neon untuk data penting */
    font-weight: 700;
    text-shadow: 0 0 8px rgba(255, 0, 230, 0.6); /* Efek glow pada teks data */
    float: right; /* [OPSIONAL] Agar data rata kanan rapi */
}

/* Animasi Scanline */
@keyframes scanline {
    0% { top: -50%; opacity: 0; }
    50% { opacity: 1; }
    100% { top: 150%; opacity: 0; }
}

  /* === Donut Wheel Section === */
.donut-wrap {
  display: flex;
  gap: 16px;
  align-items: center;
  justify-content: center;
  margin-top: 12px;
  flex-wrap: wrap;
  position: relative;
}

#donutCanvas {
  background: linear-gradient(90deg, #03a9f4, #f441a5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  border-radius: 50%;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
}

.donut-pointer {
  position: absolute;
  top: 15px; /* Sesuaikan sedikit agar pas di atas donut */
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-top: 30px solid var(--blue-main); 
  z-index: 10;
  filter: drop-shadow(0 -2px 5px rgba(0, 179, 255, 0.7)); 
}

  @media (min-width: 768px) {
  #donutCanvas {
    /* Ubah ukuran sesuai keinginan Anda, misalnya 500px */
    width: 500px !important;
    height: 500px !important;
  }

  /* === [BARU] Style untuk Fitur Sosial === */
.winner-social {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(120, 0, 255, 0.2);
}

.like-btn {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}
.like-btn.liked {
    color: var(--pink-main); /* Warna pink saat di-like */
}
.like-btn:hover {
    color: #fff;
}

.rating-stars {
    display: flex;
    gap: 2px;
}
.star {
    color: #555;
    cursor: pointer;
    font-size: 16px;
    transition: color 0.2s ease;
}
.star.active, .star:hover {
    color: gold; /* Warna emas untuk bintang aktif */
}

  /* === [BARU] Gaya Komentar Futuristik (Terminal) === */

/* Container terminal utama */
.comments-terminal {
    background: rgba(0, 0, 0, 0.8); /* Latar lebih gelap agar teks terminal terbaca */
    border: 1px solid var(--purple-main);
    border-radius: 6px;
    padding: 10px;
    font-family: 'Courier Prime', monospace; /* Font monospace penting untuk gaya terminal */
    font-size: 12px;
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
    max-height: 300px; /* Batasi tinggi agar tidak terlalu panjang */
    overflow-y: auto; /* Scroll jika komentar banyak */
}

/* Header terminal (misal: > LOG FOR WINNER...) */
.terminal-header {
    color: var(--cyan-main);
    border-bottom: 1px dashed var(--purple-main);
    padding-bottom: 4px;
    margin-bottom: 10px;
    font-size: 10px; 
    opacity: 0.8;
    letter-spacing: 1px;
}

/* Blok satu komentar individu */
.comment-log {
    margin-bottom: 12px;
    padding-left: 8px;
    border-left: 2px solid var(--blue-main); /* Indikator garis di kiri */
}

/* Metadata komentar (Nickname, Waktu, Wallet) */
.log-meta { 
    color: #888; 
    font-size: 10px; 
    margin-bottom: 2px; 
}
.log-nickname { 
    color: var(--pink-main); /* Nickname warna pink neon */
    font-weight: bold; 
}
.log-wallet { 
    color: #555; 
}

/* Isi pesan komentar */
.log-message { 
    color: #eee; 
    line-height: 1.4; 
    white-space: pre-wrap; /* Agar enter/baris baru terbaca */
}

/* Input gaya terminal */
.terminal-input {
    flex-grow: 1; /* Mengisi sisa ruang */
    background: rgba(0,0,0,0.3);
    border: none; 
    border-bottom: 1px solid var(--cyan-main);
    color: var(--cyan-main);
    font-family: 'Courier Prime', monospace;
    padding: 4px 6px; 
    outline: none;
    font-size: 12px;
}
.terminal-input::placeholder {
    color: rgba(0, 255, 255, 0.3);
}

/* Tombol gaya terminal ([ SEND ], [ EDIT LOG ], dll) */
.terminal-btn {
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--cyan-main);
    color: var(--cyan-main); 
    padding: 3px 8px; 
    font-size: 10px;
    cursor: pointer; 
    font-family: 'Courier Prime', monospace;
    transition: all 0.2s ease;
}
.terminal-btn:hover { 
    background: var(--cyan-main); 
    color: #000; /* Teks jadi hitam saat hover agar kontras */
}

  .log-message { 
    /* ... */
    white-space: pre-wrap; /* Ini yang membuat baris baru (enter) terlihat */
  }

/* === [BARU] Navbar Glassmorphism === */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 30px;
    box-sizing: border-box;
    z-index: 1000;

    /* Efek Glassmorphism */
    background: rgba(10, 10, 25, 0.6); /* Latar belakang transparan gelap */
    backdrop-filter: blur(12px); /* Efek blur di belakangnya */
    border-bottom: 1px solid rgba(120, 0, 255, 0.3); /* Garis batas halus */
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); /* Bayangan lembut */
}

.navbar-logo {
    font-family: "Ubuntu", sans-serif;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
    /* Anda bisa menambahkan <img> di sini jika punya file logo */
}

.navbar-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

/* Hapus style .wallet-container yang lama karena sudah tidak dipakai */
/* .wallet-container { ... }  <-- HAPUS INI */

/* Sesuaikan posisi modal wallet agar pas di bawah navbar */
#wallet-modal {
    top: 80px; /* 70px navbar + 10px jarak */
    right: 25px;
    /* ... (sisa style modal tetap sama) ... */
}

  /* ===== Minimal Footer Style ===== */
  footer {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        background: #000; /* Warna gelap */
        color: #ddd; /* Warna teks */
        font-size: 12px;
    }

    .social-icons {
        margin-bottom: 10px;
    }

    .social-icons a {
    background: rgba(255, 255, 255, 0.2); /* Transparan seperti kaca */
    border-radius: 10px; /* Agar sedikit membulat */
    padding: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white; /* Warna ikon */
    font-size: 15px;
    margin: 0 5px;
    text-decoration: none;
    transition: transform 0.5s ease, text-shadow 0.5s ease, box-shadow 0.5s ease;
    box-shadow: 0 0 10px rgba(0, 0, 255, 0.6); /* Cahaya biru */
    backdrop-filter: blur(10px); /* Efek blur kaca */
}

/* Efek saat hover */
.social-icons a:hover {
    color: #1a88ff; /* Warna biru neon */
    text-shadow: 0 0 10px #1a88ff, 0 0 20px #1a88ff, 0 0 30px #1a88ff; /* Glow lebih intens */
    box-shadow: 0 0 20px rgba(0, 0, 255, 1), 0 0 30px rgba(0, 0, 255, 0.8); /* Shadow lebih terang */
    transform: rotate(360deg); /* Efek berputar */
}
</style>
</head>

<body>
   <nav class="navbar">
      <div class="navbar-logo">
    <img src="logo.svg" alt="Faylotto Logo" style="height: 40px; margin-right: 10px;">
    <span style="font-weight:bold; font-size:20px; color:var(--cyan-main);"></span></div>
      <div class="navbar-actions">
          <button class="referral-btn" id="referralBtn">Referral</button>
          <button class="wallet-btn" id="walletBtn">Connect Wallet</button>
      </div>
   </nav>

  <div class="modal-overlay" id="wallet-modal-overlay"></div>
  <div class="modal" id="wallet-modal">
    <div class="modal-header">
      <h2>Wallet Info</h2>
      <button class="modal-close-btn" id="wallet-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body" id="walletInfo"> 
      <p>Address: <span id="walletAddress">-</span></p>
      <p>Balance (ETH): <span id="ethBalance">0</span></p>
      <p>Balance (USDT): <span id="usdtBalance">0</span></p>
      <hr/>
      <p>My Deposits (ETH): <span id="myEthDeposit">0</span></p>
      <p>My Deposits (USDT): <span id="myUsdtDeposit">0</span></p>
    </div>
    <div class="modal-footer">
      <button id="disconnectBtn" class="modal-btn modal-btn-disconnect">Disconnect</button>
    </div>
  </div>

  <section id="hero-section">
    <div class="hero-static-bg"></div>
    
    <div class="hero-content">
        <h2 class="hero-title">
         <span class="highlight-text">Faylotto Spin Battle</span></h2>
        <p class="hero-subtitle">
            Putar roda keberuntungan pertarungan di jaringan terdesentralisasi. Adil, transparan, dan otomatis.
        </p>
        
        <div class="hero-cta-container" onclick="document.querySelector('.app-body').scrollIntoView({behavior: 'smooth'})">
            <button class="play-now-btn">
                PLAY NOW! <span class="arrow-icon">↓</span>
            </button>
        </div>
    </div>
  </section>

  <div class="app-body" style="margin-top: 80px;"> 
      
      </div>

    <div class="donut-wrap">
        <div class="donut-pointer"></div>
        <canvas id="donutCanvas" width="360" height="360"></canvas>
    </div>

    <div class="controls">
      <button id="placeBetBtn" class="main-btn">Place Bet</button>
      <button id="finalizeBtn" class="main-btn">Finalize Round</button>
      <div class="status" id="statusText">Wallet not connected</div>
      <div class="timer" id="timerText"></div>
    </div>
    
    <div class="lists-wrapper">
      <div id="bet-list-container" class="list-container">
          <h3>Current Round Bets</h3>
          <div id="bet-list">
              <p id="bet-list-placeholder">No bets placed yet in this round.</p>
          </div>
      </div>
      
      <div id="winner-list-container" class="list-container">
          <h3>Recent Winners</h3>
          <div id="winner-list">
              <p id="winner-list-placeholder">No winners yet.</p>
          </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="bet-modal-overlay"></div>
  <div class="modal" id="bet-modal">
    <div class="modal-header">
      <h2>Place Your Bet</h2>
      <button class="modal-close-btn" id="bet-modal-close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="balance-display">
        <p>Your Balance:<br/>
          <span id="modalEthBalance">0</span> ETH<br/>
          <span id="modalUsdtBalance">0</span> USDT
        </p>
      </div>
      <div class="limits-display"> <p>Mins: <span>0.00005 ETH</span> / <span>0.5 USDT</span></p>
        <p>Max Total: <span>0.00256 ETH</span> / <span>10 USDT</span></p>
        <p>Max Bets: <span>2 per round</span></p>
      </div>
      <div class="input-group">
        <input type="number" id="betAmountInput" placeholder="Custom Amount">
        <select id="betCurrencySelect">
          <option value="ETH">ETH</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      <div class="percent-buttons">
        <button class="percent-btn" data-percent="0.10">10%</button>
        <button class="percent-btn" data-percent="0.25">25%</button>
        <button class="percent-btn" data-percent="0.50">50%</button>
        <button class="percent-btn" data-percent="0.57">57%</button>
      </div>
    </div>
    <div class="modal-footer">
      <button id="confirmBetBtn" class="modal-btn">Confirm Bet</button>
    </div>
  </div>
  
  <div class="modal-overlay" id="referral-modal-overlay"></div>

<div class="modal" id="referral-modal">

    <div class="modal-header">

        <h2>Referral System</h2>

        <button class="modal-close-btn" id="referral-modal-close-btn">&times;</button>

    </div>



    <div class="modal-body">

        <div class="ref-section">

            <h3>My Info</h3>

            <div class="ref-info">

                My Nickname: <span id="myNickname">-</span><br/>

                My Referrer: <span id="myReferrer">-</span>

            </div>

        </div>



        <div class="ref-section">

            <h3>Create Nickname to Get Referral Link</h3>

            <div class="input-group">

                <input type="text" id="nicknameInput" placeholder="Enter your nickname">

            </div>

            <button id="createNicknameBtn" class="modal-btn" style="margin-top: 10px;">Create Nickname</button>

        </div>



        <div class="ref-section" id="referralLinkSection" style="display: none;">

            <h3>Your Referral Link</h3>

            <div class="input-group">

                <input type="text" id="referralLinkInput" readonly style="cursor: pointer;">

            </div>

            <br><button id="copyReferralBtn" class="modal-btn" style="background: var(--blue-main); margin-top: 10px;">Copy Link</button>

        </div>



        <div class="ref-section">

            <h3>My Rewards</h3>

            <div class="ref-info">

                ETH: <span id="ethRewards">0</span> | USDT: <span id="usdtRewards">0</span><br/>

                Total Referrals: <span id="referralCount">0</span>

            </div>

        </div>

    </div>



    <div class="modal-footer">

        <button id="claimRewardsBtn" class="modal-btn">Claim Rewards</button>

    </div>

</div>

  <footer>
    <div id="footer" class="social-icons">
        <a href="https://x.com/FaylottoXyz" target="_blank"><i class="fa-brands fa-twitter"></i></a>
        <a href="https://t.me/FaylottoXyz" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://t.me/Faylotto" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://discord.gg/6uMYTdCZwJ" target="_blank"><i class="fa-brands fa-discord"></i></a>
        <a href="https://facebook.com/Faylotto" target="_blank"><i class="fa-brands fa-facebook"></i></a>
    </div>
    <p>
      © Powered By Faylotto.
      <span>
        <a href="https://docs.faylotto.xyz/policy/AllRightsReserved" style="color: #007bff; text-decoration: none;" target="_blank">
          <span id="year"></span> All rights reserved. 
        </a>
      </span>
      Play responsibly.
      <span>
        <a href="privacypolicy" style="color: #007bff; text-decoration: none;" target="_blank">
          Privacy Policy.
        </a>
      </span>
    </p>
  </footer>

  <script>
// ===========================================
// === 1. KONFIGURASI KONTRAK ===
// ===========================================
// ⚠️ GANTI INI DENGAN ALAMAT KONTRAK ANDA DI SEPOLIA
const USDT_ADDRESS = "0xa7baE72F341d8E70Fd5Dc2b256ecE7702823bec2"; 
const FAYLOTTO_ADDRESS = "0xcB1262c9a322dD3191aeA92077fE65A59c71e0a7"; // Ganti dengan address valid yang sudah deployed!
// ===========================================

// === 2. ABI LENGKAP ===
const USDT_ABI = [{"inputs":[{"internalType":"uint256","name":"_initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_from","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
const FAYLOTTO_ABI = [{"inputs":[{"internalType":"address","name":"_erc20Token","type":"address"},{"internalType":"address","name":"_feeCollector","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetERC20","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"nickname","type":"string"}],"name":"NicknameCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"stars","type":"uint8"}],"name":"Rated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"ReferralSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"}],"name":"RoundFinalized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"liked","type":"bool"}],"name":"WinnerLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"winnerId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardETH","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"WinnerRecorded","type":"event"},{"inputs":[],"name":"MAX_BETS_PER_PLAYER","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_ETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BET_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PLAYERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REF_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addCommentToWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"adminWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"nickname","type":"string"}],"name":"createNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"commentId","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editCommentOnWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20Token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"finalizeRound","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllCommentsForWinner","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAllLikes","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getAverageRatingForWinner","outputs":[{"internalType":"uint256","name":"avgTimes1e18","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getCommentCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"},{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerDeposits","outputs":[{"internalType":"uint256","name":"ethAmount","type":"uint256"},{"internalType":"uint256","name":"erc20Amount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"getRatingCountForWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralRewards","outputs":[{"internalType":"uint256","name":"ethReward","type":"uint256"},{"internalType":"uint256","name":"erc20Reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finalized","type":"bool"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"totalETH","type":"uint256"},{"internalType":"uint256","name":"totalERC20","type":"uint256"},{"internalType":"uint256","name":"playersCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rid","type":"uint256"}],"name":"getRoundPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getWinnerCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getWinners","outputs":[{"components":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBattle.WinnerInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"likeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"likedBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"nicknameOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"nicknames","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBetERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBetETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint8","name":"stars","type":"uint8"}],"name":"rateWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingCountByWinner","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratingTotalStars","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"ratings","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsERC20","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referralRewardsETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"referrals","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"roundLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeeBP","type":"uint256"}],"name":"setFeeBP","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refNickname","type":"string"}],"name":"setReferralByNickname","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"secs","type":"uint256"}],"name":"setRoundLength","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"}],"name":"toggleLikeWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winnerList","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"winners","outputs":[{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"address","name":"winner","type":"address"},{"internalType":"uint256","name":"rewardETH","type":"uint256"},{"internalType":"uint256","name":"rewardERC20","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

// ===========================================
// === 3. LOGIKA APLIKASI ===
// ===========================================

// --- Variabel Global ---
let provider, signer, userAddress;
let usdtContract, faylottoContract;
let rawEthBalance, rawUsdtBalance, usdtDecimals = 6;
let currentRoundId;
let currentRoundEndTime = 0;
let visualTimer = null;
let isSpinning = false;
let isFinalizing = false;
let players = {};
let totalWeight = ethers.BigNumber.from(0);
let contractRoundLengthSeconds = 300; // (Pastikan variabel ini ada dari timer)
let ctx, cw, ch, cx, cy;
let outerR = 140; // Radius luar donut
let innerR = 80;  // Radius dalam donut
let currentRotation = 0; // Rotasi roda saat ini
let playersArray = [];
let myCurrentEthDeposit = ethers.BigNumber.from(0);
let myCurrentUsdtDeposit = ethers.BigNumber.from(0);
let pendingReferrerNickname = null;

// --- Elemen DOM ---
const walletBtn = document.getElementById("walletBtn");
const walletInfo = document.getElementById("walletInfo");
const walletAddress = document.getElementById("walletAddress");
const ethBalance = document.getElementById("ethBalance");
const usdtBalance = document.getElementById("usdtBalance");
const myEthDeposit = document.getElementById("myEthDeposit");
const myUsdtDeposit = document.getElementById("myUsdtDeposit");
const statusText = document.getElementById("statusText");
const timerText = document.getElementById("timerText");
const placeBetBtn = document.getElementById("placeBetBtn");
const finalizeBtn = document.getElementById("finalizeBtn");
const winnerList = document.getElementById("winner-list");
const winnerListPlaceholder = document.getElementById("winner-list-placeholder");
// Modal Bet
const betModalOverlay = document.getElementById("bet-modal-overlay");
const betModal = document.getElementById("bet-modal");
const betModalCloseBtn = document.getElementById("bet-modal-close-btn");
const modalEthBalance = document.getElementById("modalEthBalance");
const modalUsdtBalance = document.getElementById("modalUsdtBalance");
const betAmountInput = document.getElementById("betAmountInput");
const betCurrencySelect = document.getElementById("betCurrencySelect");
const percentButtons = document.querySelectorAll(".percent-btn");
const confirmBetBtn = document.getElementById("confirmBetBtn");
// Roda & List
const betList = document.getElementById("bet-list");
const betListPlaceholder = document.getElementById("bet-list-placeholder");
// [BARU] Elemen DOM Referral
const referralBtn = document.getElementById("referralBtn");
const referralModalOverlay = document.getElementById("referral-modal-overlay");
const referralModal = document.getElementById("referral-modal");
const referralModalCloseBtn = document.getElementById("referral-modal-close-btn");
const myNickname = document.getElementById("myNickname");
const myReferrer = document.getElementById("myReferrer");
const nicknameInput = document.getElementById("nicknameInput");
const createNicknameBtn = document.getElementById("createNicknameBtn");
const setReferrerSection = document.getElementById("setReferrerSection");
const referrerNicknameInput = document.getElementById("referrerNicknameInput");
const setReferrerBtn = document.getElementById("setReferrerBtn");
const ethRewards = document.getElementById("ethRewards");
const usdtRewards = document.getElementById("usdtRewards");
const referralCount = document.getElementById("referralCount");
const claimRewardsBtn = document.getElementById("claimRewardsBtn");

// [BARU] Elemen DOM Modal Wallet
const walletModalOverlay = document.getElementById("wallet-modal-overlay");
const walletModal = document.getElementById("wallet-modal");
const walletModalCloseBtn = document.getElementById("wallet-modal-close-btn");
const disconnectBtn = document.getElementById("disconnectBtn");

const PLAYER_COLORS = [
  "#FF6B6B", // Merah
  "#4ECDC4", // Turquoise
  "#45B7D1", // Biru Cerah
  "#F9D423", // Kuning
  "#FFA62B", // Oranye
  "#7B72E9", // Ungu
  "#3DCC91", // Hijau
  "#FF90B3", // Pink
  "#C0E218", // Lime
  "#3498DB"  // Biru
];

        document.addEventListener("DOMContentLoaded", () => {
            // --- Kode inisialisasi canvas Anda ---
            const canvas = document.getElementById('myCanvas');
            // ... (logika canvas lainnya) ...

            // --- Deteksi Referral dari URL ---
            const urlParams = new URLSearchParams(window.location.search);
            const refNick = urlParams.get('ref');

            if (refNick) {
                console.log("Referral detected from URL:", refNick);
                pendingReferrerNickname = refNick;

                // Opsional: Beri tahu pengguna
                // alert(`Welcome! You were referred by ${refNick}.`);
            }
        });

// Inisialisasi Halaman (Page Load)
// Menunggu DOM (HTML) selesai dimuat sebelum menjalankan
document.addEventListener("DOMContentLoaded", () => {
    // Ambil canvas dan gambar roda kosong (No bets yet)
    const canvas = document.getElementById('donutCanvas');
    if (canvas) { // Cek jika canvas ada
        ctx = canvas.getContext('2d');
        cw = canvas.width;
        ch = canvas.height;
        cx = cw / 2;
        cy = ch / 2;
        drawDonut(); // Gambar roda kosong "No bets yet" saat halaman dimuat
    } else {
        console.error("Elemen canvas 'donutCanvas' tidak ditemukan!");
    }
});


// === FUNGSI UTAMA: Toggle Connect / Disconnect ===
async function toggleWallet() {
  // Fungsi ini sekarang HANYA menangani KONEKSI
  if (userAddress) return; // Jika sudah terhubung, abaikan
  if (!window.ethereum) return alert("Please install MetaMask.");
  
  try {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();

      // [BARU] Cek jaringan Sepolia (chain ID 11155111)
      const network = await provider.getNetwork();
      if (network.chainId !== 84532) {
          throw new Error("Please switch to Sepolia network in MetaMask.");
      }
      console.log("Connected to network:", network.name);

      usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
      faylottoContract = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, signer);

      walletBtn.innerText = "Terhubung"; // [PERBAIKAN] Teks baru
      referralBtn.style.display = "block"; 
      walletAddress.innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
      
      await updateUserBalances();
      await fetchAndDisplayRoundData();
      await fetchAndDisplayWinners();
      await fetchReferralData();
      setupEventListeners();

     if (pendingReferrerNickname) {
          try {
              const currentRef = await faylottoContract.referrerOf(userAddress);
              if (currentRef === ethers.constants.AddressZero) {
                  // User belum punya referrer, tetapkan sekarang
                  console.log("Setting pending referrer:", pendingReferrerNickname);
                  // PENTING: Ini akan memunculkan popup transaksi MetaMask
                  const tx = await faylottoContract.setReferralByNickname(pendingReferrerNickname);
                  await tx.wait();
                  alert(`Successfully referred by ${pendingReferrerNickname}!`);
                  pendingReferrerNickname = null; // Clear setelah sukses
                  fetchReferralData(); // Refresh UI
              }
          } catch (e) {
              console.warn("Failed to auto-set referrer:", e.message);
              // Jangan ganggu user dengan alert error jika gagal (misal nickname salah)
          }
     }

      console.log("Wallet connected successfully:", userAddress);
      statusText.innerText = "Click the button to start the Round!.";

  } catch (err) {
      console.error("Failed to connect wallet:", err.message);
      statusText.innerText = "Failed to connect. Check MetaMask network (Sepolia) and contract addresses.";
      provider = null; signer = null; userAddress = null;
      alert(`Error: ${err.message}`);
  }
}

// === FUNGSI UTAMA: Ambil Data Ronde & Mulai Timer ===
async function fetchAndDisplayRoundData() {
    if (!faylottoContract) return;
    try {
        statusText.innerText = "Syncing round data...";
        currentRoundId = await faylottoContract.currentRoundId();
        const roundInfo = await faylottoContract.getRoundBasic(currentRoundId);
        
        // Reset dan ambil data pemain
        resetRoundUI(); 
        const playersList = await faylottoContract.getRoundPlayers(currentRoundId);
        for (const playerAddress of playersList) {
            const deposits = await faylottoContract.getPlayerDeposits(currentRoundId, playerAddress);
            addBetToState(playerAddress, deposits.ethAmount, deposits.erc20Amount, false);
        }
        updateBetList();
        await updateMyDeposits();

        // === LOGIKA TIMER YANG BENAR (TERSINKRONISASI) ===
        // Ambil endTime ASLI dari kontrak (dalam milidetik)
        const contractEndTime = roundInfo.endTime.toNumber() * 1000;
        const now = Date.now();
        const timeLeft = contractEndTime - now;

        if (timeLeft <= 0) {
            // Jika waktu habis, langsung tampilkan Finalize (kontrak sudah siap)
            statusText.innerText = "Round ended. Waiting for finalization...";
            startVisualTimer(contractEndTime); // Ini akan langsung ke 00:00
        } else {
            // Jika ronde masih berjalan, tampilkan timer
            statusText.innerText = `Round ${currentRoundId.toString()} is live!`;
            placeBetBtn.disabled = false;
            isFinalizing = false;
            startVisualTimer(contractEndTime); // Mulai timer ASLI
        }
        // ===============================================

        console.log("Round data fetched:", roundInfo);
    } catch (err) {
        console.error("Error fetching round data:", err.message);
        statusText.innerText = "Error syncing data. Please refresh or check console.";
    }
}
  
// === FUNGSI UTAMA: Ambil Data Pemenang Lengkap & Fitur Sosial ===
async function fetchAndDisplayWinners() {
    // Pastikan kontrak read-only tersedia
    let contractInstance = faylottoContract;
    if (!contractInstance) {
       if (!provider) provider = new ethers.providers.JsonRpcProvider("https://sepolia.base.org");
       contractInstance = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    }
    
    try {
        winnerList.innerHTML = "";
        const winnersArray = await contractInstance.getWinners(10); 
        
        if (winnersArray.length === 0) {
            winnerList.appendChild(winnerListPlaceholder);
            return;
        }

        let usdtDecimalsWinner = 18;
        try { if (usdtContract) usdtDecimalsWinner = await usdtContract.decimals(); } catch (e) {}

        for (const winner of winnersArray) {
            const winnerId = winner.winnerId.toString();
            const roundId = winner.roundId.toString();
            const winnerAddr = winner.winner;
            const ethAmt = parseFloat(ethers.utils.formatEther(winner.rewardETH)).toFixed(4);
            const usdtAmt = parseFloat(ethers.utils.formatUnits(winner.rewardERC20, usdtDecimalsWinner)).toFixed(2);
            const date = new Date(winner.timestamp.toNumber() * 1000).toLocaleString();
            const shortId = (userAddress && winnerAddr.toLowerCase() === userAddress.toLowerCase()) ? "You" : (winnerAddr.slice(0, 6) + "..." + winnerAddr.slice(-4));

            // --- AMBIL DATA SOSIAL ---
            let likes = 0, ratingCount = 0, commentCount = 0;
            let isLikedByMe = false, myRating = 0;

            try {
                likes = (await contractInstance.getLikeCount(winnerId)).toNumber();
                ratingCount = (await contractInstance.getRatingCountForWinner(winnerId)).toNumber();
                // [BARU] Ambil jumlah komentar juga
                commentCount = (await contractInstance.getCommentCountForWinner(winnerId)).toNumber();
            } catch (e) { console.warn("Gagal ambil data publik sosial", e); }

            if (userAddress && faylottoContract) { 
                try {
                    const signedContract = faylottoContract.connect(signer);
                    isLikedByMe = await signedContract.liked(winnerId, userAddress);
                    myRating = await signedContract.ratings(winnerId, userAddress);
                } catch (e) { }
            }

            const item = document.createElement("div");
            item.className = "winner-list-item";
            item.innerHTML = `
              <div class="winner-id" style="display: flex; justify-content: space-between;">
                <span>Round #${roundId}</span>
                <small style="color: #888; font-size: 10px;">${date}</small>
              </div>
              <div style="margin-bottom: 4px; font-weight: bold; color: var(--cyan-main);">
                Winner: ${shortId}
              </div>
              <div class="prize-line">
                Won: ${winner.rewardETH.gt(0) ? ethAmt + ' ETH' : ''} 
                     ${(winner.rewardETH.gt(0) && winner.rewardERC20.gt(0)) ? '+ ' : ''}
                     ${winner.rewardERC20.gt(0) ? usdtAmt + ' USDT' : ''}
              </div>

              <div class="winner-social" style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(120,0,255,0.2); display:flex; justify-content:space-between; align-items:center;">
                  
                  <button class="like-btn" style="background:none; border:none; cursor:pointer; color: ${isLikedByMe ? '#ff00e6' : '#888'}; font-size:14px; display:flex; align-items:center; gap:4px;" onclick="toggleLike(${winnerId})">
                    ♥ <span>${likes}</span>
                  </button>

                  <div style="display:flex; align-items:center; gap:6px;">
                      <div class="rating-stars" style="display:flex;">
                        ${[1, 2, 3, 4, 5].map(i => `
                            <span style="cursor:pointer; color: ${i <= myRating ? 'gold' : '#555'}; font-size:16px;" onclick="rateWinner(${winnerId}, ${i})">★</span>
                        `).join('')}
                      </div>
                      <span style="font-size: 12px; color: #888;">(${ratingCount})</span>
                  </div>

                  <button class="terminal-btn" id="comm-btn-${winnerId}" style="background:none; border:none; color:var(--cyan-main); font-size:16px; cursor:pointer;" 
                          onclick="toggleComments(${winnerId}, '${winnerAddr}')">
                    💬 (${commentCount})
                  </button>

              </div>

              <div class="comments-terminal" id="terminal-${winnerId}" style="display: none; margin-top: 10px;">
                  <div class="terminal-header">> LOG FOR WINNER: ${winnerAddr.slice(0,10)}...</div>
                  
                  <div class="comments-list"></div><br>

                  <div class="new-comment-section" style="margin-top: 10px; padding-top: 8px; border-top: 1px dashed rgba(120, 0, 255, 0.2); display: flex; gap: 5px; align-items: center;">
                      <span style="color: var(--cyan-main);">></span>
                      <textarea class="terminal-input" id="new-comment-${winnerId}" placeholder="Transmit data..." rows="1" style="resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
                      <button class="terminal-btn" onclick="submitComment(${winnerId})">[ SEND ]</button>
                  </div>
              </div>
            `;
            winnerList.appendChild(item);
        }
    } catch (err) {
        console.error("Error fetching winners:", err.message);
        winnerList.appendChild(winnerListPlaceholder);
    }
                      }
                       
    
// Fungsi Helper untuk Like
async function toggleLike(winnerId) {
    if (!signer || !faylottoContract) return alert("Please connect wallet first.");
    try {
        const tx = await faylottoContract.toggleLikeWinner(winnerId);
        await tx.wait();
        fetchAndDisplayWinners(); // Refresh setelah sukses
    } catch (err) {
        console.error("Like failed:", err);
    }
}

// Fungsi Helper untuk Rating
async function rateWinner(winnerId, stars) {
    if (!signer || !faylottoContract) return alert("Please connect wallet first.");
    try {
        const tx = await faylottoContract.rateWinner(winnerId, stars);
        await tx.wait();
        fetchAndDisplayWinners(); // Refresh setelah sukses
    } catch (err) {
        console.error("Rating failed:", err);
    }
}

    // Kirim Komentar Baru
async function submitComment(winnerId) {
    if (!signer) return alert("Connect wallet first.");
    const input = document.getElementById(`new-comment-${winnerId}`);
    const text = input.value.trim();
    if (!text) return;

    try {
        input.disabled = true;
        // Simpan nilai asli untuk jaga-jaga jika gagal
        const originalValue = input.value;
        input.value = "TRANSMITTING..."; // Tampilkan status loading di input

        const tx = await faylottoContract.addCommentToWinner(winnerId, text);
        await tx.wait(); // Tunggu konfirmasi blockchain
        
        // [PERBAIKAN UTAMA]
        // Transaksi sukses! Kosongkan input dan refresh komentar SEGERA.
        input.value = "";
        await fetchAndRenderComments(winnerId); // <-- INI YANG HILANG
        
    } catch (err) {
        console.error(err);
        alert("Failed to send comment.");
        input.value = text; // Kembalikan teks asli jika gagal agar user tidak perlu ketik ulang
    } finally {
        input.disabled = false;
    }
}

// Tampilkan Mode Edit
function showEditComment(wid, cid) {
    document.getElementById(`msg-${wid}-${cid}`).style.display = 'none';
    document.getElementById(`edit-btn-${wid}-${cid}`).style.display = 'none';
    document.getElementById(`edit-actions-${wid}-${cid}`).style.display = 'block';
}

// Batalkan Mode Edit
function cancelEditComment(wid, cid) {
    document.getElementById(`msg-${wid}-${cid}`).style.display = 'block';
    document.getElementById(`edit-btn-${wid}-${cid}`).style.display = 'inline-block';
    document.getElementById(`edit-actions-${wid}-${cid}`).style.display = 'none';
}

// Simpan Editan
async function saveEditComment(wid, cid) {
    if (!signer) return;
    const input = document.getElementById(`edit-input-${wid}-${cid}`);
    const newText = input.value.trim();
    if (!newText) return alert("Comment cannot be empty.");

    try {
        const tx = await faylottoContract.editCommentOnWinner(wid, cid, newText);
        await tx.wait();
        fetchAndRenderComments(wid); // Refresh setelah simpan
    } catch (err) {
        console.error("Edit failed:", err);
        alert("Failed to edit comment.");
    }
}

// [WAJIB ADA] Fungsi untuk mengambil dan merender komentar
async function fetchAndRenderComments(winnerId) {
    const terminalDiv = document.getElementById(`terminal-${winnerId}`);
    if (!terminalDiv) return;

    const commentsListDiv = terminalDiv.querySelector('.comments-list');
    if (!commentsListDiv) return;

    commentsListDiv.innerHTML = "> LOADING NEURAL LOGS...";

    // Gunakan kontrak yang tersedia (lebih baik yang read-only jika belum login)
    let contractInstance = faylottoContract;
    if (!contractInstance) {
       if (!provider) provider = new ethers.providers.JsonRpcProvider("https://sepolia.base.org");
       contractInstance = new ethers.Contract(FAYLOTTO_ADDRESS, FAYLOTTO_ABI, provider);
    }

    try {
        // Ambil semua komentar untuk pemenang ini dari kontrak
        const comments = await contractInstance.getAllCommentsForWinner(winnerId);
        
        if (comments.length === 0) {
            commentsListDiv.innerHTML = "> NO TRANSMISSIONS FOUND.";
            return;
        }

        commentsListDiv.innerHTML = ""; // Bersihkan teks loading
        
        // Loop semua komentar dan tampilkan
        for (let i = 0; i < comments.length; i++) {
            const c = comments[i];
            const user = c.user;
            const text = c.text;
            // Konversi timestamp ke waktu lokal
            const dateObj = new Date(c.timestamp.toNumber() * 1000);
            const time = dateObj.toLocaleString('id-ID', {
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour12: false
            });
          
            // Cek apakah ini komentar saya (untuk menampilkan tombol EDIT)
            const isMyComment = (userAddress && user.toLowerCase() === userAddress.toLowerCase());
            
            // Coba ambil nickname komentator (jika ada)
            let nickname = null;
            try { nickname = await contractInstance.nicknames(user); } catch (e) {}
            const displayName = nickname || user.slice(0,6) + '...';

            const commentDiv = document.createElement('div');
            commentDiv.className = "comment-log";
            commentDiv.id = `comment-${winnerId}-${i}`;
            
            // Render HTML komentar individu
            commentDiv.innerHTML = `
                <div class="log-meta">
                    <span class="log-nickname">${displayName}</span>
                    <span class="log-wallet">(${user.slice(0,6)}...${user.slice(-4)})</span> [${time}]
                </div><br>
                <div class="log-message" id="msg-${winnerId}-${i}">${text}</div>
                <br>
                ${isMyComment ? `
                    <div class="edit-actions" style="display:none;" id="edit-actions-${winnerId}-${i}">
                        <textarea class="terminal-input" id="edit-input-${winnerId}-${i}" rows="2" style="margin-top:5px;">${text}</textarea>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button class="terminal-btn" onclick="saveEditComment(${winnerId}, ${i})">[ SAVE ]</button>
                            <button class="terminal-btn" style="color:#ff5555;border-color:#ff5555" onclick="cancelEditComment(${winnerId}, ${i})">[ CANCEL ]</button>
                        </div>
                    </div>
                    <button class="terminal-btn" id="edit-btn-${winnerId}-${i}" onclick="showEditComment(${winnerId}, ${i})" style="opacity:0.7; margin-top:5px;">[ EDIT LOG ]</button>
                ` : ''}
            `;
            commentsListDiv.appendChild(commentDiv);
        }
        
        // Update juga jumlah komentar di tombol 💬
        const commBtn = document.getElementById(`comm-btn-${winnerId}`);
        if(commBtn) commBtn.innerText = `💬 (${comments.length})`;

    } catch (err) {
        console.error("Error fetching comments:", err);
        commentsListDiv.innerHTML = "> ERROR: SIGNAL LOST.";
    }
}
    
    function toggleComments(winnerId, winnerAddr) {
    const terminal = document.getElementById(`terminal-${winnerId}`);
    if (terminal.style.display === 'none') {
        terminal.style.display = 'block';
        // Load komentar hanya saat dibuka (Lazy Loading)
        fetchAndRenderComments(winnerId);
    } else {
        terminal.style.display = 'none';
    }
    }

// === FUNGSI UTAMA: Memulai Event Listener ===
function setupEventListeners() {
    if (!faylottoContract) return;
    faylottoContract.removeAllListeners();

    faylottoContract.on("BetETH", (roundId, player, amount) => {
        if (roundId.eq(currentRoundId)) {
            addBetToState(player, amount, ethers.BigNumber.from(0), true);
            // updateWheelVisuals(); // Hapus (sudah dihandle oleh addBetToState)
            updateBetList();
            if (player.toLowerCase() === userAddress.toLowerCase()) updateMyDeposits();
        }
    });
    faylottoContract.on("BetERC20", (roundId, player, amount) => {
        if (roundId.eq(currentRoundId)) {
            addBetToState(player, ethers.BigNumber.from(0), amount, true);
            // updateWheelVisuals(); // Hapus (sudah dihandle oleh addBetToState)
            updateBetList();
            if (player.toLowerCase() === userAddress.toLowerCase()) updateMyDeposits();
        }
    });

    // 📡 EVENT LISTENER UNTUK ROUND FINALIZED
faylottoContract.on("RoundFinalized", async (roundId, winner, rewardETH, rewardERC20) => {
  console.log("📡 Event RoundFinalized diterima:", roundId.toString(), winner);

  // ✅ Pastikan ini ronde yang sedang aktif
  if (!currentRoundId || !roundId.eq(currentRoundId)) {
    console.warn("⚠️ Event bukan untuk round aktif. Diabaikan.");
    return;
  }

  // 🚫 Hindari pemanggilan ganda saat sedang spinning
  if (isSpinning || isFinalizing) {
    console.warn("⚙️ Sudah dalam proses finalisasi, abaikan event duplikat.");
    return;
  }

  try {
    await handleRoundFinalized(roundId, winner);
  } catch (err) {
    console.error("❌ Error di handleRoundFinalized:", err);
  }
});
    
    // [BARU] Event listener untuk update UI referral
    faylottoContract.on("NicknameCreated", (user) => {
        if (user.toLowerCase() === userAddress.toLowerCase()) fetchReferralData();
    });
    faylottoContract.on("ReferralSet", (user) => {
        if (user.toLowerCase() === userAddress.toLowerCase()) fetchReferralData();
    });
}

// === FUNGSI UTAMA: Handle Finalisasi ===
async function handleRoundFinalized(roundId, winnerAddr) {
    if (isSpinning) return;
    isSpinning = true;
    isFinalizing = true;
    
    // Sembunyikan semua tombol agar user fokus ke roda
    placeBetBtn.style.display = "none";
    finalizeBtn.style.display = "none";
    if (visualTimer) clearInterval(visualTimer);
    timerText.innerText = "WINNER!";
    statusText.innerText = "Spinning to the winner...";

    // Beri jeda sedikit sebelum mulai berputar (efek dramatis)
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Cari siapa pemain yang menang di array lokal kita
    const targetPlayer = playersArray.find(p => p.addr.toLowerCase() === winnerAddr.toLowerCase());
    
    if (!targetPlayer) {
        // Aneh, pemenang tidak ada di data lokal kita. Langsung reset saja.
        console.error("Winner not found in local playersArray!");
        resetAndFetchNewRound();
        return;
    }
    
    // MULAI PUTARAN! Dan tunggu sampai selesai.
    await spinToPlayer(targetPlayer); 
    
    // <-- Kode di bawah ini baru akan jalan SETELAH roda berhenti berputar
}
  
// === FUNGSI UTAMA: Reset & Ambil Ronde Baru ===
async function resetAndFetchNewRound() {
    console.log("Mereset untuk ronde baru...");
    isSpinning = false;
    isFinalizing = false;
    
    await new Promise(resolve => setTimeout(resolve, 3000));
    await fetchAndDisplayWinners(); // Refresh daftar pemenang
    await fetchAndDisplayRoundData(); // Ambil ronde baru
}

// GANTI SELURUH FUNGSI LAMA ANDA DENGAN YANG INI
async function callFinalizeRound() {
    if (!signer || !faylottoContract) return alert("Please connect your wallet.");

    finalizeBtn.disabled = true;
    statusText.innerText = "Sending finalization transaction...";

    try {
        // 1. Kirim transaksi ke blockchain
        const tx = await faylottoContract.finalizeRound(currentRoundId);
        statusText.innerText = "Finalizing... awaiting confirmation.";
        
        // 2. Tunggu sampai transaksi DIKONFIRMASI oleh blockchain
        const receipt = await tx.wait(); 
        console.log("Finalize transaction confirmed.", receipt);

        // 3. Cari event 'WinnerRecorded' di dalam struk transaksi
        const event = receipt.events?.find(e => e.event === 'WinnerRecorded');
        
        if (event) {
            // Hore! Ada pemenang. Ambil datanya.
            const roundId = event.args[1]; 
            const winnerAddr = event.args[2];
            console.log(`Winner found: ${winnerAddr} for Round ${roundId}`);
            
            // 4. Mulai animasi putaran!
            if (!isSpinning) {
                handleRoundFinalized(roundId, winnerAddr);
            }
        } else {
            // Yah, ronde kosong. Tidak ada pemenang.
            console.log("Round was empty. Resetting...");
            if (!isSpinning) {
                resetAndFetchNewRound();
            }
        }
        
    } catch (err) {
        console.error("Finalize failed:", err);
        alert("Finalization failed. See console for details.");
        statusText.innerText = "Finalization failed.";
        finalizeBtn.disabled = false; // Biarkan user mencoba lagi jika gagal
    }
}

// === FUNGSI MODAL TARUHAN (Bet Modal) ===
function showBetModal() {
  if (!signer) return alert("Connect wallet first!");
  if (isFinalizing) return alert("Round is ending, new bets are closed.");
  
  modalEthBalance.innerText = ethers.utils.formatEther(rawEthBalance || 0);
  modalUsdtBalance.innerText = ethers.utils.formatUnits(rawUsdtBalance || 0, usdtDecimals);
  betAmountInput.value = "";
  
  betModalOverlay.classList.add("show");
  betModal.classList.add("show");
}
function hideBetModal() {
  betModalOverlay.classList.remove("show");
  betModal.classList.remove("show");
}
function setAmountByPercent(percent) {
  const currency = betCurrencySelect.value;
  let balanceToUse, decimals;
  if (currency === 'ETH') {
    balanceToUse = rawEthBalance; decimals = 18;
  } else {
    balanceToUse = rawUsdtBalance; decimals = usdtDecimals;
  }
  if (!balanceToUse) return;
  const amount = balanceToUse.mul(Math.floor(percent * 1000)).div(1000);
  betAmountInput.value = ethers.utils.formatUnits(amount, decimals);
}

// === FUNGSI MODAL: Konfirmasi & Kirim Transaksi ===
async function confirmBet() {
  const amountStr = betAmountInput.value;
  const currency = betCurrencySelect.value;
  if (!amountStr || parseFloat(amountStr) <= 0) return alert("Please enter a valid amount.");
  confirmBetBtn.disabled = true;
  confirmBetBtn.innerText = "Processing...";
  try {
    let tx;
    if (currency === 'ETH') {
      tx = await placeBetETH(amountStr);
    } else {
      tx = await placeBetUSDT(amountStr);
    }
    statusText.innerText = `Bet sent! Awaiting confirmation...`;
    await tx.wait();
    statusText.innerText = `Bet confirmed! Good luck.`;
    hideBetModal();
    await updateUserBalances();
    await updateMyDeposits();
  } catch (err) {
    console.error(err);
    const errorMessage = err.reason || err.message || "Transaction failed!";
    alert(`Error: ${errorMessage}`);
    statusText.innerText = "Transaction failed.";
  } finally {
    confirmBetBtn.disabled = false;
    confirmBetBtn.innerText = "Confirm Bet";
  }
}

async function placeBetETH(amountStr) {
  const amountWei = ethers.utils.parseEther(amountStr);
  if (amountWei.gt(rawEthBalance)) throw new Error("Insufficient ETH balance.");
  const minEth = ethers.utils.parseEther("0.00005");
  if (amountWei.lt(minEth)) throw new Error("Minimum bet is 0.00005 ETH");

  // [CEK BARU] Cek batas maksimal deposit
  const maxEth = ethers.utils.parseEther("0.00256");
  const newTotalDeposit = myCurrentEthDeposit.add(amountWei);
  if (newTotalDeposit.gt(maxEth)) throw new Error("Max total deposit (0.00256 ETH) exceeded.");
  
  // Catatan: Cek 'Max 2 bets' akan ditangani oleh kontrak dan ditangkap oleh .catch()
  
  return faylottoContract.placeBetETH({ value: amountWei });
}
  
async function placeBetUSDT(amountStr) {
  const amountUsdt = ethers.utils.parseUnits(amountStr, usdtDecimals);
  if (amountUsdt.gt(rawUsdtBalance)) throw new Error("Insufficient USDT balance.");
  const minUsdt = ethers.utils.parseUnits("0.5", usdtDecimals);
  if (amountUsdt.lt(minUsdt)) throw new Error(`Minimum bet is 0.5 USDT`);

  // [CEK BARU] Cek batas maksimal deposit (10 USDT)
  // (Kita asumsikan usdtDecimals sudah 18)
  const maxUsdt = ethers.utils.parseUnits("10", usdtDecimals); 
  const newTotalDeposit = myCurrentUsdtDeposit.add(amountUsdt);
  if (newTotalDeposit.gt(maxUsdt)) throw new Error("Max total deposit (10 USDT) exceeded.");

  // Catatan: Cek 'Max 2 bets' akan ditangani oleh kontrak dan ditangkap oleh .catch()
  
  const currentAllowance = await usdtContract.allowance(userAddress, FAYLOTTO_ADDRESS);
  if (currentAllowance.lt(amountUsdt)) {
    statusText.innerText = "Need approval. Please approve in MetaMask...";
    const approveTx = await usdtContract.approve(FAYLOTTO_ADDRESS, ethers.constants.MaxUint256);
    await approveTx.wait();
    statusText.innerText = "Approval successful! Placing bet...";
  }
  return faylottoContract.placeBetERC20(amountUsdt);
}

// ===========================================
// === [BARU] FUNGSI-FUNGSI REFERRAL ===
// ===========================================

// --- Tampilkan & Sembunyikan Modal Referral ---
async function showReferralModal() {
    if (!signer) return alert("Connect wallet first!");
    
    // Selalu ambil data terbaru saat modal dibuka
    await fetchReferralData(); 
    
    referralModalOverlay.classList.add("show");
    referralModal.classList.add("show");
}
function hideReferralModal() {
  referralModalOverlay.classList.remove("show");
  referralModal.classList.remove("show");
}

    // --- Ambil Data Referral dari Kontrak ---
    async function fetchReferralData() {
    if (!faylottoContract || !userAddress) return;

    try {
        if (!usdtDecimals) usdtDecimals = 18; 

        const nick = await faylottoContract.nicknames(userAddress);
        const referrer = await faylottoContract.referrerOf(userAddress);
        const rewards = await faylottoContract.getReferralRewards(userAddress);
        const count = await faylottoContract.getReferralCount(userAddress);
        
        updateReferralUI(nick, referrer, rewards, count);
        
    } catch (err) {
        console.error("Error fetching referral data:", err);
        
    }
    }

// --- Update UI Modal Referral ---
function updateReferralUI(nick, referrer, rewards, count) {
    // 1. Update Info Saya & Link Referral
    myNickname.innerText = nick || "-";
    const linkSection = document.getElementById("referralLinkSection");
    const linkInput = document.getElementById("referralLinkInput");

    if (nick) {
        linkSection.style.display = "block";
        // Buat link: domain saat ini + ?ref=nickname
        linkInput.value = `${window.location.origin}${window.location.pathname}?ref=${nick}`;
    } else {
        linkSection.style.display = "none";
    }

    // 2. Update Status Referrer & Tampilan Section Set Referrer
    if (referrer === ethers.constants.AddressZero) {
        // Jika belum punya referrer, cek apakah ada yang pending dari URL
        myReferrer.innerText = pendingReferrerNickname ? `Pending (${pendingReferrerNickname})` : "-";
        setReferrerSection.style.display = "block"; // Tampilkan section untuk set referrer
    } else {
        // Jika sudah punya referrer, tampilkan alamatnya yang disingkat
        myReferrer.innerText = referrer.slice(0, 6) + "..." + referrer.slice(-4);
        setReferrerSection.style.display = "none"; // Sembunyikan section karena sudah punya
    }

    // 3. Update Rewards Saya
    ethRewards.innerText = parseFloat(ethers.utils.formatEther(rewards.ethReward)).toFixed(6);
    // Pastikan usdtDecimals sudah terdefinisi dengan benar sebelumnya
    usdtRewards.innerText = parseFloat(ethers.utils.formatUnits(rewards.erc20Reward, usdtDecimals)).toFixed(2);
    referralCount.innerText = count.toString();

    // 4. Atur Tombol Claim
    if (rewards.ethReward.gt(0) || rewards.erc20Reward.gt(0)) {
        claimRewardsBtn.disabled = false;
    } else {
        claimRewardsBtn.disabled = true;
    }
}

// --- Panggil Kontrak: createNickname ---
async function callCreateNickname() {
    const nick = nicknameInput.value;
    if (!nick || nick.length < 3) return alert("Nickname must be at least 3 characters.");
    
    createNicknameBtn.disabled = true;
    createNicknameBtn.innerText = "Processing...";
    try {
        const tx = await faylottoContract.createNickname(nick);
        await tx.wait();
        alert("Nickname created/updated successfully!");
        await fetchReferralData(); // Refresh UI
    } catch (err) {
        console.error("Error creating nickname:", err.message);
        alert(err.reason || "Failed to create nickname.");
    } finally {
        createNicknameBtn.disabled = false;
        createNicknameBtn.innerText = "Create";
    }
}

// --- Panggil Kontrak: setReferralByNickname ---
async function callSetReferrer() {
    const refNick = referrerNicknameInput.value;
    if (!refNick) return alert("Please enter a referrer's nickname.");
    
    setReferrerBtn.disabled = true;
    setReferrerBtn.innerText = "Processing...";
    try {
        const tx = await faylottoContract.setReferralByNickname(refNick);
        await tx.wait();
        alert("Referrer set successfully!");
        await fetchReferralData(); // Refresh UI (akan menyembunyikan section ini)
    } catch (err) {
        console.error("Error setting referrer:", err.message);
        alert(err.reason || "Failed to set referrer. (Nickname might not exist, or you already have one)");
    } finally {
        setReferrerBtn.disabled = false;
        setReferrerBtn.innerText = "Set Referrer";
    }
}

// --- Panggil Kontrak: claimReferralRewards ---
async function callClaimRewards() {
    claimRewardsBtn.disabled = true;
    claimRewardsBtn.innerText = "Claiming...";
    try {
        const tx = await faylottoContract.claimReferralRewards();
        await tx.wait();
        alert("Rewards claimed successfully!");
        await fetchReferralData(); // Refresh UI (rewards akan jadi 0)
        await updateUserBalances(); // Refresh saldo dompet
    } catch (err) {
        console.error("Error claiming rewards:", err.message);
        alert(err.reason || "Failed to claim rewards. (You might have no rewards)");
    } finally {
        // Tombol akan di-set ke disabled oleh fetchReferralData jika saldo 0
        claimRewardsBtn.innerText = "Claim Rewards";
    }
}

// === FUNGSI HELPER (Tidak berubah) ===
async function updateUserBalances() {
  if (!provider || !userAddress || !usdtContract) return;
  try {
    rawEthBalance = await provider.getBalance(userAddress);
    ethBalance.innerText = parseFloat(ethers.utils.formatEther(rawEthBalance)).toFixed(5);
    usdtDecimals = await usdtContract.decimals();
    rawUsdtBalance = await usdtContract.balanceOf(userAddress);
    usdtBalance.innerText = parseFloat(ethers.utils.formatUnits(rawUsdtBalance, usdtDecimals)).toFixed(2);
  } catch (err) { 
    console.error("Error fetching balances:", err.message);
    usdtBalance.innerText = "Error";
  }
}

  async function updateMyDeposits() {
    if (!faylottoContract || !currentRoundId || !userAddress) {
        myEthDeposit.innerText = "0";
        myUsdtDeposit.innerText = "0";
        myCurrentEthDeposit = ethers.BigNumber.from(0); // Reset
        myCurrentUsdtDeposit = ethers.BigNumber.from(0); // Reset
        return;
    }
    try {
        const deposits = await faylottoContract.getPlayerDeposits(currentRoundId, userAddress);
        
        // Simpan ke variabel global (BigNumber)
        myCurrentEthDeposit = deposits.ethAmount; 
        myCurrentUsdtDeposit = deposits.erc20Amount;

        // Tampilkan di UI (String)
        myEthDeposit.innerText = parseFloat(ethers.utils.formatEther(deposits.ethAmount)).toFixed(5);
        myUsdtDeposit.innerText = parseFloat(ethers.utils.formatUnits(deposits.erc20Amount, usdtDecimals)).toFixed(2);
    } catch (err) {
        console.error("Could not fetch user deposits:", err.message);
        myEthDeposit.innerText = "Error";
        myUsdtDeposit.innerText = "Error";
    }
  }

  function startVisualTimer(endTime) {
  if (visualTimer) clearInterval(visualTimer);
  
  visualTimer = setInterval(() => {
    const now = Date.now();
    const timeLeft = endTime - now;

    if (timeLeft <= 0) {
      clearInterval(visualTimer);
      timerText.innerText = "00:00";
      
      // Timer ASLI sudah habis. Tampilkan tombol Finalize.
      // Tidak perlu cek pemain, kontrak sudah menanganinya.
      showFinalizeButton(); 
      return;
    }

    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    timerText.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }, 1000);
  }
  
function showFinalizeButton() {
    if (isFinalizing) return;
    isFinalizing = true; // Kunci status

    // === [PERUBAHAN LOGIKA DIMULAI DI SINI] ===
    // Cek jumlah pemain dari variabel global 'players'
    const playerCount = Object.keys(players).length;

    if (playerCount > 0) {
        // ADA PEMAIN: Tampilkan teks asli
        statusText.innerText = "Round Ended! Click 'Finalize' to pick a winner.";
        finalizeBtn.innerText = "FINALIZE ROUND"; // Teks untuk "Putar Roda"
    } else {
        // TIDAK ADA PEMAIN: Tampilkan teks baru Anda
        statusText.innerText = "Round Ended! Click 'Start Now' to begin a new round.";
        finalizeBtn.innerText = "MULAI SEKARANG"; // Teks untuk "Mulai Ulang"
    }
    // === [AKHIR PERUBAHAN] ===

    // Sisa fungsi tetap sama
    placeBetBtn.disabled = true;
    placeBetBtn.style.display = "none";
    finalizeBtn.style.display = "block";
    finalizeBtn.disabled = false;
}

  function resetRoundUI() {
    players = {};
    totalWeight = ethers.BigNumber.from(0);
    playersArray = []; // Bersihkan array
    
    if (ctx) {
        currentRotation = 0;
        drawDonut(); // Gambar ulang donut kosong
    }
    
    updateBetList();
    placeBetBtn.style.display = "block";
    placeBetBtn.disabled = true;

    // Ini adalah perubahan yang Anda inginkan (dan sudah benar)
    finalizeBtn.style.display = "none";
    finalizeBtn.innerText = "FINALIZE ROUND"; // Reset teks tombol ke default
    
    myEthDeposit.innerText = "0";
    myUsdtDeposit.innerText = "0";
  }

function addBetToState(playerId, ethAmount, usdtAmount, isEvent = false) {
  const playerKey = playerId.toLowerCase(); 
  if (!players[playerKey]) {
    
    // [PERBAIKAN WARNA]
    // Ambil warna dari palet berdasarkan jumlah pemain saat ini
    const colorIndex = Object.keys(players).length;
    const playerColor = PLAYER_COLORS[colorIndex % 10]; // Modulo 10 untuk keamanan
    
    players[playerKey] = {
      id: playerId,
      eth: ethers.BigNumber.from(0),
      usdt: ethers.BigNumber.from(0),
      color: playerColor, // Gunakan warna baru
      data: { startAngle: 0, endAngle: 0 } 
    };
  }
  
  const player = players[playerKey];
  if (isEvent) {
      player.eth = player.eth.add(ethAmount);
      player.usdt = player.usdt.add(usdtAmount);
  } else {
      player.eth = ethAmount;
      player.usdt = usdtAmount;
  }
  const ethWeight = player.eth;
  const usdtFactor = ethers.BigNumber.from(10).pow(18 - usdtDecimals);
  const usdtWeight = player.usdt.mul(usdtFactor);
  player.weight = ethWeight.add(usdtWeight);
  
  // Hitung ulang total bobot
  totalWeight = ethers.BigNumber.from(0);
  for (const pid in players) {
      totalWeight = totalWeight.add(players[pid].weight);
  }

  rebuildPlayersArrayAndDraw();
}
  
  
function updateBetList() {
  betList.innerHTML = ""; 
  const playerIds = Object.keys(players);
  if (playerIds.length === 0) {
    betList.innerHTML = '<p id="bet-list-placeholder">No bets placed yet in this round.</p>';
    return;
  }
  playerIds.forEach(id => {
    const player = players[id];
    const ethAmount = parseFloat(ethers.utils.formatEther(player.eth)).toFixed(5);
    const usdtAmount = parseFloat(ethers.utils.formatUnits(player.usdt, usdtDecimals)).toFixed(2);
    const shortId = (id.toLowerCase() === userAddress.toLowerCase()) ? "You" : (id.slice(0, 6) + "..." + id.slice(-4));
    let betsHtml = "";
    if (player.eth.gt(0)) betsHtml += `${ethAmount} ETH`;
    if (player.eth.gt(0) && player.usdt.gt(0)) betsHtml += " + ";
    if (player.usdt.gt(0)) betsHtml += `${usdtAmount} USDT`;
    const item = document.createElement("div");
    item.className = "bet-list-item";
    item.innerHTML = `
      <div class="player-id" style="color: ${player.color}">${shortId}</div>
      <div class="player-bets">${betsHtml}</div>
    `;
    betList.appendChild(item);
  });
}

// ======= Draw donut on canvas =======
    function drawDonut(rotationDeg = currentRotation) {
      ctx.clearRect(0,0,cw,ch);
      // apply rotation by translating and rotating context
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(rotationDeg * Math.PI / 180);
      ctx.translate(-cx, -cy);

      // background circle
      ctx.beginPath();
      ctx.arc(cx, cy, outerR + 6, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.01)';
      ctx.fill();

      if (!playersArray || playersArray.length === 0) {
        // draw empty donut
        const gradient = ctx.createRadialGradient(cx, cy, innerR, cx, cy, outerR);
        gradient.addColorStop(0, '#ff00e6');    // Tepi dalam (Terang - var(--pink-main))
        gradient.addColorStop(0.7, '#6200ff');  // Tengah (Ungu - var(--purple-main))
        gradient.addColorStop(1, '#0b0b12');    // Tepi luar (Sangat Gelap - var(--bg-dark-1))
        
        ctx.beginPath();
        ctx.arc(cx, cy, outerR, 0, Math.PI*2);
        ctx.fillStyle = gradient;
        ctx.fill();
        // inner hole
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(cx, cy, innerR, 0, Math.PI*2);
        ctx.fill();
        ctx.globalCompositeOperation = 'source-over';
        ctx.restore();
        // center label
        ctx.fillStyle = '#ffffff';
        ctx.font = '14px Ubuntu'; // [PERBAIKAN] Ganti ke Ubuntu (sudah di-load)
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('No bets yet', cx, cy);
        return;
      }

      // draw sectors
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        const sa = p.startAngle;
        const ea = p.endAngle;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, outerR, sa, ea, false);
        ctx.closePath();
        ctx.fillStyle = p.color;
        ctx.fill();
      }

      // inner circle to make donut
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(cx, cy, innerR, 0, Math.PI*2);
      ctx.fill();
      ctx.globalCompositeOperation = 'source-over';

      // draw separators (thin lines)
      ctx.strokeStyle = 'rgba(0,0,0,0.25)';
      ctx.lineWidth = 1;
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        const angle = (p.startAngle + p.endAngle) / 2;
        // draw radial line at startAngle
        ctx.beginPath();
        ctx.moveTo(cx + Math.cos(p.startAngle) * (innerR+2), cy + Math.sin(p.startAngle) * (innerR+2));
        ctx.lineTo(cx + Math.cos(p.startAngle) * outerR, cy + Math.sin(p.startAngle) * outerR);
        ctx.stroke();
      }

      // labels (address short) along middle of sector
      ctx.fillStyle = '#fff';
      ctx.font = '12px Ubuntu'; // [PERBAIKAN] Ganti ke Ubuntu
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      for (let i=0;i<playersArray.length;i++){
        const p = playersArray[i];
        const mid = (p.startAngle + p.endAngle) / 2;
        const rlabel = (outerR + innerR) / 2;
        const lx = cx + Math.cos(mid) * rlabel;
        const ly = cy + Math.sin(mid) * rlabel;
        const short = p.addr.slice(0,6);
        ctx.fillStyle = 'rgba(0,12,20,0.85)';
        // draw small pill background for readability
        ctx.beginPath();
        ctx.fillStyle = 'rgba(255,255,255,0.85)';
        ctx.roundRect = ctx.roundRect || function(x,y,w,h,r){ if (w<2*r) r=w/2; if (h<2*r) r=h/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill(); };
        // approximate pill
        const text = short;
        ctx.font = '12px Ubuntu';
        const tw = ctx.measureText(text).width + 8;
        // draw pill in two colors (hybrid effect)
        ctx.fillStyle = 'rgba(0,0,0,0.45)';
        ctx.roundRect(lx - tw/2, ly - 12/2, tw, 16, 8);
        ctx.fillStyle = '#fff';
        ctx.fillText(text, lx, ly);
      }

      ctx.restore();
    }

    // polyfill for roundRect if needed
    if (!CanvasRenderingContext2D.prototype.roundRect) {
      CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
        if (w<2*r) r=w/2; if (h<2*r) r=h/2;
        this.beginPath();
        this.moveTo(x+r,y);
        this.arcTo(x+w,y,x+w,y+h,r);
        this.arcTo(x+w,y+h,x,y+h,r);
        this.arcTo(x,y+h,x,y,r);
        this.arcTo(x,y,x+w,y,r);
        this.closePath();
        this.fill();
      };
        }

// [BARU] Fungsi "Bridge"
function rebuildPlayersArrayAndDraw() {
    playersArray = []; // Kosongkan array
    const playerKeys = Object.keys(players);
    
    // Konversi objek 'players' ke 'playersArray'
    for (const key of playerKeys) {
        playersArray.push({
            addr: players[key].id,
            weight: players[key].weight, // Ambil bobot yang sudah dihitung
            color: players[key].color
        });
    }

    // Hitung sudut untuk canvas (dalam radian)
    let currentAngle = 0;
    const totalW = totalWeight; // Gunakan totalWeight global
    
    for (const p of playersArray) {
        p.startAngle = currentAngle;
        let percentage = 0;
        if (totalW.gt(0)) {
            // Hitung persentase dari BigNumber
            percentage = p.weight.mul(1000000).div(totalW).toNumber() / 1000000;
        }
        // Sudut dalam Radian (Math.PI * 2 = 360 derajat)
        p.endAngle = currentAngle + (percentage * Math.PI * 2);
        currentAngle = p.endAngle;
    }
    
    // Gambar ulang donut dengan data baru
    drawDonut();
}

  
  
  // ======= Weighted random selection (client-side) =======
    function pickWinnerClientSide() {
      if (!playersArray || playersArray.length === 0) return null;
      const total = playersArray.reduce((acc,p)=> acc + p.weight, 0n);
      if (total === 0n) return null;
      // random BigInt in range [0, total-1]
      const rand = randBigInt(total);
      let cum = 0n;
      for (let i=0;i<playersArray.length;i++){
        cum += playersArray[i].weight;
        if (rand < cum) return playersArray[i];
      }
      return playersArray[playersArray.length-1];
    }

  function randBigInt(max) {
      // use crypto.getRandomValues to build randomness
      // build a random BigInt less than max
      const bytes = Math.ceil((max.toString(2).length)/8);
      let rand;
      do {
        const arr = new Uint8Array(bytes);
        window.crypto.getRandomValues(arr);
        rand = 0n;
        for (let i=0;i<arr.length;i++) rand = (rand << 8n) + BigInt(arr[i]);
      } while (rand >= max);
      return rand;
    }

// ======= Spin animation =======
function spinToPlayer(targetPlayer) {
  return new Promise((resolveAnimation) => { // Bungkus animasi dalam Promise
      if (!targetPlayer) {
          resetAndFetchNewRound();
          resolveAnimation(); return;
      }

      // ... (perhitungan sudut sama seperti sebelumnya) ...
      const midRad = (targetPlayer.startAngle + targetPlayer.endAngle) / 2;
      const midDeg = (midRad * 180 / Math.PI);
      const targetRotationDeg = 270 - midDeg;
      
      const duration = Math.floor(Math.random() * (40000 - 30000 + 1)) + 30000;
      const spins = Math.floor(duration / 1200); 
      const finalRotation = (spins * 360) + targetRotationDeg;
      const startRotation = currentRotation; 
      const startTime = performance.now();

      function animate(now) {
        const t = Math.min(1, (now - startTime) / duration);
        const eased = 1 - Math.pow(1 - t, 4);
        currentRotation = startRotation + ((finalRotation - startRotation) * eased); // Rumus rotasi yang lebih stabil
        drawDonut(currentRotation);
        
        if (t < 1) {
          requestAnimationFrame(animate);
        } else {
          // ANIMASI SELESAI!
          isSpinning = false; 
          
          // Tampilkan alert pemenang SEKARANG
          const winnerId = targetPlayer.addr;
          const isWinner = (userAddress && winnerId.toLowerCase() === userAddress.toLowerCase());
          const winnerName = isWinner ? "YOU!" : winnerId.slice(0, 6) + "...";
          statusText.innerText = `Winner is ${winnerName}`;
          alert(`🎉 WINNER: ${winnerName} 🎉`);
          
          // Reset game untuk ronde berikutnya
          resetAndFetchNewRound(); 
          
          resolveAnimation(); // Beri tahu handleRoundFinalized bahwa kita sudah selesai
        }
      }
      requestAnimationFrame(animate);
  });
}

// [BARU] Fungsi untuk menampilkan/menyembunyikan Modal Wallet
function showWalletModal() {
    walletModalOverlay.classList.add("show");
    walletModal.classList.add("show");
}
function hideWalletModal() {
    walletModalOverlay.classList.remove("show");
    walletModal.classList.remove("show");
}

// [BARU] Fungsi khusus untuk Disconnect
function disconnectWallet() {
    userAddress = null; provider = null; signer = null;
    walletBtn.innerText = "Connect Wallet";
    referralBtn.style.display = "none";
    statusText.innerText = "Wallet not connected";
    
    hideWalletModal(); // Sembunyikan modal
    
    if (visualTimer) clearInterval(visualTimer);
    if (faylottoContract) faylottoContract.removeAllListeners(); // Cek dulu
    
    resetRoundUI();
    myEthDeposit.innerText = "0"; 
    myUsdtDeposit.innerText = "0";
    winnerList.innerHTML = "";
    winnerList.appendChild(winnerListPlaceholder);

    // Reset info di modal
    walletAddress.innerText = "-";
    ethBalance.innerText = "0";
    usdtBalance.innerText = "0";
}

// [BARU] Fungsi khusus untuk menggambar ulang canvas
function handleCanvasRedraw() {
    // Cek apakah 'ctx' (konteks canvas) sudah ada
    if (ctx) {
        console.log("Window/Tab kembali aktif. Menggambar ulang canvas...");
        // Paksa gambar ulang donut dengan rotasi terakhir
        drawDonut(currentRotation);
    }
}

// === 4. Inisialisasi & Event Listeners ===

document.addEventListener("DOMContentLoaded", () => {
    // --- Listener Tombol Utama ---
    walletBtn.addEventListener("click", () => {
        if (!userAddress) {
            toggleWallet();
        } else {
            showWalletModal();
        }
    });
    placeBetBtn.addEventListener("click", showBetModal);
    finalizeBtn.addEventListener("click", callFinalizeRound);

    // --- Listener Modal Bet ---
    betModalCloseBtn.addEventListener("click", hideBetModal);
    betModalOverlay.addEventListener("click", hideBetModal);
    confirmBetBtn.addEventListener("click", confirmBet);
    percentButtons.forEach(button => {
        button.addEventListener("click", () => {
            const percent = parseFloat(button.dataset.percent);
            setAmountByPercent(percent);
        });
    });

    // --- Listener Modal Referral ---
    // Pastikan elemen-elemen ini ada di HTML kamu
    if (referralBtn) referralBtn.addEventListener("click", showReferralModal);
    if (referralModalCloseBtn) referralModalCloseBtn.addEventListener("click", hideReferralModal);
    if (referralModalOverlay) referralModalOverlay.addEventListener("click", hideReferralModal);
    if (createNicknameBtn) createNicknameBtn.addEventListener("click", callCreateNickname);
    if (setReferrerBtn) setReferrerBtn.addEventListener("click", callSetReferrer);
    if (claimRewardsBtn) claimRewardsBtn.addEventListener("click", callClaimRewards);

    // --- Listener Modal Wallet ---
    if (walletModalCloseBtn) walletModalCloseBtn.addEventListener("click", hideWalletModal);
    if (walletModalOverlay) walletModalOverlay.addEventListener("click", hideWalletModal);
    if (disconnectBtn) disconnectBtn.addEventListener("click", disconnectWallet);

    // --- Listener Copy Referral ---
    const copyBtn = document.getElementById("copyReferralBtn");
    if (copyBtn) {
        copyBtn.addEventListener("click", () => {
            const linkInput = document.getElementById("referralLinkInput");
            if (linkInput) {
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); // Dukungan mobile
                navigator.clipboard.writeText(linkInput.value)
                    .then(() => alert("Referral link copied to clipboard!"))
                    .catch(err => {
                        console.error("Failed to copy: ", err);
                        // Fallback
                        try {
                            document.execCommand('copy');
                            alert("Referral link copied to clipboard!");
                        } catch (ex) {
                            alert("Failed to copy link automatically.");
                        }
                    });
            }
        });
    }

    // --- Listener Lainnya ---
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') {
            handleCanvasRedraw();
        }
    });
});

</script>
</body>
  </html>
