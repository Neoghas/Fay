<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Wheel</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.6.4/dist/ethers.umd.min.js"></script>
<style>
  html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  overflow-x: hidden; /* mencegah geser horizontal */
  }
  
body {
    font-family: 'Ubuntu', sans-serif;
    font-weight: bold;
    text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3);
    text-align: center;
    margin: 0;
    padding: 0;
    width: 100%;
    background-color: #000;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    font-size: 1rem; /* Gunakan rem agar fleksibel */
    padding-top: 70px; /* Memberikan ruang untuk navbar */
}

/* Container */
.container {
    width: 100%; /* Gunakan persentase agar fleksibel */
    max-width: 1250px;
    margin: auto;
    padding: 20px;
    background: #000000;
    box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    backdrop-filter: blur(10px);
    box-sizing: border-box;
    align-items: center;
    margin-top: 20px; /* Tambahkan jarak dari navbar */
}

/* Media Query untuk layar kecil (Laptop kecil & Tablet) */
@media (max-width: 1024px) {
    body {
        font-size: 0.9rem;
    }
    .container {
        width: 95%;
    }
}

/* Media Query untuk layar sangat kecil (Tablet & Mobile) */
@media (max-width: 768px) {
    body {
        font-size: 0.8rem;
    }
    .container {
        width: 100%;
        padding: 15px;
    }
}

/* Media Query untuk layar besar (Monitor besar & Ultrawide) */
@media (min-width: 1600px) {
    body {
        font-size: 1.2rem;
    }
    .container {
        max-width: 1200px;
    }
}
  
  /* === Hero Section === */
.hero {
  position: relative;
  text-align: center;
  margin-top: 140px; /* kasih jarak dari navbar */
  margin-bottom: 40px;
  animation: fadeIn 1.2s ease-in-out;
}

.hero-title {
  font-size: 35px;
  font-weight: 700;
  background: linear-gradient(90deg, #03a9f4, #f441a5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 12px rgba(180,140,255,0.35));
  letter-spacing: 1px;
}

.hero-subtitle {
  font-size: 20px;
  margin-top: 12px;
  color: #e7dbff;
  opacity: 0.9;
  filter: drop-shadow(0 0 6px rgba(160,120,255,0.25));
}

  .hero.scrolled .wallet-info {
  opacity: 0;
  pointer-events: none;
  }

/* animasi soft fade */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

  /* === Navbar === */
.navbar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 70px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(10, 10, 20, 0.85);
  backdrop-filter: blur(8px);
  padding: 0 35px; /* ‚Üê Tambahkan ruang kanan agar tombol tidak kepotong */
  box-sizing: border-box;
  z-index: 9999;
}
  
/* === Logo dan Brand === */
.navbar-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo {
  width: 42px;
  height: 42px;
  object-fit: contain;
}

.brand-name {
  font-family: 'Ubuntu', sans-serif;
  font-size: 24px;
  font-weight: 700;
  background: linear-gradient(90deg, #03a9f4, #f441a5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: 1px;
}

/* === Wallet Buttons === */
.wallet-controls {
  display: flex;
  flex-direction: row;
  gap: 10px;
  align-items: center;
  margin-right: 5px; /* Tambahan kecil biar sejajar halus */
}

/* Tombol futuristik smooth */
.wallet-btn {
  background: linear-gradient(135deg, #00e0ff, #0077ff, #a855f7);
  background-size: 300% 300%;
  color: #fff;
  font-weight: bold;
  border: 2px solid rgba(255, 255, 255, 0.25);
  border-radius: 20px;
  padding: 10px 22px;
  cursor: pointer;
  transition: transform 0.4s ease, box-shadow 0.4s ease;
  animation: neonFlow 6s ease infinite;
  box-shadow: 0 0 6px rgba(0, 255, 255, 0.25);
}

/* Hover efek slow dan smooth */
.wallet-btn:hover {
  transform: scale(1.06);
  box-shadow: 0 0 14px rgba(0, 255, 255, 0.5);
}

/* Animasi aliran warna halus */
@keyframes neonFlow {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

/* Klik (active): sedikit redup */
.wallet-btn:active {
  transform: scale(0.97);
  filter: brightness(0.9);
}
  
  /* Wallet info box futuristik */
.wallet-info {
  position: absolute;
  top: 25px;
  right: 25px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  background: linear-gradient(135deg, #00d4ff, #b28aff, #ff80c8);
  padding: 14px 20px;
  border-radius: 14px;
  color: #fff;
  font-weight: bold;
  box-shadow: 0 0 8px rgba(0, 255, 255, 0.1);
  transition: box-shadow 0.5s ease-in-out, transform 0.5s ease-in-out;
  overflow: hidden;
}

/* === Efek garis tepi bergerak seperti aliran listrik === */
.wallet-info::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 14px;
  padding: 2px; /* ketebalan garis luar */
  background: linear-gradient(
    120deg,
    #00ffff,
    #b28aff,
    #ff80c8,
    #00ffff
  );
  background-size: 300% 300%;
  animation: borderFlow 5s linear infinite;
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask-composite: exclude; /* Firefox pakai -moz, Chrome pakai standard */
  -webkit-mask-composite: xor;
  pointer-events: none;
}

/* Efek kilauan listrik bergerak */
@keyframes borderFlow {
  0% {
    background-position: 0% 50%;
    filter: drop-shadow(0 0 2px #00ffff) drop-shadow(0 0 5px #ff80c8);
  }
  50% {
    background-position: 100% 50%;
    filter: drop-shadow(0 0 6px #00ffff) drop-shadow(0 0 12px #b28aff);
  }
  100% {
    background-position: 0% 50%;
    filter: drop-shadow(0 0 2px #00ffff) drop-shadow(0 0 5px #ff80c8);
  }
}

/* Glow lembut keseluruhan (bisa dipicu JS) */
@keyframes softGlow {
  0% {
    box-shadow: 0 0 3px rgba(0, 255, 255, 0.1),
                0 0 6px rgba(255, 128, 200, 0.05);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 8px rgba(0, 255, 255, 0.25),
                0 0 12px rgba(178, 138, 255, 0.15);
    transform: scale(1.01);
  }
  100% {
    box-shadow: 0 0 3px rgba(0, 255, 255, 0.1),
                0 0 6px rgba(255, 128, 200, 0.05);
    transform: scale(1);
  }
}

/* Aktifkan saat connect wallet */
.glow {
  animation: softGlow 5s ease-in-out;
}

/* Aktifkan saat connect wallet */
.glow {
  animation: softGlow 5s ease-in-out;
}

  .wallet-address {
  cursor: pointer;
  user-select: none;
}
.wallet-address:hover {
  opacity: 0.8;
}

.wallet-address {
  font-size: 14px;
  font-weight: bold;
  color: #fff;
}

.wallet-balance {
  font-size: 13px;
  color: #fff;
}

  .wheel-container {
  position: relative;
  max-width: 500px;
  aspect-ratio: 1 / 1;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: visible;
  }

  /* Pastikan animasi yang keluar dari SVG terlihat */
svg {
    width: 100%;
    height: 100%;
    display: block;
    overflow: visible;  /* kunci supaya efek glow tidak terpotong */
}

/* Optional: jika ada group <g> di dalam SVG */
svg g {
    transform-origin: center center;
    overflow: visible;
}

/* Lingkaran listrik menempel di tepi wheel */
.wheel-container::after {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border-radius: 50%;
  border: 7px solid transparent;
  background: conic-gradient(
    from 0deg,
    #00eaff,
    #7b00ff,
    #ff5edc,
    #00eaff
  );
  mask: radial-gradient(farthest-side, transparent calc(100% - 6px), black 100%);
  -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 3px), black 100%);
  animation: electricFlow 2.5s linear infinite, sparkFlicker 1.2s ease-in-out infinite alternate;
  box-shadow:
    0 0 10px #00eaff,
    0 0 20px #b44bff,
    0 0 30px #ff6be7,
    inset 0 0 12px #00eaff;
  pointer-events: none;
  z-index: 10;
}

/* Efek arus listrik mengalir melingkar */
@keyframes electricFlow {
  0% {
    transform: rotate(0deg);
    filter: hue-rotate(0deg) brightness(1);
  }
  100% {
    transform: rotate(360deg);
    filter: hue-rotate(360deg) brightness(1.3);
  }
}

/* Percikan cepat saat spin */
@keyframes sparkFlickerFast {
  0%, 100% { opacity: 0.95; }
  50% { opacity: 1; }
}

#centerBtn {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 85px;
  height: 85px;
  transform: translate(-50%, -50%);
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #0ff, #7b00ff, #ff58d6);
  color: #fff;
  font-weight: bold;
  font-size: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: 3px solid transparent;
  box-shadow:
    0 0 25px rgba(0, 255, 255, 0.8),
    0 0 45px rgba(170, 0, 255, 0.6),
    inset 0 0 15px rgba(255, 90, 220, 0.8);
  z-index: 15;
  transition: all 0.3s ease;
  animation: btnGlow 2s ease-in-out infinite alternate;
  overflow: hidden;
}

/* Efek aliran listrik melingkar */
#centerBtn::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 3px solid transparent;
  background: conic-gradient(
    from 0deg,
    #00ffff,
    #7b00ff,
    #ff58d6,
    #00ffff
  );
  mask: radial-gradient(farthest-side, transparent calc(100% - 3px), black 100%);
  -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 3px), black 100%);
  animation: electricRing 1.8s linear infinite;
  pointer-events: none;
  z-index: 1;
}

/* Glow lembut di tombol */
@keyframes btnGlow {
  0% {
    box-shadow:
      0 0 20px #00ffff,
      0 0 40px #7b00ff,
      inset 0 0 15px #ff58d6;
    transform: translate(-50%, -50%) scale(1);
  }
  50% {
    box-shadow:
      0 0 30px #00ffff,
      0 0 60px #b44bff,
      inset 0 0 20px #ff6be7;
    transform: translate(-50%, -50%) scale(1.05);
  }
  100% {
    box-shadow:
      0 0 20px #00ffff,
      0 0 40px #7b00ff,
      inset 0 0 15px #ff58d6;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* Hover ‚Äì nyala lebih terang */
#centerBtn:hover {
  filter: brightness(1.3);
  box-shadow:
    0 0 35px #00ffff,
    0 0 70px #ff6be7,
    inset 0 0 25px #ff8cff;
}

/* Teks cost ETH di bawah SPIN */
#centerBtn .cost {
  font-size: 10px;
  color: #fff;
  font-weight: bold;
  margin-top: 2px;
  text-shadow: 0 0 5px #00ff6a, 0 0 10px #00ff6a;
}

  .result {
    margin-top: 30px;
    font-size: 20px;
    text-align: center;
    transition: all 0.5s ease;
    min-height: 30px;
  }

  @keyframes pulseGlow {
  0% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px #00ffff)
            drop-shadow(0 0 20px #a26bff)
            drop-shadow(0 0 30px #ff70b8);
  }
  50% {
    transform: scale(1.1);
    filter: drop-shadow(0 0 15px #6bffff)
            drop-shadow(0 0 30px #b57bff)
            drop-shadow(0 0 45px #ff7bd6);
  }
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px #00ffff)
            drop-shadow(0 0 20px #a26bff)
            drop-shadow(0 0 30px #ff70b8);
  }
}

.glow {
  animation: pulseGlow 1s infinite alternate;
  transform-origin: center center;
}

/* container utama popup */
.result-popup {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(120, 0, 255, 0.15);
  backdrop-filter: blur(15px) saturate(180%);
  -webkit-backdrop-filter: blur(15px) saturate(180%);
  border: 1.5px solid rgba(160, 0, 255, 0.3);
  border-radius: 22px;
  padding: 28px 40px;
  text-align: center;
  font-size: 20px;
  color: #fff;
  z-index: 9999;
  display: none;
  opacity: 0;
  transition: opacity 0.8s ease, transform 0.8s ease;
  box-shadow:
    inset 0 0 20px rgba(200, 0, 255, 0.25),
    0 0 25px rgba(187, 0, 255, 0.4),
    0 0 50px rgba(0, 255, 255, 0.2);
  animation: softGlow 18s ease-in-out infinite alternate, 
             subtleScale 18s ease-in-out infinite alternate;
  overflow: hidden;
}

/* glow lembut */
@keyframes softGlow {
  0% {
    box-shadow:
      inset 0 0 18px rgba(200, 0, 255, 0.2),
      0 0 25px rgba(187, 0, 255, 0.3),
      0 0 50px rgba(0, 255, 255, 0.15);
  }
  50% {
    box-shadow:
      inset 0 0 22px rgba(200, 0, 255, 0.25),
      0 0 30px rgba(187, 0, 255, 0.35),
      0 0 55px rgba(0, 255, 255, 0.2);
  }
  100% {
    box-shadow:
      inset 0 0 18px rgba(200, 0, 255, 0.2),
      0 0 25px rgba(187, 0, 255, 0.3),
      0 0 50px rgba(0, 255, 255, 0.15);
  }
}
  
@keyframes subtleScale {
  0%, 100% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -50%) scale(1.02); }
}
  
/* partikel lembut melayang */
.result-popup span.particle {
  position: absolute;
  border-radius: 50%;
  opacity: 0.6;
  animation: floatSoft 10s infinite ease-in-out alternate;
}

@keyframes floatSoft {
  0% {
    transform: translate(0, 0) scale(1);
    opacity: 0.5;
  }
  50% {
    transform: translate(20px, -30px) scale(1.3);
    opacity: 0.9;
  }
  100% {
    transform: translate(-15px, 25px) scale(1);
    opacity: 0.6;
  }
}

/* efek muncul / hilang */
.result-popup.show {
  display: block;
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}

.result-popup.hide {
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.97);
  pointer-events: none;
}

.result-popup img.icon {
  width: 60px;
  height: 60px;
  vertical-align: middle;
  margin-bottom: 10px;
}

.result-popup img.prize {
  width: 55px;
  height: 55px;
  vertical-align: middle;
  margin-left: 10px;
  border-radius: 12px;
  box-shadow: 0 0 10px gold;
}

.popup-btn {
  margin-top: 18px;
  background: linear-gradient(145deg, #ff00c8, #8a2be2, #00f0ff);
  border: none;
  border-radius: 10px;
  color: #fff;
  font-weight: bold;
  padding: 10px 22px;
  cursor: pointer;
  transition: 0.2s;
  box-shadow: 0 0 10px #ff00ff;
}

.popup-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px #00f0ff;
}

  /* ===== Minimal Footer Style ===== */
  footer {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        background: #000; /* Warna gelap */
        color: #ddd; /* Warna teks */
        font-size: 12px;
    }

    .social-icons {
        margin-bottom: 10px;
    }

    .social-icons a {
    background: rgba(255, 255, 255, 0.2); /* Transparan seperti kaca */
    border-radius: 10px; /* Agar sedikit membulat */
    padding: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white; /* Warna ikon */
    font-size: 15px;
    margin: 0 5px;
    text-decoration: none;
    transition: transform 0.5s ease, text-shadow 0.5s ease, box-shadow 0.5s ease;
    box-shadow: 0 0 10px rgba(0, 0, 255, 0.6); /* Cahaya biru */
    backdrop-filter: blur(10px); /* Efek blur kaca */
}

/* Efek saat hover */
.social-icons a:hover {
    color: #1a88ff; /* Warna biru neon */
    text-shadow: 0 0 10px #1a88ff, 0 0 20px #1a88ff, 0 0 30px #1a88ff; /* Glow lebih intens */
    box-shadow: 0 0 20px rgba(0, 0, 255, 1), 0 0 30px rgba(0, 0, 255, 0.8); /* Shadow lebih terang */
    transform: rotate(360deg); /* Efek berputar */
}

  /* Spin History */
  
   .history-container {
    margin: 20px auto;
    border: 2px solid #444;
    border-radius: 8px;
    overflow: hidden;
  }
  .history-container h2 {
    background: linear-gradient(90deg, #03a9f4, #f441a5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    padding: 10px;
    margin: 0;
    text-align: center;
  }
  #userHistory, #publicHistory {
    overflow-y: auto; /* Agar bisa di-scroll */
    height: 400px; /* Tinggi tetap, sesuaikan sesuai kebutuhan */
    padding: 10px;
  }
  .history-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .history-list li {
    background: #101010;
    margin: 10px 0;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    font-size: 14px;
    line-height: 1.5;
    border: 2px solid #1a1a2e;
    text-align: left;
  }
  .loader {
    text-align: center;
    padding: 10px;
    font-style: italic;
    color: gray;
    display: none; /* Awalnya hidden, JS akan tampilkan saat load */
  }
  button.load-btn {
    display: block;
    margin: 10px auto;
    padding: 10px 20px;
    background: linear-gradient(90deg, #03a9f4, #f441a5);
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
  }
  button.load-btn:hover {
    background: linear-gradient(135deg, #00e0ff, #0077ff, #a855f7);
  }

  /* ========== STYLING REFERRAL ========== */
.referral-container {
  background-color: #101010; /* Sedikit lebih gelap */
  padding: 20px;
  border-radius: 10px;
  border: 2px solid #444;
  margin-top: 25px;
  display: none; /* Sembunyi secara default, JS akan menampilkan */
}

.referral-container h2 {
  margin-top: 0;
  background: linear-gradient(90deg, #03a9f4, #f441a5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  text-align: center;
}

.status-text {
  text-align: center;
  color: #aaa;
  font-style: italic;
  margin-bottom: 15px;
}

/* Sembunyikan view default */
#noUidView,
#hasUidView,
#claimRewardBtn {
  display: none;
}

.ref-btn {
  background-color: #007bff;
  color: #ffffff;
  font-weight: bold;
  border: 2px solid #004a99
  padding: 10px 15px;
  border-radius: 10px;
  cursor: pointer;
  transition: background-color 0.3s;
  width: 100%;
  font-size: 16px;
}

.ref-btn:hover:not(:disabled) {
  background-color: #e67e22;
}

.ref-btn:disabled {
  background-color: #555;
  cursor: not-allowed;
}

.ref-btn.claim-btn {
  background-color: #28a745; /* Hijau */
  color: white;
}
.ref-btn.claim-btn:hover:not(:disabled) {
  background-color: #27ae60;
}

.info-box {
  margin-bottom: 15px;
}

.info-box strong {
  display: block;
  color: #bbb;
  margin-bottom: 5px;
}

.uid-display {
  font-size: 1.2em;
  color: #28a745;
  font-weight: bold;
  font-family: 'Courier New', Courier, monospace;
}

.link-wrapper {
  display: flex;
}

.link-wrapper input[type="text"] {
  flex-grow: 1;
  padding: 8px;
  background-color: #1a1a2e;
  border: 1px solid #444;
  color: white;
  border-radius: 5px 0 0 5px;
}

.small-btn {
  width: auto;
  font-size: 14px;
  border-radius: 0 5px 5px 0;
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin: 20px 0;
}

.stat-item {
  background-color: #1a1a2e;
  padding: 15px;
  border-radius: 5px;
  text-align: center;
}

.stat-item span {
  display: block;
  color: #aaa;
  font-size: 0.9em;
}

.stat-item strong {
  display: block;
  font-size: 1.5em;
  color: white;
  margin-top: 5px;
}

/* Tombol Like/Unlike */
.like-btn {
  background: #333;
  color: #eee;
  border: 2px solid #555;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 10px;
  font-size: 13px;
  font-weight: bold;
  display: inline-flex; /* Agar ikon dan teks sejajar */
  align-items: center;
  gap: 5px; /* Jarak antara ikon dan teks */
}
  
.like-btn img {
  width: 16px;
  height: 16px;
  vertical-align: middle;
}
.like-btn:hover:not(:disabled) {
  background: #444;
}
.like-btn:disabled {
  background: #555;
  cursor: not-allowed;
}

/* State "Liked" (Tombol menjadi Unlike) */
.like-btn.liked {
  background: #ff6666;
  border-color: #cc0000;
  color: white;
}
.like-btn.liked:hover:not(:disabled) {
  background: #0056b3;
}

/* Rating Bintang */
.star-rating {
  font-size: 22px; /* Ukuran bintang */
  cursor: pointer;
  display: inline-block;
  color: #777; /* Warna bintang kosong */
}
.star-rating span {
  transition: color 0.2s; /* Efek hover halus */
}
.star-rating span.filled {
  color: #f39c12; /* Warna bintang terisi (emas) */
}
.star-rating span.hover {
  color: #f7b74f; /* Warna saat di-hover (emas lebih muda) */
}
.avg-rating {
  font-size: 12px; 
  color: #999;
  margin-left: -10px; /* Sedikit ke kiri agar dekat bintang */
}

/* === STYLING FITUR KOMENTAR === */

/* Tombol Pemicu Komentar */
.comment-toggle-btn {
  background: #333;
  color: #eee;
  border: 2px solid #555;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 10px;
  font-size: 13px;
  font-weight: bold;
}
.comment-toggle-btn:hover {
  background: #444;
}
.comment-toggle-btn img { /* Style untuk ikon di tombol */
  width: 16px;
  height: 16px;
  vertical-align: middle;
  margin-right: 5px; /* Jarak ikon ke teks */
}

/* Kontainer utama komentar */
.comments-section {
  margin-top: 15px;
  border-top: 1px solid #555;
  padding-top: 10px;
}

/* Daftar komentar */
.comments-list {
  max-height: 200px; /* Batasi tinggi, beri scroll jika banyak */
  overflow-y: auto;
  margin-bottom: 10px;
  padding-right: 5px; /* Ruang untuk scrollbar */
}
.loader-comment {
  font-style: italic;
  color: #888;
}
/* Setiap item komentar (Style "Kolom" Baru) */
.comment-item {
  /* HAPUS border-bottom: 1px solid #444; */
  background: #1a1a2e; /* Beri background (seperti list riwayat) */
  border-radius: 6px;   /* Buat sudutnya melengkung */
  padding: 10px;        /* Beri padding di dalam kotak */
  margin-bottom: 8px;   /* Beri jarak antar kotak komentar */
  font-size: 13px;
  line-height: 1.4;
}

.comment-item strong {
  color: #f39c12; /* Oranye */
  font-size: 14px;
}
.comment-item small {
  color: #999;
  display: inline;
  margin-left: 10px;
}
.comment-item p {
  margin: 4px 0 0 0; 
  word-wrap: break-word;
  white-space: pre-wrap; /* <-- KUNCI: Membuat \n (Enter) tampil sebagai baris baru */
}

/* Area input komentar baru */
.comment-input-area {
  display: flex;
  margin-top: 10px;
  align-items: flex-start; /* <-- TAMBAHKAN BARIS INI */
}
.comment-input-area textarea {
  flex-grow: 1; 
  background: #1a1a2e;
  border: 1px solid #555;
  color: white;
  padding: 8px;
  border-radius: 4px;
  font-family: Arial, sans-serif;
  font-weight: normal;
  resize: vertical; /* Memungkinkan user menarik/memperbesar kotak secara vertikal */
}
.comment-input-area button {
  background: #007bff;
  border: 2px solid #004a99;
  color: #ffffff;
  font-weight: bold;
  padding: 8px 12px;
  margin-left: 5px;
  border-radius: 10px;
  cursor: pointer;
}
.comment-input-area button:disabled {
  background: #555;
}

.edit-btn {
  background: #007bff;
  border: 2px solid #004a99;
  border-radius: 10px;
  color: #ffffff;
  font-size: 12px;
  cursor: pointer;
  padding: 5px 10px;
  margin-right: 10px;
  font-weight: bold;
  float: right;
}

.edit-btn:hover {
  text-decoration: underline;
}

/* Area Mode Edit (Textarea, Save, Cancel) */
.comment-edit-mode {
  display: none; /* Sembunyi secara default */
  margin-top: 5px;
}
.comment-edit-mode textarea {
  width: 95%; /* Sedikit lebih sempit agar pas */
  min-height: 50px;
  background: #333;
  color: white;
  border: 1px solid #666;
  border-radius: 4px;
  padding: 5px;
  margin-bottom: 5px;
  font-family: Arial, sans-serif; /* Samakan font */
}
.comment-edit-mode button {
  background: #28a745; /* Hijau untuk "Save" */
  color: white;
  border: 2px solid #69c17d;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 10px;
  font-weight: bold;
}
.comment-edit-mode button.cancel-btn {
  background: #777; /* Abu-abu untuk "Cancel" */
  margin-left: 5px;
  border: 2px solid #535353;
}
.comment-edit-mode button:disabled {
  background: #555;
}

  /* === STYLING MODAL PROFIL (SAMA SEPERTI SEBELUMNYA) === */
.profile-modal-backdrop {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(5px);
  z-index: 9998;
  display: none; /* Diubah oleh JS */
  align-items: center; justify-content: center;
  opacity: 0; transition: opacity 0.3s ease;
}
.profile-modal-content {
  background: #2c2c3a; border: 1px solid #555;
  border-radius: 12px; padding: 20px 25px;
  width: 90%; max-width: 500px;
  box-shadow: 0 5px 25px rgba(0,0,0,0.5);
  position: relative;
  transform: scale(0.95); transition: transform 0.3s ease;
  color: #eee;
}
.profile-modal-backdrop.show { opacity: 1; }
.profile-modal-backdrop.show .profile-modal-content { transform: scale(1); }
.profile-modal-close {
  position: absolute; top: 10px; right: 15px;
  background: none; border: none; color: #aaa;
  font-size: 30px; font-weight: bold; cursor: pointer;
}
.profile-modal-content h3 { margin-top: 0; color: #f39c12; text-align: center; }
.profile-address-display {
  font-family: 'Courier New', Courier, monospace; font-size: 14px;
  background: #1a1a2e; padding: 8px; border-radius: 5px;
  word-wrap: break-word; text-align: center; color: #f39c12; margin-bottom: 15px;
}
.profile-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.profile-stat-item { background: #1a1a2e; padding: 10px; border-radius: 5px; text-align: center; }
.profile-stat-item span { display: block; font-size: 0.8em; color: #aaa; }
.profile-stat-item strong { display: block; font-size: 1.2em; color: white; margin-top: 5px; }
.profile-details { background: #1a1a2e; padding: 15px; border-radius: 5px; font-size: 14px; line-height: 1.6; }
.profile-details span { color: white; font-weight: bold; }

/* CSS untuk PFP (Tanpa Tombol Edit) */
.pfp-container {
  width: 100px; height: 100px;
  margin: 0 auto 15px auto; /* Pusatkan */
}
#profile-modal-pfp {
  width: 100%; height: 100%;
  border-radius: 50%; /* Bulat */
  border: 3px solid #f39c12;
  object-fit: cover;
  background-color: #1a1a2e; /* Warna latar jika gambar gagal dimuat */
}

/* CSS untuk Alamat yang Bisa Diklik */
.clickable-address {
  color: #00aaff;
  cursor: pointer;
  text-decoration: underline;
  font-weight: bold; /* Buat lebih menonjol */
}
.clickable-address:hover {
  color: #4dc4ff;
}

  /* === STYLING PFP DI RIWAYAT === */
.bet-item-header {
  display: flex;
  align-items: center; /* Sejajarkan PFP & Info */
  gap: 10px; /* Jarak antara PFP dan Info */
  margin-bottom: 10px; /* Jarak ke detail di bawahnya */
}

.history-pfp {
  width: 40px;
  height: 40px;
  border-radius: 50%; /* Bulat */
  border: 2px solid #f39c12; /* Border oranye */
  object-fit: cover;
  flex-shrink: 0; /* Mencegah gambar menyusut */
  cursor: pointer; /* Menunjukkan bisa diklik */
}

.history-info-stack {
  display: flex;
  flex-direction: column; /* Tumpuk Spin ID dan Hasil */
}
.history-info-stack strong {
  font-size: 1.1em;
}

.bet-item-details {
  padding-left: 50px; /* (40px PFP + 10px gap) -> Beri indentasi agar rapi */
  font-size: 14px;
  color: #ccc;
  line-height: 1.6;
}

  /* === STYLING PFP DI KOMENTAR === */

/* Ubah .comment-item menjadi flex container */
.comment-item {
  /* ... (style lama Anda seperti background, padding, margin) ... */
  background: #1a1a2e; 
  border-radius: 6px;   
  padding: 10px;        
  margin-bottom: 8px;   
  font-size: 13px;
  line-height: 1.4;
  
  /* --- Tambahan Baru --- */
  display: flex;         /* Aktifkan flexbox */
  gap: 10px;             /* Jarak antara PFP dan Konten */
  align-items: flex-start; /* Sejajarkan PFP di atas */
}

.comment-pfp-wrapper {
  flex-shrink: 0; /* Mencegah PFP menyusut */
}

.comment-pfp {
  width: 35px;  /* Ukuran PFP lebih kecil */
  height: 35px;
  border-radius: 50%; /* Bulat */
  object-fit: cover;
  cursor: pointer;
  border: 1px solid #555;
}

.comment-content-wrapper {
  flex-grow: 1; /* Konten mengambil sisa ruang */
  min-width: 0; /* Mencegah teks overflow */
}
</style>
</head>

<body>

  <nav class="navbar">
    <div class="navbar-left">
      <img src="logo.svg" alt="Faylotto Logo" class="logo">
      <span class="brand-name">Faylotto</span>
    </div>

    <div class="wallet-controls">
      <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
      <button id="disconnectBtn" class="wallet-btn" style="display:none;">Disconnect</button>
    </div>
  </nav>

  <div class="container">

<!-- Box info wallet di bawah tombol -->
<div id="walletInfo" class="wallet-info" style="display:none;">
  <div id="walletAddress" class="wallet-address"> Address: -</div>
  <div id="ethBalance" class="wallet-balance">Balance: - ETH</div>
  <div id="faylottoBalance" class="wallet-balance">Balance: - Faylotto</div>
</div>

  <!-- Hero Section -->
<section class="hero">
  <h1 class="hero-title">Decentralized Spin Betting</h1>
  <p class="hero-subtitle">Play, win, and good luck!</p>
</section><br><br>

  <center><div class="wheel-container">
  <svg id="wheel" viewBox="0 0 500 500"></svg>
  <div id="centerBtn">
  SPIN<br>
  <span class="cost"><center>Cost</center>0.000256 ETH</span>
    </div>
  </div></center>
    <div id="resultPopup" class="result-popup"></div>
  <div class="result" id="resultText">Press SPIN to play</div><br><br>

  <!-- Elemen HTML untuk Riwayat Public -->
<div class="history-container">
  <h2>Public Spins</h2>
  <button id="loadPublicHistoryBtn" class="load-btn">Refresh History</button> <!-- Opsional -->
  <div id="publicHistory"></div>
</div>

  <!-- Elemen HTML untuk Riwayat User Pribadi -->
<div class="history-container">
  <h2>Your Spins</h2>
  <button id="loadUserHistoryBtn" class="load-btn">Refresh Your History</button> <!-- Opsional, untuk refresh manual -->
  <div id="userHistory"></div>
</div>

  <div class="referral-container" id="referralSection">
  <h2>
  <img src="star.svg" alt="star" width="30" height="30" />
  Program Referral Anda
  </h2>
  <div id="referralStatus" class="status-text">
    Harap hubungkan wallet untuk melihat info referral.
  </div>

  <div id="noUidView">
    <p>Buat UID untuk mulai mengundang!</p>
    <button id="generateUIDBtn" class="ref-btn">Buat UID Saya</button>
  </div>

  <div id="hasUidView">
    <div class="info-box">
      <strong>UID Anda:</strong>
      <span id="userUID" class="uid-display"></span>
    </div>
    <div class="info-box">
      <strong>Link Undangan:</strong>
      <div class="link-wrapper">
        <input type="text" id="referralLink" readonly />
        <button id="copyLinkBtn" class="ref-btn small-btn">Copy</button>
      </div>
    </div>

    <h3>Statistik Anda</h3>
    <div class="stats-grid">
      <div class="stat-item">
        <span>Total Undangan</span>
        <strong id="referralCount">0</strong>
      </div>
      <div class="stat-item">
        <span>Reward (ETH)</span>
        <strong id="referralReward">0.00</strong>
      </div>
    </div>
    <button id="claimRewardBtn" class="ref-btn claim-btn">
      Klaim Reward Saya
    </button>
  </div>
  </div>

    <div id="userProfileModal" class="profile-modal-backdrop" style="display:none;" onclick="closeProfileModal()">
    <div class="profile-modal-content" onclick="event.stopPropagation()">
        <button class="profile-modal-close" onclick="closeProfileModal()">√ó</button>
        <h3>Profil Player</h3>
        
        <div class="pfp-container">
            <img id="profile-modal-pfp" src="default-pfp.png" alt="Profile Picture">
        </div>
        
        <div class="profile-address-display" id="profile-address">
            (Loading...)
        </div>

        <div class="profile-stats-grid">
            <div class="profile-stat-item">
                <span>Saldo ETH</span>
                <strong id="profile-eth-balance">...</strong>
            </div>
            <div class="profile-stat-item">
                <span>Saldo Faylotto</span>
                <strong id="profile-faylotto-balance">...</strong>
            </div>
            <div class="profile-stat-item">
                <span>Total Undangan</span>
                <strong id="profile-referral-count">...</strong>
            </div>
            <div class="profile-stat-item">
                <span>Total Spin Publik</span>
                <strong id="profile-public-spins">...</strong>
            </div>
        </div>
        
        <div class="profile-details">
            <strong>UID Referral:</strong> <span id="profile-uid">...</span><br>
            <strong>Terdaftar Free Spin:</strong> <span id="profile-free-spin-date">...</span><br>
            <strong>Spin Gratis Terpakai:</strong> <span id="profile-free-spin-used">...</span>
        </div>
    </div>
    </div>
    
  <audio id="clickSound" src="click.mp3" preload="auto"></audio>
  <audio id="spinSound" src="spin.mp3" preload="auto" loop></audio>
  <audio id="winSound" src="win.mp3" preload="auto"></audio>
</div>
  
  <footer>
    <div id="footer" class="social-icons">
        <a href="https://x.com/FaylottoXyz" target="_blank"><i class="fa-brands fa-twitter"></i></a>
        <a href="https://t.me/FaylottoXyz" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://t.me/Faylotto" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://discord.gg/6uMYTdCZwJ" target="_blank"><i class="fa-brands fa-discord"></i></a>
        <a href="https://facebook.com/Faylotto" target="_blank"><i class="fa-brands fa-facebook"></i></a>
    </div>
    <p>
      ¬© Powered By Faylotto.
      <span>
        <a href="https://docs.faylotto.xyz/policy/AllRightsReserved" style="color: #007bff; text-decoration: none;" target="_blank">
          <span id="year"></span> All rights reserved. 
        </a>
      </span>
      Play responsibly.
      <span>
        <a href="privacypolicy" style="color: #007bff; text-decoration: none;" target="_blank">
          Privacy Policy.
        </a>
      </span>
    </p>
  </footer>

<script>

// === CONTRACT ===
const CONTRACT_ADDRESS = "0xC2e09B1d6BC68F88383f16b1CE382411717cc731";
const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner_","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"BetLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"result","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"randomNumber","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"contractBalance","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"string","name":"highestAvailablePrize","type":"string"},{"indexed":false,"internalType":"bool","name":"prizeAvailable","type":"bool"},{"indexed":false,"internalType":"uint256","name":"winChance","type":"uint256"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"BetUnliked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"prizeName","type":"string"}],"name":"ETHAwarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FaylottoAwarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FaylottoMinted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"freeSpinNumber","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"random","type":"uint256"}],"name":"FreeSpinPlayed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"OwnerDepositFaylotto","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"rating","type":"uint8"}],"name":"RatingAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"oldRating","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"newRating","type":"uint8"}],"name":"RatingEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"inviter","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"}],"name":"ReferralAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"inviter","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"ReferralRewardEarned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"uid","type":"string"}],"name":"UIDGenerated","type":"event"},{"anonymous":false,"inputs":[],"name":"UserTransfersPaused","type":"event"},{"anonymous":false,"inputs":[],"name":"UserTransfersUnpaused","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[],"name":"INITIAL_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"inviterUID","type":"string"}],"name":"addReferralByUID","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner_","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimReferralReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"claimedReferralRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dailyQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dailyUsedQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"uint256","name":"commentIndex","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"freeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeSpinData","outputs":[{"internalType":"uint256","name":"freeSpinsUsed","type":"uint256"},{"internalType":"uint256","name":"lastActive","type":"uint256"},{"internalType":"uint256","name":"walletCreated","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"freeSpinQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"generateUID","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"getComments","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBet.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getPublicBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"result","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"randomNumber","type":"uint256"},{"internalType":"uint256","name":"contractBalance","type":"uint256"},{"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"string","name":"highestAvailablePrize","type":"string"},{"internalType":"bool","name":"prizeAvailable","type":"bool"},{"internalType":"uint256","name":"winChance","type":"uint256"}],"internalType":"struct FaylottoSpinBet.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"getRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getUserBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"result","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"randomNumber","type":"uint256"},{"internalType":"uint256","name":"contractBalance","type":"uint256"},{"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"string","name":"highestAvailablePrize","type":"string"},{"internalType":"bool","name":"prizeAvailable","type":"bool"},{"internalType":"uint256","name":"winChance","type":"uint256"}],"internalType":"struct FaylottoSpinBet.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"address","name":"user","type":"address"}],"name":"getUserLike","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"address","name":"user","type":"address"}],"name":"getUserRating","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"prize","type":"string"}],"name":"isPrizeAvailable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"lastPrizeTimestamps","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastResetTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"likeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"minInactiveTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minWalletAge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ownerDepositFaylotto","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pauseUserTransfers","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"prizeWindowCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"prizeWindowStart","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicHistoryLimit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"uint8","name":"rating","type":"uint8"}],"name":"rateBet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrals","outputs":[{"internalType":"address","name":"inviter","type":"address"},{"internalType":"uint256","name":"rewardEarned","type":"uint256"},{"internalType":"string","name":"uid","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"spinPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBetsEver","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"uidToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseUserTransfers","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userTransfersPaused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawFaylottoFromContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

const PFP_IMAGE_PATH = ''; 
const TOTAL_PFP_IMAGES = 10; // Harus sama dengan jumlah gambar Anda (0-9)

let refCodeFromURL = null;
let provider, signer, contract, userAddress;
const btn = document.getElementById("centerBtn");
const connectBtn = document.getElementById("connectBtn");
const disconnectBtn = document.getElementById("disconnectBtn");
const walletInfo = document.getElementById("walletInfo");
const walletAddress = document.getElementById("walletAddress");
const ethBalance = document.getElementById("ethBalance");
const faylottoBalance = document.getElementById("faylottoBalance");
const resultText = document.getElementById("resultText");
const clickSound = document.getElementById("clickSound");
const spinSound = document.getElementById("spinSound");
const winSound = document.getElementById("winSound");
const svg = document.getElementById("wheel");

const prizes = [
  { name: "1 ETH", icon: "eth.png" },
  { name: "Try Again", icon: "again.png" },
  { name: "MacBook", icon: "macbook.png" },
  { name: "5 Faylotto", icon: "fpoint.png" },
  { name: "0.1 ETH", icon: "eth.png" },
  { name: "0.05 ETH", icon: "eth.png" },
  { name: "0.7 ETH", icon: "eth.png" },
  { name: "2 Faylotto", icon: "fpoint.png" },
  { name: "0.005 ETH", icon: "eth.png" },
  { name: "0.0005 ETH", icon: "eth.png" },
  { name: "No Prize", icon: "no.png" },
  { name: "0.0001 ETH", icon: "eth.png" },  
  { name: "iPhone", icon: "iphone.png" },
  { name: "7 Faylotto", icon: "fpoint.png" }
];

const prizeMap = {
  "1 ETH Jackpot": "1 ETH",
  "0.7 ETH Big Win": "0.7 ETH",
  "Won MacBook!": "MacBook Air",
  "iPhone or Worth ETH": "iPhone Promax",
  "0.1 ETH Monthly Prize": "0.1 ETH",
  "0.05 ETH Monthly Prize": "0.05 ETH",
  "0.005 ETH Weekly": "0.005 ETH",
  "0.0005 ETH Three-day Prize": "0.0005 ETH",
  "0.0001 ETH Daily Prize": "0.0001 ETH",
  "Won 2 Faylotto": "2 Faylotto",
  "Won 5 Faylotto": "5 Faylotto",
  "Won 7 Faylotto": "7 Faylotto",
  "Try Again": "Try Again",
  "No Prize": "No Prize"
};

const colors = [
  "#FB8500",
  "#FF6347",
  "#571aff",
  "#72a2b8",
  "#FF69B4",
  "#65a765",
  "#FFB703",
  "#33b3a6",
  "#79b321",
  "#219EBC",
  "#FF4500",
  "#20B2AA",
  "#6A5ACD",
  "#334e77"
];

const radius = 240, cx = 250, cy = 250, total = prizes.length, slice = 360 / total;  

// Render wheel dengan icon & teks  
for (let i = 0; i < total; i++) {  
  const startAngle = (i * slice - 90) * Math.PI / 180;  
  const endAngle = ((i + 1) * slice - 90) * Math.PI / 180;  
  const x1 = cx + radius * Math.cos(startAngle);  
  const y1 = cy + radius * Math.sin(startAngle);  
  const x2 = cx + radius * Math.cos(endAngle);  
  const y2 = cy + radius * Math.sin(endAngle);  
  
  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");  
  path.setAttribute("d", `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 0 1 ${x2} ${y2} Z`);  
  path.setAttribute("fill", colors[i]);  
  path.setAttribute("stroke", "#fff");  
  path.setAttribute("stroke-width", "2");  
  svg.appendChild(path);  
  prizes[i].path = path;  
  
  const angle = (i + 0.5) * slice - 90;

  // icon
  const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
  const imgX = cx + radius * 0.55 * Math.cos(angle * Math.PI / 180) - 20;
  const imgY = cy + radius * 0.55 * Math.sin(angle * Math.PI / 180) - 20;
  img.setAttributeNS("http://www.w3.org/1999/xlink", "href", prizes[i].icon);
  img.setAttribute("x", imgX);
  img.setAttribute("y", imgY);
  img.setAttribute("width", "40");
  img.setAttribute("height", "40");
  svg.appendChild(img);

  // teks
  const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
  const textX = cx + radius * 0.8 * Math.cos(angle * Math.PI / 180);
  const textY = cy + radius * 0.8 * Math.sin(angle * Math.PI / 180);
  text.setAttribute("x", textX);
  text.setAttribute("y", textY);
  text.setAttribute("fill", "#fff");
  text.setAttribute("font-size", "15");
  text.setAttribute("font-weight", "bold");
  text.setAttribute("text-anchor", "middle");
  text.setAttribute("alignment-baseline", "middle");
  text.setAttribute("transform", `rotate(${angle}, ${textX}, ${textY})`);
  text.textContent = prizes[i].name;
  svg.appendChild(text);
}

let spinning = false,
  currentRotation = 0,
  animation = null;

const SEPOLIA_BASE_CHAIN_ID = "0x14a34"; // Sepolia Base Testnet chainId
const SEPOLIA_BASE_RPC = "https://sepolia.base.org"; // RPC resmi
const AUTO_CONNECT_KEY = "faylottoWallet"; // key di localStorage
const AUTO_CONNECT_DURATION = 30 * 24 * 60 * 60 * 1000; // 30 hari

let allUserBets = [];
let userCurrentIndex = 0;
const ITEMS_PER_LOAD = 15;
const INITIAL_LOAD = 10;

let allPublicBets = [];
let publicCurrentIndex = 0;

async function connectWallet(auto = false) {
  if (!window.ethereum) return alert("ü¶ä Install MetaMask!");

  provider = new ethers.BrowserProvider(window.ethereum);
  const accounts = await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();

  // ==== 1. Cek Jaringan Sepolia Base Testnet ====
  const network = await provider.getNetwork();
  if (network.chainId !== parseInt(SEPOLIA_BASE_CHAIN_ID, 16)) {
    try {
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: SEPOLIA_BASE_CHAIN_ID }],
      });
    } catch (switchError) {
      if (switchError.code === 4902) {
        await window.ethereum.request({
          method: "wallet_addEthereumChain",
          params: [{
            chainId: SEPOLIA_BASE_CHAIN_ID,
            chainName: "Sepolia Base Testnet",
            rpcUrls: [SEPOLIA_BASE_RPC],
            nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
            blockExplorerUrls: ["https://sepolia.basescan.org"]
          }]
        });
      } else {
        return alert("Silakan ganti jaringan ke Sepolia Base Testnet!");
      }
    }
  }

  // ==== 2. Signature Permission (hanya jika manual connect) ====
  if (!auto) {
    const localTime = new Date().toLocaleString();
    const message = `Welcome ${userAddress} to Faylotto SpinBet, Play And Enjoy. (${localTime})`;
    try {
      const signature = await signer.signMessage(message);
      console.log("User signature:", signature);

      // Simpan di localStorage untuk auto-reconnect
      const expire = Date.now() + AUTO_CONNECT_DURATION;
      localStorage.setItem(AUTO_CONNECT_KEY, JSON.stringify({ userAddress, expire }));
    } catch (err) {
      return alert("Signature permission diperlukan untuk melanjutkan!");
    }
  }

  // ==== 3. Buat kontrak ====
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  // ==== 4. Tombol ====
  connectBtn.style.display = "none";
  disconnectBtn.style.display = "inline-block";

  // ==== 5. Info Wallet ====
  walletInfo.style.display = "flex";
  walletAddress.textContent = `User: ${userAddress.slice(0, 8)}...${userAddress.slice(-8)}`;
  walletAddress.addEventListener("click", () => {
    navigator.clipboard.writeText(userAddress);
    walletAddress.textContent = `Copied ‚úÖ`;
    setTimeout(() => {
      walletAddress.textContent = `User: ${userAddress.slice(0, 8)}...${userAddress.slice(-8)}`;
    }, 1200);
  });

  // ambil ETH balance
  const balance = await provider.getBalance(userAddress);
  const ethDisplay = parseFloat(ethers.formatEther(balance)).toFixed(8);
  ethBalance.textContent = `ETH: ${ethDisplay}`;

  // ambil Faylotto balance
  const fBalance = await contract.balanceOf(userAddress);
  const fDisplay = parseFloat(ethers.formatUnits(fBalance, 18)).toFixed(2);
  faylottoBalance.textContent = `Faylotto: ${fDisplay}`;

  setupReferralListeners();
  await initializeReferralSection();
  await handlePendingReferral();

  document.getElementById("loadUserHistoryBtn").addEventListener("click", () => loadUserHistory(true));
  document.getElementById("loadPublicHistoryBtn").addEventListener("click", () => loadPublicHistory(true));

  // Opsional: Muat riwayat otomatis setelah connect
  loadUserHistory();
  loadPublicHistory();
}

// ==== Auto-reconnect saat halaman di-refresh ====
window.addEventListener("load", async () => {
  const stored = localStorage.getItem(AUTO_CONNECT_KEY);
  if (stored) {
    const { userAddress: storedAddress, expire } = JSON.parse(stored);
    if (Date.now() < expire) {
      await connectWallet(true); // auto connect
      console.log("Auto-reconnect wallet:", storedAddress);
    } else {
      localStorage.removeItem(AUTO_CONNECT_KEY);
    }
  }
});

function disconnectWallet() {
  provider = signer = contract = userAddress = null;
  connectBtn.style.display = "inline-block";
  disconnectBtn.style.display = "none";
  walletInfo.style.display = "none";

  // hapus data auto-connect
  localStorage.removeItem(AUTO_CONNECT_KEY);
}

async function spinFromBlockchain() {
if (!contract) return alert("‚ö†Ô∏è Connect your wallet first!");
try {
btn.disabled = true;
clickSound.play();

// üïì Saat baru klik tombol ‚Üí tunggu transaksi muncul di MetaMask    
resultText.textContent = "‚è≥ Waiting Transaction...";    

// üí∞ Kirim transaksi ke kontrak    
const tx = await contract.placeBet({ value: ethers.parseEther("0.000256") });    

// üé° Setelah transaksi dikonfirmasi di blockchain  
resultText.textContent = "üé° Spinning...";
  
spinSound.currentTime = 0;
spinSound.play();

// Tunggu konfirmasi blok    
const receipt = await tx.wait();    

// üîç Ambil event BetPlaced dari log    
const event = receipt.logs    
  .map(log => {    
    try {    
      return contract.interface.parseLog(log);    
    } catch {    
      return null;    
    }    
  })    
  .filter(e => e && e.name === "BetPlaced")[0];    

if (!event) throw new Error("No BetPlaced event found.");    

const { result } = event.args;    
console.log("Raw result from contract:", result);    

// Jalankan animasi spin berdasarkan hasil kontrak    
animateSpin(result);

} catch (err) {
console.error(err);
resultText.textContent = "‚ùå Transaction failed.";
resetButton();
}
}

function createParticles(popup) {
  // hapus partikel lama
  popup.querySelectorAll(".particle").forEach(p => p.remove());

  // buat 6‚Äì8 partikel acak
  const particleCount = 6 + Math.floor(Math.random() * 3);
  const colors = ["#ff9ff3", "#feca57", "#54a0ff", "#5f27cd", "#1dd1a1", "#48dbfb", "#c8d6e5"];
  
  for (let i = 0; i < particleCount; i++) {
    const span = document.createElement("span");
    span.classList.add("particle");
    span.style.background = colors[Math.floor(Math.random() * colors.length)];
    span.style.width = `${6 + Math.random() * 8}px`;
    span.style.height = span.style.width;
    span.style.top = `${Math.random() * 90}%`;
    span.style.left = `${Math.random() * 90}%`;
    span.style.animationDuration = `${8 + Math.random() * 4}s`;
    span.style.animationDelay = `${Math.random() * 2}s`;
    popup.appendChild(span);
  }
}

function playSoftDing() {
  const audio = new Audio("winn.mp3");
  audio.volume = 1;
  audio.play();
}

function showPopup() {
  const popup = document.querySelector(".result-popup");
  createParticles(popup);
  playSoftDing();

  popup.classList.remove("hide");
  popup.style.display = "block";
  setTimeout(() => popup.classList.add("show"), 10);
}

function hidePopup() {
  const popup = document.querySelector(".result-popup");
  popup.classList.remove("show");
  popup.classList.add("hide");
  setTimeout(() => (popup.style.display = "none"), 800);
}

function animateSpin(resultName) {
  console.log("Received resultName from backend:", resultName);
  const displayName = prizeMap[resultName] || "No Prize";
  console.log("Mapped displayName:", displayName);
  const index = prizes.findIndex(p => p.name === displayName);
  console.log("Calculated index:", index);

  if (index === -1) {
    console.error(`Hadiah tidak ditemukan: ${displayName}`);
    resultText.textContent = "Error: Hadiah tidak valid";
    resetButton();
    return;
  }

  if (animation) gsap.killTweensOf(svg);
  prizes.forEach(p => p.path.classList.remove("glow"));

  const targetSlice = slice * index + slice / 2;
  const totalRotation = currentRotation + 12 * 360 + targetSlice;
  const duration = 30 + Math.random() * 5;

  animation = gsap.fromTo(
    svg,
    { rotation: currentRotation },
    {
      rotation: totalRotation,
      duration: duration,
      ease: "power3.inOut",
      transformOrigin: "center center",
      onUpdate: () => (currentRotation = gsap.getProperty(svg, "rotation")),
      onComplete: () => {
        spinSound.pause();
        winSound.play();
        const prize = prizes[index];
        prize.path.classList.add("glow");

        // --- Popup hasil menang ---
        const popup = document.getElementById("resultPopup");
        popup.innerHTML = `
          <img src="win.png" class="icon">
          <div class="text">
            You won: <span style="color:gold;font-size:24px;">${displayName}</span>
            <img src="${prize.icon}" class="prize" alt="prize">
          </div>
          <button id="closePopupBtn" class="popup-btn">OK</button>
        `;
        popup.style.display = "block";

        // Tambahkan partikel dreamy di popup
        createParticles(popup);
        playSoftDing();

        showPopup(); // untuk muncul
        setTimeout(hidePopup, 20000); // otomatis hilang setelah 4 detik

        // Tombol OK untuk menutup popup
        document.getElementById("closePopupBtn").onclick = () => {
          popup.style.display = "none";
          resetButton();
        };
      }
    }
  );
}

// GANTI FUNGSI renderBets LAMA ANDA DENGAN YANG INI
function renderBets(ul, bets, startIndex, count, isPublic = false) {
  if (!ul || !Array.isArray(bets)) {
    console.error("Invalid arguments for renderBets", { ul, bets });
    return;
  }

  // --- 1. TENTUKAN PREFIX ---
  const prefix = isPublic ? 'public' : 'user';

  for (let i = startIndex; i < startIndex + count && i < bets.length; i++) {
    const bet = bets[i];
    if (!bet || typeof bet !== 'object') continue;

    // --- 2. AMBIL DATA & IKON ---
    const displayName = prizeMap[bet.result] || "No Prize";
    const prize = prizes.find(p => p.name === displayName);
    const iconUrl = prize ? prize.icon : "default_icon.png";
    
    // --- AMBIL PFP URL (BARU) ---
    // Pastikan fungsi getDeterministicPfpUrl sudah ada!
    const pfpUrl = getDeterministicPfpUrl(bet.player); 

    const li = document.createElement("li");
    li.style.textAlign = "left"; // Set rata kiri

    // Info player (HANYA MUNCUL JIKA isPublic true)
    const playerAddressShort = isPublic ? `${String(bet.player || '').slice(0, 10)}...${String(bet.player || '').slice(-10)}` : "";
    const playerInfoClickable = isPublic ? 
      `(Player: <span class="clickable-address" onclick="showUserProfile('${bet.player}')">${playerAddressShort}</span>)` 
      : "";

    // Ambil data lain
    const result = bet.result || 'N/A';
    const amount = bet.amount ? ethers.formatEther(bet.amount) : 'N/A';
    const timestamp = bet.timestamp ? new Date(Number(bet.timestamp) * 1000).toLocaleString() : 'N/A';
    const randomNumber = bet.randomNumber ? bet.randomNumber.toString() : 'N/A';
    const prizeAvailable = typeof bet.prizeAvailable === 'boolean' ? (bet.prizeAvailable ? "Ya" : "Tidak") : 'N/A';
    const winChance = typeof bet.winChance !== 'undefined' ? `${Number(bet.winChance) / 1000}%` : 'N/A';
    const highestPrize = bet.highestAvailablePrize || 'N/A';
    const playerBetCount = typeof bet.playerBetCount !== 'undefined' ? Number(bet.playerBetCount) + 1 : 'N/A';
    const globalBetId = typeof bet.globalBetId !== 'undefined' ? bet.globalBetId.toString() : (startIndex + i + 1);

    // --- 3. BUAT HTML ---
    li.innerHTML = `
      <div class="bet-item-header">
        <img src="${pfpUrl}" class="history-pfp" alt="PFP" onclick="showUserProfile('${bet.player}')">
        <div class="history-info-stack">
          <strong>Spin BetId: <span style="color:gold;">#${globalBetId}</span> ${playerInfoClickable}</strong>
          <span>Hasil: <span style="color:gold;">${result}</span>
                 <img src="${iconUrl}" class="prize" alt="${displayName}" style="width: 30px; height: 30px; vertical-align: middle; margin-left: 5px;">
          </span>
        </div>
      </div>
      
      <div class="bet-item-details">
        Taruhan: <span style="color:gold;">${amount} ETH</span><br>
        Waktu: <span style="color:gold;">${timestamp}</span><br>
        Random #: <span style="color:gold;">${randomNumber}</span><br>
        Hadiah Tersedia: <span style="color:gold;">${prizeAvailable}</span><br>
        Peluang Menang: <span style="color:gold;">${winChance} (estimasi)</span><br>
        
        Hadiah Tertinggi: <span style="color:gold;">${highestPrize}</span><br>
        Spin Player ke: <span style="color:gold;">${playerBetCount}</span><br>
      </div>

      <div class="bet-interactions" style="margin-top: 10px; display: flex; align-items: center; gap: 15px;">
          <button class="like-btn" id="like-btn-${prefix}-${globalBetId}" onclick="handleLikeToggle('${prefix}', ${globalBetId})">
              <img src="like.svg" alt="Like" style="width: 25px; height: 25px; vertical-align: middle;">
              Like (<span id="like-count-${prefix}-${globalBetId}">0</span>)
          </button>
          <div class="star-rating" id="stars-${prefix}-${globalBetId}" data-current-rating="0">
              ${[1, 2, 3, 4, 5].map(starValue => `
                  <span data-value="${starValue}" 
                        onclick="handleRating('${prefix}', ${globalBetId}, ${starValue})" 
                        onmouseover="highlightStars('${prefix}', ${globalBetId}, ${starValue})" 
                        onmouseleave="resetStarsHighlight('${prefix}', ${globalBetId})">‚òÜ</span>
              `).join('')}
          </div>
          <span class="avg-rating" id="avg-rating-${prefix}-${globalBetId}" style="font-size: 12px; color: #999;">(0)</span>
      </div>
      <hr style="border-color: #444; margin: 10px 0;">
      
      <button class="comment-toggle-btn" 
              id="btn-toggle-${prefix}-${globalBetId}" 
              onclick="toggleComments('${prefix}', ${globalBetId})">
          <img src="comment-icon.png" style="width:16px; height:16px; vertical-align:middle;"> Komentar (0)
      </button>
      <div class="comments-section" id="comments-section-${prefix}-${globalBetId}" style="display:none;">
        <div class="comments-list" id="comments-list-${prefix}-${globalBetId}"><p class="loader-comment">Memuat komentar...</p></div>
        <div class="comment-input-area">
          <textarea id="comment-input-${prefix}-${globalBetId}" placeholder="Tulis komentar..." rows="3"></textarea>
          <button class="comment-send-btn" onclick="handleSendComment('${prefix}', ${globalBetId})">Kirim</button>
        </div>
      </div>
    `;

    // --- 4. TAMBAHKAN KE HALAMAN ---
    ul.appendChild(li);
    
    // --- 5. PANGGIL FUNGSI (DENGAN PREFIX) ---
    loadCommentCount(prefix, globalBetId); 
    loadLikeAndRatingData(prefix, globalBetId); 
  }
}

// Fungsi untuk memuat riwayat user pribadi dengan infinite scroll
async function loadUserHistory(refresh = false) {
  if (!contract) return alert("‚ö†Ô∏è Connect your wallet first!");

  const historyDiv = document.getElementById("userHistory");
  if (refresh || allUserBets.length === 0) {
    try {
      // --- PERBAIKAN DI SINI ---
      // 1. Ambil data
      const data = await contract.getUserBets();
      // 2. Buat salinan baru [...data] lalu di-reverse
      allUserBets = [...data].reverse();
      // -------------------------

      userCurrentIndex = 0;
      historyDiv.innerHTML = ""; // Kosongkan dulu jika refresh

      if (allUserBets.length === 0) {
        historyDiv.innerHTML = "<p>Tidak ada riwayat spin pribadi.</p>";
        return;
      }

      // ... (sisa kode Anda sudah benar)

      const ul = document.createElement("ul");
      ul.classList.add("history-list");
      historyDiv.appendChild(ul);

      // Muat initial 10
      renderBets(ul, allUserBets, 0, INITIAL_LOAD);
      userCurrentIndex = INITIAL_LOAD;

      // Tambahkan loader placeholder
      const loader = document.createElement("div");
      loader.classList.add("loader");
      loader.textContent = "Memuat lebih banyak...";
      historyDiv.appendChild(loader);

      // Setup scroll listener
      historyDiv.removeEventListener("scroll", userScrollHandler); // Hapus jika ada
      historyDiv.addEventListener("scroll", userScrollHandler);
    } catch (err) {
      console.error(err);
      alert("Gagal memuat riwayat user: " + err.message);
    }
  }
}

// Handler scroll untuk user history
function userScrollHandler() {
  const historyDiv = document.getElementById("userHistory");
  const ul = historyDiv.querySelector("ul");
  const loader = historyDiv.querySelector(".loader");

  if (historyDiv.scrollTop + historyDiv.clientHeight >= historyDiv.scrollHeight - 50) { // Dekat bottom
    if (userCurrentIndex < allUserBets.length) {
      loader.style.display = "block"; // Tampilkan loader

      // Simulasi delay (karena data lokal, cepat)
      setTimeout(() => {
        renderBets(ul, allUserBets, userCurrentIndex, ITEMS_PER_LOAD);
        userCurrentIndex += ITEMS_PER_LOAD;
        if (userCurrentIndex >= allUserBets.length) {
          loader.textContent = "Tidak ada lagi riwayat.";
        }
        loader.style.display = userCurrentIndex < allUserBets.length ? "block" : "none";
      }, 500); // Delay 0.5 detik untuk efek loading
    }
  }
}

// Fungsi untuk memuat riwayat public dengan infinite scroll (mirip user)
async function loadPublicHistory(refresh = false) {
  if (!contract) return alert("‚ö†Ô∏è Connect your wallet first!");

  const historyDiv = document.getElementById("publicHistory");
  if (refresh || allPublicBets.length === 0) {
    try {
      // --- PERBAIKAN DI SINI ---
      // 1. Ambil data
      const data = await contract.getPublicBets();
      // 2. Buat salinan baru [...data] lalu di-reverse
      allPublicBets = [...data].reverse();
      // -------------------------

      publicCurrentIndex = 0;
      historyDiv.innerHTML = ""; // Kosongkan dulu jika refresh

      if (allPublicBets.length === 0) {
        historyDiv.innerHTML = "<p>Tidak ada riwayat spin public.</p>";
        return;
      }

      // ... (sisa kode Anda sudah benar)
      
      const ul = document.createElement("ul");
      ul.classList.add("history-list");
      historyDiv.appendChild(ul);

      // Muat initial 10 (sekarang ini adalah data terbaru)
      renderBets(ul, allPublicBets, 0, INITIAL_LOAD, true);
      publicCurrentIndex = INITIAL_LOAD;

      // Tambahkan loader placeholder
      const loader = document.createElement("div");
      loader.classList.add("loader");
      loader.textContent = "Memuat lebih banyak...";
      historyDiv.appendChild(loader);

      // Setup scroll listener
      historyDiv.removeEventListener("scroll", publicScrollHandler); // Hapus jika ada
      historyDiv.addEventListener("scroll", publicScrollHandler);
    } catch (err) {
      console.error(err);
      alert("Gagal memuat riwayat public: " + err.message);
    }
  }
}

// Handler scroll untuk public history
function publicScrollHandler() {
  const historyDiv = document.getElementById("publicHistory");
  const ul = historyDiv.querySelector("ul");
  const loader = historyDiv.querySelector(".loader");

  if (historyDiv.scrollTop + historyDiv.clientHeight >= historyDiv.scrollHeight - 50) { // Dekat bottom
    if (publicCurrentIndex < allPublicBets.length) {
      loader.style.display = "block"; // Tampilkan loader

      // Simulasi delay
      setTimeout(() => {
        renderBets(ul, allPublicBets, publicCurrentIndex, ITEMS_PER_LOAD, true);
        publicCurrentIndex += ITEMS_PER_LOAD;
        if (publicCurrentIndex >= allPublicBets.length) {
          loader.textContent = "Tidak ada lagi riwayat.";
        }
        loader.style.display = publicCurrentIndex < allPublicBets.length ? "block" : "none";
      }, 500);
    }
  }
    }

  // ===================================
// === FUNGSI-FUNGSI REFERRAL BARU ===
// ===================================

/**
 * Mendaftarkan event listener untuk tombol-tombol referral
 */
function setupReferralListeners() {
  // Pastikan listener hanya didaftar sekali
  const genBtn = document.getElementById('generateUIDBtn');
  if (genBtn && !genBtn.dataset.listener) { // Cek penanda
    genBtn.addEventListener('click', handleGenerateUID);
    genBtn.dataset.listener = 'true'; // Beri penanda
  }
  
  const copyBtn = document.getElementById('copyLinkBtn');
  if (copyBtn && !copyBtn.dataset.listener) {
    copyBtn.addEventListener('click', copyReferralLink);
    copyBtn.dataset.listener = 'true';
  }
  
  const claimBtn = document.getElementById('claimRewardBtn');
  if (claimBtn && !claimBtn.dataset.listener) {
    claimBtn.addEventListener('click', handleClaimReward);
    claimBtn.dataset.listener = 'true';
  }
}

/**
 * Menampilkan UI referral (untuk si pengundang)
 */
async function initializeReferralSection() {
  if (!contract) return;

  const referralDiv = document.getElementById('referralSection');
  const status = document.getElementById('referralStatus');
  const noUidView = document.getElementById('noUidView');
  const hasUidView = document.getElementById('hasUidView');
  
  referralDiv.style.display = 'block';
  status.textContent = 'Memuat data referral...';

  try {
    // 1. Cek info referral user (termasuk UID)
    const info = await contract.referrals(userAddress);
    const uid = info.uid;

    if (!uid) { // JS akan memberi string kosong jika tidak ada
      // User belum punya UID
      noUidView.style.display = 'block';
      hasUidView.style.display = 'none';
      status.textContent = 'Anda belum memiliki kode referral unik.';
    } else {
      // User sudah punya UID
      noUidView.style.display = 'none';
      hasUidView.style.display = 'block';
      
      // Tampilkan UID dan link
      document.getElementById('userUID').textContent = uid;
      const link = `${window.location.origin}${window.location.pathname}?ref=${uid}`;
      document.getElementById('referralLink').value = link;

      // 2. Ambil data statistik
      const [count, reward] = await Promise.all([
        contract.getReferralCount(userAddress),
        contract.getReferralReward(userAddress)
      ]);

      const rewardEther = ethers.formatEther(reward);
      document.getElementById('referralCount').textContent = Number(count);
      document.getElementById('referralReward').textContent = `${parseFloat(rewardEther).toFixed(6)} ETH`;

      // 3. Tampilkan/sembunyikan tombol klaim
      const claimBtn = document.getElementById('claimRewardBtn');
      if (Number(reward) > 0) {
        claimBtn.style.display = 'block';
      } else {
        claimBtn.style.display = 'none';
      }
      
      status.textContent = 'Data referral berhasil dimuat.';
    }
  } catch (err) {
    console.error("Gagal memuat info referral:", err);
    status.textContent = "Gagal memuat data referral.";
  }
}

/**
 * Menangani pendaftaran kode (untuk si undangan/referee)
 */
async function handlePendingReferral() {
  const refCode = localStorage.getItem('pendingRefCode');
  if (!refCode || !contract) {
    return; // Tidak ada kode referral yang tertunda
  }

  console.log(`Memproses kode referral tertunda: ${refCode}`);
  
  try {
    // Cek dulu apakah user sudah punya inviter
    const info = await contract.referrals(userAddress);
    
    if (info.inviter !== ethers.ZeroAddress) {
      console.log('Anda sudah memiliki inviter.');
      localStorage.removeItem('pendingRefCode'); // Bersihkan
      return;
    }
    
    // Jika belum punya, kirim transaksi addReferralByUID
    alert(`Kami mendeteksi Anda diundang oleh ${refCode}. Harap konfirmasi transaksi untuk mendaftarkan referral Anda.`);
    
    const tx = await contract.addReferralByUID(refCode);
    resultText.textContent = "‚è≥ Memproses pendaftaran referral..."; // (Opsional)
    
    await tx.wait();
    
    alert('Sukses! Anda berhasil terdaftar sebagai referral.');
    resultText.textContent = "Pendaftaran referral sukses!"; // (Opsional)
    localStorage.removeItem('pendingRefCode'); // Bersihkan setelah sukses
    
  } catch (err) {
    console.error("Gagal mendaftar referral:", err);
    // Tampilkan error, tapi jangan hapus kodenya, mungkin jaringan gagal
    // Kontrak akan me-revert jika UID salah atau sudah punya inviter
    if (err.message.includes("Already has inviter")) {
         localStorage.removeItem('pendingRefCode');
    } else {
        alert(`Gagal mendaftar referral: ${err.message}`);
    }
  }
}

/**
 * Mengirim transaksi generateUID
 */
async function handleGenerateUID() {
  if (!contract) return alert("‚ö†Ô∏è Connect your wallet first!");

  const btn = document.getElementById('generateUIDBtn');
  const status = document.getElementById('referralStatus');

  btn.disabled = true;
  btn.textContent = 'Memproses di wallet...';
  status.textContent = 'Menunggu konfirmasi transaksi...';

  try {
    const tx = await contract.generateUID();
    btn.textContent = 'Menunggu konfirmasi block...';
    
    await tx.wait();
    
    alert('UID berhasil dibuat!');
    status.textContent = 'UID dibuat! Memuat ulang data...';
    await initializeReferralSection(); // Refresh UI untuk menampilkan UID baru
    
  } catch (err) {
    console.error("Gagal generate UID:", err);
    alert(`Gagal membuat UID: ${err.message}`);
    status.textContent = 'Gagal membuat UID.';
    btn.disabled = false;
    btn.textContent = 'Buat UID Saya';
  }
}

/**
 * Mengirim transaksi claimReferralReward
 */
async function handleClaimReward() {
  if (!contract) return alert("‚ö†Ô∏è Connect yourral wallet first!");

  const btn = document.getElementById('claimRewardBtn');
  const status = document.getElementById('referralStatus');

  btn.disabled = true;
  btn.textContent = 'Memproses klaim...';
  status.textContent = 'Menunggu konfirmasi transaksi...';

  try {
    const tx = await contract.claimReferralReward();
    btn.textContent = 'Menunggu konfirmasi block...';
    
    await tx.wait();
    
    alert('Reward berhasil diklaim!');
    status.textContent = 'Reward diklaim! Memuat ulang data...';
    await initializeReferralSection(); // Refresh UI untuk update saldo reward
    
  } catch (err) {
    console.error("Gagal klaim reward:", err);
    alert(`Gagal klaim reward: ${err.message}`);
    status.textContent = 'Gagal klaim reward.';
    btn.disabled = false;
    btn.textContent = 'Klaim Reward Saya';
  }
}

/**
 * Menyalin link referral ke clipboard
 */
function copyReferralLink() {
  const linkInput = document.getElementById('referralLink');
  navigator.clipboard.writeText(linkInput.value)
    .then(() => {
      alert('Link referral disalin ke clipboard!');
    })
    .catch(err => {
      console.error('Gagal menyalin link:', err);
      alert('Gagal menyalin link.');
    });
  }

  // Fungsi ini dijalankan saat halaman dimuat
function checkURLForReferrer() {
  const urlParams = new URLSearchParams(window.location.search);
  const refCode = urlParams.get('ref'); // Cari ?ref=...
  
  if (refCode) {
    console.log("Kode referral ditemukan di URL:", refCode);
    // Simpan di localStorage agar tidak hilang jika halaman refresh
    localStorage.setItem('pendingRefCode', refCode);
    
    // Opsional: Bersihkan URL agar tidak terlihat
    // window.history.replaceState({}, document.title, window.location.pathname);
  }
}

// Panggil fungsi ini saat window/jendela dimuat
window.addEventListener("load", checkURLForReferrer);

// === Variabel Global Baru untuk Free Spin ===
let userFreeSpinState = {
  eligible: false,
  remaining: 0
};

// === Utility Function (WAJIB ADA) ===
// Fungsi ini dipanggil oleh animateSpin() dan blok catch, tapi belum Anda definisikan.
function resetButton() {
  const btn = document.getElementById("centerBtn");
  if (btn) {
    btn.disabled = false;
  }
  // Setelah spin selesai, update UI tombol (kembali normal jika free spin habis)
  updateSpinButtonUI(); 
}

/**
 * 1. FUNGSI UTAMA: Pengecekan kelayakan free spin
 * Membaca data kontrak DAN MENGEMBALIKAN status kelayakan.
 * Juga mengupdate state global userFreeSpinState.
 */
async function checkFreeSpinEligibility() {
  // Reset state default sebelum cek
  userFreeSpinState.eligible = false;
  userFreeSpinState.remaining = 0;

  if (!contract || !userAddress) {
    console.warn("checkFreeSpinEligibility skipped: Contract or userAddress not ready.");
    updateSpinButtonUI(); // Update ke tombol normal
    return false; // Kembalikan false jika tidak bisa cek
  }

  console.log("Memulai pengecekan free spin eligibility...");

  try {
    // 1. Ambil data konstan
    const [quota, minAge, minInactive] = await Promise.all([
      contract.freeSpinQuota(),
      contract.minWalletAge(),
      contract.minInactiveTime()
    ]);

    // 2. Ambil data spesifik user
    const userData = await contract.freeSpinData(userAddress);

    // 3. Ambil timestamp block terbaru
    const block = await provider.getBlock("latest");
    if (!block) {
      console.error("Gagal mendapatkan block terbaru!");
      updateSpinButtonUI();
      return false; // Kembalikan false
    }
    const now = block.timestamp;

    // 4. Konversi BigInt ke Number
    const quotaNum = Number(quota);
    const minAgeNum = Number(minAge);
    const minInactiveNum = Number(minInactive);
    const { freeSpinsUsed, lastActive, walletCreated } = {
      freeSpinsUsed: Number(userData.freeSpinsUsed),
      lastActive: Number(userData.lastActive),
      walletCreated: Number(userData.walletCreated)
    };

    const remaining = quotaNum - freeSpinsUsed;
    console.log("Sisa free spin:", remaining);

    // 5. Cek kuota dulu
    if (remaining <= 0) {
      console.log("Kuota free spin habis.");
      updateSpinButtonUI(); // Tombol normal
      return false; // Kembalikan false
    }

    // 6. Cek kondisi umur & inaktif
    const isOldEnough = (walletCreated > 0) && (now >= (walletCreated + minAgeNum));
    const isInactiveEnough = (lastActive === 0) || (now >= (lastActive + minInactiveNum));

    console.log(`Hasil Pengecekan Free Spin:
      Sisa: ${remaining}
      Cukup Umur? ${isOldEnough} (Dibuat: ${walletCreated}, Perlu: ${minAgeNum}, Sekarang: ${now})
      Cukup Inaktif? ${isInactiveEnough} (Terakhir Aktif: ${lastActive}, Perlu: ${minInactiveNum}, Sekarang: ${now})`);

    // 7. JIKA LAYAK
    if (isOldEnough && isInactiveEnough) {
      console.log("User LAYAK mendapatkan free spin.");
      userFreeSpinState.eligible = true;
      userFreeSpinState.remaining = remaining;
      // Tidak perlu popup lagi di sini, biarkan handleSpinClick yg atur
      updateSpinButtonUI(); // Update tombol ke "Spin Free X"
      return true; // Kembalikan true
    } else {
      // Jika tidak layak
      console.log("User TIDAK LAYAK mendapatkan free spin saat ini.");
      updateSpinButtonUI(); // Update tombol ke normal
      return false; // Kembalikan false
    }

  } catch (err) {
    console.error("Error besar saat mengecek kelayakan free spin:", err);
    updateSpinButtonUI(); // Tombol normal jika error
    return false; // Kembalikan false
  }
}

/**
 * 3. Update UI Tombol Spin
 * Mengubah teks tombol berdasarkan status free spin.
 */
function updateSpinButtonUI() {
  const btn = document.getElementById("centerBtn");
  if (!btn) return;

  if (userFreeSpinState.eligible && userFreeSpinState.remaining > 0) {
    // Sesuai permintaan Anda: "Spin Free 3", "Spin Free 2", dst.
    btn.innerHTML = `SPIN FREE ${userFreeSpinState.remaining}`;
    // Hapus cost span jika ada
    const costSpan = btn.querySelector(".cost");
    if (costSpan) costSpan.remove();

  } else {
    // Kembali ke normal
    btn.innerHTML = `SPIN<br><span class="cost"><center>Cost</center>0.000256 ETH</span>`;
  }
}

/**
 * 4. Fungsi Spin Gratis Baru (Dengan Penanganan Registrasi & Error)
 */
async function spinFreeFromBlockchain() {
  if (!contract) return alert("‚ö†Ô∏è Connect your wallet first!");
  
  const btn = document.getElementById("centerBtn");
  
  try {
    btn.disabled = true;
    clickSound.play();
    resultText.textContent = "‚è≥ Waiting Free Transaction...";

    // üí∞ Kirim transaksi ke fungsi freeSpin()
    const tx = await contract.freeSpin(); 

    // Tidak langsung spinning, tunggu konfirmasi dulu
    resultText.textContent = "‚è≥ Confirming Transaction...";
    const receipt = await tx.wait();

    // üîç Coba ambil event 'FreeSpinPlayed'
    const event = receipt.logs
      .map(log => {
        try { return contract.interface.parseLog(log); } catch { return null; }
      })
      .filter(e => e && e.name === "FreeSpinPlayed")[0];

    // --- PENANGANAN UNTUK PANGGILAN INISIALISASI/REGISTRASI ---
    if (!event) {
        // Ini berarti panggilan pertama berhasil (registrasi)
        console.log("Panggilan freeSpin pertama berhasil (registrasi).");
        resultText.textContent = "‚úÖ Akun Terdaftar!";
        alert("Akun Anda berhasil didaftarkan untuk free spin. Silakan tunggu 1 menit lagi, lalu coba spin gratis.");
        resetButton(); // Aktifkan tombol lagi (masih bertuliskan Spin Free X)
        return; // Hentikan fungsi di sini, jangan lanjutkan ke spin
    }
    // --------------------------------------------------------

    // --- JIKA EVENT ADA (Ini adalah spin aktual) ---
    resultText.textContent = "üé° Spinning Free...";
    spinSound.currentTime = 0;
    spinSound.play();

    // 1. Update status state
    userFreeSpinState.remaining--;
    if (userFreeSpinState.remaining <= 0) {
      userFreeSpinState.eligible = false;
    }
    // 2. Update tombol SEKARANG (sebelum animasi)
    updateSpinButtonUI(); 

    // 3. Ambil 'rewardAmount' dan petakan ke hasil string
    const { rewardAmount } = event.args;
    const resultString = mapRewardToResultString(rewardAmount);

    if (resultString === "Try Again") { // Sebelumnya "No Prize"
         console.warn("Free spin menghasilkan '3 Faylotto', dipetakan ke 'Try Again'.");
    }

    // 4. Jalankan animasi spin
    animateSpin(resultString);

  } catch (err) {
    console.error("Gagal free spin:", err);
    spinSound.pause(); // Hentikan suara spin jika error

    // --- PENANGANAN ERROR YANG LEBIH BAIK ---
    let userMessage = "‚ùå Free spin failed.";
    
    // Periksa pesan error dari kontrak (jika ada)
    const reason = err.reason || (err.data ? contract.interface.parseError(err.data)?.args[0] : null) || err.message;

    if (reason) {
        if (reason.includes("Wallet too new for free spin")) {
            userMessage = "‚è≥ Akun terdaftar! Harap tunggu 1 menit lagi.";
        } else if (reason.includes("Last active too recent")) {
            userMessage = "‚è≥ Anda baru saja spin. Harap tunggu 1 menit lagi.";
        } else if (reason.includes("No free spins left")) {
            userMessage = "‚ùå Kuota free spin Anda sudah habis.";
            // Jika habis, paksa update state & UI
            userFreeSpinState.eligible = false;
            userFreeSpinState.remaining = 0;
            updateSpinButtonUI(); 
        } else {
             // Error umum lainnya
             userMessage = `‚ùå Error: ${reason.substring(0, 100)}`; // Potong pesan error panjang
        }
    }
    
    resultText.textContent = userMessage;
    alert(userMessage); // Tampilkan pesan yang jelas ke user
    resetButton(); // Pastikan tombol aktif lagi jika gagal
  }
}
  
/**
 * 5. Helper untuk mapping hasil 'freeSpin()'
 * Kontrak freeSpin() hanya mengeluarkan event 'rewardAmount' (angka),
 * sedangkan 'animateSpin()' butuh 'resultName' (string). Kita harus konversi.
 */
function mapRewardToResultString(rewardAmount) {
  // Konversi ke BigInt untuk perbandingan yang aman
  const amount = BigInt(rewardAmount.toString());
  const base = 10n ** 18n; // 1 ETH (18 decimals)

  if (amount === 2n * base) {
    return "Won 2 Faylotto";
  }
  if (amount === 5n * base) {
    return "Won 5 Faylotto";
  }
  if (amount === 7n * base) {
    return "Won 7 Faylotto";
  }
  if (amount === 3n * base) {
    // !! PENTING: Kontrak Anda memberi 3 FAY, tapi prizeMap Anda
    // tidak memiliki "Won 3 Faylotto". Kita fallback ke "Try Again".
    return "Try Again"; 
  }
  
  // Fallback jika ada hasil tak terduga
  return "No Prize"; 
  }

/**
 * Event listener utama untuk tombol spin.
 * SELALU cek kelayakan TERKINI sebelum spin.
 */
async function handleSpinClick() {
  const btn = document.getElementById("centerBtn");
  if (!contract || !userAddress) return alert("‚ö†Ô∏è Connect your wallet first!");
  if (btn.disabled) return; // Jangan lakukan apa-apa jika tombol disabled

  console.log("Tombol SPIN diklik. Mengecek kelayakan...");
  btn.disabled = true; // Disable tombol sementara cek
  resultText.textContent = "‚è≥ Mengecek status...";

  try {
    // Panggil checkFreeSpinEligibility dan tunggu hasilnya (true/false)
    const isEligibleNow = await checkFreeSpinEligibility();

    // Berdasarkan hasil cek TERBARU:
    if (isEligibleNow) {
      console.log("Kelayakan dikonfirmasi. Memanggil spinFreeFromBlockchain...");
      // Tidak perlu popup di sini, langsung spin saja
      await spinFreeFromBlockchain(); // Tunggu spin gratis selesai
    } else {
      // Cek apakah walletCreated masih 0 (perlu registrasi)
      const userData = await contract.freeSpinData(userAddress); // Baca lagi
      if (Number(userData.walletCreated) === 0 && Number(userData.freeSpinsUsed) < Number(await contract.freeSpinQuota())) {
        // Jika belum registrasi DAN kuota masih ada -> lakukan registrasi
        console.log("User belum registrasi & kuota ada. Memanggil spinFreeFromBlockchain untuk registrasi...");
        if(confirm("Anda sepertinya belum terdaftar untuk free spin. Lakukan pendaftaran sekarang? (Tidak ada biaya gas)")){
             await spinFreeFromBlockchain(); // Panggil fungsi spin free untuk registrasi
        } else {
             resultText.textContent = "Pendaftaran dibatalkan.";
             resetButton(); // Aktifkan tombol lagi
        }
      } else {
        // Jika tidak eligible karena alasan lain (belum cukup umur/inaktif/habis)
        // atau jika sudah registrasi -> Lakukan spin berbayar
        console.log("Tidak eligible untuk free spin ATAU sudah registrasi. Memanggil spinFromBlockchain...");
        await spinFromBlockchain(); // Tunggu spin berbayar selesai
      }
    }
  } catch (err) {
    // Tangani error dari checkFreeSpinEligibility atau spin itu sendiri
    console.error("Error pada handleSpinClick:", err);
    resultText.textContent = `‚ùå Error: ${err.message.substring(0,100)}`;
    resetButton(); // Pastikan tombol aktif lagi jika ada error
  } finally {
     // Pastikan tombol diaktifkan kembali di akhir, KECUALI jika animasi sedang berjalan
     // (resetButton() sudah dipanggil oleh onComplete atau catch error spin)
     // Jadi tidak perlu enable di sini lagi.
  }
}

// ==========================================================

// === GANTI SEMUA FUNGSI HELPER LAMA ANDA DENGAN INI ===

// ==========================================================



// --- FUNGSI KOMENTAR (DENGAN PREFIX) ---



async function toggleComments(prefix, globalBetId) {

  const section = document.getElementById(`comments-section-${prefix}-${globalBetId}`);

  const button = document.getElementById(`btn-toggle-${prefix}-${globalBetId}`);

  if (!section || !button) return;



  if (section.style.display === "none") {

    section.style.display = "block";

    await loadComments(prefix, globalBetId);

  } else {

    section.style.display = "none";

    loadCommentCount(prefix, globalBetId);

  }

}



async function loadCommentCount(prefix, globalBetId) {

    const button = document.getElementById(`btn-toggle-${prefix}-${globalBetId}`);

    if (!button || !contract) return;

    const section = document.getElementById(`comments-section-${prefix}-${globalBetId}`);

    if (section && section.style.display === "block") return;



    try {

        const comments = await contract.getComments(globalBetId);

        button.innerHTML = `<img src="comment.svg" style="width:25px; height:25px; vertical-align:middle;"> Komentar (${comments.length})`;

    } catch(err) {

        console.error("Gagal load comment count:", err);

        button.innerHTML = `<img src="comment.svg" style="width:25px; height:25px; vertical-align:middle;"> Komentar (?)`;

    }

}

/**
 * FUNGSI 3 (MODIFIKASI): Teks alamat komentator sekarang bisa diklik.
 */
async function loadComments(prefix, globalBetId) {
  if (!contract) return; 

  const listDiv = document.getElementById(`comments-list-${prefix}-${globalBetId}`);
  if (!listDiv) return;

  listDiv.innerHTML = "<p class='loader-comment'>Memuat komentar...</p>"; // Tampilkan loader

  try {
    const comments = await contract.getComments(globalBetId);
    
    // Update tombol toggle
    const button = document.getElementById(`btn-toggle-${prefix}-${globalBetId}`);
    if (button) {
      button.innerHTML = `<img src="comment.svg" style="width:25px; height:25px; vertical-align:middle;"> Sembunyikan Komentar (${comments.length})`;
    }

    if (comments.length === 0) {
      listDiv.innerHTML = "<small>Belum ada komentar.</small>";
      return;
    }

    listDiv.innerHTML = ""; // Kosongkan loader

    // Render setiap komentar
    comments.forEach((comment, i) => { // 'i' adalah commentIndex
      const commentEl = document.createElement("div");
      commentEl.className = "comment-item"; 
      commentEl.id = `comment-${prefix}-${globalBetId}-${i}`; 
      
      const userAddr = comment.user;
      const timestamp = new Date(Number(comment.timestamp) * 1000).toLocaleString();
      
      // Ambil PFP (sudah ada)
      const pfpUrl = getDeterministicPfpUrl(userAddr); 

      let editButtonHtml = "";
      if (userAddress && userAddr.toLowerCase() === userAddress.toLowerCase()) {
        editButtonHtml = `
          <button class="edit-btn" id="edit-btn-${prefix}-${globalBetId}-${i}" onclick="toggleEditMode('${prefix}', ${globalBetId}, ${i}, true)">
            Edit
          </button>
        `;
      }
      
      commentEl.innerHTML = `
        <div class="comment-pfp-wrapper">
          <img src="${pfpUrl}" class="comment-pfp" alt="PFP" onclick="showUserProfile('${userAddr}')">
        </div>
        
        <div class="comment-content-wrapper">
        
          <strong>
            <span class="clickable-address" onclick="showUserProfile('${userAddr}')">
              ${userAddr.slice(0, 6)}...${userAddr.slice(-4)}
            </span>:
          </strong>

          
          <small>${timestamp}</small><br><br>
          
          <div class="comment-view-mode" id="view-mode-${prefix}-${globalBetId}-${i}">
            <p style="margin: 2px 0; word-wrap: break-word;">${comment.text}</p><br>
            ${editButtonHtml}
          </div>
          
          <div class="comment-edit-mode" id="edit-mode-${prefix}-${globalBetId}-${i}">
            <textarea id="edit-input-${prefix}-${globalBetId}-${i}">${comment.text}</textarea>
            <button onclick="handleSendEdit('${prefix}', ${globalBetId}, ${i})">Save</button>
            <button class="cancel-btn" onclick="toggleEditMode('${prefix}', ${globalBetId}, ${i}, false)">Cancel</button>
          </div>
        </div>
      `;
      
      listDiv.appendChild(commentEl);
    });

  } catch (err) {
    console.error(`Gagal memuat komentar untuk bet ${globalBetId}:`, err);
    listDiv.innerHTML = "<small>Gagal memuat komentar.</small>";
  }
}

async function handleSendComment(prefix, globalBetId) {

  if (!contract) return alert("‚ö†Ô∏è Connect your wallet first!");

  const input = document.getElementById(`comment-input-${prefix}-${globalBetId}`);

  const btn = input ? input.nextElementSibling : null;

  if (!input || !btn) return console.error("Elemen input/button komentar tidak ditemukan");

  const text = input.value.trim();

  if (!text) return alert("Komentar tidak boleh kosong!");

  if (text.length > 5000) return alert("Komentar terlalu panjang (maks 5000 karakter).");



  btn.disabled = true; input.disabled = true; btn.textContent = "Mengirim...";

  try {

    const tx = await contract.addComment(globalBetId, text);

    await tx.wait();

    alert("Komentar berhasil dikirim!");

    input.value = "";

    await loadComments(prefix, globalBetId); // Muat ulang DENGAN PREFIX

  } catch (err) {

    console.error("Gagal mengirim komentar:", err);

    let userMessage = "Transaksi komentar gagal.";

    const reason = err.reason || (err.data ? contract?.interface?.parseError(err.data)?.args[0] : null) || err.message;

    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;

    alert(userMessage);

  } finally {

    if (btn) btn.disabled = false;

    if (input) input.disabled = false;

    if (btn) btn.textContent = "Kirim";

  }

}



function toggleEditMode(prefix, globalBetId, index, isEditing) {

  const viewMode = document.getElementById(`view-mode-${prefix}-${globalBetId}-${index}`);

  const editMode = document.getElementById(`edit-mode-${prefix}-${globalBetId}-${index}`);

  const input = document.getElementById(`edit-input-${prefix}-${globalBetId}-${index}`);

  if (!viewMode || !editMode || !input) return console.error("Elemen mode edit/view tidak ditemukan");



  if (isEditing) {

    viewMode.style.display = 'none';

    editMode.style.display = 'block';

    input.focus();

  } else {

    viewMode.style.display = 'block';

    editMode.style.display = 'none';

    const originalTextElement = viewMode.querySelector('p');

    if (originalTextElement) input.value = originalTextElement.textContent;

  }

}



async function handleSendEdit(prefix, globalBetId, index) {

  if (!contract) return alert("‚ö†Ô∏è Connect your wallet first!");

  const input = document.getElementById(`edit-input-${prefix}-${globalBetId}-${index}`);

  if (!input) return console.error("Elemen input edit tidak ditemukan");

  const newText = input.value.trim();

  if (!newText) return alert("Komentar tidak boleh kosong!");

  if (newText.length > 5000) return alert("Komentar terlalu panjang (maks 5000 karakter).");



  const saveBtn = input.nextElementSibling;

  const cancelBtn = saveBtn ? saveBtn.nextElementSibling : null;

  if (saveBtn) saveBtn.disabled = true;

  if (cancelBtn) cancelBtn.disabled = true;

  input.disabled = true;

  if (saveBtn) saveBtn.textContent = "Saving...";



  try {

    const tx = await contract.editComment(globalBetId, index, newText);

    await tx.wait();

    alert("Komentar berhasil diperbarui!");

    const viewParagraph = document.querySelector(`#view-mode-${prefix}-${globalBetId}-${index} p`);

    if (viewParagraph) viewParagraph.textContent = newText;

    toggleEditMode(prefix, globalBetId, index, false); // Panggil DENGAN PREFIX

  } catch (err) {

    console.error("Gagal edit komentar:", err);

    let userMessage = "Gagal mengedit komentar.";

    const reason = err.reason || (err.data ? contract?.interface?.parseError(err.data)?.args[0] : null) || err.message;

    if (reason) userMessage = `Error: ${reason.substring(0, 100)}`;

    alert(userMessage);

  } finally {

    if (saveBtn) saveBtn.disabled = false;

    if (cancelBtn) cancelBtn.disabled = false;

    input.disabled = false;

    if (saveBtn) saveBtn.textContent = "Save";

  }

}



// --- FUNGSI LIKE & RATING (DENGAN PREFIX) ---



async function loadLikeAndRatingData(prefix, globalBetId) {

  if (!contract || !userAddress) return;

  const likeBtn = document.getElementById(`like-btn-${prefix}-${globalBetId}`);

  const likeCountSpanId = `like-count-${prefix}-${globalBetId}`;

  const starsDiv = document.getElementById(`stars-${prefix}-${globalBetId}`);

  const avgRatingSpan = document.getElementById(`avg-rating-${prefix}-${globalBetId}`);

  if (!likeBtn || !starsDiv || !avgRatingSpan) {

    console.error(`Missing elements for like/rating UI for bet ${globalBetId}`);

    return;

  }



  // Reset UI

  likeBtn.classList.remove('liked');

  likeBtn.innerHTML = `<img src="like.svg" alt="Like" style="width: 25px; height: 25px; vertical-align: middle;"> Like (<span id="${likeCountSpanId}">...</span>)`;

  updateStarDisplay(starsDiv, 0);

  starsDiv.dataset.currentRating = 0;

  avgRatingSpan.textContent = `(Loading...)`;



  try {

    const [countResult, userLikeResult, userRatingResult, avgRatingResult, ratingCountResult] = await Promise.allSettled([

      contract.getLikeCount(globalBetId),

      contract.getUserLike(globalBetId, userAddress),

      contract.getUserRating(globalBetId, userAddress),

      contract.getAverageRating(globalBetId),

      contract.getRatingCount(globalBetId)

    ]);



    // Proses Like

    let likeCount = 0;

    let userLike = false;

    if (countResult.status === 'fulfilled') {

      likeCount = Number(countResult.value);

    } else {

      console.error(`Gagal ambil like count for bet ${globalBetId}:`, countResult.reason);

      const span = document.getElementById(likeCountSpanId);

      if (span) span.textContent = "?";

    }

    if (userLikeResult.status === 'fulfilled') {

      userLike = userLikeResult.value;

    } else {

      console.error(`Gagal ambil user like status for bet ${globalBetId}:`, userLikeResult.reason);

    }

    if (userLike) {

      likeBtn.classList.add('liked');

      likeBtn.innerHTML = `<img src="dislike.svg" alt="Unlike" style="width: 20px; height: 20px; vertical-align: middle;">(<span id="${likeCountSpanId}">${likeCount}</span>)`;

    } else {

      likeBtn.classList.remove('liked');

      likeBtn.innerHTML = `<img src="like.svg" alt="Like" style="width: 25px; height: 25px; vertical-align: middle;"> Like (<span id="${likeCountSpanId}">${likeCount}</span>)`;

    }



    // Proses Rating

    let currentRating = 0;

    if (userRatingResult.status === 'fulfilled') {

      currentRating = Number(userRatingResult.value);

    } else {

      console.error(`Gagal ambil user rating for bet ${globalBetId}:`, userRatingResult.reason);

    }

    starsDiv.dataset.currentRating = currentRating;

    updateStarDisplay(starsDiv, currentRating);



    // Proses Avg Rating

    if (ratingCountResult.status === 'fulfilled' && avgRatingResult.status === 'fulfilled') {

      const avgRatingCount = Number(ratingCountResult.value);

      if (avgRatingCount > 0) {

        const avgRating = Number(avgRatingResult.value) / 100;

        avgRatingSpan.textContent = `(${avgRating.toFixed(1)} avg)`;

      } else {

        avgRatingSpan.textContent = `(0)`;

      }

    } else {

      console.error(`Gagal ambil average/count rating for bet ${globalBetId}:`, avgRatingResult.reason || ratingCountResult.reason);

      avgRatingSpan.textContent = `(Error avg)`;

    }

  } catch (err) {

    console.error(`Unexpected error in loadLikeAndRatingData for bet ${globalBetId}:`, err);

    const span = document.getElementById(likeCountSpanId);

    if (span) span.textContent = "?";

    avgRatingSpan.textContent = "(Error)";

  }

}



async function handleLikeToggle(prefix, globalBetId) {

  if (!contract || !userAddress) return alert("‚ö†Ô∏è Connect your wallet first!");

  const likeBtn = document.getElementById(`like-btn-${prefix}-${globalBetId}`);

  if (!likeBtn || likeBtn.disabled) return;



  const originalHTML = likeBtn.innerHTML;

  likeBtn.disabled = true;

  likeBtn.innerHTML = `<img src="load.svg" alt="..." style="width: 25px; height: 25px;"> Processing...`;

  try {

    const tx = await contract.likeSpin(globalBetId);

    await tx.wait();

    await loadLikeAndRatingData(prefix, globalBetId); // Panggil DENGAN PREFIX

  } catch (err) {

    console.error("Gagal like/unlike:", err);

    alert("Gagal memperbarui Like/Unlike: " + err.message);

    likeBtn.innerHTML = originalHTML;

    likeBtn.disabled = false; // Enable manual jika error

  }

  // 'disabled = false' akan di-set oleh loadLikeAndRatingData jika sukses (implisit, karena innerHTML diganti)

  // Tapi kita set manual saja di 'finally' untuk keamanan

  finally {

      if (likeBtn) likeBtn.disabled = false;

  }

}



async function handleRating(prefix, globalBetId, ratingValue) {

  if (!contract || !userAddress) return alert("‚ö†Ô∏è Connect your wallet first!");

  const starsDiv = document.getElementById(`stars-${prefix}-${globalBetId}`);

  if (!starsDiv || starsDiv.dataset.processing === 'true') return;



  starsDiv.dataset.processing = 'true';

  starsDiv.style.opacity = '0.5';

  try {

    const tx = await contract.rateBet(globalBetId, ratingValue);

    await tx.wait();

    alert("Rating berhasil disimpan!");

    await loadLikeAndRatingData(prefix, globalBetId); // Panggil DENGAN PREFIX

  } catch (err) {

    console.error("Gagal rate bet:", err);

    alert("Gagal menyimpan rating: " + err.message);

    resetStarsHighlight(prefix, globalBetId); // Panggil DENGAN PREFIX

  } finally {

    delete starsDiv.dataset.processing;

    starsDiv.style.opacity = '1';

  }

}



function updateStarDisplay(starsDiv, rating) {

    if (!starsDiv) return;

    const stars = starsDiv.querySelectorAll('span');

    stars.forEach(star => {

        const starValue = star.dataset.value ? parseInt(star.dataset.value) : 0;

        star.classList.toggle('filled', starValue > 0 && starValue <= rating);

        star.innerHTML = starValue > 0 && starValue <= rating ? '‚òÖ' : '‚òÜ';

    });

}



function highlightStars(prefix, globalBetId, hoverValue) {

    const starsDiv = document.getElementById(`stars-${prefix}-${globalBetId}`);

    if (!starsDiv || starsDiv.dataset.processing === 'true') return;

    const stars = starsDiv.querySelectorAll('span');

    stars.forEach(star => {

        const starValue = star.dataset.value ? parseInt(star.dataset.value) : 0;

        star.classList.toggle('hover', starValue > 0 && starValue <= hoverValue);

        star.innerHTML = starValue > 0 && starValue <= hoverValue ? '‚òÖ' : '‚òÜ';

    });

  }

  function resetStarsHighlight(prefix, globalBetId) {
    const starsDiv = document.getElementById(`stars-${prefix}-${globalBetId}`);
    if (!starsDiv || starsDiv.dataset.processing === 'true') return;
    const stars = starsDiv.querySelectorAll('span');
    const currentRating = starsDiv.dataset.currentRating ? parseInt(starsDiv.dataset.currentRating) : 0;
    stars.forEach(star => {
        star.classList.remove('hover');
        const starValue = star.dataset.value ? parseInt(star.dataset.value) : 0;
        star.innerHTML = starValue > 0 && starValue <= currentRating ? '‚òÖ' : '‚òÜ';
    });
  }

  /**
 * FUNGSI BARU: Menampilkan modal profil.
 */
function showUserProfile(address) {
  if (!contract) return alert("‚ö†Ô∏è Connect wallet first!");
  
  const modal = document.getElementById('userProfileModal');
  if (!modal) return;

  // Tampilkan modal
  modal.style.display = "flex";
  setTimeout(() => modal.classList.add('show'), 10);

  // Reset teks ke "Loading..."
  document.getElementById('profile-address').textContent = address;
  document.getElementById('profile-modal-pfp').src = "default-pfp.png"; // Reset ke default
  document.getElementById('profile-eth-balance').textContent = "...";
  document.getElementById('profile-faylotto-balance').textContent = "...";
  document.getElementById('profile-referral-count').textContent = "...";
  document.getElementById('profile-public-spins').textContent = "...";
  document.getElementById('profile-uid').textContent = "...";
  document.getElementById('profile-free-spin-date').textContent = "...";
  document.getElementById('profile-free-spin-used').textContent = "...";

  // Panggil fungsi untuk memuat data
  loadProfileData(address);
}

/**
 * FUNGSI BARU: Menutup modal profil.
 */
function closeProfileModal() {
  const modal = document.getElementById('userProfileModal');
  if (!modal) return;
  
  modal.classList.remove('show');
  setTimeout(() => modal.style.display = "none", 300); // Tunggu animasi selesai
}

/**
 * FUNGSI BARU (MODIFIKASI): Mengambil data DAN menghitung PFP.
 */
async function loadProfileData(address) {
  try {
    // === 1. LOGIKA PFP OTOMATIS (BARU) ===
    const TOTAL_PFP_IMAGES = 10; // Jumlah gambar (pfp-0.png s/d pfp-9.png)
    
    // Ambil 1 karakter terakhir dari alamat
    const lastChar = address.slice(-1); 
    // Konversi karakter hex (0-f) menjadi angka (0-15)
    const hash = parseInt(lastChar, 16); 
    // Gunakan modulo untuk mendapatkan angka antara 0 dan 9
    const imageIndex = hash % TOTAL_PFP_IMAGES; 
    
    // Atur URL gambar. GANTI 'path/to/images/' dengan path Anda
    const imageUrl = `pfp-${imageIndex}.png`; 
    
    document.getElementById('profile-modal-pfp').src = imageUrl;
    
    // === 2. AMBIL DATA (Sama seperti sebelumnya) ===
    
    // Ambil data balance
    const [ethBal, faylottoBal] = await Promise.all([
      provider.getBalance(address),
      contract.balanceOf(address)
    ]);
    document.getElementById('profile-eth-balance').textContent = `${parseFloat(ethers.formatEther(ethBal)).toFixed(6)} ETH`;
    document.getElementById('profile-faylotto-balance').textContent = `${parseFloat(ethers.formatUnits(faylottoBal, 18)).toFixed(2)} FAY`;

    // Ambil data referral
    const [refInfo, refCount] = await Promise.all([
      contract.referrals(address),
      contract.getReferralCount(address)
    ]);
    document.getElementById('profile-referral-count').textContent = Number(refCount);
    document.getElementById('profile-uid').textContent = refInfo.uid || "N/A";

    // Ambil data free spin
    const spinData = await contract.freeSpinData(address);
    const quota = await contract.freeSpinQuota(); // Ambil kuota
    const createdDate = Number(spinData.walletCreated) === 0 ? "Belum terdaftar" : new Date(Number(spinData.walletCreated) * 1000).toLocaleDateString();
    document.getElementById('profile-free-spin-date').textContent = createdDate;
    document.getElementById('profile-free-spin-used').textContent = `${Number(spinData.freeSpinsUsed)} / ${Number(quota)}`;
    
    // Hitung spin publik (dari data yang sudah ada)
    if (allPublicBets.length > 0) {
        const userPublicSpins = allPublicBets.filter(bet => bet.player.toLowerCase() === address.toLowerCase());
        document.getElementById('profile-public-spins').textContent = userPublicSpins.length;
    } else {
         document.getElementById('profile-public-spins').textContent = "(N/A)";
    }

  } catch (err) {
    console.error(`Gagal memuat profil untuk ${address}:`, err);
    document.getElementById('profile-eth-balance').textContent = "Error";
    document.getElementById('profile-faylotto-balance').textContent = "Error";
  }
}

/**
 * FUNGSI HELPER BARU: Menghasilkan URL PFP acak (deterministik)
 * berdasarkan alamat wallet.
 */
function getDeterministicPfpUrl(address) {
  try {
    // Ambil 1 karakter terakhir dari alamat
    const lastChar = address.slice(-1); 
    // Konversi karakter hex (0-f) menjadi angka (0-15)
    const hash = parseInt(lastChar, 16); 
    // Gunakan modulo untuk mendapatkan angka antara 0 dan 9
    const imageIndex = hash % TOTAL_PFP_IMAGES; 
    
    // Atur URL gambar
    return `${PFP_IMAGE_PATH}pfp-${imageIndex}.png`; 
  } catch (err) {
    console.error("Gagal generate PFP URL:", err);
    return `${PFP_IMAGE_PATH}default-pfp.png`; // Fallback ke default
  }
}

// tambahkan efek futuristik glow 5 detik
walletInfo.classList.add("glow");

// hapus class glow setelah 5 detik agar bisa trigger lagi di connect berikutnya
setTimeout(() => {
  walletInfo.classList.remove("glow");
}, 5000);
  
connectBtn.addEventListener("click", connectWallet);
disconnectBtn.addEventListener("click", disconnectWallet);
btn.addEventListener("click", handleSpinClick);
document.getElementById("year").textContent = new Date().getFullYear();
</script>
  
</body>
    </html>
