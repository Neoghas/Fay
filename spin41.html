<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Faylotto Spin Wheel</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.6.4/dist/ethers.umd.min.js"></script>
<style>
  html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  overflow-x: hidden; /* mencegah geser horizontal */
  }
  
body {
    font-family: 'Ubuntu', sans-serif;
    font-weight: bold;
    text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3);
    text-align: center;
    margin: 0;
    padding: 0;
    width: 100%;
    background-color: #000;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    font-size: 1rem; /* Gunakan rem agar fleksibel */
    padding-top: 70px; /* Memberikan ruang untuk navbar */
}

/* Container */
.container {
    width: 100%; /* Gunakan persentase agar fleksibel */
    max-width: 1200px; /* Sedikit lebih ramping dari 1250px */
    margin: auto;
    padding: 20px;
    background: #000000;
    box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    backdrop-filter: blur(10px);
    box-sizing: border-box;
    margin-top: 20px; /* Jarak dari navbar */
    
    /* Perbaikan Responsif: */
    display: flex;
    flex-direction: column;
    align-items: center; /* Memusatkan item di dalamnya */
    position: relative; /* Kunci untuk .wallet-info versi desktop */
}

/* Media Query untuk layar besar (Monitor besar & Ultrawide) */
@media (min-width: 1600px) {
    body {
        font-size: 1.2rem;
    }
}
  
  /* === Hero Section === */
.hero {
  position: relative;
  width: 100%;
  text-align: center;
  margin-top: 140px; /* kasih jarak dari navbar (akan di-override di mobile) */
  margin-bottom: 40px;
  animation: fadeIn 1.2s ease-in-out;
  order: 1; /* Urutan setelah wallet-info di mobile */
}

.hero-title {
  font-size: 35px;
  font-weight: 700;
  background: linear-gradient(90deg, #b3a4ff, #d6b8ff, #f2d4ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 12px rgba(180,140,255,0.35));
  letter-spacing: 1px;
}

.hero-subtitle {
  font-size: 20px;
  margin-top: 12px;
  color: #e7dbff;
  opacity: 0.9;
  filter: drop-shadow(0 0 6px rgba(160,120,255,0.25));
}

  .hero.scrolled .wallet-info {
  opacity: 0;
  pointer-events: none;
  }

/* animasi soft fade */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

  /* === Navbar === */
.navbar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 70px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(10, 10, 20, 0.85);
  backdrop-filter: blur(8px);
  padding: 0 35px;
  box-sizing: border-box;
  z-index: 9999;
}
  
/* === Logo dan Brand === */
.navbar-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo {
  width: 42px;
  height: 42px;
  object-fit: contain;
}

.brand-name {
  font-family: 'Ubuntu', sans-serif;
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  letter-spacing: 1px;
}

/* === Wallet Buttons === */
.wallet-controls {
  display: flex;
  flex-direction: row;
  gap: 10px;
  align-items: center;
  margin-right: 5px; /* Tambahan kecil biar sejajar halus */
}

/* Tombol futuristik smooth */
.wallet-btn {
  background: linear-gradient(135deg, #00e0ff, #0077ff, #a855f7);
  background-size: 300% 300%;
  color: #fff;
  font-weight: bold;
  border: 2px solid rgba(255, 255, 255, 0.25);
  border-radius: 12px;
  padding: 10px 22px;
  cursor: pointer;
  transition: transform 0.4s ease, box-shadow 0.4s ease;
  animation: neonFlow 6s ease infinite;
  box-shadow: 0 0 6px rgba(0, 255, 255, 0.25);
}

/* Hover efek slow dan smooth */
.wallet-btn:hover {
  transform: scale(1.06);
  box-shadow: 0 0 14px rgba(0, 255, 255, 0.5);
}

/* Animasi aliran warna halus */
@keyframes neonFlow {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

/* Klik (active): sedikit redup */
.wallet-btn:active {
  transform: scale(0.97);
  filter: brightness(0.9);
}
  
  /* Wallet info box futuristik */
.wallet-info {
  position: absolute;
  top: 25px;
  right: 25px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  background: linear-gradient(135deg, #00d4ff, #b28aff, #ff80c8);
  padding: 14px 20px;
  border-radius: 14px;
  color: #fff;
  font-weight: bold;
  box-shadow: 0 0 8px rgba(0, 255, 255, 0.1);
  transition: box-shadow 0.5s ease-in-out, transform 0.5s ease-in-out, position 0.3s ease, width 0.3s ease;
  overflow: hidden;
  order: 0; /* Urutan default di desktop */
}

/* === Efek garis tepi bergerak seperti aliran listrik === */
.wallet-info::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 14px;
  padding: 2px; /* ketebalan garis luar */
  background: linear-gradient(
    120deg,
    #00ffff,
    #b28aff,
    #ff80c8,
    #00ffff
  );
  background-size: 300% 300%;
  animation: borderFlow 5s linear infinite;
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask-composite: exclude; /* Firefox pakai -moz, Chrome pakai standard */
  -webkit-mask-composite: xor;
  pointer-events: none;
}

/* Efek kilauan listrik bergerak */
@keyframes borderFlow {
  0% {
    background-position: 0% 50%;
    filter: drop-shadow(0 0 2px #00ffff) drop-shadow(0 0 5px #ff80c8);
  }
  50% {
    background-position: 100% 50%;
    filter: drop-shadow(0 0 6px #00ffff) drop-shadow(0 0 12px #b28aff);
  }
  100% {
    background-position: 0% 50%;
    filter: drop-shadow(0 0 2px #00ffff) drop-shadow(0 0 5px #ff80c8);
  }
}

/* Glow lembut keseluruhan (bisa dipicu JS) */
@keyframes softGlow {
  0% {
    box-shadow: 0 0 3px rgba(0, 255, 255, 0.1),
                0 0 6px rgba(255, 128, 200, 0.05);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 8px rgba(0, 255, 255, 0.25),
                0 0 12px rgba(178, 138, 255, 0.15);
    transform: scale(1.01);
  }
  100% {
    box-shadow: 0 0 3px rgba(0, 255, 255, 0.1),
                0 0 6px rgba(255, 128, 200, 0.05);
    transform: scale(1);
  }
}

/* Aktifkan saat connect wallet */
.glow {
  animation: softGlow 5s ease-in-out;
}

  .wallet-address {
  cursor: pointer;
  user-select: none;
}
.wallet-address:hover {
  opacity: 0.8;
}

.wallet-address {
  font-size: 14px;
  font-weight: bold;
  color: #fff;
}

.wallet-balance {
  font-size: 13px;
  color: #fff;
}

/* Pembungkus <center> tag */
.container > center {
  width: 350px; /* Ukuran desktop */
  height: 350px; /* Ukuran desktop */
  transition: width 0.3s ease, height 0.3s ease;
  order: 2; /* Urutan di layout flex */
}

  .wheel-container {
  position: relative;
  width: 100%; /* Selalu penuhi pembungkus <center> */
  height: 100%; /* Selalu penuhi pembungkus <center> */
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: visible;
}

  /* Pastikan animasi yang keluar dari SVG terlihat */
svg {
    width: 100%;
    height: 100%;
    display: block;
    overflow: visible;  /* kunci supaya efek glow tidak terpotong */
}

/* Optional: jika ada group <g> di dalam SVG */
svg g {
    transform-origin: center center;
    overflow: visible;
}

/* Lingkaran listrik menempel di tepi wheel */
.wheel-container::after {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border-radius: 50%;
  border: 7px solid transparent;
  background: conic-gradient(
    from 0deg,
    #00eaff,
    #7b00ff,
    #ff5edc,
    #00eaff
  );
  mask: radial-gradient(farthest-side, transparent calc(100% - 6px), black 100%);
  -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 3px), black 100%);
  animation: electricFlow 2.5s linear infinite, sparkFlicker 1.2s ease-in-out infinite alternate;
  box-shadow:
    0 0 10px #00eaff,
    0 0 20px #b44bff,
    0 0 30px #ff6be7,
    inset 0 0 12px #00eaff;
  pointer-events: none;
  z-index: 10;
}

/* Efek arus listrik mengalir melingkar */
@keyframes electricFlow {
  0% {
    transform: rotate(0deg);
    filter: hue-rotate(0deg) brightness(1);
  }
  100% {
    transform: rotate(360deg);
    filter: hue-rotate(360deg) brightness(1.3);
  }
}

/* Percikan cepat saat spin */
@keyframes sparkFlickerFast {
  0%, 100% { opacity: 0.95; }
  50% { opacity: 1; }
}

  #enterBtn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 85px;
  height: 85px;
  border-radius: 50%;
  background: linear-gradient(145deg, #FFD700, #FFA500);
  color: fff;
  font-weight: bold;
  font-size: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow:
    0 0 20px rgba(255, 200, 0, 0.8),
    inset 0 3px 5px rgba(255, 255, 255, 0.4);
  border: 3px solid #fff;
  transition: all 0.3s ease;
  z-index: 15;
  animation: btnGlow 3s infinite alternate;
}

/* Saat hover, cahaya lebih kuat */
#enterBtn:hover {
  transform: translate(-50%, -50%) scale(1.08);
  box-shadow:
    0 0 30px rgba(255, 240, 100, 0.9),
    inset 0 4px 8px rgba(255, 255, 255, 0.6);
}

/* Saat disable */
#enterBtn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Animasi glow lembut (FIXED TYPO) */
@keyframes btnGlow {
  0% {
    box-shadow:
      0 0 18px rgba(255, 215, 0, 0.8),
      inset 0 2px 4px rgba(255, 255, 255, 0.3);
  }
  50% {
    box-shadow:
      0 0 30px rgba(255, 255, 180, 0.9),
      inset 0 3px 6px rgba(255, 255, 255, 0.5);
  }
  100% {
    box-shadow:
      0 0 18px rgba(255, 215, 0, 0.8),
      inset 0 2px 4px rgba(255, 255, 255, 0.3);
  }
}

#centerBtn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 85px;
  height: 85px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #0ff, #7b00ff, #ff58d6);
  color: #fff;
  font-weight: bold;
  font-size: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: 3px solid transparent;
  box-shadow:
    0 0 25px rgba(0, 255, 255, 0.8),
    0 0 45px rgba(170, 0, 255, 0.6),
    inset 0 0 15px rgba(255, 90, 220, 0.8);
  z-index: 15;
  transition: all 0.3s ease;
  animation: btnGlow 2s ease-in-out infinite alternate;
  overflow: hidden;
}

/* Efek aliran listrik melingkar */
#centerBtn::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 3px solid transparent;
  background: conic-gradient(
    from 0deg,
    #00ffff,
    #7b00ff,
    #ff58d6,
    #00ffff
  );
  mask: radial-gradient(farthest-side, transparent calc(100% - 3px), black 100%);
  -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 3px), black 100%);
  animation: electricRing 1.8s linear infinite;
  pointer-events: none;
  z-index: 1;
}

/* Glow lembut di tombol */
@keyframes btnGlow {
  0% {
    box-shadow:
      0 0 20px #00ffff,
      0 0 40px #7b00ff,
      inset 0 0 15px #ff58d6;
    transform: translate(-50%, -50%) scale(1);
  }
  50% {
    box-shadow:
      0 0 30px #00ffff,
      0 0 60px #b44bff,
      inset 0 0 20px #ff6be7;
    transform: translate(-50%, -50%) scale(1.05);
  }
  100% {
    box-shadow:
      0 0 20px #00ffff,
      0 0 40px #7b00ff,
      inset 0 0 15px #ff58d6;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* Hover â€“ nyala lebih terang */
#centerBtn:hover {
  filter: brightness(1.3);
  box-shadow:
    0 0 35px #00ffff,
    0 0 70px #ff6be7,
    inset 0 0 25px #ff8cff;
}

/* Teks cost ETH di bawah SPIN */
#centerBtn .cost {
  font-size: 10px;
  color: #fff;
  font-weight: bold;
  margin-top: 2px;
  text-shadow: 0 0 5px #00ff6a, 0 0 10px #00ff6a;
}

  .result {
    margin-top: 30px;
    font-size: 20px;
    text-align: center;
    transition: all 0.5s ease;
    min-height: 30px;
    order: 3; /* Urutan di layout flex */
  }

  @keyframes pulseGlow {
  0% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px #00ffff)
            drop-shadow(0 0 20px #a26bff)
            drop-shadow(0 0 30px #ff70b8);
  }
  50% {
    transform: scale(1.1);
    filter: drop-shadow(0 0 15px #6bffff)
            drop-shadow(0 0 30px #b57bff)
            drop-shadow(0 0 45px #ff7bd6);
  }
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px #00ffff)
            drop-shadow(0 0 20px #a26bff)
            drop-shadow(0 0 30px #ff70b8);
  }
}

.glow {
  animation: pulseGlow 1s infinite alternate;
  transform-origin: center center;
}

/* container utama popup */
.result-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(120, 0, 255, 0.15);
  backdrop-filter: blur(15px) saturate(180%);
  -webkit-backdrop-filter: blur(15px) saturate(180%);
  border: 1.5px solid rgba(160, 0, 255, 0.3);
  border-radius: 22px;
  padding: 28px 40px;
  text-align: center;
  font-size: 20px;
  color: #fff;
  z-index: 9999;
  display: none;
  opacity: 0;
  transition: opacity 0.8s ease, transform 0.8s ease;
  box-shadow:
    inset 0 0 20px rgba(200, 0, 255, 0.25),
    0 0 25px rgba(187, 0, 255, 0.4),
    0 0 50px rgba(0, 255, 255, 0.2);
  animation: softGlow 18s ease-in-out infinite alternate, 
             subtleScale 18s ease-in-out infinite alternate;
  overflow: hidden;

  /* Perbaikan Responsif */
  width: 90%;
  max-width: 500px; /* Batas atas */
  box-sizing: border-box;
}

/* glow lembut */
@keyframes softGlow {
  0% {
    box-shadow:
      inset 0 0 18px rgba(200, 0, 255, 0.2),
      0 0 25px rgba(187, 0, 255, 0.3),
      0 0 50px rgba(0, 255, 255, 0.15);
  }
  50% {
    box-shadow:
      inset 0 0 22px rgba(200, 0, 255, 0.25),
      0 0 30px rgba(187, 0, 255, 0.35),
      0 0 55px rgba(0, 255, 255, 0.2);
  }
  100% {
    box-shadow:
      inset 0 0 18px rgba(200, 0, 255, 0.2),
      0 0 25px rgba(187, 0, 255, 0.3),
      0 0 50px rgba(0, 255, 255, 0.15);
  }
}
  
@keyframes subtleScale {
  0%, 100% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -50%) scale(1.02); }
}
  
/* partikel lembut melayang */
.result-popup span.particle {
  position: absolute;
  border-radius: 50%;
  opacity: 0.6;
  animation: floatSoft 10s infinite ease-in-out alternate;
}

@keyframes floatSoft {
  0% {
    transform: translate(0, 0) scale(1);
    opacity: 0.5;
  }
  50% {
    transform: translate(20px, -30px) scale(1.3);
    opacity: 0.9;
  }
  100% {
    transform: translate(-15px, 25px) scale(1);
    opacity: 0.6;
  }
}

/* efek muncul / hilang */
.result-popup.show {
  display: block;
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}

.result-popup.hide {
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.97);
  pointer-events: none;
}

.result-popup img.icon {
  width: 60px;
  height: 60px;
  vertical-align: middle;
  margin-bottom: 10px;
}

.result-popup img.prize {
  width: 55px;
  height: 55px;
  vertical-align: middle;
  margin-left: 10px;
  border-radius: 12px;
  box-shadow: 0 0 10px gold;
}

.popup-btn {
  margin-top: 18px;
  background: linear-gradient(145deg, #ff00c8, #8a2be2, #00f0ff);
  border: none;
  border-radius: 10px;
  color: #fff;
  font-weight: bold;
  padding: 10px 22px;
  cursor: pointer;
  transition: 0.2s;
  box-shadow: 0 0 10px #ff00ff;
}

.popup-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px #00f0ff;
}

  /* ===== Minimal Footer Style ===== */
  footer {
        width: 100%; /* Penuhi lebar body */
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        background: #000; /* Warna gelap */
        color: #ddd; /* Warna teks */
        font-size: 12px;
        box-sizing: border-box; /* Agar padding tidak menambah lebar */
    }
    
    footer p {
        display: flex;
        flex-wrap: wrap; /* Izinkan wrapping di mobile */
        justify-content: center;
        align-items: center;
        gap: 5px 10px; /* Jarak antar item */
    }

    .social-icons {
        margin-bottom: 10px;
    }

    .social-icons a {
    background: rgba(255, 255, 255, 0.2); /* Transparan seperti kaca */
    border-radius: 10px; /* Agar sedikit membulat */
    padding: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white; /* Warna ikon */
    font-size: 15px;
    margin: 0 5px;
    text-decoration: none;
    transition: transform 0.5s ease, text-shadow 0.5s ease, box-shadow 0.5s ease;
    box-shadow: 0 0 10px rgba(0, 0, 255, 0.6); /* Cahaya biru */
    backdrop-filter: blur(10px); /* Efek blur kaca */
}

/* Efek saat hover */
.social-icons a:hover {
    color: #1a88ff; /* Warna biru neon */
    text-shadow: 0 0 10px #1a88ff, 0 0 20px #1a88ff, 0 0 30px #1a88ff; /* Glow lebih intens */
    box-shadow: 0 0 20px rgba(0, 0, 255, 1), 0 0 30px rgba(0, 0, 255, 0.8); /* Shadow lebih terang */
    transform: rotate(360deg); /* Efek berputar */
}

  /* Spin History */
   .history-container {
    max-width: 600px;
    width: 100%; /* Penuhi lebar container flex */
    margin: 10px 0; /* Margin atas/bawah, 0 kiri/kanan */
    border: 1px solid #444; /* Warna lebih gelap */
    border-radius: 8px;
    overflow: hidden;
    background: #1a1a2e; /* Latar belakang gelap */
    order: 4; /* Urutan di layout flex */
  }
  .history-container h2 {
    background: #2c2c3a; /* Latar belakang header lebih gelap */
    padding: 12px;
    margin: 0;
    text-align: center;
    color: #f39c12; /* Emas */
  }
  #userHistory, #publicHistory {
    overflow-y: auto; /* Agar bisa di-scroll */
    height: 400px; /* Tinggi tetap, sesuaikan sesuai kebutuhan */
    padding: 10px;
    box-sizing: border-box;
  }
  .history-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .history-list li {
    background: #2c2c3a; /* Latar belakang item list */
    color: #eee;
    margin: 10px 0;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    font-size: 14px;
    line-height: 1.5;
    border-left: 4px solid #f39c12; /* Aksen emas */
  }
  .loader {
    text-align: center;
    padding: 10px;
    font-style: italic;
    color: #888;
    display: none; /* Awalnya hidden, JS akan tampilkan saat load */
  }
  button.load-btn {
    display: block;
    margin: 10px auto;
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button.load-btn:hover {
    background: #0056b3;
  }

  /* ========== STYLING REFERRAL ========== */
.referral-container {
  background-color: #2c2c3a; /* Sedikit lebih gelap */
  padding: 20px;
  border-radius: 10px;
  border: 1px solid #444;
  margin-top: 10px;
  display: none; /* Sembunyi secara default, JS akan menampilkan */
  width: 100%; /* Penuhi lebar */
  max-width: 600px; /* Samakan dengan history */
  box-sizing: border-box;
  order: 5; /* Urutan di layout flex */
}

.referral-container h2 {
  margin-top: 0;
  color: #f39c12; /* Emas */
  text-align: center;
}

.status-text {
  text-align: center;
  color: #aaa;
  font-style: italic;
  margin-bottom: 15px;
}

/* Sembunyikan view default */
#noUidView,
#hasUidView,
#claimRewardBtn {
  display: none;
}

.ref-btn {
  background-color: #f39c12;
  color: #1a1a2e;
  font-weight: bold;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s;
  width: 100%;
  font-size: 16px;
}

.ref-btn:hover:not(:disabled) {
  background-color: #e67e22;
}

.ref-btn:disabled {
  background-color: #555;
  cursor: not-allowed;
}

.ref-btn.claim-btn {
  background-color: #2ecc71; /* Hijau */
  color: white;
}
.ref-btn.claim-btn:hover:not(:disabled) {
  background-color: #27ae60;
}

.info-box {
  margin-bottom: 15px;
}

.info-box strong {
  display: block;
  color: #bbb;
  margin-bottom: 5px;
}

.uid-display {
  font-size: 1.2em;
  color: #f39c12;
  font-weight: bold;
  font-family: 'Courier New', Courier, monospace;
}

.link-wrapper {
  display: flex;
}

.link-wrapper input[type="text"] {
  flex-grow: 1;
  padding: 8px;
  background-color: #1a1a2e;
  border: 1px solid #444;
  color: white;
  border-radius: 5px 0 0 5px;
}

.small-btn {
  width: auto;
  font-size: 14px;
  border-radius: 0 5px 5px 0;
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin: 20px 0;
}

.stat-item {
  background-color: #1a1a2e;
  padding: 15px;
  border-radius: 5px;
  text-align: center;
}

.stat-item span {
  display: block;
  color: #aaa;
  font-size: 0.9em;
}

.stat-item strong {
  display: block;
  font-size: 1.5em;
  color: white;
  margin-top: 5px;
}


/*
===========================================
=== BAGIAN RESPONSIVE (WAJIB DI BAWAH) ===
===========================================
*/

/* -- Target: Tablet (Potrait) & HP (Landscape) -- */
@media (max-width: 768px) {
    body {
        font-size: 0.95rem;
        padding-top: 60px; /* Navbar lebih kecil */
    }
    .container {
        width: 95%;
        padding: 15px;
        margin-top: 10px;
    }
    
    /* Navbar */
    .navbar {
        height: 60px;
        padding: 0 15px;
    }
    .brand-name {
        font-size: 20px;
    }
    .logo {
        width: 38px;
        height: 38px;
    }
    .wallet-btn {
        padding: 8px 16px;
        font-size: 14px;
    }

    /* Hero */
    .hero {
        margin-top: 10px; /* Kurangi jarak karena wallet-info ada di atasnya */
        margin-bottom: 20px;
    }
    .hero-title {
        font-size: 28px;
    }
    .hero-subtitle {
        font-size: 16px;
    }

    /* Info Wallet */
    .wallet-info {
        position: relative; /* Ubah jadi statis */
        top: auto;
        right: auto;
        width: 100%;
        max-width: 600px; /* Samakan dengan history */
        margin: 0 auto 15px auto; /* Tepat di bawah navbar, di atas hero */
        box-sizing: border-box;
        padding: 12px 15px;
        order: -1; /* Pindahkan ke atas .hero */
    }

    /* Wheel */
    .container > center {
        width: 85vw; /* Skala dengan layar */
        height: 85vw; /* Skala dengan layar */
        max-width: 350px;
        max-height: 350px;
    }
    
    #centerBtn {
        width: 75px;
        height: 75px;
        font-size: 15px;
    }
    #centerBtn .cost {
        font-size: 9px;
    }

    /* History */
    .history-container {
        max-width: 100%; /* Izinkan full-width */
    }
    
    /* Referral */
    .stats-grid {
        grid-template-columns: 1fr; /* Tumpuk statistik */
    }
}

/* -- Target: HP (Potrait) -- */
@media (max-width: 480px) {
    body {
        font-size: 0.9rem;
    }
    .container {
        padding: 10px;
        width: 98%;
    }

    /* Navbar */
    .navbar-left {
        gap: 5px;
    }
    .brand-name {
        display: none; /* Sembunyikan nama, hemat ruang */
    }
    .wallet-btn {
        padding: 8px 10px;
        font-size: 12px;
    }
    
    /* Hero */
    .hero {
        margin-top: 10px;
    }
    .hero-title {
        font-size: 24px;
    }
    .hero-subtitle {
        font-size: 14px;
    }

    /* Wheel */
    .container > center {
        width: 90vw; /* Buat 90% dari lebar layar */
        height: 90vw;
    }
    
    /* Popup */
    .result-popup {
        width: 95%; /* Hampir penuhi layar */
        padding: 20px 15px;
        font-size: 16px;
    }
    .result-popup img.icon,
    .result-popup img.prize {
        width: 45px;
        height: 45px;
    }
    
    /* Footer */
    footer p {
        font-size: 11px;
        flex-direction: column; /* Tumpuk link footer */
    }
    footer p span {
        display: block;
        margin-top: 5px;
    }
    .social-icons a {
        padding: 8px;
        font-size: 14px;
        margin: 0 3px;
    }
}
</style>
</head>

<body>

  <nav class="navbar">
    <div class="navbar-left">
      <img src="logo.svg" alt="Faylotto Logo" class="logo">
      <span class="brand-name">Faylotto</span>
    </div>

    <div class="wallet-controls">
      <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
      <button id="disconnectBtn" class="wallet-btn" style="display:none;">Disconnect</button>
    </div>
  </nav>

  <div class="container">

<!-- Box info wallet di bawah tombol -->
<div id="walletInfo" class="wallet-info" style="display:none;">
  <div id="walletAddress" class="wallet-address"> Address: -</div>
  <div id="ethBalance" class="wallet-balance">Balance: - ETH</div>
  <div id="faylottoBalance" class="wallet-balance">Balance: - Faylotto</div>
</div>

  <!-- Hero Section -->
<section class="hero">
  <h1 class="hero-title">Decentralized Spin Betting</h1>
  <p class="hero-subtitle">Play, win, and good luck!</p>
</section>

  <center><div class="wheel-container">
    <svg id="wheel" viewBox="0 0 500 500"></svg>
    <div id="centerBtn">
  SPIN<br>
  <span class="cost"><center>Cost</center>0.000256 ETH</span>
    </div>
  </div></center>
  <div class="result" id="resultText">Press SPIN to play</div>
  
  <div id="resultPopup" class="result-popup"></div>

  <!-- Elemen HTML untuk Riwayat User Pribadi -->
<div class="history-container">
  <h2>Riwayat Spin Saya</h2>
  <button id="loadUserHistoryBtn" class="load-btn">Refresh Riwayat Saya</button> <!-- Opsional, untuk refresh manual -->
  <div id="userHistory"></div>
</div>

<!-- Elemen HTML untuk Riwayat Public -->
<div class="history-container">
  <h2>Riwayat Spin Public (Terbaru)</h2>
  <button id="loadPublicHistoryBtn" class="load-btn">Refresh Riwayat Public</button> <!-- Opsional -->
  <div id="publicHistory"></div>
</div>

  <div class="referral-container" id="referralSection">
  <h2>ðŸŒŸ Program Referral Anda</h2>
  <div id="referralStatus" class="status-text">
    Harap hubungkan wallet untuk melihat info referral.
  </div>

  <div id="noUidView">
    <p>Anda belum memiliki kode referral unik. Buat satu untuk mulai mengundang!</p>
    <button id="generateUIDBtn" class="ref-btn">Buat UID Saya</button>
  </div>

  <div id="hasUidView">
    <div class="info-box">
      <strong>UID Anda:</strong>
      <span id="userUID" class="uid-display"></span>
    </div>
    <div class="info-box">
      <strong>Link Undangan:</strong>
      <div class="link-wrapper">
        <input type="text" id="referralLink" readonly />
        <button id="copyLinkBtn" class="ref-btn small-btn">Salin</button>
      </div>
    </div>

    <h3>Statistik Anda</h3>
    <div class="stats-grid">
      <div class="stat-item">
        <span>Total Undangan</span>
        <strong id="referralCount">0</strong>
      </div>
      <div class="stat-item">
        <span>Reward (ETH)</span>
        <strong id="referralReward">0.00</strong>
      </div>
    </div>
    <button id="claimRewardBtn" class="ref-btn claim-btn">
      Klaim Reward Saya
    </button>
  </div>
  </div>
    
  <audio id="clickSound" src="click.mp3" preload="auto"></audio>
  <audio id="spinSound" src="spin.mp3" preload="auto" loop></audio>
  <audio id="winSound" src="win.mp3" preload="auto"></audio>
</div>
  
  <footer>
    <div id="footer" class="social-icons">
        <a href="https://x.com/FaylottoXyz" target="_blank"><i class="fa-brands fa-twitter"></i></a>
        <a href="https://t.me/FaylottoXyz" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://t.me/Faylotto" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a href="https://discord.gg/6uMYTdCZwJ" target="_blank"><i class="fa-brands fa-discord"></i></a>
        <a href="https://facebook.com/Faylotto" target="_blank"><i class="fa-brands fa-facebook"></i></a>
    </div>
    <p>
  Â© Powered By Faylotto.
  <span>
    <a href="https://docs.faylotto.xyz/policy/AllRightsReserved" style="color: #007bff; text-decoration: none;" target="_blank">
      2025 All rights reserved.
    </a>
  </span>
  Play responsibly.
    <span>
    <a href="privacypolicy" style="color: #007bff; text-decoration: none;" target="_blank">
      Privacy Policy.
    </a>
    </span>
    </p>
  </footer>
          
<script>

// === CONTRACT ===
const CONTRACT_ADDRESS = "0xC2e09B1d6BC68F88383f16b1CE382411717cc731"; // Pastikan ini alamat TERBARU
const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner_","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"BetLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"result","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"randomNumber","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"contractBalance","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"string","name":"highestAvailablePrize","type":"string"},{"indexed":false,"internalType":"bool","name":"prizeAvailable","type":"bool"},{"indexed":false,"internalType":"uint256","name":"winChance","type":"uint256"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"BetUnliked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"prizeName","type":"string"}],"name":"ETHAwarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FaylottoAwarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FaylottoMinted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"freeSpinNumber","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"random","type":"uint256"}],"name":"FreeSpinPlayed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"OwnerDepositFaylotto","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"rating","type":"uint8"}],"name":"RatingAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"uint256","name":"globalBetId","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"oldRating","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"newRating","type":"uint8"}],"name":"RatingEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"inviter","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"}],"name":"ReferralAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"inviter","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"ReferralRewardEarned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"uid","type":"string"}],"name":"UIDGenerated","type":"event"},{"anonymous":false,"inputs":[],"name":"UserTransfersPaused","type":"event"},{"anonymous":false,"inputs":[],"name":"UserTransfersUnpaused","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[],"name":"INITIAL_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"inviterUID","type":"string"}],"name":"addReferralByUID","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner_","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimReferralReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"claimedReferralRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dailyQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dailyUsedQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"uint256","name":"commentIndex","type":"uint256"},{"internalType":"string","name":"newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"freeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"freeSpinData","outputs":[{"internalType":"uint256","name":"freeSpinsUsed","type":"uint256"},{"internalType":"uint256","name":"lastActive","type":"uint256"},{"internalType":"uint256","name":"walletCreated","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"freeSpinQuota","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"generateUID","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"getComments","outputs":[{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FaylottoSpinBet.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"getLikeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getPublicBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"result","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"randomNumber","type":"uint256"},{"internalType":"uint256","name":"contractBalance","type":"uint256"},{"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"string","name":"highestAvailablePrize","type":"string"},{"internalType":"bool","name":"prizeAvailable","type":"bool"},{"internalType":"uint256","name":"winChance","type":"uint256"}],"internalType":"struct FaylottoSpinBet.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"getRatingCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralList","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getReferralReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getUserBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"result","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"randomNumber","type":"uint256"},{"internalType":"uint256","name":"contractBalance","type":"uint256"},{"internalType":"uint256","name":"playerBetCount","type":"uint256"},{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"string","name":"highestAvailablePrize","type":"string"},{"internalType":"bool","name":"prizeAvailable","type":"bool"},{"internalType":"uint256","name":"winChance","type":"uint256"}],"internalType":"struct FaylottoSpinBet.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"address","name":"user","type":"address"}],"name":"getUserLike","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"address","name":"user","type":"address"}],"name":"getUserRating","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"prize","type":"string"}],"name":"isPrizeAvailable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"lastPrizeTimestamps","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastResetTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"}],"name":"likeSpin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"minInactiveTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minWalletAge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ownerDepositFaylotto","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pauseUserTransfers","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"prizeWindowCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"prizeWindowStart","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicHistoryLimit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"globalBetId","type":"uint256"},{"internalType":"uint8","name":"rating","type":"uint8"}],"name":"rateBet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrals","outputs":[{"internalType":"address","name":"inviter","type":"address"},{"internalType":"uint256","name":"rewardEarned","type":"uint256"},{"internalType":"string","name":"uid","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"spinPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBetsEver","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"uidToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseUserTransfers","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userTransfersPaused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawFaylottoFromContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

// --- Variabel Anda (yang sudah benar) ---
let refCodeFromURL = null;
let provider, signer, contract, userAddress;
const btn = document.getElementById("centerBtn");
const connectBtn = document.getElementById("connectBtn");
const disconnectBtn = document.getElementById("disconnectBtn");
const walletInfo = document.getElementById("walletInfo");
const walletAddress = document.getElementById("walletAddress");
const ethBalance = document.getElementById("ethBalance");
const faylottoBalance = document.getElementById("faylottoBalance");
const resultText = document.getElementById("resultText");
const clickSound = document.getElementById("clickSound");
const spinSound = document.getElementById("spinSound");
const winSound = document.getElementById("winSound");
const svg = document.getElementById("wheel");

const prizes = [
  { name: "1 ETH", icon: "eth.png" },
  { name: "Try Again", icon: "again.png" },
  { name: "MacBook", icon: "macbook.png" },
  { name: "5 Faylotto", icon: "fpoint.png" },
  { name: "0.1 ETH", icon: "eth.png" },
  { name: "0.05 ETH", icon: "eth.png" },
  { name: "0.7 ETH", icon: "eth.png" },
  { name: "2 Faylotto", icon: "fpoint.png" },
  { name: "0.005 ETH", icon: "eth.png" },
  { name: "0.0005 ETH", icon: "eth.png" },
  { name: "No Prize", icon: "no.png" },
  { name: "0.0001 ETH", icon: "eth.png" },
  { name: "iPhone", icon: "iphone.png" },
  { name: "7 Faylotto", icon: "fpoint.png" }
];

const prizeMap = {
  "1 ETH Jackpot": "1 ETH",
  "0.7 ETH Big Win": "0.7 ETH",
  "Won MacBook!": "MacBook Air", // Perbaiki nama jika perlu
  "iPhone or Worth ETH": "iPhone Promax", // Perbaiki nama jika perlu
  "0.1 ETH Monthly Prize": "0.1 ETH",
  "0.05 ETH Monthly Prize": "0.05 ETH", // Nama ini duplikat, pastikan benar
  "0.005 ETH Weekly": "0.005 ETH",
  "0.0005 ETH Three-day Prize": "0.0005 ETH",
  "0.0001 ETH Daily Prize": "0.0001 ETH",
  "Won 2 Faylotto": "2 Faylotto",
  "Won 5 Faylotto": "5 Faylotto",
  "Won 7 Faylotto": "7 Faylotto",
  "Try Again": "Try Again",
  "No Prize": "No Prize"
};

const colors = [
  "#FB8500", "#FF6347", "#571aff", "#72a2b8", "#FF69B4",
  "#65a765", "#FFB703", "#33b3a6", "#79b321", "#219EBC",
  "#FF4500", "#20B2AA", "#6A5ACD", "#334e77"
];

const radius = 240, cx = 250, cy = 250, total = prizes.length, slice = 360 / total;

// Render wheel dengan icon & teks
prizes.forEach((prize, i) => {
  const startAngle = (i * slice - 90) * Math.PI / 180;
  const endAngle = ((i + 1) * slice - 90) * Math.PI / 180;
  const x1 = cx + radius * Math.cos(startAngle);
  const y1 = cy + radius * Math.sin(startAngle);
  const x2 = cx + radius * Math.cos(endAngle);
  const y2 = cy + radius * Math.sin(endAngle);

  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
  path.setAttribute("d", `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 ${slice > 180 ? 1 : 0} 1 ${x2} ${y2} Z`);
  path.setAttribute("fill", colors[i % colors.length]); // Gunakan modulo jika warna < hadiah
  path.setAttribute("stroke", "#fff");
  path.setAttribute("stroke-width", "2");
  svg.appendChild(path);
  prizes[i].path = path; // Simpan referensi path

  const angle = (i + 0.5) * slice; // Angle in degrees for rotation
  const midAngleRad = (angle - 90) * Math.PI / 180; // Angle for positioning

  // icon
  const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
  const imgX = cx + radius * 0.55 * Math.cos(midAngleRad) - 20; // -20 for half width
  const imgY = cy + radius * 0.55 * Math.sin(midAngleRad) - 20; // -20 for half height
  img.setAttributeNS("http://www.w3.org/1999/xlink", "href", prize.icon);
  img.setAttribute("x", imgX);
  img.setAttribute("y", imgY);
  img.setAttribute("width", "40");
  img.setAttribute("height", "40");
  svg.appendChild(img);

  // teks
  const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
  const textX = cx + radius * 0.8 * Math.cos(midAngleRad);
  const textY = cy + radius * 0.8 * Math.sin(midAngleRad);
  text.setAttribute("x", textX);
  text.setAttribute("y", textY);
  text.setAttribute("fill", "#fff");
  text.setAttribute("font-size", "15");
  text.setAttribute("font-weight", "bold");
  text.setAttribute("text-anchor", "middle");
  text.setAttribute("alignment-baseline", "middle");
  text.setAttribute("transform", `rotate(${angle}, ${textX}, ${textY})`); // Rotate text correctly
  text.textContent = prize.name;
  svg.appendChild(text);
});


let spinning = false,
  currentRotation = 0,
  animation = null;

const SEPOLIA_BASE_CHAIN_ID = "0x14a34"; // Sepolia Base Testnet chainId
const SEPOLIA_BASE_RPC = "https://sepolia.base.org"; // RPC resmi
const AUTO_CONNECT_KEY = "faylottoWallet"; // key di localStorage
const AUTO_CONNECT_DURATION = 30 * 24 * 60 * 60 * 1000; // 30 hari

let allUserBets = [];
let userCurrentIndex = 0;
const ITEMS_PER_LOAD = 15;
const INITIAL_LOAD = 10;

let allPublicBets = [];
let publicCurrentIndex = 0;

async function connectWallet(auto = false) {
  if (!window.ethereum) return alert("ðŸ¦Š Install MetaMask!");

  try {
    // ==== 1. KONEKSI DASAR ====
    provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await provider.send("eth_requestAccounts", []);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();

    // ==== 2. CEK JARINGAN ====
    const network = await provider.getNetwork();
    if (network.chainId !== parseInt(SEPOLIA_BASE_CHAIN_ID, 16)) {
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: SEPOLIA_BASE_CHAIN_ID }],
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: SEPOLIA_BASE_CHAIN_ID,
              chainName: "Sepolia Base Testnet",
              rpcUrls: [SEPOLIA_BASE_RPC],
              nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
              blockExplorerUrls: ["https://sepolia.basescan.org"]
            }]
          });
        } else {
          return alert("Silakan ganti jaringan ke Sepolia Base Testnet!");
        }
      }
    }
  } catch (err) {
    console.error("Gagal koneksi wallet dasar:", err);
    return alert("Gagal menghubungkan wallet. Silakan coba lagi.");
  }

  // ==== 3. SIGNATURE (jika manual) ====
  if (!auto) {
    try {
      const localTime = new Date().toLocaleString();
      const message = `Welcome ${userAddress} to Faylotto SpinBet, Play And Enjoy. (${localTime})`;
      const signature = await signer.signMessage(message);
      console.log("User signature:", signature);
      const expire = Date.now() + AUTO_CONNECT_DURATION;
      localStorage.setItem(AUTO_CONNECT_KEY, JSON.stringify({ userAddress, expire }));
    } catch (err) {
      console.error("Signature failed:", err);
      // Jangan return, biarkan user tetap terhubung walau signature gagal
      alert("Gagal mendapatkan signature, beberapa fitur mungkin terbatas.");
    }
  }

  // ==== 4. BUAT KONTRAK ====
  try {
     contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  } catch(err){
      console.error("Gagal membuat instance kontrak:", err);
      return alert("Gagal terhubung ke smart contract. Pastikan ABI dan Alamat Kontrak benar.");
  }


  // ==== 5. TAMPILKAN UI (Bagian yang aman) ====
  connectBtn.style.display = "none";
  disconnectBtn.style.display = "inline-block";
  walletInfo.style.display = "flex";
  walletAddress.textContent = `User: ${userAddress.slice(0, 8)}...${userAddress.slice(-8)}`;
  walletAddress.addEventListener("click", () => {
    navigator.clipboard.writeText(userAddress);
    walletAddress.textContent = `Copied âœ…`;
    setTimeout(() => {
      walletAddress.textContent = `User: ${userAddress.slice(0, 8)}...${userAddress.slice(-8)}`;
    }, 1200);
  });

  // ================================================
  // ==== 6. PANGGILAN DATA (DIBUAT TANGGUH) ====
  // ================================================

  // Ambil ETH Balance (try...catch 1)
  try {
    const balance = await provider.getBalance(userAddress);
    const ethDisplay = parseFloat(ethers.formatEther(balance)).toFixed(8);
    ethBalance.textContent = `ETH: ${ethDisplay}`;
  } catch (err) {
    console.error("Gagal ambil ETH balance:", err);
    ethBalance.textContent = `ETH: Gagal muat`;
  }

  // Ambil Faylotto Balance (try...catch 2)
  try {
    const fBalance = await contract.balanceOf(userAddress);
    const fDisplay = parseFloat(ethers.formatUnits(fBalance, 18)).toFixed(2);
    faylottoBalance.textContent = `Faylotto: ${fDisplay}`;
  } catch (err) {
    console.error("Gagal ambil Faylotto balance:", err);
    faylottoBalance.textContent = `Faylotto: Gagal muat`;
  }

  // Cek Free Spin (try...catch 3)
  // Pindahkan ke akhir agar tidak block UI jika gagal
  // Setup Tombol Riwayat (Aman)
  try {
      document.getElementById("loadUserHistoryBtn").addEventListener("click", () => loadUserHistory(true));
      document.getElementById("loadPublicHistoryBtn").addEventListener("click", () => loadPublicHistory(true));
  } catch(err){
      console.error("Gagal setup tombol history:", err);
  }


  // Muat Riwayat (try...catch 5 & 6) - Lakukan lebih awal
  const loadHistoryPromises = [];
  loadHistoryPromises.push(loadUserHistory().catch(err => console.error("Gagal initial load user history:", err)));
  loadHistoryPromises.push(loadPublicHistory().catch(err => console.error("Gagal initial load public history:", err)));

  // Inisialisasi Referral (try...catch 4) - Lakukan lebih awal
   const initReferralPromise = (async () => {
        try {
            setupReferralListeners(); // Ini aman
            await initializeReferralSection();
            await handlePendingReferral();
        } catch (err) {
            console.error("Gagal inisialisasi referral:", err);
            // Cek jika elemen ada sebelum set textContent
            const referralStatusEl = document.getElementById('referralStatus');
            if (referralStatusEl) referralStatusEl.textContent = "Gagal memuat referral.";
        }
   })();

   // Cek Free Spin (try...catch 3) - Lakukan terakhir
   const checkFreeSpinPromise = checkFreeSpinEligibility().catch(err => {
        console.error("Gagal cek free spin:", err);
   });


   // Tunggu semua proses data selesai (kecuali history yang bisa jalan di background)
   try {
       await Promise.all([initReferralPromise, checkFreeSpinPromise]);
       console.log("Referral dan Free Spin check selesai.");
   } catch(err){
       console.error("Error saat menunggu init data:", err);
   }

   // Tunggu history selesai (opsional, tergantung UX)
    // try {
    //    await Promise.all(loadHistoryPromises);
    //    console.log("Initial history load selesai.");
    // } catch(err){
    //    console.error("Error saat menunggu initial history load:", err);
    // }

    // Efek glow setelah semua (atau sebagian besar) siap
    try {
        walletInfo.classList.add("glow-wallet");
        setTimeout(() => {
          walletInfo.classList.remove("glow-wallet");
        }, 5000);
    } catch(err){
        console.error("Gagal menambahkan efek glow:", err);
    }
}


// ==== Auto-reconnect saat halaman di-refresh ====
window.addEventListener("load", async () => {
  checkURLForReferrer(); // Panggil checkURLForReferrer di sini juga
  const stored = localStorage.getItem(AUTO_CONNECT_KEY);
  if (stored) {
    try {
        const { userAddress: storedAddress, expire } = JSON.parse(stored);
        if (Date.now() < expire) {
          await connectWallet(true); // auto connect
          console.log("Auto-reconnect wallet:", storedAddress);
        } else {
          localStorage.removeItem(AUTO_CONNECT_KEY);
        }
    } catch(err){
        console.error("Gagal auto-reconnect:", err);
        localStorage.removeItem(AUTO_CONNECT_KEY); // Hapus jika data corrupt
    }
  }
});

function disconnectWallet() {
  provider = signer = contract = userAddress = null;
  connectBtn.style.display = "inline-block";
  disconnectBtn.style.display = "none";
  walletInfo.style.display = "none";

  // Reset tombol spin ke default
  userFreeSpinState.eligible = false;
  userFreeSpinState.remaining = 0;
  updateSpinButtonUI();

  // Kosongkan riwayat & referral
  try {
      document.getElementById("userHistory").innerHTML = "";
      document.getElementById("publicHistory").innerHTML = "";
      document.getElementById('referralSection').style.display = 'none';
      document.getElementById('noUidView').style.display = 'none';
      document.getElementById('hasUidView').style.display = 'none';
  } catch(err){
      console.error("Error saat membersihkan UI disconnect:", err);
  }


  localStorage.removeItem(AUTO_CONNECT_KEY);
  console.log("Wallet disconnected.");
}

async function spinFromBlockchain() {
if (!contract) return alert("âš ï¸ Connect your wallet first!");
try {
btn.disabled = true;
clickSound.play();

resultText.textContent = "â³ Waiting Transaction...";

const tx = await contract.placeBet({ value: ethers.parseEther("0.000256") });

resultText.textContent = "ðŸŽ¡ Spinning...";

spinSound.currentTime = 0;
spinSound.play();

const receipt = await tx.wait();

const event = receipt.logs
  .map(log => {
    try {
      // Pastikan interface ada sebelum parse
      if (contract && contract.interface) {
          return contract.interface.parseLog(log);
      }
      return null;
    } catch {
      return null;
    }
  })
  .filter(e => e && e.name === "BetPlaced")[0];

if (!event) {
    // Jika event tidak ditemukan, mungkin transaksi revert atau masalah RPC
    console.error("No BetPlaced event found in receipt:", receipt);
    throw new Error("Spin event not found. Transaction might have failed.");
}

const { result } = event.args;
console.log("Raw result from contract:", result);

animateSpin(result); // Panggil animateSpin dengan nama hasil dari event

} catch (err) {
    console.error("Spin transaction failed:", err);
    spinSound.pause(); // Hentikan suara jika error

    let userMessage = "âŒ Transaction failed.";
    const reason = err.reason || (err.data ? contract?.interface?.parseError(err.data)?.args[0] : null) || err.message;
    if(reason) {
        userMessage = `âŒ Error: ${reason.substring(0, 100)}`;
    }

    resultText.textContent = userMessage;
    alert(userMessage);
    resetButton(); // Pastikan tombol aktif lagi
}
}


function createParticles(popup) {
  if(!popup) return;
  // hapus partikel lama
  popup.querySelectorAll(".particle").forEach(p => p.remove());

  // buat 6â€“8 partikel acak
  const particleCount = 6 + Math.floor(Math.random() * 3);
  const colors = ["#ff9ff3", "#feca57", "#54a0ff", "#5f27cd", "#1dd1a1", "#48dbfb", "#c8d6e5"];

  for (let i = 0; i < particleCount; i++) {
    const span = document.createElement("span");
    span.classList.add("particle");
    span.style.background = colors[Math.floor(Math.random() * colors.length)];
    span.style.width = `${6 + Math.random() * 8}px`;
    span.style.height = span.style.width;
    span.style.top = `${Math.random() * 90}%`;
    span.style.left = `${Math.random() * 90}%`;
    span.style.animationDuration = `${8 + Math.random() * 4}s`;
    span.style.animationDelay = `${Math.random() * 2}s`;
    popup.appendChild(span);
  }
}

function playSoftDing() {
  try {
      const audio = new Audio("winn.mp3"); // Pastikan file winn.mp3 ada
      audio.volume = 1; // Sesuaikan volume
      audio.play();
  } catch(err){
      console.error("Gagal memainkan suara 'winn.mp3':", err);
  }
}


function showPopup() {
  const popup = document.querySelector(".result-popup");
  if (!popup) {
      console.error("Elemen .result-popup tidak ditemukan!");
      return;
  }
  createParticles(popup);
  playSoftDing();

  popup.classList.remove("hide");
  popup.style.display = "block"; // Pastikan display block
  // Force reflow before adding class for transition
  void popup.offsetWidth;
  popup.classList.add("show");
}

function hidePopup() {
  const popup = document.querySelector(".result-popup");
   if (!popup) return;
  popup.classList.remove("show");
  popup.classList.add("hide");
  // Tunggu transisi selesai sebelum display none
  setTimeout(() => {
      if(popup.classList.contains('hide')) { // Cek lagi jika user klik OK
          popup.style.display = "none";
      }
  }, 800); // Sesuaikan durasi dengan transisi CSS Anda
}


function animateSpin(resultName) {
  console.log("animateSpin received resultName:", resultName);
  const displayName = prizeMap[resultName] || "No Prize"; // Fallback ke "No Prize"
  console.log("Mapped displayName:", displayName);
  const index = prizes.findIndex(p => p.name === displayName);
  console.log("Calculated index:", index);

  // Fallback jika tidak ditemukan (mungkin karena nama tidak cocok)
  if (index === -1) {
    console.error(`Prize mapping failed: '${displayName}' not found in prizes array.`);
    resultText.textContent = "Error: Invalid Prize";
    resetButton();
    return;
  }

  // Hentikan animasi sebelumnya jika ada
  if (animation) {
    animation.kill();
    animation = null; // Reset animation variable
  }
  prizes.forEach(p => p.path?.classList.remove("glow-prize")); // Gunakan ?.

  // Kalkulasi rotasi
  const targetAngle = (index * slice) + (slice / 2); // Angle to stop at (center of slice)
  const spins = 12 + Math.floor(Math.random() * 3); // More random spins
  // Pastikan currentRotation adalah angka
  let currentRotationNum = typeof currentRotation === 'number' ? currentRotation : 0;
  // Hitung rotasi akhir dengan mempertimbangkan arah putaran
  let finalRotation = (spins * 360) + targetAngle - (currentRotationNum % 360);
   // Tambahkan putaran penuh jika perlu agar selalu > 0
   if(finalRotation <= 0) finalRotation += 360 * spins;


  const duration = 5 + Math.random() * 2; // Buat durasi lebih singkat & random

  console.log(`Starting spin animation: current=${currentRotationNum}, targetAngle=${targetAngle}, finalRotation=${currentRotationNum + finalRotation}, duration=${duration}`);


  animation = gsap.to(svg, {
      rotation: `+=${finalRotation}`, // Gunakan rotasi relatif
      duration: duration,
      ease: "power2.inOut", // Coba ease yang berbeda
      transformOrigin: "center center",
      overwrite: true, // Hentikan tween sebelumnya
      onUpdate: () => {
          // Update currentRotation secara manual jika perlu (gsap handle state internal)
          // currentRotation = gsap.getProperty(svg, "rotation");
      },
      onComplete: () => {
        console.log("Spin animation complete.");
        spinSound.pause();
        spinSound.currentTime = 0; // Reset suara
        winSound.play();
        const winningPrize = prizes[index];
        if (winningPrize.path) {
            winningPrize.path.classList.add("glow-prize");
        } else {
             console.error("Path for winning prize not found!");
        }


        // --- Popup hasil menang ---
        const popup = document.getElementById("resultPopup");
        if(!popup) {
             console.error("Popup element #resultPopup not found!");
             resetButton();
             return;
        }

        popup.innerHTML = `
          <img src="win.png" class="icon" alt="Win Icon">
          <div class="text">
            You won: <span style="color:gold;font-size:24px;">${displayName}</span>
            <img src="${winningPrize.icon}" class="prize" alt="${displayName} prize">
          </div>
          <button id="closePopupBtn" class="popup-btn">OK</button>
        `;

        showPopup(); // Panggil fungsi showPopup

        // Set timeout untuk auto hide HANYA jika popup masih tampil
        const autoHideTimeout = setTimeout(() => {
            if (popup.style.display !== 'none' && popup.classList.contains('show')) {
                 hidePopup();
                 resetButton(); // Reset tombol jika auto hide
            }
        }, 10000); // 10 detik

        // Tombol OK untuk menutup popup
        const closeBtn = document.getElementById("closePopupBtn");
        if(closeBtn){
            closeBtn.onclick = () => {
              clearTimeout(autoHideTimeout); // Hentikan auto hide
              hidePopup();
              resetButton();
            };
        } else {
             console.error("Close button #closePopupBtn not found in popup!");
             resetButton(); // Tetap reset tombol
        }

        // Simpan rotasi akhir untuk spin berikutnya
        currentRotation = gsap.getProperty(svg, "rotation");
        console.log("Final rotation saved:", currentRotation);
        animation = null; // Reset animation variable
      }
    }
  );
}


// Fungsi helper untuk render batch item ke list
function renderBets(ul, bets, startIndex, count, isPublic = false) {
    if (!ul || !Array.isArray(bets)) {
        console.error("Invalid arguments for renderBets", { ul, bets });
        return;
    }
  for (let i = startIndex; i < startIndex + count && i < bets.length; i++) {
    const bet = bets[i];
     if(!bet || typeof bet !== 'object') {
         console.warn(`Skipping invalid bet data at index ${i}:`, bet);
         continue;
     }

    const li = document.createElement("li");
    const playerInfo = isPublic ? `(Player: ${String(bet.player || '').slice(0, 6)}...${String(bet.player || '').slice(-4)})` : "";

    // Safely access properties with fallback values
    const result = bet.result || 'N/A';
    const amount = bet.amount ? ethers.formatEther(bet.amount) : 'N/A';
    const timestamp = bet.timestamp ? new Date(Number(bet.timestamp) * 1000).toLocaleString() : 'N/A';
    const randomNumber = bet.randomNumber ? bet.randomNumber.toString() : 'N/A';
    const contractBalance = bet.contractBalance ? ethers.formatEther(bet.contractBalance) : 'N/A';
    const prizeAvailable = typeof bet.prizeAvailable === 'boolean' ? (bet.prizeAvailable ? "Ya" : "Tidak") : 'N/A';
    const winChance = typeof bet.winChance !== 'undefined' ? `${Number(bet.winChance) / 1000}%` : 'N/A';
    const highestPrize = bet.highestAvailablePrize || 'N/A';
    const playerBetCount = typeof bet.playerBetCount !== 'undefined' ? Number(bet.playerBetCount) + 1 : 'N/A'; // +1 because count is before this bet
    const globalBetId = typeof bet.globalBetId !== 'undefined' ? bet.globalBetId.toString() : 'N/A';


    li.innerHTML = `
      <strong>Spin #${globalBetId} ${playerInfo}</strong><br>
      Hasil: ${result}<br>
      Taruhan: ${amount} ETH<br>
      Waktu: ${timestamp}<br>
      Random #: ${randomNumber}<br>
      Saldo Kontrak: ${contractBalance} ETH<br>
      Hadiah Tersedia: ${prizeAvailable}<br>
      Peluang Menang: ${winChance} (estimasi)<br>
      Hadiah Tertinggi: ${highestPrize}<br>
      Spin Player ke: ${playerBetCount}<br>
    `;

    ul.appendChild(li);
  }
}


// Fungsi untuk memuat riwayat user pribadi dengan infinite scroll
async function loadUserHistory(refresh = false) {
  if (!contract || !userAddress) {
      console.warn("loadUserHistory skipped: Contract or userAddress not ready.");
      return; // Jangan alert, biarkan UI kosong saja
  }

  const historyDiv = document.getElementById("userHistory");
  if(!historyDiv) {
      console.error("Element #userHistory not found!");
      return;
  }


  // Cek jika sedang loading untuk mencegah multiple calls
  if (historyDiv.dataset.loading === 'true' && !refresh) return;
  historyDiv.dataset.loading = 'true';


  if (refresh || allUserBets.length === 0) {
    let loader = historyDiv.querySelector(".loader");
    try {
      // Tampilkan loader jika refresh atau load pertama
       if (!loader) {
            loader = document.createElement("div");
            loader.classList.add("loader");
            historyDiv.appendChild(loader);
       }
       loader.textContent = "Memuat riwayat saya...";
       loader.style.display = "block";


      const data = await contract.getUserBets(); // Tidak perlu userAddress, kontrak tahu msg.sender
      allUserBets = [...data].reverse();

      userCurrentIndex = 0;
      historyDiv.innerHTML = ""; // Kosongkan dulu jika refresh

      if (allUserBets.length === 0) {
        historyDiv.innerHTML = "<p>Tidak ada riwayat spin pribadi.</p>";
         historyDiv.dataset.loading = 'false';
        return;
      }

      const ul = document.createElement("ul");
      ul.classList.add("history-list");
      historyDiv.appendChild(ul);

      // Muat initial
      renderBets(ul, allUserBets, 0, INITIAL_LOAD);
      userCurrentIndex = INITIAL_LOAD;

      // Tambahkan loader lagi di bawah list
       loader = document.createElement("div"); // Buat ulang loader
       loader.classList.add("loader");
       loader.textContent = "Memuat lebih banyak...";
       loader.style.display = allUserBets.length > INITIAL_LOAD ? 'block' : 'none'; // Tampilkan jika ada lagi
       historyDiv.appendChild(loader);

      // Setup scroll listener (pastikan hanya sekali)
      historyDiv.removeEventListener("scroll", userScrollHandler);
      historyDiv.addEventListener("scroll", userScrollHandler);

    } catch (err) {
      console.error("Gagal memuat riwayat user:", err);
      historyDiv.innerHTML = "<p>Gagal memuat riwayat. Coba refresh.</p>";
       if (loader) loader.style.display = 'none'; // Sembunyikan loader jika error
    } finally {
         historyDiv.dataset.loading = 'false'; // Tandai selesai loading
    }
  } else {
       historyDiv.dataset.loading = 'false'; // Langsung set false jika tidak perlu load
  }
}

// Handler scroll untuk user history
function userScrollHandler() {
  const historyDiv = document.getElementById("userHistory");
  const ul = historyDiv.querySelector("ul");
  const loader = historyDiv.querySelector(".loader:last-child"); // Target loader terakhir

  if (!historyDiv || !ul || !loader) return;

  // Cek jika sedang loading atau sudah tidak ada data lagi
  if (historyDiv.dataset.loading === 'true' || userCurrentIndex >= allUserBets.length) return;


  // Trigger load sedikit sebelum mencapai dasar
  if (historyDiv.scrollTop + historyDiv.clientHeight >= historyDiv.scrollHeight - 100) {
    historyDiv.dataset.loading = 'true'; // Tandai mulai loading
    loader.style.display = "block";
    loader.textContent = "Memuat...";

    // Simulasi delay (data lokal)
    setTimeout(() => {
      const itemsToLoad = Math.min(ITEMS_PER_LOAD, allUserBets.length - userCurrentIndex);
      if (itemsToLoad > 0) {
          renderBets(ul, allUserBets, userCurrentIndex, itemsToLoad);
          userCurrentIndex += itemsToLoad;
      }

      if (userCurrentIndex >= allUserBets.length) {
        loader.textContent = "Tidak ada lagi riwayat.";
        // Jangan sembunyikan loader, biarkan teksnya tampil
      } else {
         loader.style.display = "none"; // Sembunyikan sementara sampai scroll lagi
      }
      historyDiv.dataset.loading = 'false'; // Tandai selesai loading
    }, 300); // Delay singkat
  }
}


// Fungsi untuk memuat riwayat public dengan infinite scroll (mirip user)
async function loadPublicHistory(refresh = false) {
  if (!contract) {
       console.warn("loadPublicHistory skipped: Contract not ready.");
       return;
  }

  const historyDiv = document.getElementById("publicHistory");
   if(!historyDiv) {
      console.error("Element #publicHistory not found!");
      return;
  }

  // Cek jika sedang loading
  if (historyDiv.dataset.loading === 'true' && !refresh) return;
  historyDiv.dataset.loading = 'true';

  if (refresh || allPublicBets.length === 0) {
    let loader = historyDiv.querySelector(".loader");
    try {
        if (!loader) {
            loader = document.createElement("div");
            loader.classList.add("loader");
            historyDiv.appendChild(loader);
        }
        loader.textContent = "Memuat riwayat public...";
        loader.style.display = "block";

      const data = await contract.getPublicBets();
      allPublicBets = [...data].reverse();

      publicCurrentIndex = 0;
      historyDiv.innerHTML = ""; // Kosongkan dulu jika refresh

      if (allPublicBets.length === 0) {
        historyDiv.innerHTML = "<p>Tidak ada riwayat spin public.</p>";
        historyDiv.dataset.loading = 'false';
        return;
      }

      const ul = document.createElement("ul");
      ul.classList.add("history-list");
      historyDiv.appendChild(ul);

      // Muat initial
      renderBets(ul, allPublicBets, 0, INITIAL_LOAD, true); // true for isPublic
      publicCurrentIndex = INITIAL_LOAD;

      // Tambahkan loader lagi
       loader = document.createElement("div"); // Buat ulang
       loader.classList.add("loader");
       loader.textContent = "Memuat lebih banyak...";
       loader.style.display = allPublicBets.length > INITIAL_LOAD ? 'block' : 'none';
       historyDiv.appendChild(loader);


      // Setup scroll listener
      historyDiv.removeEventListener("scroll", publicScrollHandler);
      historyDiv.addEventListener("scroll", publicScrollHandler);

    } catch (err) {
      console.error("Gagal memuat riwayat public:", err);
      historyDiv.innerHTML = "<p>Gagal memuat riwayat. Coba refresh.</p>";
       if (loader) loader.style.display = 'none';
    } finally {
        historyDiv.dataset.loading = 'false';
    }
  } else {
        historyDiv.dataset.loading = 'false';
  }
}

// Handler scroll untuk public history
function publicScrollHandler() {
  const historyDiv = document.getElementById("publicHistory");
  const ul = historyDiv.querySelector("ul");
  const loader = historyDiv.querySelector(".loader:last-child");

  if (!historyDiv || !ul || !loader) return;

  if (historyDiv.dataset.loading === 'true' || publicCurrentIndex >= allPublicBets.length) return;

  if (historyDiv.scrollTop + historyDiv.clientHeight >= historyDiv.scrollHeight - 100) {
    historyDiv.dataset.loading = 'true';
    loader.style.display = "block";
    loader.textContent = "Memuat...";


    // Simulasi delay (karena data dari blockchain mungkin lebih lambat)
    setTimeout(() => {
        const itemsToLoad = Math.min(ITEMS_PER_LOAD, allPublicBets.length - publicCurrentIndex);
         if (itemsToLoad > 0) {
            renderBets(ul, allPublicBets, publicCurrentIndex, itemsToLoad, true); // true for isPublic
            publicCurrentIndex += itemsToLoad;
         }


      if (publicCurrentIndex >= allPublicBets.length) {
        loader.textContent = "Tidak ada lagi riwayat.";
      } else {
          loader.style.display = "none";
      }
       historyDiv.dataset.loading = 'false';
    }, 500); // Delay sedikit lebih lama
  }
}


  // ===================================
// === FUNGSI-FUNGSI REFERRAL BARU ===
// ===================================

/**
 * Mendaftarkan event listener untuk tombol-tombol referral
 */
function setupReferralListeners() {
  try {
      const genBtn = document.getElementById('generateUIDBtn');
      if (genBtn && !genBtn.dataset.listener) {
        genBtn.addEventListener('click', handleGenerateUID);
        genBtn.dataset.listener = 'true';
      }

      const copyBtn = document.getElementById('copyLinkBtn');
      if (copyBtn && !copyBtn.dataset.listener) {
        copyBtn.addEventListener('click', copyReferralLink);
        copyBtn.dataset.listener = 'true';
      }

      const claimBtn = document.getElementById('claimRewardBtn');
      if (claimBtn && !claimBtn.dataset.listener) {
        claimBtn.addEventListener('click', handleClaimReward);
        claimBtn.dataset.listener = 'true';
      }
  } catch (err) {
      console.error("Error setting up referral listeners:", err);
  }
}


/**
 * Menampilkan UI referral (untuk si pengundang)
 */
async function initializeReferralSection() {
  if (!contract || !userAddress) {
      console.warn("initializeReferralSection skipped: Contract or userAddress not ready.");
      return;
  }

  const referralDiv = document.getElementById('referralSection');
  const status = document.getElementById('referralStatus');
  const noUidView = document.getElementById('noUidView');
  const hasUidView = document.getElementById('hasUidView');

  // Pastikan elemen ada
  if (!referralDiv || !status || !noUidView || !hasUidView) {
      console.error("Missing referral UI elements!");
      return;
  }

  referralDiv.style.display = 'block';
  status.textContent = 'Memuat data referral...';

  try {
    const info = await contract.referrals(userAddress);
    const uid = info.uid;

    if (!uid) {
      noUidView.style.display = 'block';
      hasUidView.style.display = 'none';
      status.textContent = 'Anda belum memiliki UID referral.';
    } else {
      noUidView.style.display = 'none';
      hasUidView.style.display = 'block';

      document.getElementById('userUID').textContent = uid;
      const link = `${window.location.origin}${window.location.pathname}?ref=${uid}`;
      document.getElementById('referralLink').value = link;

      // Ambil data statistik dengan error handling
      let count = 0;
      let reward = 0n; // Use BigInt for reward
       try {
            [count, reward] = await Promise.all([
                contract.getReferralCount(userAddress),
                contract.getReferralReward(userAddress)
            ]);
       } catch (statErr) {
           console.error("Gagal ambil statistik referral:", statErr);
           status.textContent = 'Gagal memuat statistik referral.';
           // Jangan hentikan proses, tampilkan default 0
       }


      const rewardEther = ethers.formatEther(reward);
      document.getElementById('referralCount').textContent = Number(count);
      document.getElementById('referralReward').textContent = `${parseFloat(rewardEther).toFixed(6)} ETH`;

      const claimBtn = document.getElementById('claimRewardBtn');
      // Gunakan BigInt untuk perbandingan > 0
      if (claimBtn) { // Cek jika tombol ada
          claimBtn.style.display = reward > 0n ? 'block' : 'none';
      }

      status.textContent = 'Data referral berhasil dimuat.';
    }
  } catch (err) {
    console.error("Gagal memuat info referral utama:", err);
    status.textContent = "Gagal memuat data referral.";
     // Sembunyikan kedua view jika error utama
     noUidView.style.display = 'none';
     hasUidView.style.display = 'none';
  }
}

/**
 * Menangani pendaftaran kode (untuk si undangan/referee)
 */
async function handlePendingReferral() {
  const refCode = localStorage.getItem('pendingRefCode');
  if (!refCode || !contract || !userAddress) {
    return; // Tidak ada kode, kontrak, atau userAddress
  }

  console.log(`Memproses kode referral tertunda: ${refCode}`);

  try {
    const info = await contract.referrals(userAddress);

    if (info.inviter !== ethers.ZeroAddress) {
      console.log('Anda sudah memiliki inviter.');
      localStorage.removeItem('pendingRefCode');
      return;
    }

    // Konfirmasi sebelum kirim transaksi
    if(!confirm(`Kami mendeteksi Anda diundang oleh ${refCode}. Konfirmasi untuk mendaftarkan referral Anda?`)) {
        console.log("Pendaftaran referral dibatalkan oleh user.");
        // Mungkin hapus kode jika user batal? Tergantung UX
        // localStorage.removeItem('pendingRefCode');
        return;
    }


    resultText.textContent = "â³ Memproses pendaftaran referral...";
    const tx = await contract.addReferralByUID(refCode);
    const receipt = await tx.wait();

    if (receipt.status === 1) {
        alert('Sukses! Anda berhasil terdaftar sebagai referral.');
        resultText.textContent = "Pendaftaran referral sukses!";
        localStorage.removeItem('pendingRefCode');
    } else {
         throw new Error("Transaksi pendaftaran referral gagal (status 0).");
    }

  } catch (err) {
    console.error("Gagal mendaftar referral:", err);
    let userMessage = `Gagal mendaftar referral: ${err.message}`;
    const reason = err.reason || (err.data ? contract?.interface?.parseError(err.data)?.args[0] : null);

     if (reason) {
        if (reason.includes("Already has an inviter")) {
            userMessage = "Anda sudah memiliki inviter.";
            localStorage.removeItem('pendingRefCode'); // Hapus jika memang sudah punya
        } else if (reason.includes("Invalid UID")) {
             userMessage = "Kode referral tidak valid.";
             localStorage.removeItem('pendingRefCode'); // Hapus jika UID salah
        } else if (reason.includes("Cannot refer yourself")) {
             userMessage = "Anda tidak bisa menggunakan kode referral Anda sendiri.";
             localStorage.removeItem('pendingRefCode');
        } else {
            userMessage = `Error: ${reason}`;
        }
     } else if (err.code === 'ACTION_REJECTED') {
         userMessage = "Pendaftaran dibatalkan.";
     }

    resultText.textContent = userMessage; // Tampilkan error di UI utama juga
    alert(userMessage);

  }
}

/**
 * Mengirim transaksi generateUID
 */
async function handleGenerateUID() {
  if (!contract) return alert("âš ï¸ Connect your wallet first!");

  const btn = document.getElementById('generateUIDBtn');
  const status = document.getElementById('referralStatus');
  if(!btn || !status) return; // Exit jika elemen tidak ada

  btn.disabled = true;
  btn.textContent = 'Memproses...';
  status.textContent = 'Menunggu konfirmasi transaksi...';

  try {
    const tx = await contract.generateUID();
    const receipt = await tx.wait();

    if (receipt.status === 1) {
        alert('UID berhasil dibuat!');
        status.textContent = 'UID dibuat! Memuat ulang data...';
        await initializeReferralSection(); // Refresh UI
    } else {
         throw new Error("Transaksi generate UID gagal (status 0).");
    }

  } catch (err) {
    console.error("Gagal generate UID:", err);
    let userMessage = `Gagal membuat UID: ${err.message}`;
     const reason = err.reason || (err.data ? contract?.interface?.parseError(err.data)?.args[0] : null);
     if(reason) {
         if (reason.includes("UID already generated")) {
             userMessage = "Anda sudah memiliki UID.";
             // Jika sudah punya, refresh saja UI nya
             await initializeReferralSection();
         } else {
             userMessage = `Error: ${reason}`;
         }
     } else if (err.code === 'ACTION_REJECTED') {
         userMessage = "Pembuatan UID dibatalkan.";
     }

    alert(userMessage);
    status.textContent = 'Gagal membuat UID.';
    // Hanya enable tombol jika bukan karena "already generated"
    if (!userMessage.includes("Anda sudah memiliki UID")) {
        btn.disabled = false;
        btn.textContent = 'Buat UID Saya';
    }
  }
}

/**
 * Mengirim transaksi claimReferralReward
 */
async function handleClaimReward() {
  if (!contract) return alert("âš ï¸ Connect your wallet first!"); // Typo 'yourral'

  const btn = document.getElementById('claimRewardBtn');
  const status = document.getElementById('referralStatus');
   if(!btn || !status) return;

  btn.disabled = true;
  btn.textContent = 'Memproses...';
  status.textContent = 'Menunggu konfirmasi transaksi...';

  try {
    const tx = await contract.claimReferralReward();
    const receipt = await tx.wait();

     if (receipt.status === 1) {
        alert('Reward berhasil diklaim!');
        status.textContent = 'Reward diklaim! Memuat ulang data...';
        await initializeReferralSection(); // Refresh UI
    } else {
         throw new Error("Transaksi klaim reward gagal (status 0).");
    }


  } catch (err) {
    console.error("Gagal klaim reward:", err);
     let userMessage = `Gagal klaim reward: ${err.message}`;
     const reason = err.reason || (err.data ? contract?.interface?.parseError(err.data)?.args[0] : null);
      if(reason) {
         if (reason.includes("No reward to claim")) {
             userMessage = "Tidak ada reward yang bisa diklaim saat ini.";
             // Refresh UI jika pesan ini muncul, mungkin data belum update
              await initializeReferralSection();
         } else {
             userMessage = `Error: ${reason}`;
         }
     } else if (err.code === 'ACTION_REJECTED') {
         userMessage = "Klaim reward dibatalkan.";
     }

    alert(userMessage);
    status.textContent = 'Gagal klaim reward.';
     // Selalu enable tombol setelah gagal (kecuali "no reward")
     if (!userMessage.includes("Tidak ada reward")) {
        btn.disabled = false;
        btn.textContent = 'Klaim Reward Saya';
     }
  }
}

/**
 * Menyalin link referral ke clipboard
 */
function copyReferralLink() {
  const linkInput = document.getElementById('referralLink');
  if (!linkInput) return; // Cek jika elemen ada

  navigator.clipboard.writeText(linkInput.value)
    .then(() => {
      alert('Link referral disalin!');
    })
    .catch(err => {
      console.error('Gagal menyalin link:', err);
      alert('Gagal menyalin link.');
    });
  }

  // Fungsi ini dijalankan saat halaman dimuat
function checkURLForReferrer() {
  try {
      const urlParams = new URLSearchParams(window.location.search);
      const refCode = urlParams.get('ref'); // Cari ?ref=...

      if (refCode && refCode.trim() !== '') {
        console.log("Kode referral ditemukan di URL:", refCode);
        localStorage.setItem('pendingRefCode', refCode);

        // Hapus parameter 'ref' dari URL tanpa reload halaman
        const nextURL = `${window.location.pathname}${window.location.search.replace(/[\?&]ref=[^&]+/, '').replace(/^&/, '?')}`;
        window.history.replaceState({ path: nextURL }, '', nextURL);
        console.log("Parameter 'ref' dihapus dari URL.");
      } else {
           console.log("Tidak ada kode referral di URL.");
      }
  } catch(err){
       console.error("Error saat memeriksa URL:", err);
  }
}

// === Variabel Global Baru untuk Free Spin ===
let userFreeSpinState = {
  eligible: false,
  remaining: 0
};

// === Utility Function (WAJIB ADA) ===
function resetButton() {
  const btn = document.getElementById("centerBtn");
  if (btn) {
    btn.disabled = false;
  }
  // Panggil update UI setelah reset
  updateSpinButtonUI();
}


/**
 * 1. FUNGSI UTAMA: Pengecekan kelayakan free spin
 */
async function checkFreeSpinEligibility() {
  // Pastikan kontrak dan userAddress sudah ada
  if (!contract || !userAddress) {
      console.warn("checkFreeSpinEligibility skipped: Contract or userAddress not ready.");
      // Pastikan tombol dalam keadaan default jika check gagal
      updateSpinButtonUI(); // Panggil dengan state default
      return;
  }

  console.log("Memulai pengecekan free spin eligibility..."); // Log Awal

  try {
    // 1. Ambil data konstan
    console.log("Mengambil data konstan (quota, minAge, minInactive)...");
    const [quota, minAge, minInactive] = await Promise.all([
      contract.freeSpinQuota(),
      contract.minWalletAge(),
      contract.minInactiveTime()
    ]);
    console.log("Data konstan diambil:", { quota, minAge, minInactive });


    // 2. Ambil data spesifik user
    console.log("Mengambil data user (freeSpinData)...");
    const userData = await contract.freeSpinData(userAddress);
     console.log("Data user diambil:", userData);

    // 3. Ambil timestamp block terbaru
    console.log("Mengambil timestamp block terbaru...");
    const block = await provider.getBlock("latest");
    if(!block){
        console.error("Gagal mendapatkan block terbaru!");
        updateSpinButtonUI(); // Fallback ke default
        return;
    }
    const now = block.timestamp;
    console.log("Timestamp block terbaru:", now);


    // 4. Konversi BigInt ke Number
    const quotaNum = Number(quota);
    const minAgeNum = Number(minAge);
    const minInactiveNum = Number(minInactive);
    const { freeSpinsUsed, lastActive, walletCreated } = {
      freeSpinsUsed: Number(userData.freeSpinsUsed),
      lastActive: Number(userData.lastActive),
      walletCreated: Number(userData.walletCreated)
    };
     console.log("Data dikonversi ke Number:", { quotaNum, minAgeNum, minInactiveNum, freeSpinsUsed, lastActive, walletCreated });


    const remaining = quotaNum - freeSpinsUsed;
     console.log("Sisa free spin:", remaining);


    // 5. Cek kuota dulu
    if (remaining <= 0) {
      console.log("Kuota free spin habis.");
      userFreeSpinState.eligible = false; // Pastikan state direset
      userFreeSpinState.remaining = 0;
      updateSpinButtonUI();
      return; // Keluar jika habis
    }

    // 6. Cek kondisi umur & inaktif
    const isOldEnough = (walletCreated > 0) && (now >= (walletCreated + minAgeNum));
    // Jika lastActive == 0 (belum pernah spin), anggap inaktif cukup lama
    const isInactiveEnough = (lastActive === 0) || (now >= (lastActive + minInactiveNum));

    console.log(`Hasil Pengecekan Free Spin:
      Sisa: ${remaining}
      Cukup Umur? ${isOldEnough} (Dibuat: ${walletCreated}, Perlu Tunggu Sampai: ${walletCreated + minAgeNum}, Sekarang: ${now})
      Cukup Inaktif? ${isInactiveEnough} (Terakhir Aktif: ${lastActive}, Perlu Tunggu Sampai: ${lastActive + minInactiveNum}, Sekarang: ${now})`);

    // 7. JIKA LAYAK (KEDUA kondisi true)
    if (isOldEnough && isInactiveEnough) {
      console.log("User LAYAK mendapatkan free spin.");
      userFreeSpinState.eligible = true;
      userFreeSpinState.remaining = remaining;

      showFreeSpinPopup(); // Tampilkan popup notifikasi
      updateSpinButtonUI(); // Update tombol menjadi "Spin Free X"
    } else {
      // Jika tidak layak, pastikan state & tombol kembali normal
      console.log("User TIDAK LAYAK mendapatkan free spin saat ini.");
      userFreeSpinState.eligible = false;
      userFreeSpinState.remaining = 0; // Set remaining ke 0 jika tidak eligible
      updateSpinButtonUI(); // Update tombol kembali ke "SPIN" normal
    }

  } catch (err) {
    console.error("Error besar saat mengecek kelayakan free spin:", err);
    // Jika terjadi error, pastikan state & tombol kembali normal
    userFreeSpinState.eligible = false;
    userFreeSpinState.remaining = 0;
    updateSpinButtonUI();
  }
}



/**
 * 2. Menampilkan popup (sesuai permintaan Anda)
 */
function showFreeSpinPopup() {
  // Hanya tampilkan popup JIKA user memang eligible DAN punya sisa spin
  // Ini mencegah popup muncul jika state belum direset dari sesi sebelumnya
  if (userFreeSpinState.eligible && userFreeSpinState.remaining > 0) {
      console.log("Menampilkan popup free spin...");
      // Ganti alert dengan konfirmasi agar tidak terlalu mengganggu
      if(confirm(`Selamat! Anda berhak mendapatkan ${userFreeSpinState.remaining} spin gratis. Spin sekarang?`)) {
          // Jika user klik OK, tidak perlu lakukan apa-apa,
          // tombol sudah berubah, user tinggal klik tombol spin.
      } else {
           console.log("User memilih untuk tidak spin gratis sekarang.");
           // Opsional: Mungkin reset state jika user cancel? Tergantung UX.
           // userFreeSpinState.eligible = false;
           // updateSpinButtonUI();
      }
  } else {
       console.log("Popup free spin tidak ditampilkan (tidak eligible atau sisa 0).");
  }
}



/**
 * 3. Update UI Tombol Spin
 */
function updateSpinButtonUI() {
  const btn = document.getElementById("centerBtn");
  if (!btn) {
       console.error("Tombol #centerBtn tidak ditemukan saat update UI!");
       return;
  }

  // Cek state KELAYAKAN dan SISA
  if (userFreeSpinState.eligible && userFreeSpinState.remaining > 0) {
    console.log(`Mengupdate tombol ke: SPIN FREE ${userFreeSpinState.remaining}`);
    btn.innerHTML = `SPIN FREE ${userFreeSpinState.remaining}`;
    const costSpan = btn.querySelector(".cost");
    if (costSpan) costSpan.remove();
  } else {
    // Kembali ke normal jika tidak eligible ATAU sisa = 0
    console.log("Mengupdate tombol ke: SPIN normal");
     // Pastikan span cost ada sebelum mencoba menambahkannya lagi
     if (!btn.querySelector(".cost")) {
         btn.innerHTML = `SPIN<br><span class="cost"><center>Cost</center>0.000256 ETH</span>`;
     } else {
          // Jika span sudah ada, cukup ubah teks utama
          btn.childNodes[0].nodeValue = "SPIN"; // Ubah teks "SPIN FREE X" jadi "SPIN"
     }
  }
   // Pastikan tombol tidak disabled setelah update UI
   btn.disabled = false;
}



/**
 * 4. Fungsi Spin Gratis Baru (Dengan Penanganan Registrasi & Error)
 */
async function spinFreeFromBlockchain() {
  if (!contract) return alert("âš ï¸ Connect your wallet first!");

  const btn = document.getElementById("centerBtn");
  if(!btn) return; // Exit jika tombol tidak ada

  try {
    btn.disabled = true;
    clickSound.play();
    resultText.textContent = "â³ Waiting Free Transaction...";

    const tx = await contract.freeSpin();

    resultText.textContent = "â³ Confirming Transaction...";
    const receipt = await tx.wait();

    // Cek status transaksi dulu
     if (receipt.status !== 1) {
          console.error("Transaksi freeSpin reverted on-chain (status 0).", receipt);
          throw new Error("Transaksi free spin gagal di blockchain.");
     }

    const event = receipt.logs
      .map(log => {
        try {
            // Pastikan interface ada
             if (contract && contract.interface) {
                 return contract.interface.parseLog(log);
             }
             return null;
        } catch { return null; }
      })
      .filter(e => e && e.name === "FreeSpinPlayed")[0];

    // --- PENANGANAN REGISTRASI ---
    if (!event) {
        console.log("Panggilan freeSpin pertama berhasil (registrasi).");
        resultText.textContent = "âœ… Akun Terdaftar!";
        alert("Akun Anda berhasil didaftarkan untuk free spin. Silakan tunggu 1 menit lagi, lalu coba spin gratis.");
        // Tombol HARUSNYA sudah di-enable oleh resetButton() di bawah,
        // tapi kita panggil updateSpinButtonUI() untuk memastikan teksnya benar
        // (masih SPIN FREE X karena remaining belum berkurang)
        resetButton(); // Ini akan memanggil updateSpinButtonUI
        return;
    }

    // --- SPIN AKTUAL ---
    resultText.textContent = "ðŸŽ¡ Spinning Free...";
    spinSound.currentTime = 0;
    spinSound.play();

    // 1. Update state (ini penting dilakukan SEBELUM animasi)
    userFreeSpinState.remaining--;
    if (userFreeSpinState.remaining <= 0) {
      userFreeSpinState.eligible = false; // Set tidak eligible jika habis
    }
     // Update tombol SEKARANG
    updateSpinButtonUI();

    // 2. Mapping hasil
    const { rewardAmount } = event.args;
    const resultString = mapRewardToResultString(rewardAmount);
    console.log(`Free spin reward amount: ${rewardAmount}, mapped to: ${resultString}`);


    if (resultString === "Try Again") {
         console.warn("Free spin menghasilkan '3 Faylotto', dipetakan ke 'Try Again'.");
    }

    // 3. Jalankan animasi
    animateSpin(resultString); // resetButton() akan dipanggil di onComplete animasi

  } catch (err) {
    console.error("Gagal free spin:", err);
    spinSound.pause();

    let userMessage = "âŒ Free spin failed.";
    const reason = err.reason || (err.data ? contract?.interface?.parseError(err.data)?.args[0] : null) || err.message;

    if (reason) {
        console.log("Contract revert reason:", reason); // Tampilkan reason di console
        if (reason.includes("Wallet too new for free spin")) {
            userMessage = "â³ Akun terdaftar! Harap tunggu 1 menit lagi.";
        } else if (reason.includes("Last active too recent")) {
            userMessage = "â³ Anda baru saja spin. Harap tunggu 1 menit lagi.";
        } else if (reason.includes("No free spins left")) {
            userMessage = "âŒ Kuota free spin Anda sudah habis.";
            userFreeSpinState.eligible = false;
            userFreeSpinState.remaining = 0;
            // resetButton() akan panggil updateSpinButtonUI()
        } else {
             userMessage = `âŒ Error: ${reason.substring(0, 100)}`;
        }
    } else if (err.code === 'ACTION_REJECTED') {
         userMessage = "Transaksi dibatalkan.";
         console.log("User rejected the transaction.");
    } else {
         // Error jaringan atau lainnya
         userMessage = "âŒ Terjadi kesalahan jaringan atau tak terduga.";
         console.log("Error non-kontrak:", err.code, err.message);
    }

    resultText.textContent = userMessage;
    alert(userMessage);
    resetButton(); // Panggil resetButton untuk mengaktifkan tombol & update UI
  }
}


/**
 * 5. Helper untuk mapping hasil 'freeSpin()'
 */
function mapRewardToResultString(rewardAmount) {
  try {
      const amount = BigInt(rewardAmount.toString());
      const base = 10n ** 18n;

      if (amount === 2n * base) return "Won 2 Faylotto";
      if (amount === 5n * base) return "Won 5 Faylotto";
      if (amount === 7n * base) return "Won 7 Faylotto";
      if (amount === 3n * base) return "Try Again"; // Fallback untuk 3 FAY

      console.warn(`Jumlah reward tidak dikenal dari free spin: ${amount}`);
      return "No Prize"; // Fallback jika jumlah tidak cocok
  } catch(err){
      console.error("Error saat mapping reward:", err, "Reward Amount:", rewardAmount);
      return "No Prize"; // Fallback jika error konversi
  }
}

/**
 * Event listener utama untuk tombol spin.
 */
function handleSpinClick() {
  // Selalu cek kelayakan TERKINI sebelum spin
  // Ini penting jika user menunggu lama di halaman tanpa refresh
  checkFreeSpinEligibility().then(() => {
      // Setelah check selesai, baru tentukan fungsi spin mana yang dipanggil
       if (userFreeSpinState.eligible && userFreeSpinState.remaining > 0) {
            console.log("Memanggil spinFreeFromBlockchain...");
            spinFreeFromBlockchain();
       } else {
            console.log("Memanggil spinFromBlockchain...");
            spinFromBlockchain();
       }
  }).catch(err => {
      // Jika checkFreeSpinEligibility gagal, fallback ke spin normal
      console.error("Check eligibility gagal sebelum spin, fallback ke spin normal:", err);
       spinFromBlockchain();
  });
}



// --- PERBAIKAN BUG GLOW & YEAR ---
// Efek glow wallet (sudah pakai nama class baru)
try {
    walletInfo.classList.add("glow-wallet");
    setTimeout(() => {
      walletInfo.classList.remove("glow-wallet");
    }, 5000);
} catch(err){
    console.error("Gagal glow wallet:", err);
}


// Event Listeners (di bagian paling bawah)
connectBtn.addEventListener("click", connectWallet);
disconnectBtn.addEventListener("click", disconnectWallet);
btn.addEventListener("click", handleSpinClick); // Listener utama yang baru

// Hapus atau perbaiki getElementById("year") jika elemennya tidak ada
// document.getElementById("year").textContent = new Date().getFullYear(); // <-- INI MASIH ERROR JIKA ID "year" TIDAK ADA

</script>

</body>
</html>
